<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bmwusa-dealer-map-location-search.html</title>
</head>
<body>

<script>
/*! BMWUSA Vite Build 1731603678170 */
import{C as p}from"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/component.js";import{u as c}from"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/index.js";import{D as S,h as n,$ as d}from"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-measurement-data.js";import{A as g}from"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/autocomplete-keyboard.js";import{V as m}from"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/validator.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/index.esm.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/is-author.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/baseDomain.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/getbyourl.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/scroll-to.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/uid.js";import"/etc.clientlibs/bmwusa/clientlibs/clientlib-site/bmwusa-clientlibs/bmwusa-chunks/resources/zipcode.js";new p({el:".dealer-map-location-search",name:"dealer-map-location-search Component",events:{"keyup input":"checkInput"},subscriptions:{"map.done":"mapLoaded","dealer.outside-click":"closeAutocomplete","dealermap.search-view":"searchDisplayToggle","dealermap.component-embedded":"prefillDealerZip","whereIWantForm.dealer.setGlobalFromForm":"setFromForm"},total:3,baseStr:"dealer-map-location-search",mapIsLoaded:!1,autocompleteOptions:{types:["(cities)"],componentRestrictions:{country:"us"}},keyCodes:[27,13,40,38],prevName:[],maxCount:50,searchTerm:"",currentSearch:"",dtmSearchError:"dtmDealerLocatorModalSearchError",dtmSearchSuccess:"dtmDealerLocatorModalSearchSuccess",dtmSearchSuccessFromForm:"DTM_AA_DealerLocatorFormZipSuccess",zipCodeCookieName:"user_zipcode",beforeInit(){this.dealerSearch=new S,this.autocompleteKeyboard=new g,this.inputs=this.element.querySelectorAll("input"),this.dealerSearchInput=this.element.querySelector('input[name="dealer-search"]'),this.dealerLocationInput=this.element.querySelector('input[name="location-search"]'),this.dealerResultsHolder=this.dealerSearchInput.parentNode.querySelector(`${this.el}__autocomplete`),this.dealerResultsHolderNav=this.dealerResultsHolder.querySelector("nav"),this.submitBtn=this.element.querySelector(`${this.el}__search-btn`),this.inputHolder=this.element.querySelectorAll(`${this.el}__input-holder`),this.submitBtnStateChanged,this.searchResultsDealer=this.searchResultsDealer.bind(this),this.mapLoaded=this.mapLoaded.bind(this),this.autoFillSelected=this.autoFillSelected.bind(this),this.processSearch=this.processSearch.bind(this),this.dealerNameClick=this.dealerNameClick.bind(this),this.dealerLocationData=this.dealerLocationData.bind(this),this.dealerCityZipSearchResults=this.dealerCityZipSearchResults.bind(this),this.focusState=this.focusState.bind(this),this.macoData=this.macoData.bind(this),this.closeAutocomplete=this.closeAutocomplete.bind(this),this.toggleLoading=this.toggleLoading.bind(this),this.dealerResultsHolderNav.addEventListener("click",this.dealerNameClick),this.element.addEventListener("submit",this.processSearch),this.submitBtn.addEventListener("click",this.processSearch),this.dealerLocationInput.addEventListener("focus",this.focusState)},init(){for(let e=0;e<this.inputHolder.length;e++)this.inputHolder[e].addEventListener("click",this.cancelProp)},mapLoaded(){this.autocomplete=new google.maps.places.Autocomplete(this.dealerLocationInput,this.autocompleteOptions),this.autocomplete.addListener("place_changed",this.autoFillSelected)},autoFillSelected(){let e,t,s;const a=this.autocomplete.getPlace(),i=!isNaN(name),r=m.validateZipCode(name);if(a&&a.address_components){this.toggleLoading(!0);const{address_components:h,geometry:o,name:f}=a;if(h.forEach(l=>{l.types.indexOf("locality")>-1&&(t=l.long_name),l.types.indexOf("administrative_area_level_1")>-1&&(s=l.short_name)}),o){const{lat:l,lng:u}=o.location;e={Lat:l(),Lon:u()}}t&&s?(this.searchTerm=t+", "+s,this.currentSearch="searchCity",this.dealerSearch.searchCity({state:s,city:t},(l,u)=>{e=o?e:!1,this.dealerCityZipSearchResults(l,u,e)},!0)):o?(this.searchTerm=e.Lat.toFixed(3)+", "+e.Lon.toFixed(3),this.currentSearch="latLonSearch",this.dealerSearch.latLonSearch(e,this.dealerCityZipSearchResults,!0)):this.toggleErrorState(this.dealerLocationInput,!0)}else!i&&!r&&(this.toggleLoading(),this.toggleErrorState(this.dealerLocationInput,!0))},dealerCityZipSearchResults(e,t,s=!1){this.currentSearch!="latLonSearch"&&this.toggleLoading(),e?this.toggleErrorState(this.dealerLocationInput,!0):(t.Results.length>0?(this.toggleErrorState(this.dealerLocationInput),this.sendData(t)):s?(this.currentSearch="latLonSearch",this.dealerSearch.latLonSearch(s,this.dealerCityZipSearchResults,!0)):this.sendData({Results:[]}),GlobalMessage("measure.dtm.track",this.dtmSearchSuccess))},prefillDealerZip(e){const t=n.getDealer();t&&setTimeout(()=>{this.dealerLocationInput.value=t.ZipCode,this.submitBtn.disabled=!1},250)},cancelProp(e){e.stopImmediatePropagation()},checkInput(e){switch(e.stopImmediatePropagation(),e.which===27&&e.target.value===""?PubSub.publish("map.close-map"):e.which===27&&this.clearSearch(),e.target.value!==""?this.submitBtn.disabled=!1:this.inputs.forEach(t=>{e.target!==t&&t.value===""&&(this.submitBtn.disabled=!0)}),this.submitBtnStateChanged!==this.submitBtn.disabled&&(PubSub.publish("map.set-trap-focus"),this.submitBtnStateChanged=this.submitBtn.disabled),e.target.name){case"dealer-search":this.searchDealerName(e);break;case"location-search":this.locationSearch(e);break}},focusState(e){this.killResults()},locationSearch(e){e.which===13&&this.runValidator(e.target)},toggleLoading(e=!1){const t=`${this.baseStr}__search-btn--active`;e?this.submitBtn.classList.add(t):this.submitBtn.classList.remove(t)},dealerLocationData(e,t,s){this.toggleLoading(),e?this.toggleErrorState(this.dealerLocationInput,!0):(t.Results.length>0?(this.toggleErrorState(this.dealerLocationInput),this.sendData(t),c.cookies.verifyAndSet(!1,this.zipCodeCookieName,this.searchTerm)):this.toggleErrorState(this.dealerLocationInput,!0),GlobalMessage("measure.dtm.track",s==="form"?this.dtmSearchSuccessFromForm:this.dtmSearchSuccess))},setFromForm(e,t){this.dealerSearch.searchZip(t,this.dealerLocationData,!0,null,"form")},typingTimer:null,doneTypingInterval:250,searchDealerName(e){const t=e.target,s=t.value,a=this.keyCodes.indexOf(e.which)>-1,i=s==="",r=this.isDealerResultsOpen();e.which===13&&i&&this.toggleErrorState(t,!0),i?this.killResults():a?e.which===13&&this.checkDealerData(t):(clearTimeout(this.typingTimer),this.typingTimer=setTimeout(()=>{this.doneTyping(s)},this.doneTypingInterval)),(r&&e.which===40||e.which===38)&&(e.which===40?this.setActiveDealerResults("down"):this.setActiveDealerResults("up"))},doneTyping(e){this.currentSearch="searchDealer",this.dealerSearch.searchDealer(e,this.searchResultsDealer)},searchResultsDealer(e,t){e?(this.toggleErrorState(this.dealerSearchInput,!0),this.debug("error",e)):(this.dealerResults=t,this.dealerResults.length>0?(this.toggleErrorState(this.dealerSearchInput),this.displayDealerResults()):this.killResults())},setActiveDealerResults(e){const t=this.dealerResultsHolder.querySelectorAll("button"),s=`${this.baseStr}__autocomplete-item--active`,a=this.dealerResultsHolder.querySelector(`.${s}`);this.autocompleteKeyboard.runKeyboardHighlights({max:t.length,activeStr:s,resultItems:t,activeItem:a},e)},toggleErrorState(e,t=!1){const s=e.parentNode,a=`${this.baseStr}__input--error`;t?(s.classList.add(`${a}`),GlobalMessage("measure.event.fieldError",d.text(s).trim()),GlobalMessage("measure.dtm.track",this.dtmSearchError)):s.classList.remove(`${a}`)},displayDealerResults(){let e="";const t=`${this.baseStr}__autocomplete--active`,s=this.dealerResults.slice(0,this.total),a=this.isDealerResultsOpen()?c.matchArrayVal(this.prevName,s,"Name"):!1,i=this.isDealerResultsOpen();!a&&this.dealerSearchInput.value!==""&&(this.prevName=[],s.forEach(r=>{const{Name:h}=r,o=h.length>this.maxCount?`${h.substring(0,this.maxCount)}...`:h;e+=`<button
                        type="button"
                        name="${o}"
                        class="${this.baseStr}__autocomplete-item">
                      ${o}
                    </button>`,this.prevName.push(h)}),this.dealerResultsHolderNav.innerHTML=e,i||this.dealerResultsHolder.classList.add(t),this.toggleErrorState(this.dealerSearchInput))},isDealerResultsOpen(){const e=`${this.baseStr}__autocomplete--active`;return this.dealerResultsHolder.classList.contains(e)},checkDealerData(e){if(!this.isDealerResultsOpen())this.toggleErrorState(e,!0);else{const s=this.dealerResultsHolder.querySelectorAll("button"),a=this.dealerResultsHolder.querySelector(`${this.el}__autocomplete-item--active`);let i=0,r=s[i];a&&(i=d.elementIndex(a),r=s[i]),e.value=r.textContent.trim(),this.selectedDealership=this.dealerResults[i],this.macoSetup(this.selectedDealership)}},dealerNameClick(e){if(e.target&&e.target.matches(`${this.el}__autocomplete-item`)){const t=e.target,s=d.elementIndex(t);this.selectedDealership=this.dealerResults[s],this.dealerSearchInput.value=t.textContent.trim(),this.macoSetup(this.selectedDealership),GlobalMessage("measure.dtm.track",this.dtmSearchSuccess)}},macoSetup(e){const{ZipCode:t,Name:s}=e;this.searchTerm=s,this.closeAutocomplete(null),this.toggleLoading(!0),n.getMacoDataApi(c.CleanZip(t)).then(a=>{this.macoData(a)}).catch(a=>{console.error(a),this.toggleErrorState(this.dealerSearchInput,!0)})},macoData(e){this.toggleLoading(),this.setupDealerData({dealer:this.selectedDealership,maco:e})},setupDealerData(e){this.currentSearch="singleDealer";const{dealer:t,maco:s}=e;this.sendData({Results:[t],Maco:s})},sendData(e){n.setDealerList(e.Results),n.setMaco(e.Maco),this.clearSearch(),e.Term=this.searchTerm||"",this.toggleLoading(),PubSub.publish("dealermap.dealer-selected",{dealer:e.Results[0],maco:e.Maco,payload:e.Results}),e.currentSearch=this.currentSearch,PubSub.publish("dealermap.search-results",e),this.searchDisplayToggle(null)},searchDisplayToggle(e,t=!1){const s=`${this.baseStr}--active`;if(t)if(t.lat&&t.lng){const a={Lat:t.lat,Lon:t.lng};this.searchTerm=t.lat.toFixed(3)+", "+t.lng.toFixed(3),this.currentSearch="latLonSearch",this.dealerSearch.latLonSearch(a,this.dealerCityZipSearchResults,!0)}else this.clearSearch();else this.element.classList.remove(s)},clearSearch(){this.dealerResults=[],this.killResults();for(let e=0;e<this.inputs.length;e++)this.inputs[e].value=""},closeAutocomplete(e,t){this.killResults()},killResults(){this.autocompleteKeyboard.reset(),this.dealerResultsHolder.classList.remove(`${this.baseStr}__autocomplete--active`)},runValidator(e,t=!0){let s=e.value;const a=m.validateZipCode(s),i=!isNaN(s);a?(s=c.CleanZip(s),this.toggleLoading(!0),this.searchTerm=s,this.currentSearch="searchZip",this.dealerSearch.searchZip(s,this.dealerLocationData,!0),GlobalMessage("measure.user.location",{zipCode:s})):t&&i?this.toggleErrorState(this.dealerLocationInput,!0):t||this.toggleErrorState(this.dealerLocationInput,!0)},processSearch(e){e.preventDefault();for(let t=0;t<this.inputs.length;t++){const s=this.inputs[t],a=s.value,i=s.name;a!==""&&(i==="location-search"?(this.runValidator(s,!1),PubSub.publish("dealer.pagination-disabled","prev")):this.toggleErrorState(s,!0))}}});

</script>

</body>
</html>
