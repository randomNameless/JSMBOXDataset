<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>app-b8fad8d.min.html</title>
</head>
<body>

<script>
var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("app",["ui.router","pascalprecht.translate","commons","angular.filter","720kb.datepicker","ngMessages","cg.fileupload","ngDialog","mp.deepBlur","rzModule","ngAria","tmh.dynamicLocale","ngCookies","RecursionHelper","ngAnimate","toastr","ngSanitize","angular-md5"]).config(["$translateProvider","tmhDynamicLocaleProvider","toastrConfig","$httpProvider",function(e,t,n,o){function i(){document.body.classList.remove("user-is-tabbing"),window.removeEventListener("mousedown",i),window.addEventListener("keydown",s)}var r=localStorage.getItem("lang"),a=(r&&0<=r.indexOf('"')&&(r=r.replace(/\"/g,""),localStorage.setItem("lang",r)),navigator.userAgent),a=new RegExp(["(MSIE|Trident|(?!Gecko.+)Firefox","|(?!AppleWebKit.+Chrome.+)Safari(?!.+Edge)","|(?!AppleWebKit.+)Chrome(?!.+Edge)|(?!AppleWebKit.+Chrome.+Safari.+)Edge","|AppleWebKit(?!.+Chrome|.+Safari)|Gecko(?!.+Firefox))(?: |\\/)([\\d\\.apre]+)"].join(""),"g").exec(a)[1],s=(document.body.className+=a.toLowerCase(),function e(t){9===t.keyCode&&(document.body.classList.add("user-is-tabbing"),window.removeEventListener("keydown",e),window.addEventListener("mousedown",i))}),a=(window.addEventListener("keydown",s),e.useLocalStorage(),e.storageKey("lang"),e.useSanitizeValueStrategy("escaped"),Object.keys(window.appConfig.languages)),c=!0,u=!1,l=void 0;try{for(var d,g=a[Symbol.iterator]();!(c=(d=g.next()).done);c=!0){var p=d.value;window.langs[p]||(window.langs[p]={default:!1,translations:{}}),_extends(window.langs[p].translations,window.appConfig.languages[p].translations),e.translations(p,window.langs[p].translations)}}catch(e){u=!0,l=e}finally{try{!c&&g.return&&g.return()}finally{if(u)throw l}}r&&a.includes(r)||(u=function(){return(void 0!==navigator.languages?navigator.languages[0]:navigator.language).split("-")[0]},l=a.find(function(e){return window.langs[e].default})||null,r=(a.includes(u())?u():null)||l||"en"),e.preferredLanguage(r),e.use(r),t.defaultLocale(r),t.localeLocationPattern("/components/angular-i18n/angular-locale_{{locale}}.js"),angular.extend(n,{positionClass:"toast-bottom-right"}),o.interceptors.push(["$q","$injector","$rootScope",function(o,i,r){return{responseError:function(e){var t,n;return e&&503===e.status&&(t=i.get("FirebaseService"),n=i.get("NotificationService"),i.get("LocalStorage").remove("maintenance"),t.injectScripts(),r.$on("maintenance",function(e,t){t&&(n.storeMaintenance(t),window.location=window.location.origin+"/maintenance.html")})),o.reject(e)}}}]),o.interceptors.push(["$q","$injector",function(i,r){var a=void 0;return{responseError:function(t){var e,n,o=r.get("SessionService");return o.isJwtTokenSession()&&(401===t.status&&"Unauthorized"===t.data.error&&"Your token has expired"===t.data.message||400===t.status&&t.data&&t.data.errors&&t.data.errors.some(function(e){return e&&e.extensions&&"UNAUTHENTICATED"===e.extensions.code&&"Context creation failed: Expired access token."===e.message}))?(e=r.get("DbnApi"),n=r.get("$http"),(a=a||e.refreshToken()).then(function(){a=null;var e=o.getToken();return t.config.headers.authorization="Bearer "+e,n(t.config)}).catch(function(e){var t=r.get("$state");return"INVALID_REFRESH_TOKEN"!==e.code&&console.error("Error on refresh token",e),o.logOut(),t.go("auth.login",{expired:1}).finally(function(){return i.reject(e.message)})})):(403===t.status&&t.data&&"Forbidden"===t.data.error&&"Missing authentication token"===t.data.message&&(console.error("Missing bearer token",t.data.error),o.logOut()),i.reject(t))}}}])}]).run(["$rootScope","Config","ModuleService","Library","SettingService","SyncService","SessionService","FirebaseService","UserService","UsersContentsInfos","UsersPreferences","UserInputsService","$location","$state","ngDialog","$window",function(i,a,e,t,n,o,r,s,c,u,l,d,g,p,h,f){i.Config=a,i.ModuleService=e,i.Library=t,i.SettingService=n,i.SyncService=o,i.SessionService=r,i.FirebaseService=s,i.ReadAloud={toolbar:null,main:null},i.UserService=c,i.UsersContentsInfos=u,i.UsersPreferences=l,i.isLoading=!1,i.UserInputsService=d,i.showBanner=!1,i.$on("$stateChangeError",function(e,t,n,o,i,r){e.preventDefault(),console.error('\n            $stateChangeError\n            from "'+o.name+'"\n            (with params: '+JSON.stringify(i)+')\n            to "'+t.name+'"\n            (with params: '+JSON.stringify(n)+")\n        ",r),r&&r.message&&r.message.toLowerCase().includes("book not found")?(e=g.search()).fromBook&&e.fromPage?p.go("reader.book.page",{book:e.fromBook,page:e.fromPage,forbiden:!0},{reload:!0}):a.isSingleMode()?p.go("auth.single-mode"):h.openConfirm({width:"25%",template:"commons/templates/not-found/not-found.html",showClose:!1,appendClassName:"modal-not-found",closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,focusOnOpen:!0,controllerAs:"$ctrl",controller:["ngDialog","$state",function(e,t){this.goToBookshelf=function(){e.close(),t.go("app.library.all",{},{reload:!0}).then(function(){f.location.reload()}).catch(function(e){console.error("Error during state transition:",e)})}}]}):p.go("auth.login")}),i.$on("$stateChangeStart",function(e,t,n,o){o.name!==t.name&&(i.isLoading=!0)}),i.$on("$stateChangeSuccess",function(e,t,n,o){o.name!==t.name&&(i.isLoading=!1)}),function e(){var t=new XMLHttpRequest;t.responseType="text",t.onload=function(){200!==t.status&&console.log("Error, cannot retrieve checksum, status "+t.status);var e=t.response;window.appConfig.appVersion!==e&&location.reload()},t.open("GET","checksum.txt"),t.send(),setTimeout(function(){e()},a.get("checksumTimeoutMs"))}();e=Object.keys(window.appConfig.languages||{}).find(function(e){return window.appConfig.languages[e].default})||"en";i.lang=e}]),angular.module("security",["ui.router","pascalprecht.translate","commons","angular.filter","720kb.datepicker","ngMessages","cg.fileupload","ngDialog","mp.deepBlur","rzModule","ngAria","tmh.dynamicLocale","ngCookies","ngAnimate","toastr","ngSanitize","angular-md5"]).config(["$translateProvider","tmhDynamicLocaleProvider","toastrConfig",function(e,t,n){function o(){document.body.classList.remove("user-is-tabbing"),window.removeEventListener("mousedown",o),window.addEventListener("keydown",a)}var i=localStorage.getItem("lang"),r=(i&&0<=i.indexOf('"')&&(i=i.replace(/\"/g,""),localStorage.setItem("lang",i)),navigator.userAgent),r=new RegExp(["(MSIE|Trident|(?!Gecko.+)Firefox","|(?!AppleWebKit.+Chrome.+)Safari(?!.+Edge)","|(?!AppleWebKit.+)Chrome(?!.+Edge)|(?!AppleWebKit.+Chrome.+Safari.+)Edge","|AppleWebKit(?!.+Chrome|.+Safari)|Gecko(?!.+Firefox))(?: |\\/)([\\d\\.apre]+)"].join(""),"g").exec(r)[1],a=(document.body.className+=r.toLowerCase(),function e(t){9===t.keyCode&&(document.body.classList.add("user-is-tabbing"),window.removeEventListener("keydown",e),window.addEventListener("mousedown",o))}),r=(window.addEventListener("keydown",a),e.useLocalStorage(),e.storageKey("lang"),e.useSanitizeValueStrategy("escaped"),_extends(window.langs,window.appConfig.languages),Object.keys(window.langs)),s=!0,c=!1,u=void 0;try{for(var l,d=r[Symbol.iterator]();!(s=(l=d.next()).done);s=!0){var g=l.value;e.translations(g,window.langs[g].translations)}}catch(e){c=!0,u=e}finally{try{!s&&d.return&&d.return()}finally{if(c)throw u}}i&&r.includes(i)||(c=function(){return(void 0!==navigator.languages?navigator.languages[0]:navigator.language).split("-")[0]},u=r.find(function(e){return window.langs[e].default})||null,i=(r.includes(c())?c():null)||u||"en"),e.preferredLanguage(i),e.use(i),t.defaultLocale(i),t.localeLocationPattern("/components/angular-i18n/angular-locale_{{locale}}.js"),angular.extend(n,{positionClass:"toast-bottom-right"})}]).run(["$rootScope","Config","ModuleService","Library","SettingService","SyncService","SessionService","FirebaseService","UserService","UsersContentsInfos","UsersPreferences","UserInputsService",function(e,t,n,o,i,r,a,s,c,u,l,d){e.Config=t,e.ModuleService=n,e.Library=o,e.SettingService=i,e.SyncService=r,e.SessionService=a,e.FirebaseService=s,e.UserService=c,e.UsersContentsInfos=u,e.UsersPreferences=l,e.isLoading=!1,e.UserInputsService=d,e.$on("$stateChangeError",function(e,t,n,o,i,r){console.log(r)}),e.$on("$stateChangeStart",function(){e.isLoading=!0}),e.$on("$stateChangeSuccess",function(){e.isLoading=!1})}]),angular.module("app").config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/login"),e.state("app",{abstract:!0,templateUrl:"app/app.html",controllerAs:"$ctrl",resolve:{_config:["$window","Config",function(e,t){return t.load(e.appConfig)}],_firebase:["FirebaseService",function(e){return e.injectScripts()}],_books:["Library",function(e){return e.load()}],_licenses:["LicenseService","SessionService",function(e,t){if(!t.getLMS())return e.load()}],_filters:["_books","Config","FilterService",function(e,t,n){return n.load(t.getAppId())}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current,t=(n&&""!=n||(n="default"),t.get("theme").themes[n]);return e.setTheme(t)}],_user:["API","SessionService","UserService","User",function(e,n,o,i){return e.getUser().then(function(e){var t=new i(e);return n.user=t,n.isChapterPreview()&&n.setReaderMode("CHAPTERPREVIEW"),o.checkTermsAndConditions(t),e}).catch(function(){return n.logOut()})}],_legacyUserInputSync:["LegacySyncService","Config","_books","_user","_config",function(e,t,n,o,i){if(!t.hasUsersDataMigratedToDbn())return e.load()}],_userContentsInfos:["UsersContentsInfos","_books","_user",function(e,t,n){return e.load()}],_userPreferences:["UsersPreferences","$translate","_books","_user",function(t,n,e,o){return t.load().then(function(){var e=t.get(t.KEY_USER_LANGUAGE);e&&n.use(e.value)})}]},controller:["$state","Config","SessionService","_config","API","DbnApi","Theme","$scope","$location","NotificationService","FirebaseAnalyticsService",function(e,t,n,o,i,r,a,s,c,u,l){var d=this,g=(this.appName=t.get("appName"),this.accessCodePanelIsVisible=!1,this.iosConfig=t.get("ios"),this.androidConfig=t.get("android"),t.isMobile(this.androidConfig.id,this.iosConfig.storeId));this.primaryColor=a._theme.primaryColor.value,this.hideToolbar=!1,s.$watch(function(){return c.path()},function(e){d.hideToolbar="/profile"===e}),s.$on("notification-banner",function(e,t){d.remoteConfig=t,s.$apply()}),s.$on("maintenance",function(e,t){t&&(window.location=window.location.origin+"/maintenance.html")}),this.remoteConfig=u.communication,this.logout=function(){(n.isJwtTokenSession()?r.logout():i.hapi.get("/v1/reader/users/logout")).then(function(){n.logOut(),l.logout("success"),e.go("auth.login")}).catch(function(){return l.logout("failed")})},this.showAccessCodePanel=function(){this.accessCodePanelIsVisible=!0},this.hideAccessCodePanel=function(){this.accessCodePanelIsVisible=!1},g.mobile&&t.mobileCheckModal(g)}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("auth",{abstract:!0,templateUrl:"auth/auth.html",controllerAs:"AuthCtrl",resolve:{_config:["$window","Config",function(e,t){return t.load(e.appConfig)}],checkSession:["$state","SessionService","Config",function(e,t,n){return t.isLogged().then(function(){n.isSingleMode()||/\btype=[^&]*\b.*\bvalue=[^&]*\b/.test(window.location.href)||e.go(t.goToShelf())}).catch(function(){})}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current,t=(n&&""!=n||(n="default"),t.get("theme").themes[n]);return e.setTheme(t)}],_firebase:["_config","FirebaseService",function(e,t){return t.injectScripts()}]},controller:["$scope","$state","$log","SessionService","Config","NotificationService",function(n,e,t,o,i,r){var a=this,t=(t.debug("AuthCtrl"),this.appName=i.get("appName"),this.iosConfig=i.get("ios"),this.androidConfig=i.get("android"),i.isMobile(this.androidConfig.id,this.iosConfig.storeId));return this.remoteConfig=r.communication,n.$on("notification-banner",function(e,t){a.remoteConfig=r.communication,n.$apply()}),this.logout=function(){o.logOut(),e.go("auth.login")},t.mobile&&i.mobileCheckModal(t),this}]}).state("auth.login",{url:"/login?expired",templateUrl:"auth/login.html",controllerAs:"$ctrl",params:{loginError:null},controller:["API","$state","SessionService","_config","$translate","LocalStorage","Config","$window","ngDialog","UserService","$location","StatisticsService","UsersPreferences","DbnApi","Entity","FirebaseAnalyticsService","oidcAuthorizationUrlQuery",function(u,e,t,n,o,i,r,a,s,c,l,d,g,p,h,f,m){var b=this,v=(i.clear(),this.appName=r.get("appName"),r.isSingleMode()&&e.go("auth.single-mode"),this.isOIDCActive=r.hasOIDCActive(),this.oidcLabel=r.getOIDCLabel(),this.isButtonClicked=!1,this.oidcAuthorizationUrlFn=function(){b.isButtonClicked=!0,b.badLogin=!1;var n=h.generateUUID(),e=window.location.origin+"/oidc.html";p.query(m,{distributionChannelId:r.getAppId(),redirectUri:e,state:n}).then(function(e){var t=e.data.oidcAuthorizationUrl;t&&(i.set("oidcState",n),i.set("oidcCodeVerifier",t.codeVerifier),window.open(t.authorizationUrl,"_self")),e.errors&&(b.badLogin=!0)})},l.search());return v.activationCode&&setTimeout(function(){b.showValidationResult(v)},1e3),v.userLockout&&setTimeout(function(){b.showUnlockResult()},1e3),e.params.expired&&(this.message=o.instant("GT_SESSION_EXPIRED")),e.params.loginError&&(this.badLogin=!0),this.queryMefUser=function(){if(v.from_mef)return!0},this.login=function(){var n=this;this.disabled=!0;(r.enableJwt()?p:u).login({email:this.email,password:this.password}).then(function(){return n.disabled=!1,n.badLogin=!1,d.loginEvent()}).then(function(){return g.load()}).then(function(){var e=i.get("lang"),t=g.get(g.KEY_USER_LANGUAGE);if(t&&e&&e!==t.value)return g.set(g.KEY_USER_LANGUAGE,e)}).then(function(){e.go(t.goToShelf()),c.checkTermsAndConditions(t.getUser())}).then(function(){return u.getCloudFrontCookies()}).then(function(){return f.loginSuccess()}).catch(function(e){var t,c;n.disabled=!1,e&&((t=e.data||null)&&t.statusCode&&"406"==t.statusCode||"USER_NOT_ACTIVATED"===e.message?n.openResend():t&&t.statusCode&&409===t.statusCode?(c=n,s.openConfirm({width:"40%",template:"auth/dialogs/existing-user-login.html",showClose:!1,closeByEscape:!1,focusOnOpen:!0,controllerAs:"$ctrl",controller:["$scope","Config","ngDialog",function(e,t,n){this.termsAndConditionsChecked=!1,this.termsAndConditionsURL=t.getExternalLink("terms"),this.privacyAndPolicyURL=t.getExternalLink("privacy"),this.contactUsURL=t.getExternalLink("contact"),this.appName=t.get("appName");var o=c.email,i=c.password,r=t.getAppId(),a=t.get("workspaceId"),s=t.getExternalLinkDisplay("terms"),s=s&&s.display,t=t.get("features")&&t.get("features").termsValidationMandatory&&!0===t.get("features").termsValidationMandatory.value;this.validateTerms=t||s,this.linkAccount=function(){n.close();var e,t=[];c.termsAndConditionsURL&&(t=[{type:"terms",current:e={date:Date.now(),url:c.termsAndConditionsURL,version:c.termsAndConditionsVersion},list:[e]}]),u.hapi.post("/ap/users/link-to-service",{email:o,password:i,app:{id:r,type:"distrib",conditions:t},workspace_id:a,type:"web"}).then(function(){c.login()})}}]}).catch(function(e){console.log(e)})):t&&t.statusCode&&"429"==t.statusCode||"USER_LOCKED"===e.message?(n.badLogin=!0,n.userLocked=!0):(n.badLogin=!0,n.userLocked=!1,f.loginFailed())),console.log(e)})},this.showValidationResult=function(e){var t=e.activationCode,e=decodeURIComponent(e.email),n=b.language;s.openConfirm({template:"auth/dialogs/user-validation-result.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{status:t,email:e,lang:n},controllerAs:"$ctrl",controller:["$scope","$state",function(e,t){var n=this;this.VALIDATION_OK="ok",this.VALIDATION_KO="ko",this.VALIDATION_NOT_FOUND="notFound",this.status=e.ngDialogData.status,this.email=e.ngDialogData.email,this.lang=e.ngDialogData.lang,this.title=function(){var e="";return n.status===n.VALIDATION_OK?e="":n.status===n.VALIDATION_KO?e=o.instant("GT_ACTIVATION_CODE_KO_TITLE"):n.status===n.VALIDATION_NOT_FOUND&&(e=o.instant("GT_ACTIVATION_CODE_NOT_FOUND_TITLE")),e},this.message=function(){var e="";return n.status===n.VALIDATION_OK?e=o.instant("GT_ACTIVATION_CODE_OK_MSG"):n.status===n.VALIDATION_KO?e=o.instant("GT_ACTIVATION_CODE_KO_MSG"):n.status===n.VALIDATION_NOT_FOUND&&(e=o.instant("GT_ACTIVATION_CODE_NOT_FOUND_MSG")),e},this.showButton=function(e){return n.status===e},this.resendValidationMail=function(){var e,t;n.email&&(e=r.get("appId"),t=r.get("workspaceId"),c.resendActivationCode(t,e,n.email,n.lang).then(function(){s.close(),s.openConfirm({width:"20%",template:"auth/dialogs/email-sent.html",showClose:!1})}).catch(function(e){console.log("Error on resendActivationCode: ",e)})),s.close()},this.goToRegister=function(){s.close(),t.go("auth.register")}}]}).catch(function(){})},this.showUnlockResult=function(){s.openConfirm({template:"auth/dialogs/user-lockout-confirmation.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",controllerAs:"$ctrl",controller:function(){this.close=function(){s.close()},this.message=o.instant("GT_USER_LOCKOUT_CONFIRMATION")}}).catch(function(){})},this.openResend=function(){var e=b.email,t=r.get("appId"),n=r.get("workspaceId"),o=b.language;c.showResendValidationEmail(n,t,e,o)},this}]}).state("auth.register",{url:"/register?token&email",templateUrl:"auth/register.html",controllerAs:"$ctrl",resolve:{singleMode:["Config","$q","$state",function(e,t,n){if(e.isSingleMode())return(e=t.defer()).resolve(),e.promise.then(function(){n.go("auth.login")})}]},controller:["API","$state","Config","UserService","ngDialog","LocalStorage","FirebaseAnalyticsService","DbnApi",function(o,i,r,a,e,s,c,u){return this.termsAndConditionsURL=r.getExternalLink("terms"),this.termsAndConditionsVersion=r.getExternalLinkVersion("terms"),this.privacyAndPolicyURL=r.getExternalLink("privacy"),this.contactUsURL=r.getExternalLink("contact"),i.params.email&&(this.email=i.params.email,this.repeatEmail=i.params.email),this.register=function(){var t=this,e=[],n=(this.termsAndConditionsURL&&(e=[{type:"terms",current:n={date:Date.now(),url:this.termsAndConditionsURL,version:this.termsAndConditionsVersion},list:[n]}]),void 0);(r.enableJwt()?(n={email:this.email,password:this.password,firstName:this.firstName,lastName:this.lastName},u):(n={email:this.email,password:this.password,identity:this.firstName+" "+this.lastName,workspace_id:r.get("workspaceId"),lang:s.get("lang"),app:{id:r.get("appId"),type:"distrib",conditions:e},type:"web"},i.params.token&&(n.registerToken=i.params.token,n.institution={conditions:n.app.conditions},delete n.app,delete n.workspace_id),o)).register(n).then(function(e){if("This email is already registered or not valid"===e.message)throw new Error(e.message);if(e.data&&0<e.data.register.userErrors.length)throw new Error("This email is not valid")}).then(function(){var e=t.email;a.showConfirmationRegistering(e)}).then(function(){t.badRegister=!1,c.register("success"),i.go("auth.login")}).catch(function(e){t.badRegister=!0,c.register("failed"),console.log(e)}).finally(function(){return t.registrationDisabled=!1})},this}]}).state("auth.forgot",{url:"/forgot-password",templateUrl:"auth/forgot.html",controllerAs:"$ctrl",resolve:{_redirect:["ModuleService","$state","Config","$window","$q",function(e,t,n,o,i){i=i.defer();return e.hasModule("passwordRecovery")?((e=n.get("screens").passwordRecovery)&&e.external?o.location.href=e.external:i.resolve(),i.promise):t.go("auth.login")}]},controller:["API","DbnApi","SessionService","$state",function(e,t,n,o){var i=this;return this.forgotPassword=function(){i.email&&0!==i.email.length&&(n.isJwtTokenSession()?t.resetPassword(i.email).then(function(e){i.badLogin=!1,i.errorEmailNotExist=!1,setTimeout(function(){o.go("auth.forgot-sent",{email:i.email,services:e.data.services})},1500)}):e.resetPassword(i.email).then(function(e){if(200!==e.status)throw new Error("Error when resetting password.");i.badLogin=!1,i.errorEmailNotExist=!1,setTimeout(function(){o.go("auth.forgot-sent",{email:i.email,services:e.data.services})},1500)}).catch(function(e){e&&405===e.status&&(i.errorEmailNotExist=!0),console.trace(e)}))},this}]}).state("auth.reset",{url:"/reset-password/:userid/:token",templateUrl:"auth/reset.html",controllerAs:"$ctrl",controller:["API","$state",function(e,t){var n=this;return this.password="",this.repeatPassword="",e.validateOneTimeReset(t.params.userid,t.params.token).then(function(){n.isValid=!0}).catch(function(){n.isValid=!1}),this.confirmPassword=function(){n.password===n.repeatPassword&&e.confirmNewPassword(t.params.userid,t.params.token,n.password).then(function(){t.go("auth.login")}).catch(function(e){console.log(e)})},this}]}).state("auth.forgot-sent",{url:"/forgot-sent",templateUrl:"auth/forgot-sent.html",controllerAs:"$ctrl",params:{email:"",services:0},controller:["$state","$stateParams",function(e,t){this.email=t.email,this.services=t.services,this.confirm=function(){e.go("auth.login")}}]}).state("auth.single-mode",{url:"/session-expired",templateUrl:"auth/single-mode.html",controllerAs:"$ctrl",params:{clearStorage:!0},controller:["LocalStorage",function(e){return this.clearStorage&&e.clear(),this}]}).state("auth.token_login",{url:"/login/sso/{token}",templateUrl:"",controllerAs:"$ctrl",controller:["API","$state","SessionService",function(t,n,o){var i=this;t.hapi.get("/v1/reader/users/sso",{params:{aptoken:n.params.token}}).then(function(e){t.afterLogin(e.data),i.badLogin=!1,n.go(o.goToShelf())})}]}).state("auth.sso-dbn-jwt",{url:"/login/sso-dbn-jwt/?accessToken&refreshToken}",templateUrl:"",controllerAs:"$ctrl",controller:["$state","DbnApi","SessionService",function(e,t,n){var o=this,i=e.params,r=i.accessToken,i=i.refreshToken;return t.postLogin(r,i).then(function(){o.badLogin=!1,e.go(n.goToShelf())})}]}).state("auth.openid",{url:"/login/oidc?code&state&iss&token",templateUrl:"auth/oidc.html",controllerAs:"$ctrl",controller:["$state","DbnApi","API","SessionService","LocalStorage","Config","connectWithOidcMutation","ngDialog","$translate","UserService","$rootScope",function(i,n,r,a,s,c,e,u,l,d,g){var t,o=this,p=(g.loadMessage=l.instant("GT_SSO_LOADING_MESSAGE_LOGGING_IN"),g.isSSO=!0,i.params),h=p.code,f=p.state,p=p.iss,m=(m=i.params.token)||s.get("readerOptionsToken"),b=s.get("referenceType"),v=s.get("referenceValue"),I=(this.afterLoginRedirect=function(){var e,t,n,o;g.loadMessage=l.instant("GT_SSO_LOADING_MESSAGE_RETRIEVING_BOOK_INFO"),c.isSingleMode()?(t=(n=(e=a.getBookLocation()).reference).type,n=n.value,o=e.pageId,a.setSingleModeConfig({isbn:n}),a.setReaderMode("SINGLE"),r.getBookIdByExternalReference(c.getAppId(),t,n).then(function(e){o&&s.set("pageId",o),i.go("reader.book",{book:e})}).catch(function(){s.clear(),i.go("auth.single-mode")})):b&&v?r.getBookIdByExternalReference(c.getAppId(),b,v).then(function(e){i.go("reader.book",{book:e}),d.checkTermsAndConditions(a.getUser())}).catch(function(){i.go(a.goToShelf()),u.openConfirm({template:l.instant("GT_BOOK_NOT_AUTHORIZED"),plain:!0,closeByDocument:!0,closeByEscape:!0,showClose:!0,width:"35%",focusOnOpen:!0})}).finally(function(){s.remove("referenceType"),s.remove("referenceValue")}):i.go(a.goToShelf())},this.redirectAfterLoginError=function(){return c.isSingleMode()?i.go("auth.single-mode"):i.go("auth.login",{loginError:!0})},s.get("oidcCodeVerifier")),y=s.get("oidcState");s.remove("oidcCodeVerifier"),s.remove("oidcState"),h&&f&&I&&y?(t=window.location.origin+"/oidc.html",h={code:h,state:f},p&&(h.iss=p),n.mutate(e,{distributionChannelId:c.getAppId(),redirectUri:t,callbackParams:h,callbackChecks:{code_verifier:I,state:y},readerOptionsToken:m},{authorization:void 0}).then(function(e){var t=e.data.connectWithOidc;if(t&&t.accessToken)return c.enableJwt()?n.postLogin(t.accessToken,t.refreshToken).then(function(){return o.afterLoginRedirect()}):r.hapi.get("/v1/reader/users/sso",{params:{aptoken:t.accessToken}}).then(function(e){return r.afterLogin(e.data),o.afterLoginRedirect()});(e.errors||t&&t.userErrors.length)&&o.redirectAfterLoginError()}).catch(function(){o.redirectAfterLoginError()})):this.redirectAfterLoginError()}]}).state("auth.openidAutoConnect",{url:"/login/oidc-auto-connect?token&type&value",templateUrl:"auth/oidc.html",controllerAs:"$ctrl",controller:["$state","DbnApi","Entity","LocalStorage","Config","oidcAuthorizationUrlQuery","$rootScope","$translate",function(e,t,n,o,i,r,a,s){o.clear();var e=e.params,c=e.token,u=e.type,l=e.value,d=n.generateUUID(),e=window.location.origin+"/oidc.html";a.loadMessage=s.instant("GT_SSO_LOADING_MESSAGE_LOGGING_IN"),t.query(r,{distributionChannelId:i.getAppId(),redirectUri:e,state:d}).then(function(e){e=e.data.oidcAuthorizationUrl;e&&(o.set("oidcState",d),o.set("oidcCodeVerifier",e.codeVerifier),c&&o.set("readerOptionsToken",c),u&&l&&(o.set("referenceType",u),o.set("referenceValue",l)),window.open(e.authorizationUrl,"_self"))})}]}).state("auth.previewOpenidAutoConnect",{url:"/preview/oidc-auto-connect?token",templateUrl:"auth/oidc.html",controllerAs:"$ctrl",controller:["$state","DbnApi","Entity","LocalStorage","Config","isValidPreviewReaderOptionsTokenQuery","connectWithOidcMutation","SessionService","ngDialog","API",function(i,n,t,r,a,e,o,s,c,u){var l=this,d=(r.clear(),i.params.token);if(!d)return i.go("auth.single-mode");var g=t.generateUUID();this.afterLoginRedirect=function(){var e=s.getBookLocation(),t=e.reference,n=t.type,t=t.value,o=e.pageId;s.setSingleModeConfig({isbn:t}),s.setReaderMode("CHAPTERPREVIEW"),c.openConfirm({template:"app/reader/components/chapter-preview-message/chapter-preview-message.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"40%",controllerAs:"$ctrl"}),u.getBookIdByExternalReference(a.getAppId(),n,t).then(function(e){o&&r.set("pageId",o),i.go("reader.book",{book:e})}).catch(function(){r.clear(),i.go("auth.single-mode")})},n.query(e,{distributionChannelId:a.getAppId(),readerOptionsToken:d}).then(function(e){if(!e.data.isValidPreviewReaderOptionsToken)return i.go("auth.single-mode");e=window.location.origin+"/oidc.html";n.mutate(o,{distributionChannelId:a.getAppId(),redirectUri:e,callbackParams:{code:t.generateUUID(),state:g},callbackChecks:{code_verifier:t.generateUUID(),state:g},readerOptionsToken:d},{authorization:void 0}).then(function(e){var t=e.data.connectWithOidc;if(t&&t.accessToken){if(a.enableJwt())return n.postLogin(t.accessToken,t.refreshToken).then(function(){return l.afterLoginRedirect()});console.warn("Maintenance: OIDC preview is not supported for non migrated workspaces"),i.go("auth.single-mode")}if(e.errors||t&&t.userErrors.length)return i.go("auth.single-mode")}).catch(function(){return a.isSingleMode()?i.go("auth.single-mode"):i.go("auth.login")})})}]})}]),angular.module("commons",[]),angular.module("security").controller("ResetPasswordController",["API","DbnApi","SessionService","$state",function(e,t,n,o){var i=this;return this.password="",this.repeatPassword="",e.validateOneTimeReset(o.params.userid,o.params.token).then(function(){i.isValid=!0}).catch(function(){i.isValid=!1}),this.confirmPassword=function(){i.password===i.repeatPassword&&(n.isJwtTokenSession()?t.resetPasswordConfirm(o.params.token,i.password,i.repeatPassword).then(function(){n.logOut()}).catch(function(e){console.log(e)}):e.confirmNewPassword(o.params.userid,o.params.token,i.password).then(function(){window.location=window.location.origin}).catch(function(e){console.log(e)}))},this}]),angular.module("security").config(["$stateProvider",function(e){e.state("security",{abstract:!0,templateUrl:"security/security.html",resolve:{_config:["$window","Config",function(e,t){return t.load(e.appConfig)}],checkSession:["$state","SessionService","Config",function(e,t,n){return t.isLogged().then(function(){n.isSingleMode()||e.go(t.goToShelf())}).catch(function(){})}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current,t=(n&&""!=n||(n="default"),t.get("theme").themes[n]);return e.setTheme(t)}]}}).state("security.reset-password",{url:"/reset-password/:userid/:token",templateUrl:"security/reset-password.html",controllerAs:"$ctrl",controller:"ResetPasswordController"}).state("security.confirm-email",{url:"/confirm-email",templateUrl:"security/confirm-email/confirm-email.html",controllerAs:"$ctrl",controller:"ConfirmEmailController"}).state("security.wr-not-accessible",{url:"/wr-not-accessible",controllerAs:"$ctrl",controller:"WrNotAccessibleController"})}]),angular.module("security").controller("WrNotAccessibleController",["Config","_config","$location","ngDialog","$translate","UserService",function(o,e,t,i,r,a){var s=this,n=(this.iosConfig=o.get("ios"),this.androidConfig=o.get("android"),o.isMobile(this.androidConfig.id,this.iosConfig.storeId)),c=t.search();n.mobile?(o.mobileCheckModal(n),c.activationCode&&setTimeout(function(){s.showValidationResult(c)},1e3)):o.hasWebreader()?(t=window.location.origin,c.activationCode&&(t=t+"/#!/login?activationCode="+c.activationCode,c.email)&&(t=t+"&email="+encodeURIComponent(c.email)),window.location=t):(o.wrNotExists(),c.activationCode&&setTimeout(function(){s.showValidationResult(c)},1e3)),this.showValidationResult=function(e){var t=e.activationCode,e=decodeURIComponent(e.email),n=s.language;i.openConfirm({template:"auth/dialogs/user-validation-result.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{status:t,email:e,lang:n},controllerAs:"$ctrl",controller:["$scope",function(e){var n=this;this.VALIDATION_OK="ok",this.VALIDATION_KO="ko",this.VALIDATION_NOT_FOUND="notFound",this.status=e.ngDialogData.status,this.email=e.ngDialogData.email,this.lang=e.ngDialogData.lang,this.title=function(){var e="";return n.status===n.VALIDATION_OK?e="":n.status===n.VALIDATION_KO?e=r.instant("GT_ACTIVATION_CODE_KO_TITLE"):n.status===n.VALIDATION_NOT_FOUND&&(e=r.instant("GT_ACTIVATION_CODE_NOT_FOUND_TITLE")),e},this.message=function(){var e="";return n.status===n.VALIDATION_OK?e=r.instant("GT_ACTIVATION_CODE_OK_MSG"):n.status===n.VALIDATION_KO?e=r.instant("GT_ACTIVATION_CODE_KO_MSG"):n.status===n.VALIDATION_NOT_FOUND&&(e=r.instant("GT_ACTIVATION_CODE_NOT_FOUND_MSG")),e},this.showButton=function(e){return n.status===e},this.resendValidationMail=function(){var e,t;n.email&&(e=o.get("appId"),t=o.get("workspaceId"),a.resendActivationCode(t,e,n.email,n.lang).then(function(){i.close(),i.openConfirm({width:"20%",template:"auth/dialogs/email-sent.html",showClose:!1})}).catch(function(e){console.log("Error on resendActivationCode: ",e)})),i.close()},this.goToRegister=function(){i.close(),window.location=window.location.origin}}]}).catch(function(){})}}]),angular.module("app").controller("AssignmentsController",["$state","Library","$scope","$filter","$translate","$rootScope","Config","UsersPreferences",function(e,t,n,o,i,r,a,s){var c=this;this.assignments=[],this.selectedAssignment=null,this.filteredAssignments=[],this.filters={type:{filterValue:"",defaultValue:"",testCondition:function(e,t){return e===t}},subject:{filterValue:"",testCondition:function(e,t){return e===t}},due_date:{filterValue:null,defaultValue:"",testCondition:function(e,t){return!e||(e=(e=new Date(e))instanceof Date&&!isNaN(e.valueOf())?e.toISOString().split("T")[0]:e)===(t=t.split("T")[0])}}},this.$onInit=function(){r.Config.hasScreenSorter("assignments")?c.configSorting=r.Config.getScreenSorter("assignments"):c.configSorting=[{enabled:!0,label:"GT_SORT_DUE_DATE",target:"due_date",orderBy:"desc"},{enabled:!0,label:"GT_SORT_ASSIGNMENT_DATE",target:"start_date",orderBy:"desc"}];var e=s.get(s.KEY_DESK_ASSIGNMENT_SORTER);c.chosenSortOption=c.configSorting[0],e&&(e=c.sortMethodConfig(e.value))&&(c.chosenSortOption=e)},n.$on("show-assignment-info-panel",function(e,t){c.selectedAssignment=t}),"app.assignments.archive"===e.current.name?(this.assignments=t.getArchivedAssignments(),this.filteredAssignments=t.getArchivedAssignments()):(this.assignments=t.getActiveAssignments(),this.filteredAssignments=t.getActiveAssignments()),this.types=t.getAssignmentTypes(),this.subjects=t.getAssignmentSubjects(),this.sortMethodConfig=function(t){return c.configSorting.find(function(e){return e.label===t})},this.translatedType=function(e){return i.instant("GT_CONTENT_TYPE_"+e.toUpperCase())},this.applyFilters=function(n){"app.assignments.archive"==e.current.name?c.filteredAssignments=t.getArchivedAssignments():c.filteredAssignments=t.getActiveAssignments(),Object.keys(n).forEach(function(t){n[t].filterValue&&0!==n[t].filterValue.length&&(c.filteredAssignments=c.filteredAssignments.filter(function(e){return n[t].testCondition(n[t].filterValue,e[t])}))})},this.applySorts=function(e){s.set(s.KEY_DESK_ASSIGNMENT_SORTER,e.label),c.filteredAssignments=o("orderBy")(c.filteredAssignments,e.target)},this.clearFilters=function(e){e?e.defaultValue?e.filterValue=e.defaultValue:e.filterValue=null:Object.keys(c.filters).forEach(function(e){e.filterValue=e.defaultValue||null}),c.applyFilters(c.filters)},this.closeAssignmentInfo=function(){c.selectedAssignment=null},angular.element(document).ready(function(){var e,t;document.querySelector("#datepicker")&&(e=document.querySelector("#datepicker")).querySelector("div")&&(t=e.querySelector("div")).addEventListener("focusout",function(e){t.contains(e.relatedTarget)||t.classList.remove("_720kb-datepicker-open")})})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.assignments",{url:"/assignments",abstract:!0,templateUrl:"app/assignments/home.html",controllerAs:"$ctrl",resolve:{_assignments:["Library","_books",function(e,t){return e.loadAssignments()}]},controller:function(){}}).state("app.assignments.all",{url:"",abstract:!1,templateUrl:"app/assignments/list.html",controllerAs:"$ctrl",controller:"AssignmentsController"}).state("app.assignments.archive",{url:"/archive",abstract:!1,templateUrl:"app/assignments/list.html",controllerAs:"$ctrl",controller:"AssignmentsController"})}]),angular.module("app").controller("LibraryController",["$state","Library","$scope","LocalStorage","FilterService","LicenseService","toastr","$translate","ReadSpeakerService",function(e,t,n,o,i,r,a,s,c){var u=this;switch(o.get("view")||o.set("view","grid"),this.books=[],this.sort=null,this.selectedBook=null,this.view=o.get("view"),this.filter={},this.metaFilters=[],i.loadFilters(),this.expireLicenseNotification=r.showNotification,n.$state=e,n.$on("show-info-panel",function(e,t){u.selectedBook=t}),this.closeBookInfo=function(){u.selectedBook=null},this.resetFilters=function(){u.metaFilters=[],u.setBooks()},this.setBooks=function(){u.metaFilters.length?u.books=i.getFilteredBooks():u.books=i.books},this.checkExpireSoonBooks=function(e){var e=r.getExpireProjectIds(e),t=o.get("expiredProjectIds");e&&e.length&&JSON.stringify(e)!==JSON.stringify(t)&&(o.set("expiredProjectIds",e),t=s.instant("GT_CONTENT_LICENSE_SOON_TO_EXPIRE_MESSAGE"),a.info(t,{toastClass:"toast license-toast",timeOut:1e4,iconClass:"license-toast-icon"}))},e.current.name){case"app.library.books":this.books=t.getShelfBooks(),this.checkExpireSoonBooks(this.books),c.resetState();break;case"app.library.modules":this.books=t.getModules(),c.resetState();break;case"app.library.resources":this.books=t.getResources();break;case"app.library.favourites":this.books=t.getFavourites();break;default:this.books=t.getShelfBooks(),this.checkExpireSoonBooks(this.books),c.resetState()}}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.library",{url:"/library",abstract:!0,templateUrl:"app/library/home.html",controllerAs:"$ctrl",resolve:{redirect:["ModuleService","$state",function(e,t){!e.hasModule("shelf")&&e.hasModule("assignments")&&t.go("app.assignments.all")}],singleMode:["Config","$q","$state",function(e,t,n){if(e.isSingleMode())return(e=t.defer()).resolve(),e.promise.then(function(){n.go("auth.login")})}],_contentsInfos:["UsersContentsInfos",function(e){return e.load()}]},controller:["Library","_contentsInfos",function(e,t){this.books=e.getContentsInfos()}]}).state("app.library.all",{url:"",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.books",{url:"/books",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.modules",{url:"/modules",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.resources",{url:"/resources",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"}).state("app.library.favourites",{url:"/favourites",templateUrl:"app/library/list.html",controllerAs:"$ctrl",controller:"LibraryController"})}]),angular.module("app").controller("BookController",["Library","$state","$rootScope","$scope","$location","LocalStorage","BookmarkService","StatisticsService","$timeout","toastr","Iframe","PaginationService","SessionService","Config","UsersContentsInfos","$translate","$filter","ngDialog","$stateParams","KeyCodesService","FirebaseAnalyticsService",function(o,r,i,a,s,c,u,l,d,g,p,e,h,f,m,b,v,t,I,y,k){var n,_=this;function T(e){var t,n=document.getElementById("toc-container"),o=document.getElementById("skipToContent"),i=document.getElementById("go-to-page-input"),r=document.getElementById("backToLibrary"),a=document.getElementById("close-sidebar-toggle"),s=document.getElementById("go-to-page-button"),c=document.getElementById("reader-accessibility"),u=document.getElementById("menu-dropdown"),l=null;document.getElementById("open-sidebar-toggle")&&(l=angular.element(document.getElementById("open-sidebar-toggle")).controller().showSidebar),y.isEnter(e)?(t=document.getElementById("skipToContent"),p&&t&&t===document.activeElement?(e.preventDefault(),p.setFocusOnContent()):"open-sidebar-toggle"===document.activeElement.id?d(function(){document.getElementById("close-sidebar-toggle").focus()}):"close-sidebar-toggle"===document.activeElement.id&&d(function(){document.getElementById("open-sidebar-toggle").focus()})):y.isTab(e)&&l&&(this.first&&this.quickTourOpened?(o.focus(),this.first=!1):this.quickTourOpened?(this.first=!1,document.getElementById("closeQuickTourDialog").focus(),document.activeElement===document.getElementById("backToLibrary")&&document.getElementById("closeQuickTourDialog").focus()):n&&o===document.activeElement?(e.preventDefault(),setTimeout(function(){n.focus()})):n===document.activeElement?(e.preventDefault(),setTimeout(function(){(y.shiftPrePressed(e)?o:i).focus()})):i===document.activeElement?y.shiftPrePressed(e)?(e.preventDefault(),setTimeout(function(){n.focus()})):s?(e.preventDefault(),setTimeout(function(){s.childNodes[0].focus()})):(e.preventDefault(),r?setTimeout(function(){r.focus()}):setTimeout(function(){a.focus()})):(t=s)&&t.childNodes[0]===document.activeElement?y.shiftPrePressed(e)?(e.preventDefault(),setTimeout(function(){i.focus()})):(e.preventDefault(),r?setTimeout(function(){r.focus()}):setTimeout(function(){a.focus()})):r===document.activeElement?(e.preventDefault(),y.shiftPrePressed(e)?s?setTimeout(function(){s.childNodes[0].focus()}):setTimeout(function(){i.focus()}):a.focus()):a===document.activeElement?l&&r&&y.shiftPrePressed(e)&&(e.preventDefault(),setTimeout(function(){r.focus()})):c.contains(document.activeElement)&&!y.shiftPrePressed(e)&&!u.contains(document.activeElement)&&this.isElementVisible(u)&&(e.preventDefault(),document.querySelector("*[tabindex='-2']").focus()))}if(this.$onInit=function(){_.showSidebar=!0,_.quickTourOpened=!1,_.Iframe=p,_.book=o.getBookByContentId(r.params.book),_.bookTitle=_.book.getTitle(),_.navigationDirection=_.book.getPaginationMode(),_.showSearch=!1,_.privacyAndPolicyURL=f.getExternalLink("privacy"),_.termsAndConditionsURL=f.getExternalLink("terms"),_.contactUsURL=f.getExternalLink("contact"),_.isContactUsEmail=_.contactUsURL&&-1<_.contactUsURL.indexOf("@"),_.helpURL=f.getExternalLink("help"),_.openNewTab=f.openNewTab(),_.topbarStyle=_.book.getTopbarStyle(),_.showTopbar=_.book.showTopbar(),_.showTOC=_.book.showTOC(),_.readerSearchFeature=_.book.readerSearchFeature(),_.readerBookmarkFeature=_.book.readerBookmarkFeature(),_.readerHighlightFeature=_.book.readerHighlightFeature(),_.readerNoteFeature=_.book.readerNoteFeature(),_.readerGtAudio=_.book.readerGtAudio(),_.hasActiveInputFeatures=_.readerHighlightFeature||_.readerNoteFeature||_.readerBookmarkFeature,_.accessibilityFeatures=_.book.accessibilityFeatures(),_.isFirefox="undefined"!=typeof InstallTrigger,_.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),_.ariaLive=_.isFirefox?"off":"polite";var n=!(!_.book.isPDF()&&!_.book.isNativeGtContent())||_.book.countPages&&!!_.book.countPages.length,e=(_.bookmarksAriaLive="off",_.sharingId=null,_.chapterPreview={enabled:h.isChapterPreview(),pages:h.chapterPreviewAllowedPages()},_.first=!0,s.search()),t=(_.fromBook=e.fromBook,_.fromPage=e.fromPage,_.title=e.fromTitle,_.fromTitle=v("readMore")(_.title,{size:25}),_.isReferredPage=_.fromBook&&_.fromPage,b.instant("GT_CONTENT_FORBIDDEN_ACCESS")),e=e.fromToken;_.bookmarks=new Map,I.forbiden&&g.warning(t,{toastClass:"toast toast-black",timeOut:5e3}),e&&h.getToken()!==e&&(h.logOut(),r.go("auth.login")),document.addEventListener("shiftPressed",function(){i.shiftPressed=!0}),document.addEventListener("shiftReleased",function(){i.shiftPressed=!1});document.getElementById("skipToContent").addEventListener("click",function(){p.setFocusOnContent()}),document.body.addEventListener("keyup",function(e){var t=document.querySelectorAll("#next-page")[1],n=document.querySelectorAll("#previous-page")[1];t!=document.activeElement||_.isSafari?n!=document.activeElement||_.isSafari||(e.preventDefault(),n.setAttribute("role","tab")):(e.preventDefault(),t.setAttribute("role","tab"))});a.$on("ngDialog.closing",function(){_.quickTourOpened=!1}),document.addEventListener("keydown",T.bind(_)),["EDIT","SINGLE","CHAPTERPREVIEW"].includes(h.readerMode)&&(_.user=h.getUser());var t=r.params.assignment;t?(_.sharingId=t,o.loadAssignmentId(t).then(function(e){_.assignment=e})):_.sharingId=_.book.getSharingId(),_.contentsInfos=m.getBySharingId(_.sharingId),_.getBookTitle=function(){return _.book.getTopbarTitle(r.params.page)},_.getFullTitle=function(){return _.book.getTopbarTitle(r.params.page)},_.loadIframe=function(){p.isReady?(p.pageScale=10,_.goToPageArrow=function(e){return p.goToPageArrow(e)},document.addEventListener("keydown",_.goToPageArrow)):setTimeout(function(){_.loadIframe()},500)},_.getTopbarTitle=function(){var e=_.book.getTopbarTitle(r.params.page);return e?v("readMore")(e,{size:140,html:!0}):""},_.openAccessibilityEvent=function(e){i.$emit("remove-selection"),e&&document.activeElement.getElementsByClassName("color-inherit")[1].click()},_.isPrintEnabled=function(){var e,t;if(_.user&&_.user.apps.length)return e=f.hasFeature("print")&&n,_.user.thirdparties.cengage&&void 0!==(t=_.user.thirdparties.cengage.enablePrint)?e&&t:e},r.params.page?(e=_.book.getPage(r.params.page))&&(t={date:Date.now(),pageId:e.path||e.id,pageTitle:e.title||e.num},m.updateLastOpening(_.sharingId,t)):(e=c.get("pageId")||_.lastOpenPageId(),c.remove("pageId"),_.chapterPreview.enabled&&(e=_.chapterPreview.pages.includes(e)?e:_.chapterPreview.pages[0]),t=_.book.getPage(e,_.book.structure.toc),e&&t?r.go("reader.book.page",{page:e}):0<_.book.pages.length&&(t=_.book.structure.version?_.book.structure.pagesList[0]:_.book.getPage(_.book.pages[0].path),r.go("reader.book.page",{page:_.chapterPreview.enabled?_.chapterPreview.pages[0]:t.path||t.id})),t&&(e={date:Date.now(),pageId:t.path||t.id,pageTitle:t.title||t.num},m.updateLastOpening(_.sharingId,e))),u.getBookmarks(_.sharingId).then(function(e){e.forEach(function(e){_.bookmarks.set(e.pageId,e)})}),_.loadIframe()},this.isElementVisible=function(e){return 0<e.offsetWidth&&0<e.offsetHeight},a.$on("$destroy",function(){document.removeEventListener("keydown",T.bind(this))}),this.goToReferPage=function(){r.go("reader.book.page",{book:_.fromBook,page:_.fromPage})},i.$on("elementToFocus",function(e,t){_.lastFocusedItem=t}),this.lastOpenDate=function(){return _.contentsInfos&&_.contentsInfos.options&&_.contentsInfos.options.lastOpen?_.contentsInfos.options.lastOpen.date:null},this.nextPageNumber=function(){if(_.nextPage())return _.nextPage().logicalPageNumber||_.nextPage().num||_.book.getIndexOfUniquePage(_.nextPage().path)+1},this.previousPageNumber=function(){if(_.previousPage())return _.previousPage().logicalPageNumber||_.previousPage().num||_.book.getIndexOfUniquePage(_.previousPage().path)+1},this.lastOpenPageId=function(){var e;return _.contentsInfos&&_.contentsInfos.options&&_.contentsInfos.options.lastOpen&&(e=_.book.getPage(_.contentsInfos.options.lastOpen.pageId))?e.path||e.id:null},this.lastOpenPageTitle=function(){return _.contentsInfos&&_.contentsInfos.options&&_.contentsInfos.options.lastOpen?_.contentsInfos.options.lastOpen.pageTitle:null},this.toggleBookmark=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=_.book.getPageFromContent(r.params.pageId||r.params.page),_.isPageBookmarked())return n=_.bookmarks.get(t.path),_.bookmarks.delete(t.path),e.next=6,u.remove(n);e.next=10;break;case 6:k.bookmark("deleted",_.bookmarks.get(t.path),_.book,t),l.userInputsEvent({type:"bookmark",action:"delete",pageId:t.path,bookId:_.book.id,bookISBN:_.book.isbn||null,pageIndex:n.pageNumber}),e.next=17;break;case 10:return o={id:u.computeId(t.path),distributionChannelId:f.getAppId(),projectId:_.sharingId,bookVersion:parseInt(_.book.getVersion(),10),pageId:t.path,pageTitle:t.title,pageNumber:_.book.getIndexOfPageForAnnotationsSort(r.params.page)},e.next=13,u.upsertBookmark(o);case 13:i=e.sent,k.bookmark("created",i,_.book,t),l.userInputsEvent({type:"bookmark",action:"create",pageId:t.path,bookId:_.book.id,bookISBN:_.book.isbn||null,pageIndex:o.pageNumber}),_.bookmarks.set(t.path,i);case 17:_.bookmarksAriaLive=_.ariaLive,a.$apply();case 19:case"end":return e.stop()}},e,_)})),this.isPageBookmarked=function(){var e=c.get("pageId")||_.lastOpenPageId(),e=_.book.getPageFromContent(r.params.pageId||r.params.page||e),e=_.bookmarks.get(e.path);return e?(_.isPageBookmarkedTitle=b.instant("GT_READER_BOOKMARK_ACTION_MARKED_ACCESS_LABEL"),!e.deleted):(_.isPageBookmarkedTitle=b.instant("GT_READER_BOOKMARK_ACTION_UNMARKED_ACCESS_LABEL"),!1)},this.nextPage=function(){return _.book.nextPage(r.params.page)},this.previousPage=function(){return _.book.previousPage(r.params.page)},this.toggleSidebar=function(){_.showSidebar=!_.showSidebar;var e={left:0,top:0};_.showSidebar&&(e={left:260,top:0}),p.setToolbarMargin(e.left,e.top)},this.toggleAnnotation=function(){e.reset(),r.go("reader.userinput",{book:_.book.book_content_id})},this.getToolbarStatus=function(e){var t=b.instant("GT_USER_INPUTS_EXPAND");return e&&(t=b.instant("GT_USER_INPUTS_COLLAPSE")),b.instant("GT_READER_SHOW_TOC_ACCESS_LABEL")+", "+t},this.toggleSearch=function(){_.showSearch||r.go("reader.book.page",{page:r.params.page},{reload:!1}),_.showSearch=!_.showSearch},this.chapterPreviewMoreInfo=function(){t.openConfirm({template:"app/reader/components/chapter-preview-message/chapter-preview-message.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"35%",controllerAs:"$ctrl"})},this.singlePagePrint=function(){return _.book.isEpubFixed()||_.book.isEpubReflow()||_.book.isNativeGtContent()},this.getFirstShownTocItem=function(){return document.getElementById("toc-container").querySelector('[role="treeitem"]')},!r.params.page){if(!this.book)return;var E=this.book.getSharingId(),E=(this.assignment&&(E=this.assignment.id),c.get(E));E?r.go("reader.book.page",{page:E}):0<this.book.pages.length&&r.go("reader.book.page",{page:this.book.pages[0].path})}return a.$on("update-annotation",(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=n.action,"bookmark"===(i=n.item).type&&"remove"===o&&_.bookmarks.delete(i.pageId);case 2:case"end":return e.stop()}},e,_)})),function(e,t){return n.apply(this,arguments)})),this}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("app").controller("PageController",["$scope","$state","Library","$sce","$timeout","$rootScope","LocalStorage","Iframe","StatisticsService","SessionService","SearchService","UsersContentsInfos","AnnotationService","UserDataConversionService","ExerciseAnswerService","$translate","ngDialog","Config","KeyCodesService","FirebaseAnalyticsService","Theme","annotations","exerciseAnswers",function(D,N,e,t,O,L,l,R,B,U,n,$,d,g,M,G,o,F,H,V,i,r,a){function j(e){var t,n=(e=e.detail).id,e=e.event;(n=q.annotations.get(n))&&(q.resetToolbar(),D.showToolbar(!0),q.toolbar.edit=!0,q.toolbar.highlight=n,q.textSelected=n.options.selectedText,q.toolbar.note=!!n.options.noteText,q.toolbar.isHighlightSelected=!0,q.toolbar.selectedText=n.options.selectedText,n=R.iframe.getBoundingClientRect(),t=void 0,t=e.clientX&&e.clientY?{top:e.clientY+n.top,left:e.clientX+n.left}:{top:(e=e.target.getBoundingClientRect()).top+n.top,left:e.left+e.width/2+n.left},q.toolbar.position={top:t.top-60,left:t.left},D.$apply())}var s,c,q=this,W=(N.params.readerDisabled&&(o.close(),o.open({template:G.instant("GT_CHAPTER_PREVIEW_SUPPORT_WARNING"),appendClassName:"support-warning",plain:!0,closeByDocument:!1,closeByEscape:!1,showClose:!1,width:"35%",focusOnOpen:!0})),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),N.params.book),u=N.params.assignment,p=(this.book=e.getBookByContentId(W),this.textSelected=null,this.annotations=new Map,this.exerciseAnswers=new Map,L.pageLoaded=!1,F.hasFeature("schwepsy")),z=this.book.getPaginationMode(),t=(this.book.structure.version?(this.index=this.book.getIndexOfPageV2(N.params.page),this.page=this.book.getSubpage(N.params.page,this.book.structure.toc),this.page||N.go("reader.book.page",{book:W,page:N.params.pageId}),this.iframeSrc=t.trustAsResourceUrl(this.book.getIndexFileV1(this.page.target,N.params.version))):(this.index=this.book.getIndexOfPage(N.params.page),this.page=this.book.getPage(N.params.page),this.iframeSrc=t.trustAsResourceUrl(this.book.getIndexFile(this.page,N.params.version))),F.getLocalStorageSize()),h=F.get("storageLimit"),f=U.getStorageLimitWarning(),h=(this.features={readerNoteFeature:this.book.readerNoteFeature(),readerHighlightFeature:this.book.readerHighlightFeature()},h<t&&!f&&(o.open({template:"app/reader/components/limit-storage/limit-storage-warning.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default storage-waning",closeByEscape:!1,showClose:!1,height:"278px",width:"320px",focusOnOpen:!0}),U.setStorageLimitWarning(!0)),this.sharingId=null,U.mobileCheck()),t=U.getDisplayMobileWarning(),f=(this.mainContent=""+G.instant("GT_READER_MAIN_CONTENTS_GROUP_ACCESS_LABEL"),u?(this.sharingId=u,e.loadAssignmentId(u).then(function(e){q.assignment=e})):this.sharingId=this.book.getSharingId(),D.$on("$destroy",function(){if(R&&R.resetObservers)try{R.resetObservers()}catch(e){console.warn("Error while trying to resetObservers on Iframe",e)}}),D.$on("reader-dropdown-menu-close",function(e,t){t.isAccessibilityElement&&(t=document.getElementById("reader-accessibility"))&&t.focus()}),D.$watch("isNoteShowing",function(){var e=document.querySelector("#currentNote");e&&!e.contains(document.activeElement)&&setTimeout(function(){var e=document.querySelector("#note-text");e&&e.focus()})}),this.resetToolbar=function(){q.toolbar={show:!1,position:null,note:!1,edit:!1,highlight:null,showNoteAndHighlight:!0,isHighlightSelected:!1,selectedText:null}},L.$on("remove-selection",this.resetToolbar),h&&!t&&(o.open({template:"app/reader/components/mobile-mode/mobile-warning.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default mobile-mode",closeByEscape:!1,showClose:!1,height:"380px",focusOnOpen:!0,controller:"MobileModeController"}),U.setDisplayMobileWarning(!0)),this.resetToolbar(),l.get("last-item")),K=(f&&f!==this.sharingId&&n.clearSearch(),l.set("last-item",this.sharingId),angular.element(document.querySelector("#iframe-page"))[0]),m=(this.initUserInputs=function(){function e(t){return Array.from(q.annotations.values()).filter(function(e){return e.type===t&&!e.cfi})}var t,n,i,o=Promise.resolve(),r=(p&&(t=e("highlight"),n=e("note"),i={highlights:t,notes:n},o=new Promise(function(t,o){var e=[].concat(_toConsumableArray(i.highlights.map(g.annotationToRangy).map(JSON.parse)),_toConsumableArray(i.notes.map(g.annotationToRangy).map(JSON.parse)));0<e.length?window.HighlightManager.asyncConvertHighlightsFromRangy(e).then(function(e){var n=new Map(e.map(function(e){return[e.id,e]})),e=[].concat(_toConsumableArray(i.highlights),_toConsumableArray(i.notes)).map(function(e){var t=n.get(e.id);return e.cfi=t.cfi,e});d.saveBulkAnnotations(e).then(function(e){e.forEach(function(e){setTimeout(function(){q.annotations.set(e.id,e),e.options.noteText?V.note("updated",e,q.book,q.page,"migrated"):V.highlight("updated",e,q.book,q.page,"migrated")},100)}),t()}).catch(o)}):t()})),o.finally(function(){var e=Array.from(q.annotations.values()).filter(function(e){return"highlight"===e.type}).map(r),t=Array.from(q.annotations.values()).filter(function(e){return"note"===e.type}).map(r);R.showHighlightsAndNotes(e,t,p)}),p?g.annotationToSchwepsy:g.annotationToRangy);a.forEach(function(e){q.exerciseAnswers.set(e.options.exerciseId,e),M.prepareExerciseForInjection(e),R.setExercise(e)})},q.annotations.clear(),r.forEach(function(e){q.annotations.set(e.id,e)}),L.$on("zoom-pdf",function(){window.NoteIconManager&&(window.NoteIconManager.isPdf=!0),q.initUserInputs()}));D.$on("$destroy",function(){window.NoteIconManager&&(window.NoteIconManager.isPdf=!1),m&&m()});return D.$on("$destroy",function(){window.removeEventListener("highlightIsTouched",j)}),R.init(K,function(){var e=K.contentDocument||K.contentWindow.document,t=e.querySelectorAll("#"+N.params.highlight),a=K.contentWindow,i=e.getElementsByTagName("body")[0],s=null,n=i,o=n.getElementsByClassName("alt-text-content"),r=!0,c=!1,u=void 0;try{for(var l,d=o[Symbol.iterator]();!(r=(l=d.next()).done);r=!0){var g=l.value,p=document.createElement("div");p.innerHTML=g.innerText,g.innerText=p.innerText}}catch(e){c=!0,u=e}finally{try{!r&&d.return&&d.return()}finally{if(c)throw u}}var o=n.getElementsByTagName("img"),h=!0,c=!1,u=void 0;try{for(var f,m=o[Symbol.iterator]();!(h=(f=m.next()).done);h=!0){var b=f.value,v=b.getAttribute("alt"),I=document.createElement("div");I.innerHTML=v,v=I.innerText,b.setAttribute("alt",v)}}catch(e){c=!0,u=e}finally{try{!h&&m.return&&m.return()}finally{if(c)throw u}}L.showNavigationBottom=!1,L.showNavigationTop=!1;function y(){var e=a.getSelection().toString().length;V.contentCopied("reader",q.book,q.page,e)}function k(){var e=50*L.showNavigationBottom+50*L.showNavigationTop,t=i.offsetHeight,n=a.pageYOffset,o=window.innerHeight<i.firstElementChild.scrollHeight;O(function(){L.showNavigationTop=0!=q.index&&n-e-a.innerHeight/t*150<=0,L.showNavigationBottom=q.index+1!==q.book.pages.length-1&&t-a.innerHeight-n-e-a.innerHeight/t*150<=0||!o&&q.index+1!==q.book.pages.length})}function _(){var e=(q.book.navigationPages||q.book.pages).length;L.showNavigationLeft=0!=q.index,L.showNavigationRight=q.index!=q.book.pages.length-1,L.cyclicNavigation=q.index===e-1,L.showNavigationTop=!1,L.showNavigationBottom=1<q.book.pages.length}e.addEventListener("copy",y);var T,E,S,A,C,w=0,P=(q.assignment&&"evaluation"===q.assignment.type&&(w=q.book.getExerciseCount(),null==q.book._submittedExercises)&&(q.book._submittedExercises=0),void 0);q.book&&q.book.isbn&&-1===(P={eISBN:q.book.isbn,page_index:q.book.getIndexOfPage(q.page.path||q.page.id)}).page_index&&(P.page_index=0);function x(e){var t,n,o=document.getElementById("input-toolbar");9===H.isTab(e)&&o&&o.contains(document.activeElement)&&(n=o.querySelectorAll('[tabindex]:not([tabindex="-1"])'),t=Array.from(n).indexOf(document.activeElement),n[n.length-1]==document.activeElement?(e.preventDefault(),(H.shiftPrePressed(e)?n[t-1]:n[0]).focus()):H.shiftPrePressed(e)&&(e.preventDefault(),(0==t?n[n.length-1]:n[t-1]).focus())),H.isEscape(e)&&(n=document.getElementById("currentNote"),o&&o.contains(document.activeElement)||n&&n.contains(document.activeElement))&&(D.showToolbar(!1),D.selectedHighlightId?(R.focusOnHighlight(D.selectedHighlightId),D.showToolbar(!1)):(D.showToolbar(!1),R.setFocusOnContent()))}"v"===z?(k(),a.onscroll=k):(_(),a.onscroll=_),N.params.highlight&&R.focusHighlight(N.params.highlight),N.params.search&&R.search(N.params.search,"search-text"),N.params.scrollTo&&R.scrollToElement(N.params.scrollTo),R.onSelectedText(function(e,t,n,o,i){var r;q.toolbar.isHighlightSelected||(D.selectedHighlightId=null,s=e,q.textSelected=e,r=Boolean(e.trim().length),q.selectedText=e,r&&o&&i?(q.resetToolbar(),q.toolbar.show=!0,q.toolbar.edit=!0,q.toolbar.highlight=i,q.textSelected=i.text,q.toolbar.note=i.isNote,q.toolbar.isHighlightSelected=!0,t&&(q.toolbar.position={top:t.y,left:t.x})):n?(a.getSelection().removeAllRanges(),D.showToolbar(!1)):(r&&null!=t&&!L.shiftPressed?D.showToolbar(!0):q.toolbar.showNoteAndHighlight=!1,t&&r&&(q.toolbar.position={top:t.y,left:t.x}),L.ReadAloud.toolbar=r?"close":L.ReadAloud.toolbar),D.$apply())}),D.showToolbar=function(e){q.resetToolbar(),q.toolbar.selectedText=q.selectedText,(q.toolbar.show=e)&&O(function(){var e;(e=angular.element(document.getElementsByClassName("colors"))[0])&&e.children[0].focus(),(e=document.getElementsByClassName("note-text")[0])&&e.focus()},1)},R.iframe.contentWindow.addEventListener("mousedown",function(){q.toolbar.show&&(D.showToolbar(!1),q.toolbar.isHighlightSelected=!1,D.$apply())},!1),window.addEventListener("highlightIsTouched",j),R.onSelectedHighlight(function(e,t,n){var o=angular.element(document.querySelector("#reader-input-note")).controller("readerInputNote");o&&q.isSafari&&o.preventChanges?o.clearPreventChanges():(D.selectedHighlightId=t.id,q.resetToolbar(),D.showToolbar(!0),q.toolbar.edit=!0,q.toolbar.highlight=q.annotations.get(t.id),q.textSelected=t.text,q.toolbar.note=t.isNote,q.toolbar.isHighlightSelected=!0,q.toolbar.selectedText=t.text,n&&(q.toolbar.position={top:n.y,left:n.x}),D.$apply())}),R.on("gt-goto",function(e){var t;e.fpath&&(q.book.structure.version&&(t=q.book.getPageByStruct(q.book.structure,e.fpath),e.fpath=q.book.structure.pagesList.find(function(e){return e.target===t.localPath}).id),N.params.page===e.fpath&&e.elementid?R.scrollToElement(e.elementid):N.go("reader.book.page",{book:W,page:e.fpath,scrollTo:e.elementid}))}),R.on("gt-goto-local-path",function(e){var t;e.localPath&&(t=q.book.getPageByLocalPath(e.localPath))&&t.path&&N.go("reader.book.page",{book:W,page:t.path,scrollTo:e.elementid})}),R.on("gt-showpage",function(){}),R.on("gt-email",function(e){var t="mailto:"+e.recipient,n="subject="+e.obj,e="body="+encodeURIComponent(e.body);window.location=t+"?"+n+"&"+e}),R.on("gt-savequizz",function(){}),R.on("gt-resetquizz",function(){}),R.on("gtSaveExercise",function(e){var t=q.book.getPageFromContent(N.params.page);M.upsert(_extends({sharingId:q.sharingId,contentVersion:q.book.getVersion(),pageTitle:q.page.title||"",pageIndex:q.book.getIndexOfPageForAnnotationsSort(N.params.page)},e),t.path||q.page.id),e.submitted&&(B.exerciseGraded({pageId:t.path||q.page.id,bookId:q.book.project_id||q.book.id,assignment:q.assignment,loId:t.identifier||t.path}),q.pageViewedEvent&&B.endPageViewed(q.pageViewedEvent).then(function(){return q.pageViewedEvent=null}),B.startPageViewed({pageId:t.path,bookId:q.book.project_id||q.book.id,assignment:q.assignment,additionalInfo:P||void 0}).then(function(e){return q.pageViewedEvent=e}),q.assignment)&&"evaluation"==q.assignment.type&&(q.book._submittedExercises++,q.book._submittedExercises==w)&&(q.assignment.submitted=!0)}),R.on("gtResetExercise",(T=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=q.exerciseAnswers.get(t),e.next=3,M.remove(n.id);case 3:q.exerciseAnswers.delete(t);case 4:case"end":return e.stop()}},e,q)})),function(e){return T.apply(this,arguments)})),R.on("gt-bookmark",function(){}),"PREVIEW"!==U.readerMode&&(E=q.book.getPageFromContent(N.params.page),S=new Date,B.startPageViewed({pageId:E.path||E.id,bookId:q.book.project_id||q.book.id,assignment:q.assignment,additionalInfo:P||void 0}).then(function(e){return q.pageViewedEvent=e}),a.onbeforeunload=function(){q.pageViewedEvent&&(B.endPageViewed(q.pageViewedEvent).then(function(){return q.pageViewedEvent=null}),V.pageViewed(S,q.book,E))},A=D.$on("$stateChangeStart",function(e,t,n,o,i){n.anchor&&(a.location.hash=n.anchor),q.pageViewedEvent&&n.page!=i.page&&(B.endPageViewed(q.pageViewedEvent).then(function(){return q.pageViewedEvent=null}),V.pageViewed(S,q.book,E)),A()})),q.book&&q.book.isEpubReflow()&&((n=a.document.createElement("style")).innerHTML="\n                @media (min-width: 1024px) {\n                    body.epub-reflow { "+(F.isCengageWS()?"":"margin: 5% 15%; line-height: 2em;")+" }\n                }\n                @media (min-width: 1440px) {\n                    body.epub-reflow {  "+(F.isCengageWS()?"":"margin: 5% 25%; line-height: 2em;")+" }\n                }",a.document.body.append(n),a.document.body.classList.add("epub-reflow"),o=q.page.target.split("#"),C=null,o&&(C=o[1]),N.params.scrollTo||C)&&setTimeout(function(){var e=a.document.getElementById(N.params.scrollTo||C);e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},0),"PREVIEW"!==U.readerMode&&(c={pageId:q.page.path||q.page.id,pageTitle:q.page.title||q.page.num},$.updateLastOpening(q.sharingId,c)),D.$apply(function(){L.pageLoaded=!0}),window.gtReaderLibs.reader.init({accessibility:{color1:G.instant("GT_READER_HIGHLIGHT_YELLOW_COLOR"),color2:G.instant("GT_READER_HIGHLIGHT_GREEN_COLOR"),color3:G.instant("GT_READER_HIGHLIGHT_BLUE_COLOR"),color4:G.instant("GT_READER_HIGHLIGHT_PINK_COLOR"),color5:G.instant("GT_READER_HIGHLIGHT_PURPLE_COLOR"),highlight_start_with_color:G.instant("GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY"),highlight_start:G.instant("GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY"),highlight_end:G.instant("GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY"),note_start_with_color:G.instant("GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY"),note_start:G.instant("GT_READER_NOTE_READ_START_ACCESSIBILITY"),note_end:G.instant("GT_READER_NOTE_READ_END_ACCESSIBILITY")}}),R.GtPdfJS.isPDF||q.initUserInputs(),document.getElementById("page-status").innerHTML=q.page.title+" has loaded",document.body.addEventListener("keydown",x),D.$apply(function(){L.pageLoaded=!0}),document.getElementById("page-status").innerHTML=q.page.title+" has loaded",D.$on("$destroy",function(){document.removeEventListener("keydown",x)}),document.addEventListener("keydown",function(e){!e.ctrlKey&&!e.metaKey||"c"!==e.key&&"C"!==e.key||((e=document.createElement("textarea")).style.width="0",e.style.height="0",e.value=s,document.body.appendChild(e),e.focus(),e.select(),document.execCommand("copy"),document.body.removeChild(e))}),t&&Array.from(t,function(e){e.blur(),D.$apply()}),document.body.classList.contains("user-is-tabbing")&&L.$broadcast("focusActiveTocItem"),D.$on("$destroy",function(){return e.removeEventListener("copy",y)})}),this.addAnnotationToMap=function(e){q.annotations.set(e.id,e)},this.deleteAnnotationFromMap=function(e){q.annotations.delete(e)},this.saveAnnotation=(s=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i,r,a,s,c,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=o=void 0,n.id?(i="updated",p?(r=g.annotationToSchwepsy(n),R.highlightWithSchwepsy(r.id,r.color,r.isNote),e.next=12):e.next=9):e.next=16;break;case 9:return r=g.annotationToRangy(n),e.next=12,R.highlight(n.options.color,r,!!n.options.noteText);case 12:(o=n).type=n.options.noteText?"note":"highlight",e.next=31;break;case 16:i="created",a=void 0,p?(a=R.highlightWithSchwepsy(null,n.options.color,!!n.options.noteText),e.next=25):e.next=22;break;case 22:return e.next=24,R.highlight(n.options.color,null,!!n.options.noteText);case 24:a=e.sent;case 25:s=q.book.getPageFromContent(N.params.page),s=s.path||s.pageId,a=_extends(p?a:JSON.parse(a),{sharingId:q.book.getSharingId(),contentVersion:q.book.getVersion(),pageTitle:q.book.getPage(s).title||"",pageIndex:q.book.getIndexOfPageForAnnotationsSort(N.params.page)}),c=l.get("userId"),u=F.getAppId(),o=g.highlighterToAnnotation(a,u,c,s,n.options.noteText,p);case 31:D.showToolbar(!1),d.addAnnotation(o,i).then(function(e){e.forEach(function(e){q.addAnnotationToMap(e)}),R.iframe&&R.iframe.contentWindow&&R.iframe.contentWindow.document.body.getAttribute("contenteditable")?R.returnToSelectionMode():"updated"===i&&setTimeout(function(){R.focusOnHighlight(n.id,p)},500),n.noteText?V.note(i,n,q.book,q.page,"manual"):V.highlight(i,n,q.book,q.page,"manual")});case 33:case"end":return e.stop()}},e,q)})),function(e,t){return s.apply(this,arguments)}),this.deleteAnnotation=function(e,t){R.removeHighlight(t.id,p),D.showToolbar(!1),D.$applyAsync(),d.remove(t).then(function(){q.deleteAnnotationFromMap(t.id),(H.isEnter(e)||H.isSpace(e))&&setTimeout(function(){R.setFocusOnContent()},200),t.noteText?V.note("deleted",{id:t.id},q.book,q.page):V.highlight("deleted",{id:t.id},q.book,q.page)})},D.$on("update-annotation",(c=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.item,i=n.action,r=q.book.getPageFromContent(N.params.page),"bookmark"===o.type||o.pageId!==r.path)return e.abrupt("return");e.next=4;break;case 4:"remove"===i?q.deleteAnnotationFromMap(o.id):(R.removeHighlight(o.id),q.addAnnotationToMap(o),q.initUserInputs());case 5:case"end":return e.stop()}},e,q)})),function(e,t){return c.apply(this,arguments)})),i.setLightenedPrimaryColor(),this}]).controller("MobileModeController",["$translate","$sce","$scope",function(e,t,n){n.warningDesc=t.trustAsHtml(e.instant("GT_MOBILE_WARNING_DESCRIPTION"))}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},_createClass=(angular.module("app").config(["$stateProvider",function(e){var t={_refreshCloudfrontCookie:["API","_ssoLogin",function(e,t){return e.refreshCloudFrontCookies()}],_firebase:["FirebaseService",function(e){return e.injectScripts()}],_user:["API","DbnApi","SessionService","Config","User","_ssoLogin","_userId",function(e,n,o,t,i,r,a){if("PREVIEW"!==o.readerMode&&("SINGLE"!==o.readerMode||o.getUserId()))return t.enableJwt()?n.getMe().then(function(e){var t=[],e=n.convertUser(e.data.me);return o.isChapterPreview()&&(o.setReaderMode("CHAPTERPREVIEW"),t=o.chapterPreviewAllowedPages()),o.user=e,o.setUserPreviewPages(t),e}):e.getUser().then(function(e){return o.user=new i(e),o.isChapterPreview()&&o.setReaderMode("CHAPTERPREVIEW"),e})}],_assignments:["Library","_library","_user",function(e,t,n){return e.loadAssignments()}],_library:["Library","_ssoLogin","$state","$stateParams","_user",function(e,t,n,o,i){n=n.params.projectId,o=o.book;return n?e.load({projectId:n}):e.load({book_content_id:o})}],book:["_library","$stateParams","_user","_refreshCloudfrontCookie",function(e,t,n,o){var i=e.getBookByContentId(t.book);if(i)return Promise.all([i.getStructure(t.version),i.getFeatures(t.version)]).then(function(){return i});throw new Error("book not found")}],_assignment:["Library","_library","$stateParams","_user",function(e,t,n,o){if(n.assignment)return e.loadAssignmentId(n.assignment)}],_userContentsInfos:["UsersContentsInfos","SessionService","_ssoLogin","_library","_user",function(e,t,n,o,i){if("PREVIEW"!==t.readerMode)return e.load()}],_userPreferences:["UsersPreferences","SessionService","_ssoLogin","_library","_user",function(e,t,n,o,i){if("PREVIEW"!==t.readerMode)return e.load()}]};e.state("reader",{url:"/reader?sso&assignment&username&token&accessToken&refreshToken",abstract:!0,controllerAs:"$ctrl",templateUrl:"app/reader/reader.html",resolve:{_config:["$window","Config",function(e,t){return t.load(e.appConfig)}],singleMode:["Config","SessionService",function(e,t){t.isChapterPreview()?t.setReaderMode("CHAPTERPREVIEW"):e.isSingleMode()&&t.setReaderMode("SINGLE")}],_theme:["Theme","Config",function(e,t){var n=t.get("theme").current,t=(n&&""!=n||(n="default"),t.get("theme").themes[n]);return e.setTheme(t)}],_settings:["API","SettingService",function(e,o){return e.get("/components/native-js-libs/accessibility.json").then(function(e){_extends(o,e.data);var e=void 0,t=0===window.navigator.platform.toUpperCase().indexOf("MAC"),n=0===window.navigator.platform.toUpperCase().indexOf("WIN"),e=t?"osx":n?"windows":"other";return o.fonts=o.fonts[e],o})}],_ssoLogin:["$state","$stateParams","API","$location","DbnApi",function(t,e,n,o,i){var r;return e.sso?n.ssoLogin(e.sso).then(function(e){return n.afterLogin(e)}).then(function(){return n.getCloudFrontCookies()}).catch(function(e){console.error("API.ssoLogin error",e),t.go("auth.login")}):e.username&&e.token?n.login({email:e.username,password:e.token}).then(function(){console.log("reset login query params username & token"),o.search("username",null),o.search("token",null)}).catch(function(e){console.error("API.login error",e),t.go("auth.login")}):e.accessToken&&e.refreshToken?(r=e.accessToken,e=e.refreshToken,i.postLogin(r,e).then(function(){return n.getCloudFrontCookies()}).then(function(){o.search("accessToken",null),o.search("refreshToken",null)})):void 0}],_userId:["_ssoLogin","SessionService","DbnApi","TokenType",function(e,t,n,o){return!(!t.getUserId()&&t.getTokenType()===o.DBN_JWT)||"PREVIEW"===t.readerMode||n.postLogin(t.getToken(),t.getRefreshToken())}]},controller:["Config","NotificationService",function(e,t){this.iosConfig=e.get("ios"),this.androidConfig=e.get("android");var n=e.isMobile(this.androidConfig.id,this.iosConfig.storeId);return this.remoteConfig=t.communication,n.mobile&&e.mobileCheckModal(n),this}]}).state("reader.book",{url:"/:book?version",abstract:!1,params:{forbiden:!1},templateUrl:"app/reader/index.html",resolve:_extends({_singleMode:["Config","SessionService","$q","$state","_library",function(e,t,n,o,i){if(e.isSingleMode()){e=t.getSingleModeConfig().isbn,t=n.defer();if(t.resolve(),i._library[0]&&i._library[0].isbn!==e)return t.promise.then(function(){o.go("auth.single-mode",{clearStorage:!1})})}}]},t),controllerAs:"$ctrl",controller:"BookController"}).state("reader.userinput",{url:"/:book/userinput",abstract:!1,templateProvider:["Config","$templateRequest",function(e,t){var n="app/reader/user-input/user-input.html";return t(n=e.hasUsersDataMigratedToDbn()?"app/reader/user-input/user-data.html":n)}],resolve:t,controllerAs:"$ctrl",controllerProvider:["Config",function(e){var t="userInput";return t=e.hasUsersDataMigratedToDbn()?"userData":t}]}).state("reader.book.page",{url:"/page/:page?highlight&scrollTo&search",abstract:!1,params:{enterClickNext:null,enterClickPrevious:null,pageId:null,readerDisabled:null,showSearch:null},resolve:{_refreshCloudfrontCookie:["API",function(e){return e.refreshCloudFrontCookies()}],_exists:["_library","book","$stateParams","SyncService","$state","SessionService",function(e,t,n,o,i,r){var a=t.getPage(n.page),s=t.structure.version?t.structure.pagesList[0].pageId:t.pages[0].path;return a?r.isChapterPreview()&&(s===a.pageId||s===a.path?n.readerDisabled=!0:r.chapterPreviewAllowedPages().includes(a.path||a.pageId)||i.go("reader.book.page",{page:r.chapterPreviewAllowedPages()[0],search:n.search})):(a=t.getPageByPath(n.page))?i.go("reader.book.page",{page:a.id,search:n.search}):r.isChapterPreview()?i.go("reader.book.page",{page:s}):i.go("reader.book",{book:n.book}),n.pageId=a.path||a.pageId,!0}],pageIds:["$stateParams","_library","book",function(t,e,n){var o,i=n.getPage(t.page),r="",a=(t.pageId=i.path||i.pageId,[]);return n.structure.version?(r=(o=n.getPageFromContent(t.pageId))?o.path:"",a=n.structure.pagesList.filter(function(e){return e.pageId===t.pageId}).map(function(e){return e.id})):a.push(i.path||i.pageId),r&&a.push(r),a}],pageUserData:["UserDataProxyService","Config","SessionService","book","_user","pageIds",function(e,t,n,o,i,r){return"PREVIEW"!==n.readerMode?e.getBySharingIdAndPageId(t.getAppId(),o.project_id,r):[]}],annotations:["AnnotationService","book","SessionService","$stateParams","pageUserData",function(e,t,n,o,i){return i.filter(function(e){return"note"===e.type||"highlight"===e.type})}],exerciseAnswers:["ExerciseAnswerService","book","SessionService","$stateParams","pageUserData",function(e,t,n,o,i){return i.filter(function(e){return"exercise"===e.type})}]},templateUrl:"app/reader/page.html",controllerAs:"$ctrl",controller:"PageController",bindings:{annotations:"<",exerciseAnswers:"<"}}).state("reader.mefsso",{url:"/mefsso/:meftoken/:workspaceId/:projectId/:version",controllerAs:"$ctrl",resolve:{_mefSSO:["$stateParams","SessionService","Config","API",function(e,t,n,o){return n.set("workspaceId",e.workspaceId),t.setMEFToken(e.meftoken,e.workspaceId),o.getCloudFrontCookies()}],_library:["Library","_mefSSO","$stateParams",function(e,t,n){n=n.projectId;return e.load({projectId:n})}],_redirect:["_mefSSO","_library","$stateParams","$state",function(e,t,n,o){t=t.getBookByProjectId(n.projectId);o.go("reader.book",{book:t.book_content_id,version:n.version})}]}}).state("reader.login_with_cengage",{url:"/jwt/tribble?jwt&pageId",templateUrl:"",controllerAs:"$ctrl",controller:["API","$state","Config","SessionService","User","LocalStorage","ngDialog",function(n,e,t,o,i,r,a){r.clear();var s=e.params.jwt,c=e.params.pageId,u=t.get("workspaceId"),t=t.get("appId"),l={};n.hapi.post("/v1/reader/users/cengage-jwt",{workspace_id:u,app_id:t,jwt:s}).then(function(e){n.afterLogin(e.data.user);var t=e.data.user.thirdparties.cengage.isbn;o.setSingleModeConfig({type:"cengage",isbn:t}),o.user=new i(e.data.user),o.isChapterPreview()?(o.setReaderMode("CHAPTERPREVIEW"),a.openConfirm({template:"app/reader/components/chapter-preview-message/chapter-preview-message.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"40%",controllerAs:"$ctrl"})):o.setReaderMode("SINGLE"),l.book_content_id=e.data.book_content_id}).then(function(){return n.getCloudFrontCookies()}).then(function(){r.set("pageId",c),e.go("reader.book",{book:l.book_content_id})}).catch(function(){r.clear(),e.go("auth.login")})}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.statistics",{url:"/statistics",controllerAs:"$ctrl",resolve:{redirect:["$state",function(e){return e.go("app.library.all")}]}})}]),function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}()),_get=function e(t,n,o){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);return void 0!==i?"value"in i?i.value:void 0!==(i=i.get)?i.call(o):void 0:null!==(i=Object.getPrototypeOf(t))?e(i,n,o):void 0};function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Library",["Entities","Config","$http","Book","$q","API","Assignment","SessionService","LocalStorage","StatisticsService","UsersContentsInfos","LicenseService",function(e,s,t,c,o,n,a,u,l,i,r,d){function g(){_classCallCheck(this,g);var e=_possibleConstructorReturn(this,(g.__proto__||Object.getPrototypeOf(g)).call(this));return e._library=[],e._mappeBooks={},e._assignments=[],e._data=null,e}return _inherits(g,e),_createClass(g,[{key:"load",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.projectId,o=e.book_content_id,i=s.get("appId"),r=s.get("workspaceId")||l.get("workspaceId"),e=u.getUserId(),a=l.get("cacheToken");return _get(g.prototype.__proto__||Object.getPrototypeOf(g.prototype),"load",this).call(this,"/v1/reader/users/cacheToken?app_id="+i+"&user_id="+e).then(function(e){e&&e!==a&&l.set("cacheToken",e);e=!e||t||o?"?metaType=web&app_studio_id="+i:"?c="+e+"&metaType=web&app_studio_id="+i;return u.getLMS()||(e+="&app_id="+i+"&workspace_id="+r),t?e+="&project_id="+t:o&&(e+="&book_id="+o),_get(g.prototype.__proto__||Object.getPrototypeOf(g.prototype),"load",n).call(n,"/v2/reader/books/store"+e)}).then(function(e){n._library=[];e=e[0];e.books&&e.books.forEach(function(e){var t=d.getByProjectId(e.project_id),t=(e.licenses=t,new c(e));n._library.push(t)}),"PREVIEW"===u.readerMode?n._library.sort(function(e,t){return parseInt(t.version)-parseInt(e.version)}):n._library.sort(function(e,t){return parseInt(t.export_date,10)-parseInt(e.export_date,10)}),n._data=e,n.mapBookById()}).then(function(){return n})}},{key:"loadAssignments",value:function(){var t=this,n=[];return this._assignments.length?this._assignments:(this._assignments=[],this._data&&this._data.assignments&&this._data.assignments.forEach(function(e){e=new a(e);n.push(e.loadPagesRead()),t._assignments.push(e)}),o.all(n))}},{key:"loadAssignmentId",value:function(e){var i,r=this,t=this.getAssignmentById(e);return t?o.resolve(t):(t=s.get("appId"),i=null,_get(g.prototype.__proto__||Object.getPrototypeOf(g.prototype),"load",this).call(this,"/v2/reader/books/store?app_studio_id="+t+"&assignment_id="+e+"&metaType=web").then(function(e){var t,n,o,e=e[0];return e.books&&e.books.length&&(t=e.books[0],r._library.some(function(e){return e.id===t.id})||(o=new c(t),r._library.push(o),r._data.books.push(t))),e.assignments&&e.assignments.length&&(n=e.assignments[0],i=n,r._assignments.some(function(e){e.id,n.id})||((o=new a(n)).loadPagesRead(),r._assignments.push(o),r._data.assignments.push(n))),i}))}},{key:"_filterLibrary",value:function(t){return this._library.filter(function(e){if(e.type===t)return e})}},{key:"mapBookById",value:function(){var t=this;this.getBooks().forEach(function(e){t._mappeBooks[e.id]=e})}},{key:"getAssignments",value:function(){return this._assignments}},{key:"getAssignmentById",value:function(t){return this._assignments.find(function(e){return e.id==t})}},{key:"getActiveAssignments",value:function(){return this.getAssignments().filter(function(e){var t=new Date(e.due_date),n=new Date,e=new Date(e.end_date);return n<t&&n<e})}},{key:"getArchivedAssignments",value:function(){return this.getAssignments().filter(function(e){var t=new Date(e.due_date),n=new Date,e=new Date(e.end_date);return t<=n&&n<e})}},{key:"getAll",value:function(){return this._library}},{key:"getBooks",value:function(){return this._filterLibrary("book")}},{key:"getShelfBooks",value:function(){return this._library.filter(function(e){if("book"===e.type&&e.sharing&&e.sharing.distributions&&-1<e.sharing.distributions.indexOf("shelf"))return e})}},{key:"getModules",value:function(){return this._filterLibrary("module")}},{key:"getModuleById",value:function(t){return this._library.find(function(e){if("module"===e.type&&e.id==t)return e})}},{key:"getResources",value:function(){return this._filterLibrary("resource")}},{key:"getFavourites",value:function(){return this._library.filter(function(e){if(!0===e.favourite)return e})}},{key:"getAssignmentTypes",value:function(){var t=[];return this._assignments.forEach(function(e){t.includes(e.type)||t.push(e.type)}),t}},{key:"getAssignmentSubjects",value:function(){var t=[];return this._assignments.forEach(function(e){t.includes(e.subject)||t.push(e.subject)}),t}},{key:"getBookByContentId",value:function(t){return this._library.find(function(e){return e.book_content_id===t})}},{key:"getBookByBookId",value:function(t){return this._library.find(function(e){return e.book_id===t||e.newapi_id===t})}},{key:"getBookById",value:function(e){return this._mappeBooks[e]}},{key:"getBookByLMSId",value:function(t){return this._library.find(function(e){return e.newapi_id===t})}},{key:"getBookByProjectId",value:function(t){return this._library.find(function(e){return e.project_id===t&&"html5"===e.format})}},{key:"getBookOrAssignmentBySharingId",value:function(t){var e=this.getAssignmentById(t);return e||this._library.find(function(e){return e.getSharingId()==t})}},{key:"getContentsInfos",value:function(){return this._library.forEach(function(e){e.last_open_date=0;var t=r.getBySharingId(e.getSharingId());t&&t.options.lastOpen&&(e.last_open_date=t.options.lastOpen.date)}),this._library}}]),new g}]),angular.module("commons").filter("capitalize",function(){return function(e){return e?e.charAt(0).toUpperCase()+e.substr(1).toLowerCase():""}});var _window=window,he=_window.he;angular.module("commons").filter("encodeAnnotations",function(){return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=RegExp("&#x3C;mark&#x3E;(.*?)&#x3C;/mark&#x3E;","gi");return e=(e=he.encode(e)).replace(t,"<mark>$1</mark>")}}),angular.module("commons").filter("copyObject",function(){return function(n){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return Object.keys(n).reduce(function(e,t){return i.length?i.indexOf(t)<0&&(e[t]=n[t]):-1<o.indexOf(t)&&(e[t]=n[t]),e},{})}});he=(_window=window).he,angular.module("commons").filter("decodeHTML",function(){return function(e){return e?he?he.decode(e):e:""}}),angular.module("commons").filter("decodeURI",function(){return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";try{return decodeURIComponent(t)}catch(e){return t}}}),angular.module("commons").filter("normalizeText",function(){return function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"").replace(/&#xa0;/g," ").split(/\s\s+/g).join(" ")}}),angular.module("commons").filter("percentage",function(){return function(e){return e+"%"}}),angular.module("commons").filter("readMore",function(){return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",e=arguments[1],n=e.size||20,o=void 0;try{o=decodeURIComponent(t).replace(/<\/?[^>]+(>|$)/g,"")}catch(e){o=t.replace(/<\/?[^>]+(>|$)/g,"")}return null==(o=e.html?t:o)||o&&o.length<=n||e.full?o:o.toString().substr(0,n)+"..."}}),angular.module("commons").filter("sanitizeText",function(){return function(e){if(e)return e.replace(/(?:\u0000|&#0;|&#x0;)*/gi,"")}}),angular.module("commons").filter("userInputsSync",["$state","Library",function(t,i){return function(e){function n(){switch(t.current.name){case"reader.userinput.notes":return"note";case"reader.userinput.bookmarks":return"bookmark";case"reader.userinput.highlights":return"highlight";case"reader.userinput.notdisplayed":return"notdisplayed";default:return null}}var o=[];return e.filter(function(e){var t=i.getBookOrAssignmentBySharingId(e.sharingId);"training"!==t.type&&"evaluation"!==t.type||!t.book_id?"training"!==t.type&&"evaluation"!==t.type||!t.module_id?("notdisplayed"===n()&&!t.getPage(e.pageId)||n()==e.type&&t.getPage(e.pageId))&&o.push(e):("notdisplayed"===n()&&!i.getBookByBookId(t.module_id).getPage(e.pageId)||n()==e.type&&i.getBookByBookId(t.module_id).getPage(e.pageId))&&o.push(e):("notdisplayed"===n()&&!i.getBookByBookId(t.book_id).getPage(e.pageId)||n()==e.type&&i.getBookByBookId(t.book_id).getPage(e.pageId))&&o.push(e)}),n()?o:e}}]),window.langs={en:{default:!0,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Resend Invitation Link",GT_PRINT_DISABLED_MESSAGE:"Browser printing is not supported",GT_READER_HIGHLIGHT_BLUE_COLOR:"blue",GT_READER_HIGHLIGHT_GREEN_COLOR:"green",GT_READER_HIGHLIGHT_PINK_COLOR:"pink",GT_READER_HIGHLIGHT_PURPLE_COLOR:"purple",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"End of highlighted passage",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"Start highlighted passage: ",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"Start highlighted passage in [color]: ",GT_READER_HIGHLIGHT_YELLOW_COLOR:"yellow",GT_READER_NOTE_READ_END_ACCESSIBILITY:"End of annotated passage",GT_READER_NOTE_READ_START_ACCESSIBILITY:"Start annotated passage: ",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"Start annotated passage in [color]: "}},fr:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Renvoyer l'email de validation",GT_PRINT_DISABLED_MESSAGE:"L'impression depuis le navigateur n'est pas prise en charge",GT_READER_HIGHLIGHT_BLUE_COLOR:"bleu",GT_READER_HIGHLIGHT_GREEN_COLOR:"vert",GT_READER_HIGHLIGHT_PINK_COLOR:"rose",GT_READER_HIGHLIGHT_PURPLE_COLOR:"violet",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"Fin du texte surlign",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"Dbut du texte surlign: ",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"Dbut du texte surlign en [color]: ",GT_READER_HIGHLIGHT_YELLOW_COLOR:"jaune",GT_READER_NOTE_READ_END_ACCESSIBILITY:"Fin du texte annot",GT_READER_NOTE_READ_START_ACCESSIBILITY:"Dbut du texte annot: ",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"Dbut du texte annot en [color]: "}},de:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Einladungs-E-Mail erneut senden",GT_PRINT_DISABLED_MESSAGE:"Drucken ber den Browser wird nicht untersttzt",GT_READER_HIGHLIGHT_BLUE_COLOR:"blau",GT_READER_HIGHLIGHT_GREEN_COLOR:"grn",GT_READER_HIGHLIGHT_PINK_COLOR:"rosa",GT_READER_HIGHLIGHT_PURPLE_COLOR:"lila",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"Ende der Markierung",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"Start der Markierung: ",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"Start der Markierung in [color]: ",GT_READER_HIGHLIGHT_YELLOW_COLOR:"gelb",GT_READER_NOTE_READ_END_ACCESSIBILITY:"Ende der Notiz",GT_READER_NOTE_READ_START_ACCESSIBILITY:"Start der Notiz: ",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"Start der Notiz in [color]: "}},es:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Reenviar correo electrnico de invitacin",GT_PRINT_DISABLED_MESSAGE:"La impresin desde el navegador no est soportada",GT_READER_HIGHLIGHT_BLUE_COLOR:"azul",GT_READER_HIGHLIGHT_GREEN_COLOR:"verde",GT_READER_HIGHLIGHT_PINK_COLOR:"rosa",GT_READER_HIGHLIGHT_PURPLE_COLOR:"morado",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"Fin del resaltado",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"Inicio del resaltado: ",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"Inicio del resaltado en [color]: ",GT_READER_HIGHLIGHT_YELLOW_COLOR:"amarillo",GT_READER_NOTE_READ_END_ACCESSIBILITY:"Fin de la nota",GT_READER_NOTE_READ_START_ACCESSIBILITY:"Inicio de la nota: ",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"Inicio de la nota en [color]: "}},ja:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"",GT_PRINT_DISABLED_MESSAGE:"",GT_READER_HIGHLIGHT_BLUE_COLOR:"",GT_READER_HIGHLIGHT_GREEN_COLOR:"",GT_READER_HIGHLIGHT_PINK_COLOR:"",GT_READER_HIGHLIGHT_PURPLE_COLOR:"",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"[color]",GT_READER_HIGHLIGHT_YELLOW_COLOR:"",GT_READER_NOTE_READ_END_ACCESSIBILITY:"",GT_READER_NOTE_READ_START_ACCESSIBILITY:"",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"[color]"}},pt:{default:!1,translations:{GT_LOGIN_RESEND_INVITATION_LINK:"Reenviar e-mail de convite",GT_PRINT_DISABLED_MESSAGE:"A impresso do navegador no  suportada",GT_READER_HIGHLIGHT_BLUE_COLOR:"azul",GT_READER_HIGHLIGHT_GREEN_COLOR:"verde",GT_READER_HIGHLIGHT_PINK_COLOR:"rosa",GT_READER_HIGHLIGHT_PURPLE_COLOR:"roxo",GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY:"Fim do destaque",GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY:"Incio do destaque: ",GT_READER_HIGHLIGHT_READ_START_WITH_COLOR_ACCESSIBILITY:"Incio do destaque em [color]: ",GT_READER_HIGHLIGHT_YELLOW_COLOR:"amarelo",GT_READER_NOTE_READ_END_ACCESSIBILITY:"Fim da anotao",GT_READER_NOTE_READ_START_ACCESSIBILITY:"Incio da anotao: ",GT_READER_NOTE_READ_START_WITH_COLOR_ACCESSIBILITY:"Incio da anotao em [color]: "}}},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Assignment",["Entity","StatisticsService",function(e,n){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"loadPagesRead",value:function(){var t=this;return n.getNbPagesRead(this.id).then(function(e){return t.pagesRead=e})}},{key:"getLMSId",value:function(){return this.book_id||this.module_id}},{key:"getIndexOfPage",value:function(){return null}},{key:"getTitle",value:function(){return this.title}}]),t}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("Book",["Entity","API","$q","md5","LicenseService","UsersContentsInfos","$rootScope","$translate",function(e,n,o,r,t,i,a,s){function c(e){_classCallCheck(this,c);e=_possibleConstructorReturn(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,e));return e.pages=[],e.uniquePages=[],e.localPathDir="",e}return _inherits(c,e),_createClass(c,[{key:"getStructure",value:function(e){var t=this;return a.loadMessage=s.instant("GT_SSO_LOADING_MESSAGE_RETRIEVING_TOC"),this.structure?o.resolve(this.structure):(this._loadingStructure||(this._loadingStructure=!0,this._loadingPromiseStructure=n.sameOriginHapi.get("/v1/reader/read/"+this.book_content_id+"/"+(e||this.version)+"/structure.json").then(function(e){return t.structure=e.data.book,t.structure.version=e.data.version,t.pages=[],t.hasLogicalPageNumbers=!1,t._getPages(t.structure.content),t.uniquePages=[].concat(_toConsumableArray(new Set(t.pages.map(function(e){return e.path})))),t.structure.version&&(t.navigationPages=t.structure.pagesList.filter(function(e){return-1<e.role.indexOf("navigation")}),t.countPages=t.structure.pagesList.filter(function(e){return-1<e.role.indexOf("count")}),t.hasPageBreak=!!t.countPages.length),t._loadingStructure=!1,a.loadMessage=s.instant("GT_GENERIC_LOADING_MESSAGE"),t.structure}).catch(function(e){return console.error("Error fetching structure:",e),t._loadingStructure=!1,a.loadMessage=s.instant("GT_GENERIC_LOADING_MESSAGE"),o.reject("Failed to load structure")})),this._loadingPromiseStructure)}},{key:"getFeatures",value:function(e){var t=this;return this.features?o.resolve(this.features):(this._loadingFeatures||(this._loadingFeatures=!0,this._loadingPromiseFeatures=n.sameOriginHapi.get("/v1/reader/read/"+this.book_content_id+"/"+(e||this.version)+"/config.json").then(function(e){return t.features=e.data,t._loadingFeatures=!1,t.features}).catch(function(e){return console.error("Error fetching features:",e),t._loadingFeatures=!1,o.reject("Failed to load features")})),this._loadingPromiseFeatures)}},{key:"_getPages",value:function(e){var n=this;return e.reduce(function(e,t){return!n.hasLogicalPageNumbers&&t.logicalPageNumber&&null!==t.logicalPageNumber&&(n.hasLogicalPageNumbers=!0),"true"!==t.isPage?n._getPages(t.content||[]):n.pages.push(t),n.pages},[])}},{key:"nextPage",value:function(t){var e,n,o;return this.structure.version?(e=this.getPage(t))?(n=null,(o=this.getIndexOfPageV2(e.pageId)+1)>=this.navigationPages.length&&(o=this.getIndexOfPageV2(e.id)+1)>=this.navigationPages.length&&(o=0),(n=this.isEpubReflowWithoutPageBreak()?this.getTocPageByPageId(this.structure.toc,this.navigationPages[o].pageId):n)||this.navigationPages[o]):void 0:((e=this.uniquePages.findIndex(function(e){return e===t})+1)>=this.uniquePages.length&&(e=0),this.getPage(this.uniquePages[e]))}},{key:"previousPage",value:function(t){var e,n,o;return this.structure.version?(e=this.getPage(t))?(n=null,(o=this.getIndexOfPageV2(e.pageId)-1)<0&&(o=this.getIndexOfPageV2(e.id)-1)<0&&(o=this.navigationPages.length-1),(n=this.isEpubReflowWithoutPageBreak()?this.getTocPageByPageId(this.structure.toc,this.navigationPages[o].pageId):n)||this.navigationPages[o]):void 0:((e=this.uniquePages.findIndex(function(e){return e===t})-1)<0&&(e=this.uniquePages.length-1),this.getPage(this.uniquePages[e]))}},{key:"getIndexFile",value:function(e,t,n){if(e&&"true"===e.isPage)return void 0===n&&(n=!0),e.localPath&&(this.localPathDir=e.localPath.substring(0,e.localPath.lastIndexOf("/")+1)),"v1/reader/stream/"+this.book_content_id+"/"+(t||this.version)+"/"+e.localPath+"?scripts="+n}},{key:"getIndexFileV1",value:function(e,t){return"v1/reader/stream/"+this.book_content_id+"/"+(t||this.version)+"/"+e}},{key:"getPageByStruct",value:function(e,t){if(e.path===t&&"true"===e.isPage)return e;if(!e.content)return null;var n,o=null;for(n in e.content)if(null!=(o=this.getPageByStruct(e.content[n],t)))break;return o}},{key:"getPage",value:function(e,t,n){var o,i;if(this.structure&&e)return o=this.getPageByStruct(this.structure,e),this.structure.version?(t=t||this.structure.toc,o?(i=r.createHash(o.localPath.split("#")[0]),this.getSubpage(i,t)):n?{page:this.getSubpage(e,t),updateAnnotation:!0}:this.getSubpage(e,t)):o}},{key:"getPageFromContent",value:function(t,e){if(this.structure&&t){if(this.structure.version){e=e||this.structure.toc;var n,e=void 0;if(e=!this.isEpubReflow()&&(e=this.structure.pagesList.find(function(e){return e.id===t}))||this.getTocPageById(this.structure.toc,t))return n=(n=this.getPageByLocalPath(e.target.split("#")[0]))||this.getPageByLocalPath(e.target),this.getPageByStruct(this.structure,n.path)}return this.getPageByStruct(this.structure,t)}}},{key:"getPageByLocalPath",value:function(e){var t;return this.structure&&e?(t=this.localPathDir+e,this.pages.find(function(e){return e.localPath===t})):null}},{key:"getCountPage",value:function(t){if(this.countPages)return this.countPages.find(function(e){return e.id===t})}},{key:"getCountPageByNum",value:function(t){if(this.countPages)return this.countPages.find(function(e){return e.num==t})}},{key:"getPageV1",value:function(t,e){var n=this;if(this.structure&&t)return this.navigationPages[0].id===t?(this.subpage=this.navigationPages[0],this.subpage):e.find(function(e){return e.id===t?(n.subpage=e,n.subpage):e.children?n.getPageV1(t,e.children):void 0})}},{key:"getPageByPath",value:function(t){var n=this.pages.find(function(e){return e.path===t});if(n)return this.structure.pagesList.find(function(e){return e.target===n.localPath})}},{key:"getSubpage",value:function(e,t){return this.getPageV1(e,t)||(this.subpage=this.getCountPage(e)),this.subpage}},{key:"getIndexOfPage",value:function(t){return this.structure.version?this.navigationPages.findIndex(function(e){return e.pageId===t}):this.pages.findIndex(function(e){return e.path===t})}},{key:"getIndexOfUniquePage",value:function(t){return this.uniquePages.findIndex(function(e){return e===t})}},{key:"getIndexOfPageV2",value:function(t){var n,e=this.navigationPages.findIndex(function(e){return e.pageId===t});return-1===e&&this.isEpubReflowWithoutPageBreak()&&(n=this.getPage(t),e=this.navigationPages.findIndex(function(e){return e.pageId===n.pageId})),e}},{key:"getIndexOfPageForAnnotationsSort",value:function(e){return this.structure.version?this.getIndexOfPageV2(e):this.getIndexOfPage(e)}},{key:"getTocPageByPageId",value:function(e,t){if(e&&t){for(var n=null,o=0;o<e.length;){var i=e[o];if(n=!(n=i.pageId===t?i:n)&&i.children?this.getTocPageByPageId(i.children,t):n)break;o++}return n}}},{key:"getTocPageById",value:function(e,t){if(e&&t){for(var n=null,o=0;o<e.length;){var i=e[o];if(n=!(n=i.id===t?i:n)&&i.children?this.getTocPageById(i.children,t):n)break;o++}return n}}},{key:"getFirstPageFromStruct",value:function(e){if(!e)return null;if("true"==e.isPage)return e;if(!e.content)return null;var t,n=null;for(t in e.content)if(null!=(n=this.getFirstPageFromStruct(e.content[t])))break;return n}},{key:"getPages",value:function(){return this.pages}},{key:"getExerciseCount",value:function(){return this.pages.filter(function(e){return"exercise"===e.type}).length}},{key:"getSharingId",value:function(){return this.project_id||this.newapi_id}},{key:"getPartOrSection",value:function(t,e){var n=this,e=e||this.structure.content,o=null;return e.forEach(function(e){o||(e.path==t&&(o=e),e.content&&(o=n.getPartOrSection(t,e.content)?e:null))}),o}},{key:"getTitle",value:function(){if(this.isbn===this.title){var e=this.project_metas.value;if(e&&e.length){e=e.find(function(e){return"title"===e.name.toLowerCase()});if(e&&e.value)return e.value}}return this.title}},{key:"getAuthor",value:function(){if(this.author||this.authors)return this.author||this.authors;var e=this.project_metas?this.project_metas.value:[];if(e&&e.length){e=e.find(function(e){return"author(s)"===e.name.toLowerCase()});if(e&&e.value)return e.value}return""}},{key:"getPageTitle",value:function(e){if(void 0!==this.getPage(e))return this.getPage(e).title.replace(/<[^>]*>/g,"")}},{key:"getTopbarStyle",value:function(){if(this.features)return this.features.topbar.style}},{key:"showTopbar",value:function(){return!!this.features&&!this.features.autonomous}},{key:"showNdAnnotationsModal",value:function(){return!!this.features&&!this.features.autonomous}},{key:"loadScripts",value:function(){return!this.features||!this.features.autonomous}},{key:"showTOC",value:function(){return!!this.features&&!(this.features.autonomous||this.features.toc&&!1===this.features.toc.enabled)}},{key:"getTopbarTitle",value:function(e){var t;return!(this.features&&this.features.topbar&&this.features.topbar.display)||"project"===(t=this.features.topbar.display.title)?this.getTitle():"page"===t?this.getPageTitle(e):null}},{key:"readerSearchFeature",value:function(){return this.features&&"module"!==this.type?!(this.features.autonomous||!this.features.features)&&this.features.features.search:!(!this.features||!this.features.functionalities)&&this.features.functionalities.search.value}},{key:"readerBookmarkFeature",value:function(){return this.features&&"module"!==this.type?!(this.features.autonomous||!this.features.features)&&this.features.features.bookmarks:!(!this.features||!this.features.functionalities)&&this.features.functionalities.bookmarks.value}},{key:"readerHighlightFeature",value:function(){return this.features&&"module"!==this.type?!(this.features.autonomous||!this.features.features)&&this.features.features.highlights:!(!this.features||!this.features.functionalities)&&this.features.functionalities.highlight.value}},{key:"readerNoteFeature",value:function(){return this.features&&"module"!==this.type?!(this.features.autonomous||!this.features.features)&&this.features.features.notes:!(!this.features||!this.features.functionalities)&&this.features.functionalities.notes.value}},{key:"readerGtAudio",value:function(){return!(!this.features||"module"===this.type||this.features.autonomous||!this.features.features)&&this.features.features.gtAudio}},{key:"accessibilityFeatures",value:function(){return!(!this.features||"module"===this.type||this.features.autonomous||!this.features.features)&&this.features.features.accessibility}},{key:"getPaginationMode",value:function(){if(this.features&&"module"!==this.type)return"vertical"===this.features.navigation.pagination?"v":"h"}},{key:"getVersion",value:function(){return this.version}},{key:"isPdfEpubOrNativeGtContent",value:function(){return this.isPDF()||this.isEpubFixed()||this.isEpubReflow()||this.isNativeGtContent()}},{key:"isPDF",value:function(){return this.importType&&"pdf"===this.importType}},{key:"isEpubFixed",value:function(){return this.importType&&"epub-fixed"===this.importType}},{key:"isEpubReflow",value:function(){return this.importType&&"epub-reflow"===this.importType}},{key:"isNativeGtContent",value:function(){return!this.importType}},{key:"isMefZip",value:function(){return this.importType&&"mef-zip"===this.importType}},{key:"isEpubReflowWithoutPageBreak",value:function(){return this.isEpubReflow()&&this.structure.version&&!this.countPages.length}},{key:"getLicenseTimeExpire",value:function(e){return e?t.calcExpireTime(e):{}}},{key:"getActiveLicenses",value:function(){var e,t;if(this.licenses)return e=this.licenses.access_code.filter(function(e){return!e.endDate&&"GT_LICENSE_STATUS_ACTIVE"===e.status}),t=this.licenses.access_code.filter(function(e){return e.endDate&&+new Date(e.endDate)>+new Date&&"GT_LICENSE_STATUS_ACTIVE"===e.status}),{access_code:e.concat(t),inapp:this.licenses.inapp}}},{key:"getActiveLicenseAndOthers",value:function(){var e=this.getActiveLicenses(),t=[],n=[],o=[];return e.inapp.length&&(t.push(e.inapp[0]),1<e.inapp.length)&&n.push.apply(n,_toConsumableArray(e.inapp.slice(1))),e.access_code.length&&((t.length?o:t).push(e.access_code[0]),1<e.access_code.length)&&o.push.apply(o,_toConsumableArray(e.access_code.slice(1))),{active:t[0]||{},others:n.concat(o)}}},{key:"isNewContent",value:function(){var e=this.getSharingId(),e=i.getBySharingId(e);return Boolean(!e||!e.options||e.options.lastOpen&&!e.options.lastOpen.pageId)}},{key:"getHeaderParams",value:function(e){var t;return e.children?{title:this.getTitle(),chapterTitle:e.title,sectionTitle:null}:(t=void 0,t=this.structure.toc?this._getParentChapter(this.structure.toc,e.pageId,"children","pageId"):this._getParentChapter(this.structure.content,e.path,"content","path"),{title:this.getTitle(),chapterTitle:t.title,sectionTitle:e.title})}},{key:"_getParentChapter",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"children",o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"pageId",i=null,r=0;if(!e)return null;for(;r<e.length;){if(t===e[r][o]){i=e[r];break}if(e[r][n]&&(i=this._getParentChapter(e[r][n],t,n,o))){i[n]||(i=e[r]);break}r++}return i}}]),c}]),angular.module("commons").constant("TokenType",{AP:"ap",MEF:"mef",DBN_JWT:"dbnJwt"});_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Evaluation",["Entity","SessionService","$interval",function(e,t,n){function o(e){_classCallCheck(this,o),this.assignment=e,this.user=t.getUser(),this.options=e.evaluation_options,this.user.assignments_status||(this.user.assignments_status={}),this.user.assignments_status[this.assignment.id]||(this.user.assignments_status[this.assignment.id]={status:"not_started",time_spent:0}),this.assignment_status=this.user.assignments_status[this.assignment.id],"finished"!=this.assignment_status.status&&(e=Date.now(),new Date(this.assignment.due_date).getTime()<e)&&this.finish()}return _createClass(o,[{key:"_patch",value:function(e){if(e)return this.assignment_status.status=e,this.user.assignments_status[this.assignment.id]=this.assignment_status,this.user.patch({assignments_status:this.user.assignments_status});throw new Error("status is not defined")}},{key:"_clear",value:function(){this._interval&&(n.cancel(this._interval),delete this._interval)}},{key:"start",value:function(){var e=this;this.isFinished()||(this._start=Date.now()-this.assignment_status.time_spent,this._patch("in_progress"),this._interval=n(function(){e.assignment_status.time_spent>=e.options.duration?e.finish().then(function(){"function"==typeof e._onFinish&&e._onFinish()}):(e.assignment_status.time_spent=1e3*((Date.now()-e._start)/1e3).toFixed(0),e.assignment_status.time_spent%1e4==0&&e._patch("in_progress"))},1e3))}},{key:"finish",value:function(){return this._clear(),this.assignment_status.time_spent=this.options.duration,this._patch("finished")}},{key:"isFinished",value:function(){return this.assignment_status.time_spent>=this.options.duration}},{key:"onFinish",value:function(e){this._onFinish=e}},{key:"pause",value:function(){this.isFinished()||(this._clear(),this.options.user_can_leave?this._patch("started"):this.finish())}},{key:"addTimeOffset",value:function(e){this._start+=e}},{key:"getReadableTimeSpent",value:function(){var e=new Date(this.options.duration-this.assignment_status.time_spent);return[e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()].map(function(e){return 1==(""+e).length?"0"+e:e}).join(":")}}]),o}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("StatisticsEvent",function(){function s(e){var t=e.type,n=e.object,o=e.result,i=e.context,r=e.user,a=e.mediaParams,e=e.startTime;_classCallCheck(this,s),this.type=t,this.object=n,this.result=o,this.context=i,this.user=r,this.mediaParams=a,this.startTime=e}return _createClass(s,[{key:"end",value:function(){var e=new Date,t=new Date(this.startTime),e=e.getTime()-t.getTime();this.result={duration:e}}},{key:"getLocalDateISOString",value:function(){function e(e,t){return(e=Math.abs(Math.floor(e)).toString()).length>=t?e:new Array(t-e.length+1).join("0")+e}var t=new Date,n=t.getTimezoneOffset();return t.getFullYear().toString().concat("-",e(t.getMonth()+1,2),"-",e(t.getDate(),2),"T",e(t.getHours(),2),":",e(t.getMinutes(),2),":",e(t.getSeconds(),2),".",e(t.getMilliseconds(),3),n<0?"+":"-",e(Math.abs(n)/60,2),":",e(Math.abs(n)%60,2))}},{key:"toObject",value:function(){return{timestamp:(new Date).toISOString(),authority:{reader:"WEBREADER",osVersion:window.navigator.platform,appVersion:window.wrVersion||"v3",browser:window.navigator.userAgent},verb:{name:this.type,action:["action","bookmark","highlight","note","audio","video"].includes(this.object.type)?this.object.value.toUpperCase():null},context:this.context,object:this.object,result:this.result,mediaParams:this.mediaParams,actor:{userId:this.user.id,email:this.user.email,externalUserId:this.user.externalUserId},identityProvider:this.user.identityProvider,localTimestamp:(new Date).toISOString()}}}]),s});_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").factory("User",["Entity","API","SessionService",function(e,n,o){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"/v1/reader/users"))}return _inherits(t,e),_createClass(t,[{key:"save",value:function(){var t=this;return this._syncEntity(),n.hapi.put("/v2/reader/users",{user:this._entity,criticalUpdateToken:o.getUserCriticalToken()}).then(function(e){return t._update(e.data),e.data})}}]),t}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("commons").service("API",["Config","$cookies","$http","$q","SessionService","$state","LocalStorage","$injector","TokenType",function(i,o,a,r,s,t,c,n,e){var u=this,l=(this.pushSubscribing=!1,_createClass(d,null,[{key:"keepTrying",value:function(n){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:3,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e3;return n().catch(function(e){var t=r.defer();return e.status<=0&&1<o?setTimeout(function(){d.keepTrying(n,o-1,i).then(t.resolve).catch(t.reject)},i):t.reject(e),t.promise})}},{key:"logoutMiddleware",value:function(e){if(!e||!e.data||"Your token is invalid!"!=e.data.message)throw e;s.logOut(),t.go("auth.login",{expired:1}),console.trace("API error ",e)}}]),_createClass(d,[{key:"getConfig",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t={headers:{"X-GT-Client-Version":i.get("appVersion")?i.get("appVersion"):"unknown","X-GT-Locale":c.get("lang")||i.defaultLanguage(),"x-gt-workspace-id":i.get("workspaceId"),"x-gt-distribution-channel-id":i.get("appId")},params:{},withCredentials:!1,retry:!1},n=(s.getToken()?t.headers["X-GT-Client-Name"]=s.isJwtTokenSession()?"wr3":"wr3-legacy":t.headers["X-GT-Client-Name"]=i.enableJwt()?"wr3":"wr3-legacy",this.baseUrl()===i.get("statistics").endpoint&&(t.headers={}),_extends(t.headers,this.defaults().headers,e.headers)),o=_extends(t.params,this.defaults().params,e.params);return _extends(t,this.defaults(),e,{headers:n,params:o})}},{key:"getUrl",value:function(e,t){var o=this.getConfig(t),i=this.makeUrl(e);return Object.keys(o.params).forEach(function(e,t){var n=o.params[e];i+=0===t?"?"+e+"="+n:"&"+e+"="+n}),i}},{key:"post",value:function(e,t){var n,o,i=this.getConfig(2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}),r=this.makeUrl(e);return(i.retry?(n=(o=i.retry).count,o=o.delay,d.keepTrying(function(){return a.post(r,t,i)},n,o)):a.post(r,t,i)).catch(d.logoutMiddleware)}},{key:"put",value:function(e,t,n){n=this.getConfig(n),e=this.makeUrl(e);return a.put(e,t,n).catch(d.logoutMiddleware)}},{key:"patch",value:function(e,t,n){n=this.getConfig(n),e=this.makeUrl(e);return a.patch(e,t,n).catch(d.logoutMiddleware)}},{key:"get",value:function(e,t){t=this.getConfig(t),e=this.makeUrl(e);return a.get(e,t).catch(d.logoutMiddleware)}},{key:"delete",value:function(e,t){t=this.getConfig(t),e=this.makeUrl(e);return a.delete(e,t).catch(d.logoutMiddleware)}},{key:"makeUrl",value:function(e){return""+this.baseUrl()+e}}]),d);function d(e){var t=e.baseUrl,e=e.defaults,e=void 0===e?null:e;_classCallCheck(this,d),this.baseUrl=t,this.defaults=e}this.getDefaults=function(){if(s.getToken())switch(s.getTokenType()){case e.MEF:return{params:{meftoken:s.getToken()}};case e.AP:return{params:{aptoken:s.getToken()}};case e.DBN_JWT:return{headers:{authorization:"Bearer "+s.getToken()}};default:return{params:{aptoken:s.getToken()}}}return{}},this.hapi=new l({baseUrl:function(){var e=i.get("hapiRho");return e.protocol+"://"+e.host},defaults:this.getDefaults}),this.sameOriginHapi=new l({baseUrl:function(){return""},defaults:this.getDefaults}),this.statistics=new l({baseUrl:function(){return i.get("statistics").endpoint},defaults:function(){return{headers:{Authorization:"Bearer "+s.getToken()}}}}),this.afterLogin=function(e){c.get("userId")!==e.id&&(console.warn("afterLogin clear LocalStorage",c.get("userId"),e),c.clear()),e.apps&&e.apps.length?(t=e.apps.find(function(e){return e.id===i.get("appId")}))?s.setApToken(t.session):(t=e.institution||e.institutions[0],s.setApToken(t.session),s.setLMS(t.id)):(t=e.institution||e.institutions[0],s.setApToken(t.session),s.setLMS(t.id)),s.setUserId(e.id),s.user=e,s.isChapterPreview()&&s.setReaderMode("CHAPTERPREVIEW");var t=c.get("lastfcmtoken");t&&u.pushSubscribe(t)},this.login=function(e){var t=this;return e.type="web",e.workspace=i.get("workspaceId"),e.app=i.get("appId"),this.hapi.post("/v1/reader/users/login",e,{withCredentials:!0}).then(function(e){e=e.data;t.afterLogin(e)})},this.register=function(e){return this.hapi.post("/v2/reader/users/register",e).then(function(e){return e.data})},this.getUser=function(){return this.hapi.get("/v1/reader/users/"+s.getUserId()).then(function(e){return e.data})},this.resetPassword=function(e){var t=n.get("FirebaseAnalyticsService");return u.hapi.post("/v1/reader/users/lost",{email:e,app:i.get("appId"),lang:c.get("lang")}).then(function(e){return t.forgotPassword("success"),e}).catch(function(e){return t.forgotPassword("failed"),e})},this.getCloudFrontCookies=function(){var e=u.getDefaults();return e.withCredentials=!0,u.sameOriginHapi.get("/v1/reader/users/get-cloudfront-signed-cookies",e)},this.hasCloudFrontCookies=function(){var e=o.get("CloudFront-Key-Pair-Id"),t=o.get("CloudFront-Policy"),n=o.get("CloudFront-Signature");return e&&t&&n},this.refreshCloudFrontCookies=function(){return!i.get("s3").cloudFrontEnabled||u.hasCloudFrontCookies()?void 0:u.getCloudFrontCookies()},this.validateOneTimeReset=function(e,t){return u.hapi.post("/v1/reader/users/one-time-reset-validation",{userId:e,token:t})},this.confirmNewPassword=function(e,t,n){return u.hapi.post("/v1/reader/users/confirm-password",{userId:e,token:t,password:n})},this.get=function(e){return a.get(e)},this.ssoLogin=function(e){return u.get(u.hapi.baseUrl()+"/v1/reader/users/sso?aptoken="+e).then(function(e){return e.data})},this.getCorrectionSrc=function(e,t){return u.hapi.getUrl("/ap/corrections/fullreport/"+e+"/"+t)},this.pushSubscribe=function(t){var e,n=this;if(s.getFCMToken()!==t&&!0!==this.pushSubscribing)return this.pushSubscribing=!0,(e={fcmToken:t}).app=i.get("appId"),e.type="web",this.hapi.post("/ap/users/pushSubscribe",e).then(function(e){return s.setFCMToken(t),n.pushSubscribing=!1,e.data}).catch(function(){n.pushSubscribing=!1})},this.getBookIdByExternalReference=function(e,t,n){return u.hapi.get("/ap/books/appId/"+e+"/reference/"+n+"?type="+t).then(function(e){return e.data})}}]),angular.module("commons").service("AnnotationService",["Config","DbnApi","Entity","LocalStorage","SessionService","UserDataConversionService","StatisticsService","Library","upsertAnnotationMutation","searchAnnotationsQuery","removeAnnotationMutation",function(s,c,r,u,a,l,d,g,p,h,i){var n,f=this;this.addAnnotation=function(e,t){var n,o,i;return"PREVIEW"===a.readerMode?Promise.resolve([]):(n=l.legacyToDbnUserData(e),e=u.get("userId"),o=s.getAppId(),i=g.getBookOrAssignmentBySharingId(n.projectId),e={userId:e,distributionChannelId:o,annotations:[n],clientMutationId:r.generateUUID()},c.mutate(p,{input:e}).then(function(e){return d.userInputsEvent({type:n.noteText?"note":"highlight",action:"created"===t?"create":"update",pageId:n.pageId,bookId:n.projectId,bookISBN:i?i.isbn:null,pageIndex:n.pageNumber}),l.getUserInputsLike(e.data.upsertAnnotations.annotations)}))};this.saveBulkAnnotations=function(e){var n,o;if("PREVIEW"!==a.readerMode)return e=e.map(function(e){return l.legacyToDbnUserData(e)}),n=u.get("userId"),o=s.getAppId(),e=function(e,t){for(var n=[],o=0;o<e.length;o+=t)n.push(e.slice(o,o+t));return n}(e,30).map(function(e){var t=n;return t={userId:n,distributionChannelId:o,annotations:e,clientMutationId:r.generateUUID()},c.mutate(p,{input:t}).then(function(e){return l.getUserInputsLike(e.data.upsertAnnotations.annotations)})}),Promise.all(e).then(function(e){var t;return(t=[]).concat.apply(t,_toConsumableArray(e))})},this.getByPageIds=(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:i=s.getAppId(),o=u.get("userId"),o={userId:o,distributionChannelId:i,pageIds:n,projectId:t},i=[],r=!0,a=void 0;case 6:if(r)return e.next=9,c.query(h,{input:o});e.next=15;break;case 9:a=e.sent,r=a.data.searchAnnotations.pageInfo.hasNextPage,i=i.concat(a.data.searchAnnotations.nodes),o.after=a.data.searchAnnotations.pageInfo.endCursor,e.next=6;break;case 15:return e.abrupt("return",l.getUserInputsLike(i));case 16:case"end":return e.stop()}},e,f)})),function(e,t){return n.apply(this,arguments)}),this.remove=function(e){var t=s.getAppId(),n=u.get("userId"),o=g.getBookOrAssignmentBySharingId(e.sharingId),n={ids:[e.id],userId:n,distributionChannelId:t,clientMutationId:r.generateUUID()};return d.userInputsEvent({type:e.options.noteText?"note":"highlight",action:"delete",pageId:e.pageId,bookId:e.sharingId,bookISBN:o?o.isbn:null,pageIndex:e.pageIndex}),c.mutate(i,{input:n})}}]),angular.module("commons").service("BookmarkService",["Config","DbnApi","Entity","LocalStorage","searchBookmarksQuery","upsertBookmarksMutation","removeBookmarksMutation",function(a,s,o,c,u,t,n){var i,l=this;this.computeId=function(e){var t=c.get("userId"),n=a.getAppId();return"hash"+o.hashCode(n+t+e)},this.getBookmarks=(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,o,i,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=c.get("userId"),o=a.getAppId(),n={userId:n,distributionChannelId:o,projectId:t},o=[],i=!0,r=void 0;case 6:if(i)return e.next=9,s.query(u,{input:n});e.next=15;break;case 9:r=e.sent,i=r.data.searchBookmarks.pageInfo.hasNextPage,o=o.concat(r.data.searchBookmarks.nodes),n.after=r.data.searchBookmarks.pageInfo.endCursor,e.next=6;break;case 15:return e.abrupt("return",o);case 16:case"end":return e.stop()}},e,l)})),function(e){return i.apply(this,arguments)}),this.remove=function(e){e={userId:c.get("userId"),distributionChannelId:a.getAppId(),ids:[e.id],clientMutationId:o.generateUUID()};return s.mutate(n,{input:e}).then(function(e){return e.data.removeBookmarks.bookmarks})},this.upsertBookmark=function(e){e={userId:c.get("userId"),distributionChannelId:a.getAppId(),bookmarks:[e],clientMutationId:o.generateUUID()};return s.mutate(t,{input:e}).then(function(e){return e.data.upsertBookmarks.bookmarks[0]})}}]),angular.module("commons").service("ColorAccessibility",function(){this.relativeLuminance=function(e){e=(e=(e=(e=(e=/^#([A-Fa-f0-9]{3}){1,2}$/.test(e)?"rgba("+[(t="0x"+(t=3==(t=(t=e).substring(1).split("")).length?[t[0],t[0],t[1],t[1],t[2],t[2]]:t).join(""))>>16&255,t>>8&255,255&t].join(",")+",1)":e).replace("rgba(","")).replace("rgb(","")).replace(")","")).replace(/[.]/,"0.");var t=JSON.parse("["+e+"]"),e=t[0]/255,n=t[1]/255,o=t[2]/255;return.2126*(e<=.03928?e/12.92:Math.pow((.055+e)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((.055+n)/1.055,2.4))+.0722*(o<=.03928?o/12.92:Math.pow((.055+o)/1.055,2.4))}}),angular.module("commons").service("Config",["$q","ngDialog","$sce",function(t,n,i){var r=this;this.config={},this.load=function(e){return r.config=e,t.resolve(r.config)},this.get=function(e){return r.config[e]},this.set=function(e,t){r.config[e]=t},this.getAppId=function(){return r.get("appId")},this.hasExternalAuthenticationProvider=function(){var e=r.get("ssos"),t=r.get("usersReadOnly");return e&&0<e.length||!0===t},this.hasFeature=function(e){var t=r.get("features");return!(!t||r.hasExternalAuthenticationProvider()&&"accessAndPurchase"===e||!(t=t[e])||!0!==t.value)},this.isTermsAndConditionsDisabled=function(){var e=r.get("links");return!e||(e=e.find(function(e){return"terms"===e.type}))&&""===e.url},this.getExternalLinkVersion=function(t){var e=r.get("links");return!!e&&!!(e=e.find(function(e){return e.type===t}))&&e.version},this.getExternalLink=function(t){var e=r.get("links");return!!e&&!!(e=e.find(function(e){return e.type===t}))&&e.url},this.getExternalLinkDisplay=function(t){var e=r.get("links");return e&&e.find(function(e){return e.type===t})||!1},this.hasScreenSorter=function(e){var t=r.get("screens");return t[e]&&t[e].sorters},this.getScreenSorter=function(e){return r.get("screens")[e].sorters.list},this.getCurrentScreenSorter=function(e){return r.get("screens")[e].sorters.current},this.isSingleMode=function(){var e=r.get("screens").reader;return!(!e||!e.single)},this.openNewTab=function(){var e=r.get("screens").reader;return!!(e&&e.features&&e.features.external)},this.displayReaderLinks=function(){var e=r.get("screens").reader;return!!(e&&e.features&&e.features.displayLinks)},this.hasOIDCActive=function(){var e=r.get("ssos");return!(!e||!e.length||!e.find(function(e){return"oidc"===e.protocol}))},this.getOIDCLabel=function(){var e=r.get("ssos");return e&&e.length&&(e=e.find(function(e){return"oidc"===e.protocol}))?e.label:""},this.hasReadAloud=function(){return!!r.hasFeature("readAloud")&&!!r.get("features").readAloud.id},this.hasIosUniversalLink=function(){return r.hasIos()&&r.get("ios").universalLink},this.hasAndroidUniversalLink=function(){return r.hasAndroid()&&r.get("android").universalLink},this.hasIos=function(){return r.get("ios")&&(r.get("ios").onSmartphone||r.get("ios").onTablet)},this.hasAndroid=function(){return r.get("android")&&(r.get("android").onSmartphone||r.get("android").onTablet)},this.hasWebreader=function(){return r.get("webreader")&&r.get("webreader").onDesktop},this.hasUsersMigratedToDbn=function(){return r.get("dbn")&&r.get("dbn").user},this.hasUsersDataMigratedToDbn=function(){return r.get("dbn")&&r.get("dbn").userData},this.enableJwt=function(){return r.get("dbn")&&r.get("dbn").enableJwt},this.hasNotesOnTheSide=function(){return r.config.screens.reader.features.notesOnTheSide},this.isMobile=function(e,t){var n=navigator.userAgent.match("iPad")||navigator.userAgent.match("iPhone")||navigator.userAgent.match("iPod"),o=navigator.userAgent.match("Android");return r.hasIos()&&n?{customLink:r.getAppId(),iOSLink:"https://itunes.apple.com/app/apple-store/id"+t+"?mt=8",mobile:!0}:r.hasAndroid()&&o?{androidLink:"https://play.google.com/store/apps/details?id="+e,customLink:i.trustAsResourceUrl("intent://gt/#Intent;scheme="+r.getAppId()+";package="+e+";end"),mobile:!0}:n||o?{mobile:!0}:{mobile:!1}},this.showNotificationBannerOnMobile=function(){return!r.isMobile().mobile},this.mobileCheckModal=function(e){r.isCengageWS()||n.open({template:"commons/templates/mobile-pop-up/mobile-pop-up.html",controllerAs:"$ctrl",appendClassName:"mobile-pop-up",showClose:!1,closeByEscape:!1,className:"ngdialog-theme-default",resolve:{isMobile:function(){return e}},controller:["isMobile","Config",function(e,t){this.isMobile=e,this.iosConfig=t.get("ios"),this.androidConfig=t.get("android"),e.iOSLink&&(document.head.insertAdjacentHTML("beforeend","<style>\n                        body.ngdialog-open, html.ngdialog-open {\n                            overflow: scroll;\n                        }\n                        </style>"),window.scrollTo(0,-100))}]})},this.wrNotExists=function(){n.open({template:"commons/templates/wr-not-exists-popup.html",controllerAs:"$ctrl",appendClassName:"mobile-pop-up",showClose:!1,closeByEscape:!1,className:"ngdialog-theme-default"})},this.getLocalStorageSize=function(){var e,t=0;for(e in localStorage){var n=2*localStorage[e].length/1024/1024;!isNaN(n)&&localStorage.hasOwnProperty(e)&&(t+=n)}return t.toFixed(2)},this.isCengageWS=function(){return["0b35898b-c464-43f0-949a-dab60635af6b","4de27bea-d98f-4176-a5f6-20a88a443280","cac42432-31e8-45dd-8a58-f7cd34107d2d","528f8b8b-71b8-433f-b130-3106805f545a"].includes(r.get("workspaceId"))},this.defaultLanguage=function(){var t=r.get("languages");return Object.keys(t).find(function(e){return t[e].default})||"en"},this.hasDbnExports=function(){return r.get("dbn")&&r.get("dbn").exports}}]),angular.module("commons").service("Cookies",function(){this.get=function(e){var t=!0,n=!1,o=void 0;try{for(var i,r=document.cookie.split("; ")[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=i.value.split("=");if(a[0]===e)return a[1]}}catch(e){n=!0,o=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw o}}return null}});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("commons").service("DbnApi",["Config","$http","$q","LocalStorage","SessionService","Entity","loginMutation","refreshTokenMutation","verifyCredentialsMutation","meQuery","registerMutation","requestResetPasswordMutation","resetPasswordMutation","updateIdentityMutation","requestAccountDeletionMutation","resendActivationCodeMutation","requestChangeEmailMutation","userByEmailInWorkspaceQuery","logoutMutation","updateUserPrintLimit","userPreviewPagesQuery","trackEventsMutation",function(r,a,s,i,c,o,n,t,u,e,l,d,g,p,h,f,m,b,v,I,y,k){var _=this;this.getHeaders=function(){var e={"x-gt-client-name":r.enableJwt()?"wr3":"wr3-legacy","x-gt-client-version":r.get("appVersion")?r.get("appVersion"):"unknown","x-gt-locale":i.get("lang")||r.defaultLanguage(),"x-gt-workspace-id":r.get("workspaceId"),"x-gt-distribution-channel-id":r.get("appId")};return r.enableJwt()&&c.getToken()&&(e.authorization="Bearer "+c.getToken()),e},this.graphqlHeaders=function(){return _extends(_.getHeaders(),{"Content-Type":"application/json"})},this.query=this.mutate=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},i=r.get("dbnUrl")+"/graphql",n=_extends(_.graphqlHeaders(),n),n=(o.headers=n,{query:e});return t&&(n.variables=t),a.post(i,n,o).then(function(e){return e.data&&e.data.errors&&e.data.errors.length?s.reject(e.data.errors[0]):e.data}).catch(function(e){throw console.error("Error mutate/query",e),e})},this.dbnExternalStoreToLegacyThirdParties=function(e,t){switch(e){case"ComptiaBenchPrep":return{comptia:{}};case"ComptiaSelfPaced":return{comptiaSelfPaced:{}};case"CengageOkta":var n={};return t&&t.readerOptions&&(t.readerOptions.features&&(t.readerOptions.features.print&&"enabled"in t.readerOptions.features.print&&(n.enablePrint=t.readerOptions.features.print.enabled),t.readerOptions.features.mobileDownload)&&"enabled"in t.readerOptions.features.mobileDownload&&(n.mobileDownload=t.readerOptions.features.mobileDownload.enabled),t.readerOptions.analytics&&t.readerOptions.analytics.provider&&(n.identityProvider=t.readerOptions.analytics.provider),t.readerOptions.location&&(t.readerOptions.location.reference&&t.readerOptions.location.reference.value&&(n.isbn=t.readerOptions.location.reference.value),t.readerOptions.location.reference&&t.readerOptions.location.reference.type&&(n.referenceType=t.readerOptions.location.reference.type),t.readerOptions.location.pageId)&&(n.pageId=t.readerOptions.location.pageId),t.readerOptions.preview)&&(n.preview=t.readerOptions.preview),t&&t.externalUserId&&(n.user_id=t.externalUserId),{cengage:n};case"PivotPoint":return{pivotPoint:{}};default:return{}}},this.getUserPreviewPages=function(e){return _.query(y,e).then(function(e){return e.data.userPreviewPages})},this.emailCheck=function(e){return _.query(b,e).then(function(e){return null!==e.data.userByEmailInWorkspace})},this.logout=function(){return _.mutate(v,{input:{clientMutationId:o.generateUUID()}})},this.resendActivationCode=function(e){return _.mutate(f,{input:{clientMutationId:o.generateUUID(),email:e.email,distributionChannelId:e.app_id}})},this.login=function(e){var t=r.getAppId();return _.mutate(n,{input:{distributionChannelId:t,email:e.email,password:e.password,clientMutationId:o.generateUUID(),linkToDistributionChannel:!0}},{withCredentials:!0,authorization:void 0}).then(function(e){var t,n;if(e.data&&e.data.login&&0===e.data.login.userErrors.length)return t=(n=e.data.login).accessToken,n=n.refreshToken,_.postLogin(t,n);throw new Error(e.data.login.userErrors[0].code)})},this.postLogin=function(t,n){var o=r.getAppId();return c.setAccessToken(t),c.setRefreshToken(n),_.getMe().then(function(e){e=e.data.me;return i.get("userId")!==e.id&&(i.clear(),c.setAccessToken(t),c.setRefreshToken(n)),c.setUserId(e.id),c.user=_.convertUser(e),e}).then(function(e){if(e.readerOptions&&e.readerOptions.preview)return _.getUserPreviewPages({distributionChannelId:o,userId:e.id}).then(function(e){c.setUserPreviewPages(e)})})},this.refreshToken=function(){var e=c.getRefreshToken();return e?_.mutate(t,{input:{clientMutationId:o.generateUUID(),refreshToken:e}},{authorization:void 0}).then(function(e){var e=e.data.refreshToken,t=e.accessToken,n=e.refreshToken,e=e.userErrors;if(e&&0<e.length)throw e[0];c.setAccessToken(t),c.setRefreshToken(n)}):s.reject("No refresh token found on refreshToken!")},this.verifyCredentials=function(e){return _.mutate(u,{input:{clientMutationId:o.generateUUID(),distributionChannelId:r.getAppId(),email:e.email,password:e.password,userId:c.getUserId()}}).then(function(e){var e=e.data.verifyCredentials,t=e.accessToken,n=e.refreshToken,e=e.userErrors;if(0<e.length)return s.reject(e);c.setAccessToken(t),c.setRefreshToken(n)})},this.getMe=function(){return _.query(e)},this.register=function(e){return _.mutate(l,{input:{clientMutationId:o.generateUUID(),distributionChannelId:r.getAppId(),email:e.email,firstName:e.firstName,lastName:e.lastName,password:e.password}})},this.resetPassword=function(e){return _.mutate(d,{input:{clientMutationId:o.generateUUID(),distributionChannelId:r.getAppId(),email:e}})},this.resetPasswordConfirm=function(e,t,n){return _.mutate(g,{input:{clientMutationId:o.generateUUID(),resetPasswordCode:e,newPassword:t,newPasswordConfirmation:n}},{authorization:void 0})},this.updateIdentity=function(e){return _.mutate(p,{input:{clientMutationId:o.generateUUID(),firstName:e.firstName,id:e.id,lastName:e.lastName}})},this.requestChangeEmail=function(e){var t=c.getUser();return _.mutate(m,{input:{clientMutationId:o.generateUUID(),distributionChannelId:r.getAppId(),email:t.email,newEmail:e.toLowerCase()}})},this.requestAccountDeletion=function(){return _.mutate(h,{input:{clientMutationId:o.generateUUID(),id:c.getUserId()}})},this.updateUserPrintLimit=function(e,t){return _.mutate(I,{clientMutationId:o.generateUUID(),userId:e,sessionKey:c.getToken(),usedPages:t}).then(function(e){var e=e.data.updateUserPrintLimit,t=e.leftToPrint,e=e.userErrors;return 0<e.length?s.reject(e):t})},this.convertUser=function(n){var o=[],i=r.getAppId(),e=n.distributionChannels.find(function(e){return e.id===i}),e=(e.hasUserSignedRequiredCondition&&e.conditions.filter(function(e){return"TERMS"===e.type}).map(function(e){e={date:Date.now(),url:e.link,version:e.version};return o.push({current:e,list:[e],type:"terms"})}),_.dbnExternalStoreToLegacyThirdParties(n.externalStoreProvider,n)),t=n.distributionChannels.map(function(e){var t={id:e.id,type:"distrib"};return i===e.id&&(t.session=c.getToken(),t.conditions=o,n.readerOptions)&&n.readerOptions.features&&n.readerOptions.features.print&&n.readerOptions.features.print.enabled&&(t.print={token:c.getToken(),limit:n.readerOptions.features.print.value}),t}),t={$created_at:Date.parse(n.createdAt),$updated_at:Date.parse(n.updatedAt),active:n.isActivated,apps:t,email:n.email,id:n.id,identity:n.firstName+" "+n.lastName,institutions:[],is_from_old_api:!1,licenses:[],options:{},thirdparties:e,type:"web",workspace_id:n.workspaceId,externalUserId:n.externalUserId};return n.watermark&&(t.watermark=n.watermark),n.readerOptions&&n.readerOptions.preview&&(t.options.is_preview=!0),t},this.sendTrackedEvent=function(e){return _.mutate(k,{clientMutationId:o.generateUUID(),events:e}).then(function(e){e=e.data.trackEvents.userErrors;if(e&&0<e.length)return s.reject(e)})}}]),angular.module("commons").service("DictionaryService",["Config","$http",function(n,o){var i=this;this.buildDictionaryUrl=function(e,t){return n.get("dictionaryUrl").replace("[lang]",e).replace("[term]",t.toLowerCase())},this.getDefinitionHtml=function(e,t){e=i.buildDictionaryUrl(e,t);return o.get(e).then(function(e){return e.data}).catch(function(e){return console.error(e)})}}]),angular.module("commons").service("ExerciseAnswerService",["DbnApi","Config","LocalStorage","Entity","SessionService","UserDataConversionService","searchExerciseAnswers","upsertExerciseAnswersMutation","removeExerciseAnswersMutation",function(s,c,u,l,d,g,p,h,t){var n,o,f=this;this.getByPageIds=(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o={projectId:t,pageIds:n,userId:u.get("userId"),distributionChannelId:c.getAppId()},i=!0,r=[],a=void 0;case 4:if(i)return e.next=7,s.query(p,{input:o});e.next=13;break;case 7:a=e.sent,r=r.concat(a.data.searchExerciseAnswers.nodes),i=a.data.searchExerciseAnswers.pageInfo.hasNextPage,o.after=a.data.searchExerciseAnswers.pageInfo.endCursor,e.next=4;break;case 13:return e.abrupt("return",g.getUserInputsLike(r));case 14:case"end":return e.stop()}},e,f)})),function(e,t){return n.apply(this,arguments)}),this.computeId=function(e){var t=u.get("userId"),n=c.getAppId(),o=e.sharingId||e.path,i=e.pageId,r=e.fid,e=e.id;return"hash"+l.hashCode(n+t+o+i+r+e)},this.upsert=(o=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){var o,i,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("PREVIEW"===d.readerMode)return e.abrupt("return");e.next=2;break;case 2:return o=u.get("userId"),i=c.getAppId(),(a=t.id)||(r={sharingId:t.sharingId,pageId:n,id:t.fid,fid:t.fid},a=f.computeId(r)),r={id:a,userId:o,appId:i,deleted:!1,pageId:n,pageTitle:t.pageTitle,pageIndex:t.pageIndex,type:"exercise",contentVersion:t.contentVersion,userDate:Date.now(),version:f._currentDataModelVersion,options:{questions:"string"==typeof t.questions?t.questions:JSON.stringify(t.questions),currentQuestion:t.currentQuestion,nbQuestions:t.nbQuestions,submitted:t.submitted,score_type:t.score_type,score:t.score,scorePerc:t.scorePerc,exerciseId:t.fid}},t.sharingId&&(r.sharingId=t.sharingId),f.prepareExerciseForSync(r),a={distributionChannelId:i,userId:o,clientMutationId:l.generateUUID(),exerciseAnswers:[g.legacyToDbnUserData(r)]},e.abrupt("return",s.mutate(h,{input:a}));case 11:case"end":return e.stop()}},e,f)})),function(e,t){return o.apply(this,arguments)}),this.remove=function(e){e={distributionChannelId:c.getAppId(),userId:u.get("userId"),ids:[e],clientMutationId:l.generateUUID()};return s.mutate(t,{input:e})},this.prepareExerciseForInjection=function(e){"string"==typeof e.options.questions?e.questions=JSON.parse(e.options.questions):e.questions=e.options.questions,e.currentQuestion=e.options.currentQuestion,e.nbQuestions=e.options.nbQuestions,e.submitted=e.options.submitted,e.score_type=e.options.score_type,e.score=e.options.score,e.scorePerc=e.options.scorePerc},this.prepareExerciseForSync=function(e){e.questions&&delete e.questions,!e.currentQuestion&&0!==e.currentQuestion||delete e.currentQuestion,!e.nbQuestions&&0!==e.nbQuestions||delete e.nbQuestions,!e.submitted&&!1!==e.submitted||delete e.submitted,e.score_type&&delete e.score_type,!e.score&&0!==e.score||delete e.score,!e.scorePerc&&0!==e.scorePerc||delete e.scorePerc}}]),angular.module("commons").service("FilterService",["Library","UsersContentsInfos","API","SessionService",function(r,n,t,o){var a=this;this.filter=[],this.mappedFilters={},this.books=r.getBooks(),this.filteredBooks=[],this.load=function(e){return t.hapi.get("/v1/reader/appstudio/"+e+"/filters").then(function(e){a.filter=e.data}).catch(function(e){console.log(e)})},this.loadFilters=function(){return a.mapFilters(a.books)},this.getFilter=function(){return a.filter},this.getMappedFilters=function(){return a.mappedFilters},this.getFilteredBooks=function(){return a.filteredBooks},this.unique=function(e){return[].concat(_toConsumableArray(new Set(e)))},this.pushValue=function(e,t,n){t=e+"_"+t;a.mappedFilters[t]||(a.mappedFilters[t]={},a.mappedFilters[t].ids=[]),a.mappedFilters[t].name=e,a.mappedFilters[t].ids.push(n.id)},this.checkMetasType=function(t,n){Array.isArray(t.value)?t.value.forEach(function(e){a.pushValue(t.name,e,n)}):t.value&&a.pushValue(t.name,t.value,n)},this.readUnreadBooks=function(e){var t=n.getBySharingId(e.getSharingId());t&&t.options.lastOpen?a.pushValue("generic","read",e):a.pushValue("generic","unread",e)},this.mapFilters=function(e){var n;o.getLMS()||(a.mappedFilters={},n=a.filter.map(function(e){return e.name}),e.forEach(function(t){a.readUnreadBooks(t),t.project_metas&&t.project_metas.value&&t.project_metas.value.forEach(function(e){n.includes(e.name)&&a.checkMetasType(e,t)})}))},this.filterBooks=function(e){if(e&&e.length){var t,n={},o=[],i=[];for(t in e.forEach(function(e){e=a.mappedFilters[e.name+"_"+e.value];e&&e.ids&&(n[e.name]||(n[e.name]=[]),n[e.name]=n[e.name].concat(e.ids))}),n)o.push(n[t]);1===o.length&&(i=a.unique(o[0])),2<=o.length&&(i=o.reduce(a.intersection)),a.filteredBooks=i.map(function(e){return r.getBookById(e)})}},this.intersection=function(e,t){var e=new Set(e),n=new Set(t);return[].concat(_toConsumableArray(new Set([].concat(_toConsumableArray(e)).filter(function(e){return n.has(e)}))))}}]),angular.module("commons").service("FirebaseAnalyticsService",["FirebaseService","SessionService","$filter",function(o,e,r){var n,i=this,a=(n=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.logEvent(t,n);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.error("Firebase analytics eventName: "+t+" error",e.t0);case 8:case"end":return e.stop()}},e,i,[[0,5]])})),function(e,t){return n.apply(this,arguments)});this.loginSuccess=function(){return a("loginSuccess",{eventGroup:"login",userid:e.getUser().id})},this.loginFailed=function(){return a("loginFailed",{eventGroup:"login"})},this.logout=function(e){if(e)return e=r("capitalize")(e),a("logout"+e,{eventGroup:"logout"})},this.searchFromLibrary=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";if(e)return a("searchFromLibrary",{eventGroup:"search",searchTerms:e})},this.searchFromBook=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";if(e&&t)return a("searchFromBook",{eventGroup:"search",bookId:e.book_content_id,bookTitle:e.getTitle(),searchTerms:t})},this.bookmark=function(e,t,n,o){if(e&&t&&n&&o)return e=r("capitalize")(e),a("bookmark"+e,{eventGroup:"bookmark",bookId:n.book_content_id,bookTitle:n.getTitle(),pageId:o.path,pageTitle:o.title,annotId:t.id})},this.highlight=function(e,t,n,o,i){if(e&&t&&n&&o)return e=r("capitalize")(e),a("highlight"+e,{eventGroup:"highlight",bookId:n.book_content_id,bookTitle:n.getTitle(),pageId:o.path,pageTitle:o.title,annotId:t.id,trigger:i})},this.note=function(e,t,n,o,i){if(e&&t&&n&&o)return e=r("capitalize")(e),a("note"+e,{eventGroup:"note",bookId:n.book_content_id,bookTitle:n.getTitle(),pageId:o.path,pageTitle:o.title,annotId:t.id,trigger:i})},this.bookOpened=function(e,t,n){if(e&&t&&n)return a("bookOpened",{eventGroup:"book",eventOrigin:t,bookId:e.id,bookTitle:e.getTitle(),contentType:n})},this.bookInfosOpened=function(e,t,n){if(e&&t&&n)return a("bookInfosOpened",{eventGroup:"book",bookId:e.id,bookTitle:e.getTitle(),eventOrigin:t,contentType:n})},this.register=function(e){if(e)return e=r("capitalize")(e),a("register"+e,{eventGroup:"register"})},this.forgotPassword=function(e){if(e)return e=r("capitalize")(e),a("forgotPassword"+e,{eventGroup:"forgotPassword"})},this.languageChanged=function(e){if(e)return a("languageChanged",{eventGroup:"language",lang:e})},this.termsAccepted=function(e){if(e)return a("termsAccepted",{eventGroup:"terms",termsVersion:e})};this.pageViewed=function(e,t,n){var o,i;if(e&&t&&n)return o=e,i=new Date,o=new Date(o),i=(o={duration:i.getTime()-o.getTime(),endTime:i.toISOString()}).endTime,o=o.duration,a("pageViewed",{eventGroup:"pageViewed",bookId:t.book_content_id,bookTitle:t.getTitle(),pageId:n.path,pageTitle:n.title,pageViewedStartedAt:e,pageViewedEndedAt:i,pageViewedDuration:o})},this.contentCopied=function(e,t,n,o){if(e&&0!==o)return a("contentCopied",{eventGroup:"contentCopied",bookId:t?t.book_content_id:void 0,bookTitle:t?t.getTitle():void 0,pageId:n?n.path:void 0,pageTitle:n?n.title:void 0,context:e,characterCount:o})}}]),angular.module("commons").service("FirebaseService",["API","LocalStorage","NotificationService","Config",function(t,n,r,a){function s(e){for(var t=document.getElementsByTagName("script"),n=t.length;n--;)if(t[n].src==e)return 1}function c(e,t){var n=document.createElement("script");t&&(n.onload=t),document.head.appendChild(n),n.src=e}var u=this;this.firebase=null,this.publicKey=null,this.registration=null;return this.injectScripts=function(){var e,t,n,o,i=u.initialize;return(a.hasFeature("notifications")||a.hasFeature("firebaseAnalytics"))&&(t="https://www.gstatic.com/firebasejs/8.9.1/firebase-messaging.js",n="https://www.gstatic.com/firebasejs/8.9.1/firebase-analytics.js",o="https://www.gstatic.com/firebasejs/8.9.1/firebase-remote-config.js",s(e="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js")&&s(t)&&s(n)&&s(o)?u.firebase&&r.fetchConfig(u.firebase):c(e,function(){c(n,function(){c(t,function(){c(o,function(){var e=a.get("notificationPublicKey"),t=a.get("notificationScript");t&&e&&(t=(t=(t=(t=(t=t.match("{(.*)}")[0].trim()).replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:(?=\s)/g,'"$2": ')).replace(/ /g,"")).replace(/https:/g,"https")).replace(/https/g,"https:"),t=JSON.parse(t),i(t,e))})})})})),!0},this.initialize=function(e,t){u.firebase=window.firebase,u.publicKey=t,0===u.firebase.apps.length?(u.firebase.initializeApp(e),r.fetchConfig(u.firebase),a.hasFeature("firebaseAnalytics")&&u.firebase.analytics(),a.hasFeature("notifications")&&navigator.serviceWorker.register("firebase-messaging-sw.js?id="+e.messagingSenderId).then(function(e){return u.registration=e,u.firebase.messaging().useServiceWorker(e),navigator.serviceWorker.ready}).then(function(e){u.requestPermission()}).catch(function(e){})):a.hasFeature("notifications")&&!n.get("lastfcmtoken")&&u.requestPermission()},this.requestPermission=function(){u.firebase.messaging().usePublicVapidKey(u.publicKey),u.firebase.messaging().requestPermission().then(function(){return u.firebase.messaging().getToken().then(function(e){return e})}).then(function(e){n.set("lastfcmtoken",e),t.pushSubscribe(e)}).catch(function(e){console.log("FCM: ",e)}),u.firebase.messaging().onTokenRefresh(function(){u.firebase.messaging().getToken().then(function(e){n.set("lastfcmtoken",e),t.pushSubscribe(e)}).catch(function(e){console.log("FCM: ",e)})}),u.firebase.messaging().onMessage(function(e){u.showNotification(e)}),u.firebase.messaging().setBackgroundMessageHandler(function(e){u.showNotification(e)})},this.showNotification=function(e){var t=e.notification.title,e={body:e.notification.body,icon:e.notification.icon};return u.registration.showNotification(t,e)},this.logEvent=function(e,t){if(u.firebase){var n=u.firebase.analytics();if(n)return n.logEvent(e,t)}},this}]),angular.module("commons").service("KeyCodesService",function(){var o=this;return this.codes={ESCAPE:{keys:["Escape","Esc"],keyCode:27},SPACE:{keys:[" ","Space","Spacebar"],keyCode:32},TAB:{keys:["Tab"],keyCode:9},ENTER:{keys:["Enter"],keyCode:13},SHIFT:{keys:["Shift","ShiftLeft","ShiftRight"],keyCode:16},CTRL:{keys:["Control","ControlLeft","ControlRight","Ctrl","Ctl"],keyCode:17},ARROW_LEFT:{keys:["ArrowLeft","Left"],keyCode:37},ARROW_UP:{keys:["ArrowUp","Up"],keyCode:38},ARROW_RIGHT:{keys:["ArrowRight","Right"],keyCode:39},ARROW_DOWN:{keys:["ArrowDown","Down"],keyCode:40},HOME:{keys:["Home","Numpad7"],keyCode:36},END:{keys:["End","Numpad1"],keyCode:35}},this.getMethodName=function(e){return"is"+e.split("_").map(function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}).join("")},Object.keys(this.codes).forEach(function(n){var e=o.getMethodName(n);o.codes[e]=function(e){var t;return!!e&&(t=!1,!!(e.key&&o.codes[n].keys.includes(e.key)||e.code&&o.codes[n].keys.includes(e.code)||e.keyCode&&o.codes[n].keyCode==e.keyCode)||t)}}),this.codes.shiftPrePressed=function(e){return!!e&&e.shiftKey},this.codes.isKeyBoardTriggeredEvent=function(e){return 0===e.screenX&&0===e.screenY},this.codes});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("commons").service("LegacySyncService",["API","LocalStorage","Library","StatisticsService","Config","Entity","SessionService","Assignment","UserDataProxyService",function(t,c,r,a,u,s,l,n,o){var i,d=this;this._cache=[],this._booksCache={},this._currentDataModelVersion=2,this._push=function(e){e.forEach(function(t){var e=d._syncData.userInputs.find(function(e){return e.id===t.id&&e.sharingId===t.sharingId});e?t.deleted?d._syncData.userInputs=d._syncData.userInputs.filter(function(e){return e.id!==t.id}):_extends(e,t):d._syncData.userInputs.push(t)}),d._updateCache()},this.computeId=function(e){var t=c.get("userId"),t=u.getAppId()+t+e.id;return"hash"+s.hashCode(t)},this.computeExerciseId=function(e){var t=c.get("userId"),n=u.getAppId(),o=e.sharingId||e.path,i=e.pageId,r=e.fid,e=e.id;return"hash"+s.hashCode(n+t+o+i+r+e)},this._migrateDataModelToVersion2=function(e){var i,r=[],a=c.get("userId"),s=u.getAppId();return a&&(i=[],e.docs&&(i=e.docs.filter(function(e){return"highlight"===e.type}),e.docs.forEach(function(t){var e=void 0;switch(t.type){case"bookmark":(e=(n=t).sharingId?(o={id:n.pageId},{id:d.computeId(o),$created_at:n.userDate,$updated_at:n.userDat,userId:a,appId:s,deleted:!1,contentVersion:""+n.moduleVersion||"1",pageId:n.pageId,version:1,sharingId:n.sharingId,type:n.type,userDate:n.userDate,options:{enabled:Boolean(!n.deleted)}}):null)&&r.push(e);break;case"note":var n,o=i.findIndex(function(e){return e.id===t.highlight.$ref});-1!==o&&(n=i[o],(e=function(e,t){if(!(e.sharingId&&t&&t.serialization&&"string"==typeof t.serialization&&t.serialization.length))return null;var n=d.computeId(e),o="",i="";try{var r=JSON.parse(t.serialization),o=r.color&&r.color.length?r.color:"#FFEB6B";r.id=n,i=JSON.stringify(r)}catch(e){return null}return{id:n,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:o,selectedText:t.content,noteText:e.text,serializedData:i,highlightId:t.id}}}(t,n))&&r.push(e),i.splice(o,1));break;case"exercise":case"quizz2":(e=function(e){if(!e.sharingId)return null;var t=e.questions;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return null}t={id:d.computeExerciseId(e),$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId||null,type:"exercise",userDate:e.userDate,options:{scorePerc:e.scorePerc||e.score,scoreType:e.score_type||"percent",questions:t,currentQuestion:e.currentQuestion,submitted:Boolean(e.submitted),score:e.score,exerciseId:e.fid}};return e.nbQuestions&&(t.options.nbQuestions=e.nbQuestions),t}(t))&&r.push(e)}})),i.forEach(function(e){e=function(e){if(!e.sharingId||!e.serialization||"string"!=typeof e.serialization||!e.serialization.length)return null;var t=d.computeId(e),n="",o="";try{var i=JSON.parse(e.serialization),n=i.color&&i.color.length?i.color:"#FFEB6B";i.id=t,o=JSON.stringify(i)}catch(e){return null}return{id:t,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:n,selectedText:e.content,serializedData:o}}}(e);e&&r.push(e)})),r},this._migrateDataModel=function(){var e,t=c.get("sync");t&&!t.version&&(e=d._migrateDataModelToVersion2(t),t={version:2,syncTimestamp:t.lastsyncdate||0,userInputs:e},c.set("sync",t))},this.load=function(){d._cache=[],d._booksCache={},d._migrateDataModel();var e=c.get("sync"),t=u.getAppId();return d._syncData={userInputs:[],syncTimestamp:0},e&&(d._syncData=e,d._updateCache()),o.load(t,e).then(function(e){return d._syncData||(d._syncData={version:d._currentDataModelVersion,syncTimestamp:0,userInputs:[]}),d._syncData.syncTimestamp=e.syncTimestamp,d._push(e.userInputs),d._syncData}).catch(function(){d._syncData={version:d._currentDataModelVersion,syncTimestamp:0,userInputs:[]}})},this._updateCache=function(){d._cache=d._get(),d._booksCache={},c.set("sync",d._syncData)},this.get=function(){return d._cache},this._get=function(){return d._syncData.userInputs=d._syncData.userInputs.filter(function(e){return!e.deleted}),d._syncData.userInputs.filter(function(e){var t=r.getBookOrAssignmentBySharingId(e.sharingId);return("bookmark"!==e.type||e.options.enabled)&&t})},this.getSyncDataByContext=function(e){var t=e.book,n=e.assignment,e=e.array,o=void 0;if(n)o=n;else{n=r.getBookByContentId(t);if(!n)throw Error("No book provided");o=n.getSharingId()}n=d._getSyncData(t,o);return e?n:{notes:n.filter(function(e){return"note"===e.type}),highlights:n.filter(function(e){return"highlight"===e.type}),bookmarks:n.filter(function(e){return"bookmark"===e.type}),exercises:n.filter(function(e){return"exercise"===e.type})}},this._getSyncData=function(e,t){return d._booksCache[e+t]||(d._booksCache[e+t]=d.get().filter(function(e){return e.sharingId==t}))},this.getUserInputsByContext=function(e){var t=e.book,e=e.assignment,n=void 0;if(e)n=e;else{e=r.getBookByContentId(t);if(!e)throw Error("No book provided");n=e.getSharingId()}return d._getUserInputs(t,n)},this._getUserInputs=function(e,t){e="ui_"+e+t;return d._booksCache[e]||(d._booksCache[e]=d.get().filter(function(e){return e.sharingId==t&&("note"===e.type||"highlight"===e.type||"bookmark"===e.type)}))},this.getNdAnnotations=function(){return d.get().filter(function(e){if("exercise"!==e.type){var t=r.getBookOrAssignmentBySharingId(e.sharingId);if(t instanceof n){if(t.book_id&&!r.getBookByBookId(t.book_id).getPage(e.pageId))return!0;if(t.module_id&&!r.getBookByBookId(t.module_id).getPage(e.pageId))return!0}else if(!t.getPage(e.pageId))return!0}return!1})},this.getUpdatedNdAnnotation=function(){return d.getNdAnnotations().filter(function(e){return!e.options.broken_status})},this.updateNdAnnotationsStatus=function(t){var e;"PREVIEW"!=l.readerMode&&((e=d.getNdAnnotations()).forEach(function(e){(t||e.options.broken_status)&&(!t||"viewed"===!e.options.broken_status&&e.options.broken_status)||(e.options.broken_status=t)}),d.push(e))},this.getByPageId=function(t,n){return d._syncData.userInputs.find(function(e){return e.pageId===t&&e.type===n})},this.getById=function(t){return d._syncData.userInputs.find(function(e){return e.id===t})},this.getExercise=function(t,n){return d._syncData.userInputs.find(function(e){return"exercise"===e.type&&e.options.exerciseId===t&&e.sharingId==n})},this.delete=(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=d.getById(t)){e.next=3;break}return e.abrupt("return");case 3:return"bookmark"===n.type?d.toggleBookmark(n):n.deleted=!0,e.next=6,d.push([n]);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,d)})),function(e){return i.apply(this,arguments)}),this.deleteExercise=function(e,t){e=d.getExercise(e,t);if(e)return e.deleted=!0,d.prepareExerciseForSync(e),d.push([e])},this.push=function(e){return t.hapi.post("/v3/reader/sync",{appId:u.getAppId(),syncTimestamp:d._syncData.syncTimestamp,userInputs:e}).then(function(e){e=e.data;return d._syncData.syncTimestamp=e.syncTimestamp,d.sendUserInputEvent(e.userInputs),d._push(e.userInputs),e}).catch(function(){return null})},this.sendUserInputEvent=function(e){e.forEach(function(e){var t,n,o,i;["highlight","bookmark","note"].includes(e.type)&&(t=d.getById(e.id),n="create",i=(o=r.getBookOrAssignmentBySharingId(e.sharingId)).getIndexOfPage(e.pageId),t&&e.deleted&&(n="delete"),t&&!e.deleted&&(n="update"),a.userInputsEvent({type:e.type,action:n,pageId:e.pageId,bookId:o.id,bookISBN:o.isbn,pageIndex:i}))})},this.toggleBookmark=function(e){var t,n,o,i;if("PREVIEW"!=l.readerMode)return t=u.getAppId(),n=c.get("userId"),null==(i=d.getByPageId(e.pageId,"bookmark"))?(o={id:e.pageId},i=_extends(e,{id:d.computeId(o),type:"bookmark",appId:t,userId:n,deleted:!1,pageId:e.pageId,pageTitle:e.pageTitle,pageIndex:e.pageIndex,contentVersion:e.contentVersion,userDate:Date.now(),version:d._currentDataModelVersion,options:{enabled:!0}})):i.options.enabled=!i.options.enabled,e.sharingId&&(i.sharingId=e.sharingId),d.push([i])},this.getBookmarks=function(){return d._syncData.userInputs.filter(function(e){return"bookmark"===e.type&&r.getBookOrAssignmentBySharingId(e.sharingId)})},this.isBookmarked=function(t,n,o){if("PREVIEW"!=l.readerMode&&o)return d.getBookmarks().find(function(e){return(e.pageId===t||e.pageId===o.path)&&e.sharingId===n&&!0===e.options.enabled})},this.addHighlight=function(e,t){var n,o,i;if("PREVIEW"!=l.readerMode)return n=Date.now(),o=u.getAppId(),i=c.get("userId"),o={id:e.id,appId:o,userId:i,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,contentVersion:e.contentVersion,type:"highlight",userDate:n,version:d._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e)}},(i=d.getById(e.id))&&(o.$created_at=i.$created_at),e.sharingId&&(o.sharingId=e.sharingId),d.push([o])},this.getHighlights=function(){return d.get().filter(function(e){return"highlight"===e.type&&r.getBookOrAssignmentBySharingId(e.sharingId)})},this.addNote=function(e,t,n){var o,i,r;if("PREVIEW"!=l.readerMode)return r=Date.now(),o=u.getAppId(),i=c.get("userId"),o={id:e.id,appId:o,userId:i,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,type:"note",contentVersion:e.contentVersion,userDate:r,version:d._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e),noteText:n}},(i=d.getById(e.id))&&(o.$created_at=i.$created_at),e.sharingId&&(o.sharingId=e.sharingId),!0!==e.noteFromHighlight||e.id.contains("-fromhighlight")?d.push([o]):((t=_extends({},o)).deleted=!0,delete t.options,delete t.type,(r=_extends({},e)).id=e.id+"-fromhighlight",o.id=r.id,o.options.highlightId=e.id,o.options.serializedData=JSON.stringify(r),d.push([t,o]))},this.getNotes=function(){return d._syncData.userInputs.filter(function(e){return"note"===e.type&&r.getBookOrAssignmentBySharingId(e.sharingId)})},this.addExercise=function(e,t){var n,o,i,r;if("PREVIEW"!=l.readerMode)return n=u.getAppId(),o=c.get("userId"),(r=e.id)||(i={sharingId:e.sharingId,pageId:t,id:e.fid,fid:e.fid},r=d.computeExerciseId(i)),i={id:r,userId:o,appId:n,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,type:"exercise",contentVersion:e.contentVersion,userDate:Date.now(),version:d._currentDataModelVersion,options:{questions:"string"==typeof e.questions?e.questions:JSON.stringify(e.questions),currentQuestion:e.currentQuestion,nbQuestions:e.nbQuestions,submitted:e.submitted,score_type:e.score_type,score:e.score,scorePerc:e.scorePerc,exerciseId:e.fid}},(r=d.getById(e.id))&&(i.$created_at=r.$created_at),e.sharingId&&(i.sharingId=e.sharingId),d.prepareExerciseForSync(i),d.push([i])},this.prepareExerciseForInjection=function(e){"string"==typeof e.options.questions?e.questions=JSON.parse(e.options.questions):e.questions=e.options.questions,e.currentQuestion=e.options.currentQuestion,e.nbQuestions=e.options.nbQuestions,e.submitted=e.options.submitted,e.score_type=e.options.score_type,e.score=e.options.score,e.scorePerc=e.options.scorePerc},this.prepareExerciseForSync=function(e){e.questions&&delete e.questions,!e.currentQuestion&&0!==e.currentQuestion||delete e.currentQuestion,!e.nbQuestions&&0!==e.nbQuestions||delete e.nbQuestions,!e.submitted&&0!=e.submitted||delete e.submitted,e.score_type&&delete e.score_type,!e.score&&0!==e.score||delete e.score,!e.scorePerc&&0!==e.scorePerc||delete e.scorePerc}}]),angular.module("commons").service("LicenseService",["API","ToolsService",function(e,n){var i=this;this.licenses=[],this.expiredBooks=[],this.load=function(){return e.hapi.get("/v1/reader/licenses/all").then(function(e){var e=e.data,t=e.licenses,e=e.expiredBooks;i.licenses=t,i.expiredBooks=e})},this.getByProjectId=function(e){for(var t={inapp:[],access_code:[]},n=0;n<i.licenses.length;n++){var o=i.licenses[n];o.projectIds.includes(e)&&t[o.type].push(o)}return t},this.calcExpireTime=function(e){var t=new Date;return n.calcDiffTime(new Date(e),t)},this.getExpireProjectIds=function(e){if(e&&e.length){for(var t=[],n=0;n<e.length;n++){var o=e[n],i=o.getActiveLicenseAndOthers().active,i=o.getLicenseTimeExpire(i.endDate);("days"===i.type&&i.time<=14||"hours"===i.type)&&t.push(o.project_id)}return t}}}]),angular.module("commons").service("LocalStorage",function(){this.set=function(e,t){localStorage.setItem(e,angular.toJson(t))},this.get=function(e){var t=localStorage.getItem(e);return t&&"undefined"!==t?"lang"===e?t:angular.fromJson(t):null},this.remove=function(e){localStorage.removeItem(e)},this.clear=function(){var t={};["view","sort","lastfcmtoken","lang","referenceType","referenceValue"].forEach(function(e){null!==localStorage.getItem(e)&&(t[e]=localStorage.getItem(e))}),localStorage.clear(),Object.keys(t).forEach(function(e){localStorage.setItem(e,t[e])})}});_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},angular.module("commons").service("ModuleService",["Config",function(n){var o=this;this.hasModule=function(e){o._modulesList=n.get("screens");var t=o._modulesList[e];return!(!t||!0!==t.enabled||n.hasExternalAuthenticationProvider()&&["passwordRecovery","register"].includes(e))},this.getModule=function(e){var t;if(o.hasModule(e))return o._modulesList=n.get("screens"),t=(e=o._modulesList[e]).current||"generic",t=e.templates[t],_extends(e,t)}}]),angular.module("commons").service("NotificationService",["$rootScope","LocalStorage",function(r,a){var s=this;return this.communication=[],this.maintenance=[],this.fetchConfig=function(e){s.communication=[],s.maintenance=[];var n=e.remoteConfig(),t=(n.settings={minimumFetchIntervalMillis:1},n.defaultConfig={communication:null,maintenance:null},a.get("communication")),o=a.get("maintenance"),e=+new Date,i=t&&t.timeStamp>e,e=o&&o.timeStamp>e;t&&t.config&&i&&setTimeout(function(){r.showBanner=s.showBanner(t.config),r.$broadcast("notification-banner",t.config),s.communication.push(t.config),r.$apply()},500),o&&o.config&&e&&setTimeout(function(){r.$broadcast("maintenance",o.config),s.maintenance.push(o.config),window.location=window.location.origin+"/maintenance.html"},500),i&&e||n.fetchAndActivate().then(function(){var e=n.getValue("communication").asString(),t=n.getValue("maintenance").asString();s.storeCommunication(e),s.storeMaintenance(t),e&&e.length&&"null"!==e&&(r.showBanner=s.showBanner(JSON.parse(e)),r.$broadcast("notification-banner",JSON.parse(e)),s.communication.push(JSON.parse(e)),r.$apply()),t&&t.length&&"null"!==t&&(r.$broadcast("maintenance",JSON.parse(t)),s.maintenance.push(t),window.location=window.location.origin+"/maintenance.html")}).catch(function(e){console.log(e)})},this.storeCommunication=function(e){var t;e&&e.length&&((t=new Date).setHours(t.getHours()+1),e={config:"string"==typeof e?JSON.parse(e):e,timeStamp:t.getTime()},a.set("communication",e))},this.storeMaintenance=function(e){var t;e&&e.length&&((t=new Date).setMinutes(t.getMinutes()+10),e={config:"string"==typeof e?JSON.parse(e):e,timeStamp:t.getTime()},a.set("maintenance",e))},this.showBanner=function(e){return!!e&&!(a.get("hide-banner")||[]).includes(e.id)},this}]),angular.module("commons").service("PaginationService",["Config","$state","UserDataProxyService",function(i,o,n){var r=this;this.loading=!1,this.size=20,this.isInitialLoading=!0,this.hasNext=!1,this.cursor=null,this.items=[],this.totalCount=0,this.distinctCount=null,this.search=null,this.searchChanged=!1,this.type=null,this.sharingId=null,this.sort=null,this.sortChanged=!1,this.allowedSortDirections=["ASC","DESC"],this.paginate=function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return!r.loading&&(r.isInitialLoading||r.hasNext||r.sortChanged)?(e=r.getPayload(),r.loading=!0,n.paginate(e,t).then(function(e){var t=e.nodes,n=e.pageInfo;r.isInitialLoading||r.searchChanged||r.sortChanged?r.getTotals().then(function(){r.setCursor(t,n)}):r.setCursor(t,n)}).catch(function(){r.isInitialLoading=!1,r.loading=!1})):Promise.resolve()},this.setCursor=function(e,t){r.isInitialLoading=!1,r.hasNext=t.hasNextPage,!(r.loading=!1)===r.sortChanged?r.items=e:e.forEach(function(e){r.items.push(e)}),r.cursor=t.endCursor,r.searchChanged=!1,r.sortChanged=!1},this.getTotals=function(){var e={first:1,appId:i.get("appId")};return r.search&&(e.search=r.search),r.sharingId&&(e.sharingId=r.sharingId),n.paginate(e).then(function(e){var t=e.totalCount,e=e.distinctCount;r.totalCount=t,r.distinctCount=e})},this.getPayload=function(){var e={first:r.size,appId:i.get("appId")},t=(r.cursor&&(e.after=r.cursor),r.sharingId&&(e.sharingId=r.sharingId),r.getTypes()),n=t.type,o=t.mustInclude,t=t.mustNotInclude;return n&&(e.type=n),o.length&&(e.mustIncludeFields=o),t.length&&(e.mustNotIncludeFields=t),r.search&&(e.search=r.search),r.sort&&(e.sort=r.sort),e},this.reset=function(){r.loading=!1,r.isInitialLoading=!0,r.hasNext=!1,r.cursor=null,r.items=[]},this.setType=function(e){r.reset(),r.type=e},this.setSearch=function(e){r.reset(),r.search=e,r.searchChanged=!0},this.setSharingId=function(e){r.sharingId=e},this.setSort=function(e,t){if(r.sort=null,r.sortChanged=!0,r.cursor=null,!r.allowedSortDirections.includes(t))throw new Error("Invalid sort direction '"+t+"'. Allowed values are '"+r.allowedSortDirections.join(", ")+"'");r.sort||(r.sort={}),r.sort.field=e,r.sort.direction=t},this.getTypes=function(){var e=null,t=[],n=[];if(r.type)switch(r.type){case"note":e="ANNOTATION",t.push("noteText");break;case"highlight":e="ANNOTATION",n.push("noteText");break;case"bookmark":e="BOOKMARK";break;case"all":e=null}else switch(o.current.name){case"reader.userinput.notes":e="ANNOTATION",t.push("noteText");break;case"reader.userinput.highlights":n.push("noteText"),e="ANNOTATION";break;case"reader.userinput.bookmarks":e="BOOKMARK"}return{type:e,mustInclude:t,mustNotInclude:n}},this.getAutofixItems=function(){if(r.items.length<=r.size)return r.items;for(var e=r.cursor.length%r.size,t=[],n=r.items.length-e-1;n<r.items.length;n++)t.push(r.items[n]);return t},this.hasNotesOrHighlights=function(){return!!r.items&&r.items.some(function(e){return"note"===e.type||"highlight"===e.type})}}]),angular.module("commons").service("PrintService",["SessionService",function(o){return this.getPrintTemplateUrl=function(e,t){var n="v1/reader/print/"+e.app_id+"/"+e.project_id+"/"+e.book_content_id+"/"+e.book_version+"/"+e.fromPageId+"/to/"+e.toPageId+"?aptoken="+o.getToken();return t&&Object.keys(t).forEach(function(e){t[e]&&(n+="&"+e+"="+encodeURIComponent(t[e]))}),n},this}]),angular.module("commons").service("ReadSpeakerService",["$location","$rootScope","Library",function(i,n,r){var o=this;this.voiceLang=null,this.displayMainPlay=function(e){n.ReadAloud.displayPlay=e},this.resetState=function(){n.ReadAloud={toolbar:null,main:null}},this.setState=function(e,t){n.ReadAloud={toolbar:e,main:t}},this.readSpeakerConf=function(e,t){var t=r.getBookByContentId(t),n=t.isPDF()?"#ffffff00":"#000000",t=t.isPDF()?"#2196f3":"#add8ff",o=document.createElement("script"),n=(o.type="text/javascript","\n            window.rsConf = {\n                general: {\n                    usePost: true,\n                },\n                ui: {\n                    displayDownload: false,\n                    tools: {\n                        voicesettings: true\n                    }\n                },\n                settings: {\n                    hlicon: 'iconoff',\n                    hlspeed: 100,\n                    hltext: '"+n+"',\n                    hlsent: '#ffffff00',\n                    hlword: '"+t+"'\n                },\n                cb: {\n                    ui: {\n                        timeupdated: function (time, total) {\n                            var convertTime = function (time) {\n                                var splitedTime = time.split(':')\n                                var hour = Number(splitedTime[0])\n                                var minutes = Number(splitedTime[1])\n                                var seconds = Number(splitedTime[2])\n                                return (hour * 60 * 60) + (minutes * 60) + seconds\n                            }\n                            parent.postMessage({\n                                type:\"timeupdated\",\n                                params: {\n                                    percentage: convertTime(time) / convertTime(total) * 100\n                                }\n                            }, '*')\n                        },\n                        open: function () {\n                            console.log('hi');\n                        },\n                        play: function () {\n                            console.log('play');\n                        },\n                        pause: function () {\n                            console.log('pause');\n                        },\n                        stop: function () {\n                            parent.postMessage({\n                                type:\"stop\",\n                                params: {}\n                            }, '*')\n                            console.log('stop');\n                        }\n                    }\n                }\n            }");o.appendChild(document.createTextNode(n)),e.appendChild(o)},this.getSpeed=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            ReadSpeaker.q(function() {\n                parent.postMessage({\n                    type: \"spechSpeed\",\n                    params: {\n                        spechSpeed: rspkr.st.get('hlspeed')\n                    }\n                }, '*')\n            });\n        ")),e.appendChild(t)},this.getLanguages=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            rspkr.tools.load()\n            ReadSpeaker.q(function() {\n                parent.postMessage({\n                    type: \"langs\",\n                    params: {\n                        langs: rspkr.cfg.item('general.readingLangs')\n                    }\n                }, '*')\n            });\n        ")),e.appendChild(t)},this.readSpeakerCss=function(e){var t=document.createElement("style");t.type="text/css",t.rel="stylesheet";t.appendChild(document.createTextNode("\n            div#readspeaker_button1 {\n                display: none !important;\n            },\n            .sync_sent, .sync_word, .sync_word_highlighted, .sync_sent_highlighted {\n                font-size:inherit !important;\n                font-family:inherit !important;\n                color: inherit !important;\n            }\n        ")),e.appendChild(t)},this.readSpeakerEvents=function(e){var t=document.createElement("script");t.type="text/javascript";t.appendChild(document.createTextNode("\n            function createNewEvent(eventName) {\n                var event;\n                if (typeof Event === 'function') {\n                    event = new Event(eventName);\n                } else {\n                    event = document.createEvent('Event');\n                    event.initEvent(eventName, true, true);\n                }\n                return event;\n            }\n\n            window.addEventListener(\"message\", function receiveMessage(event)\n            {\n                if (event && event.data) {\n                    if (event.data.type === 'play') {\n                        readpage();\n                    }\n                    if (rspkr) {\n                        if (event.data.type === 'pause-play') {\n                            rspkr.ui.getActivePlayer().play();\n                        }\n                        else if (event.data.type === 'pause'){\n                            rspkr.ui.getActivePlayer().pause();\n                        }\n                        else if (event.data.type === 'stop') {\n                            rspkr.ui.getActivePlayer().stop()\n                        }\n                        else if (event.data.type === 'close'){\n                            rspkr.ui.getActivePlayer().close();\n                        }\n\n                        if (event.data.type === 'skipBackwards') {\n                            rspkr.ui.getActivePlayer().rewind(5);\n                        }\n\n                        if (event.data.type === 'skipForwards') {\n                            rspkr.ui.getActivePlayer().forward(5);\n                        }\n\n                        if (event.data.type === 'changeSpeed') {\n                            rspkr.st.set('hlspeed', Number(event.data.params.speed))\n                        }\n\n                        if (event.data.type === 'changeLang') {\n                            rspkr.ui.Tools.VoiceSettings.switchLang(event.data.params.language.lang, event.data.params.language.name)\n                        }\n                    }\n                }\n            }, false);\n\n        ")),e.appendChild(t)},this.addReadSpeakerScript=function(e,t){var n=document.createElement("script");n.type="text/javascript",n.src="https://cdn1.readspeaker.com/script/"+t+"/webReader/beta/ReadSpeaker.js?pids=wr",e.appendChild(n),n.onload=function(){o.getLanguages(e),o.getSpeed(e)}},this.addReadSpeakerButton=function(e,t,n){var o=document.createElement("div"),n=(o.id="readspeaker_button1",o.className="rs_skip rsbtn rs_preserve",'\n            <a\n                class="rsbtn_play"\n                accesskey="L"\n                title="Read the page"\n                href="//app-na.readspeaker.com/cgi-bin/rsent?customerid='+n+"&amp;lang=en_us&amp;readclass="+(t.document.getElementsByClassName("textLayer").length?"textLayer":t.document.body.firstElementChild.className)+"&amp;url="+encodeURIComponent(i.absUrl())+'"\n            >\n                <span class="rsbtn_left rsimg rspart">\n                    <span class="rsbtn_text">\n                        <span>Listen</span>\n                    </span>\n                </span>\n                <span class="rsbtn_right rsimg rsplay rspart"></span>\n            </a>\n        ');o.innerHTML=n,e.appendChild(o)}}]),angular.module("commons").service("SearchService",["API","StatisticsService","Library",function(s,c,u){function n(e,t){if(!e)return!1;try{e=decodeURI(e)}catch(e){console.warn("Maintenance: malformed URI sequence",e)}return e.toLowerCase().split(/\s\s+/g).join(" ").includes(t.toLowerCase())}function r(e,t){for(var n=null,o=0;o<e.length;o++){var i=e[o];if(i.logicalPageNumber==t&&(n=i),n=i.content?r(i.content,t):n)break}return n}function a(e,t){var n;return e.structure.version?e.hasPageBreak?(n=e.countPages.find(function(e){return e.num===t}))?e.navigationPages.find(function(e){return e.id===n.pageId}):null:e.navigationPages.find(function(e){return e.num===t}):e.getPage(e.uniquePages[t-1])}function l(e,t){return e.getPage(e.uniquePages[t-1])}var d=this;this.results=[],this.query="",this.isLoading=!1,this.annotationsLength=0,this.searchedPage=null,this.getSearchQuery=function(){return this.query},this.setSearchQuery=function(e){this.query=e},this.search=function(e,t,n,o){var i,r,a=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{};if(d.query=n,d.query&&d.query.length)return-1===(r=(i=u.getBookByContentId(e)).getIndexOfPage(o))&&(r=0),d.isLoading=!0,c.searchEvent({pageId:o,bookId:i.project_id||i.id,bookISBN:i.isbn,pageIndex:r,value:n}),s.hapi.post("/v1/search/"+e+"/"+t,{query:d.query},a).then(function(e){d.isLoading=!1,d.results=e.data}).catch(function(e){console.log(e),d.isLoading=!1,d.results=[]})},this.markSearch=function(e,t){if(!e||!t)return"";try{e=decodeURI(e)}catch(e){console.warn("Maintenance: malformed URI sequence",e)}e=e.split(/\s\s+/g).join(" "),t=t.replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g"),"\\$&");t=RegExp("("+t+")","gi");return e=e.replace(t,"<mark>$1</mark>")},this.searchLocalAnnotations=function(e,t){return e&&e.length&&t?(e=e.filter(function(e){return n(e.options.selectedText,t)||n(e.pageTitle,t)&&"bookmark"===e.type||n(e.options.noteText,t)}),d.annotationsLength=e.length,e):[]};return this.searchBookPage=function(e,t){var n,o,i;e&&t&&!e.isEpubReflowWithoutPageBreak()&&(e.isPDF()&&(d.searchedPage=(o=t,(i=(n=e).structure.content)[0]&&i[0].logicalPageNumber&&r(i,o)||n.getPage(n.uniquePages[o-1]))),e.isEpubFixed()&&(d.searchedPage=a(e,t)),e.isEpubReflow()&&(d.searchedPage=a(e,t)),e.isNativeGtContent()&&(d.searchedPage=l(e,t)),e.isMefZip())&&(d.searchedPage=l(e,t))},this.clearSearch=function(){d.annotationsLength=0,d.clearContentResults(),d.query="",d.isLoading=!1,d.searchedPage=null},this.clearContentResults=function(){d.results=[]},this.numberOfResults=function(){return d.results.reduce(function(e,t){return e+t.totalOccurrences},0)},this.truncate=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:120;return(e=e.toString()).length<=t?e:e.slice(0,t)+"..."},this}]),angular.module("commons").service("SessionService",["$q","LocalStorage","ModuleService","TokenType",function(t,n,e,o){var i=this;switch(this.user=null,this.userCriticalToken=null,this.readerMode="UNAUTHORIZED",this.setUserCriticalToken=function(e){i.userCriticalToken=e},this.getUserCriticalToken=function(){return i.userCriticalToken},this.getTokenType=function(){return n.get("tokenType")},this.setApToken=function(e){i.readerMode="EDIT",n.remove("refreshToken"),n.set("token",e),n.set("tokenType",o.AP)},this.getToken=function(){return n.get("token")},this.setMEFToken=function(e,t){i.readerMode="PREVIEW",n.remove("refreshToken"),n.set("token",e),n.set("tokenType",o.MEF),n.set("workspaceId",t)},this.getFCMToken=function(){return n.get("fcmtoken")},this.setFCMToken=function(e){n.set("fcmtoken",e)},this.setAccessToken=function(e){i.readerMode="EDIT",n.set("token",e),n.set("tokenType",o.DBN_JWT)},this.getRefreshToken=function(){return n.get("refreshToken")},this.setRefreshToken=function(e){n.set("refreshToken",e)},this.isLogged=function(){var e=t.defer();return n.get("token")?e.resolve():e.reject(),e.promise},this.isJwtTokenSession=function(){return this.getTokenType()===o.DBN_JWT},this.logOut=function(){n.remove("token"),n.remove("refreshToken"),n.remove("tokenType"),n.remove("contentsInfos"),n.remove("sync"),n.remove("preferences"),n.remove("last-item"),n.remove("hide-banner"),window.location.href=window.location.origin},this.setUserId=function(e){n.set("userId",e);e=new CustomEvent("userIdUpdated",{detail:e});window.dispatchEvent(e)},this.getUserId=function(){return n.get("userId")},this.setUser=function(e){n.set("user",e)},this.setSingleModeConfig=function(e){n.set("singleModeConfig",e)},this.getSingleModeConfig=function(){return n.get("singleModeConfig")},this.setDisplayMobileWarning=function(e){n.set("displayMobileWarning",e)},this.getDisplayMobileWarning=function(){return n.get("displayMobileWarning")},this.getUser=function(){return this.user},this.setLMS=function(e){n.set("isFromLMS",e)},this.getLMS=function(){return n.get("isFromLMS",!1)},this.goToShelf=function(){return!e.hasModule("shelf")&&e.hasModule("assignments")?"app.assignments.all":"app.library.all"},this.setReaderMode=function(e){i.readerMode=e},this.setStorageLimitWarning=function(e){n.set("displayStorageLimit",e)},this.getStorageLimitWarning=function(){return n.get("displayStorageLimit")},this.mobileCheck=function(){var e,t;return!(i.user&&i.user.thirdparties&&i.user.thirdparties.cengage&&!1===i.user.thirdparties.cengage.mobileDownload)&&(e=navigator.userAgent.match("iPad")||navigator.userAgent.match("iPhone")||navigator.userAgent.match("iPod"),t=navigator.userAgent.match("Android"),e||t)},this.isChapterPreview=function(){return Boolean(i.user&&(i.user.thirdparties&&i.user.thirdparties.cengage&&i.user.thirdparties.cengage.preview||i.user.options&&i.user.options.is_preview))},this.chapterPreviewAllowedPages=function(){return i.user&&i.user.thirdparties&&i.user.thirdparties.cengage&&i.user.thirdparties.cengage.pages||[]},this.getBookLocation=function(){var e={reference:{type:null,value:null},pageId:null},t=i.user.thirdparties.cengage||i.user.thirdparties.pivotPoint;return t&&(e.reference.type=t.referenceType,e.reference.value=t.isbn,t.pageId)&&(e.pageId=t.pageId),e},this.getTokenType()){case o.MEF:this.readerMode="PREVIEW";break;case o.AP:case o.DBN_JWT:this.readerMode="EDIT";break;default:this.readerMode="UNAUTHORIZED"}this.setUserPreviewPages=function(e){var t=i.user.thirdparties.cengage;t&&(t.pages=e)}}]),angular.module("commons").service("SettingService",function(){return this.data={accessibility:{fontSize:20,font:""},fonts:[],"font-sizes":[],contrasts:[]},this.data}),_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").service("StatisticsService",["$q","DbnApi","SessionService","Config","StatisticsEvent",function(s,n,c,t,u){function e(){_classCallCheck(this,e),this.eventDisableModes=["UNAUTHORIZED","PREVIEW"]}return _createClass(e,[{key:"_disabled",value:function(){return!t.get("statistics").enabled||!t.hasFeature("trackEvents")||this.eventDisableModes.includes(c.readerMode)}},{key:"_getContext",value:function(e){return{distributionChannelId:t.get("appId"),projectId:e}}},{key:"trackEvent",value:function(e){var t;return this._disabled()?s.resolve(null):(t=e.toObject(),n.sendTrackedEvent([t]).then(function(){return e}).catch(function(e){return console.error("Statistics error: tracking event error",e),s.reject(e)}))}},{key:"startPageViewed",value:function(e){var t,n=e.pageId,o=e.bookId,i=e.assignment,e=e.additionalInfo;return this._disabled()?s.resolve(null):(t=c.getUser(),(o=this._getContext(o,i)).pageId=n,e&&(o.pageIndex=e.page_index,o.externalProjectId=e.eISBN),i=new u({type:"VIEWED",result:{},object:{},context:o,user:t,startTime:(new Date).toISOString()}),this.trackEvent(i))}},{key:"endPageViewed",value:function(e){return this._disabled()?s.resolve(null):(e.end(),this.trackEvent(e))}},{key:"exerciseGraded",value:function(e){var t,n=e.pageId,o=e.bookId,e=e.assignment;return this._disabled()?s.resolve(null):(t=c.getUser(),(o=this._getContext(o,e)).pageId=n,e=new u({type:"GRADED",object:{},context:o,user:t}),this.trackEvent(e))}},{key:"loginEvent",value:function(){var e,t;return this._disabled()?s.resolve(null):(e=c.getUser(),t=this._getContext(),t=new u({type:"LOGIN",object:{},context:t,user:e}),this.trackEvent(t))}},{key:"loginSSOEvent",value:function(e,t){var n,o;return this._disabled()?s.resolve(null):(n=c.getUser(),o=this._getContext(),t&&(o.externalProjectId=t),t=new u({type:"LAUNCH",object:{},context:o,user:n}),this.trackEvent(t))}},{key:"userInputsEvent",value:function(e){var t,n=e.type,o=e.action,i=e.pageId,r=e.bookId,a=e.bookISBN,e=e.pageIndex;return this._disabled()?s.resolve(null):(t=c.getUser(),i={type:n,id:(r=this._getContext(r)).pageId=i,value:o},a&&(r.externalProjectId=a,r.pageIndex=e),o=new u({type:n.toUpperCase(),object:i,context:r,user:t}),this.trackEvent(o))}},{key:"searchEvent",value:function(e){var t,n=e.pageId,o=e.bookId,i=e.bookISBN,r=e.pageIndex,e=e.value;return this._disabled()?s.resolve(null):(t=c.getUser(),(o=this._getContext(o)).pageId=n,n={type:"search_term",value:e},i&&(o.externalProjectId=i,o.pageIndex=r),e=new u({type:"SEARCH",object:n,context:o,user:t}),this.trackEvent(e))}},{key:"readAloudEvent",value:function(e){var t=e.pageId,n=e.bookId,o=e.bookISBN,i=e.pageIndex,e=e.value;if(this._disabled())return s.resolve(null);var r=c.getUser(),n=this._getContext(n),t=(n.pageId=t,{type:"action",value:e}),a=(o&&(n.externalProjectId=o,n.pageIndex=i),new u({type:"LISTEN",object:t,context:n,user:r}));switch(t.value){case"stop":case"close":return;default:return this.trackEvent(a)}}},{key:"printEvent",value:function(e){var t,n=e.pageId,o=e.bookId,i=e.bookISBN,e=e.value;return this._disabled()?s.resolve(null):(t=c.getUser(),(o=this._getContext(o)).pageId=n,n={type:"total_print_pages",value:e.toString()},i&&(o.externalProjectId=i),e=new u({type:"PRINT",object:n,context:o,user:t}),this.trackEvent(e))}},{key:"printAnnotationsEvent",value:function(){}},{key:"playerEvent",value:function(e){var t,n,o=e.action,i=e.params,r=e.bookId,e=e.isbn;return this._disabled()?s.resolve(null):(t=c.getUser(),r=this._getContext(r),e&&(r.externalProjectId=e),e=i.eventCategory,n={},["mediaCGI","mediaDuration","startTimestamp","endTimestamp"].forEach(function(e){n[e]=i[e]}),e=new u({type:e.toUpperCase(),object:{type:e,value:o.replace(/[A-Z]/g,function(e){return"_"+e.toLowerCase()})},context:r,user:t,mediaParams:n}),this.trackEvent(e))}}]),new e}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},angular.module("commons").service("SyncService",["API","LocalStorage","Library","StatisticsService","Config","Entity","SessionService","Assignment","UserInputsService","PaginationService","UserDataProxyService","$q",function(e,c,r,a,u,s,l,n,o,i,d,g){var p=this;this._cache=[],this._booksCache={},this._currentDataModelVersion=2,this._syncTimestamp=Date.now(),this._push=function(e){e.forEach(function(t){var e=p._syncData.find(function(e){return e.id===t.id&&e.sharingId===t.sharingId});e?t.deleted?p._syncData=p._syncData.filter(function(e){return e.id!==t.id}):_extends(e,t):p._syncData.push(t)}),p._updateCache()},this.computeId=function(e){var t=c.get("userId"),t=u.getAppId()+t+e.id;return"hash"+s.hashCode(t)},this.computeExerciseId=function(e){var t=c.get("userId"),n=u.getAppId(),o=e.sharingId||e.path,i=e.pageId,r=e.fid,e=e.id;return"hash"+s.hashCode(n+t+o+i+r+e)},this._migrateDataModelToVersion2=function(e){var i,r=[],a=c.get("userId"),s=u.getAppId();return a&&(i=[],e.docs&&(i=e.docs.filter(function(e){return"highlight"===e.type}),e.docs.forEach(function(t){var e=void 0;switch(t.type){case"bookmark":(e=(n=t).sharingId?(o={id:n.pageId},{id:p.computeId(o),$created_at:n.userDate,$updated_at:n.userDat,userId:a,appId:s,deleted:!1,contentVersion:""+n.moduleVersion||"1",pageId:n.pageId,version:1,sharingId:n.sharingId,type:n.type,userDate:n.userDate,options:{enabled:Boolean(!n.deleted)}}):null)&&r.push(e);break;case"note":var n,o=i.findIndex(function(e){return e.id===t.highlight.$ref});-1!==o&&(n=i[o],(e=function(e,t){if(!(e.sharingId&&t&&t.serialization&&"string"==typeof t.serialization&&t.serialization.length))return null;var n=p.computeId(e),o="",i="";try{var r=JSON.parse(t.serialization),o=r.color&&r.color.length?r.color:"#FFEB6B";r.id=n,i=JSON.stringify(r)}catch(e){return null}return{id:n,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:o,selectedText:t.content,noteText:e.text,serializedData:i,highlightId:t.id}}}(t,n))&&r.push(e),i.splice(o,1));break;case"exercise":case"quizz2":(e=function(e){if(!e.sharingId)return null;var t=e.questions;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return null}t={id:p.computeExerciseId(e),$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId||null,type:"exercise",userDate:e.userDate,options:{scorePerc:e.scorePerc||e.score,scoreType:e.score_type||"percent",questions:t,currentQuestion:e.currentQuestion,submitted:Boolean(e.submitted),score:e.score,exerciseId:e.fid}};return e.nbQuestions&&(t.options.nbQuestions=e.nbQuestions),t}(t))&&r.push(e)}})),i.forEach(function(e){e=function(e){if(!e.sharingId||!e.serialization||"string"!=typeof e.serialization||!e.serialization.length)return null;var t=p.computeId(e),n="",o="";try{var i=JSON.parse(e.serialization),n=i.color&&i.color.length?i.color:"#FFEB6B";i.id=t,o=JSON.stringify(i)}catch(e){return null}return{id:t,$created_at:e.userDate,$updated_at:e.userDate,userId:a,appId:s,deleted:Boolean(e.deleted),contentVersion:""+e.moduleVersion||"1",pageId:e.pageId,version:1,sharingId:e.sharingId,type:e.type,userDate:e.userDate,options:{color:n,selectedText:e.content,serializedData:o}}}(e);e&&r.push(e)})),r},this.load=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",o=(p._cache=[],p._booksCache={},n&&e.push(n),u.getAppId());return d.getBySharingIdAndPageId(o,t,e).then(function(e){n&&p.autofixAnnotations(e,null,n),p._syncData=e,p._updateCache()}).catch(function(e){p._syncData=[],console.log(e)})},this._updateCache=function(){p._cache=p._syncData,p._booksCache={}},this.get=function(){return p._cache},this.getSyncDataByContext=function(e){var t=e.book,n=e.assignment,e=e.array;if(!n&&!r.getBookByContentId(t))throw Error("No book provided");n=p.get();return e?n:{notes:n.filter(function(e){return"note"===e.type}),highlights:n.filter(function(e){return"highlight"===e.type}),bookmarks:n.filter(function(e){return"bookmark"===e.type}),exercises:n.filter(function(e){return"exercise"===e.type})}},this._getSyncData=function(e,t){return p._booksCache[e+t]||(p._booksCache[e+t]=p.get().filter(function(e){return e.sharingId===t}))},this.getNdAnnotations=function(){return p.get().filter(function(e){if("exercise"===e.type)return!1;var t=r.getBookOrAssignmentBySharingId(e.sharingId);if(t){if(t instanceof n){if(t.book_id&&!r.getBookByBookId(t.book_id).getPage(e.pageId))return!0;if(t.module_id&&!r.getBookByBookId(t.module_id).getPage(e.pageId))return!0}else if(!t.getPage(e.pageId))return!0;return!1}})},this.updateNdAnnotationsStatus=function(t){var e;"PREVIEW"!==l.readerMode&&((e=p.getNdAnnotations()).forEach(function(e){(t||e.options.broken_status)&&(!t||"viewed"===!e.options.broken_status&&e.options.broken_status)||(e.options.broken_status=t)}),p.push(e))},this.getNotViewedAnnotation=function(){return p.getNdAnnotations().filter(function(e){return!e.options.broken_status||"viewed"!==e.options.broken_status})},this.getByPageId=function(t,n){return p._syncData.find(function(e){return e.pageId===t&&e.type===n})},this.getById=function(t){if(p._syncData&&0!==p._syncData.length)return p._syncData.find(function(e){return e.id===t})},this.getPaginatedById=function(t){if(u.hasUsersDataMigratedToDbn()){if(i.items)return i.items.find(function(e){return e.id===t})}else if(o.paginatedData)return o.paginatedData.find(function(e){return e.id===t})},this.getExercise=function(t,n){return p._syncData.find(function(e){return"exercise"===e.type&&e.options.exerciseId===t&&e.sharingId===n})},this.delete=function(e){var t=p.getById(e);return(t=t||p.getPaginatedById(e))?("bookmark"===t.type?t.options.enabled=!1:t.deleted=!0,p.push([t])):g.resolve()},this.deleteExercise=function(e,t){e=p.getExercise(e,t);if(e)return e.deleted=!0,p.prepareExerciseForSync(e),p.push([e])},this.push=function(t){var e;if(t&&t.length&&0<t.length)return e=Date.now(),p._syncTimestamp&&(e=p._syncTimestamp),e={appId:u.getAppId(),syncTimestamp:e,userInputs:t},d.sync(e).then(function(e){return p._syncData||(p._syncData=[]),p._syncTimestamp=e.syncTimestamp,p.sendUserInputEvent(e.userInputs.filter(function(e){return t.map(function(e){return e.id}).includes(e.id)})),p._push(e.userInputs),e}).catch(function(){return null})},this.sendUserInputEvent=function(e){e.forEach(function(e){var t,n,o,i;["highlight","bookmark","note"].includes(e.type)&&(t=p.getById(e.id),n="create",i=(o=r.getBookOrAssignmentBySharingId(e.sharingId)).getIndexOfPage(e.pageId),t&&e.deleted&&(n="delete"),t&&!e.deleted&&(n="update"),a.userInputsEvent({type:e.type,action:n,pageId:e.pageId,bookId:o.id,bookISBN:o.isbn,pageIndex:i}))})},this.getByBookId=function(t){return p.allUserInputs.filter(function(e){return e.sharingId===t&&!e.deleted})},this.toggleBookmark=function(e){var t,n,o,i;if("PREVIEW"!==l.readerMode)return t=u.getAppId(),n=c.get("userId"),(i=p.getByPageId(e.pageId,"bookmark"))?i.options.enabled=!i.options.enabled:(o={id:e.pageId},i=_extends(e,{id:p.computeId(o),type:"bookmark",appId:t,userId:n,deleted:!1,pageId:e.pageId,pageTitle:e.pageTitle,pageIndex:e.pageIndex,contentVersion:e.contentVersion,userDate:Date.now(),version:p._currentDataModelVersion,options:{enabled:!0}})),e.sharingId&&(i.sharingId=e.sharingId),p.push([i])},this.isBookmarked=function(t,n,o){if("PREVIEW"!==l.readerMode&&o)return p.getAnnotations("bookmark").find(function(e){return(e.pageId===t||e.pageId===o.path)&&e.sharingId===n&&r.getBookOrAssignmentBySharingId(e.sharingId)&&!0===e.options.enabled})},this.addHighlight=function(e,t){var n,o,i;if("PREVIEW"!==l.readerMode)return n=Date.now(),o=u.getAppId(),i=c.get("userId"),o={id:e.id,appId:o,userId:i,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,contentVersion:e.contentVersion,type:"highlight",userDate:n,version:p._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e)}},(i=p.getById(e.id))&&(o.$created_at=i.$created_at),e.sharingId&&(o.sharingId=e.sharingId),p.push([o])},this.getAnnotations=function(t){return p.get().filter(function(e){return e.type===t})},this.addNote=function(e,t,n){var o,i,r;if("PREVIEW"!==l.readerMode)return r=Date.now(),o=u.getAppId(),i=c.get("userId"),o={id:e.id,appId:o,userId:i,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,type:"note",contentVersion:e.contentVersion,userDate:r,version:p._currentDataModelVersion,options:{color:e.color,selectedText:e.text,serializedData:JSON.stringify(e),noteText:n}},(i=p.getById(e.id))&&(o.$created_at=i.$created_at),e.sharingId&&(o.sharingId=e.sharingId),!0!==e.noteFromHighlight||e.id.contains("-fromhighlight")?p.push([o]):((t=_extends({},o)).deleted=!0,delete t.options,delete t.type,(r=_extends({},e)).id=e.id+"-fromhighlight",o.id=r.id,o.options.highlightId=e.id,o.options.serializedData=JSON.stringify(r),p.push([t,o]))},this.addExercise=function(e,t){var n,o,i,r;if("PREVIEW"!==l.readerMode)return n=u.getAppId(),o=c.get("userId"),(r=e.id)||(i={sharingId:e.sharingId,pageId:t,id:e.fid,fid:e.fid},r=p.computeExerciseId(i)),i={id:r,userId:o,appId:n,deleted:!1,pageId:t,pageTitle:e.pageTitle,pageIndex:e.pageIndex,type:"exercise",contentVersion:e.contentVersion,userDate:Date.now(),version:p._currentDataModelVersion,options:{questions:"string"==typeof e.questions?e.questions:JSON.stringify(e.questions),currentQuestion:e.currentQuestion,nbQuestions:e.nbQuestions,submitted:e.submitted,score_type:e.score_type,score:e.score,scorePerc:e.scorePerc,exerciseId:e.fid}},(r=p.getById(e.id))&&(i.$created_at=r.$created_at),e.sharingId&&(i.sharingId=e.sharingId),p.prepareExerciseForSync(i),p.push([i])},this.prepareExerciseForInjection=function(e){"string"==typeof e.options.questions?e.questions=JSON.parse(e.options.questions):e.questions=e.options.questions,e.currentQuestion=e.options.currentQuestion,e.nbQuestions=e.options.nbQuestions,e.submitted=e.options.submitted,e.score_type=e.options.score_type,e.score=e.options.score,e.scorePerc=e.options.scorePerc},this.prepareExerciseForSync=function(e){e.questions&&delete e.questions,!e.currentQuestion&&0!==e.currentQuestion||delete e.currentQuestion,!e.nbQuestions&&0!==e.nbQuestions||delete e.nbQuestions,!e.submitted&&!1!==e.submitted||delete e.submitted,e.score_type&&delete e.score_type,!e.score&&0!==e.score||delete e.score,!e.scorePerc&&0!==e.scorePerc||delete e.scorePerc},this.autofixAnnotations=function(e,n,o){var i=[];e.forEach(function(e){var t;if(n&&(t=n.getPageFromContent(e.pageId),o=(t||(t=n.getPage(e.pageId),n.getPageFromContent(t.pageId))).path),e.pageId!==o)switch(e.type){case"note":case"highlight":case"bookmark":e.pageId=o,e.userDate=Date.now(),i.push(e)}}),p.push(i)}}]),angular.module("commons").service("TocService",function(){this.scrollOnPage=function(t){setTimeout(function(){var e=document.getElementById(t);e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},100)}}),angular.module("commons").service("ToolsService",function(){this.calcDiffTime=function(e,t){var n;return e.getTime()<t.getTime()?{}:(n=86400,e=Math.abs(e-t)/1e3,e-=(t=1<=e/n&&.5<=e/n%1?Math.ceil(e/n):Math.floor(e/n))*n,n=Math.ceil(e/3600)%24,0<t?{time:t,type:"days"}:0===t&&0==n?{time:1,type:"days"}:{time:n,type:"hours"})}}),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},angular.module("commons").service("UserDataConversionService",function(){var r=this;this.getUserInputsLike=function(e){return e.map(function(e){var t=!!e.deletedAt,n=r.getUserInputType(e),o=t,i={};return"highlight"===n||"note"===n?(i.color=e.color,i.selectedText=e.selectedText,i.serializedData=e.serializedData,"note"===n&&(i.noteText=e.noteText)):"bookmark"===n?(i.enabled=!t,o=!1):"exercise"===n&&(i.score=e.score,i.questions=e.questions,i.currentQuestion=e.currentQuestion,i.submitted=e.submitted,"PERCENT"===e.scoreType?i.scoreType="percent":i.scoreType="value",i.scorePerc=e.scorePercentage,i.nbQuestions=e.nbQuestions,i.attemptsRemaining=e.attemptsRemaining,i.difficulty=e.difficulty,i.annotationId=e.annotationId,i.exerciseId=e.exerciseId),e.brokenStatus&&(i.broken_status=e.brokenStatus),{$created_at:new Date(e.createdAt).getTime(),$updated_at:new Date(e.updatedAt).getTime(),appId:e.distributionChannelId,cfi:e.cfi,contentVersion:e.bookVersion.toString(),deleted:o,highlighter:e.highlighter,id:e.id,options:i,pageId:e.pageId,pageIndex:e.pageNumber,pageTitle:e.pageTitle,pageNumberRef:e.pageNumberRef,sharingId:e.projectId,type:n,userDate:new Date(e.updatedByUserAt).getTime(),userId:e.userId,version:2}})},this.getUserInputType=function(e){var t=null;switch(e.__typename){case"UserAnnotation":t=e.noteText?"note":"highlight";break;case"UserExerciseAnswer":t="exercise";break;case"UserBookmark":t="bookmark";break;default:throw new Error("Unknown type from UDS : "+e.__typename)}return t},this.getUserDataLike=function(e){var n=[],o={annotations:[],bookmarks:[],excerciseAnswers:[]};return e.forEach(function(e){if(!e.deleted&&("bookmark"!==e.type||e.options&&e.options.enabled)){var t=r.legacyToDbnUserData(e);switch(e.type){case"bookmark":o.bookmarks.push(t);break;case"exercise":o.excerciseAnswers.push(t)}}else n.push(e.id),"bookmark"===e.type?e.options.enabled=!1:e.deleted=!0}),{remove:n,upsert:o}},this.legacyToDbnUserData=function(e){var t,n={id:e.id,distributionChannelId:e.appId,updatedByUserAt:e.userDate&&new Date(e.userDate),projectId:e.sharingId,bookVersion:parseInt(e.contentVersion),pageId:e.pageId,pageNumber:e.pageIndex,pageTitle:e.pageTitle,highlighter:e.highlighter,cfi:e.cfi};return e.options&&(t=void 0,"highlight"!==e.type&&"note"!==e.type||((t=JSON.parse(e.options.serializedData)).color=e.options.color,t.isNote=!!e.options.noteText),n=_extends(n,{brokenStatus:e.options.broken_status,color:e.options.color,selectedText:e.options.selectedText,noteText:e.options.noteText,serializedData:JSON.stringify(t),score:e.options.score,questions:e.options.questions&&("string"==typeof e.options.questions?e.options.questions:JSON.stringify(e.options.questions)),currentQuestion:e.options.currentQuestion,submitted:e.options.submitted,scoreType:(e.options.scoreType||e.options.score_type)&&("normal"===e.options.scoreType||"normal"===e.options.score_type?"VALUE":"PERCENT"),scorePercentage:e.options.scorePerc,nbQuestions:e.options.nbQuestions,attemptsRemaining:e.options.attemptsRemaining,difficulty:e.options.difficulty,annotationId:e.options.annotationId,exerciseId:e.options.exerciseId})),n},this.getHapiContentsInfosLike=function(e){return e.map(function(e){var t,n={favorite:!1};return 1==e.favorite&&(n.favorite=!0),e.accessibility&&Object.keys(e.accessibility).length&&(t={},e.accessibility.contrastName&&(t.contrastName=e.accessibility.contrastName),e.accessibility.fontName&&(t.fontName=e.accessibility.fontName),e.accessibility.volume&&(t.soundPower=e.accessibility.volume),e.accessibility.speechRate&&(t.speechRate=e.accessibility.speechRate),e.accessibility.altMediaEnabled&&(t.altMediaEnabled=e.accessibility.altMediaEnabled),n.accessibility=t),e.lastOpenPage&&Object.keys(e.lastOpenPage).length&&(t={},e.lastOpenPage.date&&(t.date=new Date(e.lastOpenPage.date).getTime()),e.lastOpenPage.pageId&&(t.pageId=e.lastOpenPage.pageId),e.lastOpenPage.pageTitle&&(t.pageTitle=e.lastOpenPage.pageTitle),n.lastOpen=t),{$created_at:new Date(e.createdAt).getTime(),$updated_at:new Date(e.updatedAt).getTime(),appId:e.distributionChannelId,deleted:!1,id:e.id,options:n,sharingId:e.projectId,userId:e.userId,version:1}})},this.getDbnContentsInfosLike=function(e){return e.map(function(e){var t,n={projectId:e.sharingId,distributionChannelId:e.appId,id:e.id,favorite:e.options.favorite||null,lastOpenPage:null,accessibility:null};return e.options.lastOpen&&(t={},e.options.lastOpen.date&&(t.date=new Date(e.options.lastOpen.date)),e.options.lastOpen.pageId&&(t.pageId=e.options.lastOpen.pageId),e.options.lastOpen.pageTitle&&(t.pageTitle=e.options.lastOpen.pageTitle),n.lastOpenPage=t),e.options.accessibility&&(n.accessibility={contrastName:e.options.accessibility.contrastName||null,fontName:e.options.accessibility.fontName||null,volume:e.options.accessibility.soundPower||null,speechRate:e.options.accessibility.speechRate||null,altMediaEnabled:e.options.accessibility.altMediaEnabled||null}),n})},this.getHapiPreferencesLike=function(e){return e.map(function(e){return{id:e.id,userId:e.userId,appId:e.distributionChannelId,version:1,key:r.dbnUsersPreferencesKeyToLegacyUsersPreferencesKey(e.key),value:e.value,$created_at:new Date(e.createdAt).getTime(),$updated_at:new Date(e.updatedAt).getTime()}})},this.getDbnPreferenceLike=function(e){var t=r.legacyUsersPreferencesKeyToDbnUsersPreferencesKey(e.key);return[{id:e.id,distributionChannelId:e.appId,key:t,value:e.value}]},this.dbnUsersPreferencesKeyToLegacyUsersPreferencesKey=function(e){switch(e){case"DESK_ASSIGNMENT_SORTER":return"deskAssignmentSorter";case"DESK_BOOK_SORTER":return"deskBookSorter";case"DESK_STORE_SORTER":return"deskStoreSorter";case"USER_LANGUAGE":return"language"}},this.legacyUsersPreferencesKeyToDbnUsersPreferencesKey=function(e){switch(e){case"deskAssignmentSorter":return"DESK_ASSIGNMENT_SORTER";case"deskBookSorter":return"DESK_BOOK_SORTER";case"deskStoreSorter":return"DESK_STORE_SORTER";case"language":return"USER_LANGUAGE"}},this.annotationToRangy=function(e){var t=JSON.parse(e.options.serializedData);return t.characterRange?JSON.stringify({characterRange:t.characterRange,backward:t.backward,id:e.id,text:e.options.selectedText,isNote:"note"===e.type,location:t.location,style:t.style,color:e.options.color,sharingId:e.sharingId,contentVersion:e.contentVersion,pageTitle:e.pageTitle,pageIndex:e.pageIndex}):null},this.annotationToSchwepsy=function(e){return{cfi:e.cfi,id:e.id,text:e.options.selectedText,isNote:!!e.options.noteText,color:e.options.color,sharingId:e.sharingId,contentVersion:e.contentVersion,pageTitle:e.pageTitle,pageIndex:e.pageIndex}},this.highlighterToAnnotation=function(e,t,n,o,i,r){var a={characterRange:e.characterRange||{start:0,end:0},backward:e.backward||!1,location:e.location,color:e.color,isNote:e.isNote,text:e.text,id:e.id};return{id:e.id,options:{serializedData:JSON.stringify(a),selectedText:e.text,color:e.color,noteText:i},type:e.isNote?"note":"highlight",sharingId:e.sharingId,contentVersion:e.contentVersion,pageTitle:e.pageTitle,pageIndex:e.pageIndex,highlighter:{name:r?"schwepsy":"gt-rangy",version:"1"},brokenStatus:null,cfi:e.cfi,pageId:o,userId:n,appId:t}}}),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e};function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("commons").service("UserDataProxyService",["UserDataConversionService","Config","DbnApi","API","SessionService","userDatasQuery","synchronizeUserDatasMutation","userDatasByPageIdsQuery","upsertContentInfosMutation","userContentInfosQuery","upsertPreferencesMutation","userPreferencesQuery","$filter","Entity",function(r,e,a,s,c,i,u,l,d,g,n,t,p,h){var f=this;this.directCall=function(){return e.hasUsersDataMigratedToDbn()&&c.isJwtTokenSession()},this.sync=function(e){var t,n,o;return f.directCall()?(o=e.syncTimestamp||0,n=e.userInputs||[],t=(n=r.getUserDataLike(n)).remove,n=n.upsert,o={userId:c.getUserId(),distributionChannelId:e.appId,synchronizeTime:new Date(o),upsert:n,remove:t},a.mutate(u,o).then(function(e){var e=e.data.synchronizeUserDatas,t=e.userDatas,e=e.synchronizedAt;return{version:2,syncTimestamp:new Date(e).getTime(),userInputs:r.getUserInputsLike(t)}})):s.hapi.post("/v3/reader/sync",e).then(function(e){return e.data})},this.load=function(e,t){var n;return f.directCall()?(n=t.syncTimestamp||0,n={userId:c.getUserId(),distributionChannelId:t.appId,synchronizeTime:new Date(n)},a.mutate(u,n).then(function(e){var e=e.data.synchronizeUserDatas,t=e.userDatas,e=e.synchronizedAt;return{version:2,syncTimestamp:new Date(e).getTime(),userInputs:r.getUserInputsLike(t)}})):(n="",t&&(n="&syncTimestamp="+t.syncTimestamp),s.hapi.get("/v3/reader/sync?appId="+e+n).then(function(e){return e.data}))},this.paginate=function(e){var t,n,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return f.directCall()?(n=p("copyObject")(e,null,["sharingId","appId"]),t={projectId:e.sharingId,distributionChannelId:e.appId,userId:c.getUserId()},n=_extends(n,t),a.query(i,n,o).then(function(e){e=e.data.userDatas;return e.nodes=r.getUserInputsLike(e.nodes),e})):s.hapi.post("/ap/usersInputs/paginate",e,o).then(function(e){return e.data})},this.offsetPaginate=function(e){return s.hapi.post("/ap/usersInputs/advanced",e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).then(function(e){return e.data})},this.getBySharingIdAndPageId=function(e,t,n){var o;return f.directCall()?(o={userId:c.getUserId(),distributionChannelId:e,projectId:t,pageIds:n},a.query(l,o).then(function(e){e=e.data.userDatasByPageIds;return r.getUserInputsLike(e)})):s.hapi.post("/ap/usersInputs/appId/"+e+"/sharingId/"+t,{pageIds:n}).then(function(e){return e.data})},this.syncContentsInfos=function(e){var t,n,o,i;return f.directCall()?(t=e.syncTimestamp||0,n=e.userContentsInfos||[],n=r.getDbnContentsInfosLike(n),o=Date.now(),i={userId:c.getUserId(),contentInfos:n,clientMutationId:h.generateUUID()},(0<n.length?a.mutate(d,i).then(function(e){return e.data.upsertContentInfos.contentInfos}):a.query(g,{userId:c.getUserId(),distributionChannelId:e.appId}).then(function(e){return e.data.userContentInfos})).then(function(e){e=r.getHapiContentsInfosLike(e).filter(function(e){return e.$updated_at>t});return{version:1,syncTimestamp:o,userContentsInfos:e}})):s.hapi.post("/v1/reader/usersContentsInfos/sync",e).then(function(e){return e.data})},this.getPreferences=function(e){return f.directCall()?a.query(t,{userId:c.getUserId(),distributionChannelId:e}).then(function(e){e=e.data.userPreferences;return r.getHapiPreferencesLike(e)}):s.hapi.get("/v1/reader/usersPreferences?appId="+e).then(function(e){return e.data})},this.upsertPreferences=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"post";return f.directCall()?a.mutate(n,{userId:c.getUserId(),preferences:r.getDbnPreferenceLike(e)}).then(function(e){e=e.data.upsertPreferences.preferences;return r.getHapiPreferencesLike(e)[0]}):s.hapi[t]("/v1/reader/usersPreferences",e).then(function(e){return e.data})}}]),angular.module("commons").service("UserInputsService",["$state","UserDataProxyService",function(e,o){var u=this,l=(this.ANNOTATIONS_PER_PAGE=20,this.isLoading=!1,["note","highlight","bookmark","all"]);this.getTypeByState=function(){switch(e.current.name){case"reader.userinput.notes":return"note";case"reader.userinput.bookmarks":return"bookmark";case"reader.userinput.highlights":return"highlight";case"reader.userinput.notdisplayed":return"notdisplayed";default:return null}},this.getUserInputsForPage=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=u.generatePayload(e);return u.isLoading=!0,o.offsetPaginate(n,t).then(function(e){u.totalUserInputs={all:e.count,bookmark:e.distinctCount.bookmark,note:e.distinctCount.note,highlight:e.distinctCount.highlight},u.pagination=e.pagination,u.paginatedData=e.results,u.isLoading=!1}).catch(function(e){console.log(e),u.pagination=null,u.paginatedData=[],u.totalUserInputs={all:0,bookmark:0,note:0,highlight:0},u.isLoading=!1})},this.hasNotesOrHighlights=function(){return!!u.paginatedData&&u.paginatedData.some(function(e){return"note"===e.type||"highlight"===e.type})},this.generatePayload=function(e){var t=e.appId,n=e.sharingId,o=e.page,i=e.field,r=e.direction,a=e.count,s=e.distinctCount,c=e.type,e=e.search,n=(-1===l.indexOf(c)&&(c=u.getTypeByState()),{filters:{sharingId:n},pagination:{page:o,size:u.ANNOTATIONS_PER_PAGE,sort:{field:i,direction:r}},count:a,distinctCount:s});return(c="all"===c?null:c)&&(n.pagination.type=c),e&&(n.search=e),t&&(n.filters.appId=t),n}}]),angular.module("commons").service("UserService",["$q","LocalStorage","Config","API","DbnApi","$state","ngDialog","SessionService","FirebaseAnalyticsService","distributionChannelConditionsQuery","signConditionMutation",function(e,t,r,a,s,c,u,l,d,g,p){var h=this;this.isCheckingTermsAndConditions=!1,this.checkTermsAndConditions=function(t){var e,n,o,i;r.get("features")&&r.get("features").termsValidationMandatory&&!1===r.get("features").termsValidationMandatory.value||!h.isCheckingTermsAndConditions&&r.isTermsAndConditionsDisabled()||(e=r.getExternalLink("terms"),t&&!h.isCheckingTermsAndConditions&&e&&(n=r.getExternalLinkVersion("terms"),h.isCheckingTermsAndConditions=!0,i=null,o=(i=(!(i=t.apps&&0<t.apps.length&&(o=t.apps.find(function(e){return e.id===r.get("appId")}))&&o.conditions?o.conditions.filter(function(e){return"terms"===e.type}):i)||!i.length)&&t.institutions&&0<t.institutions.length&&(o=t.institutions.find(function(e){return e.id===l.getLMS()}))&&o.conditions?o.conditions.filter(function(e){return"terms"===e.type}):i)&&i.length?i[0]:null,!(i=r.getExternalLinkDisplay("terms").display)&&!o||i&&(!o||o.current.version<n)?u.openConfirm({showClose:!1,closeByDocument:!1,closeByEscape:!1,width:"50%",height:"80%",appendClassName:"ngdialog-terms-conditions",data:{terms_url:e},controllerAs:"$ctrl",template:"app/settings/condition-settings/condition-settings.html",controller:["$scope","$sce",function(e,t){this.terms_url=e.ngDialogData.terms_url,this.iframeLoaded=!0,this.trustSrc=function(){return t.trustAsResourceUrl(this.terms_url)},this.onLoad=function(){document.getElementById("iframe-termsAndConditions").contentWindow.length||(this.iframeLoaded=!1)}}]}).then(function(){return h.isCheckingTermsAndConditions=!1,r.enableJwt()?s.query(g,{id:r.getAppId()}).then(function(e){e.data.distributionChannel.conditions.forEach(function(e){s.mutate(p,{conditionId:e.id,userId:t.id}).then(function(e){return d.termsAccepted(n),e})})}):a.hapi.patch("/v1/reader/users/terms",{type:"terms",url:e,version:n}).then(function(e){return d.termsAccepted(n),e})}).catch(function(){l.logOut(),c.go("auth.login"),h.isCheckingTermsAndConditions=!1}):h.isCheckingTermsAndConditions=!1))},this.resendActivationCode=function(e,t,n,o){return l.isJwtTokenSession()?s.resendActivationCode({email:n,distributionChannelId:t}):a.hapi.post("/ap/users/resendActivationCode",{email:n,app_id:t,workspace_id:e,lang:o})},this.showResendValidationEmail=function(e,t,n,o){u.openConfirm({template:"auth/dialogs/resend-invitation.html",showClose:!1,appendClassName:"directive-modal-common",closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{userEmail:n,userAppId:t,userWorkspaceId:e,userLang:o,hasResendAction:!(4<arguments.length&&void 0!==arguments[4])||arguments[4],parent:h},controllerAs:"$ctrl",controller:["$scope",function(e){var t=this;this.email=e.ngDialogData.userEmail,this.appId=e.ngDialogData.userAppId,this.workspaceId=e.ngDialogData.userWorkspaceId,this.lang=e.ngDialogData.userLang,this.hasResendAction=e.ngDialogData.hasResendAction,this.parent=e.ngDialogData.parent,this.resendInvitation=function(){t.parent.resendActivationCode(t.workspaceId,t.appId,t.email,t.lang).then(function(){u.close(),u.openConfirm({width:"20%",template:"auth/dialogs/email-sent.html",showClose:!1})}).catch(function(e){console.log("Error on resendActivationCode: ",e)})},this.confirm=function(){u.close()}}]}).catch(function(){})},this.showConfirmationRegistering=function(e){u.openConfirm({template:"auth/dialogs/register-confirmation.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"30%",data:{userEmail:e},controllerAs:"$ctrl",controller:["$scope",function(e){this.email=e.ngDialogData.userEmail,this.confirm=function(){u.close()}}]}).catch(function(){})},this.updateUserPrintLimit=function(e,t,n){return r.enableJwt()?s.updateUserPrintLimit(e,n):r.hasUsersMigratedToDbn()?a.hapi.post("/v1/reader/users/"+e+"/updateUserPrintLimit",{usedPages:n}):a.hapi.patch("/v1/reader/users/"+e,t)}}]),angular.module("commons").service("UsersContentsInfos",["LocalStorage","Config","Entity","SessionService","UserDataProxyService","Utils",function(o,i,r,a,n,s){var t,c=this,u="contentsInfos";this.DEFAULT_ALT_MEDIA_ENABLED=!1,this.DEFAULT_TTS_VOLUME=.5,this.DEFAULT_TTS_SPEED=.5,this.DEFAULT_FONT_NAME="",this._currentDataModelVersion=1,this._syncData={version:this._currentDataModelVersion,syncTimestamp:0,userContentsInfos:[]},this._updateCache=function(){o.set(u,c._syncData)},this._push=function(e){e.forEach(function(e){var t=c.getBySharingId(e.sharingId);t?s.mergeDeep(t,e):c._syncData.userContentsInfos.push(e)}),c._updateCache()},this._buildNewContentsInfos=function(e){var t=i.getAppId(),n=o.get("userId");return{id:c.generateID(t,n,e),userId:n,appId:t,sharingId:e,version:c._currentDataModelVersion,deleted:!1,options:{}}},this.load=function(){var e=o.get(u),t=i.getAppId(),e=(e&&(c._syncData=e,c._updateCache()),{appId:t,syncTimestamp:c._syncData.syncTimestamp||0,userContentsInfos:[]});return n.syncContentsInfos(e).then(function(e){return c._syncData.syncTimestamp=e.syncTimestamp,c._push(e.userContentsInfos),c._syncData})},this.generateID=function(e,t,n){return"hash"+r.hashCode(e+t+n)},this.getBySharingId=function(t){return c._syncData.userContentsInfos.find(function(e){return e.sharingId===t})},this.delete=(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=c.getBySharingId(t)){e.next=3;break}return e.abrupt("return");case 3:return n.deleted=!0,e.next=6,c.push([n]);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}},e,c)})),function(e){return t.apply(this,arguments)}),this.push=function(e){e={appId:i.getAppId(),syncTimestamp:c._syncData.syncTimestamp||0,userContentsInfos:e};return n.syncContentsInfos(e).then(function(e){return c._syncData.syncTimestamp=e.syncTimestamp,c._push(e.userContentsInfos),e})},this.toggleFavourite=function(e){var t;if("PREVIEW"!=a.readerMode)return null==(t=c.getBySharingId(e))?(t=c._buildNewContentsInfos(e)).options.favorite=!0:t.options.favorite=!t.options.favorite,c.push([t])},this.isFavourite=function(e){if("PREVIEW"!=a.readerMode)return null!=(e=c.getBySharingId(e))&&!1===e.deleted&&!0===e.options.favorite},this.updateLastOpening=function(e,t){var n;if("PREVIEW"!=a.readerMode)return(n=null==(n=c.getBySharingId(e))?c._buildNewContentsInfos(e):n).options.lastOpen=t,c.push([n])},this.updateAccessibilityTTS=function(e,t){var n;if("PREVIEW"!=a.readerMode)return(n=null==(n=c.getBySharingId(e))?c._buildNewContentsInfos(e):n).options.accessibility||(n.options.accessibility={}),null!=t.altMediaEnabled?n.options.accessibility.altMediaEnabled=t.altMediaEnabled:n.options.accessibility.altMediaEnabled=c.DEFAULT_ALT_MEDIA_ENABLED,null!=t.soundPower&&null!=t.soundPower&&0<=t.soundPower?n.options.accessibility.soundPower=t.soundPower:n.options.accessibility.soundPower=c.DEFAULT_TTS_VOLUME,null!=t.speechRate&&null!=t.speechRate&&0<=t.speechRate?n.options.accessibility.speechRate=t.speechRate:n.options.accessibility.speechRate=c.DEFAULT_TTS_SPEED,c.push([n])},this.updateAccessibilityFont=function(e,t){if("PREVIEW"===a.readerMode)return Promise.resolve();var n=c.getBySharingId(e);(n=n||c._buildNewContentsInfos(e)).options.accessibility||(n.options.accessibility={}),n.options.accessibility.fontName=t.fontName||t.fontName===c.DEFAULT_FONT_NAME?t.fontName:n.options.accessibility.fontName||c.DEFAULT_FONT_NAME,t.fontSize&&(n.options.accessibility.fontSize=t.fontSize),c._push([n])}}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},_extends=(angular.module("commons").service("UsersPreferences",["LocalStorage","Config","Entity","UserDataProxyService",function(a,s,o,n){var c=this,i="preferences";this.KEY_DESK_BOOK_SORTER="deskBookSorter",this.KEY_DESK_ASSIGNMENT_SORTER="deskAssignmentSorter",this.KEY_USER_LANGUAGE="language",this._currentDataModelVersion=1,this._cache=[],this._syncData={userPreferences:[]},this._updateCache=function(){c._cache=c._get(),a.set(i,c._syncData)},this._push=function(e){e.forEach(function(t){var e=c._syncData.userPreferences.find(function(e){return e.id===t.id});e?_extends(e,t):c._syncData.userPreferences.push(t)}),c._updateCache()},this._get=function(){return c._syncData.userPreferences},this.load=function(){var e=a.get(i),t=s.getAppId();return e&&(c._syncData=e,c._updateCache()),n.getPreferences(t).then(function(e){return c._push(e),c._syncData})},this.generateID=function(e,t,n){return o.hashCode(e+t+n)},this.get=function(){return c._cache},this.getById=function(t){return c._syncData.userPreferences.find(function(e){return e.id===t})},this._insert=function(e){return n.upsertPreferences(e).then(function(e){return c._push([e]),e})},this._update=function(e){return n.upsertPreferences(e,"put").then(function(e){return c._push([e]),e})},this.set=function(e,t){var n=a.get("userId"),o=s.getAppId(),i=c.generateID(o,n,e),r=c.getById(i);return r?(r.value=t,c._update(r)):(r={id:i,userId:n,appId:o,version:c._currentDataModelVersion,key:e,value:t},c._insert(r))},this.get=function(e){var t=a.get("userId"),n=s.getAppId(),n=c.generateID(n,t,e);return c.getById(n)}}]),Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}angular.module("commons").service("Utils",function(){var a=this;this.isObject=function(e){return e&&"object"===(void 0===e?"undefined":_typeof(e))&&!Array.isArray(e)},this.mergeDeep=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];if(!n.length)return e;var i=n.shift();if(a.isObject(e)&&a.isObject(i))for(var r in i)a.isObject(i[r])?(e[r]||_extends(e,_defineProperty({},r,{})),a.mergeDeep(e[r],i[r])):_extends(e,_defineProperty({},r,i[r]));return a.mergeDeep.apply(a,[e].concat(n))}}),angular.module("security").controller("ConfirmEmailController",["API","$location","$http","ngDialog","SessionService",function(e,t,n,o,i){var r=this,a=t.search();this.expiredLink=!1,n.get(e.hapi.baseUrl()+"/ap/users/reset-email?resetToken="+a.token).then(function(){r.openChangeConfirm(),t.search("token",null)}).catch(function(){r.expiredLink=!0,r.openChangeConfirm()}),this.openChangeConfirm=function(){o.openConfirm({width:"350px",template:"security/confirm-email/confirm-dialog/confirm-dialog.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"confirm-reset-email-dialog",focusOnOpen:!0,controllerAs:"$ctrl",data:{expiredLink:r.expiredLink},controller:["ngDialog","$scope",function(e,t){this.expiredLink=t.ngDialogData.expiredLink,this.go=function(){i.logOut()},this.close=function(){e.close()}}]}).catch(function(e){console.log(e)})}}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}angular.module("commons").service("Iframe",["SettingService","IframeInterface","SyncService","SessionService","$state","Library","Config","Entity","LocalStorage","UsersContentsInfos","$translate","ReadSpeakerService","StatisticsService","KeyCodesService","$timeout","$rootScope",function(e,t,n,p,h,f,m,r,a,b,v,I,y,k,o,i){function s(){_classCallCheck(this,s);var e=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return e.iframe=null,e.tools=null,e.showToolbar=!1,e.sharingId=null,e.contentsInfos=null,e.init=e.init.bind(e),e.onFrameLoad=e.onFrameLoad.bind(e),e.setFont=e.setFont.bind(e),e.PDFScale=1.25,e.EpubFixedWidth=60,e.pageScale=10,e.EpubReflowWidth=1,e.activateAltTextMedia=e.activateAltTextMedia.bind(e),e.testAudioForAltText=e.testAudioForAltText.bind(e),e}return _inherits(s,t),_createClass(s,[{key:"init",value:function(e,t){this.listeners=new Map,this.setSelectedText=null,this.setSelectedHighlight=null,this.iframe=e,this.iframe.addEventListener("load",this.onFrameLoad,this),"function"==typeof t&&this.iframe.addEventListener("load",t)}},{key:"resetObservers",value:function(){this.GtAudio&&this.book.readerGtAudio()&&this.GtAudio.resetObservers&&this.GtAudio.resetObservers()}},{key:"onFrameLoad",value:function(){var e,t,n,o,i,r,a,s,c,u=this,l=m.hasReadAloud(),d=this.iframe.contentWindow,g=d.document;/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&((e=document.createElement("style")).innerHTML="\n                    @media print {\n                        body * { display: none !important; }\n                        body:after { content: '"+v.instant("GT_PRINT_DISABLED_MESSAGE")+"'; }\n                    }\n                ",g.head.appendChild(e)),l&&(g=m.get("features").readAloud,e=d.document.getElementsByTagName("body")[0],l=d.document.getElementsByTagName("head")[0],I.readSpeakerCss(l),I.readSpeakerConf(e,h.params.book),I.readSpeakerEvents(e),I.addReadSpeakerScript(e,g.id),I.addReadSpeakerButton(e,d,g.id)),this.tools=d.Tools,this.GtRangy=d.GtRangy,this.GtAudio=d.GtAudio,this.GtPdfJS=d.GtPdfJS,this.GtWiktionaryHtmlParser=d.GtWiktionaryHtmlParser,this.tools&&this.GtRangy&&this.GtAudio&&this.GtPdfJS&&(m.hasFeature("schwepsy")&&window.gtReaderLibs.init(),l={highlight:{start:v.instant("GT_READER_HIGHLIGHT_READ_START_ACCESSIBILITY"),end:v.instant("GT_READER_HIGHLIGHT_READ_END_ACCESSIBILITY")},note:{start:v.instant("GT_READER_NOTE_READ_START_ACCESSIBILITY"),end:v.instant("GT_READER_NOTE_READ_END_ACCESSIBILITY")}},d.document.body.classList.add("webreader"),d.GtConfig.isMobile=!1,this.GtRangy.setWebReader(this),this.GtRangy.init({accessibility:l}),d.document.getElementById("gtrangy-style").textContent+="\n                .gt-search-highlight {\n                    background-color: yellow !important;\n                    padding: 2px 0px;\n                    outline: 2px solid blue;\n                }\n            ","function"==typeof d.setWebReader&&d.setWebReader(),d.onPlayerEvent=function(e,t){y.playerEvent({action:e,params:t,bookId:u.book.project_id||u.book.id,isbn:u.book.isbn})},d.sendToReader=function(e,t){u.emit(e,t),console.log(e,t)},this.GtPdfJS&&this.GtPdfJS.init(),this.isWatermarkActive=m.hasFeature("bookWatermark"),this.GtPdfJS&&this.isPDF()&&this.isWatermarkActive&&(e=p.getUser(),this.GtPdfJS.setWatermark(e.identity+" "+e.email)),this.internalLinks=d.document.querySelectorAll(".gt-internal-link"),this.internalLinks.length&&this.setInternalLinkHref(this.internalLinks),g=h.params.book,this.book=f.getBookByContentId(g),l=h.params.assignment,this.sharingId=this._sharingId(g,l),this.contentsInfos=b.getBySharingId(this.sharingId),e=b.DEFAULT_TTS_VOLUME,g=b.DEFAULT_TTS_SPEED,l=b.DEFAULT_ALT_MEDIA_ENABLED,this.book.isPdfEpubOrNativeGtContent()?d.document.body.querySelectorAll("a:not(.gt-internal-link)").forEach(function(e){return e.setAttribute("target","_blank")}):(s=d.document.body.querySelectorAll("a:not(.gt-internal-link)"),c=(a=window.parent.top).location.hash.split("/"),r=a.document.getElementById("project-title"),t=r&&r.getAttribute("data-title"),n=c[4],o=c[2],i=encodeURIComponent(a.localStorage.getItem("aptoken")||"").slice(1,-1),s.forEach(function(e){e.href&&(-1===e.href.indexOf("?")?e.href+="?fromToken="+i:e.href+="&fromToken="+i,t&&(e.href+="&fromTitle="+t),e.href+="&fromBook="+o+"&fromPage="+n),e.setAttribute("target","_top")})),d.document.addEventListener("keydown",function(e){var t,n;13===e.keyCode&&e.shiftKey?(e.preventDefault(),d.document.body.getAttribute("contenteditable")||(d.document.body.setAttribute("contenteditable","true"),(t=d.getSelection()).removeAllRanges(),(n=d.document.createRange()).setStart(d.document.body,0),n.collapse(!0),t.addRange(n))):27===e.keyCode&&d.document.body.getAttribute("contenteditable")&&(d.document.body.removeAttribute("contenteditable"),d.document.body.focus())}),this.contentsInfos?(c=(r=this.contentsInfos.options.accessibility)?r.fontName:"",this.setFont(c,!1),this.zoomBook(r.fontSize),a=r&&null!=r.soundPower?r.soundPower:e,s=r&&null!=r.speechRate?r.speechRate:g,c=r&&null!=r.altMediaEnabled?r.altMediaEnabled:l,this.activateAltTextMedia(c,a,s,!1)):(this.zoomBook(),this.activateAltTextMedia(l,e,g,!1)),this.goToPageArrow=function(e){var t,n,o,i,r;"reader.book.page"!==h.current.name||(t=d.document.body).hasAttribute("contenteditable")||(o=document.activeElement,i=d.document.activeElement,r="input"===o.tagName.toLowerCase()||"input"===i.tagName.toLowerCase(),n="textarea"===o.tagName.toLowerCase()||"textarea"===i.tagName.toLowerCase(),o="true"===o.contentEditable.toLowerCase()||"true"===i.contentEditable.toLowerCase(),r)||n||o||(t.setAttribute("tabindex","-1"),"h"===u.book.getPaginationMode()?(i=0<!!document.activeElement.closest("#fontMenuFocus"),r=0<!!document.activeElement.closest("#readingSpeed"),document.activeElement.closest("#toc-container")||(!k.isArrowLeft(e)||i||r?!k.isArrowRight(e)||i||r?(k.isArrowUp(e)||k.isArrowDown(e)&&document.activeElement!==document.querySelector("#fontMenu"))&&(document.getElementById("changelanguage")==document.activeElement?u.openmenu=!0:t.focus()):(o=(n=u.book.nextPage(h.params.page)).path||n.id,h.go("reader.book.page",{page:o})):(r=(i=u.book.previousPage(h.params.page)).path||i.id,h.go("reader.book.page",{page:r})))):k.isArrowUp(e)?0===t.scrollTop?(o=(n=u.book.previousPage(h.params.page)).path||n.id,h.go("reader.book.page",{page:o})):document.activeElement!==document.querySelector("#fontMenu")&&t.focus():k.isArrowDown(e)&&(t.scrollHeight-t.scrollTop===t.clientHeight?(r=(i=u.book.nextPage(h.params.page)).path||i.id,h.go("reader.book.page",{page:r})):document.activeElement!==document.querySelector("#fontMenu")&&t.focus()))},d.document.addEventListener("keydown",this.goToPageArrow),this.GtAudio&&this.book.readerGtAudio()&&this.GtAudio.init({full:!1}),this.setToolbarMargin(260,-20),this.ready(),this.emit("load"))}},{key:"returnToSelectionMode",value:function(e){this.GtRangy.returnToSelectionMode(e)}},{key:"_sharingId",value:function(e,t){var n=null;return t?n=t:(t=f.getBookByContentId(e))&&(n=t.getSharingId()),n}},{key:"activateAltTextMedia",value:function(e,t,n){var o=!(3<arguments.length&&void 0!==arguments[3])||arguments[3],i=a.get("lang");e?this.tools.initTextAltOnMedia(i,t,n):this.tools.cancelTextOnMediaAlt(),!0===o&&this.sharingId&&b.updateAccessibilityTTS(this.sharingId,{altMediaEnabled:e,soundPower:t,speechRate:n})}},{key:"testAudioForAltText",value:function(e,t,n){var o=a.get("lang");this.tools.testAudioforAltMedia(o,e,t,n)}},{key:"setFont",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];e&&""!==e?this.tools.setFontFamily(e):this.tools.resetFontFamily(),!0===t&&this.sharingId&&b.updateAccessibilityFont(this.sharingId,{fontName:e})}},{key:"highlight",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o=void 0,o=t?(this.GtRangy.unlight(),t):r.generateUUID("hash");return this.GtRangy.highlight(o,n,e,!0)}},{key:"highlightWithSchwepsy",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2],o=e||r.generateUUID("hash"),i={};return window.HighlightManager?e?(window.HighlightManager.setColor(o,t),n&&window.HighlightManager.convertHighlightToNote(o)):i=window.HighlightManager.createHighlightFromSelection(t,o,n):console.error("HighlightManager is not available"),i}},{key:"removeHighlight",value:function(e,t){t?window.HighlightManager.removeHighlight(e):this.GtRangy.unlight(e)}},{key:"focusHighlight",value:function(e){this.highlightId&&this.GtRangy.focusHighlight(e)}},{key:"focusOnHighlight",value:function(e,t){t?window.HighlightManager.focusHighlight(e):this.GtRangy.focusOnHighlight(e)}},{key:"setToolbarMargin",value:function(e,t){this.GtRangy.setFramePosition({left:e,top:t})}},{key:"setFocusOnContent",value:function(){this.GtRangy.setFocusOnContent()}},{key:"search",value:function(e,t){e&&t&&this.GtRangy.search(e,t)}},{key:"undoSearch",value:function(){this.GtRangy.undoSearch()}},{key:"scrollToElement",value:function(t){var n=this.iframe.contentWindow;n.location.hash=null,o(function(){var e;n.document.getElementById(t)?(e=n.document.getElementById(t).getBoundingClientRect().top+n.scrollY,n.scroll({top:e,behavior:"smooth"})):n.location.hash=t},500)}},{key:"setInternalLinkHref",value:function(e){e.forEach(function(e){var t=e.href.split("?")[0],n=e.getAttribute("external-id");e.href=t+"?#"+n})}},{key:"zoomPDF",value:function(e){var t,n=this;this.isPDF()&&!isNaN(e)&&(this.PDFScale=e,this.isWatermarkActive=m.hasFeature("bookWatermark"),t=p.getUser(),this.GtRangy.unlightAll(),window.HighlightManager.removeAllHighlights(),this.GtPdfJS.zoom(this.PDFScale).then(function(){i.$broadcast("zoom-pdf"),n.isWatermarkActive&&n.GtPdfJS.setWatermark(t.identity+" "+(t.watermark||t.email))}))}},{key:"parseDefinition",value:function(e,t){return this.GtWiktionaryHtmlParser.parse(e,t)}},{key:"isPDF",value:function(){return!!this.GtPdfJS&&this.GtPdfJS.isPDF}},{key:"isEpubFixed",value:function(){return this.book&&this.book.isEpubFixed()}},{key:"isNativeGtContent",value:function(){return!this.isEpubFixed()&&!this.isPDF()}},{key:"zoomEpubFixed",value:function(e){var t=this.iframe.contentWindow.document.body,n=t.parentNode,o=this.iframe.contentWindow.document.getElementsByTagName("section"),o=(o[0]&&(o[0].style.width="unset"),n.setAttribute("style","background: #808080; height: 100%;"),t.setAttribute("style","transform-origin: top center;\n                margin: 0 auto;\n                position: absolute;\n                top: 0; left: 0;\n                bottom: 0; right: 0;"),this.EpubFixedWidth=e,t.offsetWidth/n.offsetWidth*100);t.style.transform="scale("+this.EpubFixedWidth/o+")"}},{key:"zoomPage",value:function(e){if(this.iframe.contentWindow)for(var a=this.iframe.contentWindow.document.body,t=1<e?"top left":"top center",n=(this.pageScale=10*e,this.book&&this.book.isEpubReflowWithoutPageBreak()&&(t="top center",a.style.margin=a.clientWidth<1440?"5% "+15*e+"%":""),a.style.transformOrigin=t,a.style.transform=1!==e?"scale("+e+")":"none",a.getElementsByClassName("gt-note note")),o=0;o<n.length;o++)n[o].onclick=function(e){var t,n,o,i,r;e.stopPropagation(),e.preventDefault(),"click"===e.type&&((t=a.getElementsByClassName("i-note")[0]).style.position="absolute",n=a.getBoundingClientRect(),o=t.getBoundingClientRect(),i=a.getElementsByClassName("i-note-bg")[0].getBoundingClientRect(),r=n.top>o.height,i.height>n.bottom+o.height||!r?(t.style.top=e.pageY-e.layerY+e.offsetY+"px",t.classList.add("i-note-bottom")):(t.style.top=n.top-o.height+"px",t.classList.add("i-note-top")),i=n.left+n.width/2,(r=e.pageX-e.layerX+e.offsetX)<0&&(r=e.x+o.width),t.style.left=r+"px",o=t.getBoundingClientRect(),t.dataset.notePosition=i-o.left)}}},{key:"zoomEpubReflow",value:function(e){var t=this.iframe.contentWindow.document.body;this.EpubReflowWidth=e,document.body.className.includes("firefox")?t.setAttribute("style","transform: scale("+e+")"):t.setAttribute("style","zoom: "+e)}},{key:"zoomBook",value:function(e){if(this.book)switch(!0){case this.isPDF():e=e?e/100:this.PDFScale,this.zoomPDF(e);break;case this.isEpubFixed():e=e||this.EpubFixedWidth,this.zoomEpubFixed(e);break;case this.book.isEpubReflow():e=e?e/100:this.EpubReflowWidth,this.zoomEpubReflow(e);break;case this.book.isNativeGtContent():e=e?e/10:this.pageScale/10,this.zoomPage(e)}}},{key:"showHighlightsAndNotes",value:function(e,t,n){n?(window.NoteIconManager&&(window.NoteIconManager.showIconInSide=m.hasNotesOnTheSide()),window.HighlightManager.applyHighlights(e.concat(t))):this.GtRangy.showHighlightsAndNotes(e,t,!1)}},{key:"setExercise",value:function(e){"function"==typeof this.iframe.contentWindow.setExercise&&this.iframe.contentWindow.setExercise(e.options.exerciseId,e)}}]),new s}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(r,a){return function t(e,n){try{var o=s[e](n),i=o.value}catch(e){return void a(e)}if(!o.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});r(i)}("next")})}}angular.module("app").factory("IframeInterface",function(){function e(){_classCallCheck(this,e),this.isReady=!1,this.callbacksWhenReady=[],this.onSelectedHighlight=this.onSelectedHighlight.bind(this),this.onSelectedText=this.onSelectedText.bind(this),this.listeners=new Map}return _createClass(e,[{key:"onSelectedText",value:function(e){this.setSelectedText=e}},{key:"onSelectedHighlight",value:function(e){this.setSelectedHighlight=e}},{key:"ready",value:function(){this.isReady=!0,this.callbacksWhenReady.forEach(function(e){return e.apply()}),this.callbacksWhenReady.length=0}},{key:"whenReady",value:function(e){this.isReady?e.apply():this.callbacksWhenReady.push(e)}},{key:"emit",value:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];var i=this.listeners.get(e);return!(!i||!i.length||(i.forEach(function(e){e.apply(void 0,n)}),0))}},{key:"on",value:function(e,t){var n=this;return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),function(){n.listeners.get(e).splice(n.listeners.get(e).indexOf(t),1)}}}]),e}),angular.module("app").config(["$stateProvider",function(e){e.state("reader.userinput.notes",{url:"/notes"}).state("reader.userinput.bookmarks",{url:"/bookmarks"}).state("reader.userinput.highlights",{url:"/highlights"}).state("reader.userinput.notdisplayed",{url:"/bad-items"})}]),angular.module("app").controller("userData",["$state","$scope","SyncService","Library","SearchService","Theme","PaginationService","$translate","book",function(t,n,o,e,i,r,a,s,c){var u=this;this.$onInit=function(){var e;u.primaryColor=r._theme.primaryColor.value,u.PaginationService=a,n.$state=t,u.book=c,u.book?(u.features=u.book.features,u.structure=u.book.structure,u.highlightsActivated=u.book.readerHighlightFeature(),u.notesActivated=u.book.readerNoteFeature(),u.bookmarksActivated=u.book.readerBookmarkFeature(),u.bookTitle=u.book.getTitle(),u.cover=u.book.cover||"commons/img/covers.png",u.author=u.book.author||"-",u.ndAnnotations=o.getNdAnnotations().length,u.activeSearch=!1,u.firstTab=!0,u.filterOptions=[{name:s.instant("GT_ANNOTATIONS_SORT_CONTENT"),direction:"ASC",field:"pageNumberRef"},{name:s.instant("GT_ANNOTATIONS_SORT_NEW"),direction:"DESC",field:"updatedAt"},{name:s.instant("GT_ANNOTATIONS_SORT_OLD"),direction:"ASC",field:"updatedAt"}],u.annotationsStatus=o.getNdAnnotations().filter(function(e){return!e.options.broken_status||"viewed"!==e.options.broken_status}).length,e=null,e=t.params.assignment||u.book.getSharingId(),a.setSharingId(e),"reader.userinput.bookmarks"===t.current.name?a.setType("bookmark"):"reader.userinput.notes"===t.current.name?a.setType("note"):"reader.userinput.highlights"===t.current.name?a.setType("highlight"):a.setType("all"),u.sortSelected=u.filterOptions[0],a.setSort(u.sortSelected.field,u.sortSelected.direction),u.searchQuery="",i.clearSearch(),a.setSearch(null),u.paginate()):console.error("Book could not be retrieved from Library")};document.getElementById("skipToContent").addEventListener("click",function(e){e.preventDefault(),document.getElementById("user-input-"+(u.type||"all")+"-tab").focus()}),document.addEventListener("keydown",function(e){var t=document.getElementById("skipToContent");9===e.keyCode?u.firstTab&&(e.preventDefault(),document.getElementById("skipToContent").focus(),u.firstTab=!1):13===e.keyCode&&t&&t===document.activeElement&&(e.preventDefault(),document.getElementById("user-input-"+(u.type||"all")+"-tab").focus())});n.$on("update-annotation",function(){a.reset(),u.type&&a.setType(u.type),u.sortSelected&&a.setSort(u.sortSelected.field,u.sortSelected.direction),u.paginate()}),this.changeTab=function(e){u.type=e,a.setType(e),a.setSort(u.sortSelected.field,u.sortSelected.direction),u.paginate()},this.sortAnnotations=function(e){u.sortSelected=e,a.setSort(u.sortSelected.field,u.sortSelected.direction),u.paginate().then(function(){document.getElementById("sort-anontation-menu").focus()})},this.isTabSelected=function(e){return e===u.type},this.updateStatus=function(e){o.updateNdAnnotationsStatus(e),u.annotationsStatus=0},this.clearSearch=function(){u.searchQuery&&!a.isLoading&&(i.clearSearch(),u.searchQuery="",a.setSearch(null),u.type&&a.setType(u.type),u.sortSelected&&a.setSort(u.sortSelected.field,u.sortSelected.direction),u.paginate())},this.onChanges=function(e){e?u.userInputs=e:(u.paginatedData=a.items,u.totalUserInputs=a.totalCount)},document.querySelector('[role="tablist"]').addEventListener("keydown",function(e){var t=document.querySelectorAll('[role="tab"]'),n=document.getElementById("menu-list-item").children,n=Array.prototype.slice.call(n).indexOf(document.activeElement);39!==e.keyCode&&37!==e.keyCode||(t[n].setAttribute("tabindex",-1),39===e.keyCode?++n>=t.length&&(n=0):37===e.keyCode&&--n<0&&(n=t.length-1),t[n].setAttribute("tabindex",0),t[n].focus())}),this.searchAnnotations=function(){a.setSearch(u.searchQuery),u.type&&a.setType(u.type),u.sortSelected&&a.setSort(u.sortSelected.field,u.sortSelected.direction),u.paginate().then(function(){setTimeout(function(){document.getElementById("search-input").focus()},10)})},this.goBack=function(){t.go("reader.book",{book:t.params.book})},this.getFilter=function(){return t.current.name.split(".")[2]},this.paginate=function(){return u.book||console.error("Book is undefined"),a.paginate().then(function(){u.book.structure.version?o.autofixAnnotations(a.getAutofixItems(),u.book):console.warn("Skipping autofix because book structure version is undefined or falsy")}).catch(function(e){console.error("Error during pagination:",e)})},this.getCount=function(e){switch(e){case"all":return a.totalCount||0;case"note":return a.distinctCount?a.distinctCount.note:0;case"highlight":return a.distinctCount?a.distinctCount.annotation-a.distinctCount.note:0;case"bookmark":return a.distinctCount?a.distinctCount.bookmark:0}}}]),angular.module("app").controller("userInput",["$state","$scope","SyncService","Library","SearchService","UserInputsService","Theme","$translate","Config","KeyCodesService",function(t,e,n,o,i,r,a,s,c,u){var l=this;this.$onInit=function(){l.primaryColor=a._theme.primaryColor.value,l.UserInputsService=r,l.selectedPage=1,e.$state=t,l.book=o.getBookByContentId(t.params.book),l.highlightsActivated=l.book.readerHighlightFeature(),l.notesActivated=l.book.readerNoteFeature(),l.bookmarksActivated=l.book.readerBookmarkFeature(),l.bookTitle=l.book.getTitle(),l.isFirefox="undefined"!=typeof InstallTrigger,l.ariaLive=l.isFirefox?"off":"polite",l.cover=l.book.cover||"commons/img/covers.png",l.author=l.book.author||"-",l.ndAnnotations=n.getNdAnnotations().length,l.annotationsStatus=n.getNotViewedAnnotation().length,l.activeSearch=!1,l.showSize=r.ANNOTATIONS_PER_PAGE,l.firstTab=!0,l.filterOptions=[{name:s.instant("GT_ANNOTATIONS_SORT_CONTENT"),key:"asc",type:"pageTitle"},{name:s.instant("GT_ANNOTATIONS_SORT_NEW"),key:"desc",type:"$updated_at"},{name:s.instant("GT_ANNOTATIONS_SORT_OLD"),key:"asc",type:"$updated_at"}],l.sortSelected=l.filterOptions[0],r.sortType=l.sortSelected.type,l.getSyncObjects=_asyncToGenerator(regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.getUserInputsForPage({appId:c.get("appId"),sharingId:l.book.getSharingId(),page:l.selectedPage,field:l.sortSelected.type,direction:l.sortSelected.key,count:!0,distinctCount:!0,type:l.type,search:l.searchQuery});case 2:if(!r.paginatedData.length&&1<l.selectedPage)return l.selectedPage--,e.abrupt("return",l.getSyncObjects());e.next=5;break;case 5:l.book.structure.version&&n.autofixAnnotations(r.paginatedData,l.book);case 6:case"end":return e.stop()}},e,l)})),l.getSyncObjects()};document.getElementById("skipToContent").addEventListener("click",function(e){e.preventDefault(),document.getElementById("user-input-"+(l.type||"all")+"-tab").focus()}),this.openSortByDialog=function(){return l.openSortSelect?s.instant("GT_USER_INPUTS_EXPAND"):s.instant("GT_USER_INPUTS_COLLAPSE")},document.addEventListener("keydown",function(e){var t=document.getElementById("skipToContent");u.isTab(e)?l.firstTab&&(e.preventDefault(),document.getElementById("skipToContent").focus(),l.firstTab=!1):u.isEnter(e)&&t&&t===document.activeElement&&(e.preventDefault(),document.getElementById("main").focus())});e.$on("page-change",function(e,t){l.selectedPage=t,l.getSyncObjects()}),e.$on("update-annotation",function(){l.getSyncObjects()}),this.changeTab=function(e){l.type=e,l.selectedPage=1,l.getSyncObjects()},this.checkType=function(e){switch(t.current.name){case"reader.userinput":if("all"===e)return!0;break;case"reader.userinput.notes":if("note"===e)return!0;break;case"reader.userinput.highlights":if("highlight"===e)return!0;break;case"reader.userinput.bookmarks":if("bookmark"===e)return!0}return!1},e.$on("update-annotation",function(){l.getSyncObjects()}),this.getTotalItems=function(){var t=l,n=null;return t.type=r.getTypeByState(),t.type?(Object.keys(r.totalUserInputs).forEach(function(e){e===t.type&&(n=r.totalUserInputs[e])}),n):r.totalUserInputs.all},this.sortAnnotations=function(e){l.sortSelected=e,r.sortType=e.type,l.getSyncObjects(),document.getElementById("sort-anontation-menu").focus()},this.getAriaLabel=function(){return!1},this.isTabSelected=function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:null)===l.type},this.updateStatus=function(e){n.updateNdAnnotationsStatus(e),l.annotationsStatus=0},this.clearSearch=function(){l.searchQuery&&!r.isLoading&&(i.clearSearch(),l.searchQuery="",l.getSyncObjects())},this.isClearDisabled=function(){var e=!1,t=(l.searchQuery&&!l.UserInputsService.isLoading||(e=!0),document.getElementById("userInputClearButton"));return setTimeout(function(){t.setAttribute("disabled",e)}),e},this.onChanges=function(e){e?l.userInputs=e:(l.paginatedData=r.paginatedData,l.totalUserInputs=r.totalUserInputs)},document.querySelector('[role="tablist"]').addEventListener("keydown",function(e){var t=document.querySelectorAll('[role="tab"]'),n=document.getElementById("menu-list-item").children,n=Array.prototype.slice.call(n).indexOf(document.activeElement);(u.isArrowRight(e)||u.isArrowLeft(e))&&(t[n].setAttribute("tabindex",-1),u.isArrowRight(e)?++n>=t.length&&(n=0):u.isArrowLeft(e)&&--n<0&&(n=t.length-1),t[n].setAttribute("tabindex",0),t[n].focus())}),this.searchAnnotations=function(){l.getSyncObjects().then(function(){document.getElementById("search-input").focus()})},this.goBack=function(){t.go("reader.book",{book:t.params.book})},this.isPaginationShown=function(){var e;return!!r.paginatedData&&(e=l.getTotalItems(),0<r.paginatedData.length)&&!r.isLoading&&e>r.ANNOTATIONS_PER_PAGE},this.goBack=function(){t.go("reader.book",{book:t.params.book})},this.getFilter=function(){return t.current.name.split(".")[2]}}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.account-settings",{url:"/account-settings",abstract:!1,templateUrl:"app/settings/account-settings/account-settings.html",controllerAs:"$ctrl",controller:["$anchorScroll","$location",function(t,n){this.innerNav=function(e){n.hash(e),t()}}]})}]),angular.module("app").config(["$stateProvider",function(e){e.state("app.general-settings",{url:"/general-settings",abstract:!1,templateUrl:"app/settings/general-settings/general-settings.html",controllerAs:"$ctrl",controller:["$anchorScroll","$location",function(t,n){this.innerNav=function(e){n.hash(e),t()}}]})}]);_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},angular.module("app").config(["$stateProvider",function(e){e.state("app.profile",{url:"/profile",abstract:!1,templateUrl:"app/settings/profile/profile.html",controllerAs:"$ctrl",params:{formIsEditable:!1,firstName:null,lastName:null},controller:["SessionService","API","$state","DbnApi","Config","$translate","Theme","$q","toastr","ngDialog",function(t,e,n,o,i,r,a,s,c,u){var l=this,a=a._theme.primaryColor.value,a=((a=(a=/^#([A-Fa-f0-9]{3}){1,2}$/.test(a)?function(e){3===(e=e.substring(1).split("")).length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]);return"rgba("+[(e="0x"+e.join(""))>>16&255,e>>8&255,255&e].join(",")+",1)"}(a):a).split(","))[3]||(a[2]=a[2].replace(")","")),a[3]=".2)",this.primaryColor=a.join(","),this.user=t.getUser(),this.hasExternalAuthenticationProvider=i.hasExternalAuthenticationProvider()||Boolean(Object.keys(this.user.thirdparties).length),this.isSSOUsername=!!this.user.email&&-1===this.user.email.indexOf("@"),this.user.identity?this.user.identity.split(" "):[]);this.firstName=this.firstNameCopy=a.slice(0,a.length-1).join(" "),this.lastName=this.lastNameCopy=a[a.length-1],this.allowedFileFormats=["jpeg","jpg","png"],this.formIsEditable=n.params.formIsEditable,this.updateIdentity=n.params.updateIdentity,this.hasJwt=t.isJwtTokenSession(),this.goBack=function(){n.go(t.goToShelf())},this.modalParams={type:"open",button:r.instant("GT_DESK_ITEM_PROFILE"),modalButton:"Confirm",body:"You have unsaved changes. Are you sure?"},this.update=function(){l.user.identity=(l.firstName?l.firstName.trim():"")+" "+(l.lastName?l.lastName.trim():""),l.user.save().then(function(){l.formIsEditable=!1,l.firstNameCopy=l.firstName,l.lastNameCopy=l.lastName;var e=r.instant("GT_USER_PROFILE_MODIFICATIONS_SAVED");c.success(e,{toastClass:"toast toast-black",timeOut:3e3})}).catch(function(){l.resetUpdate();var e=r.instant("GT_SESSION_EXPIRED");c.warning(e,{toastClass:"toast toast-black",timeOut:3e3}),l.verifyUser("reset-profile")})},this.updateIdentity=function(){var e={firstName:l.firstName,lastName:l.lastName,id:l.user.id};o.updateIdentity(e).then(function(e){e=_extends(t.getUser(),e.data.updateIdentity.user),e.identity=e.firstName+" "+e.lastName,t.setUser(e),t.user=e,l.formIsEditable=!1,l.firstNameCopy=l.firstName,l.lastNameCopy=l.lastName,e=r.instant("GT_USER_PROFILE_MODIFICATIONS_SAVED");c.success(e,{toastClass:"toast toast-black",timeOut:3e3})}).catch(function(e){console.error(e);e=r.instant("GT_ALERT_UNKNOWN_ERROR_MSG");c.error(e,{timeOut:3e3})})},(n.params.firstName||n.params.lastName)&&(this.firstName=n.params.firstName,this.lastName=n.params.lastName,this.firstNameCopy=this.firstName,this.lastNameCopy=this.lastName,t.isJwtTokenSession()?this.updateIdentity():this.update()),this.hasChanges=function(){return l.firstName!==l.firstNameCopy||l.lastName!==l.lastNameCopy},this.canSave=function(){return""!==l.firstName&&""!==l.lastName&&l.hasChanges()},this.resetUpdate=function(){l.firstName=l.firstNameCopy,l.lastName=l.lastNameCopy,l.formIsEditable=!1},this.resetPassword=function(){t.isJwtTokenSession()?l.resetPasswordDbn():l.resetPasswordHapi()},this.resetPasswordHapi=function(){e.resetPassword(l.user.email).then(function(e){if(200!==e.status)throw new Error("Error when resetting password.");n.go("app.forgot-mail-sent",{email:l.user.email,services:e.data.services})})},this.resetPasswordDbn=function(){o.resetPassword(l.user.email).then(function(e){n.go("app.forgot-mail-sent",{email:l.user.email,services:e.data.services})})},this.handleSaveIdentity=function(){l.verifyUser("reset-profile")},this.handleResetEmail=function(){l.verifyUser("reset-email")},this.handleAccountDeletion=function(){u.openConfirm({width:"350px",template:"app/settings/profile/delete-account/confirm-dialog/confirm-dialog.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"confirm-delete-account-dialog",focusOnOpen:!0}).then(function(){(t.isJwtTokenSession()?o.requestAccountDeletion():e.hapi.post("/v1/reader/users/deletion-request",{userId:t.getUserId()})).then(function(){var e=r.instant("GT_ACCOUNT_DELETION_MSG_DONE");c.success(e,{toastClass:"toast toast-black",timeOut:3e3})}).catch(function(){l.openAccountDeletionError(),u.closeThisDialog()})}).catch(function(){})},this.openAccountDeletionError=function(){u.openConfirm({width:"350px",template:"app/settings/profile/delete-account/error-dialog/error-dialog.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"delete-account-error-dialog",focusOnOpen:!0,controller:["Config",function(e){this.email=e.get("links").filter(function(e){return"accountDeletion"===e.type})[0].url}]}).catch(function(){})},this.verifyUser=function(e){n.go("app.verify-user",{next:e,firstName:l.firstName,lastName:l.lastName})}}]}).state("app.verify-user",{url:"/verify-user?next",templateUrl:"app/settings/profile/verify-user/verify-user.html",controllerAs:"$ctrl",controller:"VerifyUserController",params:{user:{},firstName:null,lastName:null}}).state("app.reset-email",{url:"/reset-email",templateUrl:"app/settings/profile/reset-email/reset-email.html",controllerAs:"$ctrl",controller:"ResetEmailController",resolve:{isVerified:["$q","$state","SessionService",function(e,t,n){if(!n.getUserCriticalToken()&&!n.isJwtTokenSession())return e.when().then(function(){t.go("app.profile")})}]}}).state("app.forgot-mail-sent",{url:"/forgot-mail-sent",templateUrl:"app/settings/profile/forgot-mail-sent.html",controllerAs:"$ctrl",params:{email:"",services:0},controller:["$state","$stateParams",function(e,t){this.email=t.email,this.services=t.services,this.confirm=function(){e.go("app.profile")}}]})}]),angular.module("commons").component("accessCodePanel",{bindings:{cancel:"&",visible:"="},templateUrl:"commons/components/access-code/access-code-panel.html",controller:["$state","API","Library","$translate","toastr","ngDialog","Config",function(t,e,o,i,r,n,a){var s=this;this.currentStep=0,this.code="",this.wrongCode="",this.errorMsg="",this.license=null,this.projects=[],this.validateCode=function(){var n=this;return this.wrongCode=this.code,this.currentStep=1,e.hapi.patch("/v1/reader/licenses/activate",{access_code:this.code,app_studio_id:a.get("appId")}).then(function(e){var e=e.data,t=e.license,e=e.projects;return n.license=t,n.projects=e,o.load()}).then(function(e){n.goToLibrary()}).then(function(){n.handleNewContentAvailablePanel()}).then(function(){var e=i.instant("GT_ACCESS_CODE_CONTENT_AVAILABLE");r.warning(e,{toastClass:"toast-access-code",timeOut:3e3,iconClass:"access-toast-icon"})}).catch(function(){n.currentStep=3})},this.goToLibrary=function(){this.cancel(),t.go("app.library.all"),t.reload(),this.currentStep=0},this.handleNewContentAvailablePanel=function(){n.openConfirm({width:"650px",height:"530px",template:"commons/components/access-code/project-panel/new-content-available.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"access-code-related-projects",focusOnOpen:!0,data:{license:s.license,books:s.projects.map(function(e){return o.getBookByProjectId(e)})},controllerAs:"$ctrl",controller:["ngDialog","$scope","$state","UsersContentsInfos","LicenseService","$translate","Config",function(e,t,n,o,i,r,a){var s=this;this.license=t.ngDialogData.license,this.books=t.ngDialogData.books,this.bookExpireTime=i.calcExpireTime(this.license.endAt)||{},this.openBook=function(e){var t;a.openNewTab()?(t=n.href("reader.book",{book:e}),window.open(t,"_blank")):n.go("reader.book",{book:e}),s.close()},this.addToFavorites=function(t){o.toggleFavourite(t);var e=s.books.find(function(e){return e.project_id===t||e.newapi_id===t});e&&(e.favourite=!e.favourite)},this.isFavourite=function(t){var e=s.books.find(function(e){return e.project_id===t||e.newapi_id===t});return e&&e.favourite},this.getExpireBookHoursOrDays=function(){return"days"===s.bookExpireTime.type?1===s.bookExpireTime.time?r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAY_WR",{days:s.bookExpireTime.time}):r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAYS_WR",{days:s.bookExpireTime.time}):1===s.bookExpireTime.time?r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOUR_WR",{hours:s.bookExpireTime.time}):r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOURS_WR",{hours:s.bookExpireTime.time})},this.getDateFormat=function(){return r.instant("GT_CONTENT_DETAILS_LICENSE_DATE_FORMAT")},this.showBookExpireTime=function(){return!!("days"===s.bookExpireTime.type&&s.bookExpireTime.time<=14||"hours"===s.bookExpireTime.type&&s.license.endAt)},this.close=function(){e.close("access-purchase-projects-dialog",0<arguments.length&&void 0!==arguments[0]?arguments[0]:"")}}]}).catch(function(e){"close"===e&&t.reload()})},this.close=function(){this.cancel(),this.code="",this.currentStep=0}}]}),angular.module("commons").component("footerOptions",{templateUrl:"commons/components/footer-options/footer-options.html",controllerAs:"$ctrl",controller:["LocalStorage","Config","$translate","FirebaseAnalyticsService",function(e,t,n,o){var i=this,r=(this.language=e.get("lang")||"en",this.languages=Object.keys(t.get("languages")),this.termsAndConditionsURL=t.getExternalLink("terms"),this.privacyAndPolicyURL=t.getExternalLink("privacy"),this.contactUsURL=t.getExternalLink("contact"),{en:"commons/img/english-us-uk.svg",fr:"commons/img/fr-flag-icon.png",de:"commons/img/de-flag-icon.png",it:"commons/img/it-flag-icon.png",es:"commons/img/es-flag-icon.png",pt:"commons/img/pt-flag-icon.png",ja:"commons/img/ja-flag-icon.png"});return this.getFlag=function(e){return e=e||i.language,r[e]||"commons/img/missing-flag-icon.png"},this.languagesName=function(e){return e=e||i.language,n.instant("GT_LANGUAGE_OPTIONS_"+e.toUpperCase())},this.setLanguage=function(e){e!==i.language&&(i.language=e,n.use(e),o.languageChanged(e))},this}]}),angular.module("commons").component("gtButton",{bindings:{title:"@",icon:"@",color:"@",textColor:"@",click:"&",disabled:"="},templateUrl:"commons/components/gt-button/gt-button.html",controllerAs:"$ctrl",controller:function(){return this}}),angular.module("commons").component("gtInput",{bindings:{type:"@",form:"<",title:"@",data:"=",condition:"<",compare:"<",icon:"@",link:"@",name:"@",required:"@",disabled:"<",validation:"<",used:"=",badLogin:"<"},transclude:!0,templateUrl:"commons/components/gt-input/gt-input.html",controllerAs:"$ctrl",controller:["$translate",function(e){var t=this,n=/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*\@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/,o=/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?([^\w\s]|_)).{8,}$/;return this.isVisible=!1,this.$onInit=function(){t.isPass=angular.copy(t.type),t.typeTranslation=e.instant("GT_MUST_MATCH_"+t.type.toUpperCase())},this.getPattern=function(){return"email"==t.type?n:"password"==t.isPass&&t.validation&&t.validation.pattern?o:""},this.showPass=function(){t.isVisible=!t.isVisible,t.type=t.isVisible?"text":"password"},this}]}),angular.module("commons").component("gtPagination",{bindings:{totalitems:"<",itemsperpage:"<",selectedpage:"="},templateUrl:"commons/components/gt-pagination/gt-pagination.html",controllerAs:"$ctrl",controller:["$rootScope",function(i){var r=this;return this.$onInit=function(){r.totalPages=Math.ceil(r.totalitems/r.itemsperpage),r.pages=[],r.originalPages=[],r.leftDots=!1,r.rightDots=!1,r.setPage(r.selectedpage),r.isSelected=function(e){return!e&&1===r.selectedpage||e===r.selectedpage}},this.setPage=function(e,t){if(e!=r.selected){if(r.selected||(r.selected=r.selectedpage),7<r.totalPages){var n=[];n.push(r.totalPages-3),n.push(r.totalPages-2),n.push(r.totalPages-1),n.push(r.totalPages),[1,2,3,4].includes(r.selected)?(r.pages=[2,3,4,5],r.rightDots=!0,r.leftDots=!1):n.includes(r.selected)?((n=[]).push(r.totalPages-4),n.push(r.totalPages-3),n.push(r.totalPages-2),n.push(r.totalPages-1),r.pages=n,r.leftDots=!0,r.rightDots=!1):((n=[]).push(r.selected-1),n.push(r.selected),n.push(r.selected+1),r.pages=n,r.rightDots=!0,r.leftDots=!0)}else{r.pages=[];for(var o=1;o<r.totalPages+1;o++)r.pages.push(o)}Number.isInteger(e)?r.selected=e:("right"==e&&(r.selected=r.selected+1),"left"==e&&(r.selected=r.selected-1)),t&&i.$broadcast("page-change",r.selected)}},this}]}),angular.module("commons").component("notificationBanner",{bindings:{config:"<"},templateUrl:"commons/components/notification-banner/notification-banner.html",controllerAs:"$ctrl",controller:["LocalStorage","$rootScope",function(t,n){var o=this;return this.$onInit=function(){o.lang=t.get("lang")},this.close=function(){n.showBanner=!1;var e=t.get("hide-banner")||[];e.push(o.config.id),t.set("hide-banner",e)},this}]}),angular.module("commons").component("toolbar",{bindings:{logout:"&",showaccesscodepanel:"&"},templateUrl:"commons/components/toolbar/toolbar.html",controller:["$scope","$state","SessionService","Config","LocalStorage","$translate","UsersPreferences","FirebaseAnalyticsService","tmhDynamicLocale",function(e,t,n,o,i,r,a,s,c){var u=this,e=(e.$state=t,this.user=n.user,this.language=i.get("lang")||"en",a.get(a.KEY_USER_LANGUAGE)),l=(e&&(this.language=e.value),this.languages=Object.keys(o.get("languages")),this.termsAndConditionsURL=o.getExternalLink("terms"),this.policyURL=o.getExternalLink("privacy"),this.contactURL=o.getExternalLink("contact"),this.isContactEmail=this.contactURL?-1!=this.contactURL.indexOf("@"):null,{en:"commons/img/english-us-uk.svg",fr:"commons/img/fr-flag-icon.png",de:"commons/img/de-flag-icon.png",it:"commons/img/it-flag-icon.png",es:"commons/img/es-flag-icon.png",pt:"commons/img/pt-flag-icon.png",ja:"commons/img/ja-flag-icon.png",_default:"commons/img/missing-flag-icon.png"});this.getFlag=function(e){return e=e||u.language,l[e]||e._default},this.languagesName=function(e){return e=e||u.language,r.instant("GT_LANGUAGE_OPTIONS_"+e.toUpperCase())},this.setLanguage=function(e){return e!==u.language&&(u.language=e,a.set(a.KEY_USER_LANGUAGE,e),r.use(e),s.languageChanged(e),c.set(e)),u.lang=e}}]}),angular.module("commons").directive("copyListener",["FirebaseAnalyticsService",function(n){return{restrict:"A",scope:{book:"<",page:"<"},link:function(t,e){e.on("copy",function(){var e=window.getSelection().toString().length;n.contentCopied("annotation",t.book,t.page,e)}),t.$on("$destroy",function(){e.off("copy")})}}}]),angular.module("commons").directive("ngDraggable",["$document",function(f){return{restrict:"A",scope:{dragOptions:"=ngDraggable"},link:function(e,t){var n,o,i,r,a,s,c,u=0,l=0,d=t[0].offsetWidth,g=t[0].offsetHeight;function p(e){l=e.clientY-o,u=e.clientX-n,i&&(u<i.left?u=i.left:u>i.right-d&&(u=i.right-d),l<i.top?l=i.top:l>i.bottom-g&&(l=i.bottom-g)),t.css({top:l+"px",left:u+"px"}),a&&a(e)}function h(e){f.unbind("mousemove",p),f.unbind("mouseup",h),s&&s(e)}e.dragOptions&&(r=e.dragOptions.start,a=e.dragOptions.drag,s=e.dragOptions.stop,c=e.dragOptions.header,e=e.dragOptions.selector)&&(i=(i=document.querySelector(e)||document.getElementById("iframe-page").contentWindow.document.querySelector(e))&&i.getBoundingClientRect()),c?document.getElementById(c).onmousedown=function(e){e.preventDefault(),n=e.clientX-t[0].offsetLeft,o=e.clientY-t[0].offsetTop,f.on("mousemove",p),f.on("mouseup",h),r&&r(e)}:t.on("mousedown",function(e){e.preventDefault(),n=e.clientX-t[0].offsetLeft,o=e.clientY-t[0].offsetTop,f.on("mousemove",p),f.on("mouseup",h),r&&r(e)})}}}]),angular.module("commons").directive("dropdownMenu",["KeyCodesService",function(h){return{restrict:"A",scope:{},link:function(e,t){for(var i=null,r=null,n=0;n<t.children().length;n++){var o=t.children()[n];"BUTTON"===o.tagName&&(i=o).addEventListener("keydown",g),"UL"===o.tagName&&(r=o).addEventListener("keydown",p)}function a(e){if(e&&e.length)return e[e.length-1]}function s(e){if(e&&e.length)return e[0]}var c=function(e){setTimeout(function(){s(e).setAttribute("tabindex",0),s(e).focus()},10)},u=function(e){var t=!0,n=!1,o=void 0;try{for(var i,r=e[Symbol.iterator]();!(t=(i=r.next()).done);t=!0)i.value.setAttribute("tabindex",-1)}catch(e){n=!0,o=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw o}}},l=function(e){e.setAttribute("tabindex",-1)},d=function(e){setTimeout(function(){a(e).setAttribute("tabindex",0),a(e).focus()},10)};function g(e){var t=r.children;switch(!0){case h.isSpace(e):case h.isEnter(e):case h.isArrowDown(e):i.click(),c(t),e.stopPropagation(),e.preventDefault();break;case h.isArrowUp(e):i.click(),d(t),e.stopPropagation(),e.preventDefault()}}function p(e){var t=r.children,n=Array.prototype.slice.call(r.children).indexOf(document.activeElement),o=Array.prototype.slice.call(t[n].children).find(function(e){return"A"==e.tagName});switch(!0){case h.isEnter(e):o&&o.click();break;case h.isEscape(e):i.focus(),i.click(),u(t);break;case h.isArrowUp(e):0<n&&l(t[n]),--n<0&&(n=t.length-1,l(t[0])),t[n].setAttribute("tabindex",0),t[n].focus(),e.stopPropagation(),e.preventDefault();break;case h.isArrowDown(e):0<=n&&l(t[n]),++n>=t.length&&(n=0,l(t[t.length-1])),t[n].setAttribute("tabindex",0),t[n].focus(),e.stopPropagation(),e.preventDefault();break;case h.isHome(e):c(t),e.stopPropagation(),e.preventDefault();break;case h.isEnd(e):d(t),e.stopPropagation(),e.preventDefault()}}}}}]),angular.module("commons").directive("gtModal",["ngDialog","$sce",function(r,a){return{restrict:"EA",templateUrl:"commons/directives/gt-modal/gt-modal.html",scope:{params:"=",cancelButton:"&",approveButton:"&"},transclude:!0,link:function(e,t,n,o,i){e.params.disabled||t.on("click",function(){r.open({template:"commons/directives/gt-modal/gt-modal-ng-dialog.html",showClose:!1,appendClassName:"open"===e.params.type?"directive-modal-read":"delete"===e.params.type?"directive-modal-delete":"directive-modal-common",resolve:{},className:"ngdialog-theme-default",controllerAs:"$ctrl",controller:function(){var o=this;i(e,function(e){for(var t="",n=0;n<e.length;n++)t+=e[n].outerHTML;o.cloneElement=a.trustAsHtml(t)}),this.modalParams=e.params,this.buttonFunc=function(){e.approveButton(),r.close()},this.close=function(){e.cancelButton(),r.close()}}})})}}}]),angular.module("commons").directive("lazyBackground",["$timeout",function(r){return{restrict:"A",scope:{lazyBackground:"@"},link:function(n,o,i){i.$observe("lazyBackground",function(e){var t=new Image;t.onload=function(){r(function(){n.$apply(function(){i.lazyBackground&&o.css({background:'url("'+e+'") no-repeat center',backgroundSize:"cover"})})})},t.src=e,t.complete&&t.onload()})}}}]),angular.module("commons").directive("lazyImage",["$timeout",function(i){return{restrict:"A",scope:{lazyImage:"@"},link:function(n,o,e){e.$observe("lazyImage",function(e){var t=new Image;t.onload=function(){i(function(){n.$apply(function(){e&&""!=e&&o.attr("src",e)})})},t.src=e,t.complete&&t.onload()})}}}]),angular.module("commons").directive("loadMore",function(){return{restrict:"A",scope:{nextItems:"&"},link:function(e,t){var n=t[0];t.bind("scroll",function(){n.scrollTop+n.offsetHeight+25>=n.scrollHeight&&e.nextItems()})}}}),angular.module("commons").directive("ngOnload",function(){return{restrict:"A",scope:{callback:"&ngOnload"},link:function(e,t){t.one("load",function(){e.callback()})}}}),angular.module("commons").constant("connectWithOidcMutation","\n    mutation connectWithOidc(\n        $clientMutationId: String\n        $distributionChannelId: String!\n        $redirectUri: String!\n        $callbackParams: OidcCallbackParams!\n        $callbackChecks: OidcCallbackChecks!\n        $readerOptionsToken: String\n    ) {\n        connectWithOidc(input: {\n            clientMutationId: $clientMutationId\n            distributionChannelId: $distributionChannelId\n            redirectUri: $redirectUri\n            callbackParams: $callbackParams\n            callbackChecks: $callbackChecks\n            readerOptionsToken: $readerOptionsToken\n        }) {\n            clientMutationId\n            accessToken\n            refreshToken\n            userErrors {\n                code,\n                message,\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("loginMutation","\n    mutation login ($input: LoginInput!) {\n        login (input: $input) {\n            accessToken\n            refreshToken\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("logoutMutation","\n    mutation logout ($input: LogoutInput!) {\n        logout (input: $input) {\n            clientMutationId\n        }\n    }\n"),angular.module("commons").constant("refreshTokenMutation","\n    mutation refreshToken ($input: RefreshTokenInput!) {\n        refreshToken (input: $input) {\n            accessToken\n            clientMutationId\n            refreshToken\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("registerMutation","\n    mutation register ($input: RegisterInput!) {\n        register (input: $input) {\n            clientMutationId\n            user {\n                authenticationProvider\n                createdAt\n                distributionChannels {\n                    androidSessionExpirationTimeoutInSecs\n                    androidSessionInactivityTimeoutInSecs\n                    authConfig {\n                        provider\n                        type\n                    }\n                    conditions {\n                        id\n                        isRequired\n                        link\n                        type\n                        version\n                    }\n                    customSubdomain\n                    externalStoreProvider\n                    hasUserSignedRequiredCondition\n                    iOSSessionExpirationTimeoutInSecs\n                    iOSSessionInactivityTimeoutInSecs\n                    id\n                    logoUrl\n                    maxSessionCountByUser\n                    name\n                    subdomain\n                    webReader3SessionExpirationTimeoutInSecs\n                    webReader3SessionInactivityTimeoutInSecs\n                    workspaceId\n                }\n                email\n                externalStoreProvider\n                firstName\n                id\n                isActivated\n                lastName\n                role\n                updatedAt\n                watermark\n                workspaceId\n            }\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("removeAnnotationMutation","\n    mutation removeAnnotations(\n    $input: RemoveUserDataInput!\n){\n    removeAnnotations(input: $input) {\n        clientMutationId\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("removeBookmarksMutation","\n    mutation removeBookmarks(\n    $input: RemoveUserDataInput!\n){\n    removeBookmarks(input: $input) {\n        clientMutationId\n        bookmarks {\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n        }\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("removeExerciseAnswersMutation","\nmutation removeExerciseAnswers(\n    $input: RemoveUserDataInput!\n){\n    removeExerciseAnswers(input: $input) {\n        clientMutationId\n        exerciseAnswers {\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            score\n            questions\n            currentQuestion\n            submitted\n            scoreType\n            scorePercentage\n            nbQuestions\n            attemptsRemaining\n            difficulty\n            annotationId\n            exerciseId\n        }\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("requestAccountDeletionMutation","\n    mutation requestAccountDeletion ($input: RequestAccountDeletionInput!) {\n        requestAccountDeletion (input: $input) {\n            clientMutationId\n        }\n    }\n"),angular.module("commons").constant("requestChangeEmailMutation","\n    mutation requestChangeEmail ($input: RequestChangeEmailInput!) {\n        requestChangeEmail (input: $input) {\n            clientMutationId\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("requestResetPasswordMutation","\n    mutation requestResetPassword ($input: RequestResetPasswordInput!) {\n        requestResetPassword (input: $input) {\n            clientMutationId\n        }\n    }\n"),angular.module("commons").constant("resendActivationCodeMutation","\n    mutation resendActivationCode(\n        $clientMutationId: String\n        $distributionChannelId: String!\n        $email: String!\n        ) {\n        resendActivationCode(\n            input: {\n            clientMutationId: $clientMutationId\n            distributionChannelId: $distributionChannelId\n            email: $email\n            }\n        ) {\n            clientMutationId\n            userErrors {\n            code\n            message\n            path\n            }\n        }\n        }\n\n"),angular.module("commons").constant("resetPasswordMutation","\n    mutation resetPassword ($input: ResetPasswordInput!) {\n        resetPassword (input: $input) {\n            clientMutationId\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("signConditionMutation","\n        mutation signCondition(\n        $clientMutationId: String\n        $conditionId: ID!\n        $userId: ID!\n    ) {\n        signCondition(input: {\n            clientMutationId: $clientMutationId\n            conditionId: $conditionId\n            userId: $userId\n        }) {\n            clientMutationId\n            userConditionApproval {\n                condition {\n                    id\n                }\n                user {\n                    id\n                }\n                acceptedAt\n            }\n            userErrors {\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("synchronizeUserDatasMutation","\n    mutation synchronizeUserDatas(\n        $clientMutationId: String,\n        $userId: ID!,\n        $distributionChannelId: ID!,\n        $synchronizeTime: Date!,\n        $upsert: InputUpsertSynchronizeUserData,\n        $remove: [ID!]\n    ) {\n        synchronizeUserDatas(input: {\n            clientMutationId: $clientMutationId\n            userId: $userId\n            distributionChannelId: $distributionChannelId\n            synchronizeTime: $synchronizeTime\n            upsert: $upsert\n            remove: $remove\n        }) {\n            clientMutationId\n            synchronizedAt\n            userDatas {\n                __typename\n                id\n                distributionChannelId\n                userId\n                createdAt\n                updatedAt\n                deletedAt\n                updatedByUserAt\n                projectId\n                bookVersion\n                pageId\n                pageNumber\n                pageTitle\n                brokenStatus\n                ... on UserAnnotation {\n                    color\n                    selectedText\n                    noteText\n                    serializedData\n                    highlighter {\n                        name\n                        version\n                    }\n                }\n                ... on UserExerciseAnswer {\n                    score\n                    questions\n                    currentQuestion\n                    submitted\n                    scoreType\n                    scorePercentage\n                    nbQuestions\n                    attemptsRemaining\n                    difficulty\n                    annotationId\n                    exerciseId\n                }\n            }\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("trackEventsMutation","\n    mutation trackEvents (\n        $clientMutationId: String\n        $events: [TrackedEvent!]!\n    ) {\n        trackEvents (input: {\n            clientMutationId: $clientMutationId\n            events: $events\n        }) {\n            clientMutationId\n            userErrors {\n                message\n                code\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("updateIdentityMutation","\n    mutation updateIdentity ($input: UpdateIdentityInput!) {\n        updateIdentity (input: $input) {\n            clientMutationId\n            user {\n                authenticationProvider\n                createdAt\n                distributionChannels {\n                    androidSessionExpirationTimeoutInSecs\n                    androidSessionInactivityTimeoutInSecs\n                    authConfig {\n                        provider\n                        type\n                    }\n                    conditions {\n                        id\n                        isRequired\n                        link\n                        type\n                        version\n                    }\n                    customSubdomain\n                    externalStoreProvider\n                    hasUserSignedRequiredCondition\n                    iOSSessionExpirationTimeoutInSecs\n                    iOSSessionInactivityTimeoutInSecs\n                    id\n                    logoUrl\n                    maxSessionCountByUser\n                    name\n                    subdomain\n                    webReader3SessionExpirationTimeoutInSecs\n                    webReader3SessionInactivityTimeoutInSecs\n                    workspaceId\n                }\n                email\n                externalStoreProvider\n                firstName\n                id\n                isActivated\n                lastName\n                role\n                updatedAt\n                watermark\n                workspaceId\n            }\n        }\n    }\n"),angular.module("commons").constant("updateUserPrintLimit","\n    mutation updateUserPrintLimit(\n        $clientMutationId: String\n        $userId: ID!\n        $sessionKey: String!\n        $usedPages: Int!\n    ) {\n        updateUserPrintLimit(input: {\n            clientMutationId: $clientMutationId,\n            userId: $userId\n            sessionKey: $sessionKey\n            usedPages: $usedPages\n        }) {\n            clientMutationId\n            sessionKey\n            leftToPrint\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("upsertAnnotationMutation","\n    mutation upsertAnnotations(\n    $input: UpsertAnnotationInput!\n){\n    upsertAnnotations(input: $input) {\n        clientMutationId\n        annotations {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            brokenStatus\n            color\n            selectedText\n            noteText\n            serializedData\n            highlighter {\n                name\n                version\n            }\n            cfi\n        }\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("upsertBookmarksMutation","\n    mutation upsertBookmarks(\n    $input: UpsertBookmarkInput!\n){\n    upsertBookmarks(input: $input) {\n        clientMutationId\n        bookmarks {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n        }\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("upsertContentInfosMutation","\n    mutation upsertContentInfos(\n        $clientMutationId: String,\n        $userId: ID!,\n        $contentInfos: [CreateUserContentInfoInput!]!\n    ){\n        upsertContentInfos(input: {\n            clientMutationId: $clientMutationId\n            userId: $userId\n            contentInfos: $contentInfos\n        }) {\n            clientMutationId\n            contentInfos {\n                id\n                createdAt\n                updatedAt\n                distributionChannelId\n                projectId\n                favorite\n                lastOpenPage {\n                    date\n                    pageId\n                    pageTitle\n                }\n                accessibility {\n                    contrastName\n                    fontName\n                    fontSize\n                    volume\n                    speechRate\n                    altMediaEnabled\n                }\n            }\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("upsertExerciseAnswersMutation","\n    mutation upsertExerciseAnswers(\n    $input: UpsertExerciseAnswerInput!\n){\n    upsertExerciseAnswers(input: $input) {\n        clientMutationId\n        exerciseAnswers {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            score\n            questions\n            currentQuestion\n            submitted\n            scoreType\n            scorePercentage\n            nbQuestions\n            attemptsRemaining\n            difficulty\n            annotationId\n            exerciseId\n        }\n        userErrors {\n            code\n            message\n            path\n        }\n    }\n}\n"),angular.module("commons").constant("upsertPreferencesMutation","\n    mutation upsertPreferences(\n        $clientMutationId: String,\n        $userId: ID!,\n        $preferences: [CreateUserPreferenceInput!]!\n    ){\n        upsertPreferences(input: {\n            clientMutationId: $clientMutationId\n            userId: $userId\n            preferences: $preferences\n        }) {\n            clientMutationId\n            preferences {\n                id\n                createdAt\n                updatedAt\n                userId\n                distributionChannelId\n                key\n                value\n            }\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("verifyCredentialsMutation","\n    mutation verifyCredentials ($input: VerifyCredentialsInput!) {\n        verifyCredentials (input: $input) {\n            accessToken\n            refreshToken\n            clientMutationId\n            userErrors {\n                code\n                message\n                path\n            }\n        }\n    }\n"),angular.module("commons").constant("searchAnnotationsQuery","\n    query searchAnnotations($input: SearchPaginationInput!) {\n    searchAnnotations(input: $input) {\n        totalCount\n        edges {\n            cursor\n            node {\n                id\n                distributionChannelId\n                projectId\n                pageId\n                pageTitle\n            }\n        }\n        nodes {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            brokenStatus\n            color\n            selectedText\n            noteText\n            serializedData\n            highlighter {\n                name\n                version\n            }\n            cfi\n        }\n        pageInfo {\n            endCursor\n            hasNextPage\n            hasPreviousPage\n            startCursor\n        }\n    }\n}\n"),angular.module("commons").constant("searchBookmarksQuery","\n    query searchBookmarks($input: SearchPaginationInput!) {\n    searchBookmarks(input: $input) {\n        totalCount\n        edges {\n            cursor\n            node {\n                id\n                distributionChannelId\n                projectId\n                pageId\n                pageTitle\n            }\n        }\n        nodes {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            brokenStatus\n        }\n        pageInfo {\n            endCursor\n            hasNextPage\n            hasPreviousPage\n            startCursor\n        }\n    }\n}\n"),angular.module("commons").constant("distributionChannelConditionsQuery","\n        query distributionChannel(\n            $id: ID!\n        ) {\n            distributionChannel(\n                id: $id\n        ) {\n            conditions {\n                id\n                type\n                link\n                version\n                isRequired\n            }\n        }\n    }\n"),angular.module("commons").constant("searchExerciseAnswers","\nquery searchExerciseAnswers($input: SearchPaginationInput!) {\n    searchExerciseAnswers(input: $input) {\n        totalCount\n        edges {\n            cursor\n            node {\n                id\n                distributionChannelId\n                projectId\n                pageId\n                pageTitle\n            }\n        }\n        nodes {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            deletedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageTitle\n            pageNumber\n            pageNumberRef\n            brokenStatus\n            score\n            questions\n            currentQuestion\n            submitted\n            scoreType\n            scorePercentage\n            nbQuestions\n            attemptsRemaining\n            difficulty\n            annotationId\n            exerciseId\n        }\n        pageInfo {\n            endCursor\n            hasNextPage\n            hasPreviousPage\n            startCursor\n        }\n    }\n}\n"),angular.module("commons").constant("isValidPreviewReaderOptionsTokenQuery","\n    query isValidPreviewReaderOptionsToken(\n        $distributionChannelId: String!\n        $readerOptionsToken: String!\n    ) {\n        isValidPreviewReaderOptionsToken(distributionChannelId: $distributionChannelId, readerOptionsToken: $readerOptionsToken)\n    }\n"),angular.module("commons").constant("meQuery","\n    query me {\n        me {\n            authenticationProvider\n            createdAt\n            distributionChannels {\n                authConfig {\n                    provider\n                    type\n                }\n                conditions {\n                    id\n                    isRequired\n                    link\n                    type\n                    version\n                }\n                customSubdomain\n                externalStoreProvider\n                id\n                logoUrl\n                name\n                subdomain\n                hasUserSignedRequiredCondition\n            }\n            email\n            externalStoreProvider\n            firstName\n            id\n            isActivated\n            lastName\n            role\n            updatedAt\n            watermark\n            workspaceId\n            readerOptions {\n                analytics {\n                    provider\n                }\n                features {\n                    print {\n                        enabled\n                        value\n                    }\n                    mobileDownload {\n                        enabled\n                    }\n                }\n                location {\n                    reference {\n                        type\n                        value\n                    }\n                    pageId\n                }\n                preview\n            }\n            externalUserId\n        }\n    }\n"),angular.module("commons").constant("oidcAuthorizationUrlQuery","\n    query oidcAuthorizationUrl(\n        $distributionChannelId: String!,\n        $redirectUri: String!,\n        $state: String,\n        $nonce: String\n    ) {\n        oidcAuthorizationUrl(\n            distributionChannelId: $distributionChannelId,\n            redirectUri: $redirectUri,\n            state: $state,\n            nonce: $nonce\n        ) {\n            authorizationUrl\n            codeVerifier\n        }\n    }\n"),angular.module("commons").constant("userByEmailInWorkspaceQuery","\n    query userByEmailInWorkspace($email: String!, $workspaceId: String!) {\n        userByEmailInWorkspace(email: $email, workspaceId: $workspaceId) {\n            id\n            createdAt\n            email\n            firstName\n            isActivated\n            lastName\n            role\n            updatedAt\n            watermark\n            workspaceId\n            externalUserId\n        }\n    }\n"),angular.module("commons").constant("userContentInfosQuery","\n    query userContentInfos($userId: ID!, $distributionChannelId: ID!) {\n        userContentInfos(userId: $userId, distributionChannelId: $distributionChannelId) {\n            id\n            createdAt\n            updatedAt\n            userId\n            distributionChannelId\n            projectId\n            favorite\n            lastOpenPage {\n                date\n                pageId\n                pageTitle\n            }\n            accessibility {\n                volume\n                speechRate\n                altMediaEnabled\n            }\n        }\n    }\n"),angular.module("commons").constant("userDatasQuery","\n    query userDatas(\n        $userId: ID!,\n        $before: [StringInt],\n        $after: [StringInt],\n        $first: Int,\n        $last: Int,\n        $sort: UserDataSort,\n        $type: UserDataType,\n        $projectId: String,\n        $distributionChannelId: String,\n        $search: String,\n        $mustIncludeFields: [String!],\n        $mustNotIncludeFields: [String!]\n    ) {\n        userDatas(\n            userId: $userId,\n            before: $before,\n            after: $after\n            first: $first,\n            last: $last,\n            sort: $sort,\n            type: $type,\n            projectId: $projectId,\n            distributionChannelId: $distributionChannelId,\n            search: $search,\n            mustIncludeFields: $mustIncludeFields,\n            mustNotIncludeFields: $mustNotIncludeFields\n        ) {\n            totalCount\n            distinctCount {\n                annotation\n                note\n                bookmark\n                exerciseAnswer\n            }\n            edges {\n                cursor\n                node {\n                    id\n                    distributionChannelId\n                    projectId\n                    pageId\n                    pageTitle\n                }\n            }\n            nodes {\n                __typename\n                id\n                userId\n                distributionChannelId\n                createdAt\n                updatedAt\n                updatedByUserAt\n                projectId\n                bookVersion\n                pageId\n                pageNumber\n                pageTitle\n                pageNumberRef\n                brokenStatus\n                ... on UserAnnotation {\n                    color\n                    selectedText\n                    noteText\n                    serializedData\n                    highlighter {\n                        name\n                        version\n                    }\n                }\n                ... on UserExerciseAnswer {\n                    score\n                    questions\n                    currentQuestion\n                    submitted\n                    scoreType\n                    scorePercentage\n                    nbQuestions\n                    attemptsRemaining\n                    difficulty\n                    annotationId\n                    exerciseId\n                }\n            }\n            pageInfo {\n                endCursor\n                hasNextPage\n                hasPreviousPage\n                startCursor\n            }\n        }\n    }\n"),angular.module("commons").constant("userDatasByPageIdsQuery","\n    query userDatasByPageIds(\n        $userId: ID!\n        $distributionChannelId: ID!\n        $projectId: ID!\n        $pageIds: [String!]!\n    ) {\n        userDatasByPageIds(\n            userId: $userId\n            distributionChannelId: $distributionChannelId\n            projectId: $projectId\n            pageIds: $pageIds\n        ) {\n            __typename\n            id\n            userId\n            distributionChannelId\n            createdAt\n            updatedAt\n            updatedByUserAt\n            projectId\n            bookVersion\n            pageId\n            pageNumber\n            pageTitle\n            brokenStatus\n            ... on UserAnnotation {\n                color\n                selectedText\n                noteText\n                serializedData\n                highlighter {\n                    name\n                    version\n                }\n                cfi\n            }\n            ... on UserExerciseAnswer {\n                score\n                questions\n                currentQuestion\n                submitted\n                scoreType\n                scorePercentage\n                nbQuestions\n                attemptsRemaining\n                difficulty\n                annotationId\n                exerciseId\n            }\n        }\n    }\n"),angular.module("commons").constant("userPreferencesQuery","\n    query userPreferences($userId: ID!, $distributionChannelId: ID!) {\n        userPreferences(userId: $userId, distributionChannelId: $distributionChannelId) {\n            id\n            createdAt\n            updatedAt\n            userId\n            distributionChannelId\n            key\n            value\n        }\n    }\n"),angular.module("commons").constant("userPreviewPagesQuery","\n    query userPreviewPages($distributionChannelId: ID!, $userId: ID!) {\n        userPreviewPages(distributionChannelId: $distributionChannelId, userId: $userId)\n    }\n"),_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Entities",["API",function(t){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"load",value:function(e){return t.hapi.get(e||this.endpoint).then(function(e){return e.data})}},{key:"hapi",value:function(){return t.hapi}}]),e}]);_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}angular.module("commons").factory("Entity",["API",function(n){function o(e,t){_classCallCheck(this,o),this._update(e),this._url=t}return _createClass(o,[{key:"_update",value:function(t){var n=this;this._entity={},Object.keys(t).forEach(function(e){e in["id","$created_at","$updated_at"]||(n._entity[e]=t[e]),n[e]=t[e]})}},{key:"_syncEntity",value:function(){var t=this;Object.keys(this._entity).forEach(function(e){t._entity[e]=t[e]})}},{key:"setProperty",value:function(e,t){this._entity[e]=this[e]=t}},{key:"save",value:function(){var e,t=this;if(this._url)return this._syncEntity(),e="post",this.id&&(e="put"),n.hapi[e](this._url,this._entity).then(function(e){return t._update(e.data),e.data})}},{key:"patch",value:function(e){var t=this;if(this._entity.id)return n.hapi.patch(this._url+"/"+this._entity.id,e).then(function(e){return t._update(e.data),e.data})}}],[{key:"generateUUID",value:function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"")+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}},{key:"hashCode",value:function(e){if(!e||!e.length)return 0;for(var t=void 0,n=0;n<e.length;n++)t=Math.imul(31,t)+e.charCodeAt(n)|0;return""+t}}]),o}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e},STATIC_COLOR_EXPRESSION=/^{((\s|,)*?["'a-zA-Z-]+?\s*?:\s*?('|")[a-zA-Z0-9-.]*('|"))+\s*}$/,_extends=(angular.module("commons").directive("gtColors",["$parse","Theme",function(u,l){return{restrict:"A",require:[],compile:function(e,t){n=t.gtColors,o=-1<n.indexOf("::"),i=o||STATIC_COLOR_EXPRESSION.test(t.gtColors),t.gtColors=n.replace("::","");var n,o,i,c=!o&&!i;return function(e,r,t){function n(){return t.gtColors||(t.gtColors="{}"),u(t.gtColors)(e)}function a(n,o){Object.keys(n).forEach(function(e){var t=o[n[e]],t=t?t.value:n[e];r.css(e,t)})}function o(e,t){var n,o,i;e.hover&&(n=_extends({},e.hover),delete e.hover,r[0].removeEventListener("mouseover",o=function(){a(n,t)},!(i=function(){Object.keys(n).forEach(function(e){r.css(e,"")}),a(e,t)})),r[0].removeEventListener("mouseout",i,!1),r[0].addEventListener("mouseover",o,!1),r[0].addEventListener("mouseout",i,!1))}e.$on("$destroy",function(){angular.noop()}),e.$on("theme-changed",function(){var e=l.getTheme();a(n(),e)});try{var i=l.getTheme(),s=n();o(s,i),c?e.$watch(n,function(){a(n(),i)},!0):a(s,i)}catch(e){console.error(e)}}}}}]),Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}),_createClass=function(){function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rgbaToHsla(e,t,n,o){e/=255,t/=255,n/=255;var i=Math.max(e,t,n),r=Math.min(e,t,n),a=void 0,s=void 0,c=(i+r)/2;if(i===r)a=s=0;else{var u=i-r,s=.5<c?u/(2-i-r):u/(i+r);switch(i){case e:a=(t-n)/u+(t<n?6:0);break;case t:a=(n-e)/u+2;break;case n:a=(e-t)/u+4}a/=6}return[a,s,c,o]}function hslaToRgba(e,t,n,o){var i,r=void 0,a=void 0,s=void 0;return 0===t?r=a=s=n:(r=(i=function(e,t,n){return n<0&&(n+=1),1<n&&--n,n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e})(t=2*n-(n=n<.5?n*(1+t):n+t-n*t),n,e+1/3),a=i(t,n,e),s=i(t,n,e-1/3)),[Math.round(255*r),Math.round(255*a),Math.round(255*s),o]}function hexToRgbaArray(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return[parseInt(e.slice(1,3),16),parseInt(e.slice(3,5),16),parseInt(e.slice(5,7),16),t]}function rgbaToArray(e){return e.slice(5,-1).split(",").map(Number)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("commons").factory("Theme",["$rootScope",function(t){function e(){_classCallCheck(this,e),this._theme={primaryColor:{value:"red"},secondaryColor:{value:"blue"},textColor:{value:"#34495e"}}}return _createClass(e,[{key:"getTheme",value:function(){return this._theme}},{key:"setTheme",value:function(e){this._theme=_extends(this._theme,e),t.$broadcast("theme-changed")}},{key:"setLightenedPrimaryColor",value:function(){var e=this._theme.primaryColor.value,t=[],t=(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e)?hexToRgbaArray:rgbaToArray)(e),e=rgbaToHsla.apply(void 0,_toConsumableArray(t));e[2]+=.35,1<e[2]&&(e[2]=1);t="rgba("+hslaToRgba.apply(void 0,_toConsumableArray(e)).join(",")+")";document.documentElement.style.setProperty("--lightened-primary-color",t)}}]),new e}]),angular.module("app").component("assignmentInfo",{bindings:{assignment:"<",closeCallback:"<"},templateUrl:"app/assignments/components/assignment-info/assignment-info.html",controller:["$state","LegacySyncService","Library","FirebaseAnalyticsService",function(e,t,n,o){var i=this;this.moreInfo=!1,this.sync={notes:0,highlights:0,bookmarks:0},this.$onChanges=function(){i.assignment&&(i.sync={notes:0,highlights:0,bookmarks:0},i.book=n.getBookByLMSId(i.assignment.getLMSId()),i.book.getStructure().then(function(){var e=t.getSyncDataByContext({book:i.book.book_content_id,assignment:i.assignment.id});i.sync.notes=e.notes.length,i.sync.bookmarks=e.bookmarks.length,i.sync.highlights=e.highlights.length}))},this.closeInfo=function(){"function"==typeof i.closeCallback&&i.closeCallback.apply()},this.goToReader=function(){o.bookOpened(i.book,"infos","distribution"),e.go("reader.book",{book:i.book.book_content_id,assignment:i.assignment?i.assignment.id:void 0})},this.goToHighlights=function(){e.go("reader.userinput.highlights",{book:i.book.book_content_id,assignment:i.assignment?i.assignment.id:void 0})},this.goToNotes=function(){e.go("reader.userinput.notes",{book:i.book.book_content_id,assignment:i.assignment?i.assignment.id:void 0})},this.goToBookmarks=function(){e.go("reader.userinput.bookmarks",{book:i.book.book_content_id,assignment:i.assignment?i.assignment.id:void 0})}}]}),angular.module("app").component("assignmentList",{bindings:{assignments:"="},templateUrl:"app/assignments/components/assignment-list/assignment-list.html",controller:function(){}}),angular.module("app").component("assignmentTile",{bindings:{assignment:"="},templateUrl:"app/assignments/components/assignment-tile/assignment-tile.html",controller:["$state","$rootScope","Library","LocalStorage","API","FirebaseAnalyticsService",function(e,t,n,o,i,r){var a=this;this.$onInit=function(){a.book=n.getBookByLMSId(a.assignment.getLMSId()),a.cover=a.book?a.book.cover:void 0;var e=1,e=a.book.infos?a.book.infos.pages.length:a.book.contents?a.book.contents.length:1;a.progress=+(100*a.assignment.pagesRead/e).toFixed(0)||0,a.isNew=o.get(a.assignment.id),a.today=Date.now(),a.due=new Date(a.assignment.due_date).getTime(),a.start=new Date(a.assignment.start_date).getTime(),a.moreInfo=!1},this.showInfo=function(){t.$broadcast("show-assignment-info-panel",a.assignment),r.bookInfosOpened(a.book,"infos","assignment")},this.read=function(){r.bookOpened(a.book,"card","assignment"),e.go("reader.book",{book:a.book.book_content_id,assignment:a.assignment.id})},this.goToReport=function(){window.open(i.getCorrectionSrc(a.assignment.id,o.get("lang")),"_blank")}}]}),angular.module("app").component("bookFilters",{bindings:{view:"=",sort:"=",filter:"=",filterVisible:"=",updateBooks:"&",metaFilters:"=",resetFilters:"&"},templateUrl:"app/library/components/book-filters/book-filters.html",controller:["LocalStorage","$rootScope","UsersPreferences","SessionService","KeyCodesService","FirebaseAnalyticsService",function(t,n,o,e,i,r){var a=this;this.$onInit=function(){n.Config.hasScreenSorter("shelf")?a.sortFilters=a.sortFiltersId(n.Config.getScreenSorter("shelf")):a.sortFilters=[{enabled:!0,label:"GT_SORT_LAST_OPEN",target:"last_open_date",orderBy:"desc",id:"0"},{enabled:!0,label:"GT_SORT_LAST_ADDED_TO_LIB",target:"$updated_at",orderBy:"desc",id:"1"},{enabled:!0,label:"GT_SORT_TITLE_AZ",target:"title",orderBy:"asc",id:"2"},{enabled:!0,label:"GT_SORT_TITLE_ZA",target:"title",orderBy:"desc",id:"3"}];var e=o.get(o.KEY_DESK_BOOK_SORTER);e&&(e=a.sortMethodConfig(e.value))?a.sort=e:a.applyFilter()},this.isLMS=function(){return e.getLMS()},this.sortMethodConfig=function(t){return a.sortFilters.find(function(e){return e.label===t})},this.openFilterMenu=function(e){a.filterVisible=!0,i.isEnter(e)&&document.getElementById("close-filters").focus()},this.filterChange=function(e){e&&r.searchFromLibrary(e)},this.sortFiltersId=function(e){return e.forEach(function(e,t){e.id=t}),e},this.defineSortMethod=function(e){a.sort=e,o.set(o.KEY_DESK_BOOK_SORTER,a.sort.label)},this.changeView=function(e){t.set("view",e),a.view=e},this.applyFilter=function(){n.Config.hasScreenSorter("shelf")?a.sort=a.sortMethodConfig(n.Config.getCurrentScreenSorter("shelf")):a.sort=a.sortFilters[0]}}]}),angular.module("app").component("bookInfo",{bindings:{book:"<",closeCallback:"<"},templateUrl:"app/library/components/book-info/book-info.html",controller:["$state","Config","LegacySyncService","PaginationService","UsersContentsInfos","$translate","FirebaseAnalyticsService",function(t,n,o,e,i,r,a){var s=this;this.moreInfo=!1,this.sync={notes:0,highlights:0,bookmarks:0},this.highlightsActivated=!0,this.notesActivated=!0,this.bookmarksActivated=!0,this.bookTitle=function(){return s.book.getTitle()},this.getDateFormat=function(){return r.instant("GT_CONTENT_DETAILS_LICENSE_DATE_FORMAT")},this.getHourFormat=function(){return r.instant("GT_CONTENT_DETAILS_LICENSE_HOUR_FORMAT")},this.showBookExpireTime=function(e){e=s.book.getLicenseTimeExpire(e);return"days"===e.type&&e.time<=14||"hours"===e.type},this.getExpireBookHoursOrDays=function(e){e=s.book.getLicenseTimeExpire(e);return"days"===e.type?1===e.time?r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAY_WR",{days:e.time}):r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAYS_WR",{days:e.time}):1===e.time?r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOUR_WR",{hours:e.time}):r.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOURS_WR",{hours:e.time})},this.getLicenses=function(){return s.book.getActiveLicenseAndOthers()},this.hasActiveLicense=function(){return Object.keys(s.getLicenses().active).length},this.$onChanges=function(){s.book&&(s.sync={notes:0,highlights:0,bookmarks:0},n.hasUsersDataMigratedToDbn()?(e.setSharingId(s.book.project_id),e.getTotals().then(function(){e.setSharingId(),s.sync.notes=e.distinctCount.note,s.sync.bookmarks=e.distinctCount.bookmark,s.sync.highlights=e.distinctCount.annotation-e.distinctCount.note})):s.book.getStructure().then(function(){var e=o.getSyncDataByContext({book:s.book.book_content_id});s.sync.notes=e.notes.length,s.sync.bookmarks=e.bookmarks.length,s.sync.highlights=e.highlights.length}),s.book.getFeatures(s.book.version).then(function(){s.highlightsActivated=s.book.readerHighlightFeature(),s.notesActivated=s.book.readerNoteFeature(),s.bookmarksActivated=s.book.readerBookmarkFeature()}))},this.closeInfo=function(){"function"==typeof s.closeCallback&&s.closeCallback.apply()},this.toggleFavourite=function(){i.toggleFavourite(s.book.getSharingId()),s.book.favourite=!s.book.favourite},this.goToReader=function(){var e;a.bookOpened(s.book,"infos","distribution"),n.openNewTab()?(e=t.href("reader.book",{book:s.book.book_content_id}),window.open(e,"_blank")):t.go("reader.book",{book:s.book.book_content_id})}}]}),angular.module("app").component("bookList",{bindings:{books:"=",sort:"=",view:"=",filter:"=",filterVisible:"="},templateUrl:"app/library/components/book-list/book-list.html",controller:["$window","$scope",function(e,t){var n=this;this.limitProjects=40,this.$onInit=function(){angular.element(e).on("scroll",n.onScroll)},this.$onDestroy=function(){angular.element(e).off("scroll",n.onScroll)},this.orderByFunction=function(){return n.sort?[("desc"===n.sort.orderBy?"-":"")+n.sort.target,"title"]:"title"},this.loadMore=function(){n.limitProjects+40>n.books.length?(n.limitProjects=n.books.length,angular.element(e).off("scroll",n.onScroll)):n.limitProjects+=40,t.$applyAsync()},this.onScroll=function(){var e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight),t=window.scrollY+window.innerHeight;t-5<e&&e<t+5&&n.loadMore()}}]}),angular.module("app").component("bookTile",{bindings:{book:"=",view:"="},templateUrl:"app/library/components/book-tile/book-tile.html",controller:["$rootScope","$state","UsersContentsInfos","Config","$translate","FirebaseAnalyticsService",function(e,t,n,o,i,r){var a=this;this.$onInit=function(){a.book.favourite=n.isFavourite(a.book.getSharingId()),a.isNewContent=a.book.isNewContent(),a.bookTitle=a.book.getTitle(),a.activeLicense=a.book.getActiveLicenseAndOthers().active,a.bookExpireTime=a.book.getLicenseTimeExpire(a.activeLicense.endDate)},this.showInfo=function(){e.$broadcast("show-info-panel",a.book),r.bookInfosOpened(a.book,"infos","distribution")},this.toggleFavourite=function(e){e.stopPropagation(),n.toggleFavourite(a.book.getSharingId()),a.book.favourite=!a.book.favourite},this.getExpireBookHoursOrDays=function(){return"days"===a.bookExpireTime.type?1===a.bookExpireTime.time?i.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAY_LABEL_WR",{days:a.bookExpireTime.time}):i.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_DAYS_LABEL_WR",{days:a.bookExpireTime.time}):1===a.bookExpireTime.time?i.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOUR_LABEL_WR",{hours:a.bookExpireTime.time}):i.instant("GT_CONTENT_DETAILS_LICENSE_END_EXPIRE_HOURS_LABEL_WR",{hours:a.bookExpireTime.time})},this.showBookExpireTime=function(){return"days"===a.bookExpireTime.type&&a.bookExpireTime.time<=14||"hours"===a.bookExpireTime.type},this.goToReader=function(){var e;o.openNewTab()?(e=t.href("reader.book",{book:a.book.book_content_id}),window.open(e,"_blank")):t.go("reader.book",{book:a.book.book_content_id}),r.bookOpened(a.book,"card","distribution")}}]}),angular.module("app").component("metadataFilters",{bindings:{onUpdate:"&",filters:"=",resetFilters:"&"},templateUrl:"app/library/components/metadata-filters/metadata-filters.html",controller:["FilterService","KeyCodesService",function(e,n){var o=this;this.$onInit=function(){o.filter=e.getFilter(),o.mappedFilters=e.getMappedFilters(),o.read=!1,o.unread=!1},this.update=function(){e.filterBooks(o.filters),o.onUpdate()},this.composeId=function(e,t,n){return(e+"-"+t+"-"+n).replace(/\s+/g,"")},this.getFilterLength=function(){return o.filters.length},this.getMetasLength=function(e){var t,n=0;for(t in o.mappedFilters)o.mappedFilters[t].name===e&&(n+=o.mappedFilters[t].ids.length);return n},this.resetSelections=function(){Object.keys(o.mappedFilters).map(function(e){return e.split("_").join("")}).forEach(function(e){o.selectMeta&&o.selectMeta[e]&&(o.selectMeta[e]=!1)})},this.getFilterNumber=function(e,t){e=e+"_"+t;return o.mappedFilters[e]?o.mappedFilters[e].ids.length:0},this.toggleCheckboxWithKeyboard=function(e,t){e.preventDefault(),(n.isSpace(e)||"click"===e.type&&0===e.button)&&document.getElementById(t).click()},this.applyFilters=function(t,e){var n;o.filters.length&&!e?0<=(n=o.filters.findIndex(function(e){return e.name===t.name&&e.value===t.value}))&&(o.filters.splice(n,1),o.update()):e&&(o.filters.push(t),o.update())},this.reset=function(){o.read=!1,o.unread=!1,o.resetSelections(),o.resetFilters()}}]}),angular.module("app").component("assignmentEvaluation",{bindings:{assignment:"="},templateUrl:"app/reader/components/assignment-evaluation/assignment-evaluation.html",controllerAs:"$ctrl",controller:["Evaluation","$window","$scope","$state",function(e,t,n,r){var a=this;return this.$onInit=function(){var i;"evaluation"==a.assignment.type&&(a.evaluation=new e(a.assignment),a.evaluation.start(),a.finished=!1,a.evaluation.onFinish(function(){a.finished=!0,alert("Evaluation finished."),r.go("app.assignments.all")}),t.onbeforeunload=function(){if(!a.evaluation.isFinished()&&!a.evaluation.options.user_can_leave)return""},t.onunload=function(){return a.evaluation.pause()},n.$on("$destroy",function(){a.evaluation.pause(),"function"==typeof i&&i()}),i=n.$on("$stateChangeStart",function(e,t,n,o){if(!a.evaluation.isFinished()&&!a.evaluation.assignment.submitted&&!(0<=o.name.indexOf(t.name))&&(a.evaluation.options.user_can_leave||!a.evaluation.isFinished())){if(a.evaluation.options.user_can_leave&&!a.evaluation.isFinished()){if(e.preventDefault(),confirm("Warning! Are you sure you want to leave this session?"))return i(),void r.go(t,n)}else if(e.preventDefault(),confirm('Do you really want to quit the page? Evaluation will be marqued as "finished".'))return i(),void r.go(t,n);return!1}}))},this}]}),angular.module("app").component("goToPage",{bindings:{book:"<",chapterPreview:"<"},templateUrl:"app/reader/components/go-to-page/go-to-page.html",controllerAs:"$ctrl",controller:["$state","TocService","ngDialog","$rootScope","$translate",function(o,t,n,e,i){var r=this;this.$onInit=function(){r.structureVersion=r.book.structure.version,r.structureContent=r.book.structure.content,r.pages=r.book.pages,r.uniquePages=[].concat(_toConsumableArray(new Set(r.pages.map(function(e){return e.path})))),r.lastPage=r.pages[r.pages.length-1],r.lastPageNumber=Number(r.lastPage.logicalPageNumber),r.pageNumber=null,r.totalPageNumber=r.uniquePages.length,r.hasLogicalPageNumber=!(!r.structureContent[0]||!r.structureContent[0].logicalPageNumber),r.structureVersion&&(r.book.hasPageBreak?(r.totalPageNumber=r.book.countPages.length,r.uniquePages=r.book.countPages):(r.totalPageNumber=r.book.navigationPages.length,r.uniquePages=r.book.navigationPages),r.lastPage=r.uniquePages[r.uniquePages.length-1],r.lastPageNumber=Number(r.lastPage)),e.$on("$locationChangeSuccess",function(){r.actualPageNumber(),r.getIndexOfPage()})},this.keyup=function(){var e=document.getElementById("go-to-page-input").value;document.getElementById("go-to-page-input").setAttribute("aria-label",e)},this.getIndexOfPage=function(){var t=r.book.getPage(o.params.page);if(t)return r.structureVersion?r.uniquePages.findIndex(function(e){return e.pageId===t.pageId})+1:r.uniquePages.findIndex(function(e){return e==t.path})+1};return this.actualPageNumber=function(){var t=r.book.getPage(o.params.page);if(t){if(r.structureVersion){var n=t.target,e=r.uniquePages.find(function(e){return e.target.includes(n)});return e?e.num:void 0}return t.logicalPageNumber||(r.book.isEpubFixed()&&!r.structureVersion?r.uniquePages.findIndex(function(e){return e==t.path})+1:r.pages.findIndex(function(e){return e.path==t.path})+1)}},this.getLogicalPageNumber=function(e,t){for(var n=null,o=0;o<e.length;){var i=e[o];if(i.logicalPageNumber==t&&(n=i),Number(t)>r.lastPageNumber&&!isNaN(r.lastPageNumber)&&Number(t)<=r.totalPageNumber&&(n=r.book.getPage(r.uniquePages[t-1])),n=i.content?r.getLogicalPageNumber(i.content,t):n)break;o++}return n},this.getPageByNumber=function(){var t,e;if(r.structureContent.length)return r.structureVersion?r.uniquePages.find(function(e){return e.num===r.pageNumber}):r.structureContent[0].logicalPageNumber?r.getLogicalPageNumber(r.structureContent,r.pageNumber):r.book.isEpubFixed()&&!r.structureVersion?(t=r.uniquePages[r.pageNumber-1],r.pages.find(function(e){return e.path===t})):(e=r.pageNumber-1,r.pages[e])},this.goToPage=function(){var e=r.getPageByNumber();if(!e)return r.pageNumber=r.actualPageNumber();r.chapterPreview.enabled&&!r.chapterPreview.pages.includes(e.path||e.pageId)?n.openConfirm({template:i.instant("GT_CHAPTER_PREVIEW_PAGE_NOT_AVAILABLE"),plain:!0,closeByDocument:!0,closeByEscape:!0,showClose:!0,width:"35%",focusOnOpen:!0}):(o.go("reader.book.page",{page:e.path||e.pageId,scrollTo:null}),t.scrollOnPage(e.path||e.pageId),document.getElementById("iframe-page").focus())},this}]}),angular.module("app").component("printPages",{bindings:{book:"<",disabled:"<",singlePagePrint:"<"},templateUrl:"app/reader/components/print-pages/print-pages.html",controllerAs:"$ctrl",controller:["ngDialog","API","SessionService","User","LocalStorage",function(i,r,a,s,c){var u=this;return this.$onInit=function(){var e=u.book,t=u.singlePagePrint,n=c.get("lang")||"en",o=!1;u.openPrintModal=function(){u.disabled||o||(o=!0,i.open({template:"app/reader/components/print-pages/print-pages-modal.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default print-modal",width:"pt"===n?"395px":"330px",showClose:!1,ariaRole:"dialog",preCloseCallback:function(){o=!1},resolve:{book:function(){return e},userAPI:function(){return r.getUser().then(function(e){return a.user=new s(e)})},singlePagePrint:function(){return t}},controller:"PrintController"}))}},this}]}).controller("PrintController",["book","$scope","$state","$sce","SessionService","Config","$translate","PrintService","StatisticsService","$timeout","singlePagePrint","Iframe","UserService",function(i,r,a,s,c,e,o,u,l,t,n,d,g){var p=this,h=(this.displayError="",this.structureVersion=i.structure.version,i.structure.content),n=(this.countPages=i.countPages,this.singlePagePrint=n,this.structureVersion?i.countPages:i.pages),f=c.getToken(),m=[].concat(_toConsumableArray(new Set(n.map(function(e){return e.path})))),b=n[n.length-1],v=n.findIndex(function(e){return e.id==b.id}),I=Number(b.logicalPageNumber),y=e.get("appId"),k=c.getUser(),_=10,T=null,E=k.apps.find(function(e,t){return T=t,e.id===y}),S=(E.print&&E.print.token===f?_=E.print.limit:(n={limit:_,token:f},k.apps[T].print=n,c.user=k),this.getPage=function(e){var t=i.getPage(e);return p.structureVersion?p.countPages.find(function(e){return e.target.includes(t.target)}):t},this.actualPageNumber=function(e){var e=e||a.params.page,t=p.getPage(e);if(t)return t.logicalPageNumber&&t.isPage?t.logicalPageNumber:t.num||i.pages.findIndex(function(e){return e.path==t.path})+1},this.fromPage=this.actualPageNumber(null),this.getPageByNumber=function(e){if(h.length)return h[0].logicalPageNumber?p.getLogicalPageNumber(h,e):p.getPage(a.params.page)},this.getLogicalPageNumber=function(e,t){var n=null;return e.forEach(function(e){!n&&e.isPage&&(e.logicalPageNumber==t&&(n=e),Number(t)>I&&!isNaN(I)&&Number(t)<=p.totalPageNumber&&(n=p.book.getPage(m[t-1])),e.content)&&(n=p.getLogicalPageNumber(e.content,t))}),n},this.getIndexOfPage=function(t){if(t)return p.structureVersion?i.countPages.findIndex(function(e){return e.target==t.target}):m.findIndex(function(e){return e==t.path})+1},this.convertPageToIndex=function(t,e){var n=p.structureVersion?i.countPages.find(function(e){return e.num==t}):p.getPageByNumber(t);return n?p.getIndexOfPage(n):(n=m[t-1])?(n=p.actualPageNumber(n),e?p.fromPage=n:p.toPage=n,e=p.getPageByNumber(n),p.getIndexOfPage(e)):void 0},this.validateInputs=function(){t(function(){if(p.toPage&&p.fromPage){var e;if("0"!=p.fromPage.toString().charAt(0)&&"0"!=p.toPage.toString().charAt(0))return p.structureVersion?(p.firstPage=i.getCountPageByNum(p.fromPage),p.lastPage=i.getCountPageByNum(p.toPage),p.validateError=!1,p.displayError=p.firstPage&&p.lastPage?S():o.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE")):i.isNativeGtContent()?(e=a.params.pageId,p.firstPage=e,p.lastPage=e,void(p.validateError=!1)):(p.firstPage=p.convertPageToIndex(p.fromPage,!0),p.lastPage=p.convertPageToIndex(p.toPage,!1),p.validateError=!1,p.firstPage&&p.lastPage?p.validateFromToPages():p.displayError=o.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE"));p.displayError=o.instant("GT_BOOK_PRINT_INVALID_PAGE_RANGE")}else p.displayError="",p.validateError=!0},1e3)},function(){var e=p.convertPageToIndex(p.firstPage.num),t=(A(p.firstPage),p.convertPageToIndex(p.toPage)),n=_+o.instant("GT_BOOK_PRINT_PAGES_LEFT");return n=t-e<_?!t||e<=t?"":o.instant("GT_BOOK_PRINT_FROM_TO_PAGES"):n}),A=(this.validateFromToPages=function(){return p.displayError=o.instant("GT_BOOK_PRINT_FROM_TO_PAGES"),!p.lastPage||p.firstPage<=p.lastPage?p.totalPrintPages():p.displayError},this.totalPrintPages=function(){return p.displayError=_+o.instant("GT_BOOK_PRINT_PAGES_LEFT"),p.lastPage-p.firstPage<_?p.displayError="":p.displayError},this.isPrintDisabled=function(){var e=Boolean(p.displayError||p.validateError||!1),t=document.getElementById("printPagesButton");return setTimeout(function(){t.setAttribute("disabled",e)}),e},this.getDefaultToPage=function(){var e;if(_)return p.fromPage?(A(p.fromPage),void p.validateInputs()):p.toPage=null;e=p.singlePagePrint?"GT_BOOK_PRINT_SESSION_LIMIT":"GT_BOOK_PRINT_NO_MORE_PAGES",p.displayError=o.instant(e),p.disableInputs=!0,p.toPage=null,p.fromPage=null},function(e){var t,e=p.convertPageToIndex(e);p.structureVersion?(t=1==_?e:e+_-1,(t=i.countPages[t=v<t?v:t])&&(p.toPage=t.num)):isNaN(Number(p.fromPage))?(t=m[e+_-2],p.toPage=p.actualPageNumber(t)):(e=(Number(p.fromPage)+_-1).toString(),p.toPage=I<e?I:e)});this.getDefaultToPage(),this.print=function(){var e,t,n,o;p.isPrintDisabled()||(n=void 0,e={project_id:i.project_id,app_id:E.id,book_content_id:i.book_content_id,book_version:i.version},p.singlePagePrint?(t=(o=a.params).page,n=o.pageId||t,p.iFrameSrc=s.trustAsResourceUrl(d.iframe.src)):(e.fromPageId=m[p.firstPage-1]||p.firstPage.id,e.toPageId=m[p.lastPage-1]||p.lastPage.id,n=m[p.firstPage-1]||p.firstPage.id,p.iFrameSrc=s.trustAsResourceUrl(u.getPrintTemplateUrl(e))),l.printEvent({pageId:n,bookId:i.project_id||i.id,bookISBN:i.isbn,value:p.singlePagePrint?1:p.lastPage-p.firstPage+1}),o=void(p.validateError=!0),o=p.singlePagePrint?(k.apps[T].print.limit=_-1,1):(p.structureVersion||(k.apps[T].print.limit=_-(p.lastPage-p.firstPage+1)),p.lastPage-p.firstPage+1),g.updateUserPrintLimit(k.id,{apps:k.apps},o).then(function(){c.user=k}))},this.onFrameLoad=function(){t(function(){var e,t,n,o=document.getElementById("iframe-print-page");p.singlePagePrint&&(n=a.params.pageId,n=i.getPage(n),n=i.getHeaderParams(n),(e=document.createElement("div")).classList.add("printed-header"),(t=document.createElement("span")).classList.add("printed-span"),t.innerHTML="Book Title: "+n.title,e.appendChild(t),(t=document.createElement("span")).classList.add("printed-span"),t.innerHTML=n.chapterTitle,e.appendChild(t),n.sectionTitle&&((t=document.createElement("span")).classList.add("printed-span"),t.innerHTML=n.sectionTitle,e.appendChild(t)),(n=document.createElement("style")).appendChild(document.createTextNode("\n                    .printed-header {\n                        align-items: flex-start;\n                        float: none;\n                        display: inline-grid;\n                        margin: 0 !important;\n                        padding: 10px;\n                        border: 10px solid white;\n                        box-sizing: border-box;\n                        justify-content: start;\n                        flex-direction: column;\n                        position: relative;\n                        min-width: 100%;\n                        text-align: start;\n                        vertical-align: middle;\n                        page-break-after: auto !important;\n                        background-color: #EDECED;\n                    }\n                    .printed-span {\n                        margin-left: 10px\n                    }\n                    .printed-content {\n                        margin: 0 !important;\n                        padding: 0 !important;\n                        text-align: center;\n                        float: none\n\n                    }\n                ")),o.contentWindow.document.head.appendChild(n),o.contentWindow.document.body.prepend(e)),o.contentWindow.document.execCommand("print",!1,null)||o.contentWindow.print(),r.closeThisDialog()},1e3)}}]),angular.module("app").component("readAloud",{bindings:{expanded:"<",showOptions:"<",listener:"<"},templateUrl:"app/reader/components/read-aloud/read-aloud.html",controller:["Iframe","$rootScope","$scope","ReadSpeakerService","StatisticsService","$state","Library","$timeout","$translate","KeyCodesService",function(t,e,i,r,n,o,a,s,c,u){function l(t){s(function(){var e;d.expanded?(e=angular.element(document.getElementsByClassName(t))[0])&&e.focus():(e=angular.element(document.getElementsByClassName(t))[1])&&e.focus()})}var d=this,g=o.params.page,p=a.getBookByContentId(o.params.book),h=(this.isFirefox="undefined"!=typeof InstallTrigger,r.displayMainPlay(!1),this.ariaLive=this.isFirefox?"off":"polite",this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this),f=(this.languages=[],this.mappedLanguages=[],this.activeLanguage=null,this.progress=0,this.showReadAloudMenu=!1,this.readspeakerSpeed=[{type:"70",name:c.instant("GT_VOCAL_SYNTHESIS_SLOW_TITLE")},{type:"100",name:c.instant("GT_VOCAL_SYNTHESIS_NORMAL_TITLE")},{type:"140",name:c.instant("GT_VOCAL_SYNTHESIS_FAST_TITLE")}],{Kate:c.instant("GT_READ_ALOUD_US_FEMALE_VOICE"),en_gb_brian:c.instant("GT_READ_ALOUD_UK_MALE_VOICE"),Jack:c.instant("GT_READ_ALOUD_AU_MALE_VOICE"),Paul:c.instant("GT_READ_ALOUD_US_MALE_VOICE")}),m=Object.keys(f);this.speed=this.readspeakerSpeed[1].type,this.changeLanguage=function(e){e&&(r.resetState(),d.progress=0,t.iframe.contentWindow.postMessage({type:"changeLang",params:{language:e}},"*"),r.voiceLang=e.name)},window.addEventListener("message",function(e){var t,n,o;e&&e.data&&"stop"===e.data.type&&(r.setState("stop","stop"),i.$apply()),e&&e.data&&"langs"===e.data.type&&(h.languages=e.data.params?e.data.params.langs:[],h.defaultLang=r.voiceLang,t=angular.copy(h.languages),o=Object.keys(h.languages).map(function(e){return t[e].lang=e,t[e]}),h.mappedLanguages=[].concat.apply([],o).map(function(e){if(0<=m.indexOf(e.voice))return e.voice===h.defaultLang&&(h.defaultLang=f[e.voice]),e.name=e.voice,e.lang=e.lang||"en_us",e.voice=f[e.voice],e}),o=h.mappedLanguages.map(function(e){return e.voice}).indexOf(h.defaultLang),h.activeLanguage=-1!==o?h.mappedLanguages[o]:h.mappedLanguages[2],h.changeLanguage(h.activeLanguage)),e&&e.data&&"timeupdated"===e.data.type&&(h.progress=e.data.params?e.data.params.percentage:0,i.$apply()),e&&e.data&&"spechSpeed"===e.data.type&&(n=e.data.params.spechSpeed,o=h.readspeakerSpeed.find(function(e){return e.type===n}))&&(h.speed=o.type)},!1);document.addEventListener("keydown",function(e){d.expanded&&d.listener&&(u.isArrowLeft(e)?["tab0","label-tab-0"].includes(document.activeElement.id)?(document.getElementById("label-tab-2").click(),document.getElementById("label-tab-2").focus()):["tab1","label-tab-1"].includes(document.activeElement.id)?(document.getElementById("label-tab-0").click(),document.getElementById("label-tab-0").focus()):["tab2","label-tab-2"].includes(document.activeElement.id)&&(document.getElementById("label-tab-1").click(),document.getElementById("label-tab-1").focus()):u.isArrowRight(e)&&(["tab0","label-tab-0"].includes(document.activeElement.id)?(document.getElementById("label-tab-1").click(),document.getElementById("label-tab-1").focus()):["tab1","label-tab-1"].includes(document.activeElement.id)?(document.getElementById("label-tab-2").click(),document.getElementById("label-tab-2").focus()):["tab2","label-tab-2"].includes(document.activeElement.id)&&(document.getElementById("label-tab-0").click(),document.getElementById("label-tab-0").focus())))}),this.play=function(e){t.iframe.contentWindow.postMessage({type:e,params:{}},"*"),r.setState("play","play"),n.readAloudEvent({pageId:g,bookId:p.project_id||p.id,bookISBN:p.isbn,pageIndex:p.getIndexOfPage(g),value:"play"}),d.expanded?l("pause-player"):l("pause")},this.pause=function(e){t.iframe.contentWindow.postMessage({type:"pause",params:{}},"*"),r.setState("pause","pause"),n.readAloudEvent({pageId:g,bookId:p.project_id||p.id,bookISBN:p.isbn,pageIndex:p.getIndexOfPage(g),value:"pause"}),l("play"),"pause"===e?(r.displayMainPlay(!0),l("play-player")):(r.displayMainPlay(!1),l("pause"))},this.stop=function(){t.iframe.contentWindow.postMessage({type:"stop",params:{}},"*"),r.setState("stop","stop"),n.readAloudEvent({pageId:g,bookId:p.project_id||p.id,bookISBN:p.isbn,pageIndex:p.getIndexOfPage(g),value:"stop"}),r.displayMainPlay(!1),d.expanded?l("replay-player"):l("replay"),d.progress=0},this.close=function(e){if(r.displayMainPlay(!1),e)return d.playerStatus="close";t.iframe.contentWindow.postMessage({type:"close",params:{}},"*"),r.resetState(),n.readAloudEvent({pageId:g,bookId:p.project_id||p.id,bookISBN:p.isbn,pageIndex:p.getIndexOfPage(g),value:"close"}),l("play")},this.skipBackwards=function(){r.displayMainPlay(!1),t.iframe.contentWindow.postMessage({type:"skipBackwards",params:{}},"*")},this.skipForwards=function(){r.displayMainPlay(!1),t.iframe.contentWindow.postMessage({type:"skipForwards",params:{}},"*")},this.changeSpeed=function(e){d.speed=e,t.iframe.contentWindow.postMessage({type:"changeSpeed",params:{speed:e}},"*")},i.$on("$locationChangeSuccess",function(){r.resetState()}),this.setLanguage=function(e){d.activeLanguage=e,d.changeLanguage(e),d.switchReadAloudMenu(!1)},this.switchReadAloudMenu=function(e){d.showReadAloudMenu=e,s(function(){document.getElementById("changelanguage").focus()})},i.$on("reader-dropdown-menu-close",function(e,t){t.isAccessibilityElement&&(d.showReadAloudMenu=!1)})}]}),angular.module("app").component("readerAccessibility",{bindings:{book:"<"},templateUrl:"app/reader/components/reader-accessibility/reader-accessibility.html",controllerAs:"$ctrl",controller:["$scope","Iframe","SettingService","$translate","$timeout","UsersContentsInfos","$state","SessionService",function(t,n,o,i,r,a,e,s){var c=this,u=a.DEFAULT_ALT_MEDIA_ENABLED,l=a.DEFAULT_TTS_SPEED,d=10*a.DEFAULT_TTS_VOLUME,g=a.DEFAULT_FONT_NAME,p=e.params.book,h=e.params.assignment;this.$onInit=function(){c.showFontMenu=!1,c.Iframe=n,c.sharingId=n._sharingId(p,h),c.contentsInfos=a.getBySharingId(c.sharingId),c.user=s.getUser(),c.isFirefox="undefined"!=typeof InstallTrigger,c.readingSpeed=[{type:0,name:i.instant("GT_VOCAL_SYNTHESIS_SLOW_TITLE")},{type:.5,name:i.instant("GT_VOCAL_SYNTHESIS_NORMAL_TITLE")},{type:1,name:i.instant("GT_VOCAL_SYNTHESIS_FAST_TITLE")}],c.testAudioText=i.instant("GT_VOCAL_SYNTHESIS_AUDIO_TEST_TEXT"),c.isAltTextActived=c.userAltMediaEnabled(),c.altTextLabel=c.isAltTextActived?i.instant("GT_ACCESSIBILITY_DISPLAY_ALT_TEXT_ACTIVE"):i.instant("GT_ACCESSIBILITY_DISPLAY_ALT_TEXT_INACTIVE"),document.body.addEventListener("keydown",function(e){var t=document.querySelector("#fontMenu");t==document.activeElement&&(37==e.keyCode||39==e.keyCode?e.preventDefault():13==e.keyCode&&setTimeout(function(){t.focus()},200))}),c.speed=c.userReadingSpeed();var e=void 0;return c.contentsInfos&&c.contentsInfos.options.accessibility&&(e=c.contentsInfos.options.accessibility.fontSize),c.book.isPDF()?c.fontSizeSlider={value:e||100*n.PDFScale,options:{floor:o["pdf-zoom"].range[0],ceil:o["pdf-zoom"].range[1],step:o["pdf-zoom"].step,showSelectionBarEnd:!1,keyboardSupport:!0,ariaLabel:"Zoom in, zoom out slider",hidePointerLabels:!0,hideLimitLabels:!0,showSelectionBar:!0,getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}}:c.book.isEpubFixed()||c.book.isEpubReflow()?c.fontSizeSlider={value:e||(c.book.isEpubFixed()?n.EpubFixedWidth:100*n.EpubReflowWidth),options:{hidePointerLabels:!0,hideLimitLabels:!0,floor:c.book.isEpubFixed()?20:30,ceil:c.book.isEpubFixed()?99:170,step:c.book.isEpubFixed()?1:20,showSelectionBarEnd:!1,showSelectionBar:!0,keyboardSupport:!0,ariaLabel:"Zoom in, zoom out slider",getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}}:c.fontSizeSlider={value:e||n.pageScale,options:{floor:3,ceil:17,step:1,showSelectionBarEnd:!1,showSelectionBar:!0,keyboardSupport:!0,ariaLabel:i.instant("GT_READER_ACCESSIBILITY_FONT_SIZE_ACCESS_LABEL"),translate:function(){return""},getSelectionBarColor:function(){return"#3086d0"}}},c.volumeSlider={value:c.userVolume(),options:{floor:0,ceil:10,step:1,hideLimitLabels:!0,hidePointerLabels:!0,showSelectionBarEnd:!1,ariaLabel:i.instant("GT_READER_ACCESSIBILITY_SPEECH_VOLUME_ACCESS_LABEL"),onEnd:function(){n.activateAltTextMedia(!1,c.currentVolume(),c.speed,!1),n.activateAltTextMedia(!0,c.currentVolume(),c.speed)},showSelectionBar:!0,getSelectionBarColor:function(){return"#3E85C7"},getPointerColor:function(){return"#3E85C7"}}},c.font=c.userFont(),t.$on("slideEnded",function(){a.updateAccessibilityFont(c.sharingId,{fontSize:c.fontSizeSlider.value}),c.zoomBook()}),t.$on("reader-dropdown-menu-close",function(e,t){t.isAccessibilityElement&&(c.showFontMenu=!1)}),c},this.zoomBook=function(){n.zoomBook(c.fontSizeSlider.value)},this.changeZoom=function(e,t){var n,o;c.fontSizeSlider.value<=c.fontSizeSlider.options.floor&&"out"===e||"in"===e&&c.fontSizeSlider.value>=c.fontSizeSlider.options.ceil||(n=c.fontSizeSlider.options.step,o=null,"out"===e?o=Math.max(c.fontSizeSlider.options.floor,c.fontSizeSlider.value-n):"in"===e&&(o=Math.min(c.fontSizeSlider.options.ceil,c.fontSizeSlider.value+n)),a.updateAccessibilityFont(c.sharingId,{fontSize:o}),c.fontSizeSlider.value=o,c.zoomBook(),t&&"mouse"===t.pointerType)||c.isFirefox||document.body.classList.add("user-is-tabbing")},this.userReadingSpeed=function(){return c.contentsInfos&&c.contentsInfos.options.accessibility&&c.contentsInfos.options.accessibility.speechRate?c.contentsInfos.options.accessibility.speechRate:l},this.userVolume=function(){return c.contentsInfos&&c.contentsInfos.options.accessibility&&c.contentsInfos.options.accessibility.soundPower?10*c.contentsInfos.options.accessibility.soundPower:d},this.userFont=function(){var e;return c.contentsInfos&&c.contentsInfos.options.accessibility&&c.contentsInfos.options.accessibility.fontName&&(e=c.contentsInfos.options.accessibility.fontName,o.fonts.includes(e))?e:g},this.userAltMediaEnabled=function(){return c.contentsInfos&&c.contentsInfos.options.accessibility&&c.contentsInfos.options.accessibility.altMediaEnabled?c.contentsInfos.options.accessibility.altMediaEnabled:u},this.currentVolume=function(){return c.volumeSlider.value/10},this.changeVolumeButton=function(e){"up"===e&&c.volumeSlider.value<c.volumeSlider.options.ceil?c.volumeSlider.value+c.volumeSlider.options.step<=c.volumeSlider.options.ceil?c.volumeSlider.value+=c.volumeSlider.options.step:c.volumeSlider.value=c.volumeSlider.options.ceil:"down"===e&&c.volumeSlider.value>c.volumeSlider.options.floor&&(c.volumeSlider.value-c.volumeSlider.options.step>=c.volumeSlider.options.floor?c.volumeSlider.value-=c.volumeSlider.options.step:c.volumeSlider.value=c.volumeSlider.options.floor)},this.selectFont=function(){n.setFont(c.font)},this.displayAltTextMedia=function(){n.activateAltTextMedia(c.isAltTextActived,c.currentVolume(),c.speed)},this.changeReadingSpeed=function(e){n.activateAltTextMedia(!1,c.currentVolume(),e,!1),n.activateAltTextMedia(!0,c.currentVolume(),e)},this.testAudio=function(){n.testAudioForAltText(c.currentVolume(),c.speed,c.testAudioText)},this.setFont=function(e){c.font=e,c.selectFont(),c.switchFontMenu(!1)},this.switchFontMenu=function(e){c.showFontMenu=e,r(function(){document.getElementById("font-button").focus()})},r(function(){var t=document.getElementById("font-dropdown");t&&Object.keys(t.children).forEach(function(e){t.children[e].hasAttribute("aria-checked")&&t.children[e].removeAttribute("aria-checked")})})}]}),angular.module("app").component("readerDropdown",{bindings:{icon:"@",tooltip:"@",additionalClass:"@",tabIndex:"@",ariaLabel:"@",isAccessibilityElement:"<"},transclude:!0,templateUrl:"app/reader/components/reader-dropdown/reader-dropdown.html",controllerAs:"$ctrl",controller:["$rootScope","$scope","$timeout","$translate","KeyCodesService",function(t,n,o,e,i){var r=this,a=(this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.closeMenu=function(){r.openmenu=!1},document.getElementById("menu-dropdown"));return a.addEventListener("focusin",function(){var e=a.querySelectorAll("*[tabindex='-2']");Array.from(e).forEach(function(e){e.setAttribute("tabindex",0)})}),this.closeMenuAndBroadcast=function(){var e=a.querySelectorAll("*[tabindex='-2']");Array.from(e).forEach(function(e){e.setAttribute("tabindex",0)}),document.activeElement.classList.contains("read-aloud-buttons")||(r.openmenu=!1,t.$broadcast("reader-dropdown-menu-close",{isAccessibilityElement:r.isAccessibilityElement}))},this.$onInit=function(){document.addEventListener("keydown",function(e){var t;e.target.classList.contains("terms-and-conditions-focus")?i.isEscape(e)&&(t=document.getElementById("terms-and-conditions"))&&(o(function(){r.openmenu=!1}),t.focus()):i.isEscape(e)&&r.openmenu&&(r.click(),t=document.getElementById("reader-accessibility"))&&t.focus()})},this.click=function(){var e;r.openmenu?(e=a.querySelectorAll("*[tabindex='-2']"),Array.from(e).forEach(function(e){e.setAttribute("tabindex",0)})):(e=a.querySelectorAll("*[tabindex='0']"),Array.from(e).forEach(function(e){e.setAttribute("tabindex",-2)})),r.openmenu=!r.openmenu,r.openmenu||t.$broadcast("reader-dropdown-menu-close",{isAccessibilityElement:r.isAccessibilityElement}),o(function(){n.$broadcast("rzSliderForceRender");var e=document.getElementsByClassName("rz-pointer-min")[0];e&&(e.tabIndex=11)})},this.dropdownState=function(){return r.openmenu?e.instant("GT_USER_INPUTS_COLLAPSE"):e.instant("GT_USER_INPUTS_EXPAND")},this}]}),angular.module("app").component("readerJoyride",{templateUrl:"app/reader/components/reader-joyride/reader-joyride.html",bindings:{isOpen:"="},controller:["ngDialog",function(e){var t=this;this.openInfo=function(){t.isOpen=!0,e.open({template:"app/reader/components/reader-joyride/modals/modal.html",appendClassName:"reader-joyride-modal",showClose:!1,closeByEscape:!0,closeByDocument:!1,focusOnOpen:!0,className:"ngdialog-theme-default",controllerAs:"$ctrl",controller:["$sce","$translate","$timeout",function(e,t,n){this.joyrideContent=e.trustAsHtml(t.instant("GT_READER_JOYRIDE_CONTENT")),n(function(){var e=document.getElementById("ngdialog1");e&&e.setAttribute("aria-modal",!0)},100),window.addEventListener("focus",function(){var e=document.getElementById("closeQuickTourDialog");angular.element(document.querySelector("#reader-joyride")).controller("readerJoyride").isOpen&&e&&e.focus()})}],width:"90%",ariaRole:"dialog",ariaModal:"true",ariaLabelledById:"readerJoyrideTitle"})}}]}),angular.module("app").component("readerMessage",{bindings:{translationKey:"<",color:"<",textColor:"<",prependIcon:"<",appendIcon:"<",appendButtonText:"<",appendButtonEvent:"&"},templateUrl:"app/reader/components/reader-message/reader-message.html",controllerAs:"$ctrl"}),angular.module("app").component("readerNavigation",{bindings:{position:"@",condition:"=",next:"=",previous:"=",nextPageNumber:"=",previousPageNumber:"=",type:"@",book:"<",chapterPreview:"<"},transclude:!0,templateUrl:"app/reader/components/reader-navigation/reader-navigation.html",controllerAs:"$ctrl",controller:["$state","$scope","$rootScope","Theme","TocService","KeyCodesService",function(o,e,i,t,r,a){var s=this;return this.$onInit=function(){s.hoverColor=t._theme.primaryColor.value.replace(/,(?:.(?!,))+$/gi,",0.04)"),s.hoverColor=-1<s.hoverColor.indexOf("#")?s.hoverColor.substr(0,7)+"0a":s.hoverColor,e.$watch("$ctrl.condition",function(e){e&&setTimeout(function(){var e=o.params.enterClickPrevious?i.showNavigationLeft?"#previous-page":"#next-page":i.showNavigationRight?"#next-page":"#previous-page",e=document.querySelectorAll(e)[1];e&&e.focus()},100)})},this.nextPage=function(e){if(!s.isRestricted("next")){if(document.activeElement===document.getElementById("next-page")){for(var t=parseInt(document.getElementById("next-page").getAttribute("tabindex"));!document.querySelectorAll('[tabindex="'+--t+'"]').length;);document.querySelectorAll('[tabindex="'+t+'"]')[0].focus(),document.querySelectorAll('[tabindex="'+t+'"]')[0].blur()}var n=s.next.path||s.next.id;i.showNavigationTop=!1,i.showNavigationBottom=!1,i.showNavigationLeft=!1,i.showNavigationRight=!1,i.cyclicNavigation=!1,o.go("reader.book.page",{page:n,enterClickNext:a.isKeyBoardTriggeredEvent(e),enterClickPrevious:!1}),r.scrollOnPage(n)}},this.getPageNumberAndName=function(e){var t=e.next,e=e.previous;return t?s.book.isEpubReflowWithoutPageBreak()||s.book.isEpubFixed()||s.book.isEpubReflow()||"true"===s.next.display?(s.nextPageTitle=s.next.title,s.next.title):(s.nextPageTitle=s.nextPageNumber,s.nextPageNumber):e?s.book.isEpubReflowWithoutPageBreak()||s.book.isEpubFixed()||s.book.isEpubReflow()||"true"===s.previous.display?(s.previousPageTitle=s.previous.title,s.previous.title):(s.previousPageTitle=s.previousPageNumber,s.previousPageNumber):void 0},this.previousPage=function(e){if(!s.isRestricted("previous")){if(document.activeElement===document.getElementById("previous-page")){for(var t=parseInt(document.getElementById("previous-page").getAttribute("tabindex"));!document.querySelectorAll('[tabindex="'+--t+'"]').length;);document.querySelectorAll('[tabindex="'+t+'"]')[0].focus(),document.querySelectorAll('[tabindex="'+t+'"]')[0].blur()}var n=s.previous.path||s.previous.id;i.navigationAnimation=s.type+"p",i.showNavigationTop=!1,i.showNavigationBottom=!1,i.showNavigationLeft=!1,i.showNavigationRight=!1,i.cyclicNavigation=!1,o.go("reader.book.page",{page:n,enterClickNext:!1,enterClickPrevious:a.isKeyBoardTriggeredEvent(e)}),r.scrollOnPage(n)}},this.isRestricted=function(e){return s.chapterPreview.enabled&&s[e]&&!s.chapterPreview.pages.includes(s[e].pageId||s[e].path)},this}]}),angular.module("app").component("readerToc",{bindings:{book:"=",chapterPreview:"<"},templateUrl:"app/reader/components/reader-toc/reader-toc.html",controller:["KeyCodesService","$stateParams","$rootScope",function(t,o,n){var r=this;this.$onInit=function(){r.bookTitle=r.book.getTitle();var e=r.findParentChapters(r.book.structure.toc||r.book.structure.content,r.chapterPreview.pages[0])||[];r.chapterPreview=angular.copy(r.chapterPreview),r.chapterPreview.pages=r.chapterPreview.pages.concat(e),n.$on("focusActiveTocItem",function(){r.focusActiveTocItem()})},this.getBookStructure=function(){return r.book.structure.version?r.book.structure.toc:r.book.structure.content},this.getShownBookStructure=function(){return r.getBookStructure().filter(r.shouldShowItem)},this.findParentChapters=function(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],o=0;o<e.length;o++){var i=[].concat(_toConsumableArray(n));if(i.push(e[o].pageId),e[o].pageId===t||e[o].path===t)return n;if(e[o].children||e[o].content){i=r.findParentChapters(e[o].children||e[o].content,t,i);if(i)return i}}},this.shouldShowItem=function(e){return!e.hasOwnProperty("display")||"true"===e.display},this.handleKeyDown=function(e){switch(!0){case t.isEnter(e):e.preventDefault(),e.stopPropagation(),r.focusActiveTocItem();break;case t.isEscape(e):e.preventDefault(),e.stopPropagation(),document.querySelector('[role="tree"]').focus()}},this.focusActiveTocItem=function(){var e,t,n=document.querySelector('[role="treeitem"].selected-page');n||-1!==(e=(t=r.getBookStructure().flatMap(r.flattenNode)).findIndex(function(e){return e.path===o.pageId&&"true"===e.isPage||e.id===o.pageId}))&&(t=t.slice(0,e).findLast(r.shouldShowItem))&&(n=document.querySelector('[role="treeitem"][id="'+(t.id||t.path)+'"]')),(n=n||document.querySelector('[role="treeitem"]')).focus()},this.flattenNode=function(e){return e.content?[e].concat(_toConsumableArray(e.content.flatMap(r.flattenNode))):e.children?[e].concat(_toConsumableArray(e.children.flatMap(r.flattenNode))):[e]}}]}),angular.module("app").component("searchPanel",{bindings:{book:"<",back:"&",chapterPreview:"<"},templateUrl:"app/reader/components/search-panel/search-panel.html",controllerAs:"$ctrl",controller:["SearchService","Library","Iframe","$state","$sce","$scope","$location","$translate","TocService","SessionService","ngDialog","KeyCodesService","FirebaseAnalyticsService","UserInputsService","PaginationService","Config","$q",function(t,e,n,o,i,r,a,s,c,u,l,d,g,p,h,f,m){function b(e){k.offsetParent&&!y.contains(e.srcElement)&&!k.contains(e.srcElement)&&d.isTab(e)&&(e.preventDefault(),v.searchInput)&&v.searchInput.focus()}var v=this,I=(this.book=e.getBookByContentId(o.params.book),this.SearchService=t,this.searchQuery="",o.params.page),y=document.getElementsByTagName("search-panel")[0],k=document.getElementById("main");this.searchInput=angular.element(document.getElementById("search-input"))[0],this.isFirefox="undefined"!=typeof InstallTrigger,this.ariaLive=this.isFirefox?"off":"polite",this.activeTab="content",this.pageTitleIndex={},this.selectedPage=1,this.searchCanceller=m.defer(),this.chapterPreview={enabled:u.isChapterPreview(),pages:u.chapterPreviewAllowedPages()};this.$onInit=function(){document.addEventListener("keydown",b),v.searchInput.focus(),f.hasUsersDataMigratedToDbn()&&(h.reset(),h.setType("all"),h.setSort("pageNumberRef","ASC"),h.totalCount=0),t.clearContentResults(),""!==t.getSearchQuery()&&(v.searchQuery=t.getSearchQuery(),v.queryChanged(v.searchQuery))},this.isViewerMode=function(){return"PREVIEW"===u.readerMode},this.searchAnnotations=function(){f.hasUsersDataMigratedToDbn()?h.paginate({timeout:v.searchCanceller.promise}).then(function(){t.annotationsLength=h.totalCount||0}):p.getUserInputsForPage({appId:f.get("appId"),sharingId:v.book.getSharingId(),page:v.selectedPage,field:"pageTitle",direction:"asc",count:!0,distinctCount:!0,type:"all",search:v.searchQuery},{timeout:v.searchCanceller.promise}).then(function(){return t.annotationsLength=p.totalUserInputs.all||0})},this.annotationsLength=function(){return v.searchQuery?f.hasUsersDataMigratedToDbn()?h.totalCount:p.totalUserInputs.all:0},this.annotationsLoading=function(e){return f.hasUsersDataMigratedToDbn()?e?h.isInitialLoading:h.loading:p.loading},this.queryChanged=function(e){v.searchCanceller.resolve(),v.searchCanceller=m.defer(),e?(t.setSearchQuery(e),t.search(v.book.book_content_id,v.book.version,e,I,{timeout:v.searchCanceller.promise}),v.shortenedQuery=i.valueOf(t.truncate(e)),t.searchBookPage(v.book,e),g.searchFromBook(v.book,e),v.selectedPage=1,f.hasUsersDataMigratedToDbn()&&(h.setSearch(e),h.setSharingId(v.book.getSharingId())),v.searchAnnotations()):v.clearSearch()},r.$on("page-change",function(e,t){v.selectedPage=t,v.searchAnnotations()}),this.getTextFromHTML=function(e){var t;if(e)return t=new RegExp(/(<([^>]+)>)/,"ig"),e.replace(t,"").trim()},this.getPageTitleOrNumber=function(){var e=v.SearchService.searchedPage;return e&&v.getTextFromHTML(e.title)?v.getTextFromHTML(e.title):v.getPageNumber()},this.getPageNumber=function(){return s.instant("GT_CONTENT_TYPE_PAGE")+" "+v.SearchService.query},this.isViewerMode()||(this.getSyncObjects=function(){return f.hasUsersDataMigratedToDbn()?h.items:p.paginatedData}),this.goToPage=function(e){e=e.path||e.id;v.back(),I!==e&&o.go("reader.book.page",{page:e}),c.scrollOnPage(e)},this.switchPanel=function(e){e&&(v.activeTab=e)},r.$watch("$ctrl.searchQuery",function(e){var t=document.getElementById("searchClearButton"),n=e?!1:!0;setTimeout(function(){t.setAttribute("disabled",n)})}),this.chapterPreviewMoreInfo=function(){l.openConfirm({template:"app/reader/components/chapter-preview-message/chapter-preview-message.html",showClose:!1,closeByDocument:!1,closeByEscape:!1,focusOnOpen:!0,width:"35%",controllerAs:"$ctrl"})},this.isPageInfoRestricted=function(){return v.SearchService.searchedPage&&v.chapterPreview.enabled&&!v.chapterPreview.pages.includes(v.SearchService.searchedPage.pageId||v.SearchService.searchedPage.path)},document.addEventListener("keydown",function(e){"search-content"===document.activeElement.id?(d.isEnter(e)||d.isSpace(e))&&document.getElementById("search-content").click():"search-annotation"===document.activeElement.id&&(d.isEnter(e)||d.isSpace(e))&&document.getElementById("search-annotation").click()});document.getElementById("skipToSearchContent").addEventListener("click",function(e){e.preventDefault(),k.focus()}),document.addEventListener("keydown",function(e){var t=document.getElementById("skipToSearchContent");t&&t===document.activeElement&&(d.isEscape(e)?(e.preventDefault(),v.searchInput.focus()):d.isEnter(e)&&(e.preventDefault(),k.focus()))}),this.selectTab=function(e){(d.isEnter(e)||d.isSpace(e))&&(e.target.click(),e.preventDefault(),e.stopPropagation())};var _=document.querySelector('[role="tablist"]');return _.addEventListener("keydown",function(e){var t=_.querySelectorAll('[role="tab"]'),n=void 0;document.getElementById("search-menu-list-item")?n=document.getElementById("search-menu-list-item").children:(n=[document.getElementById("search-content")],(o=document.getElementById("search-annotation"))&&n.push(o));var o=Array.prototype.slice.call(n).indexOf(document.activeElement);(d.isArrowRight(e)||d.isArrowLeft(e))&&(d.isArrowRight(e)?++o>=t.length&&(o=0):d.isArrowLeft(e)&&--o<0&&(o=t.length-1),t[o].focus(),e.stopPropagation(),e.preventDefault())}),this.clearSearch=function(){n.undoSearch(),t.clearSearch(),v.searchQuery="",v.searchInput.focus(),a.search("search",null),a.search("scrollTo",null),r.$emit("openSearch")},r.$on("update-annotation",function(){f.hasUsersDataMigratedToDbn()&&(h.reset(),h.setType("all"),h.setSort("pageNumberRef","ASC"),h.setSearch(v.searchQuery)),v.searchAnnotations()}),this}]}),angular.module("app").component("searchResults",{bindings:{searchQuery:"<",results:"=",annotations:"<",filter:"<",book:"<",back:"&",chapterPreview:"<",selectedPage:"<"},templateUrl:"app/reader/components/search-results/search-results.html",controller:["$rootScope","UserInputsService","PaginationService","Config",function(t,n,e,o){var i=this;this.$onInit=function(){i.showSize=o.hasUsersDataMigratedToDbn()?e.size:n.ANNOTATIONS_PER_PAGE},this.$onChanges=function(e){e&&e.searchQuery&&e.searchQuery.isFirstChange()||e&&e.annotations&&e.annotations.isFirstChange()||t.$broadcast("note-edit")},this.sortSearchResults=function(){return"+pageIndex"},this.getTotalItems=function(){return n.totalUserInputs.all},this.isPaginationShown=function(){var e;return!o.hasUsersDataMigratedToDbn()&&!!n.paginatedData&&(e=i.getTotalItems(),0<n.paginatedData.length)&&!n.isLoading&&e>n.ANNOTATIONS_PER_PAGE}}]}),angular.module("app").controller("ResetEmailController",["API","DbnApi","SessionService","LocalStorage","ngDialog",function(e,t,n,o,i){var r=this;this.emailPattern=/^\s*[\w\-\+_]+(\.[\w\-\+_]+)*\@[\w\-\+_]+\.[\w\-\+_]+(\.[\w\-\+_]+)*\s*$/,this.newEmail="",this.getUserLinkedAccounts=function(){var e=n.getUser();return e?e.apps.length:1},this.submit=function(){n.isJwtTokenSession(),1<r.getUserLinkedAccounts()?r.openChangeConfirm():r.changeEmail().then(function(){return r.openEmailSentConfirm()}).catch(function(){return r.openSessionExpire()})},this.changeEmail=function(){return n.isJwtTokenSession()?t.requestChangeEmail(r.newEmail):e.hapi.post("/v1/reader/users/resetEmail",{newEmail:r.newEmail.toLowerCase(),lang:o.get("lang"),criticalUpdateToken:n.getUserCriticalToken()})},this.openChangeConfirm=function(){i.openConfirm({width:"350px",template:"app/settings/profile/reset-email/confirm-dialog/confirm-dialog.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"confirm-reset-email-dialog",focusOnOpen:!0,controllerAs:"$ctrl",data:{changeEmail:r.changeEmail,emailConfirm:r.openEmailSentConfirm,openSessionExpire:r.openSessionExpire},controller:["ngDialog","$scope",function(e,t){var n=this;this.changeEmail=t.ngDialogData.changeEmail,this.emailConfirm=t.ngDialogData.emailConfirm,this.openSessionExpire=t.ngDialogData.openSessionExpire,this.confirm=function(){n.changeEmail().then(function(){n.close(),n.emailConfirm()}).catch(function(){n.close(),n.openSessionExpire()})},this.close=function(){e.close()}}]}).catch(function(e){console.log(e)})},this.openEmailSentConfirm=function(){i.openConfirm({width:"350px",template:"app/settings/profile/reset-email/confirm-email-sent/confirm-email-sent.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"confirm-reset-email-dialog",focusOnOpen:!0,data:{email:r.newEmail.toLowerCase()},controllerAs:"$ctrl",controller:["ngDialog","$state","SessionService","$scope",function(e,t,n,o){this.email=o.ngDialogData.email,this.go=function(){n.setUserCriticalToken(null),t.go("app.profile"),e.close()},this.close=function(){e.close()}}]}).catch(function(e){console.log(e)})},this.openSessionExpire=function(){i.openConfirm({width:"350px",template:"app/settings/profile/reset-email/session-expired-dialog/session-expired-dialog.html",showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,appendClassName:"confirm-reset-email-dialog",focusOnOpen:!0,controllerAs:"$ctrl",controller:["ngDialog","$state",function(e,t){this.go=function(){t.go("app.verify-user"),e.close()},this.close=function(){e.close()}}]}).catch(function(e){console.log(e)})}}]),angular.module("app").controller("VerifyUserController",["API","Config","SessionService","$state","$stateParams","DbnApi","$window","$location","$anchorScroll",function(e,t,n,o,i,r,a,s,c){var u=this;"reload"===a.performance.getEntriesByType("navigation")[0].type&&s.path("/profile"),c(),this.isVisible=!1,this.type="password",this.firstName=i.firstName,this.lastName=i.lastName,this.showPassword=function(){u.isVisible=!u.isVisible,u.type=u.isVisible?"text":"password"},this.verify=function(){(n.isJwtTokenSession()?r.verifyCredentials({email:u.email,password:u.password}):e.hapi.post("/v1/reader/users/verify",{password:u.password,email:u.email,workspace:t.get("workspaceId"),editor:n.getUserId(),app:t.getAppId()}).then(function(e){e=e.data.criticalUpdateToken;n.setUserCriticalToken(e)})).then(u.navigateToNextStep).catch(function(e){console.error(e),u.badVerification=!0})},this.navigateToNextStep=function(){switch(o.params.next){case"reset-email":o.go("app.reset-email");break;case"reset-profile":o.go("app.profile",{formIsEditable:!0,updateIdentity:!0,firstName:u.firstName,lastName:u.lastName});break;case"update-picture":o.go("app.profile",{pictureIsEditable:!0});break;default:o.go("app.profile")}}}]),angular.module("app").component("genericDictionary",{bindings:{settings:"<",text:"<",display:"="},templateUrl:"app/reader/user-input/components/generic-dictionary/generic-dictionary.html",controllerAs:"$ctrl",controller:["DictionaryService","$translate","LocalStorage","Iframe","$sce",function(e,t,n,o,i){var r=this;this.$onInit=function(){r.definitionWord=decodeURI(r.text),r.isLoading=!0,r.hasResults=!1,r.dropdownIsHidden=!1,r.languages=["en","fr","de","es","pt","ja"],r.language=n.get("lang")||"en",r.getDefinitionHtml(),r.dragOptions={selector:".webreader",header:"dictionary-header"}},this.$onChanges=function(e){e&&e.text&&e.text.currentValue&&r.definitionWord&&e.text.currentValue!==r.definitionWord&&r.hide(),e&&e.text&&!e.text.currentValue&&r.hide()},this.getDefinitionHtml=function(){return r.isLoading=!0,e.getDefinitionHtml(r.language,r.text.toLowerCase()).then(r.success).catch(r.error)},this.success=function(e){r.isLoading=!1;var e=Object.values(e.query.pages),t=document.createElement("div");t.innerHTML=e[0].extract,r.hasResults=o.parseDefinition(r.language,t),r.dictionary=i.trustAsHtml(t.innerHTML),r.hasResults=!!r.dictionary&&r.hasResults,r.hasResults||(r.dictionary=null)},this.error=function(){r.isLoading=!1},this.noResultsMessage=function(){return t.instant("GT_DEFINE_NOT_FOUND_WR",{word:r.definitionWord,lang:r.languagesName(r.language)})},this.languagesName=function(e){return e=e||r.language,t.instant("GT_LANGUAGE_OPTIONS_"+e.toUpperCase())},this.setLanguage=function(e){e!==r.language&&(r.hasResults=!1,r.dictionary=null,r.language=e,r.getDefinitionHtml())},this.hide=function(){r.display=!1},this.alignPositionTop=function(){var e;return r.settings.position?(e=window.innerHeight-r.settings.position.top,r.dropdownIsHidden=401<=e&&e<=480,e<=400?(e=r.settings.position.top-300)<0?"0px":e+"px":r.settings.position.top+40+"px"):"0px"},this.alignPositionLeft=function(){var e;return r.settings.position?200<(e=window.innerWidth-r.settings.position.left)?r.settings.position.left-455+"px":(e<100?window.innerWidth-375:r.settings.position.left-window.innerWidth/6)-320+"px":"0px"}}]}),angular.module("app").component("printAnnotations",{bindings:{book:"<"},templateUrl:"app/reader/user-input/components/print-annotations/print-annotations.html",controllerAs:"$ctrl",controller:["ngDialog","API","SessionService","User","UserInputsService","$translate","PaginationService","Config",function(n,o,i,r,e,a,s,c){var u=this;return this.$onInit=function(){u.getItems=function(){return c.hasUsersDataMigratedToDbn()?s.items:e.paginatedData},u.getAriaLabel=function(){return u.enablePrint()?a.instant("GT_READER_ACTION_PRINT"):a.instant("GT_PRINT_OPTIONS_TITLE_NOT_AVAILABLE")};var t=u.book;u.openPrintModal=function(){var e;u.enablePrint()&&(e=u.getItems(),n.open({template:"app/reader/user-input/components/print-annotations/print-annotations-modal.html",controllerAs:"$ctrl",appendClassName:"directive-modal-common",className:"ngdialog-theme-default print-annotations",width:"560px",resolve:{book:function(){return t},userAPI:function(){return o.getUser().then(function(e){return i.user=new r(e)})},userInputs:function(){return e},types:function(){return u.types=[],u.getUserInputsLength("note")&&u.types.push("note"),u.getUserInputsLength("highlight")&&u.types.push("highlight"),u.getUserInputsLength("notdisplayed")&&u.types.push("notdisplayed"),u.types}},controller:"PrintAnnotationController"}))},u.getUserInputsLength=function(t){return u.getItems().filter(function(e){return"notdisplayed"===t&&"bookmark"!==e.type?!u.book.getPage(e.pageId):e.type===t&&u.book.getPage(e.pageId)}).length},u.enablePrint=function(){return(c.hasUsersDataMigratedToDbn()?s:e).hasNotesOrHighlights()}},this}]}).controller("PrintAnnotationController",["types","userInputs","$timeout","book","$translate","SessionService","$location","StatisticsService",function(e,n,o,i,r,t,a,s){function c(e,t){var n=[],o=g(e,t);return Object.keys(o).forEach(function(e){n=n.concat(o[e])}),n}var u=this,l=(this.types=e,this.book=i,this.userInputs=angular.copy(n),angular.copy(this.types)),d=(this.orderBy="pageId",this.cover=this.book.cover||"commons/img/covers.png",this.bookTitle=this.book.getTitle(),this.user=t.getUser(),this.url="https://"+a.host()+"/",this.getTypeLabel=function(e){return"notdisplayed"===e?r.instant("GT_USER_INPUTS_NOT_DISPLAYED")+" "+r.instant("GT_USER_INPUTS_HIGHLIGHTS")+" & "+r.instant("GT_USER_INPUTS_NOTES"):r.instant("GT_USER_INPUTS_"+e.toUpperCase()+"S")},this.getSortBy=function(){return"type"===u.orderBy?r.instant("GT_PRINT_OPTIONS_ORDER_BY_TYPE"):r.instant("GT_PRINT_OPTIONS_ORDER_BY_PAGE")},this.isSelected=function(e){return-1<l.indexOf(e)},this.selectTypes=function(e){var t=l.indexOf(e);-1<t?l.splice(t,1):l.push(e)},this.getColorName=function(e){return"#FFEB6B"===e?d("yellow"):"#C0ED72"===e?d("green"):"#ADD8FF"===e?d("blue"):"#FFB0CA"===e?d("pink"):"#D9B2FF"===e?d("purple"):void 0},this.getAnnotationType=function(e){return r.instant("GT_USER_INPUT_"+e.toUpperCase())},function(e){return r.instant("GT_READER_HIGHLIGHT_"+e.toUpperCase()+"_COLOR")}),g=function(e,n){return e.reduce(function(e,t){return(e[t[n]]=e[t[n]]||[]).push(t),e},{})};this.getPartChapterPageName=function(e){var t=i.getPartOrSection(e),e=i.getPage(e);return e&&t&&"true"!==t.isPage?t.title+" / "+e.title:e?e.title:""},this.getUserInputsLength=function(t){return n.filter(function(e){return"notdisplayed"===t?!u.book.getPage(e.pageId):e.type===t&&u.book.getPage(e.pageId)}).length},this.update=function(){u.userInputs=c(u.userInputs,u.orderBy)},this.isNotDisplayed=function(e){return!u.book.getPage(e)},this.printButtonDisabled=function(){return 0<!l.length},this.print=function(){var e,t;0<l.length&&(e=[],t=[],-1<l.indexOf("notdisplayed")&&(t=n.filter(function(e){return!u.book.getPage(e.pageId)})),e=n.filter(function(e){return-1<l.indexOf(e.type)&&u.book.getPage(e.pageId)}).concat(t),u.userInputs=c(e,u.orderBy),o(function(){var e=document.getElementById("print-section").innerHTML,t=window.open("","","width=800,height=900");t.document.open(),t.document.write("<html><head><title>"+r.instant("GT_ANNOTATIONS_PRINT_TEMPLATE_HEADER",{projectTitle:u.bookTitle})+'</title><style>\n                .annotation-card {\n                    border-bottom: 1px solid #9e9e9e7a;\n                    margin-bottom: 24px;\n                    position: relative;\n                    width: 70%\n                }\n                .whole-page {\n                    margin: 28px 38px;\n                }\n                #print-section {\n                    page-break-after: always;\n                    page-break-inside: avoid;\n                }\n                .header {\n                    border-bottom: 1px solid #9e9e9e7a;\n                    padding: 5px 0;\n                }\n                .date {\n                    float: right;\n                    font-size: 14px;\n                }\n                .side-notes {\n                    width: 30%;\n                    margin: 0 10px;\n                    position: absolute;\n                    top: 0;\n                    left: 74%;\n                }\n                .error {\n                    width: 16px;\n                    background-color: #B00020;\n                    height: 16px;\n                    text-align: center;\n                    border-radius: 50%;\n                    margin-right: 4px;\n                    display: inline-block;\n                }\n                .missing-page-caption {\n                    color: #B00020;\n                    font-size: 14px;\n                }\n                .highlighted-text>p {\n                    font-weight: 600\n                }\n                .highlighted-text {\n                    border-left: 4px solid;\n                    padding-left: 5px;\n                }\n                .side-note-text{\n                    margin: 0;\n                    color: rgba(0, 0, 0, 0.87);\n                    padding-top: 5px;\n                    padding-bottom: 7px;\n                    font-size: 16px;\n                    border-bottom: 1px solid #9e9e9e7a;\n                    font-weight: bold;\n                }\n                .header {\n                    border-bottom: 1px solid #9e9e9e7a;\n                }\n                .book-chapter{\n                    padding-top: 8px;\n                }\n                .page-name {\n                    color: rgba(0,0,0,0.87);\n                    font-family: Roboto;\n                    font-size: 14px;\n                    letter-spacing: 0.27px;\n                    margin-top: 10px;\n                    line-height: 16px;\n                }\n                .color-display {\n                    display: inline-flex;\n                    width: 20px;\n                    height: 20px;\n                    border-radius: 50%;\n                    margin-right: 6px\n                }\n                .book-annotation-cover {\n                    float: left;\n                    border-radius: 2px;\n                    padding-right: 16px;\n                }\n                .type {\n                    text-transform: capitalize;\n                    font-size: 14px;\n                    vertical-align: super;\n                    color: rgba(0,0,0,0.87);\n                }\n                .note-text{\n                    font-size: 16px;\n                }\n                .book-cover {\n                    height: 120px;\n                    width: 120px;\n                    object-fit: contain;\n                }\n                .page-header {\n                    display: none;\n                }\n                @page {\n                    margin: 50px;\n                }\n                .copyrights {\n                    position: fixed;\n                    right: 1%;\n                    height: 35px;\n                    width: 170px;\n                    color: rgba(0,0,0,0.87);\n                    font-family: Roboto;\n                    font-size: 8px;\n                    letter-spacing: 0.2px;\n                    line-height: 10px;\n                    bottom: 106px;\n                }\n                .info-type{\n                    color: #565252;\n                    font-family: Roboto;\n                    font-size: 16px;\n                    font-weight: bold;\n                    letter-spacing: 0.11px;\n                    line-height: 16px;\n                }\n                .book-annotation-description {\n                    display: grid;\n                }\n                .book-annotations {\n                    display: inline-flex;\n                }\n                .annotation-info{\n                    margin: 17px 0;\n                    border-bottom: 1px solid #9e9e9e7a;\n                    padding: 5px 0;\n                }\n                .annotation-book {\n                    line-height: 12px;\n                }\n                .book-name {\n                    color: rgba(0, 0, 0, 0.87);\n                    font-size: 20px;\n                    font-weight: 600;\n                    letter-spacing: 0.25px;\n                    word-wrap: break-word;\n                    white-space: initial;\n                    max-width: 100%;\n                }\n                .annotation-book-author {\n                    height: 20px;\n                    color: rgba(0, 0, 0, .6);\n                    font-size: 14px;\n                    letter-spacing: .25px;\n                    line-height: 20px;\n                }\n                .annotation-section {\n                    position: relative;\n                }\n            // </style></head><body onload="window.print()">'+e+"</html>"),t.document.close()},1e3),s.printAnnotationsEvent())}}]),angular.module("app").component("readerColorPicker",{bindings:{callback:"&",selected:"<?",tooltip:"@",firstIsDefault:"@?"},templateUrl:"app/reader/user-input/components/reader-color-picker/reader-color-picker.html",controller:["$scope","$translate",function(e,t){var n=this;this.colors=["#FFEB6B","#C0ED72","#ADD8FF","#FFB0CA","#D9B2FF"],this.$onInit=function(){n.selected||(n.selected="",n.firstIsDefault&&n.selectColor(null,n.colors[0]),n.setDefaultFocus())},this.setDefaultFocus=function(){var e=document.getElementById("input-toolbar");e?e.querySelector("i")&&e.querySelector("i").focus():setTimeout(function(){n.setDefaultFocus()},500)},this.selectColor=function(e,t){n.selected=t,n.callback({event:e,color:t})},this.getTranslationValue=function(e){e=t.instant("GT_READER_HIGHLIGHT_"+e.toUpperCase()+"_COLOR");return t.instant("GT_READER_HIGHLIGHT_ACCESSIBILITY",{color:e})},this.getColorName=function(e){return"#FFEB6B"===e?n.getTranslationValue("yellow"):"#C0ED72"===e?n.getTranslationValue("green"):"#ADD8FF"===e?n.getTranslationValue("blue"):"#FFB0CA"===e?n.getTranslationValue("pink"):"#D9B2FF"===e?n.getTranslationValue("purple"):void 0}}]}),angular.module("app").component("readerInputItemList",{bindings:{items:"<",filter:"<",changes:"&",searchQuery:"<",annotationMode:"<",back:"&",render:"<"},templateUrl:"app/reader/user-input/components/reader-input-item-list/reader-input-item-list.html",controller:["$state","Library","SearchService","$filter","$rootScope","$timeout","UserInputsService","PaginationService","Config",function(e,t,n,o,i,r,a,s,c){var u=this,l=(this.bookId=e.params.book,this.currentState=e.current.name,t.getBookByContentId(this.bookId));this.groupBy="",s.sort&&"pageNumberRef"===s.sort.field?this.groupBy="[sharingId, pageIndex]":"pageTitle"===a.sortType&&(this.groupBy="[sharingId, pageId]"),this.$onInit=function(){u.annotations=u.items,i.$on("note-edit",function(){u.render=!1,r(function(){u.render=!0},1)})},this.$onChanges=function(e){e&&e.items&&(u.annotations=u.items,u.changes())},this.displayExpand=function(e){return!l.getPage(e[0].pageId)},this.getPartChapterPageName=function(e,t){return t.length&&e?(e=t[0],(t=l.getPartOrSection(e.pageId))&&"true"!==t.isPage?t.title+" / "+e.pageTitle:e.pageTitle||""):""},this.getBookName=function(e){e=t.getBookOrAssignmentBySharingId(e);return e?e.getTitle():""},this.getShortenedQuery=function(e){return n.truncate(e)},this.searchAnnotations=function(){return n.searchLocalAnnotations(u.items,u.searchQuery)},this.hasUsersDataMigratedToDbn=function(){return c.hasUsersDataMigratedToDbn()},this.hasNext=function(){return s.hasNext}}]}),angular.module("app").component("readerInputItemViewer",{bindings:{currentItem:"<",text:"<",type:"<",searchQuery:"<",annotationMode:"<",back:"&"},templateUrl:"app/reader/user-input/components/reader-input-item-viewer/reader-input-item-viewer.html",controller:["$state","SyncService","Library","$translate","Assignment","$scope","LocalStorage","SearchService","toastr","Iframe","$rootScope","UserInputsService","AnnotationService","BookmarkService","$timeout","FirebaseAnalyticsService","Config",function(e,t,n,o,i,r,a,s,c,u,l,d,g,p,h,f,m){function b(e,t){return e&&t?"de"===t?e:e.toLowerCase():""}function v(e){var t;"bookmark"===I.type&&(t=I.item.pageTitle,I.markedBookmark=s.markSearch(t,e)),"highlight"===I.type&&(t=I.item.options.selectedText,I.markedHighlight=s.markSearch(t,e)),"note"===I.type&&(t=I.item.options.selectedText,I.markedselectedText=s.markSearch(t,e),t=I.item.options.noteText,I.markedNoteText=s.markSearch(t,e))}var I=this,y=(this.fullNote=!1,this.moreOrLess="GT_SHOW_MORE",this.pageTitle=null,m.hasFeature("schwepsy"));this.$onInit=function(){I.item=I.currentItem,I.type=I.item.type;var e=n.getBookOrAssignmentBySharingId(I.item.sharingId);I.bookContentId=e.book_content_id||n.getBookByLMSId(e.getLMSId()).book_content_id,I.assignmentId=e instanceof i?e.id:void 0,I.book=n.getBookByContentId(I.bookContentId),I.page=I.book.getPage(I.item.pageId,null,!0),I.typeTranslation=o.instant("GT_USER_INPUT_"+I.type.toUpperCase()),I.lang=a.get("lang"),I.page&&I.page.title&&(I.pageTitle=I.page.title),I.item&&I.item.options.serializedData&&(e=JSON.parse(I.item.options.serializedData),I.color=e.color),v(I.searchQuery),I.initItem(),I.resetNoteSettings(),document.addEventListener("mousedown",function(e){var t=document.getElementsByClassName("reader-input-note");t&&t.length&&(t[0].contains(e.target)||(I.resetNoteSettings(),r.$apply()))},!1)},this.$onChanges=function(){I.item=I.currentItem,I.initItem(),I.getAnnotationIcon(),v(I.searchQuery)},this.initItem=function(){I.item&&I.item.options.serializedData&&(9===I.item.options.color.length&&(I.item.options.color="#"+I.item.options.color.substring(3)),I.color=I.item.options.color),I.typeTranslation=o.instant("GT_USER_INPUT_"+I.type.toUpperCase()),I.modalParams={type:"delete",button:o.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:b(I.typeTranslation,I.lang)}),modalButton:o.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:b(I.typeTranslation,I.lang)}),header:o.instant("GT_ALERT_DELETE_USER_INPUT_TITLE",{type:b(I.typeTranslation,I.lang)}),body:o.instant("GT_USER_INPUTS_WARNING_DELETE_"+I.type.toUpperCase())},I.goToAnnotationModal={type:"open",disabled:!I.page,button:o.instant("GT_USER_INPUT_OPEN_ACTION"),modalButton:o.instant("GT_USER_INPUTS_LEAVE_BUTTON"),body:o.instant("GT_USER_INPUTS_WARNING_OPEN_"+I.type.toUpperCase())}},this.openDropdown=function(o){var i=I.annotationMode?d.paginatedData:t._syncData;h(function(){var e,t,n;I.openAnnotationMenu&&i&&(e=I.annotationMode?200:100,e=window.innerHeight-e>o.pageY,t=i.findIndex(function(e){return e.id===I.item.id})+1,n=(I.annotationMode?document.getElementsByClassName("user-input-content"):document.getElementsByTagName("search-results"))[0],t!==i.length&&e||n.scrollBy(0,150))},1)},this.openNoteMode=function(e){I.resetNoteSettings(),I.noteSettings.show=!0,I.noteSettings.edit=!0,I.noteSettings.highlight=I.item,I.noteSettings.note=!0,I.noteSettings.isAnnotationsMode=I.annotationMode,I.noteSettings.isSearchMode=!I.annotationMode,I.noteSettings.serializedHighlight=I.item.options.serializedData,I.noteSettings.pageId=I.item.pageId,I.noteSettings.position={top:e.pageY?e.pageY-300:window.innerHeight/3},I.noteSettings.selectedText=I.item.options.selectedText},this.getAnnotationIcon=function(){var e="note"===I.type?"message":"highlight";return"bookmark"===I.type?"bookmark":e},this.cancelPopup=function(e){e=document.getElementById("more-menu-"+e);e&&e.focus()},this.resetNoteSettings=function(){I.noteSettings={show:!1,position:null,note:!1,edit:!1,highlight:null}},this.goToAnnotation=function(){I.page&&(I.back(),f.bookOpened(I.book,"card","distribution"),e.go("reader.book.page",{book:I.bookContentId,page:I.page.pageId||I.page.path,highlight:I.item.id,scrollTo:I.item.id,assignment:I.assignmentId,search:I.searchQuery},{reload:!0}))},this.delete=function(){var e=void 0;switch(I.item.type){case"highlight":case"note":e=g;break;case"bookmark":e=p;break;default:return}e.remove(I.item).then(function(){var e=o.instant("GT_USER_INPUTS_DELETE_"+I.item.type.toUpperCase()),t=o.instant("GT_CANCEL").toUpperCase();c.success('<span role="alert">'+e+'.</span> <button class="toast-cancel-button">'+t+"</button>",{toastClass:"toast toast-black",timeOut:3e3,allowHtml:!0}),I.annotationMode||u.removeHighlight(I.item.id,y),l.$broadcast("update-annotation",{item:I.item,action:"remove"})})},this.saveAnnotation=function(e,t){g.addAnnotation(t).then(function(e){I.resetNoteSettings(),l.$broadcast("update-annotation",{item:e[0],action:"update"})})},this.showMoreOrLess=function(){I.fullNote=!I.fullNote,I.moreOrLess=I.fullNote?"GT_SHOW_LESS":"GT_SHOW_MORE"},this.open=function(){r.openAnnotationMenu=!r.openAnnotationMenu},this.closeMenu=function(){r.openAnnotationMenu=!1},this.getNoteText=function(){var e=I.item.options.noteText;return s.markSearch(e,I.searchQuery)||e}}]}),angular.module("app").component("readerInputNotDisplayed",{bindings:{settings:"<"},templateUrl:"app/reader/user-input/components/reader-input-not-displayed/reader-input-not-displayed.html",controller:["$state","Library","$translate","SyncService",function(e,t,n,o){var i=this;this.book=t.getBookByContentId(e.params.book),this.$onInit=function(){i.nonDisplayedTitle=n.instant("GT_USER_INPUTS_NOT_DISPLAYED_ALERT",{number:i.settings.number})},this.updateStatus=function(e){i.settings.show=!1,o.updateNdAnnotationsStatus(e)}}]}),angular.module("app").component("readerInputNote",{bindings:{settings:"<",onSave:"&",onDelete:"&",page:"<"},templateUrl:"app/reader/user-input/components/reader-input-note/reader-input-note.html",controller:["Iframe","SyncService","$state","Library","$translate","$filter","$rootScope","KeyCodesService","FirebaseAnalyticsService","AnnotationService","Config","$timeout",function(o,e,t,n,i,r,a,s,c,u,l,d){var g,p=this;this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.id=null,this.color="",this.text="",this.book=n.getBookByContentId(t.params.book),a.isNoteShowing=!1,t.params.assignment&&n.loadAssignmentId(t.params.assignment).then(function(e){p.assignment=e}),document.addEventListener("keydown",function(e){var t,n,o;s.isTab(e)?"saveButton"===document.activeElement.id?s.shiftPrePressed(e)?d(function(){return document.getElementById("closeModalButton").focus()}):p.showColors?(t=document.getElementById("reader-color-reader-note").firstChild.childNodes[1],d(function(){return t.focus()})):(n=document.getElementById("color-picker"))?d(function(){return n.focus()}):(o=document.getElementById("currentNote"))&&o.focus():"color-picker"===document.activeElement.id?!p.showColors&&s.shiftPrePressed(e)&&d(function(){return document.getElementById("saveButton").focus()}):"currentNote"===document.activeElement.id&&s.shiftPrePressed(e)&&d(function(){return document.getElementById("saveButton").focus()}):s.isEscape(e)&&p.displayNote()&&document.getElementById("closeModalButton").click()});this.$doCheck=function(){var e;(e=angular.element(document.getElementsByClassName("highlight-text"))[0])&&e.scrollHeight>e.clientHeight&&e.setAttribute("style","box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -moz-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15); -webkit-box-shadow: 0 4px 10px 0px rgba(0, 0, 0, 0.15)")},this.$onChanges=function(e){p.preventChanges?p.clearPreventChanges():(e=e.settings.currentValue,p.selectedText=r("decodeURI")(e.selectedText),p.color="",p.text="",e.highlight?(p.color=e.highlight.color||e.highlight.options.color,p.id=e.highlight.id,p.text=e.highlight.options.noteText):p.id=null)},this.colorChanged=function(e,t){p.color=t},this.displayNote=function(){return a.isNoteShowing=p.settings.show&&p.settings.note,a.isNoteShowing},this.focusColorPicker=function(e){e?document.getElementById("color-picker").focus():p.isShown=!1,p.selectColorLabel()},this.save=function(e){var t=p.settings.highlight||{options:{}};t.options.color=p.color,t.options.noteText=p.text,p.onSave({event:e,annotation:t})},this.delete=function(e){p.onDelete({event:e,annotation:p.settings.highlight})},this.cancel=function(e){var t;p.settings.highlight&&(t=p.settings.highlight.id,p.setNoChanges(e,t)),p.settings.show=!1,p.isShown=!1,p.settings.isHighlightSelected=!1},this.alignPositionTop=function(){var e=window.innerHeight||document.body.clientHeight,t=p.settings.position.top;return(t=e<t+(g=document.getElementsByClassName("reader-input-note")[0].clientHeight)?e-g-100:t)+"px"},this.alignPositionLeft=function(){var e=window.innerWidth||document.body.clientWidth,t=p.settings.position.left-350,n=(t=t<350?350:t)+700;return(t=(t=e<n?e-700-350:t)<350&&e<n?(e-700)/2:t)+"px"},this.selectColorLabel=function(){var e=p.showColors?i.instant("GT_USER_INPUTS_COLLAPSE"):i.instant("GT_USER_INPUTS_EXPAND");return i.instant("GT_USER_INPUTS_SELECT_COLOR_LABEL")+", "+e},this.isSaveDisabled=function(){var e=!0,t=(p.text&&(e=1e3<p.text.length||p.text.length<=0||p.disableSave),document.getElementById("saveButton"));return setTimeout(function(){t.setAttribute("disabled",e||!1)}),e},this.remainingChars=function(){var e=1e3-(p.text?p.text.length:0);return 0<e?e:0},this.setNoChanges=function(e,t){var n=o.iframe;n&&n.contentWindow&&n.contentWindow.document&&((n=n.contentWindow.document.getElementById(t))&&n.focus(),n)&&s.isEnter(e)&&(p.preventChanges=!0)},this.clearPreventChanges=function(){p.preventChanges=!1,p.settings.show=!1,p.isShown=!1,p.settings.isHighlightSelected=!1}}]}),angular.module("app").component("readerInputToolbar",{bindings:{settings:"<",features:"<",selectedText:"<",page:"<",onSave:"&",onDelete:"&"},templateUrl:"app/reader/user-input/components/reader-input-toolbar/reader-input-toolbar.html",controller:["$scope","Iframe","SyncService","$state","Library","Config","ngDialog","KeyCodesService",function(e,t,n,o,i,r,a,s){var c=this;this.book=i.getBookByContentId(o.params.book),o.params.assignment&&i.loadAssignmentId(o.params.assignment).then(function(e){c.assignment=e}),this.$onInit=function(){c.showGenericDictionary=!1;var e=document.getElementById("input-toolbar");e&&e.focus(),document.addEventListener("keydown",function(e){(c.features.readerHighlightFeature||c.features.readerNoteFeature)&&c.settings.show&&s.isEnter(e)&&(e=document.getElementById("note-text"))&&e.focus()})},this.isOneWordSelected=function(){return c.selectedText.trim().split(" ").length<=1},this.isGenericDictionaryActive=function(){return r.get("features")&&r.get("features").dictionary&&r.get("features").dictionary.value&&"generic"===r.get("features").dictionary.id},this.applyHighlight=function(e,t){var n=c.settings.highlight||{options:{}};n.options.color=t,c.onSave({event:e,annotation:n})},this.toggleNote=function(){c.settings.note=!c.settings.note},this.openGenericDefinition=function(){c.settings.isHighlightSelected=!1,c.showGenericDictionary=!0,c.settings.show=!1},this.delete=function(e){c.onDelete({event:e,annotation:c.settings.highlight})},e.$on("changeZoom",function(){c.settings.show=!1}),this.alignPositionTop=function(){return c.settings.position?c.settings.position.top<60?c.settings.position.top+75+"px":c.settings.position.top+"px":"0px"},this.alignPositionLeft=function(){var e;return c.settings.position?200<(e=window.innerWidth-c.settings.position.left)?c.settings.position.left-135+"px":(e<100?window.innerWidth-375:c.settings.position.left-window.innerWidth/6)+"px":"0px"}}]}),angular.module("app").component("readerTocItem",{bindings:{item:"=",chapterPreview:"<",level:"<",setsize:"<",posinset:"<"},templateUrl:"app/reader/components/reader-toc/components/reader-toc-item/reader-toc-item.html",controller:["$state","$stateParams","Library","$rootScope","$translate","$timeout","TocService","KeyCodesService",function(o,e,t,i,n,r,a,s){var c=this;this.$onInit=function(){c.disabled=c.chapterPreview.enabled&&!c.chapterPreview.pages.includes(c.item.path),c.params=e,c.book=t.getBookByContentId(c.params.book),c.isFirefox="undefined"!=typeof InstallTrigger,c.ariaLive=c.isFirefox?"off":"polite",a.scrollOnPage(c.params.page),c.showChild=c.shouldStayOpen=c._shouldStayOpen(),i.$on("$locationChangeSuccess",function(){c.showChild=c.shouldStayOpen=c._shouldStayOpen()})},this.shouldShowItem=function(e){return!e.hasOwnProperty("display")||"true"===e.display},this.getShownChildren=function(){return c.item.content.filter(c.shouldShowItem)},this.getStatus=function(){return"true"==c.item.isPage?"":c.showChild?n.instant("GT_USER_INPUTS_COLLAPSE"):n.instant("GT_USER_INPUTS_EXPAND")},this.selectedPage=function(){return c.item.path===c.params.page&&"true"===c.item.isPage},this.closeSection=function(e){e.stopPropagation(),c.showChild=!1,c.shouldStayOpen=!1},this.openSection=function(e){e.stopPropagation(),"true"!==c.item.isPage&&(c.showChild||(c.showChild=!0),c.shouldStayOpen||(c.shouldStayOpen=!0))},this.getId=function(){return c.item.path+"-"+c.item.title.replace(/\s+/g,"_")},this.openPage=function(e,t){var n;c.disabled||("true"===c.item.isPage?(i.$broadcast("elementToFocus",null),o.go("reader.book.page",{page:c.item.path,scrollTo:e||null})):(n=c.book.getFirstPageFromStruct(c.item))&&(i.$broadcast("elementToFocus",t.srcElement),o.go("reader.book.page",{page:n.path,scrollTo:e||null})))},this._shouldStayOpen=function(){return c.showChild||null!=c.book.getPageByStruct(c.item,c.params.page)},this.isActive=function(){return"false"==c.item.isPage&&null!=c.book.getPageByStruct(c.item,c.params.page)},this.pageNumber=function(e){if(c.book.isPDF())return c.book.hasLogicalPageNumbers?e.logicalPageNumber:c.book.getIndexOfPage(e.path)+1;for(;e&&"false"==e.isPage&&e.content;)e=e.content[0];return e?c.book.getIndexOfUniquePage(e.path)+1:null},this.getAriaExpanded=function(){var e=void 0;return e="false"===c.item.isPage?!!c.shouldStayOpen:e},this.getVisibleTocItems=function(){var i=[];return document.querySelectorAll(".toc-item").forEach(function(e){for(var t=!0,n=e;n;){var o=getComputedStyle(n);if("none"===o.display||"hidden"===o.visibility){t=!1;break}n=n.parentElement}t&&i.push(e)}),i},this.handleKeyDown=function(e){var t=!1,n=void 0,o=void 0;if(!(e.altKey||e.ctrlKey||e.metaKey))if(e.shift)(s.isEnter(e)||s.isReturn(e))&&e.stopPropagation();else{switch(!0){case s.isSpace(e):case s.isEnter(e):c.openPage(null,e),t=!0;break;case s.isTab(e)&&!e.shiftKey:case s.isArrowDown(e):e.stopPropagation(),(o=(n=c.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))<n.length-1&&n[o+1].focus(),t=!0;break;case s.isTab(e)&&e.shiftKey:case s.isArrowUp(e):e.stopPropagation(),0<(o=(n=c.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))&&n[o-1].focus(),t=!0;break;case s.isArrowLeft(e):e.stopPropagation(),"false"===c.item.isPage&&c.showChild?(c.closeSection(e),t=!0):"true"===c.item.isPage&&e.target.parentNode&&e.target.parentNode.parentNode&&e.target.parentNode.parentNode.parentNode&&"group"===e.target.parentNode.parentNode.parentNode.getAttribute("role")&&(e.target.parentNode.parentNode.parentNode.previousElementSibling.focus(),t=!0);break;case s.isArrowRight(e):e.stopPropagation(),"false"!==c.item.isPage||c.showChild?(o=(n=c.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))<n.length-1&&n[o+1].focus():c.openSection(e),t=!0;break;case s.isHome(e):(n=c.getVisibleTocItems())[0].focus(),t=!0;break;case s.isEnd(e):(n=c.getVisibleTocItems())[n.length-1].focus(),t=!0}t&&(e.preventDefault(),e.stopPropagation())}}}]}),angular.module("app").directive("newTocReaderItem",["RecursionHelper","$rootScope","$timeout","$injector",function(i,c,e,u){return{restrict:"AE",scope:{item:"=",chapterPreview:"<",level:"<",setsize:"<",posinset:"<"},templateUrl:"app/reader/components/reader-toc/components/reader-toc-item-new/reader-toc-item-new.html",compile:function(e){var t=u.get("Library"),o=u.get("$state"),n=u.get("$stateParams"),r=u.get("$translate"),a=u.get("TocService"),s=u.get("KeyCodesService");return i.compile(e,function(i){i.disabled=i.chapterPreview.enabled&&!i.chapterPreview.pages.includes(i.item.pageId),i.params=n,i.book=t.getBookByContentId(i.params.book),i.isFirefox="undefined"!=typeof InstallTrigger,i.ariaLive=i.isFirefox?"off":"polite",a.scrollOnPage(i.params.page),i.getStatus=function(){return"true"==i.item.isPage?"":i.showChild?r.instant("GT_USER_INPUTS_COLLAPSE"):r.instant("GT_USER_INPUTS_EXPAND")},i.isSelectedPage=function(){var e=null,t=i.params.page,n=i.book.getCountPage(t);return n&&(e=n.target.split("#")[0]),i.item.id===t||i.item.target.includes(e)},i.closeSection=function(e){e.stopPropagation(),i.showChild=!1,i.shouldStayOpen=!1},i.openSection=function(e){e.stopPropagation(),i.item.children&&(i.showChild||(i.showChild=!0),i.shouldStayOpen||(i.shouldStayOpen=!0))},i.getId=function(){return i.item.id+"-"+i.item.title.replace(/\s+/g,"_")},i.openPage=function(e){var t,n;i.disabled||(n=null,(t=i.item.target.split("#"))&&(n=t[1]),o.go("reader.book.page",{page:i.item.id,scrollTo:e||n}))},i._shouldStayOpen=function(){return!!i.item.children&&(i.showChild||i.book.getPage(i.params.page,i.item.children))},i.pageNumber=function(t){var e,n=void 0;if(n=i.book.hasPageBreak?i.book.countPages.find(function(e){return e.target.includes(t.target)}):(e=i.book.getIndexOfPageV2(t.pageId),i.book.navigationPages[e]))return n.num},i.getAriaExpanded=function(){var e=void 0;return e=i.item.children&&i.item.children.length?!!i.showChild:e},i.getVisibleTocItems=function(){var i=[];return document.querySelectorAll(".toc-item").forEach(function(e){for(var t=!0,n=e;n;){var o=getComputedStyle(n);if("none"===o.display||"hidden"===o.visibility){t=!1;break}n=n.parentElement}t&&i.push(e)}),i},i.onKeydown=function(e){var t=!1,n=void 0,o=void 0;if(!(e.altKey||e.ctrlKey||e.metaKey)){if(e.shift)(s.isEnter(e)||s.isReturn(e))&&e.stopPropagation();else switch(!0){case s.isSpace(e):case s.isEnter(e):i.openPage(),t=!0;break;case s.isTab(e)&&e.shiftKey:case s.isArrowUp(e):0<(o=(n=i.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))&&n[o-1].focus(),t=!0;break;case s.isTab(e)&&!e.shiftKey:case s.isArrowDown(e):(o=(n=i.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))<n.length-1&&n[o+1].focus(),t=!0;break;case s.isArrowRight(e):i.item.children&&(i.showChild?(o=(n=i.getVisibleTocItems()).findIndex(function(e){return e===document.activeElement||document.activeElement.parentElement.querySelector('[role="treeitem"]')===e}))<n.length-1&&n[o+1].focus():i.openSection(e)),t=!0;break;case s.isArrowLeft(e):i.item.children&&i.showChild?(i.closeSection(e),t=!0):e.target.parentNode&&e.target.parentNode.parentNode&&e.target.parentNode.parentNode.parentNode&&"group"===e.target.parentNode.parentNode.parentNode.getAttribute("role")&&(e.target.parentNode.parentNode.parentNode.previousElementSibling.focus(),t=!0);break;case s.isHome(e):(n=i.getVisibleTocItems())[0].focus(),t=!0;break;case s.isEnd(e):(n=i.getVisibleTocItems())[n.length-1].focus(),t=!0}t&&(e.stopPropagation(),e.preventDefault())}},i.showChild=i.shouldStayOpen=i._shouldStayOpen(),c.$on("$locationChangeSuccess",function(){i.showChild=i.shouldStayOpen=i._shouldStayOpen()})})}}}]),angular.module("app").component("searchResultItem",{bindings:{searchQuery:"<",result:"=",book:"<",back:"&",chapterPreview:"<"},templateUrl:"app/reader/components/search-results/components/search-result-item/search-result-item.html",controller:["$state","$sce","$translate","TocService",function(n,t,o,i){var r=this;this.collapsed=!1,this.$onInit=function(){r.markedIndex=[],r.previews=r.result.previews.map(function(e){return r.findMarkedElementsIndex(e.preview),{occurrences:e.occurrences,previewText:t.trustAsHtml(" ..."+e.preview+"... "),ariaLabelText:r.getAriaLabel(e.preview)}}),r.page=r.getPageByIndex(),r.pageTitle=r.page.title||r.result.pageTitle,r.occurrences=r.result.totalOccurrences},this.findMarkedElementsIndex=function(e){var t=new RegExp("<mark[^>]*>","g");e&&t.test(e)&&r.markedIndex.push(e.match(t).length)},this.findItemIndex=function(o){return 0===o?1:r.markedIndex.reduce(function(e,t,n){return n<=o?e+t:e})},this.getPageByIndex=function(){var e={};return r.book.structure.version&&(e=r.book.navigationPages[r.result.pageIndex],r.book.isEpubReflowWithoutPageBreak())?r.book.getTocPageByPageId(r.book.structure.toc,e.pageId):e},this.goToPage=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;e.srcElement.classList.contains("occurrences-button")||e.srcElement.classList.contains("show-more-less-btn")?r.showMoreLess():(n.go("reader.book.page",{page:r.page.id||r.result.pageContentId,search:r.searchQuery,scrollTo:"search-text-"+r.findItemIndex(t)}),r.back(),i.scrollOnPage(r.page.id||r.result.pageContentId))},this.showMoreLess=function(e){e&&e.stopPropagation(),r.collapsed=!r.collapsed},this.getPageTitle=function(){var e=(e=""+o.instant("GT_SEARCH_PAGE_TITLE")+r.pageTitle).replace(new RegExp("</?.*?[^<>]*>","gi"),"");return t.trustAsHtml(e)},this.isRestricted=function(){return r.page&&r.chapterPreview.enabled&&!r.chapterPreview.pages.includes(r.page.pageId||r.result.pageContentId)},this.buttonAriaLabel=function(){return r.collapsed?o.instant("GT_USER_INPUTS_EXPAND"):o.instant("GT_USER_INPUTS_COLLAPSE")},this.getAriaLabel=function(e){return e.replace(new RegExp("</?.*?[^<>]*>","gi"),"")}}]});
</script>

</body>
</html>
