<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>clientlib-datalayer.lc-0dc284515b2dc41eca6189108ac1bf6f-lc.min.html</title>
</head>
<body>

<script>
jQuery(document).ready(function($) {
    window.digitalData.form.lead = window.digitalData.form.lead  || {};
    //console.log(window.digitalData);
    var mkto_lead_id;
    // Read _devrun_mkto_lead cookie
    var match_devrun_mkto_lead = document.cookie.match(new RegExp('(^| )' + "_devrun_mkto_lead" + '=([^;]+)'));
    // If cookie exists, read lead ID & set eVars
    //console.log(match_devrun_mkto_lead);
    if(match_devrun_mkto_lead){
        mkto_lead_id = match_devrun_mkto_lead[2];
        //console.log('Got lead ID from cookie storage: ' + mkto_lead_id);
        window.digitalData.form.lead.id = mkto_lead_id;
        window.digitalData.form.lead.status = "known";
        window.digitalData.form.lead.api = false;
    }
    // If cookie doesn't exist, get _mkto_trk & make Ajax call
    else{
        var match_mkto_trk = document.cookie.match(new RegExp('(^| )' + "_mkto_trk" + '=([^;]+)'));
        //console.log(match_mkto_trk);
        if(match_mkto_trk){
            var _mkto_trk = match_mkto_trk[2];
            var data = {
                action: 'get_leadid',
                cookie_value: encodeURIComponent(_mkto_trk)
            };
            /**
             * The following post ajax call needs the supporting Devrun server-side code to work. That was written for WordPress/php and will need to be adapted to AEM/Java.
             */
            /* Remove this comment to enable the ajax call once the server-side code is ready
            jQuery.post('https://anaplansolustg.wpengine.com/wp-admin/admin-ajax.php', data, function(response) {
                console.log('Got lead ID from API call: ' + response);
                if(response !== "lead not found"){
                    window.digitalData.form.lead = window.digitalData.form.lead || {};
                    window.digitalData.form.lead.id = response;
                    window.digitalData.form.lead.status = "known";
                    window.digitalData.form.lead.api = true;
                    // Insert a cookie with the lead ID
                    document.cookie = "_devrun_mkto_lead=" + window.digitalData.form.lead.id + "; max-age=" + 30 * 24 * 60 * 60 + ";path=/;secure";
                }else{
                    window.digitalData.form.lead.id = "na";
                    window.digitalData.form.lead.status = "unknown";
                    window.digitalData.form.lead.api = true;
                }
            });*/
        } else{
            console.log("_mkto_trk not found");
        }
    }
});

</script>

</body>
</html>
