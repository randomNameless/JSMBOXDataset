<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>same-heights-for-puffs.html</title>
</head>
<body>

<script>
/**
 * This script lives in https://tfs.its.uu.se/DefaultCollection/Webbplattform/_git/misc-js
 *
 * This Javascript will resize all puffs on the page to the height of their biggest sibling.
 */

(() => {
  const STYLE_SHEET_ID = 'custom-puff-heights';
  const MAIN_COLUMN_SELECTOR = '#Mittenspalt';
  const PUFF_SELECTOR = '.sv-se-uu-uit-webb-puff, .sv-se-uu-uit-webb-webapp-linked-cards-event, .sv-portlet:has([id^="Lankadmodul"]), .sv-se-uu-uit-webb-webapp-linked-cards-archive';
  const CARD_BODY_SELECTOR = '.uu-blurb__content';
  const CARD_SELECTOR = `${CARD_BODY_SELECTOR}`;
  const PARENT_SELECTOR = '.sv-layout .sv-row, .sv-layout .sv-horizontal, .sv-layout .sv-vertical';
  const CUSTOM_CLASS_PREFIX = 'custom-height-';
  const BREAKPOINT = 768;
  const MAIN_COLUMN_ELEMENT = document.querySelector(MAIN_COLUMN_SELECTOR);

  /**
   *  Gets a style sheet element in which to put custom CSS rules.
   *  Creates it if necessary.
   */
  const getCustomStyle = () => {
    let style = document.getElementById(STYLE_SHEET_ID);
    if (!style) {
      style = document.createElement('style');
      style.id = STYLE_SHEET_ID;
      document.head.appendChild(style);
    }
    return style;
  };

  /**
   * Removes the custom style sheet from the DOM and its rules with it.
   */
  const removeCustomStyle = () => {
    const style = document.getElementById(STYLE_SHEET_ID);
    if (style) {
      style.disabled = true;
      style.parentNode.removeChild(style);
    }
  };

  /**
   * Tries to find an ancestor element that probably contains this puff's
   * siblings by matching against a set of CSS classes.
   */
  const findPuffContainer = (puff) => {
    let element = puff;
    while (
      !element.matches(PARENT_SELECTOR) &&
      element.parentNode &&
      // Don't go as high as the "Mittenspalt", since that would put all puffs
      // in the same container.
      element.parentNode !== MAIN_COLUMN_ELEMENT
    ) {
      element = element.parentNode;
    }
    return element;
  };

  /**
   * Finds all puffs on the page and makes them the same height as their immediate siblings.
   * The biggest puff decides the height.
   */
  const setPuffsToSameHeight = (puffSelector, cardSelector) => {
    // Find the all the Sitevision generated divs that hold a number of puffs each.
    // Since they have no good classes we need to find a puff generated by our puff
    // module and then use its grand parent.
    const puffSelectorList = [...document.querySelectorAll(puffSelector)];
    const puffContainers = puffSelectorList
      .map((puff) => {
        return findPuffContainer(puff);
      })
      // Remove duplicates
      .filter((value, index, self) => {
        return self.indexOf(value) === index;
      });

    // For each of these "puff containers" we'll iterate over its puffs and find the biggest height.
    // Then we'll resize all of the puffs in the puff container to that height.
    puffContainers.forEach((puffContainer) => {
      // We want to exclude the main container that includes everything
      if (!puffContainer.outerHTML.includes('<main')) {
        let maxHeight = 0;
        // Find biggest height
        const cards = [...puffContainer.querySelectorAll(cardSelector)];
        cards.forEach(
          (card) => {
            maxHeight = Math.max(maxHeight, card.offsetHeight);
          }
        );

        // Create a new CSS class
        const customClass = CUSTOM_CLASS_PREFIX + Math.floor(Math.random() * 100000000);

        // First, remove any previous custom height classes
        const puffContainerClassList = puffContainer.classList;
        puffContainerClassList.forEach((className) => {
          if (className.startsWith(CUSTOM_CLASS_PREFIX)) {
            puffContainerClassList.remove(className);
          }
        });
        puffContainerClassList.add(customClass);

        // Get the custom style sheet (or create a new) that will reference the custom class.
        const style = getCustomStyle();
        // Add a rule for widths of at least BREAKPOINT pixels that sets the height to the
        // biggest height
        style.textContent +=
           `@media screen and (min-width: ${BREAKPOINT}px) {
              .${customClass} ${CARD_BODY_SELECTOR} {
                height: ${maxHeight}px !important;
              }
            }`;
      }
    });
  };

  /**
   * Event handler that removes any previous custom styles set with this script
   * and then calls setPuffsToSameHeight().
   */
  const readjustPuffHeights = () => {
    // We need to remove the custom style sheet to prevent the page being flooded
    // with style elements.
    removeCustomStyle();
    setPuffsToSameHeight(PUFF_SELECTOR, CARD_SELECTOR);
  };

  // Adjust puff heights on window resize
  window.addEventListener('resize', readjustPuffHeights);

  // Adjust puff heights immediately
  setPuffsToSameHeight(PUFF_SELECTOR, CARD_SELECTOR);
})();

</script>

</body>
</html>
