<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>plumbertracewithoutpouchdbwithbeaconsendwithlocalstorage_h5v35.html</title>
</head>
<body>

<script>

/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/
var CryptoJS=CryptoJS||function(u,p){var d={},l=d.lib={},s=function(){},t=l.Base={extend:function(a){s.prototype=this;var c=new s;a&&c.mixIn(a);c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments)});c.init.prototype=c;c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},
r=l.WordArray=t.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=p?c:4*a.length},toString:function(a){return(a||v).stringify(this)},concat:function(a){var c=this.words,e=a.words,j=this.sigBytes;a=a.sigBytes;this.clamp();if(j%4)for(var k=0;k<a;k++)c[j+k>>>2]|=(e[k>>>2]>>>24-8*(k%4)&255)<<24-8*((j+k)%4);else if(65535<e.length)for(k=0;k<a;k+=4)c[j+k>>>2]=e[k>>>2];else c.push.apply(c,e);this.sigBytes+=a;return this},clamp:function(){var a=this.words,c=this.sigBytes;a[c>>>2]&=4294967295<<
32-8*(c%4);a.length=u.ceil(c/4)},clone:function(){var a=t.clone.call(this);a.words=this.words.slice(0);return a},random:function(a){for(var c=[],e=0;e<a;e+=4)c.push(4294967296*u.random()|0);return new r.init(c,a)}}),w=d.enc={},v=w.Hex={stringify:function(a){var c=a.words;a=a.sigBytes;for(var e=[],j=0;j<a;j++){var k=c[j>>>2]>>>24-8*(j%4)&255;e.push((k>>>4).toString(16));e.push((k&15).toString(16))}return e.join("")},parse:function(a){for(var c=a.length,e=[],j=0;j<c;j+=2)e[j>>>3]|=parseInt(a.substr(j,
2),16)<<24-4*(j%8);return new r.init(e,c/2)}},b=w.Latin1={stringify:function(a){var c=a.words;a=a.sigBytes;for(var e=[],j=0;j<a;j++)e.push(String.fromCharCode(c[j>>>2]>>>24-8*(j%4)&255));return e.join("")},parse:function(a){for(var c=a.length,e=[],j=0;j<c;j++)e[j>>>2]|=(a.charCodeAt(j)&255)<<24-8*(j%4);return new r.init(e,c)}},x=w.Utf8={stringify:function(a){try{return decodeURIComponent(escape(b.stringify(a)))}catch(c){throw Error("Malformed UTF-8 data");}},parse:function(a){return b.parse(unescape(encodeURIComponent(a)))}},
q=l.BufferedBlockAlgorithm=t.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=x.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(a){var c=this._data,e=c.words,j=c.sigBytes,k=this.blockSize,b=j/(4*k),b=a?u.ceil(b):u.max((b|0)-this._minBufferSize,0);a=b*k;j=u.min(4*a,j);if(a){for(var q=0;q<a;q+=k)this._doProcessBlock(e,q);q=e.splice(0,a);c.sigBytes-=j}return new r.init(q,j)},clone:function(){var a=t.clone.call(this);
a._data=this._data.clone();return a},_minBufferSize:0});l.Hasher=q.extend({cfg:t.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){q.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,e){return(new a.init(e)).finalize(b)}},_createHmacHelper:function(a){return function(b,e){return(new n.HMAC.init(a,
e)).finalize(b)}}});var n=d.algo={};return d}(Math);
(function(){var u=CryptoJS,p=u.lib.WordArray;u.enc.Base64={stringify:function(d){var l=d.words,p=d.sigBytes,t=this._map;d.clamp();d=[];for(var r=0;r<p;r+=3)for(var w=(l[r>>>2]>>>24-8*(r%4)&255)<<16|(l[r+1>>>2]>>>24-8*((r+1)%4)&255)<<8|l[r+2>>>2]>>>24-8*((r+2)%4)&255,v=0;4>v&&r+0.75*v<p;v++)d.push(t.charAt(w>>>6*(3-v)&63));if(l=t.charAt(64))for(;d.length%4;)d.push(l);return d.join("")},parse:function(d){var l=d.length,s=this._map,t=s.charAt(64);t&&(t=d.indexOf(t),-1!=t&&(l=t));for(var t=[],r=0,w=0;w<
l;w++)if(w%4){var v=s.indexOf(d.charAt(w-1))<<2*(w%4),b=s.indexOf(d.charAt(w))>>>6-2*(w%4);t[r>>>2]|=(v|b)<<24-8*(r%4);r++}return p.create(t,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();
(function(u){function p(b,n,a,c,e,j,k){b=b+(n&a|~n&c)+e+k;return(b<<j|b>>>32-j)+n}function d(b,n,a,c,e,j,k){b=b+(n&c|a&~c)+e+k;return(b<<j|b>>>32-j)+n}function l(b,n,a,c,e,j,k){b=b+(n^a^c)+e+k;return(b<<j|b>>>32-j)+n}function s(b,n,a,c,e,j,k){b=b+(a^(n|~c))+e+k;return(b<<j|b>>>32-j)+n}for(var t=CryptoJS,r=t.lib,w=r.WordArray,v=r.Hasher,r=t.algo,b=[],x=0;64>x;x++)b[x]=4294967296*u.abs(u.sin(x+1))|0;r=r.MD5=v.extend({_doReset:function(){this._hash=new w.init([1732584193,4023233417,2562383102,271733878])},
_doProcessBlock:function(q,n){for(var a=0;16>a;a++){var c=n+a,e=q[c];q[c]=(e<<8|e>>>24)&16711935|(e<<24|e>>>8)&4278255360}var a=this._hash.words,c=q[n+0],e=q[n+1],j=q[n+2],k=q[n+3],z=q[n+4],r=q[n+5],t=q[n+6],w=q[n+7],v=q[n+8],A=q[n+9],B=q[n+10],C=q[n+11],u=q[n+12],D=q[n+13],E=q[n+14],x=q[n+15],f=a[0],m=a[1],g=a[2],h=a[3],f=p(f,m,g,h,c,7,b[0]),h=p(h,f,m,g,e,12,b[1]),g=p(g,h,f,m,j,17,b[2]),m=p(m,g,h,f,k,22,b[3]),f=p(f,m,g,h,z,7,b[4]),h=p(h,f,m,g,r,12,b[5]),g=p(g,h,f,m,t,17,b[6]),m=p(m,g,h,f,w,22,b[7]),
f=p(f,m,g,h,v,7,b[8]),h=p(h,f,m,g,A,12,b[9]),g=p(g,h,f,m,B,17,b[10]),m=p(m,g,h,f,C,22,b[11]),f=p(f,m,g,h,u,7,b[12]),h=p(h,f,m,g,D,12,b[13]),g=p(g,h,f,m,E,17,b[14]),m=p(m,g,h,f,x,22,b[15]),f=d(f,m,g,h,e,5,b[16]),h=d(h,f,m,g,t,9,b[17]),g=d(g,h,f,m,C,14,b[18]),m=d(m,g,h,f,c,20,b[19]),f=d(f,m,g,h,r,5,b[20]),h=d(h,f,m,g,B,9,b[21]),g=d(g,h,f,m,x,14,b[22]),m=d(m,g,h,f,z,20,b[23]),f=d(f,m,g,h,A,5,b[24]),h=d(h,f,m,g,E,9,b[25]),g=d(g,h,f,m,k,14,b[26]),m=d(m,g,h,f,v,20,b[27]),f=d(f,m,g,h,D,5,b[28]),h=d(h,f,
m,g,j,9,b[29]),g=d(g,h,f,m,w,14,b[30]),m=d(m,g,h,f,u,20,b[31]),f=l(f,m,g,h,r,4,b[32]),h=l(h,f,m,g,v,11,b[33]),g=l(g,h,f,m,C,16,b[34]),m=l(m,g,h,f,E,23,b[35]),f=l(f,m,g,h,e,4,b[36]),h=l(h,f,m,g,z,11,b[37]),g=l(g,h,f,m,w,16,b[38]),m=l(m,g,h,f,B,23,b[39]),f=l(f,m,g,h,D,4,b[40]),h=l(h,f,m,g,c,11,b[41]),g=l(g,h,f,m,k,16,b[42]),m=l(m,g,h,f,t,23,b[43]),f=l(f,m,g,h,A,4,b[44]),h=l(h,f,m,g,u,11,b[45]),g=l(g,h,f,m,x,16,b[46]),m=l(m,g,h,f,j,23,b[47]),f=s(f,m,g,h,c,6,b[48]),h=s(h,f,m,g,w,10,b[49]),g=s(g,h,f,m,
E,15,b[50]),m=s(m,g,h,f,r,21,b[51]),f=s(f,m,g,h,u,6,b[52]),h=s(h,f,m,g,k,10,b[53]),g=s(g,h,f,m,B,15,b[54]),m=s(m,g,h,f,e,21,b[55]),f=s(f,m,g,h,v,6,b[56]),h=s(h,f,m,g,x,10,b[57]),g=s(g,h,f,m,t,15,b[58]),m=s(m,g,h,f,D,21,b[59]),f=s(f,m,g,h,z,6,b[60]),h=s(h,f,m,g,C,10,b[61]),g=s(g,h,f,m,j,15,b[62]),m=s(m,g,h,f,A,21,b[63]);a[0]=a[0]+f|0;a[1]=a[1]+m|0;a[2]=a[2]+g|0;a[3]=a[3]+h|0},_doFinalize:function(){var b=this._data,n=b.words,a=8*this._nDataBytes,c=8*b.sigBytes;n[c>>>5]|=128<<24-c%32;var e=u.floor(a/
4294967296);n[(c+64>>>9<<4)+15]=(e<<8|e>>>24)&16711935|(e<<24|e>>>8)&4278255360;n[(c+64>>>9<<4)+14]=(a<<8|a>>>24)&16711935|(a<<24|a>>>8)&4278255360;b.sigBytes=4*(n.length+1);this._process();b=this._hash;n=b.words;for(a=0;4>a;a++)c=n[a],n[a]=(c<<8|c>>>24)&16711935|(c<<24|c>>>8)&4278255360;return b},clone:function(){var b=v.clone.call(this);b._hash=this._hash.clone();return b}});t.MD5=v._createHelper(r);t.HmacMD5=v._createHmacHelper(r)})(Math);
(function(){var u=CryptoJS,p=u.lib,d=p.Base,l=p.WordArray,p=u.algo,s=p.EvpKDF=d.extend({cfg:d.extend({keySize:4,hasher:p.MD5,iterations:1}),init:function(d){this.cfg=this.cfg.extend(d)},compute:function(d,r){for(var p=this.cfg,s=p.hasher.create(),b=l.create(),u=b.words,q=p.keySize,p=p.iterations;u.length<q;){n&&s.update(n);var n=s.update(d).finalize(r);s.reset();for(var a=1;a<p;a++)n=s.finalize(n),s.reset();b.concat(n)}b.sigBytes=4*q;return b}});u.EvpKDF=function(d,l,p){return s.create(p).compute(d,
l)}})();
CryptoJS.lib.Cipher||function(u){var p=CryptoJS,d=p.lib,l=d.Base,s=d.WordArray,t=d.BufferedBlockAlgorithm,r=p.enc.Base64,w=p.algo.EvpKDF,v=d.Cipher=t.extend({cfg:l.extend(),createEncryptor:function(e,a){return this.create(this._ENC_XFORM_MODE,e,a)},createDecryptor:function(e,a){return this.create(this._DEC_XFORM_MODE,e,a)},init:function(e,a,b){this.cfg=this.cfg.extend(b);this._xformMode=e;this._key=a;this.reset()},reset:function(){t.reset.call(this);this._doReset()},process:function(e){this._append(e);return this._process()},
finalize:function(e){e&&this._append(e);return this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(b,k,d){return("string"==typeof k?c:a).encrypt(e,b,k,d)},decrypt:function(b,k,d){return("string"==typeof k?c:a).decrypt(e,b,k,d)}}}});d.StreamCipher=v.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var b=p.mode={},x=function(e,a,b){var c=this._iv;c?this._iv=u:c=this._prevBlock;for(var d=0;d<b;d++)e[a+d]^=
c[d]},q=(d.BlockCipherMode=l.extend({createEncryptor:function(e,a){return this.Encryptor.create(e,a)},createDecryptor:function(e,a){return this.Decryptor.create(e,a)},init:function(e,a){this._cipher=e;this._iv=a}})).extend();q.Encryptor=q.extend({processBlock:function(e,a){var b=this._cipher,c=b.blockSize;x.call(this,e,a,c);b.encryptBlock(e,a);this._prevBlock=e.slice(a,a+c)}});q.Decryptor=q.extend({processBlock:function(e,a){var b=this._cipher,c=b.blockSize,d=e.slice(a,a+c);b.decryptBlock(e,a);x.call(this,
e,a,c);this._prevBlock=d}});b=b.CBC=q;q=(p.pad={}).Pkcs7={pad:function(a,b){for(var c=4*b,c=c-a.sigBytes%c,d=c<<24|c<<16|c<<8|c,l=[],n=0;n<c;n+=4)l.push(d);c=s.create(l,c);a.concat(c)},unpad:function(a){a.sigBytes-=a.words[a.sigBytes-1>>>2]&255}};d.BlockCipher=v.extend({cfg:v.cfg.extend({mode:b,padding:q}),reset:function(){v.reset.call(this);var a=this.cfg,b=a.iv,a=a.mode;if(this._xformMode==this._ENC_XFORM_MODE)var c=a.createEncryptor;else c=a.createDecryptor,this._minBufferSize=1;this._mode=c.call(a,
this,b&&b.words)},_doProcessBlock:function(a,b){this._mode.processBlock(a,b)},_doFinalize:function(){var a=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){a.pad(this._data,this.blockSize);var b=this._process(!0)}else b=this._process(!0),a.unpad(b);return b},blockSize:4});var n=d.CipherParams=l.extend({init:function(a){this.mixIn(a)},toString:function(a){return(a||this.formatter).stringify(this)}}),b=(p.format={}).OpenSSL={stringify:function(a){var b=a.ciphertext;a=a.salt;return(a?s.create([1398893684,
1701076831]).concat(a).concat(b):b).toString(r)},parse:function(a){a=r.parse(a);var b=a.words;if(1398893684==b[0]&&1701076831==b[1]){var c=s.create(b.slice(2,4));b.splice(0,4);a.sigBytes-=16}return n.create({ciphertext:a,salt:c})}},a=d.SerializableCipher=l.extend({cfg:l.extend({format:b}),encrypt:function(a,b,c,d){d=this.cfg.extend(d);var l=a.createEncryptor(c,d);b=l.finalize(b);l=l.cfg;return n.create({ciphertext:b,key:c,iv:l.iv,algorithm:a,mode:l.mode,padding:l.padding,blockSize:a.blockSize,formatter:d.format})},
decrypt:function(a,b,c,d){d=this.cfg.extend(d);b=this._parse(b,d.format);return a.createDecryptor(c,d).finalize(b.ciphertext)},_parse:function(a,b){return"string"==typeof a?b.parse(a,this):a}}),p=(p.kdf={}).OpenSSL={execute:function(a,b,c,d){d||(d=s.random(8));a=w.create({keySize:b+c}).compute(a,d);c=s.create(a.words.slice(b),4*c);a.sigBytes=4*b;return n.create({key:a,iv:c,salt:d})}},c=d.PasswordBasedCipher=a.extend({cfg:a.cfg.extend({kdf:p}),encrypt:function(b,c,d,l){l=this.cfg.extend(l);d=l.kdf.execute(d,
b.keySize,b.ivSize);l.iv=d.iv;b=a.encrypt.call(this,b,c,d.key,l);b.mixIn(d);return b},decrypt:function(b,c,d,l){l=this.cfg.extend(l);c=this._parse(c,l.format);d=l.kdf.execute(d,b.keySize,b.ivSize,c.salt);l.iv=d.iv;return a.decrypt.call(this,b,c,d.key,l)}})}();
(function(){for(var u=CryptoJS,p=u.lib.BlockCipher,d=u.algo,l=[],s=[],t=[],r=[],w=[],v=[],b=[],x=[],q=[],n=[],a=[],c=0;256>c;c++)a[c]=128>c?c<<1:c<<1^283;for(var e=0,j=0,c=0;256>c;c++){var k=j^j<<1^j<<2^j<<3^j<<4,k=k>>>8^k&255^99;l[e]=k;s[k]=e;var z=a[e],F=a[z],G=a[F],y=257*a[k]^16843008*k;t[e]=y<<24|y>>>8;r[e]=y<<16|y>>>16;w[e]=y<<8|y>>>24;v[e]=y;y=16843009*G^65537*F^257*z^16843008*e;b[k]=y<<24|y>>>8;x[k]=y<<16|y>>>16;q[k]=y<<8|y>>>24;n[k]=y;e?(e=z^a[a[a[G^z]]],j^=a[a[j]]):e=j=1}var H=[0,1,2,4,8,
16,32,64,128,27,54],d=d.AES=p.extend({_doReset:function(){for(var a=this._key,c=a.words,d=a.sigBytes/4,a=4*((this._nRounds=d+6)+1),e=this._keySchedule=[],j=0;j<a;j++)if(j<d)e[j]=c[j];else{var k=e[j-1];j%d?6<d&&4==j%d&&(k=l[k>>>24]<<24|l[k>>>16&255]<<16|l[k>>>8&255]<<8|l[k&255]):(k=k<<8|k>>>24,k=l[k>>>24]<<24|l[k>>>16&255]<<16|l[k>>>8&255]<<8|l[k&255],k^=H[j/d|0]<<24);e[j]=e[j-d]^k}c=this._invKeySchedule=[];for(d=0;d<a;d++)j=a-d,k=d%4?e[j]:e[j-4],c[d]=4>d||4>=j?k:b[l[k>>>24]]^x[l[k>>>16&255]]^q[l[k>>>
8&255]]^n[l[k&255]]},encryptBlock:function(a,b){this._doCryptBlock(a,b,this._keySchedule,t,r,w,v,l)},decryptBlock:function(a,c){var d=a[c+1];a[c+1]=a[c+3];a[c+3]=d;this._doCryptBlock(a,c,this._invKeySchedule,b,x,q,n,s);d=a[c+1];a[c+1]=a[c+3];a[c+3]=d},_doCryptBlock:function(a,b,c,d,e,j,l,f){for(var m=this._nRounds,g=a[b]^c[0],h=a[b+1]^c[1],k=a[b+2]^c[2],n=a[b+3]^c[3],p=4,r=1;r<m;r++)var q=d[g>>>24]^e[h>>>16&255]^j[k>>>8&255]^l[n&255]^c[p++],s=d[h>>>24]^e[k>>>16&255]^j[n>>>8&255]^l[g&255]^c[p++],t=
d[k>>>24]^e[n>>>16&255]^j[g>>>8&255]^l[h&255]^c[p++],n=d[n>>>24]^e[g>>>16&255]^j[h>>>8&255]^l[k&255]^c[p++],g=q,h=s,k=t;q=(f[g>>>24]<<24|f[h>>>16&255]<<16|f[k>>>8&255]<<8|f[n&255])^c[p++];s=(f[h>>>24]<<24|f[k>>>16&255]<<16|f[n>>>8&255]<<8|f[g&255])^c[p++];t=(f[k>>>24]<<24|f[n>>>16&255]<<16|f[g>>>8&255]<<8|f[h&255])^c[p++];n=(f[n>>>24]<<24|f[g>>>16&255]<<16|f[h>>>8&255]<<8|f[k&255])^c[p++];a[b]=q;a[b+1]=s;a[b+2]=t;a[b+3]=n},keySize:8});u.AES=p._createHelper(d)})();
//标准aes需要添加ECB模式和NoPadding模式
CryptoJS.mode.ECB=function(){var a=CryptoJS.lib.BlockCipherMode.extend();a.Encryptor=a.extend({processBlock:function(a,b){this._cipher.encryptBlock(a,b)}});a.Decryptor=a.extend({processBlock:function(a,b){this._cipher.decryptBlock(a,b)}});return a}();
CryptoJS.pad.NoPadding={pad:function(){},unpad:function(){}};


//***********************************postmate */
/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.6.0
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function (e, t) { "object" == typeof exports && "undefined" != typeof module ? module.exports = t() : "function" == typeof define && define.amd ? define(t) : (e = e || self).Postmate = t() }(this, function () { "use strict"; var h = "application/x-postmate-v1+json", r = 0, n = { handshake: 1, "handshake-reply": 1, call: 1, emit: 1, reply: 1, request: 1 }, p = function (e, t) { return ("string" != typeof t || e.origin === t) && (!!e.data && (("object" != typeof e.data || "postmate" in e.data) && (e.data.type === h && !!n[e.data.postmate]))) }, c = function () { function e(e) { var a = this; this.parent = e.parent, this.frame = e.frame, this.child = e.child, this.childOrigin = e.childOrigin, this.events = {}, this.listener = function (e) { if (!p(e, a.childOrigin)) return !1; var t = ((e || {}).data || {}).value || {}, n = t.data, i = t.name; "emit" === e.data.postmate && i in a.events && a.events[i].forEach(function (e) { e.call(a, n) }) }, this.parent.addEventListener("message", this.listener, !1) } var t = e.prototype; return t.get = function (e) { var a = this; return new l.Promise(function (n) { var i = ++r; a.parent.addEventListener("message", function e(t) { t.data.uid === i && "reply" === t.data.postmate && (a.parent.removeEventListener("message", e, !1), n(t.data.value)) }, !1), a.child.postMessage({ postmate: "request", type: h, property: e, uid: i }, a.childOrigin) }) }, t.call = function (e, t) { this.child.postMessage({ postmate: "call", type: h, property: e, data: t }, this.childOrigin) }, t.on = function (e, t) { this.events[e] || (this.events[e] = []), this.events[e].push(t) }, t.destroy = function () { window.removeEventListener("message", this.listener, !1), this.frame.parentNode.removeChild(this.frame) }, e }(), s = function () { function e(e) { var d = this; this.model = e.model, this.parent = e.parent, this.parentOrigin = e.parentOrigin, this.child = e.child, this.child.addEventListener("message", function (t) { if (p(t, d.parentOrigin)) { var e, n, i, a = t.data, r = a.property, s = a.uid, o = a.data; if ("call" !== t.data.postmate) (e = d.model, n = r, i = "function" == typeof e[n] ? e[n]() : e[n], l.Promise.resolve(i)).then(function (e) { return t.source.postMessage({ property: r, postmate: "reply", type: h, uid: s, value: e }, t.origin) }); else r in d.model && "function" == typeof d.model[r] && d.model[r](o) } }) } return e.prototype.emit = function (e, t) { this.parent.postMessage({ postmate: "emit", type: h, value: { name: e, data: t } }, this.parentOrigin) }, e }(), l = function () { function e(e) { var t = e.container, n = void 0 === t ? void 0 !== n ? n : document.body : t, i = e.model, a = e.url, r = e.name, s = e.classListArray, o = void 0 === s ? [] : s; return this.parent = window, this.frame = document.createElement("iframe"), this.frame.name = r || "", this.frame.classList.add.apply(this.frame.classList, o), n.appendChild(this.frame), this.child = this.frame.contentWindow || this.frame.contentDocument.parentWindow, this.model = i || {}, this.sendHandshake(a) } return e.prototype.sendHandshake = function (a) { var r, s = this, o = function (e) { var t = document.createElement("a"); t.href = e; var n = 4 < t.protocol.length ? t.protocol : window.location.protocol, i = t.host.length ? "80" === t.port || "443" === t.port ? t.hostname : t.host : window.location.host; return t.origin || n + "//" + i }(a), d = 0; return new e.Promise(function (n, i) { s.parent.addEventListener("message", function e(t) { return !!p(t, o) && ("handshake-reply" === t.data.postmate ? (clearInterval(r), s.parent.removeEventListener("message", e, !1), s.childOrigin = t.origin, n(new c(s))) : i("Failed handshake")) }, !1); var e = function () { d++, s.child.postMessage({ postmate: "handshake", type: h, model: s.model }, o), 5 === d && clearInterval(r) }, t = function () { e(), r = setInterval(e, 500) }; s.frame.attachEvent ? s.frame.attachEvent("onload", t) : s.frame.addEventListener("load", t), s.frame.src = a }) }, e }(); return l.debug = !1, l.Promise = function () { try { return window ? window.Promise : Promise } catch (e) { return null } }(), l.Model = function () { function e(e) { return this.child = window, this.model = e, this.parent = this.child.parent, this.sendHandshakeReply() } return e.prototype.sendHandshakeReply = function () { var r = this; return new l.Promise(function (i, a) { r.child.addEventListener("message", function e(t) { if (t.data.postmate) { if ("handshake" !== t.data.postmate) return a("Handshake Reply Failed"); r.child.removeEventListener("message", e, !1), t.source.postMessage({ postmate: "handshake-reply", type: h }, t.origin), r.parentOrigin = t.origin; var n = t.data.model; return n && Object.keys(n).forEach(function (e) { r.model[e] = n[e] }), i(new s(r)) } }, !1) }) }, e }(), l });
//***********************************xdf Plumber WebJssdk**********************************************
var UUID;
UUID = (function () {
  'use strict';

  /** @lends UUID */
  function UUID() { }
  UUID.generate = function () {
    var rand = UUID._getRandomInt,
      hex = UUID._hexAligner;

    // ["timeLow", "timeMid", "timeHiAndVersion", "clockSeqHiAndReserved", "clockSeqLow", "node"]
    return (
      hex(rand(32), 8) + // time_low
      '-' +
      hex(rand(16), 4) + // time_mid
      '-' +
      hex(0x4000 | rand(12), 4) + // time_hi_and_version
      '-' +
      hex(0x8000 | rand(14), 4) + // clock_seq_hi_and_reserved clock_seq_low
      '-' +
      hex(rand(48), 12)
    ); // node
  };

  /**
   * Returns an unsigned x-bit random integer.
   * @param {int} x A positive integer ranging from 0 to 53, inclusive.
   * @returns {int} An unsigned x-bit random integer (0 <= f(x) < 2^x).
   */
  UUID._getRandomInt = function (x) {
    if (x < 0) {
      return NaN;
    }
    if (x <= 30) {
      return 0 | (Math.random() * (1 << x));
    }
    if (x <= 53) {
      return (0 | (Math.random() * (1 << 30))) + (0 | (Math.random() * (1 << (x - 30)))) * (1 << 30);
    }

    return NaN;
  };

  /**
   * Returns a function that converts an integer to a zero-filled string.
   * @param {int} radix
   * @returns {function(num&#44; length)}
   */
  UUID._getIntAligner = function (radix) {
    return function (num, length) {
      var str = num.toString(radix),
        i = length - str.length,
        z = '0';

      for (; i > 0; i >>>= 1, z += z) {
        if (i & 1) {
          str = z + str;
        }
      }
      return str;
    };
  };

  UUID._hexAligner = UUID._getIntAligner(16);

  /**
   * Returns UUID string representation.
   * @returns {string} {@link UUID#hexString}.
   */
  UUID.prototype.toString = function () {
    return this.hexString;
  };

  return UUID;
})(UUID);

//　ip citycode ips都是动态生成的，所以这里不记录了
function GetGuid(channel,renew) {

  //生成guid
  channel = undefined == channel ? "" : channel
  var plumberh5guid = 'plumber-h5-guid'
  var plumberh5guidcreattime = 'plumber-h5-guid-creattime'
  var plumberh5guidchannel = 'plumber-h5-guid-channel'
  //生成默认返回对象
  var jsonObj = {};
  jsonObj.guid = "";
  jsonObj.guidcreattime = "";
  jsonObj.guidchannel = "";
  jsonObj.renew = false
  if(true==renew){
    //这个特殊，完全logout会初始化所有guid
    storage.removeItem(plumberh5guid)
    storage.removeItem(plumberh5guidcreattime)
    storage.removeItem(plumberh5guidchannel)
    return jsonObj;
  }
  //检查h5是否存在guid，有则返回
  var storage = window.localStorage;
  try {
    var valueh5guid = storage.getItem(plumberh5guid)
    if (valueh5guid) {
      jsonObj.guid = valueh5guid;
    }
    else {
      //没有guid则生成guid然后返回
      var setguid = UUID.generate()
      storage.removeItem(plumberh5guidcreattime)
      storage.removeItem(plumberh5guidchannel)
      jsonObj.renew = true
      try {
        storage.setItem(plumberh5guid, setguid)
        jsonObj.guid = setguid;
      } catch (e) { jsonObj.guid = "error guid"; }
    }
  } catch (e) { }

  //检查h5是否存在guid的创建时间，有则返回
  try {
    var valueh5guidcreattime = storage.getItem(plumberh5guidcreattime)
    if (valueh5guidcreattime) {
      jsonObj.guidcreattime = valueh5guidcreattime;
    } else {
      var setguidcreattime = new Date().getTime()
      try {
        storage.setItem(plumberh5guidcreattime, setguidcreattime)
        jsonObj.guidcreattime = setguidcreattime;
      } catch (e) { jsonObj.guidcreattime = "error guid creattime" }
    }
  } catch (e) { }

  //检查h5是否存在guid的创建渠道，有则返回
  try {
    var valueh5guidchannel = storage.getItem(plumberh5guidchannel)
    if (valueh5guidchannel) {
      jsonObj.guidchannel = valueh5guidchannel;
    } else {
      var setguidchannel = "" == channel ? "plumber-h5" : channel
      try {
        storage.setItem(plumberh5guidchannel, setguidchannel)
        jsonObj.guidchannel = setguidchannel;
      } catch (e) { jsonObj.guidchannel = "error guid channel" }
    }
  } catch (e) { }

  return jsonObj
}

var WebJssdkBase = (function () {
  var baseInfo;
  var instantiated;     //匿名函数创建私有变量,判断单体对象是否被创建的句柄
  function getWebglVendorAndRenderer() {
    /* This a subset of the WebGL fingerprint with a lot of entropy, while being reasonably browser-independent */
    try {
      var glContext = getWebglCanvas()
      var extensionDebugRendererInfo = glContext.getExtension('WEBGL_debug_renderer_info')
      return glContext.getParameter(extensionDebugRendererInfo.UNMASKED_VENDOR_WEBGL) + '~' + glContext.getParameter(extensionDebugRendererInfo.UNMASKED_RENDERER_WEBGL)
    } catch (e) {
      return null
    }
  }
  function getWebglCanvas() {
    var canvas = document.createElement('canvas')
    var gl = null
    try {
      gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl')
    } catch (e) { /* squelch */ }
    if (!gl) { gl = null }
    return gl
  }
  function isCanvasSupported() {
    var elem = document.createElement('canvas')
    return !!(elem.getContext && elem.getContext('2d'))
  }
  function isWebGlSupported() {
    // code taken from Modernizr
    if (!isCanvasSupported()) {
      return false
    }

    var glContext = getWebglCanvas()
    return !!window.WebGLRenderingContext && !!glContext
  }

  async function asyncinit() {

    var info = { "type": "msg" }
    baseInfo = JSON.stringify(info)
    baseInfo = JSON.parse(baseInfo)

    async function processuserAgent() {
      const r = await navigator.userAgentData.getHighEntropyValues([
        "architecture",
        "model",
        "platformVersion",
        "fullVersionList",
      ]);
      return r
    }

    async function getBattery() {
      const r = await navigator.getBattery()
      return r
    }

    try {
      const ret = await processuserAgent()
      baseInfo["browse_brands"] = JSON.stringify(ret.fullVersionList)
      baseInfo["browse_model"] = ret.model
      baseInfo["browse_platform"] = ret.platform
      baseInfo["browse_platformVersion"] = ret.platformVersion
      baseInfo["browse_architecture"] = ret.architecture
    } catch (e) {
      baseInfo["browse_vendor"] = navigator.vendor
    }
    try{
      const ret = await getBattery()
      baseInfo["device_charging"] = ret.charging
      baseInfo["device_chargingTime"] = ret.chargingTime
      baseInfo["device_dischargingTime"] = ret.dischargingTime
      baseInfo["device_charginglevel"] = ret.level
    }catch (e) {
      baseInfo["device_battery"] = "unknow"
    }
    try{
      if ("geolocation" in navigator) {
        /* geolocation is available */
      } else {
        /* geolocation IS NOT available */
      }
    }catch(e)
    {
      console.log("geolocation",e)
    }
    try{
      baseInfo["browse_agent"] = navigator.userAgent
      baseInfo["browse_hardwareConcurrency"] = navigator.hardwareConcurrency
      baseInfo["browse_hardwaredeviceMemory"] = navigator.deviceMemory
      baseInfo["browse_history"] = window.history.length
      baseInfo["browse_url"] = location.href
      baseInfo["browse_hash"] = location.hash
      baseInfo["browse_referer"] = document.referrer
      baseInfo["browse_screenResolution"] = [screen.width, screen.height]
      baseInfo["browse_availablescreenResolution"] = [window.screen.availWidth, window.screen.availHeight]
      baseInfo["browse_innerscreenResolution"] = [window.innerWidth, window.innerHeight]
      
  
      baseInfo["browse_language"] = navigator.language || navigator.userLanguage || navigator.browserLanguage || navigator.systemLanguage
      baseInfo["browse_timezoneOffset"] = new Date().getTimezoneOffset()
      baseInfo["browse_colordph"] = screen.colorDepth
      if (window.Intl && window.Intl.DateTimeFormat) {
        baseInfo["browse_timezone"] = new window.Intl.DateTimeFormat().resolvedOptions().timeZone
      }
      if (isWebGlSupported()) {
        baseInfo["browse_webglVendorAndRenderer"] = getWebglVendorAndRenderer()
      }
    }catch(e)
    {
      baseInfo["browse_baseinfo"] = "initfault"
    }

  }

  function init() {
    return {
      GetBaseInfo: async function () {
        await asyncinit();
        return baseInfo;
      },
    }
  }
  return {
    getinstance: function () {
      if (!instantiated) {
        instantiated = new init();

      }
      return instantiated;
    }
  }
}
)()


var WebJssdkNetwork = (function () {
  //var webplumberhttp = "http://web.plumber.sohu.com/"
  //var networkplumberhttp = "http://network.plumber.sohu.com/"
  var websocket;
  var heart;
  var reconnectcount = 0
  var timeouthandle
  var tokenstr = ""
  var client_seq = 0
  var server_seq = 0
  var wsurl = "ws://10.2.24.131:18181/ws"

  var httpkey = "swxapktzteyjsali"
  var Cryptojs = CryptoJS
  var instantiated;
  var wsenable = true

  function initnetwork() {
    console.log(Cryptojs)
    return {
      reconnect: function (enable) {
        if (false == enable && true == wsenable) {
          wsenable = false
        }
        if (false == wsenable) {
          return
        }
        console.log("reconnect", enable, wsenable)
        clearInterval(heart)
        clearTimeout(timeouthandle)
        reconnectcount++
        if (reconnectcount > 10) {
          console.log("网络异常")
          reconnectcount = 1
        }
        websocket = new WebSocket(wsurl);
        instantiated.config(websocket)
      },
      sendWebSocketMsg: function (msg) { //发送消息 
        if (false == wsenable) {
          console.log("websocket disable")
          return
        }
        client_seq++
        if (websocket.readyState == WebSocket.OPEN) { //如果WebSocket是打开状态
          var r = JSON.parse(msg)
          r.client_seq = client_seq
          r.server_seq = server_seq
          msg = JSON.stringify(r)

          var codemsg = instantiated.encrypt(msg)
          console.log("ws_sed_msg:", msg)
          websocket.send(codemsg); //send()发送消息
        }
        else {
          console.log("send failed")
        }
      },
      publicPrototype: "xdf websocket jssdk",
      encrypthttp: function (msg) {
        var srcs = msg;
        var encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(srcs), CryptoJS.enc.Utf8.parse(httpkey), { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 });
        return encrypted.toString();
      },
      encrypt: function (msg) {
        var key = tokenstr;
        var srcs = msg;
        var encrypted = CryptoJS.AES.encrypt(CryptoJS.enc.Utf8.parse(srcs), CryptoJS.enc.Utf8.parse(key), { mode: CryptoJS.mode.ECB, padding: CryptoJS.pad.Pkcs7 });
        return encrypted.toString();
        /* 服务器测试用加解密
        console.log("encrypt",encrypted.toString(),key,srcs)
        var xx = CryptoJS.enc.Utf8.parse(encrypted.toString())
        var Base64 = CryptoJS.enc.Base64.stringify(xx)
        console.log("enbase64",Base64.toString())
        var DeBase64 = CryptoJS.enc.Base64.parse(Base64.toString());
        DeBase64 = DeBase64.toString(CryptoJS.enc.Utf8);
        console.log("debase64",DeBase64.toString())   
        var decrypt = CryptoJS.AES.decrypt(DeBase64.toString(), CryptoJS.enc.Utf8.parse(key), {mode:CryptoJS.mode.ECB,padding: CryptoJS.pad.Pkcs7});
        console.log("decrypt",decrypt.toString(CryptoJS.enc.Utf8))  
        return encrypted.toString();
        */
      },
      heartbeat: function () {//该函数可能未来不会暴露
        heart = setInterval(function () {
          var heart = { "type": "hbeat", "Time_stamp": new Date().getTime() }
          //转换数据类型
          var sendinfo = JSON.stringify(heart);
          instantiated.sendWebSocketMsg(sendinfo)
        }, 1000 * 60 * 3);
      },

      config: function (ret) {//该函数可能未来不会暴露
        //如果浏览器支持WebSocket
        //当有消息过来的时候触发
        ret.onmessage = function (event) {
          console.log("ws_ret_msg", event.data)
          var data = JSON.parse(event.data);
          server_seq = data.server_seq
          switch (data.type) {
            case "code": // JOIN
              tokenstr = data.code
              console.log("token:", data);
              break
            default:
              break;
          }
        }

        //连接关闭的时候触发
        ret.onclose = function (event) {
          setTimeout(instantiated.reconnect, reconnectcount * 10000)
          clearInterval(heart)
          console.log("websocket断开连接")
        }

        //连接打开的时候触发
        ret.onopen = function (event) {
          reconnectcount = 1
          console.log("websocket建立链接", event, websocket)
        }

        //连接打开的时候触发
        ret.error = function (event) {
          setTimeout(instantiated.reconnect, reconnectcount * 10000)
          clearInterval(heart)
          console.log("websocket error")
        }
        instantiated.heartbeat()
      }
    }
  }
  return {
    getinstance: function () {
      if (!instantiated) {
        instantiated = new initnetwork();
        //instantiated.reconnect()
      }
      return instantiated;
    }
  }
}
)()

//***********************************xdf Plumber WebJssdk**********************************************

var webjssdk = (function () {
  var appmeta_appname
  var appmeta_groupname
  var appmeta_appver
  var sdk_version = "20240127v34"
  var dev = false
  var uid_uid = ""
  var uid_sid = ""
  var appmeta_appbundlename = undefined;
  //发送地址会根据dev环境自动更换，这里默认是测试
  var plumbersendhttp = "https://c-tessar.test.xdf.cn/plumber/statis/"
  var recommendsendhttp = "https://c-tessar.test.xdf.cn/plumber/recommend/"
  var unioninfohttp = "https://c-tessar.test.xdf.cn/plumber/unioninfo/"
  //var sendhttp = "https://c-tessar.xdf.cn/plumber/statis"
  var instantiated = undefined;     //匿名函数创建私有变量,判断单体对象是否被创建的句柄
  var routinglist = new Array()
  var oWebJssdkNetwork = undefined;
  var spidercheck = false
  var ScrollTick = (new Date()).getTime()
  var ScrollTick2 = (new Date()).getTime()
  var ResizeTick = (new Date()).getTime()
  var beaconfn = null
  var setuptime = (new Date()).getTime()
  var connect_group = {}
  var listenerlist = []
  var tessarid = 0
  var recommendqueue = []
  var recommendqueuetime = (new Date()).getTime()
  var recoomendtick = 10 * 1000
  var keylist = undefined;
  var appended = undefined;
  var traceid = undefined
  var packenv = undefined
  var rGuid = undefined;
  if (window.localStorage) {
    try {
      window.localStorage.removeItem("plumbersdk_routinglist");
    } catch (e) {
      console.log('This browser does NOT support localStorage');
    }
  } else {
    console.log('This browser does NOT support localStorage');
  }
  function init() {
    return {
      /// 参数非空可以成功左值
      /// undefined可以清空该左值
      appendedbundlename: function (bundlename) {
        if ("" != bundlename) {
          appmeta_appbundlename = bundlename
          return appmeta_appbundlename
        }
        return undefined
      },
      appended: function (info) {
        if (undefined == info) {
          appended = undefined
          return true
        }
        try {
          var t = JSON.stringify(info)
          appended = info
          instantiated.addTodbwithrecommend("appended", undefined, "appended")
          return true
        } catch (e) {
          return false;
        }
      },
      cloneappended: function () {
        if (undefined != appended) {
          return appended
        }
        return undefined
      },
      //该函数已经废弃
      pushlocalstorage: function () {
      },
      //模拟监测系统退出动作，最小30秒，最大300秒，通常我们认为爬虫不会有这么久的时间
      settimecheck: function (time) {
        if (undefined == arguments[0]) { time = 0 }
        var t = Number(time)
        if (t < 30 * 1000) { t = 30 * 1000 }
        else if (t > 5 * 60 * 1000) {
          t = 5 * 60 * 1000
        }
        setTimeout(() => {
          if (false == spidercheck) {
            var o = {}
            o.type = "timecheck"
            instantiated.usercheck(o)
          }
        }, t);
      },
      setbeaconfn: function (fn) {
        beaconfn = fn
      },
      find: function (list, f) {
        return list.filter(f)[0]
      },
      hookinfo: function (obj, action) {
        var pobj = obj
        var event = ""
        var step = 0
        var infojson = {}
        infojson.extraReportData = []
        var target_href = undefined
        while (step < 20) {
          if (undefined == target_href) {
            target_href = pobj.href
          }
          //这也是埋点比较关键的组件跟踪，如果有objid存在，就不适用tessarid，否则就直接用objid，通常是埋点系统规定的8位数字加字符串
          var pname = pobj.tagName + "#" + ("" == pobj.id ? "tesssarid" + pobj.tessarid : pobj.id)
          //用一组递进关系向上朔源获得大框架的info,不是太好，先用着
          if (undefined != pobj.dataset.tessarInfo && undefined == infojson.reportData) {
            var o = JSON.parse(pobj.dataset.tessarInfo)
            infojson.reportData = o//和app端统一
            //后续可能需要obj.dataset.tessar的其他字段来合并拼装
          }
          else if (undefined != pobj.dataset.tessarInfo)//连续周游字段全部都带上，以后可能还会使用到位置信息
          {
            var extra_o = JSON.parse(pobj.dataset.tessarInfo)
            infojson.extraReportData.push(extra_o)
          }

          event = "" == event ? pname : pname + "-" + event
          step++
          if ("BODY" == pobj.tagName || null == pobj.parentElement) {
            break
          } else {
            pobj = pobj.parentElement
          }

        }
        //没有数据就不透传了
        if (undefined == infojson.reportData || {}==infojson) {
          infojson = undefined
        }

        var ret_o = {
          "elementid": obj.id,
          "tag": obj.dataset.tessarTag,//标签也需要未来根据其他的字段聚合
          "info": infojson,
          "tagName": obj.tagName,
          "event": window.location.pathname + "|" + event + "|" + obj.tagName + "#" + obj.id + "|" + (undefined == action ? null : action),
          "href": target_href,
          "tessarid":obj.tessarid,
          //event以后我们调整成一个标准json，同时使用竖线，此外，obj.id也会采用number+substring+'_'+action的方式来约定，方便正则表达式清洗
        }
        return ret_o
      },
      hookvisibility: function (namekey) {
        console.log(namekey)
        //var objs = document.getElementById(namekey)

      },
      hookscroll: function (namekey) {
        var curtime = (new Date()).getTime()
        if (curtime - ScrollTick2 > 4000) {
          ScrollTick2 = curtime
        }
        else if (curtime - ScrollTick2 < 4000) {
          return
        }
        if (false == spidercheck) {
          var o = {}
          o.type = "hookscroll"
          instantiated.usercheck(o)
        }
        instantiated.addTodbwithrecommend("scroll_body", {})
      },
      hookglobalclick: function (e) {
        if (false == spidercheck) {
          var o = {}
          o.type = "hookglobalclick"
          instantiated.usercheck(o)
        }
        var objs = e.target
        if (null != objs) {
          var list = (objs.tagName).toLowerCase()
          if (-1 != keylist.indexOf(list)) {

            instantiated.addTodbwithrecommend("click_el" + undefined != objs.id ? objs.id : "" + "_" + objs.value, instantiated.hookinfo(objs, "click"))
          }
        }
      },
      hookglobalhover: function (e) {
        if (false == spidercheck) {
          var o = {}
          o.type = "hookglobalhover"
          instantiated.usercheck(o)
        }
        var objs = e.target
        if (null != objs) {
          var list = (objs.tagName).toLowerCase()
          if (-1 != keylist.indexOf(list) && "" != objs.id) {
            //对于hover元素，必须检查有真正的h5dataset才发送，否则不发送，因为没有人关注
            var ojson = instantiated.hookinfo(objs, "hover");
            if(undefined!=ojson.info)
            {
              instantiated.addTodbwithrecommend("hover_el" + undefined != objs.id ? objs.id : "" + "_" + objs.value, ojson)
            }
          }
        }

      },
      /*
      @recursioninit 对全局监听初始化
      @param info 监听的元素类型，用｜间隔，字符串
      @param forcehover 是否坚挺鼠标悬停，boolean 
      */
      recursioninit: function (info, forcehover) {
        forcehover = (undefined == forcehover ? false : true);
        listenerlist.forEach(function (drop) {
          (drop.obj).removeEventListener(drop.key, drop.fn)
        })
        listenerlist = []
        try {
          info = JSON.parse(info)
          keylist = info["type"]
          //var list=keylist.split("|");
          var objs = document.getElementsByTagName("*")
          //增加全局最大的窗口滚动事件捕获
          let f = new Object()
          f.fn = function () { instantiated.hookscroll() }
          f.key = "scroll"
          f.obj = document
          listenerlist.push(f)
          document.addEventListener(f.key, f.fn);
          f = new Object()
          f.fn = function (e) { instantiated.hookglobalclick(e) }
          f.key = "click"
          f.obj = document
          listenerlist.push(f)
          document.addEventListener(f.key, f.fn);
          //目前全局悬停检测是开启的，因为有spidercheck功能控制
          if (true == forcehover) {
            f = new Object()
            f.fn = function (e) { instantiated.hookglobalhover(e) }
            f.key = "mouseover"
            f.obj = document
            listenerlist.push(f)
            document.addEventListener(f.key, f.fn);
          }
          try {
            for (var obj in objs) {
              tessarid++
              objs[obj].tessarid = tessarid
            }
          } catch (e) {
            if("dev"==packenv)
            {
              console.log(e)
            }
          }
          return true
        } catch (err) {
          if("dev"==packenv)
          {
            console.log(err)
          }

        }
        return false
      },
      /*
      @addTodbwithrecommend 对全局监听初始化
      @param text 行为名称，字符串
      @param detailinfo 通常是携带的json数据细节，json对象
      @param server_action 服务器行为类型，通常这里只有recommend，因为别的模式几乎都是立刻发送，比如logininfo/logout，setup/session/routing都是通过固定调用发送的，系统默认发送规则，字符串
      @param baconsend 是否用baconsend方式发送数据，boolean
      */
      addTodbwithrecommend: function (text, detailinfo, server_action, baconsend) {
        if (undefined == baconsend) { baconsend = false }
        server_action = undefined == server_action ? "recommend" : server_action
        if (undefined == detailinfo) { detailinfo = {} }
        var curtimestamp = new Date().getTime()
        var last = routinglist[routinglist.length - 1]
        var session_duration = (undefined != last ? Math.round((curtimestamp - last.time_stamp) / 1000 * 100) / 100 : 0)
        var session_edge = (undefined != last ? last.routing + "|" + text : "setup|" + text)
        var info = {
          "type": "msg"
          , "time_stamp": curtimestamp
          , detail: detailinfo
          , server_action: server_action
          , session_duration: session_duration
          , session_edge: session_edge
          , session_step: routinglist.length
          , appmeta_appname: appmeta_appname
          , appmeta_groupname: appmeta_groupname
          , appmeta_appver: appmeta_appver
          , appmeta_appbundlename: appmeta_appbundlename
          , uid_uid: uid_uid
          , uid_sid: uid_sid
          , uid_sid_channel: rGuid.guidchannel
          , uid_sid_creattime: rGuid.guidcreattime
          , setup_time_stamp: setuptime
          , setup_time_duration: Math.round((curtimestamp - setuptime) / 1000 * 100) / 100
          , browse_url: location.href
          , browse_url_args : instantiated.getcurrentArgs()
          , browse_agent: navigator.userAgent
          , browse_referer: document.referrer
          , sdkversion: sdk_version
          , connect_group: connect_group
          , appended: appended
          , browse_screenResolution: [screen.width, screen.height]
          , browse_availablescreenResolution: [window.screen.availWidth, window.screen.availHeight]
          , browse_innerscreenResolution: [window.innerWidth, window.innerHeight]
          //,browse_connecttype:navigator.network.effectiveType
          , browse_vendor: navigator.vendor
          , browse_history: window.history.length
          , tessar_nginx_trace: traceid

        }
        instantiated.addTodb(text, detailinfo)
        if (true == baconsend) {
          instantiated.sendhttpinfo(JSON.stringify(info), true, true)//走baconsend模式的特殊的recommend，通常是特殊的bg效应
        } else {
          if ("recommend" != server_action) {
            //非推荐数据立刻发送并进入离线数据队列
            instantiated.sendhttpinfo(JSON.stringify(info), false, false)
          } else {
            recommendqueue.push(info)
          }
          if (curtimestamp - recommendqueuetime > recoomendtick) {
            recommendqueuetime = curtimestamp
            instantiated.sendhttpinfo(JSON.stringify(recommendqueue), false, true)
            recommendqueue = []
          }
          //最开始的15秒呢直接发送
          else if ((new Date()).getTime() - setuptime < 15000) {
            recommendqueuetime = curtimestamp
            instantiated.sendhttpinfo(JSON.stringify(recommendqueue), false, true)
            recommendqueue = []
          }
        }
        if("logout" === server_action)
        {
          //强制删除染色信息
          instantiated.gettraceCookie("")
          GetGuid("",true);
        }

      },
      gettraceCookie(newtraceid) {
        const plumberTraceid = "plumber-h5-nginx-traceid"
        try {
          var storage = window.localStorage;
          if (undefined == newtraceid)//读取nginx中央染色
          {
            var value = storage.getItem(plumberTraceid)
            return value
          } else if ("" == newtraceid)//删除nginx中央染色
          {
            storage.removeItem(plumberTraceid)
            return ""//删除染色成功
          }
          //其他都是写入染色
          storage.setItem(plumberTraceid, newtraceid)
          var value = storage.getItem(plumberTraceid)
          return value
        }
        catch (e) { }
        return undefined//操作失败
      },
      updaterecommend: function (beaconsend = false) {
        if (recommendqueue.length > 0) {
          recommendqueuetime = new Date().getTime()
          instantiated.sendhttpinfo(JSON.stringify(recommendqueue), beaconsend, true)
          recommendqueue = []
        }
      },
      addTodb: function (text, detailinfo) {
        /*
        对于滚动事件，4500ms内只记录一次，最终做长路径判断的时候，对回文的处理需要排除这些用户附加行为
        类似的还包括pull刷新，showModal，等event事件
        */
        //var detail =instantiated.deepCopyV(detailinfo)
        var detail = ""
        if (undefined != detailinfo) {
          detail = JSON.parse(JSON.stringify(detailinfo))
        }

        var testScroll = -1 == text.toLowerCase().indexOf("scroll") ? false : true;
        var curtime = (new Date()).getTime()
        if (true == testScroll && curtime - ScrollTick > 4500) {
          ScrollTick = curtime
        }
        else if (true == testScroll && curtime - ScrollTick < 4500) {
          return
        }
        var testresize = -1 == text.toLowerCase().indexOf("resize") ? false : true;
        var curnewtime = (new Date()).getTime()
        if (true == testresize && curnewtime - ResizeTick > 3500) {
          ResizeTick = curnewtime
        }
        else if (true == testresize && curnewtime - ResizeTick < 3500) {
          return
        }
        //滚动判断结束
        //console.log(text, detail)
        var todo = {
          _id: new Date().toISOString(),
          routing: text,
          time_stamp: (new Date()).getTime(),
          detail: detail,
          browse_url: location.href,
          recount: 0,
        };
        try {
          //当设置了pushlocalstorage清空routinglist以后，不再接受bg压入路径
          routinglist.push(todo)
        } catch (err) {
          console.log(err);
        }
      },
      usercheck: function (action) {
        if (false == spidercheck) {
          var o = webjssdk.getinstance();
          var a = { type: action.type }
          window.removeEventListener("mousemove", o.usercheck)
          window.removeEventListener("touchmove", o.usercheck)
          instantiated.addTodbwithrecommend("spidercheck", a, "spidercheck")
          spidercheck = true
        }

      },
      initWebInfo: function () {

        window.addEventListener("mousemove", this.usercheck)
        window.addEventListener('touchmove', this.usercheck)
        window.onresize = function () {
          var o = {}
          o.type = "onresize"
          instantiated.usercheck(o)
          //instantiated.addTodb("onresize")
          //instantiated.sdklog(currentTimeString() + " 从第三方应用启动：" + plus.runtime.arguments);
        }
        window.onerror = function (errorMessage, scriptURI, lineNumber, columnNumber, error) {
          if (error) {
            console.log(error);
          } else {
            console.log({ message: errorMessage, script: scriptURI, line: lineNumber, column: columnNumber });
          }
        }
        window.onpopstate = function () {
          setTimeout(function () {
            //完成hash动作结束当前的routing
            //instantiated.sendRouting()
            //新hash以后发送setup
            instantiated.sendbaseinfo("onpopstate")
          }, 500);
        }
        window.onpagehide = async function () {
          //这里要测试成功xhr同步成功
          //window.localStorage.removeItem("plumbersdk_routinglist");
        }
        window.onblur = async function () {
          var o = {}
          o.type = "onblur"
          instantiated.usercheck(o)
        }
        window.onfocus = function () {
          var o = {}
          o.type = "onfocus"
          instantiated.usercheck(o)
        }
        window.onscroll = function () {
          var o = {}
          o.type = "onscroll"
          instantiated.usercheck(o)
        }
        window.ononline = function () {
        };
        window.onoffline = function () {
        }
        window.onhashchange = function () {
          var o = {}
          o.type = "onhashchange"
          instantiated.usercheck(o)
          instantiated.sendbaseinfo("onhashchange")

        }
        window.history.pushState = (function () {
          var e = history['pushState']
          return function () {
            e.apply(history, arguments)
            //完成hash动作结束当前的routing
            //instantiated.sendRouting()
            //新hash以后发送setup
            instantiated.sendbaseinfo("pushState")
          }
        }())
        window.history.replaceState = (function () {
          var e = history['replaceState']
          return function () {
            e.apply(history, arguments)
            instantiated.sendbaseinfo("replaceState")
          }
        }())
        window.onunload = function () {
          if (null != beaconfn) {
            beaconfn();
          }
          var o = {}
          o.type = "onunload"
          instantiated.usercheck(o)
          //如果外部调用了pushlocalstorage，就需要发送bg信息
          instantiated.sendRouting(true, "onunload")
        }
        window.onbeforeunload = function () {
          if (null != beaconfn) {
            beaconfn();
          }
          var o = {}
          o.type = "onbeforeunload"
          instantiated.usercheck(o)
          //如果外部调用了pushlocalstorage，就需要发送bg信息
          instantiated.sendRouting(true, "onbeforeunload")
          window.onunload = undefined
        }
        //系统加载完自动发送基础信息
        instantiated.sendbaseinfo()
      },
      sendInfo: function (info) {
        var send = { "type": "msg", "Time_stamp": new Date().getTime(), "msg": info }
        var sendmsg = JSON.stringify(send);
        oWebJssdkNetwork.sendWebSocketMsg(sendmsg)
      },
      currentTimeString: function () {
        var d = new Date();
        return d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds() + "." + d.getMilliseconds() + " - ";
      },
      sendRouting: function (beaconsend, detail_type) {
        try {
          instantiated.addTodbwithrecommend("bg", undefined, "recommend", true)//发出routing前的最后recommend指令，获得退出命令，然后走routing，这个修改主要是针对边统计开发
          var dateinfo = new Array()
          for (var index = 0; index < routinglist.length; index++) {
            dateinfo[index] = routinglist[index]
            dateinfo[index].step = index//routinglist.length-index
            if ("" == dateinfo[index].detail) {
              delete dateinfo[index].detail;
            }
            delete dateinfo[index]._id;
            delete dateinfo[index]._rev;
          }

          for (index = 1; index < dateinfo.length; index++) {
            dateinfo[index].duration = Math.round((dateinfo[index].time_stamp - dateinfo[index - 1].time_stamp) / 1000 * 100) / 100
            dateinfo[index].original = dateinfo[index - 1].routing
            dateinfo[index].edge = dateinfo[index].original + "|" + dateinfo[index].routing
          }
          //考虑0号节点的用途其实不大，不能形成边，但是在长路径中可以携带detail，因此不再删除0号节点
          //dateinfo.splice(0,1)
          //var oBaseInfo = oWebJssdkBase.GetBaseInfo();
          var info = {
            type: 'msg'
            , time_stamp: new Date().getTime()
            , routing_stack: dateinfo
            , appmeta_appname: appmeta_appname
            , appmeta_groupname: appmeta_groupname
            , appmeta_appver: appmeta_appver
            , appmeta_appbundlename: appmeta_appbundlename
            , server_action: 'routing'
            , uid_uid: uid_uid
            , uid_sid: uid_sid
            , setup_time_stamp: setuptime
            , setup_time_duration: Math.round((new Date().getTime() - setuptime) / 1000 * 100) / 100
            , browse_url: location.href
            , browse_url_args : instantiated.getcurrentArgs()
            , browse_agent: navigator.userAgent
            , browse_referer: document.referrer
            , sdkversion: sdk_version
            , connect_group: connect_group
            , appended: appended
            , browse_screenResolution: [screen.width, screen.height]
            , browse_availablescreenResolution: [window.screen.availWidth, window.screen.availHeight]
            , browse_innerscreenResolution: [window.innerWidth, window.innerHeight]
            //,browse_connecttype:navigator.network.effectiveType
            , browse_vendor: navigator.vendor
            , browse_history: window.history.length
            , tessar_nginx_trace: traceid
          }
          if (undefined != detail_type) {
            info.routing_type = detail_type
          }
          var sstr = JSON.stringify(info)
          var checkjson = JSON.parse(sstr)
          sstr = JSON.stringify(checkjson)
          instantiated.sendhttpinfo(sstr, beaconsend)
          //强制把推荐的数据beaconsed出去
          instantiated.updaterecommend(true)
        } catch (err) {
          console.log(err);
        }
      },
      sendhttpinfo: function (msg, beaconsend = false, recommend = false) {
        var sendhttp = true == recommend ? recommendsendhttp : plumbersendhttp;
        var r = JSON.parse(msg)
        r.time_stamp = (new Date()).getTime()
        msg = JSON.stringify(r)
        var codemsg = oWebJssdkNetwork.encrypthttp(msg)
        if ("sendBeacon" in navigator && true == beaconsend) {
          var blob = new Blob([codemsg, {
            type: 'application/x-www-form-urlencoded',
          }]);
          var t = navigator.sendBeacon(sendhttp, codemsg);
        }
        else {
          var xhr = new XMLHttpRequest();
          xhr.open("POST", sendhttp);
          xhr.setRequestHeader("Content-type", "application/json");
          xhr.setRequestHeader("Encrypt-Type", "AES,AES/ECB/PKCS7Padding")
          xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
              if (xhr.status == 200 && true == dev) { console.log("sendhttpinforet:", xhr.response + "\n", "sendhttpinfo:", msg) }
            }
          };
          xhr.send(codemsg);
        }
      },
      getcurrentArgs: function() {
        var args = {};
        var match = null;
        var search = decodeURIComponent(location.search.substring(1));
        var reg = /(?:([^&]+)=([^&]+))/g;
        while ((match = reg.exec(search)) !== null) {
          args[match[1]] = match[2];
        }
        return args;
      },
      GetBaseInfo: async function () {


        var oWebJssdkBase = WebJssdkBase.getinstance();
        var oBaseInfo = await oWebJssdkBase.GetBaseInfo();
        oBaseInfo["appmeta_appname"] = appmeta_appname
        oBaseInfo["appmeta_groupname"] = appmeta_groupname
        oBaseInfo["appmeta_appver"] = appmeta_appver
        oBaseInfo["appmeta_appbundlename"] = appmeta_appbundlename
        oBaseInfo["uid_uid"] = uid_uid
        oBaseInfo["appmeta_url_args"] = instantiated.getcurrentArgs()
        oBaseInfo["uid_sid"] = rGuid.guid
        oBaseInfo["uid_sid_channel"] = rGuid.guidchannel
        oBaseInfo["uid_sid_creattime"] = rGuid.guidcreattime
        oBaseInfo["setup_time_stamp"] = setuptime
        oBaseInfo["sdkversion"] = sdk_version,
        oBaseInfo["connect_group"] = connect_group,
        oBaseInfo["appended"] = appended
        //nginx_trace染色
        oBaseInfo["tessar_nginx_trace"] = traceid;
        return oBaseInfo
      },
      rebasetraceid: function (server_action) {
        if ("setup" == server_action && undefined == traceid) {
          var tessar_nginx_trace = instantiated.gettraceCookie()
          if (undefined != tessar_nginx_trace && "" != tessar_nginx_trace) {
            traceid = tessar_nginx_trace
          }
        }
      },
      //启动强制发送setup标记信息，同时携带基础数据，该功能也同时支持bg消息
      sendbaseinfo: async function (server_action) {
        if (!arguments[0]) { server_action = "setup" }//默认参数
        try{
          instantiated.rebasetraceid(server_action)
          var oBaseInfo = await instantiated.GetBaseInfo()
          oBaseInfo["server_action"] = server_action
          oBaseInfo = JSON.stringify(oBaseInfo)
          instantiated.sendhttpinfo(oBaseInfo)
          instantiated.rebasetraceid(server_action)
          console.log("sendbaseinfo",server_action)
        }catch(e){
          console.log("sendbaseinfo","initfault",e)
        }

      },
      updateuid: function (uid) {
        uid_uid = uid
        instantiated.sendbaseinfo("session")
      },
      reconnect: function (enable) {
        oWebJssdkNetwork.reconnect(enable)
      },
      recursion: function (vkeylist) {
        if (instantiated) {
          var o = { "type": "input|textarea|button|img|a|div|span|ul|li|p" }
          var keylist = undefined != vkeylist ? JSON.stringify(vkeylist) : JSON.stringify(o)
          //默认不初始化悬停动作检测，这个会影响spidercheck
          instantiated.recursioninit(keylist,true)
          return true
        }
        return false
      }
    }
  }
  return {
    /*
    @getinstanceinit 对象初始化的外包函数，通过JSON对象来初始化对象，该函数只用来初始化
    @param initinfo JSON对象，包括的参数如下
    @return boolean 是否初始化成功
    @JSONparam appname 就是项目名称，通常是埋点系统给出
    @JSONparam appver 传递的项目版本，通常用来筛选不同的版本来完成跟踪设置
    @JSONparam uuid 如果用户登陆完成，则拿到用户的uid
    @JSONparam debug 测试开关，debug为true，优先向测试环境发送数据
    @JSONparam env 环境开关，evn为test则发送给测试环境，env为dev向开发环境发送数据，只有在debug开启时候有效果
    @JSONparam union 是否开启unioninfo的跨域联合访问，该参数影响跨c-tessar.xdf.cn/plumber/unioninfo.html的通用访问，对小程序来说影响极大,默认是false，开启
    */
    getinstanceinit: function (initinfo)
    {
      try {
        var jObj = JSON.parse(JSON.stringify(initinfo)) //通过变化检查json对象并构造一个新对象
        if(undefined!=jObj.union && true==jObj.union){
          this.sdk_version = this.sdk_version+"free"
        }
        if(undefined!=jObj.union && undefined!=jObj.debug){
          this.getinstance(jObj.appname,jObj.appver,jObj.uuid,jObj.debug,jObj.env)
        }
      } catch (error) {
        console.log("getinstanceinit:",error)
        return false
      }
      return false
    },
    /*
    @getinstance 初始化全局对象单例
    @param appname 就是项目名称，通常是埋点系统给出
    @param appver 传递的项目版本，通常用来筛选不同的版本来完成跟踪设置
    @param uuid 如果用户登陆完成，则拿到用户的uid
    @param debug 测试开关，debug为true，优先向测试环境发送数据
    @param env 环境开关，evn为test则发送给测试环境，env为dev向开发环境发送数据，只有在debug开启时候有效果
    */
    getinstance: function (appname, appver, uuid, debug, env) {

      if (!instantiated) {
        env = (undefined == env ? "test" : "dev")//根据外部参数或者node环境读取环境状态
        var process = undefined
        try {
          process = process || process.env.NODE_BUILD_ENV
        } catch (e) {
          process
        }
        if (undefined != process && undefined == debug)//且检测打包，按打包走
        {
          env = process.env.NODE_BUILD_ENV //读取环境参数，prod，test，dev
          if (process.env.NODE_BUILD_ENV === 'prod')//如果是prod状态，debug开关关闭
          { debug = false } else { debug = true }
        } else if (undefined != debug) {
          if (false == debug) { env = 'prod' }
        }
        //开始判断debug开关和env参数
        dev = (debug == true ? true : false)
        var ishttps = 'https:' == document.location.protocol ? true : false;
        var pre_fix = "http"
        if (ishttps) {
          pre_fix = "https"
        }
        if (dev == false) {
          packenv = "prod"
          plumbersendhttp = pre_fix + "://c-tessar.xdf.cn/plumber/statis/"
          recommendsendhttp = pre_fix + "://c-tessar.xdf.cn/plumber/recommend/"
          unioninfohttp = "https://c-tessar.xdf.cn/plumber/unioninfo/"
          sdk_version = sdk_version + "-" + "prod"
        }
        else if (dev == true && env == "test") {
          packenv = "test"
          plumbersendhttp = pre_fix + "://c-tessar.test.xdf.cn//plumber/statis/"
          recommendsendhttp = pre_fix + "://c-tessar.test.xdf.cn/plumber/recommend/"
          unioninfohttp = "https://c-tessar.test.xdf.cn/plumber/unioninfo/"
          sdk_version = sdk_version + "-" + env
        }
        else if (dev == true && env == "dev") {
          packenv = "dev"
          plumbersendhttp = pre_fix + "://lunarhook.picp.vip/plumber/statis/"
          recommendsendhttp = pre_fix + "://lunarhook.picp.vip/plumber/recommend/"
          unioninfohttp = "https://lunarhook.picp.vip/plumber/unioninfo/"
          sdk_version = sdk_version + "-" + env
        }
        appmeta_appname = appname != undefined ? appname : "default"
        appmeta_groupname = appmeta_appname.split("_");
        appmeta_groupname = appmeta_groupname.pop()
        appmeta_appver = appver != undefined ? appver : ""
        uid_uid = uuid != undefined ? uuid : ""
        rGuid = GetGuid(appmeta_appname)
        uid_sid = rGuid.guid
        var namekey = 'tessar-iframe-unioninfo'
        oWebJssdkNetwork = WebJssdkNetwork.getinstance()
        instantiated = new init();
        instantiated.initWebInfo()
        //默认打开时间检查系统
        instantiated.settimecheck()
        //  
        if (-1 == sdk_version.indexOf("free"))//乐学系统不做处理
        {
          var unioninfo_url = unioninfohttp + "?channel=" + appmeta_appname + "&url=" + location.href +"&t=" + 
          (new Date()).getTime() +"&tessarnginxnewtraceid=" + (true==rGuid.renew?"renew":uid_sid);
          if ("prod" == env) {
            unioninfo_url = unioninfohttp + "?channel=" + 
                            appmeta_appname + "&url=" + 
                            location.href + "&t=" + 
                            (new Date()).getTime() + "&tessarnginxnewtraceid=" +
                            (true==rGuid.renew?"renew":uid_sid);
                            
          }
          var handshake = new Postmate({
            container: document.body, // Element to inject frame into
            url: unioninfo_url, // Page to load, must have postmate.js. This will also be the origin used for communication.
            name: namekey, // Set Iframe name attribute. Useful to get `window.name` in the child.
            //classListArray: ["myClass"] //Classes to add to the iframe via classList, useful for styling.
          });
          var iframe = document.getElementsByName(namekey)
          if (undefined != iframe && iframe.length >0 && iframe[0].parentNode) {
            iframe[0].height = 1;
            iframe[0].width = 1;
            iframe[0].hidden = true;

            // When parent <-> child handshake is complete, data may be requested from the child
            handshake.then(function (child) {
              // Fetch the height property in child.html and set it to the iFrames height
              //child.get('height').then(height => child.frame.style.height = `${height}px`);
              // Listen to a particular event from the child
              child.on('tessar-event', function (data) {

                if (undefined != data) {
                  var group = new Object()
                  group.guid = data.connect_guid
                  group.guidcreattime = (new Date(data.connect_guidcreattime)).valueOf()
                  group.guidchannel = data.connect_guidchannel
                  group.guidip = data.connect_guidip
                  group.citycode = data.connect_citycode
                  group.cityname = data.connect_cityname
                  group.ips = data.ips
                  group.channel_group = data.connect_guidchannel_group
                  group.guidurl_group = data.connect_guidurl_group
                  group.tessar_nginx_traceid = undefined!=data.tessar_nginx_traceid?data.tessar_nginx_traceid:data.tessar_nginx_new_traceid
                  //服务器unioninfo会保证你之前如果携带过染色不会丢失，按历史下发
                  instantiated.gettraceCookie(group.tessar_nginx_traceid)
                  connect_group = group
                }
                if (undefined != iframe && iframe.length >0 && iframe[0].parentNode) {
                  iframe[0].parentNode.removeChild(iframe[0]);
                }
                instantiated.addTodbwithrecommend("identify", undefined, "identify")
                delete connect_group.ips
                //delete connect_group.channel_group
                connect_group.url_group = new Array()
                undefined != connect_group.guidurl_group[0] ? connect_group.url_group.push(connect_group.guidurl_group[0]) : {}
                undefined != connect_group.guidurl_group[1] ? connect_group.url_group.push(connect_group.guidurl_group[1]) : {}
                delete connect_group.guidurl_group
              }); // Logs "Hello, World!"
            });
            //强制删除交互窗口
            setTimeout(function () {
              try {
                //如果发生强制跨域跳转，可会删除iframe
                var iframe = document.getElementsByName(namekey)
                if (undefined != iframe && iframe.length >0 && iframe[0].parentNode) {
                  iframe[0].parentNode.removeChild(iframe[0]);
                }
              } catch { }
            }, 4000);
          }
        }
        setInterval(function () {
          instantiated.updaterecommend()
        }, recoomendtick);
      }
      return instantiated;
    },
  }

})();
(function () {
  window.webjssdk = webjssdk
  return window.webjssdk;
})()

</script>

</body>
</html>
