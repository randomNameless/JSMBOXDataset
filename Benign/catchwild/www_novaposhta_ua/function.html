<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>function.html</title>
</head>
<body>

<script>
// NovaPoshta Scripts
window.NovaPoshta = window.NovaPoshta || {};
window.NovaPoshta.trackAnalitycs = function(url)
{
    // Дергаем аналитику посещений
    if(typeof ga == 'function')
    {
        ga('send', 'pageview');
    }
    else if(typeof _gaq != 'undefined')
    {
        _gaq.push(['_trackPageview', url]);
    }
    else if(typeof pageTracker != 'undefined')
    {
        pageTracker._trackPageview(url);
    }
}
function validate_ini() {
    $(".form_wrap form [data-validate], .search_cargo_form [data-validate]").unbind('blur');

    var validate = function(arg)
    {
        var curObj = $(arg);

        if (curObj.hasClass("opt") || curObj.is(':disabled') || (!curObj.is(':visible') && !curObj.is('[type="hidden"]'))) {
            return false;
        }

        var error = {};
        var c = curObj.val();
        var dv = curObj.data("validate");
        var limit = curObj.data("limit");
        var form = curObj.closest('form');

        function addError(curObj, error, dv, err_string) {
            curObj
                .addClass("error")
                .parents(".i").prev(".l").removeClass("valid").addClass("invalid");
            error[dv] = err_string ;
        }
        function addAttention(curObj, error, dv, err_string) {
            addError(curObj, error, dv, err_string)
            curObj.nextAll('.attention').addClass('show').find('i').mouseenter();
        }
        function removeError(curObj, error, dv) {
            curObj.removeClass("error");
            if (!curObj.parents(".i").find(".error").length) {
                curObj.parents(".i").prev(".l").addClass("valid").removeClass("invalid");
            }
            delete error.dv;
            curObj.nextAll('.attention').removeClass('show');
        }

        if (dv == "factual_weight" ) {
            var fw_limit = 1100;
            if (c == '' || c == ' ' || c == "" ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else if(parseFloat(c) > fw_limit) {
                addAttention(curObj, error, dv, "Вы не можете воспользоваться этой услугой, так как фактический вес превышает " + fw_limit + " кг");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "volume_weight" ) {
            var fw_limit = 1100;
            if (c == '' || c == ' ' || c == "" ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
                $('#CarrierForm_length, #CarrierForm_width, #CarrierForm_height').addClass('error');
            } else if(parseFloat(c) > fw_limit) {
                addAttention(curObj, error, dv, "Вы не можете воспользоваться этой услугой, так как объемный вес превышает " + fw_limit + " кг");
                $('#CarrierForm_length, #CarrierForm_width, #CarrierForm_height').addClass('error');
            } else {
                removeError(curObj, error, dv);
                $('#CarrierForm_length, #CarrierForm_width, #CarrierForm_height').removeClass('error');
            }
        }



        if (dv == "full" ) {
            if (c == '' || c == ' ' || c == "" ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "weight-limit" ) {
            if(curObj.attr('type') == 'checkbox') {
                c = curObj.is(':checked');
            }

            var weight_count = parseFloat(form.find('.weight_kg input[type="text"]:visible').val())/parseFloat(form.find('.places_count input[type="text"]:visible').val());
            if(!isNaN(weight_count) && weight_count > limit && (c != '' || c != "")) {
                addAttention(curObj, error, dv, "Вы не можете воспользоваться этой услугой, так как вес одного места превышает "+limit+" кг");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "back-price" ) {
            $('.MAX_SUM_DELIVERY_PRICE').hide();
            if (c == '' || c == ' ' || c == "" ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else if(parseFloat(c) > limit) {
                addAttention(curObj, error, dv, "Сумма одного денежного перевода не может превышать "+limit+" грн");
            } else if($('#DeliveryForm_backDelivery').prop("checked")
                && $('#DeliveryForm_backDelivery_cargoType').val() == 'ValuablePapers'
                && $('#DeliveryForm_deliveryTechnology_id').val() != 'WarehouseWarehouse'
                && window.MAX_SUM_DELIVERY_PRICE
                && parseFloat($('#DeliveryForm_backDelivery_amount').val()) > window.MAX_SUM_DELIVERY_PRICE){
                $('.MAX_SUM_DELIVERY_PRICE').show();
                $('.MAX_SUM_PUBLIC_PRICE').hide();
                addAttention(curObj, error, dv, "MAX_SUM_DELIVERY_PRICE");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "phone" ) {
            var reg = new RegExp('[0-9]+');
            if (!reg.test(c)) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "phones" ) {
            var reg = new RegExp('[0-9]+');
            if (!reg.test(c)) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else if(c.length != 10) {
                addAttention(curObj, error, dv, "Неверно указан номер телефона. Номер должен начинаться с кода города или оператора, с цифры 0.");
            } else {
                removeError(curObj, error, dv);
            }

            if (typeof window.BlackListPhones !== 'undefined') {
                var blacklist = window.BlackListPhones ? window.BlackListPhones : [];
                var phone = curObj.val();
                if (blacklist.indexOf('38' + phone) > -1 || blacklist.indexOf('+38' + phone) > -1 || blacklist.indexOf(phone) > -1) {
                    addError(curObj, error, dv, "Заборонено використовувати данний номер");
                }
            }
        }

        if (dv == "date" ) {
            var reg = new RegExp('[0-9.]+');

            if (!reg.test(c)) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == 'weight_documents'){
            if (c == '' || c == ' ' || c == '0' || c == 0) {
                // addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else {
                removeError(curObj, error, dv);
            }
            if ($('#DeliveryForm_cargoType').val() != 'Documents') {
                removeError(curObj, error, dv);
                curObj.parents(".i").prev(".l").removeClass("valid");
            }
        }

        if (dv == "select_only") {
            if ( !curObj.siblings(".dropdown").find("li[data-value='" + c + "']").length ) {
                addError(curObj, error, dv, "Неверное значение поля");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "select" ) {
            if ( !curObj.siblings(".dropdown").find("li[data-value='" + c + "']").length ) {
                addError(curObj, error, dv, "Неверное значение поля");
            } else {
                removeError(curObj, error, dv);
            }

            if (c == 'Pallets' || c == 'TiresWheels') {
                var valid = false;
                $('.m_discs_tyres input[type="text"]').each(function(){
                    if (($(this).val() != '' || $(this).val() != "") && ($(this).siblings(':checkbox:checked').length)) {
                        valid = true;
                    }
                });
                if (!valid) {
                    addError(curObj, error, dv, $translate.mustFill[currentLang]);
                } else {
                    removeError(curObj, error, dv);
                }
            }

            $('[data-value="cb73a7e9-7b86-4094-8885-613f2d5a662f"]').toggle(c !== 'Pallet' && c !== 'TiresWheels'); // скрываем обрешетовку
        }

        if (dv == "autocomplete" ) {
            var autocompleteActive = curObj.closest(".b_autocomplete").find('.drop-down-ul li.active');
            var autocompleteValue = autocompleteActive.children('span').length ? autocompleteActive.children('span').text() : autocompleteActive.text();
            if (c == '' || c == ' ' || c == "" ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else if (autocompleteValue != c ) {
                addError(curObj, error, dv, "Выбрано неверное значение поля");
            } else {
                removeError(curObj, error, dv);
            }
        }

        if (dv == "birth" ) {
            if (c == '' || c == ' ' ) {
                addError(curObj, error, dv, "Это поле должно быть заполнено");
            } else {
                removeError(curObj, error, dv);

                // parse years
                var check = c.split("-");
                var year = new Date;
                year = year.getFullYear();
                if (parseInt(check[0]) > 31 || parseInt(check[1]) > 12 || parseInt(check[2]) > year || parseInt(check[2]) < 1910 ) {
                    addError(curObj, error, dv, "Дата рождения введена неверно");
                } else {
                    removeError(curObj, error, dv);
                }
            }
        }

        if (dv == "email" ) {
            var reg = /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;

            if ( reg.test(c) != true) {
                addError(curObj, error, dv, "Адрес e-mail введен неверно");
            } else {
                removeError(curObj, error, dv);
            }
        }
        //console.log(error);
    }

    $(document).on('blur', ".form_wrap form [data-validate], .search_cargo_form [data-validate]", function(e) {
        validate(this);
    });

    $(document).on('change', ".form_wrap form [data-validate], .search_cargo_form [type=checkbox][data-validate]", function(e) {
        validate(this);
    });
}
$(document).ready(function(e) {
    /* Default ajax setup */
    $(document).ajaxSend(function(event, jqxhr, settings) {
        if (settings.crossDomain === false && $("input[name=YIICSRFTOKEN]").val() !== '') {
            jqxhr.setRequestHeader('YIICSRFTOKEN', $("input[name=YIICSRFTOKEN]").val());
        }
    });
    // if(currentLang == 'ru') {
    //     $('.banner-mobile-app').css('background', 'url(https://static.novaposhta.ua/sitecard/misc/img/foxtrot_ru.png)');
    //     $('.url-banner').attr("href", "http://bit.ly/32FmxaW");
    // } else {
    //     $('.banner-mobile-app').css('background', 'url(https://static.novaposhta.ua/sitecard/misc/img/foxtrot_ua.png)');
    //     $('.url-banner').attr("href", "http://bit.ly/30ME0fJ");
    // }
    // $('.banner-mobile-app').css('background', 'url(https://static.novaposhta.ua/sitecard/misc/img/monatik_600x260_' + currentLang + '.jpg)');
    $('.url-banner').attr("href", "http://bit.ly/32FmxaW");

    disableType();
    drop();
    styledCheck();
    inputs();
    validate_ini();
    map_h_shadows();
    initHelpQuestionsPopup();
    setPointerDescPosition();
    initScrollerButton();
    initWeightPerPlaceValidate();
    googleMapSearchTimeOut = 0;
    var tp_t = 0;
    $(".reset_date_estimate, .reset_track").click(function(e) {
        $('.response').hide();
    });

    $('body').click(function(e) {
        var target = $(e.target)
        if (!target.parents('.time_popup').length) {
            $('.offices .time_popup .pop.opened').animate({'height': 20}, 100, function() {
                $(this).css('top', '').removeClass('opened');

                $('.offices .time_popup .pop').removeClass('opened');
                $('.offices .time_popup .pop').addClass('popcent');
            });
        }
    });

    $('#popup_help .sections-list ul').children('li:nth-child(4n)').addClass('row');

    $('body').on('click','.reset', function(e) {
        var form = $(this).closest('.b_tooltip').length ? $(this).closest('.b_tooltip') : $(this).parents('form');
        form.find('input[type="text"],input[type="password"], textarea').val("").removeClass('error');
        form.find('.invalid').removeClass('invalid');
        form.find('.valid').removeClass('valid');
        form.find('.b_autocomplete input[type="hidden"]').val("");
        if (form.find('.pickdate_today').length) {
            form.find('.pickdate_today').datepicker("setDate", new Date());
        }
        if (form.find('.pickdatetime_today').length) {
            form.find('.pickdatetime_today').datetimepicker("setDate", new Date());
        }
        if (form.find('.top.results').length) {
            form.find('.top.results').remove();
        }
        e.preventDefault();
    });

    $('#footer_click').on('click', function(e) {
        if ($("#footer_reserved").is(":hidden")) {
            $("#footer_reserved").slideDown("normal");
        } else {
            $("#footer_reserved").slideUp("normal");

        }
    });

    $('table.offices').on('click','.time_popup .pop', function(e) {
        //if ($(this).find('li').length < 2) {return false;}

        var $pop = $(this.parentElement.parentElement).find('div.pop');
        var $pops = $('.time_popup').find('.pop');

        $pops.each(function(counter, elem){
            elem.classList.remove("opened");
            elem.classList.add("popcent");
            elem.style.height = "40px";
        });

        if (!$(this).hasClass('checkOpened')) {
            $pop.addClass('opened');
            $pop.addClass('checkOpened');

            $('.today').show();
            $('.opened .today').hide();

            var height = 40;
            $pop.height('auto');
            $pop.each(function(){
                if($(this).height() > height) {
                    height = $(this).height();
                }
            });
            $pop.height(40);
            $pop.width(152.700);

//            $(this).css('top', $(this).position().top);
            $pop.animate({'height': height}, 200);
            $(this).trigger('open');
        } else {
            $pop.removeClass('checkOpened');
            if(e.target.nodeName == 'INS' || !$pop.data('noclose-on-click')) {
                $pop.animate({'height': 40}, 200, function() {
                    $('.today').show();
                    $pop.css('top','').removeClass('opened');
                });
            }
        }
    });


    $('body').on('click','form .o_clear_btn', function(e, data) {
        var form = $(this).closest('form');
        var parent = $(this).parent();
        parent.find('input[type="text"],input[type="password"], textarea').val("").removeClass('error').trigger('change', data);
        parent.find('.b_autocomplete input').val("").focusout().siblings('.scroll-element').find('li.active').removeClass('active');
        parent.find('.select .dropdown li').each(function() {
            if ($(this).data('value') == '' || $(this).data('value') == '0') {
                $(this).click();
            }
        });


        if (form.hasClass('clear_submit')) {
            form.submit();
        }
        if (parent.hasClass('city'))
        {
            $('#sundayFilter').attr('checked', false);
            $('#selfServiceFilter').attr('checked', false);
            $('#nowFilter').attr('checked', false);
            //$('.postomat-radio-buttons input[value=warehouse]').attr('checked', true);
            $('body').trigger('ymaps-event-reset-map');
            form.find('.office_num input').val("").siblings('.scroll-element').find('li').remove();
            $('.offices_wrap .offices tbody tr').remove();
            $('.offices_wrap .offices').hide();
        }
        if ($(this).hasClass('clear_nearest'))
        {
            parent.find('input[type="hidden"]').val("");
            $('body').trigger('ymaps-event-remove-nearest-marker');
            $('body').trigger('ymaps-event-reset-map');
            $("#search_bar .b_autocomplete input").val('');
            $('#search_bar .office_num .drop-down-ul li').remove();
        }
        if (parent.hasClass('office_num')) {
            $("ul.d_cities").find('li.active').addClass('ymaps-event').trigger('ymaps-filter-city');
            $('.weight .dropdown li[data-value="0"]').trigger('click', [1]);
            //$('.postomat-radio-buttons input[value="warehouse"]').trigger('click', [1]);
            $('#sundayFilter').attr('checked', false);
            $('#nowFilter').attr('checked', false);
            $('#selfServiceFilter').attr('checked', false);
            //getWarenHouseList($('#i_City').val());
        }
        e.preventDefault();
    });

    if ($("body.content-map .search_map").length) {
        $('body').click(function(e) {
            var target = $(e.target)
            if (!target.parents('.search_map').length) {$('.search_map ul.results').hide()}
        });

        $("#header.map .search_map .body input").keyup(function(e) {
            var obj = $(this);

            var a = e.keyCode;
            if (a == 32 || a == 37 || a == 38 || a == 39 || a == 40 || a == 13 || obj.val() === '') {
                return;
            }
            if (obj.val().length < 3) {
                return;
            }
            clearTimeout(googleMapSearchTimeOut);
            googleMapSearchTimeOut = setTimeout(function () {
            if (obj.attr('id')==='address')
            {
                obj.addClass('ymaps-event').trigger('ymaps-search-places');
            }
//            if ($(".ui-autocomplete:visible").length) {
//                obj.parents(".body").addClass("m_ac_on");
//            } else {
//                obj.parents(".body").removeClass("m_ac_on");
//            }
//
//            var t = setTimeout(function() {
//                if ($(".ui-autocomplete:visible").length) {
//                    obj.parents(".body").addClass("m_ac_on");
//                } else {
//                    obj.parents(".body").removeClass("m_ac_on");
//                }
//            }, 100)
            }, 200);
        });

        $("#header.map .search_map .body input").focusout(function(e) {
            if ($(this).val() == "") {
                $(this).siblings('input[type="hidden"]').val("");
            }
        });

//        $(".ui-autocomplete .ui-menu-item").click(function() {
//            $("#header.map .search_map .body").removeClass("m_ac_on");
//        })
//        $("#header.map .search_map .body input").focusout(function() {
//            $(this).parents(".body").removeClass("m_ac_on");
//        });

        $("#header.map ul.results").on('click','li',function(){
            var t=$(this);
            t.closest('.search_map').find('input[type="text"]').val(t.text());
            t.addClass('ymaps-event').trigger('ymaps-nearest-search');
            $("#search_bar .b_autocomplete input").val('');
            $('#search_bar .office_num .drop-down-ul li').remove();
        });

        $('.search_map ul.results').hover(function(){
            $(this).addClass('hover_list');
        }, function() {
            $(this).removeClass('hover_list');
        });

        $("body").on('mouseenter','.search_map ul.results li',function(){
            $(this).addClass('hover');
        });

        $("body").on('mouseleave','.search_map ul.results li',function(){
            $(this).removeClass('hover').siblings('.hover').removeClass('hover');
        });

        $("body").on('keydown','.search_map input',function(e){
            var dropdown = $(this).closest('.search_map').find('ul');
            var hover = dropdown.children('li.hover:visible');
            var first = dropdown.children('li:visible:first');
            var last = dropdown.children('li:visible:last');
            var scrollTop = dropdown.scrollTop();
            var scrollTopDown = scrollTop + dropdown.outerHeight();

            switch (e.keyCode){
                case 38:
                    if (hover.length && !hover.is(first)) {
                        hover.removeClass('hover').prevAll('li:visible:first').addClass('hover');
                    } else if (hover.is(first)) {
                        hover.removeClass('hover');
                        last.addClass('hover');
                        dropdown.scrollTop(last.position().top);
                    } else {
                        last.addClass('hover');
                    }

                    hover = hover.prevAll('li:visible:first');
                    if (hover.length && hover.position().top + scrollTop <= scrollTop) {
                        dropdown.scrollTop((hover.position().top + scrollTop));
                    }

                    break;
                case 40:
                    if (hover.length && !hover.is(last)) {
                        hover.removeClass('hover').nextAll('li:visible:first').addClass('hover');
                    } else if (hover.is(last)) {
                        hover.removeClass('hover');
                        first.addClass('hover');
                        dropdown.scrollTop(0);
                    } else {
                        first.addClass('hover');
                    }

                    hover = hover.nextAll('li:visible:first');
                    if (hover.length && hover.position().top + scrollTop + hover.outerHeight() >= scrollTopDown) {
                        dropdown.scrollTop(((hover.position().top + hover.outerHeight()) - dropdown.outerHeight()) + scrollTop);
                    }

                    break;
                case 13:
                    hover.click();
                    break;
            }

            if (e.keyCode == 38 || e.keyCode == 40 || e.keyCode == 13) return false;
        });
    }

    window.onload = function() {
        $('body').on('keypress keyup', '#codeFilter', function(event){
            if(event.keyCode == 13){
                addressSuccess('list', 1, 1);
            }
        });

        $(".nova_post_a").click(function(e) {
            $('.modal-nova-post-frame').html('<iframe class = \'nova_post\' src=\'https://forms.novapost.world/#/?source=ua-site&locale=uk\' width=\'100%\' frameborder=\'0\'></iframe><br/>'); $('.modal-nova_post').css('display', 'block');
        });

        window.addEventListener("message", receiveMessage, false);

        const handlerMessage = (e) => {
           if (e.data.type == "analytics") {
                const data = e.data;
                window.dataLayer = window.dataLayer || []; //не обов'язково, якщо dataLayer вже створено на цьому етапі
                data.event = data.name; //додавання назви події в data.params.event (вимоги GTM)
                dataLayer.push(data);
            }
        }

        if(window.addEventListener){
            window.addEventListener('message', handlerMessage);
        } else {
            window.attachEvent('message', handlerMessage);
        }

        function receiveMessage(event)
        {
            if (event.data.name == 'close') {
                $('.modal-nova_post').css('display', 'none');$('.nova_post').css('display', 'none');
                $('.modal-nova_post').html('');
            }
        }
    };

    $("#user_menu .logo_in, #top_menu .logo_in, .logo_in").click(function(e) {
        //popOpen( "login" );
    });

    $(".click.popup").click(function(e) {
        e.preventDefault();
        popOpen($(this).data("open"));
    });

    if ($.fn.masonry) {
        $(".order.complete > .block").masonry({
            itemSelector: '.shard',
            columnWidth: 290,
            gutterWidth: 15,
            isFitWidth: true
        });

    }

    $('body').on('change', '.conditionsCheck', function() {
        var form = $(this).closest('form');
        var submit = form.find('.submit');
        if ($(this).is(':checked')) {
            form.find('[data-validate]').blur();
            submit.removeAttr('disabled');
        } else {
            submit.attr('disabled', 'disabled');
        }
    });

    $('body')
        .on('keypress keyup change', 'input.dublicate', function() {
            $('[data-dublicate-rel="'+$(this).data('dublicate')+'"]').val($(this).val());
        })
        .on('click', '.help-popup-trigger', function(){
            popOpen('help');
            return false;
        });

    $(".company").on('click', function(){
        var corp       = $(".company");
        var passport_block = $(".passport_block");

        if (corp.prop("checked")) {
            passport_block.hide();
        } else {
            passport_block.show();
        }
    });

    $(".checkbox-hide").change(function(e) {
        var content = $('[data-rel-hide="' + $(this).data('rel') + '"]');
        if($(this).is(':checked')) {
            content.removeClass('hide');
        } else {
            content.addClass('hide').find('input[type="text"]').val('').removeClass('error');
            content.find('.invalid').removeClass('invalid');
        }
    });

    $('body').on('keypress keyup blur', '.dimensions input', function(e){
        var vol_w = 0;
        var l = $(this).closest(".dimensions").find("input").length;
        $(this).closest(".dimensions").find("input").each(function(i) {
            if (vol_w == 0) {
                vol_w = parseFloat($(this).val());
            } else {
                vol_w = vol_w * parseFloat($(this).val());

            }

            if (i == l-1 && typeof vol_w == 'number' && !isNaN(vol_w)) $(this).closest(".i").find(".volume_weight").val((vol_w/4000).toFixed(2));
            $('#CarrierForm_length, #CarrierForm_width, #CarrierForm_height, .volume_weight').removeClass('error');
        })
    });

    if ($(".volume_weight").hasClass('error')){
        $('#CarrierForm_length, #CarrierForm_width, #CarrierForm_height').addClass('error');
    }

    $(".b_tooltip > i").hover(function(e) {
        $(this).addClass("hover");

        var curObj = $(this).parents(".b_tooltip");
        tp_t = setTimeout( function() {


            if (!curObj.children("i.hover").length) return false;


            var pos_under = 0;
            if (curObj.children("i").offset().left + 540 > $(window).width() || curObj.hasClass('m_discs_tyres')) {
                pos_under = 1;
                curObj.addClass("m_top");
            } else {
                curObj.removeClass("m_top");
            }

            if (curObj.children("i").offset().left + 250 > $(window).width() ) {
                curObj.addClass("m_left");
            } else {
                curObj.removeClass("m_left");
            }

            $(".b_tooltip.active:not(.attention) .b_tooltip_body").stop(true, true).fadeOut("fast", function () {
                curObj.parent().removeClass("active");
            })

            if (curObj.hasClass("m_big")) {

                curObj.prev(".tp_this").addClass("tp_over_mask");
                curObj.prev().find(".tp_this").addClass("tp_over_mask");

                curObj.find(".b_tooltip_body").removeAttr("style");

                if (pos_under) {
                    curObj.find(".b_tooltip_body")
                        .css("width", "900px")
                        .css("left", "50%")
                        .css("top", "80px")
                        .css("margin-left", "-470px");
                        // .css("margin-left", "-286px");
                } else {
                    curObj.find(".b_tooltip_body")
                        .css("left", "-99999px")
                        .css("display", "block")
                    curObj.find(".b_tooltip_body").css("top", "-" + curObj.find(".b_tooltip_body").outerHeight()/2 + "px" );
                    curObj.find(".b_tooltip_body")
                        .css("left", "")
                        .css("display", "");
                }

                if (!$(".popup_mask").length)  $("body").append('<div class="popup_mask"></div>');
                $(".popup_mask").fadeIn();



                curObj.find(".b_tooltip_body").fadeIn("fast", function () {
                    curObj.addClass("active");
                    if (window.PIE) PIE.attach(this);

                    curObj.find(".btn.close").click(function(e) {
                        e.preventDefault();

                        $(".popup_mask").fadeOut();
                        curObj.find(".b_tooltip_body").fadeOut("fast", function() {
                            $(".tp_over_mask").removeClass("tp_over_mask");
                            curObj.removeClass("active");
                            if (window.PIE) PIE.detach(this)
                        });
                    });

                    $(".popup_mask").click(function(e) {
                        curObj.find(".btn.close").trigger("click");
                    });


                });
            } else {
                // not .big
                curObj.find(".b_tooltip_body").fadeIn("fast", function () {
                    $(this).parent().addClass("active");
                    if (window.PIE) PIE.attach(this);
                    $(".b_tooltip.active").not(".big").mouseleave(function(e) {
                        $(".b_tooltip.active .b_tooltip_body").fadeOut("fast", function () {
                            if (window.PIE) PIE.detach(this);
                            $(this).parent().removeClass("active");
                        })
                    });
                });
            }

        }, 200 );

    }, function () {
        //document.tp_t
        if ($(this).parents('.attention').length) return false;

        window.clearTimeout(tp_t);

        $(this).removeClass("hover");

        var curObj = $(this).parents(".b_tooltip");

        if (!curObj.hasClass("m_big")) {
            $(".b_tooltip.active .b_tooltip_body").fadeOut("fast", function () {
                $(this).parent().removeClass("active");
                if (window.PIE) PIE.detach(this);
            })

        }

    });

    if ($.fn.mask) {
//        $.mask.definitions['~']='[0-9]?';
//        $(".phone_mask").mask("(999~~) ~~9-99-99", { placeholder: " "});


        // $.mask.definitions['~']='[абвгдеждзийклмонпрстуфхцчшщьыъэюяАБВГДЕЖЗИКЛМОНПРСТУФЧЦШЩЬЫЪЭЮЯ]';
        // $(".cargo_id_mask").mask("9999-9999-9999-99");


        $(".birth_mask").mask("*9-*9-9999", {placeholder: " "});
    }


    $(".form_wrap .list.check input:text").focus(function(e) {
        if ($(this).parents(".b_tooltip.m_discs_tyres").length) {
            $(this).attr("data-validate", "phone");
        } else {
            $(this).attr("data-validate", "full");
        }
        validate_ini();
        $(this).siblings("input:checkbox").attr("checked", "checked");
    });
    $(".form_wrap .list.check.full input:checkbox").change(function(e) {
        if ($(this).attr("checked") == "checked") {
            $(this).siblings("input:text")
                .focus()
                .attr("data-validate", "full");
            validate_ini();
        } else {
            $(this).siblings("input:text")
                .removeAttr("data-validate")
                .removeClass("error")
                .val("");
            validate_ini();
        }
    });


    if (  $.fn.autocomplete_k ) {
        $("form .b_autocomplete").each(function() {
            $(this).autocomplete_k();
        });
    }


    if (  $.fn.datepicker ) {
        $("form .pickdate").datepicker({
            regional: "ru",
            firstDay: 1,
            onClose: function() {
                $("form .date").blur();
            }
        });

        $("form .pickdate_today").datepicker({
            regional: "ru",
            firstDay: 1,
            minDate: 0,
            onClose: function() {
                $("form .date").blur();
            }
        });

        var year = new Date;
        year = year.getFullYear();

        $("form .pickdate_birth").datepicker({
            regional: "ru",
            firstDay: 1,
            changeYear: true,
            changeMonth: true,
            yearRange: "1910:"+year,

            onClose: function() {
                $("form .date").blur();
            }
        });

        $( "form .pickdate2.from" ).each(function() {
            $(this).datepicker({

                firstDay: 1,
                changeYear: true,
                changeMonth: true,
                showAnim: '',
                yearRange: "1960:"+year,
                onClose: function( selectedDate ) {
                    var d = selectedDate.split(".");
                    var d2 = new Date();
                    d2.setDate(d[0]);
                    d2.setMonth(d[1]-1);
                    d2.setFullYear(d[2]);
                    var d3 = new Date( parseInt(d2.getTime()) + 86400000 );

                    var dd = parseInt(d3.getDate());
                    if (dd < 10) dd = '0' + dd;
                    var d4 = dd + "." + (parseInt( d3.getMonth()) +1) + "." + d3.getFullYear();

                    $(this).parents(".f_l").siblings().find( ".pickdate2.to" ).datepicker( "option", "minDate", d4 );
                    $(this).blur();
                }
            });

        });


        $( "form .pickdate2.to" ).each(function() {
            $(this).datepicker({

                firstDay: 1,
                changeYear: true,
                changeMonth: true,
                showAnim: '',
                yearRange: "1960:"+year+7,
                onClose: function( selectedDate ) {
                    $(this).blur();
                    $(this).siblings(".f_l").find( ".pickdate2.from" ).datepicker( "option", "maxDate", selectedDate );
                }
            });


        });


    }


    if ( $.fn.datetimepicker ) {
        /**
         * RPZ-82596 исправление язвка календаря
         */
        $.datepicker.regional['ru'] = {
            closeText: 'Закрыть',
            prevText: '&#x3c;Пред',
            nextText: 'След&#x3e;',
            currentText: 'Сегодня',
            monthNames: ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'],
            monthNamesShort: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн',
                'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
            dayNames: ['воскресенье', 'понедельник', 'вторник', 'среда', 'четверг', 'пятница', 'суббота'],
            dayNamesShort: ['вск', 'пнд', 'втр', 'срд', 'чтв', 'птн', 'сбт'],
            dayNamesMin: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
            dateFormat: 'dd.mm.yy', firstDay: 1,
            timeOnlyTitle: 'Выберите время',
            timeText: 'Время',
            hourText: 'Часы',
            minuteText: 'Минуты',
            secondText: 'Секунды',
            millisecText: 'Миллисекунды',
            timezoneText: 'Часовой пояс',
            timeFormat: 'HH:mm',
            amNames: ['AM', 'A'],
            pmNames: ['PM', 'P'],
            isRTL: false
        };
        $.timepicker.regional['ru'] = {
            timeOnlyTitle: 'Выберите время',
            timeText: 'Время',
            hourText: 'Часы',
            minuteText: 'Минуты',
            secondText: 'Секунды',
            millisecText: 'Миллисекунды',
            timezoneText: 'Часовой пояс',
            currentText: 'Сейчас',
            closeText: 'Закрыть',
            timeFormat: 'HH:mm',
            amNames: ['AM', 'A'],
            pmNames: ['PM', 'P'],
            isRTL: false
        };

        $.datepicker.regional['uk'] = {
            closeText: 'Закрити',
            prevText: '&#x3c;Попер',
            nextText: 'Наст&#x3e;',
            currentText: 'Сьогодні',
            monthNames: ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень',
                'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'],
            monthNamesShort: ['Сiч', 'Лют', 'Бер', 'Квiт', 'Трав', 'Черв',
                'Лип', 'Серп', 'Вер', 'Жовт', 'Лист', 'Груд'],
            dayNames: ['неділя', 'понеділок', 'вівторок', 'середа', 'четверг', 'пятница', 'суббота'],
            dayNamesShort: ['нд', 'пн', 'вт', 'ср', 'чт', 'пт', 'сб'],
            dayNamesMin: ['Нд', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
            dateFormat: 'dd.mm.yy', firstDay: 1,
            isRTL: false,
        };
        $.timepicker.regional['uk'] = {
            timeOnlyTitle: 'Оберіть час',
            timeText: 'Час',
            hourText: 'Години',
            minuteText: 'Хвилини',
            secondText: 'Секунди',
            millisecText: 'Мілісекунди',
            timezoneText: 'Часовий пояс',
            currentText: 'Зараз',
            closeText: 'Закрити',
            timeFormat: 'HH:mm',
            amNames: ['AM', 'A'],
            pmNames: ['PM', 'P'],
            isRTL: false
        };
        if ($("form .pickdatetime_today").data('lang') === 'uk') {
            $.timepicker.setDefaults($.timepicker.regional['uk']);
            $.datepicker.setDefaults($.datepicker.regional['uk']);
        }
        if ($("form .pickdatetime_today").data('lang') === 'ru') {
            $.timepicker.setDefaults($.timepicker.regional['ru']);
            $.datepicker.setDefaults($.datepicker.regional['ru']);
        }

        $("form .pickdatetime_today").datetimepicker({
            autoclose: true,
            language: "uk",
            format: "dd.mm.yyyy HH:ii",
            minView: 0,
            maxView: 3,
            pickerPosition: "bottom-left",
            todayBtn: true,
            weekStart: 1,
            minDate: new Date(),
        });
    }

    if ($(".job_application").length) {

        $(".job_application .still_work input").change(function(e) {
            if ($(this).attr("checked") == "checked") {
                $(this).parents(".i").find(".pickdate2.to")
                    .datepicker("setDate", new Date() )
                    .addClass("opt").attr("disabled", "disabled").removeClass('error');
            } else {
                $(this).parents(".i").find(".pickdate2.to").removeClass("opt").removeAttr("disabled");
            }
        });

    }


    /* accordeon2 */

    $(".accordeon2").each(function() {
        function accDynamics(curObj) {

            curObj.children(".completed").dblclick(function() {
                $(this).siblings(".active").removeClass("active");
                $(this)
                    .removeClass("completed")
                    .addClass("active");
            })

        }


        var l = $(this).children("li").length;
        var curObj = $(this);

        curObj.children("li").addClass("folded disabled");
        accDynamics(curObj);

        curObj.children("li:first").removeClass("disabled");
        curObj.children("li:first:not('.no_slide')")
            .removeClass("folded").addClass("active")
            .children(".wrap").slideDown();

        /*
         curObj.parents("form").submit(function(e) {
         curObj.children("li:not(.disabled):last").find(".btn").click();
         });
         */

        curObj.children("li").find(".wrap > .btn").click(function(e) {
            $(this).siblings(".i").find("[data-validate]").blur();

            if (!$(this).siblings(".i").find(".error").length) {
                if ( $(this).parents("li").index()+1 == l ) {
                    $(this).parents("form").submit();
                } else {
                    $(this).parents("li")
                        .addClass("completed")
                        .removeClass("active")
                        .next("li")
                        .removeClass("folded disabled")
                        .addClass("active")
                        .children(".wrap").slideDown();
                    var offset = $(this).parents("li").next("li").offset().top-20;
                    $("body").animate({
                        scrollTop: offset
                    });
                    accDynamics(curObj);

                    $(this).closest('form').trigger('step.next');
                }
            } else {
                return false;
            }
        });


        curObj.children("li").find(".title").click(function(e) {
            $(this)
                .next(".wrap").slideToggle()
                .parents("li").toggleClass("folded");
        });


    });


    /* validation */

    $(".form_wrap form, .search_cargo_form form").submit(function(e) {
        $(this).find("[data-validate]").blur();
        $(":disabled").removeClass("error");
        if ($(this).find(".error").length) {
            e.preventDefault();
        }
    });

    $('body').on('keypress keyup', '.allowed-char', function(e){
        var C;
        var a = e.which;
        var c = String.fromCharCode(a);
        var pointPos;

        // коды служебных кнопок для input fields трекинга
        var serviceButtonsCode = [
            0, // arrows
            8, // backspace
            9,
            13, // enter
            16,
            17,
            36,
            37,
            38,
            39,
            40,
            46, // delete
        ];
        var arV = [
            22,
            86,
            118, // CTRL+V
        ];

        switch ($(this).data('allowed-type')) {
            case 'integros':
                // валидация номера заказа Integros при трэкинге (пример: CV123456789DE)
                var inputValue = $(this).val().toLowerCase();
                var inputValueLength = inputValue.length;
                var inputChar = c.toLowerCase();

                if (inputValue.substr(0, 1) == 'c' || (inputValueLength == 0 && inputChar == 'c')){
                    // валидация только keypress, keyup пропускаем
                    if (e.type == 'keyup') {
                        return true;
                    }
                    // принимать нажатия служебных кнопок
                    if (jQuery.inArray(a, serviceButtonsCode) != -1) {
                        return true;
                    }
                    // второй символ должен быть 'v'
                    if (inputValueLength == 1 && inputChar != 'v') return false;
                    // не принимать пробел
                    if (inputChar == ' ') return false;
                    // ограничение по длине
                    return (inputValueLength < 13);

                    // валидация обычного номера заказа (integer)
                } else {
                    C = /[0-9]/;
                }
                break;

            case 'alphanumeric':
                C = /[0-9a-zA-Z_-]/;
                break;
            case 'int':
                C = /[0-9]/;
                break;
            case 'int-zero':
                C = /[0-9]/;

                if (($(this).val().substr(0, 1) == "0")) {
                    $(this).val($(this).val().substring(1));
                    $(this).keyup();
                }

                break;
            case 'float':
                C = /[0-9\.,]/;

                $(this).val($(this).val().replace(/,+/g, '.'));

                if (($(this).val().substr(0, 1) == ".")) {
                    $(this).val($(this).val().substring(1));
                    $(this).keyup();
                    break;
                }

                if ((pointPos = $(this).val().indexOf(".")) > -1) {
                    var value = $(this).val().replace(/\.+/g, '');
                    $(this).val(value.substring(0,pointPos) + '.' + value.substring(pointPos));
                    $(this).trigger('my.change');
                }
                break;
            case 'float-zero':
                C = /[0-9\.,]/;

                if(e.type == 'keyup')
                {
                    if($.inArray(a, serviceButtonsCode) != -1)
                    {
                        return;
                    }
                    $(this).val($(this).val().replace(/,+/g, '.'));
                }


//                if (($(this).val().substr(0, 1) == "0" || $(this).val().substr(0, 1) == ".")) {
//                    $(this).val($(this).val().substring(1));
//                    $(this).keyup();
//                    break;
//                }

                if ($(this).val().substr(0, 1) == ".") {
                    $(this).val($(this).val().substring(1));
                    $(this).keyup();
                    break;
                }

                if ((pointPos = $(this).val().indexOf(".")) > -1) {
                    var value = $(this).val().replace(/\.+/g, '');
                    $(this).val(value.substring(0,pointPos) + '.' + value.substring(pointPos));
                    $(this).trigger('my.change');
                }
                break;
            case 'domain':
                C = /[0-9A-Za-zА-Яа-я.-]/;

                if ($(this).val().length > 63) return false;

                break;
            case 'text':
                C = /[^0-9]/;

                if ($(this).val().length > 63) return false;

                break;

            case 'cyrillic':
                C = /[а-я\s\-ёєії]/i;
                if ($(this).val().length > 63) return false;
                break;

            case 'name':
                C = /[\da-zа-я\s\-ёєії'"]/i;
                break;

            case 'phone':
                C = /[0-9]/;
                break;
            case 'floor':
                C = /[\-\d]/;

                var val = $(this).val();
                var res = val.match(/^-?[\d]*/g);
                val = res ? res[0] : '';
                if(val > 99) {
                    val = '99';
                } else if (val < -99) {
                    val = '-99';
                }
                $(this).val(val);

                if (val.substr(0, 1) == "0") {
                    $(this).val(val.substring(1));
                    $(this).keyup();
                }
                break;

            default:
                C = /[0-9]/;
                break;
        }

        var isCtrlV = $.inArray(a, arV) != -1  && e.ctrlKey;

        return !!($.inArray(a, serviceButtonsCode) != -1 || c.match(C) || isCtrlV);
    });

    $('body').on('change my.change', '.allowed-char', function(e){
        var pointPos;
        switch ($(this).data('allowed-type')) {
            case 'integros':
                $(this).val($(this).val().replace(/\s+/g, ''));
                if ($.trim($(this).val()).toLowerCase().substr(0,1) != 'c') {
                    $(this).val($(this).val().replace(/[^0-9]+/g, ''));
                }
                break;
            case 'alphanumeric':
                $(this).val($(this).val().replace(/[^0-9a-zA-Z_-]+/g, ''));
                break;
            case 'int':
                $(this).val($(this).val().replace(/[^0-9]+/g, ''));
                break;
            case 'int-zero':
                $(this).val($(this).val().replace(/[^0-9]+/g, ''));

                if (($(this).val().substr(0, 1) == "0")) {
                    $(this).val($(this).val().substring(1));
                    $(this).trigger('my.change');
                }
                break;
            case 'float':
                $(this).val($(this).val().replace(/,+/g, '.'));
                $(this).val($(this).val().replace(/[^0-9\.]/g, ''));

                if (($(this).val().substr(0, 1) == ".")) {
                    $(this).val($(this).val().substring(1));
                    $(this).trigger('my.change');
                    break;
                }

                if ((pointPos = $(this).val().indexOf(".")) > -1) {
                    var value = $(this).val().replace(/\.+/g, '');
                    $(this).val(value.substring(0,pointPos) + '.' + value.substring(pointPos));
                    break;
                }
            case 'float-zero':
                $(this).val($(this).val().replace(/,+/g, '.'));
                $(this).val($(this).val().replace(/[^0-9\.]+/g, ''));
//                if (($(this).val().substr(0, 1) == "0" || $(this).val().substr(0, 1) == ".")) {
//                    $(this).val($(this).val().substring(1));
//                    $(this).trigger('my.change');
//                    break;
//                }
                if (($(this).val() == "0" || $(this).val().substr(0, 1) == ".")) {
                    $(this).val($(this).val().substring(1));
                    $(this).trigger('my.change');
                    break;
                }

                if ((pointPos = $(this).val().indexOf(".")) > -1) {
                    var value = $(this).val().replace(/\.+/g, '');
                    $(this).val(value.substring(0,pointPos) + '.' + value.substring(pointPos));
                }
                break;
            case 'domain':
                $(this).val($(this).val().replace(/[^0-9A-Za-zА-Яа-я\.-]+/g, ''));
                break;
            case 'text':
                $(this).val($(this).val().replace(/[0-9]+/g, ''));
                break;
            case 'cyrillic':
                $(this).val($(this).val().replace(/[^а-я\s\-ёєії]+/i, ''));
                break;
            case 'name':
                $(this).val($(this).val().replace(/[^\da-zа-я\s\-ёєії'"]+/i, ''));
                break;
            case 'phone':
                $(this).val($(this).val().replace(/[^0-9]+/g, ''));
                break;
            case 'floor':
                var val = $(this).val();
                var res = val.match(/^-?[\d]+/g);
                val = res ? res[0] : '';
                if(val > 99) {
                    val = 99;
                } else if (val < -99) {
                    val = -99;
                }
                $(this).val(val);
                break;
            default:
                $(this).val($(this).val().replace(/[^0-9]+/g, ''));
                break;
        }
    });
    $('form[action="log.php"]').attr('action', '');

    $(".offices_wrap .offices tbody tr:last, .text table tbody tr:last").addClass("last");


//    $(".offices_wrap .offices td, .text table td").not(".hover").hover(function(e) {
//        $(".offices_wrap .offices td.hover").removeClass("hover");
//        var c =  $(this).index();
//        if ($(this).parents(".offices_wrap").hasClass("red")) {
//            if ($(this).parents("tbody").length) $(this).siblings("td").addClass("hover");
//        } else {
//            $(".offices_wrap .offices tr, .text table tr").each(function(i) {
//                $(this).find("td").eq(c).addClass("hover");
//            });
//        }
//
//    }, function() {
//        $(".offices_wrap .offices td.hover, .text table td.hover").removeClass("hover");
//    })


    $(".aux .print").click(function(e) {
        e.preventDefault();
        window.print();
    });

    $(".download_online_order a").click(function(e){
        e.preventDefault();
        var link=$(this).attr('href');
        var form=$(this).closest('form');
        form.attr('action',link);
        form.submit();
    });




    if ($(".form_wrap .register").length) {
        $(".form_wrap .register .reg_with li").click(function(e) {
            e.preventDefault();
            $(this).siblings().removeClass("selected");
            $(this)
                .addClass("selected")
                .find("input:radio").attr("checked", "checked");
        });
    }



    $(".select.region .list li").click(function() {

        var new_val = $(this).data("value");

        var cityObj = $(this).parents(".filter").find(".select.city");

        cityObj.attr("data-region", new_val);

        var first_val = cityObj.find(".list li.c" + new_val).eq(0).text();

        cityObj.find(".option_select").text( first_val );
        cityObj.find("input").val( first_val );
    });

    $(".select.agent_type ul li").click(function() {
        var val = $(this).attr("data-value");
        if (val == "1") {

            $(this).parents(".i").next(".company")
                .addClass("hide")
                .find("input").attr("data-validate", "full");
            validate_ini();
        } else if (val == "2") {
            $(this).parents(".i").next(".company")
                .removeClass("hide")
                .find("input").attr("data-validate", "full");
            validate_ini();
        }

    });

    $('#sundayFilter').on('click', function(){
        WarehouseFilter.applyFilter();
    });

    $('#nowFilter').on('click', function(){
        WarehouseFilter.applyFilter();
    });

    $('#selfServiceFilter').on('click', function(){
        WarehouseFilter.applyFilter();
    });

    $('#searchFilter').on('click', function(){
        $('.postomat-radio-buttons .radiobutton_warehouse').trigger('click');
    });

    $('#oSearchFilter').on('click', function(){
        $('.postomat-radio-buttons .radiobutton_warehouse').trigger('click');
    });

    $("#search_bar [name=w_type]").change(function(e, preventClearOffices) {
        WarehouseFilter.applyFilter();
        $('#wareId').val('');
        if (!preventClearOffices) { $(".offices_num").val(''); }
    });

    //$('.offices_wrap table tbody tr[data-warehouse-type!="postomat"]').addClass('hide');

    $('.postomat-radio-buttons input[type="radio"]').click(function(e, preventClearOffices) {
        WarehouseFilter.applyFilter();
        if (!preventClearOffices) { $(".offices_num").val(''); }

        var legendClass;
        $('.d_offices li').hide();

        if ($(this).val() == 'store') {
            legendClass = 'legend-warehouse';
            $('.d_offices li').hide();
            $('.d_offices li.Store').show();
            $('#i_Office_num_label').text($('#i_Office_num_label').data('warehouse'));
        } else if ($(this).val() == 'postomat') {
            legendClass = 'legend-postomat';
            $('.d_offices li.p').show();
            $('#i_Office_num_label').text($('#i_Office_num_label').data('postomat'));
        } else {
            legendClass = 'legend-warehouse';
            $('.d_offices li').not('.p').show();
            $('#i_Office_num_label').text($('#i_Office_num_label').data('warehouse'));
        }

        setMapLegend(legendClass);
    });

    $('.postomat-radio-buttons input[type="radio"]:checked').trigger('click');

    $("#vote-proceed").click(function(e){
        e.preventDefault();
        var poll_id=$(this).data('poll');
        var vote_id=$(this).closest('form').find('input:checked').val();
        if (!vote_id) return false;
        voteProceed(poll_id,vote_id);
    });


    $(".map_link").click(function(e){
        e.preventDefault();

        var t = $(this);
        var form = t.closest('form');
        var data = {};
        var city = form.find('#i_City').val();

        data.ll = $('#latlng').val();
        data.wareid = form.find('#wareId').val();

        data.type = form.find("[name=type]:checked").val();
        if(data.type == 'warehouse') {
            data.type = '';
        }

        if(data.type == 'warehouse') {
            data.typedepartment = form.find("[name=w_type]").val();
            if(data.typedepartment == 0) {
                data.typedepartment = '';
            }
        }

        data.query = $("#address").focus().val();

        var params = [];

        for (var a in data) {
            if (data[a]!=='' && typeof data[a] != 'undefined') {
                params.push(a+'='+data[a]);
            }
        }


        var link = $(this).data('action');
        if(city) {
            link+='/city/'+city;
        }
        if(params.length > 0) {
            link+='?'+params.join('&');
        }

        location.href = appParameters.languageUrl+link;
    });

    // feedBack
    $(".popup_feedback_message").click(function(e) {
        $('.feedback_message').hide();
        $('.feedback_message_form').css('display', 'block');
        $('#FeedbackMessageForm_textMessage').val('');
    });

    $(".popup_feedback_form_close").click(function(e){
        $('.feedback_message_form').css('display', 'none');
        $('.feedback_message').show();
    });

    $("#feedbackMessageBtnOk").click(function(e){
        var dataText = $('#FeedbackMessageForm_textMessage').val();

        $('.feedback_message').show();
        $('.feedback_message_form').css('display', 'none');

        if(dataText == ''){
            return false;
        }

        var $feedback_message_answer = $('.feedback_message_answer');

        $feedback_message_answer.css('display', 'block');
        $feedback_message_answer.click(function(){$feedback_message_answer.css('display', 'none');})
        setInterval(function(){$feedback_message_answer.css('display', 'none');}, 5000);
    });

    // end feedBack

    $('.set_focus').focus();

    //$();

    $(document).on('click', '#showDetailedService', function (e) {
        if($('#detailedService').hasClass('hide')) {
            $('#detailedService').removeClass('hide');
        } else {
            $('#detailedService').addClass('hide');
        }
        e.preventDefault();
        e.stopPropagation();
    });

    $(document).on('click', '#showDetailedBackDelivery', function (e) {
        if($('#detailedBackDelivery').hasClass('hide')) {
            $('#detailedBackDelivery').removeClass('hide');
        } else {
            $('#detailedBackDelivery').addClass('hide');
        }
        e.preventDefault();
        e.stopPropagation();
    });
});

$(window).ready(function(e) {
    var filter_class = '';
    accordion();
    topMenu();
    $("#slider_block .slider").slider({delay: 6000});
    equalHeight();
//    popOpen('help');

    $(".sliders .slider").slider({delay: 5000, fade:1000});

//    $(".b_tooltip.m_discs_tyres .b_tooltip_body .b_discs").removeClass("hide").siblings(".b_palets").addClass("hide");

//	$(".form_wrap .pallets_discs .dropdown li").click(function() {
//		$(".b_tooltip.m_discs_tyres .b_tooltip_body .bottom .m_cancel").click();
//		if ($(this).data("value") == "1") {
//			$(".b_tooltip.m_discs_tyres .b_tooltip_body .b_discs").removeClass("hide").siblings(".b_palets").addClass("hide");
//			$(".b_tooltip.m_discs_tyres > i").show().mouseenter();
//		} else if ($(this).data("value") == "2") {
//			$(".b_tooltip.m_discs_tyres .b_tooltip_body .b_palets").removeClass("hide").siblings(".b_discs").addClass("hide");
//			$(".b_tooltip.m_discs_tyres > i").show().mouseenter();
//		} else {
//			$(".b_tooltip.m_discs_tyres > i").hide();
//		}
//	})

    $(".b_tooltip.m_discs_tyres .b_tooltip_body").each(function() {
        var obj = $(this);

        obj.find(".bottom .btn.check").click(function(e) {
            obj.find("[data-validate]").blur();

            var valid = false;
            obj.find('input[type="text"]').each(function(){
                if (($(this).val() != '' || $(this).val() != "") && ($(this).siblings(':checkbox:checked').length)) {
                    valid = true;
                }
            });
            if (!valid) {
                if (!obj.find('.e_block .err_string').length) {
                    obj.find('.e_block').append('<div class="err_string"><span>' + $translate.mustFill[currentLang] + '</span></div>');
                }
                return false;
            } else {
                obj.find('.e_block .err_string').remove();
            }

            if (obj.find(".error").length) return;

            var str = '';

            obj.find(".e_block:visible .list.check li").each(function(i) {
                if ($(this).find("input:checkbox:checked").length) {
                    if (str != '') str += ', ';
                    str += $(this).find("label").text() + ": " + parseInt($(this).find("input:text").val()) + " шт.";
                }
            })
            obj.parents("form").find(".i_Add_info").val(str).attr("disabled", "disabled");

            close();

        })

        obj.find(".bottom .m_clear").click(function(e) {
            e.preventDefault();

            obj.find("input:checkbox").attr("checked", "checked").click();
            obj.parents("form").find(".i_Add_info").val('').removeAttr("disabled");

        })
        obj.find(".bottom .m_cancel").click(function(e) {
            obj.find(".bottom .m_clear").click();
            close();
        })

        $('body').on('click','.popup_mask', function(e) {
            close();
        })

        function close() {
            $(".popup_mask").fadeOut();
            obj.fadeOut("fast", function() {
                $(".tp_over_mask").removeClass("tp_over_mask");
                obj.parents('.b_tooltip').removeClass("active");
            });

            obj.find('.e_block .err_string').remove();
        }
    })

    if ($(".order.order_list").length) {
        $(".form_wrap .redel_block [data-validate]").addClass("opt");

        $(".list.redelivery input:checkbox").change(function(e) {
            if ($(this).attr("checked") == "checked") {
                $(this).parents(".i").siblings(".redel_block")
                    .removeClass("hide")
                    .find("[data-validate]").removeClass("opt");

            } else {
                $(this).parents(".i").siblings(".redel_block")
                    .addClass("hide")
                    .find("[data-validate]").addClass("opt");
            }

        });


        $(".form_wrap .select.redel_type .dropdown li").click(function() {

            if ($(this).data("value") == "3") {
                $(this).parents(".select").siblings(".b_tooltip").children("i").css("display", "block").mouseenter();
            } else {
                $(this).parents(".select").siblings(".b_tooltip").children("i").hide();
            }

            /*
             var i = $(this).index();
             var i2 =  $(".form_wrap .select.redel_type_2 .dropdown li.active").index();
             */

            var i = $(this).attr("data-value");
            var i2 =  $(".form_wrap .select.redel_type_2 .dropdown li[data-value='" + i + "']");

            i2.hide().siblings().show();

            if ($(".form_wrap .select.redel_type_2 .dropdown li.active").attr("data-value") == i) {

                $(".form_wrap .select.redel_type_2 .dropdown li.active").removeClass("active")
                    .parents(".select").find(".option_select").text('').siblings("input").val('');
            }

            if ( i == 3) {// pallettes
                i2.parents(".select").siblings(".b_tooltip").children("i").hide();
            }

            /*
             if ( i == 0 ) {
             // first value equal in both
             $(".form_wrap .select.redel_type_2 .dropdown li:first").hide().siblings().show();
             if ( i2 == i ) {
             $(".form_wrap .select.redel_type_2 .option_select").text('').siblings("input").val('')
             .parents(".select").siblings(".b_tooltip").children("i").hide();
             }
             } else if (i == 1) {
             $(".form_wrap .select.redel_type_2 .dropdown li").show();
             } else {
             // if not first, then second index - 1
             $(".form_wrap .select.redel_type_2 .dropdown li").eq(i-1).hide().siblings().show();
             if ( i2 == i+1 ) {
             $(".form_wrap .select.redel_type_2 .option_select").text('').siblings("input").val('')
             .parents(".select").siblings(".b_tooltip").children("i").hide();
             }
             }
             */


        })

        $(".form_wrap .select.redel_type_2 .dropdown li").click(function() {

            if ($(this).data("value") == "3") {
                $(this).parents(".select").siblings(".b_tooltip").children("i").css("display", "block").mouseenter();
            } else {
                $(this).parents(".select").siblings(".b_tooltip").children("i").hide();
            }


            var i = $(this).attr("data-value");
            var i2 =  $(".form_wrap .select.redel_type .dropdown li[data-value='" + i + "']");

            i2.hide().siblings().show();

            if ($(".form_wrap .select.redel_type .dropdown li.active").attr("data-value") == i) {
                $(".form_wrap .select.redel_type .dropdown li.active").removeClass("active")
                    .parents(".select").find(".option_select").text('').siblings("input").val('');
            }

            if ( i == 3) {// pallettes
                i2.parents(".select").siblings(".b_tooltip").children("i").hide();
            }


            /*
             var i = $(this).index();
             var i2 =  $(".form_wrap .select.redel_type .dropdown li.active").index();


             if ( i == 0 ) {
             // first value equal in both
             $(".form_wrap .select.redel_type .dropdown li:first").hide().siblings().show();
             if ( i2 == i ) {
             $(".form_wrap .select.redel_type .option_select").text('').siblings("input").val('')
             .parents(".select").siblings(".b_tooltip").children("i").hide();
             }
             } else {
             // if not first, then second index - 1
             $(".form_wrap .select.redel_type .dropdown li").eq(i+1).hide().siblings().show();
             if ( i2 == i-1 ) {
             $(".form_wrap .select.redel_type .option_select").text('').siblings("input").val('')
             .parents(".select").siblings(".b_tooltip").children("i").hide();
             }
             }
             */

        })




        $(".b_tooltip.m_pallets .b_tooltip_body").each(function() {
            var obj = $(this);


            obj.find(".bottom .btn.close").click(function(e) {

//                console.log("a");
                obj.find("[data-validate]").blur();

                if (obj.find(".error").length) return;

                /*
                 var str = '';

                 obj.find(".e_block:visible .list.check li").each(function(i) {
                 if ($(this).find("input:checkbox:checked").length) {
                 if (str != '') str += ', ';
                 str += $(this).find("label").text() + ": " + parseInt($(this).find("input:text").val()) + " шт.";
                 }
                 })
                 obj.parents("form").find(".i_Add_info").val(str).attr("disabled", "disabled");
                 */

            })

            obj.find(".bottom .m_clear").click(function(e) {
                e.preventDefault();

                obj.find("input:checkbox").attr("checked", "checked").click();
                obj.parents("form").find(".i_Add_info").val('').removeAttr("disabled");

            })
            obj.find(".bottom .m_cancel").click(function(e) {
                obj.find(".bottom .m_clear").click();
                obj.find(".bottom .btn.close").click();
            })


        });


        $(".form_wrap .redel_block [data-validate]").addClass("opt");

        $(".list.redelivery input:checkbox").change(function(e) {
            if ($(this).attr("checked") == "checked") {
                $(this).parents(".i").siblings(".redel_block")
                    .removeClass("hide")
                    .find("[data-validate]").removeClass("opt");

            } else {
                $(this).parents(".i").siblings(".redel_block")
                    .addClass("hide")
                    .find("[data-validate]").addClass("opt");
            }

        })


    }

    $("ul.map-target li").on('click',function(){

    });

    $('.spoiler-int').click(function(){
        $(this).closest('table').find('.spoiler-content').slideToggle();

        $(this).closest('table').css('width', $(this).closest('table').width());
    });

    Timetable.init();
    TimeInterval.init();
});

var WarehouseFilter = {
    map: null,
    modeList: 'list',
    modeMap: 'map',
    getFilter: function() {
        var filter = {};
        filter.warehouseCategory = $('.postomat-radio-buttons input[type="radio"]:checked').val();
        if (['store', 'postomat'].indexOf(filter.warehouseCategory) == -1) {
            filter.warehouseType = $('#search_bar [name=w_type]').val();
        }
        filter.sunday = $('#sundayFilter').prop("checked") ? 1 : 0;
        filter.selfService = $('#selfServiceFilter').prop("checked") ? 1 : 0;
        filter.now = $('#nowFilter').prop("checked") ? 1 : 0;

        return filter;
    },
    applyFilter: function() {
        var search = $('#header.map .search_map #address').val();
        if (search) {
            $('#header.map ul.results').html('<li class="autoload ymaps-event">' + search + '</li>').find('li').trigger('click');

            return;
        }

        var filter = this.getFilter();

        $('.offices_wrap table tbody tr').removeClass('hide');
        if (filter.warehouseCategory == 'store') {
            $('.offices_wrap table tbody tr[data-warehouse-category!="Store"]').addClass('hide');
        } else if (filter.warehouseCategory == 'postomat') {
            $('.offices_wrap table tbody tr[data-warehouse-type!="postomat"]').addClass('hide');
        } else {
            if (filter.warehouseType != 0) {
                $('.offices_wrap table tbody tr[data-warehouse-type!="' + filter.warehouseType + '"]').addClass('hide');
            }
        }

        if (filter.sunday) {
            $('.offices_wrap table tbody tr[data-sunday!="1"]').addClass('hide');
        }

        if (filter.selfService) {
            $('.offices_wrap table tbody tr[data-selfService!="1"]').addClass('hide');
        }

        $(".offices_wrap table tbody tr:visible").each(function(i) {
            if (!((i+1)%2)) {
                $(this).addClass("even");
            } else {
                $(this).removeClass("even");
            }
        });
    }
};

var Timetable = {
    init: function(){
        // График работы отделений
        $('#NovaPoshtaFiltersForm_department, #NovaPoshtaFiltersForm_schedule, input[name="NovaPoshtaFiltersForm[type]"]').on('change', function(e){
            if(e.target.id == 'NovaPoshtaFiltersForm_department') {
                $('input[name="NovaPoshtaFiltersForm[type]"][value=warehouse]').attr('checked', 'checked');
            }

            Timetable.handleClick();
            $('#select-city').hide();
            $('#NovaPoshtaFiltersForm_warehouse').val('');
        });

        $('#NovaPoshtaFiltersForm_city').on('change', function(e, data){
            if (typeof data == 'object' && data.fromList) {
                Timetable.handleClick();
                $('#select-city').hide();
                $('#NovaPoshtaFiltersForm_warehouse').val('');
            }
        });

        $('#NovaPoshtaFiltersForm_warehouse').on('change', function(e, data){
            if (typeof data == 'object' && data.fromList) {
                $('#timetable-warehouses tr').hide();
                $('#timetable-warehouses tr#'+$('#NovaPoshtaFiltersForm_warehouse_ul li.active').data('ref')).show();
            }
        });

        $(document).on('click', '.js-pager a', function(e){
            var onPage = 100;
            e.preventDefault();

            var page = $(this).text();

            var start = (page - 1) * onPage;
            var end = page * onPage;

            Timetable.filterWarehouses();

            if(page > 1) {
                $('table.offices tbody tr:visible').filter(':gt('+(start - 1)+'):lt('+(end - 1)+')').show();
            } else {
                $('table.offices tbody tr:visible').filter(':lt('+end+')').show();
            }

            $('table.offices tbody tr:visible:lt('+start+'), table.offices tbody tr:visible:gt('+(end - 1)+')').hide();


            $('.yiiPager .selected').removeClass('selected');
            $(this).closest('li').addClass('selected');

            $('html, body').animate({
                scrollTop: $("div.offices").offset().top
            }, 350);

            $('#NovaPoshtaFiltersForm_warehouse').val('');
        });

        $('form.offices').submit(function(){
            $('#NovaPoshtaFiltersForm_department, #NovaPoshtaFiltersForm_schedule, input[name="NovaPoshtaFiltersForm[type]"]').attr('disabled', 'disabled');
        });
    },
    handleClick: function(){
        $('.progress').show();
        // if(typeof Timetable.arWarehouses == 'undefined'){
        //     Timetable.load({
        //         ready: function(){
        //             Timetable.doFilter();
        //         }
        //     });
        // }else{
        //     Timetable.doFilter();
        // }
        // всегда запускаем загрузку, потому что у нас теперь не список всех складов. а только по одному городу.
        // а там надеемся на кеш в локал сторадже.
        Timetable.load({
            ready: function(){
                Timetable.doFilter();
            }
        });
    },

    initHistoryApi: function(){
        if(history.pushState) {
            // initial page replace
            history.replaceState({city: $("#NovaPoshtaFiltersForm_city_ul li.active").text()}, $('title'), location.href);

            // Event listener to capture when user pressing the back and forward buttons within the browser.
            window.addEventListener("popstate", function(e) {
                // оказывается кто-то еще использует дремучий хром :)
                // @todo старая версия jquery неправильно определяет версию браузера
                // @todo проверить на сафари и старой версии хрома без этого блока
                if(
                    ($.browser.webkit && parseFloat($.browser.version) < 537.36)
                    || $.browser.safari
                ) {
                    if(!appParameters.historyReady) {
                        return;
                    }
                }

                // fix #hash
                if(e.state) {
                    var new_title = e.state.city+appParameters.tr_title;
                    $('title').text(new_title);
                    if(e.state.city) {
                        $("#NovaPoshtaFiltersForm_city_ul li:contains("+e.state.city+")").trigger('click', {nopush: 1});
                    } else {
                        $('.clear_btn').trigger('click', {nopush: 1});
                    }
                }
            });

            $(document).on('change', '#NovaPoshtaFiltersForm_city', function(e, data){
                if(
                    1
                    && typeof data !== 'undefined'
                    && data.fromList
                    && typeof data.nopush == 'undefined'
                ) {
                    // Для дремучего хрома
                    appParameters.historyReady = true;
                    var city = $(this).val();
                    var new_url = city ? appParameters.url+'/city/'+city : appParameters.url;
                    var new_title = city+appParameters.tr_title;
                    $('title').text(new_title);
                    history.pushState({city: city}, new_title, new_url);
                    NovaPoshta.trackAnalitycs(new_url);
                }
            });
        }
    },

    makeFilter: function()
    {
        filter_class = {};

        if(typeof Timetable.arWarehouses == 'undefined') {
            return filter_class;
        }

        if($('#NovaPoshtaFiltersForm_city_ul li.active').data('ref')) {
            filter_class.city = $('#NovaPoshtaFiltersForm_city_ul li.active').data('ref');
        } else {
            return filter_class;
        }

        if($('input[name="NovaPoshtaFiltersForm[type]"]:checked').val() == 'warehouse') {
            if($('#NovaPoshtaFiltersForm_department').val() != '0') {
                filter_class.type = $('#NovaPoshtaFiltersForm_department').val();
            } else {
                filter_class.type = 'warehouse';
            }
        } else if ($('input[name="NovaPoshtaFiltersForm[type]"]:checked').val() == 'postomat') {
            filter_class.type = 'postomat';
        } else if ($('input[name="NovaPoshtaFiltersForm[type]"]:checked').val() == 'store') {
            filter_class.type = 'store';
        } else {
            filter_class.type = 'all';
        }

        if($('#NovaPoshtaFiltersForm_schedule').val() != '0') {
            filter_class.time = $('#NovaPoshtaFiltersForm_schedule').val();
        }

        return filter_class;
    },

    scheduleHolidaysFlags: function()
    {
        $.ajax({
            type: 'GET',
            url: "/timetable/GetScheduleHolidaysFlags/cityRef/"+filter_class.city,
            dataType: 'json',
            success: function (data) {
                $.each(data, function(k, wa) {
                    $('#'+k+' .col2 a').addClass( "tooltip attention" );
                    $('#'+k+' .col2 a').prepend('' +
                        '<span class="tooltiptext">' +
                        mess.holidays_tooltip +
                        '</span>');
                });
            }
        });

    },

    filterWarehouses: function()
    {
        filter_class = Timetable.makeFilter();

        if(Object.keys(filter_class).length) {
            Timetable.scheduleHolidaysFlags();
            $('#timetable-warehouses').html('');

            var spanClass;
            var weight;
            var cityName;
            var adress;
            var urlText;
            var row;
            var html;
            var warehouseFilterLis = '';
            $.each(Timetable.arWarehouses, function(k, warehouse){
                if(filter_class.city != warehouse['cityRef']) {
                    return;
                }
                if(typeof filter_class.type != 'undefined') {
                    var isTypeNotEqual = false;
                    if (filter_class.type === 'all') {
                        isTypeNotEqual = false;
                    } else if (filter_class.type === 'warehouse') {
                        isTypeNotEqual = 'postomat' === warehouse['type'];
                    } else if (filter_class.type === 'store') {
                        isTypeNotEqual = 'Store' !== warehouse['category'];
                    } else {
                        isTypeNotEqual = filter_class.type != warehouse['type'];
                    }
                    var hasTimeFilter = typeof filter_class.time != 'undefined';
                    var isTimeNotEqual = $.inArray(filter_class.time, warehouse['time']) == -1;
                    if(isTypeNotEqual || (hasTimeFilter && isTimeNotEqual)) {
                        return;
                    }
                }
                if(typeof filter_class.time != 'undefined') {
                    if(jQuery.inArray(filter_class.time, warehouse['time']) == -1){
                        return;
                    }
                }

                spanClass = 'weight_l m_';
                if (warehouse["maxWeightAllowed"] != "0"){
                    spanClass+=1;
                } else {
                    spanClass+=2;
                }
                weight = warehouse["maxWeightAllowed"] != "0" ? 'До '+warehouse["maxWeightAllowed"]+' кг' : 'Без обмежень';

                if(currentLang == 'ru') {
                    cityName = warehouse['city_ru'];
                    adress = warehouse["address_ru"];
                } else {
                    cityName = warehouse['city_uk'];
                    adress = warehouse["address_uk"];
                }

                urlText = '';
                if(warehouse['address_url']) {
                    urlText = '<a href="'+appParameters.languageUrl+warehouse['address_url']+cityName+'"><span>'+adress+'</span></a>';
                }

                row =
                    '<tr id ='+warehouse['ref']+'>'
                        +'<td class="col1 city first mainCity"><span class="name">'+cityName+'</span></td>'
                        +'<td class="col2">'+urlText+'</td>'
                        +'<td class="col3 phone">'
                            +'<span class="'+spanClass+'" >' + weight + '</span>'
                        +'</td>'
                        +'<td class="col4 time time_popup popcent" style="padding-left:10px;">'+Timetable.getSchedule(warehouse)+'</td>'
                        +'<td class="col5 time time_popup popcent" style="padding-left:20px;">'+Timetable.getReceptionSchedule(warehouse)+'</td>'
                        +'<td class="col6 time last time_popup popcent" style="padding-left:11px;">'+Timetable.getDeliverySchedule(warehouse)+'</td>'
                    +'</tr>';
                html += row;

                warehouseFilterLi =
                    '<li data-ref="' + warehouse['ref']
                        + '"><span>' + adress
                    +'</span></li>';

                warehouseFilterLis += warehouseFilterLi;
            });

            $('#timetable-warehouses').append(html);
            $('#NovaPoshtaFiltersForm_warehouse_ul').html(warehouseFilterLis);
        }
    },

    makePagination: function()
    {
        var onPage = 100;
        var $els = $('table.offices-js-navigation tbody tr:visible');
        var page = Math.floor($els.length / onPage) + 1;
        var $pager = $('.yiiPagerTimeTable');
        $pager.html('');
        $pager.hide();

        if(page == 1) {
            return;
        }

        $pager.show();

        $els.filter(':gt('+(onPage-1)+')').hide();

        for(var i=1; i <= page; i++){
            $pager.append('<li class="page" ><a href="#page-'+i+'">'+i+'</a></li>');
        }

        $pager.find('li:first').addClass('selected');
    },

    doFilter: function()
    {
        Timetable.filterWarehouses();

        // пересчет пагинации
        Timetable.makePagination();

        // Убираем прогресс-бар
        $('.progress').hide();

        // Найдено - не найдено
        $('#empty-result').toggle($('table.offices-js-navigation tbody tr:visible').length == 0);
    },

    load: function(params)
    {
        $('#NovaPoshtaFiltersForm_city').attr('disabled', 'disabled');
        var selectedWarehouse = $('#NovaPoshtaFiltersForm_city_ul li.active').data('ref');
        if(isEnableStorage() && 1){
            var key = 'timetable' + selectedWarehouse;
            var key_time = key + '-time';
            var time = Math.round(new Date().getTime() / 1000);
            if (typeof window.localStorage[key] == 'undefined' || time > parseInt(window.localStorage[key_time]) + 86400 || time < parseInt(window.localStorage[key_time]) - 86400) {
                $.ajax({
                    type: 'GET',
                    url: "/timetable/GetJsonWarehouseList/ref/" + selectedWarehouse,
                    dataType: 'json',
                    success: function (data) {
                        Timetable.arWarehouses = data.warehouses;
                        $('#NovaPoshtaFiltersForm_city').attr('disabled', false);
                        params.ready();

                        try{
                            window.localStorage[key_time] = time;
                            window.localStorage[key] = JSON.stringify(data.warehouses);
                        } catch(e) {
                            //console.log(e);
                        }
                    }
                });
            } else {
                Timetable.arWarehouses = JSON.parse(window.localStorage[key]);
                $('#NovaPoshtaFiltersForm_city').attr('disabled', false);
                params.ready();
            }
        } else {
            $.ajax({
                type: 'GET',
                url: "/timetable/GetJsonWarehouseList/ref/" + selectedWarehouse,
                dataType: 'json',
                success: function (data) {
                    Timetable.arWarehouses = data.warehouses;
                    $('#NovaPoshtaFiltersForm_city').attr('disabled', false);
                    params.ready();
                }
            });
        }
    },

    getSchedule: function (data)
    {
        if (data['time'] == 'h24') {
            var html;
            html = '<div class="b_tooltip col4_time_popup"><i class="">';
            html += Timetable.getRenderedList(data['Schedule'], '');

            html += '</i><div style="display: none;" class="b_tooltip_body m_right"><div class="text">'+ mess.CARD_PRIVAT+'</div></div>';

            return html;
        }

        return Timetable.getRenderedList(data, 'Schedule');
    },

    getReceptionSchedule: function (data)
    {
        var str;
        var type = 'Reception';
        $.each(data[type], function(day, time){
            if (time != '-') {
                str = time.split('-');
                data[type][day] = str[0];
            }
        });

        return Timetable.getRenderedList(data, type);
    },

    getDeliverySchedule: function (data)
    {
        var str;
        var type = 'Delivery';
        $.each(data[type], function(day, time){
            if (time != '-') {
                str = time.split('-');
                if(str[1]) {
                    data[type][day] = str[1];
                }
            }
        });

        return Timetable.getRenderedList(data, type);
    },

    getRenderedList: function (data, type)
    {
        var config = {Reception: 'FROM', Delivery: 'TO'};
        var prefix = config[type];
        var html;
        html='<div class="pop"><ins></ins><ul>';
        $.each(data[type], function(day, time){
            if (day == 'Monday' && time == '00:01-23:59') {
                html += '<li style="text-align: center;"><span style="color: #f23c32;">' + mess.H24 + '</span></li>';
            }
            html += '<li><span class="day">' + mess[day] + ':</span>';
            if (
                time == '-'
                && (type == 'Schedule' || data['Schedule'][day] == '-')
            ) {
                html += ' ' + mess.WEEKEND + '</li>';
            } else {
                html += ' ' + (prefix != undefined && time != '-' ? mess[prefix] + ' ' : ' ') + time+ '</li>';
            }
        });
        html += '</ul></div>';

        return html;
    }
}

/*Временные интервалы*/
var TimeInterval = {
    back: '',
    init: function() {
        TimeInterval.handleCityClick();
        TimeInterval.handleDayClick();
        TimeInterval.handleTimeIntervalClick();
        TimeInterval.handleOpenWeek();
        TimeInterval.handleClickTab();
    },

    handleCityClick: function() {
        $('#Center_city').on('change', function(e, data){
            var val = $(this).val();
            if(!val) {
                if(TimeInterval.back) {
                    $('table.offices tbody').html(TimeInterval.back);
                    $('.yiiPager').show();
                }

                $('ul.list.day').find('li:first-child').trigger('click');

                $('.timeinterval-select-day').addClass('hide');
                $('.timeinterval-select-day-fake').removeClass('hide');

                return;
            }

            if (typeof data == 'object' && data.fromList)
            {
                $('.progress').show();

                $.ajax({
                    type: 'GET',
                    url: window.appParameters.languageUrl + "/grafik_zaboru/GetCity/city/" + val,
                    dataType: 'html',
                    success: function (data) {
                        if(!TimeInterval.back) {
                            TimeInterval.back = $('table.offices tbody').html();
                        }
                        $('table.offices tbody').html($(data).find('tbody tr'));
                        $('.yiiPager').hide();

                        setTimeout(function(){
                            $('table.offices tbody').find('.pop').trigger('click');
                        }, 100);

                        $('.timeinterval-select-day').removeClass('hide');
                        $('.timeinterval-select-day-fake').addClass('hide');

                        $('ul.list.day li[data-value=""]').show();
                        $('ul.list.day').find('li:first-child').trigger('click');

                        $('ul.list.timeinterval li[data-value=""]').show();
                        $('ul.list.timeinterval').find('li:first-child').trigger('click');
                    },
                    complete: function() {
                        $('.progress').hide();
                    }
                });
            }
        });
    },

    handleDayClick: function() {
        $('#Center_day').on('change', function(){
            $('ul.list.day li[data-value=""]').hide();

            var city = $('#Center_city').val();
            var day = $(this).val();

            if(!city || !day) {
                TimeInterval.clearValues();
            }

            var html = '';
            if(city && day) {
                var $timeInteralsDay = $('.time-intervals-content-time-intervals').find('.' + day + ' ul li');
                if($timeInteralsDay.length) {
                    html = '<li data-value="">' + window.appParameters.tr_not_selected + '</li>';

                    // Вытаскиваем временные интервалы из таблицы по дню
                    $timeInteralsDay.each(function(){
                        var val = $(this).text();
                        html += '<li data-value="' + val + '">' + val + '</li>';
                    });
                } else {
                    html = '<li data-value="">' + window.appParameters.tr_not_found + '</li>';
                }
            } else {
                if(day) {
                    html = '<li data-value="">' + window.appParameters.tr_not_selected + '</li>';
                } else {
                    html = '<li data-value="">&nbsp;</li>';
                }
            }

            $('ul.list.timeinterval').html(html);
            $('ul.list.timeinterval').find('li:first-child').trigger('click');
        });
    },

    handleTimeIntervalClick: function(){
        $('#Center_timeinterval').on('change', function(){
            $('ul.list.timeinterval li[data-value=""]').hide();

            var city = $('#Center_city').val();
            var day = $('#Center_day').val();
            var interval = $(this).val();
            if(!city || !day || !interval) {
                TimeInterval.clearValues();
                return;
            }

            // Вытаскиваем данные из таблицы по дню и индексу временного интервала
            var index = $('.time-intervals-content-time-intervals').find('.'+day+' ul li:contains("'+interval+'")').index();
            var order = $('.time-intervals-content-order').find('.'+day+' ul li').eq(index).text();
            var sendingDay = $('.time-intervals-content-sending-day').find('.'+day+' ul li').eq(index).text();

            $('.orderVal').text(order);
            $('.sendingDayVal').text(sendingDay);
            $('.timeinterval-filter-block .btn2').show();
        });
    },

    handleOpenWeek: function(){
        $('.time-intervals-table').on('open','.time_popup .pop', function(){
            if(!$(this).find('.time-intervals-tab li.time-intervals-tab-selected').length) {
                $(this).find('.time-intervals-tab li[data-day=monday]').addClass('time-intervals-tab-selected');
            }
        });
    },

    handleClickTab: function(){
        $('.time-intervals-table').on('click', '.time-intervals-tab li', function(){
            $this = $(this);
            $this.siblings('.time-intervals-tab-selected').removeClass('time-intervals-tab-selected');
            $this.addClass('time-intervals-tab-selected');

            var $row = $this.closest('tr');

            $row.find('.time-intervals-content > li').hide();
            $row.find('.time-intervals-content > li.'+$(this).data('day')).fadeIn();
        });
    },

    clearValues: function () {
        $('.orderVal').text('');
        $('.sendingDayVal').text('');
    }
}
/*!Временные интервалы*/

$(window).resize(function(e) {
    map_h_shadows();
    setPopupPosition();
    setPointerDescPosition();
});

$(window).scroll(function(e) {
    setPointerDescPosition();
    setTableHeaderPosition();
});

function setTableHeaderPosition() {
    var table = $('.offices_wrap table.offices:visible');

    if (!table.length) {return false;}

    var header = table.children('thead');
    if (!header.length) {return false;}

    var scrollTop = $(window).scrollTop();
    var tr = header.children('tr');

    if (scrollTop >= header.offset().top) {
        if (tr.hasClass('fixed')) {return false;}
        if (!table.hasClass('no_width')) {
            tr.children('td').each(function() {
                $(this).css('width', $(this).width());
            });
        }
        header.append('<tr class="placeholder"></tr>');
        header.children('.placeholder').css('height', header.outerHeight());

        tr.addClass('fixed').css({'position':'fixed', 'width': table.outerWidth() + 10, 'top': 0, 'left': header.offset().left});

        $('html').css('height', 'auto');
    } else {
        header.children('.placeholder').remove();
        tr.removeClass('fixed').removeAttr('style').children('td').removeAttr('style');

        $('html').css('height', '');
    }


}

function initScrollerButton() {
    var oldScroll;
    var direction = 'down';
    var scroller = $("#wrapper > .scroller");
    var scrollHeight = document.documentElement.scrollHeight;
    var clientHeight = document.documentElement.clientHeight;

    scrollHeight = Math.max(scrollHeight, clientHeight);

    $(window).scroll(function(e) {
        var scrollTop = $(window).scrollTop();

//        console.log((scrollTop < (scrollHeight - $(window).height() - 100)));

        if (oldScroll < scrollTop && (scrollTop < (scrollHeight - $(window).height() - 100))) {
            direction = 'down';
        } else if (oldScroll > scrollTop || (scrollTop >= (scrollHeight - $(window).height() - 100))) {
            direction = 'up';
        }

        oldScroll = scrollTop;

        if (scrollTop > $('#wrapper').offset().top) {
            scroller.stop(true,true).fadeIn(500);
        } else {
            scroller.stop(true,true).fadeOut(500);
        }

        if (direction == 'up') {
            scroller.addClass('up');
        } else {
            scroller.removeClass('up');
        }
    });

    scroller.click(function() {
        if ($(this).hasClass("up")) {
            $('body, html').stop().animate({'scrollTop': 0}, 800);
        } else {
            $('body, html').stop().animate({'scrollTop': scrollHeight}, 800);
        }
    });
}

function setPointerDescPosition() {
    var pointerDesc = $('#pointer_desc');

    /*if ($(window).scrollTop() + $(window).height() - 165 > 620) {
        pointerDesc.css('position', 'absolute');
    } else {
        pointerDesc.css('position', 'fixed');
    }*/
}

function popOpen( d ) {

    if (!d) return false;

    var popup = $("#popup_" + d );

    if (!$(".popup_mask").length) { $("body").append('<div class="popup_mask"></div>'); }

    if (popup.length) {
        popup
            .css("left", "-99999px")
            .css("visibility", "hidden")
            .css("margin-left", "-" + popup.width()/2 + "px" )
            .css("left", "50%")
            .css("margin-top", "-" + popup.height()/2 + "px" )
            .css("top", "50%")
            .css("visibility", "visible")
            .fadeIn();
        $(".popup_mask").fadeIn();

        if (d == 'help') {
            $('body').css('overflow', 'hidden');
        }

        $(".popup_mask, .popup_box .click.close").click(function() {
            $(".popup_box:visible").fadeOut();
            $(".popup_mask").fadeOut();
            if (d == 'help') {
                popup.find('.thanks a').click();
                $('body').css('overflow', '');
            }
        })
    }

    setPopupPosition();

    $(window).resize(function() {
        setPopupPosition();
    })
}

function setPopupPosition() {
    var popup = $(".popup_box:visible");
    var height = popup.height();

    if ($(window).height() > height + 40) {
        popup.css({'top': '50%','position': 'fixed'}).stop(true, true).animate({'margin-top': -((height/2) + 20)},400);
    } else {
        popup.css({'position': 'absolute'}).stop(true, true).animate({'top': 20 + $(window).scrollTop(), 'margin-top': 0},400);
    }
}

function topMenu(){
    var w = $("#top_menu").width();
    var l = $("#top_menu > li").length;
    $("#top_menu > li").width("");
    var t = 0;
    var w_l_g = 0;
    $("#top_menu > li").each(function(index, element) {
        w_l_g += $(this).width();

        $(this).children(".sub").find("li").each(function() {
            if ($(this).children(".sub").length) $(this).addClass("has_sub");
        })

    });
    var d = Math.floor((w - w_l_g)/l);
    //$("#top_menu > li").css("margin-left", d + "px");
    //$("#top_menu li").css("padding-left", d/2 + "px");
    //$("#top_menu li").css("padding-right", d/2 + "px");
    $("#top_menu > li").each(function() {
        $(this).width( $(this).width() + d -1 );
        //$(this).width( 100 / l + "%" );
        //$(this).width( $(this).width() + d);
    });
    $("#top_menu > li").css("visibility", "visible");
    //$("#top_menu li .sub").css("margin-left", "-" + d/2 + "px");
    $("#top_menu li").hover(function() {
        var cur = $(this);
        cur.addClass("hover");
        t = setTimeout(function() {
            if (!cur.hasClass("hover")) return false;

            if ( window.PIE ) {
                cur.parent().each(function() {
                    PIE.attach(this);
                })
                cur.children("a").each(function() {
                    PIE.attach(this);
                })
            }
            if (cur.find(".sub li").length) {
                cur.addClass("show_sub");
                cur.children(".sub").show();
            }
        }, 300)
    }, function() {
        var cur = $(this);
        cur.removeClass("hover");

        if ( window.PIE ) {
            cur.parent().each(function() {
                PIE.attach(this);
            })
            cur.children("a").each(function() {
                PIE.detach(this);
            })
        }

        if (cur.children(".sub").length) {
            cur.removeClass("show_sub");
            cur.children(".sub").hide();
        }
        window.clearTimeout(t);
    });
}

function accordion() {
    $(".accordion").each(function() {
        $(this).children("li").click(function(e) {
//            e.preventDefault();
            var a = $(this).siblings(".active");
            if (a.length) {

                a.children(".title").animate({
                    "font-size": 15
                })
                a.children(".text").slideUp("fast", function() {
                    a.removeClass("active");
                })
            }
            /*
             $(this).find(".title").animate({
             "font-size": 21
             })
             */
            if (!$(this).hasClass('active')) {
                $(this).find(".text").slideDown("fast", function() {
                    $(this).parents("li").addClass("active ok");
                    // addcookies

//                    $("html, body").animate({
//                        scrollTop: $(this).parents("li").offset().top
//                    }, 1000);
                })
            } else {
                $(this).children(".title").animate({
                    "font-size": 15
                })
                $(this).children(".text").slideUp("slow", function() {
                    $(this).parents("li").removeClass("active");
                })
            }

        });

    });

}

function tabIndex() {
    //$("input, .select, textarea").each(function(index) {
    //    $(this).attr("tabindex", index);
    //});
}

function drop(){
    $("body").click(function(e){
        e = e || window.event;
        var el = e.target || e.srcElement;
        var obj = $("#slider_block");
        if(!$(el).closest(obj).length && !$(el).parents('.select').length) $(".select").removeClass('open').find(".dropdown").stop(true, true).slideUp(100);

    });

    var inFocus = 0;
    $("body").on("click", '.option_select', function(){
        var select = $(this).closest('.select');
        if (select.hasClass("open") && inFocus > 1) {
            select.focusout();
            inFocus = 1;
        } else {
            select.focusin();
        }
    });

    $("body").on("focusin", '.select', function(){
        if (!$(this).hasClass('open')) {
            $(".select").not($(this)).removeClass("open").find(".dropdown:visible").stop(true, true).slideUp(100);
            $(this).addClass("open");
            $(this).find(".dropdown").stop(true, true).slideDown(100);
        }
        inFocus++;
    });

    $("body").on("focusout", '.select', function(){
        if ($(this).hasClass('open')) {
            $(this).removeClass("open");
            $(this).find(".dropdown").stop(true, true).slideUp(100);
        }
        inFocus = 0;
    });

    $("body").on("keydown", '.select', function(e){
        var dropdown = $(this).find('.dropdown > ul');
        var hover = dropdown.children('li.hover:visible');
        var first = dropdown.children('li:visible:first');
        var last = dropdown.children('li:visible:last');
        var scrollTop = dropdown.scrollTop();
        var scrollTopDown = scrollTop + dropdown.outerHeight();
        switch (e.keyCode){
            case 38:
                if (hover.length && !hover.is(first)) {
                    hover.removeClass('hover').prevAll('li:visible:first').addClass('hover');
                } else if (hover.is(first)) {
                    hover.removeClass('hover');
                    last.addClass('hover');
                    dropdown.scrollTop(last.position().top);
                } else {
                    last.addClass('hover');
                }

                hover = hover.prevAll('li:visible:first');
                if (hover.length && hover.position().top + scrollTop <= scrollTop) {
                    dropdown.scrollTop((hover.position().top + scrollTop));
                }

                break;
            case 40:
                if (hover.length && !hover.is(last)) {
                    hover.removeClass('hover').nextAll('li:visible:first').addClass('hover');
                } else if (hover.is(last)) {
                    hover.removeClass('hover');
                    first.addClass('hover');
                    dropdown.scrollTop(0);
                } else {
                    first.addClass('hover');
                }

                hover = hover.nextAll('li:visible:first');
                if (hover.length && hover.position().top + scrollTop + hover.outerHeight() >= scrollTopDown) {
                    dropdown.scrollTop(((hover.position().top + hover.outerHeight()) - dropdown.outerHeight()) + scrollTop);
                }

                break;
            case 13:
                hover.click();
                break;
        }

        if (e.keyCode == 38 || e.keyCode == 40 || e.keyCode == 13) return false;
    });

    /*Кто писал эту вермишель? M-A-X 2015-10-05*/
    $(".select").each(function(index, element) {
        var curObj = $(this);
        curObj.css("z-index", $(".select").length - index + 5);
        curObj.find(".option_select, li").die();

        if(!curObj.find("li.active").length) {
            curObj.find("li:first").addClass("active");
        }
        curObj.find("li:last").addClass("last");
        if(curObj.find("li > a").length) {
            var html = curObj.find("li.active").find("a").html();
        } else {
            var html = curObj.find("li.active").html();
        }
        if(curObj.find(".option_select .body").length) {
            curObj.find(".option_select .body").html(html);
        } else {
            curObj.find(".option_select").html('<span>'+html+'</span>');
        }

        if (curObj.hasClass('change_type_weight')) {
            $('.type_weight_block li:first-child').show().siblings('li').hide().find('input').attr('disabled', 'disabled');
        }
        curObj.find("li:last").addClass("last");
        if(curObj.find("li > a").length) {
            var html = curObj.find("li.active").find("a").html();
        } else {
            var html = curObj.find("li.active").html();
        }
        if(curObj.find(".option_select .body").length) {
            curObj.find(".option_select .body").html(html);
        } else {
            curObj.find(".option_select").html('<span>'+html+'</span>');
        }

        if (curObj.hasClass('change_type_weight')) {
            $('.type_weight_block li:first-child').show().siblings('li').hide().find('input').attr('disabled', 'disabled');
        }

        curObj.find("li").hover(function(){
            $(this).addClass('hover');
        }, function() {
            $(this).removeClass('hover').siblings('.hover').removeClass('hover');
        });
        if(curObj.find("input").length) {
            var val = curObj.find("li.active").data("value");
            curObj.find("input").val(val);
        }
        if(curObj.attr('id') == 'select_tabs') {
            var val = curObj.find("li.active").data("value");
            $("#select_center_info" + val).show();
        }
        curObj.find("li").live("click", function(e, data){
            var cur_li = $(this);
            if(cur_li.hasClass('disabled')) {
                return false;
            }
            var cur_li_d = cur_li.data("value");
            var form = curObj.closest("form");

            if(cur_li.find("a").length) {
                var html = cur_li.find("a").html();
            } else {
                var html = cur_li.html();
            }
            if(curObj.find(".option_select .body").length) {
                curObj.find(".option_select .body").html(html);
            } else {
                curObj.find(".option_select").html('<span>'+html+'</span>');
            }
            curObj.find(".dropdown").stop(true, true).slideUp(100, function(){
                cur_li.addClass("active").siblings().removeClass("active");
                curObj.removeClass("open");
            });

            // Здесь в скрытый инпут добавляется валуе
            if(curObj.find("input").length) {
                var val = cur_li_d;
                curObj.find("input").val(val).trigger('change', data);
            }
            if(curObj.attr('id') == 'select_tabs') {
                var val = cur_li_d;
                $("#select_center_info" + val).show().siblings('.select_center_info').hide();
            }

            if ($(this).closest('ul').hasClass('map'))
            {
                $(this).addClass('ymaps-event');
                $(this).trigger('ymaps-filter-city');
            }
            if ($(this).closest('ul').hasClass('submitOnClick'))
            {
                $(this).closest('form').submit();
            }

            if ($(curObj.hasClass('select_hide'))) {
                $('[data-rel-hide="'+curObj.data('rel')+'"]').addClass('hide').find('input[type="text"]').val('').removeClass('error');
                $('[data-rel-hide="'+curObj.data('rel')+'"]').find('.invalid').removeClass('invalid');
                $('[data-rel-hide="'+curObj.data('rel')+'"][data-hide="'+ cur_li.data('value') +'"]').removeClass('hide');
            }

            if( curObj.hasClass('del_type')) {
//                if (cur_li_d == '2' || cur_li_d == '4' ) {
//                    form.find(".l_lift").addClass("hide").next(".i").addClass("hide").find('input').val('').removeClass('error');
//                    form.find(".l_places_count").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input').val('').removeClass('error');
//                } else if ($('.cargo_type li.active').data('value') == 'Cargo' || $('.cargo_type li.active').data('value') == 'TiresWheels') {
//                    form.find(".l_lift").removeClass("hide").next(".i").removeClass("hide");
//                    form.find(".l_places_count").removeClass('invalid valid').removeClass("hide").next(".i").removeClass("hide");
//                }

                if ($('.cargo_type li.active').data('value') == 'Cargo' || $('.cargo_type li.active').data('value') == 'TiresWheels') {
                    form.find(".l_lift").removeClass("hide").next(".i").removeClass("hide");
                    form.find(".l_places_count").removeClass('invalid valid').removeClass("hide").next(".i").removeClass("hide");
                }
            }
            /*

             if( curObj.hasClass('weight')) {
             //                if (cur_li_d != '-1') {
             form.find('.office_num input').val("").siblings('.scroll-element').find('ul li.active').removeClass('active');
             if ($(".offices_wrap table tbody").length)
             {
             $('.offices_wrap table tbody tr').removeClass('hide');
             }
             //                }
             }
             */

            if( curObj.hasClass('cargo_type')) {
                curObj.siblings(".b_tooltip.m_discs_tyres").addClass("hide");
                form.find(".l_weight_types").removeClass("hide").next(".i").removeClass("hide");
                form.find(".l_weight_documents_types").addClass("hide");
                form.find(".l_pack_service").removeClass("hide").next(".i").removeClass("hide").find(':checked').removeAttr('checked').change();
                form.find(".l_redelivery").removeClass("hide").next(".i").removeClass("hide").find(':checked').removeAttr('checked').change();
                form.find(".l_pallets").addClass("hide").next(".i").addClass("hide");
                if (form.find(".del_type li.active").data("value") != '2' && form.find(".del_type li.active").data("value") != '4') {
                    form.find(".l_lift").removeClass("hide").next(".i").removeClass("hide");
                    form.find(".l_places_count").removeClass("hide").next(".i").removeClass("hide");
                }

                if (cur_li_d != 'Cargo' && cur_li_d != 'TiresWheels') {
                    form.find(".l_places_count").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val(1).removeClass('error');
                }

                if (cur_li_d == 'ValuablePapers' ) {
                    form.find(".l_weight_types").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                    form.find(".l_lift").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                    form.find(".l_pack_service").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                    form.find(".l_redelivery").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                } else if (cur_li_d == 'Documents') {
                    form.find('.pack_type li[data-value="1499fa48-d26e-11e1-95e4-0026b97ed48a"]').eq(0).click().siblings('li').addClass("hide");
                    form.find(".l_weight_types").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                    // form.find(".l_weight_documents_types").removeClass("hide");
//                    form.find(".b_vol_w").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                    form.find(".l_lift").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');

                } else {
                    if (cur_li_d == 'TiresWheels' || cur_li_d == 'Pallet') {
                        curObj.siblings(".b_tooltip.m_discs_tyres").removeClass("hide");
                        form.find(".l_weight_types").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                        form.find(".weight_vol").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                        $(".b_tooltip.m_discs_tyres .b_tooltip_body .bottom .m_cancel").click();

                        if (cur_li_d == 'TiresWheels' ) {
                            // form.find(".b_tooltip.m_discs_tyres .b_tooltip_body .b_discs").removeClass("hide").siblings(".b_palets").addClass("hide");
                            // form.find(".b_tooltip.m_discs_tyres > i").show().mouseenter();
//                            form.find(".l_lift").removeClass('invalid valid').addClass("hide").next(".i").addClass("hide").find('input[type="text"]').val('').removeClass('error');
                        } else if (cur_li_d == 'Pallet' ) {
                            // form.find(".b_tooltip.m_discs_tyres .b_tooltip_body .b_palets").removeClass("hide").siblings(".b_discs").addClass("hide");
                            // form.find(".b_tooltip.m_discs_tyres > i").show().mouseenter();
                            form.find(".l_lift").removeClass('invalid valid');
                            form.find(".l_pallets").removeClass("hide").next(".i").removeClass("hide");

                        }
                    }
                    form.find(".pack_type li").removeClass("hide");
                }
                $('.popup_mask').click();
            }

            if( curObj.hasClass('redelivery_type')) {
                if (cur_li.data('value') === 'ValuablePapers' ) {
                    curObj.siblings(".show_on_money").removeClass("hide");
                } else {
                    curObj.siblings(".show_on_money").addClass("hide").find('input').removeClass('error').val('');
                }
                if (cur_li.data('value') === 'Trays' ) {
                    curObj.siblings(".show_on_trays").removeClass("hide");
                } else {
                    curObj.siblings(".show_on_trays").addClass("hide").find('input').removeClass('error').val('');
                }
            }

            curObj.find("input[data-validate]").blur();

            equalHeight();
        })
//		curObj.click(function(e){
//			e.stopPropagation();
//		})

    });
}

function setMapLegend(type) {
    return;
    var $legend = $('#pointer_desc li');
    if (!$legend.length) return false;

    $legend.each(function(){
        if ($(this).hasClass(type)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

$.fn.autocomplete_k = function(options) {
    var defaults = {
        delay: '0'
    };
    var opts = $.extend(defaults, options);
    var t;

    var cur = $(this);
    if(cur.hasClass("s_activated")) {
        return;
    }
    var ul = cur.find("ul");
    var strict = cur.data('strict');
    var hasCustomFilter = cur.data('custom-filter');
    cur.addClass("s_activated");

    cur.children("ins").bind("click", function(e) {
        if (!cur.hasClass('active')) {
            ul.find('.hidden').removeClass('hidden');
            ac_open(ul);
            cur.addClass("active");
        } else {
            ac_close(cur.find("ul"));
            cur.removeClass("active");
        }
    });

    cur.children("input").bind("focusin", function(e) {
        ul.find('.hidden').removeClass('hidden');
        ac_open(ul);
        cur.addClass("active");
    });

    if (!hasCustomFilter) {
        cur.children("input").bind("keyup", function(e) {
            var findFirst = 0;

            if (e.keyCode == 13) {
                findFirst = 1;
            }

            ac_filter(cur.children("input"), findFirst);
            cur.addClass("active");
        });
    }

    cur.bind("focusout", function(e) {
        if (!cur.find("ul.hover_list").length) {
            ac_close(cur.find("ul"));
            cur.removeClass("active");

            if($(this).data('previous')){
                var previous = $(this).data('previous');
            }
            setTimeout(function(){
                if (1
                    && previous
                    && previous.length
                    && !cur.find('li.active').length
                ) {
                    cur.children('input[type="text"]').val(previous.find('span').text());
                    //console.log(previous);
                    previous.addClass('active').siblings('li.active').removeClass('active');
                }
            }, 20);
        }
    });

    ul.hover(function(){
        $(this).addClass('hover_list');
    }, function() {
        $(this).removeClass('hover_list');
    });

    ul.find("li").hover(function(){
        $(this).addClass('hover');
    }, function() {
        $(this).removeClass('hover').siblings('.hover').removeClass('hover');
    });

    let timeout = null;

    cur.children("input").bind("keyup", function(e) {
        var scroll = cur.find('.scroll-element.initialized');
        var hover = ul.children('li.hover:visible');
        var first = ul.children('li:visible:first');
        var last = ul.children('li:visible:last');
        var scrollapi = scroll.jScrollPane({
            showArrows:true,
            autoReinitialise: false,
            verticalDragMinHeight: 36,
            verticalDragMaxHeight: 48
        }).data('jsp');
        var scrollTop = scrollapi ? scrollapi.getContentPositionY() : 0;
        var scrollTopDown = scrollTop + scroll.outerHeight();

        switch (e.keyCode){
            case 38:
                if (hover.length && !hover.is(first)) {
                    hover.removeClass('hover').prevAll('li:visible:first').addClass('hover');
                } else if (hover.is(first)) {
                    hover.removeClass('hover');
                    last.addClass('hover');
                    scrollapi.scrollToY(last.position().top)
                } else {
                    last.addClass('hover');
                }

                hover = hover.prevAll('li:visible:first');
                if (hover.length && hover.position().top <= scrollTop) {
                    scrollapi.scrollToY((hover.position().top));
                }
                break;
            case 40:
                if (hover.length && !hover.is(last)) {
                    hover.removeClass('hover').nextAll('li:visible:first').addClass('hover');
                } else if (hover.is(last)) {
                    hover.removeClass('hover');
                    first.addClass('hover');
                    scrollapi.scrollToY(0);
                } else {
                    first.addClass('hover');
                }

                hover = hover.nextAll('li:visible:first');
                if (hover.length && hover.position().top + hover.outerHeight() >= scrollTopDown) {
                    if (scrollapi) {
                        scrollapi.scrollToY(((hover.position().top + hover.outerHeight()) - scroll.outerHeight()));
                    }
                }
                break;
            case 13:
                hover.click();
                break;
        }

        if (e.keyCode == 38 || e.keyCode == 40 || e.keyCode == 13) {
            return false;
        } else {
            //console.log();
            if($(this).attr('id') == 'oCityFilter') {
                $('#oCityFilter').val($('#oCityFilter').val().replace(/[^а-яА-ЯїЇєЄіІёЁ'\- ]/g, ''));
            //$('#oCityFilter').keydown(function(e){
                //if (e.keyCode != 38 && e.keyCode != 40 && e.keyCode != 13) {
                    if ($('#oCityFilter').val().length >= 1) {
                        clearTimeout(timeout);
                        if ($('#oCityFilter').val().length === 1){
                            timeout = setTimeout(function(){
                                searchSettlements($('#oCityFilter').val());
                            }, 200);
                        } else {
                            timeout = setTimeout(function(){
                                searchSettlements($('#oCityFilter').val());
                            }, 800);
                        }
                    } else {
                        $('#o_cities').html('');
                        $('#searchSettlementsDiv .scroll-element').hide();
                        // $('#searchSettlementsDiv .scroll-element').css('height', '0');
                        // console.log($('#o_cities').html());
                    }
                //}
            //});
            }

            if($(this).hasClass('settlementSearchInp')){
                if ($(this).val().length > 1) {
                    clearTimeout(timeout);
                    var value = $(this).val();
                    var $ulElem = $(this).closest('.b_autocomplete').find('ul');
                    timeout = setTimeout(function(){
                        searchSettlements(value, $ulElem);
                    }, 800);
                }
            }

            if($(this).attr('id') == 'settlementSelect') {
                if ($('#settlementSelect').val().length > 1) {
                    clearTimeout(timeout);
                    timeout = setTimeout(function(){
                        searchSettlementsList($('#settlementSelect').val());
                    }, 800);
                } else {
                    $('#settlementSelectList').html('');
                    //$('#searchSettlementsDiv .scroll-element').hide();
                    // $('#searchSettlementsDiv .scroll-element').css('height', '0');
                    // console.log($('#o_cities').html());
                }
            }
            if($(this).attr('id') == 'DeliveryForm_senderCity') {
                if ($('#DeliveryForm_senderCity').val().length > 3) {
                    setTimeout(function(){
                        var obj = new CitiesDeliveryForm();
                        obj.searchSettlements($('#DeliveryForm_senderCity').val(), 'sender');
                    }, 200);
                }
            }
            if($(this).attr('id') == 'DeliveryForm_recipientCity') {
                if ($('#DeliveryForm_recipientCity').val().length > 3) {
                    setTimeout(function(){
                        var obj = new CitiesDeliveryForm();
                        obj.searchSettlements($('#DeliveryForm_recipientCity').val(), 'recipient');
                    }, 200);
                }
            }
            if(0 && $(this).attr('id') == 'CarrierForm_streetName') {
                if ($('#CarrierForm_streetName').val().length > 1) {
                    clearTimeout(timeout);
                    timeout = setTimeout(function(){
                        searchSettlementsStreetList($('#CarrierForm_streetName').val());
                    }, 800);
                } else {
                    $('#CarrierForm_streetName').html('');
                    //$('#searchSettlementsDiv .scroll-element').hide();
                    // $('#searchSettlementsDiv .scroll-element').css('height', '0');
                    // console.log($('#o_cities').html());
                }
            }

            if($(this).attr('id') == 'oWarehouseFilter') {
                var liFound = $(this).closest('.b_autocomplete').find('li').not('.hidden');
                if ((liFound.length === 0 && $('#oWarehouseFilter').val().length > 2) || ($.isNumeric($('#oWarehouseFilter').val()))){
                    setTimeout(function(){
                        $warehouseList.findByString($('#oWarehouseFilter').val());
                    }, 200);
                }
            }
        }
    });

    cur.children("input").bind("keypress keyup", function(e) {
        if ($(this).val() == '' || $(this).val() == "") {
            cur.find('input[type="hidden"]').val("");

            var searchBar = cur.closest('#search_bar');
            if (searchBar.length) {
                if ($(this).hasClass('cities')) {
                    searchBar.find('.office_num input').val("").siblings('.scroll-element').find('li').remove();
                }

                // if ($(this).hasClass('offices_num')) {
                //     searchBar.find('.city .drop-down-ul li.active').click();
                // }
            }
        }
    });

    ul.find("li").unbind("click");
    ul.on("click",'li', function(e, data) {

        $(this).addClass('active').siblings('li.active').removeClass('active');
        var _data = data || {};
        _data.fromList = true;
        cur.children('input[type="text"]').val($(this).find('span').text()).blur().trigger('change', _data);
        cur.children('input[type="hidden"].cityid').val($(this).data('value')).trigger('change');
        ac_close(ul);
        if (!$(this).closest('ul').hasClass('nomap'))
        {
            if ($(this).closest('ul').hasClass('d_cities')) {
                var legendClass = $('.postomat-radio-buttons input:checked').val();
                if (legendClass == 'warehouse'){
                    $('#department').css('visibility', 'visible');
                }
                setMapLegend(legendClass);
                $('.search_map .google-autocomplete').val("");
            }
            if ($(this).closest('ul').hasClass('d_offices'))
            {
                $(this).addClass('ymaps-event');
                $(this).trigger('ymaps-filter-warehouse');
                if ($(".offices_wrap table tbody").length)
                {
                    $('.offices_wrap table tbody tr').removeClass('hide');
                    $('.offices_wrap table tbody tr[data-office!="'+$(this).data('value')+'"]').addClass('hide');
                }
            }
            else {
                // $(".offices_num").val('');
                // $(".weight").removeClass('disabled').fadeTo('slow','1');
                // $(this).addClass('ymaps-event');
                // $(this).trigger('ymaps-filter-city');
                //
                // // @todo Лучше бы список для фильтра генерировался на стороне js, так как для его генерации достаточно данных ответа.
                // getWarenHouseList($(this).text());
            }
        }
        else if ($(this).closest('ul').hasClass('load_streets'))
        {
            loadStreets($(this));
        }
        else if ($(this).closest('ul').hasClass('submitOnClick')) {
            $(this).closest('form').submit();
        }
    });

    //initScrolls(cur.children(".scroll-element"));


    function ac_filter(obj, findFirst){

        var val = obj.val();
        var curUl = obj.siblings('.scroll-element').find('ul');

        if(val == ''){
            curUl.children('li').removeClass('hidden');
        } else {
            var patt = new RegExp(val, 'i');
            curUl.children('li').each(function(){
                let text = $(this).children('span').length ? $(this).children('span').text() : $(this).text();
                let textAlt1 = $(this).text(), textAlt2 = $(this).text();
                if($(this).attr('data-name-ru')){
                    textAlt1 = $(this).attr('data-name-ru');
                }
                if($(this).attr('data-name-ua')){
                    textAlt2 = $(this).attr('data-name-ua');
                }

                if (strict) {
                    if(text.toLowerCase().indexOf(val.toLowerCase()) == 0 || textAlt1.toLowerCase().indexOf(val.toLowerCase()) == 0
                        || textAlt2.toLowerCase().indexOf(val.toLowerCase()) == 0) {
                        $(this).removeClass('hidden');
                    } else {
                        $(this).addClass('hidden');
                    }
                } else {
                    if(patt.test(text) || patt.test(textAlt1) || patt.test(textAlt2)) {
                        if (findFirst == 1) {
                            // $(this).each(function(counter, elem) {
                            //     elem.click();
                            //     return false;
                            // });
                        }

                        $(this).removeClass('hidden');
                    } else {
                        $(this).addClass('hidden');
                    }
                }
            });
        }
        if(curUl.children('li:not(.hidden)').length) ac_open(curUl);
        else ac_close(curUl);

    }

    function ac_open(ul) {

        ul.parents(".scroll-element").show();
        reinitScroll( ul.parents(".scroll-element") );
    }

    function ac_close(ul) {
        destroyScroll( ul.parents(".scroll-element") );
        ul.parents(".scroll-element").hide();
    }

    function initScrolls(obj){
        obj.not('.initialized').jScrollPane({
//            showArrows:true,
            autoReinitialise: false,
            verticalDragMinHeight: 36,
            verticalDragMaxHeight: 48
        });
        obj.not('.initialized').addClass('initialized');
    }

    function reinitScroll(obj){
        if ( obj.find("ul").height() > 200 ) {

            initScrolls(obj);
            //var scrollapi = obj.data('jsp');
            //if (scrollapi) scrollapi.reinitialise();

            if (window.PIE) {
                $(".jspVerticalBar div").each(function() {
                    if ($(this).hasClass(".jspDrag") || $(this).hasClass(".jspTrack")) {
                        PIE.attach(this);
                    }
                })
            }
        } else {
            destroyScroll(obj);
        }
    }

    function destroyScroll(obj){
        var scrollapi = obj.data('jsp');
        if (scrollapi) scrollapi.destroy();
        obj.removeClass('initialized');

    }
}

$.fn.slider = function(options){

    var defaults = {
        delay: '0',
        fade: '0',
        stop_on_click: false,
        stop_on_hover: true,
        show_arrows: false
    };
    var opts = $.extend(defaults, options);
    var t;

    var cur = $(this);
    var cur_li = cur.children("ul").children("li");
    var n = cur_li.length;

    var delay = opts['delay'];
    var fade=opts['fade'];

    if (opts['show_arrows']) {
        cur.append('<div class="slider-arrows"><i class="left"></i><i class="right"></i></div>');

        $(cur).on('click', '.slider-arrows i', function(e){
            var $a;
            if ($(this).hasClass('left')) {
                $a = cur.find(".switcher").find("a.active").prev('a');
                if (!$a.length) {
                    $a = cur.find(".switcher").find("a:last-child");
                }
            } else {
                $a = cur.find(".switcher").find("a.active").next('a');
                if (!$a.length) {
                    $a = cur.find(".switcher").find("a:first-child");
                }
            }
            $a.trigger('click');
        });
    }

    cur_li.each(function(index, element) {
        cur.find(".switcher").append("<a href='#'></a>");
    });

    if (cur.find(".switcher").hasClass('right_pos')) {
        cur.find(".switcher").css('margin-top', -(cur.find(".switcher").outerHeight()/2));
    }

    cur.find(".switcher a:first").addClass("active");
    cur_li.first().show().siblings().hide();
    cur.find(".switcher").find("a").live("click", function(e){
        if($(this).hasClass("active")) return false;
        if(opts.stop_on_click){
            clearInterval(t);
        }
        var i = $(this).index();
        $(this).addClass("active").siblings().removeClass("active");
        cur_li.eq(i).show().siblings().hide();
        return false;
    });

    cur.on('mouseenter', function(){
        if(opts.stop_on_hover){
            clearInterval(t);
        }
    });

    cur.on('mouseleave', function(){
        if(opts.stop_on_hover && delay) {
            cycle();
        }
    });

    if(delay) {
        cycle();
    }

    function cycle(){
        t = setInterval(function(){
            if(cur.find(".switcher a.active").next().length) {
                var next_a = cur.find(".switcher a.active").next();
            } else {
                var next_a = cur.find(".switcher").find("a:first");
            }
            var i = next_a.index();
            next_a.addClass("active").siblings().removeClass("active");
            if (fade!=='0')
            {
                cur_li.eq(i).fadeIn(fade).siblings().fadeOut();
            }
            else {
                cur_li.eq(i).show().siblings().hide();
            }
        }, delay);
    }

}

function styledCheck(){
    $(".checkbox :checked").siblings("label").addClass("active");
    $(".checkbox").find("label").live("click", function(){
        $(this).toggleClass("active");
    })
    $(".radio :checked").siblings("label").addClass("active");
    $(".radio").find("label").live("click", function(){
        var name = $(this).siblings("input").attr("name");
        $(this).addClass("active").closest("form").find("input[name='" + name + "']").siblings("label").not($(this)).removeClass("active");

    })
}

function inputs(){
    $("input:text[data-placeholder]").each(function(index, element) {

        var placeholder = $(this).attr('data-placeholder');
        if(!placeholder) return false;
        $(this).val(placeholder)
            .bind('keydown focus', function(){
                if($(this).val() != placeholder) {
                    $(this).addClass("focus");
                } else {
                    $(this).removeClass("focus");
                    $(this).val('');
                }
            })
            .blur(function(){
                if($(this).val() == '') {
                    $(this).removeClass("focus");
                    $(this).val(placeholder);
                }
            })
    });
}

function initHelpQuestionsPopup() {
    var popup = $('#popup_help');
    var sections = popup.find('.sections-list');
    var questions = popup.find('.questions-list');
    var question = popup.find('.question');
    var footer = popup.find('.footer');
    var headerBtn = popup.find('.header-btn');
    var sectionTitle = popup.find('.header .section-title');

    sections.on('click', 'li a', function(e) {
        var t=$(this);

        if(t.data('load') == 0) {
            return;
        } else {
            e.preventDefault();
        }

        popup.find('.preloader').fadeIn();
        $.ajax({
            type:'POST',
            url: t.data('href'),
            dataType:'json',
            success:function(json)
            {
                if (json.success)
                {
                    questions.find('.scroll-element').html(json.html);
                    sections.slideUp(300);
                    questions.slideDown(500, function() {
                        initPaneScrolls(questions.find('.scroll-element'));
                        setPopupPosition();
                    });
                    headerBtn.fadeIn();
                    headerBtn.find('.change.section').show().siblings().hide();
                    sectionTitle.text(t.parents('li').find('.title a').text()).show().siblings('h2').hide();
                }
                popup.find('.preloader').fadeOut();
            }
        });

        return false;
    });

    questions.on('click', 'li a', function(e) {
        var t=$(this);
        e.preventDefault();
        popup.find('.preloader').fadeIn();
        $.ajax({
            type:'POST',
            url: t.data('href'),
            dataType:'json',
            success:function(json)
            {
                if (json.success)
                {
                    question.find('.scroll-element').html(json.html);
                    questions.slideUp(300);
                    question.slideDown(500, function() {
                        initPaneScrolls(question.find('.scroll-element'));
                        setPopupPosition();
                    });
                    headerBtn.find('.change.question').show().siblings().hide();
                    footer.find('.thanks').fadeIn();
                }
                popup.find('.preloader').fadeOut();
            }
        });

        return false;
    });

    popup.on('click', '.change a:visible', function() {
        if (question.is(':visible')) {
            questions.slideDown(300, function() {
                setPopupPosition();
            });
            question.slideUp(300);
            headerBtn.find('.change.section').show().siblings().hide();
            initPaneScrolls(question.find('.scroll-element'), 'destroy');
            footer.find('.thanks').hide();
        } else {
            sections.slideDown(300, function() {
                setPopupPosition();
            });
            questions.slideUp(300);
            headerBtn.hide();
            popup.find('.header .section-title').hide().siblings('h2').show();
            initPaneScrolls(questions.find('.scroll-element'), 'destroy');
        }
        popup.find('.preloader').fadeOut();

        return false;
    });

    footer.on('click', '.thanks a, .online-help a', function() {
        $(".popup_box:visible").fadeOut();
        popup.find('.preloader').fadeOut();
        $(".popup_mask").fadeOut(function(){
            sections.show();
            questions.hide();
            question.hide();
            footer.find('.thanks').hide();
            headerBtn.hide();
            popup.find('.header .section-title').hide().siblings('h2').show();
            initPaneScrolls(question.find('.scroll-element'), 'destroy');
            initPaneScrolls(questions.find('.scroll-element'), 'destroy');
            $('body').css('overflow', '');
        });

        return false;
    });

    $('.tabs-registration .button-tab').click(function(){
        var type = $(this).data('type');
        if($('#LoginForm_1').val() == type) {
            return;
        }

        $('#LoginForm_1').val(type);

        $('#auth_text_person').toggleClass('hide');
        $('#auth_text_business').toggleClass('hide');

        $('.button-tab.selected').removeClass('selected');
        $(this).addClass('selected');
    });
}

function initPaneScrolls(elm, action) {
    if ($.fn.jScrollPane) {
        action = action || "default";
        var options = {
            showArrows:false,
            autoReinitialise: false,
            horizontalGutter: 10,
            verticalGutter: 50
        }

        if (typeof elm != 'undefined' && elm.length > 0) {
            var api = elm.jScrollPane(options).data().jsp;

            switch (action) {
                case 'reinit':
                    api.reinitialise();
                    break;
                case 'hard-reinit':
                    api.destroy();
                    elm.jScrollPane(options);
                    break;
                case 'destroy':
                    api.destroy();
                    break;
                case 'default':
                default:
                    elm.jScrollPane(options);
                    break;
            }
        } else {
            $('.scroll-element:visible').jScrollPane(options);
        }
    }
}

function equalHeight(){
    var height = 0;
    $("#bottom_block .mod").each(function() { $(this).find(".body:last").css("min-height", ""); })
    $("#bottom_block .mod").each(function(index, element) {
        if($(this).height() > height) height = $(this).height();
    });
    $("#bottom_block .mod").each(function(index, element) {
        var d = height - $(this).height();
        var _body = $(this).find(".body:last");
        _body.css("min-height", (_body.height() + d) + "px");
    });

}

function map_h_shadows() {
    $("#header > .shadow").attr( "style", "" );

    if ($(window).width() < $("#header .img").width() + $("#header > .shadow").width()*2 ) {
        $("#header > .shadow").width( ($(window).width() - $("#header .img").width()) /2 )
        //$("#header > .shadow.l").css("left", "-" + ( $(window).width() - $("#header .img").width() ) + "px" );
        //$("#header > .shadow.r").css("right", "-" + ( $(window).width() - $("#header .img").width() ) + "px" );
    } else {
        $("#header > .shadow").width( "" );
    }
}



function voteProceed(poll_id,vote_id)
{
    $.ajax({
        'type':'POST',
        'url':'/poll/vote/',
        'data':{poll:poll_id,vote:vote_id},
        'success':function(html)
        {
            $("#polls").fadeOut('slow',function(){
                $(this).replaceWith(html);
                $(this).fadeIn('slow');
            });
        }
    })
}


function getWarenHouseList(cityName)
{
    var warenhouselistTimeout = setTimeout(function(){
        $.ajax({
            type:'POST',
            url:"/office/warenhouselist?language="+currentLang,
            data:{city:cityName},
            dataType:'json',
            success:function (data)
            {
                $("ul.d_offices").html(data['warenList']);
                if ($(".offices_wrap .offices tbody").length)
                {
                    $(".offices_wrap .offices").show();
                    $(".offices_wrap .offices tbody").html(data['html']);
                }
                $('.weight .dropdown li[data-value="0"]').trigger('click');
                $('.weight .dropdown li[data-value="-1"]').trigger('click');
                $('.postomat-radio-buttons input:checked').trigger('click');
                $('#sundayFilter').attr('checked', false);
                $('#nowFilter').attr('checked', false);
                $('#selfServiceFilter').attr('checked', false);
                $(".office_num ul.d_offices li").attr('style', ''); // убрать лишний стиль, который мешает поиску
            }
        });
    }, 1000);
}

function loadStreets(el)
{
    var cityRef = el.data('value');
    $.ajax({
        type:'GET',
        url:"/onlineorder/getStreetList/",
        data:{cityRef: cityRef, language: currentLang},
        dataType:'json',
        success:function (data)
        {
            $(".sender_address").val('');
            $(el).closest('form').find('.streets').html(data['html']);
        }
    });
}
alreadyHaveMap = false;
function officeViewMap(warehouse)
{
    var mapOptions = {
        center: [warehouse.x,warehouse.y],
        zoom: 16
    };
    alreadyHaveMap = true;
    var map = new GoogleMaps("view_map", mapOptions);
    map.initStaticMap(warehouse);
}

function getAdditionalServices(data) {
    var ContentString = '';
    if (data.HasAdditionalServices) {
        ContentString += '<p class="additional-services-title-infoWindow"><b>' + appParameters.tr_additional_services + '</b></p>';
        ContentString += '<ul class="additional-services-blockUL">';
        if (data.OnlyReceivingParcel) {
            ContentString += '<li>' + appParameters.tr_onlyreceivingparcel + '</li>';
        }
        if (data.PostFinance) {
            ContentString += '<li>' + appParameters.tr_money + '</li>';
        }
        if (data.POSTerminal) {
            ContentString += '<li>' + appParameters.tr_card + '</li>';
        }
        if (data.BicycleParking) {
            ContentString += '<li>' + appParameters.tr_bicycleparking + '</li>';
        }
        if (data.InternationalShipping) {
            ContentString += '<li>' + appParameters.tr_internationalshipping + '</li>';
        }
        if (data.SelfServiceWorkplacesCount) {
            ContentString += '<li>' + appParameters.tr_selfserviceworkplacescount + '</li>';
        }
        if (data.GeneratorEnabled) {
            ContentString += '<li>' + appParameters.tr_generatorenabled + '</li>';
        }
        if (data.HasMirror) {
            ContentString += '<li>' + appParameters.tr_hasmirror + '</li>';
        }
        if (data.HasFittingRoom) {
            ContentString += '<li>' + appParameters.tr_hasfittingroom + '</li>';
        }

        ContentString += '</ul>';
    }

    return ContentString;
}

// OLD with icons
// function getAdditionalServices(data) {
//     var ContentString = '';
//     if (data.HasAdditionalServices) {
//         ContentString += '<p class="additional-services-title-infoWindow"><b>' + appParameters.tr_additional_services + '</b></p>';
//         ContentString += '<div class="additional-services-block">';
//         if (data.PostFinance) {
//             ContentString += '<div class="additional-services-item-infoWindow"><div class="icon icon-postfinance"></div><p>' + appParameters.tr_money + '<p></div>';
//         }
//         if (data.POSTerminal) {
//             ContentString += '<div class="additional-services-item-infoWindow"><div class="icon icon-posterminal"></div><p>' + appParameters.tr_card + '</p></div>';
//         }
//         if (data.BicycleParking) {
//             ContentString += '<div class="additional-services-item-infoWindow"><div class="icon icon-bicycleparking"></div><p>' + appParameters.tr_bicycleparking + '</p></div>';
//         }
//         if (data.InternationalShipping) {
//             ContentString += '<div class="additional-services-item-infoWindow"><div class="icon icon-internationalshipping"></div><p>' + appParameters.tr_internationalshipping + '</p></div>';
//         }
//         if (data.SelfServiceWorkplacesCount) {
//             ContentString += '<div class="additional-services-item-infoWindow"><div class="icon icon-selfserviceworkplacescount"></div><p>' + appParameters.tr_selfserviceworkplacescount + '</p></div>';
//         }
//
//         ContentString += '</div>';
//     }
//
//     return ContentString;
// }

function addAdditionalServicesBlock(data) {
    var content = getAdditionalServices(data);
    $('.info_block_office').html(content);
}

$(window).ready(function() {
    if($('#i_City').val()) {
        $('.office_num').css('visibility', 'visible');
    }

    $(document).on('change', '#i_City', function () {
        $(this).closest('form').find('.office_num').css('visibility', !!$(this).val() ? 'visible' : 'hidden');
    });

    if (!alreadyHaveMap){
        // NovaPoshta Scripts
            if (typeof google != 'undefined')
            {
                var map=new GoogleMaps('map');
                var setCurrentLocation = location.pathname.indexOf('international') == -1; // на карте международных отделений не используем геолокацию
                map.init(setCurrentLocation);

                if(history.pushState)
                {
                    // initial page replace
                    history.replaceState({city: $("ul.d_cities").find('li.active').text()}, $('title'), location.href);

                    // Event listener to capture when user pressing the back and forward buttons within the browser.
                    window.addEventListener("popstate", function(e) {
                        // оказывается кто-то еще использует дремучий хром :)
                        // @todo старая версия jquery неправильно определяет версию браузера
                        // @todo проверить на сафари и старой версии хрома без этого блока
                        if(
                            ($.browser.webkit && parseFloat($.browser.version) < 537.36)
                            || $.browser.safari
                        ) {
                            if(!appParameters.historyReady) {
                                return;
                            }
                        }


                        // fix #hash
                        if(e.state) {
                            var new_title = e.state.city+appParameters.tr_title;
                            $('title').text(new_title);
                            if(e.state.city) {
                                $("ul.d_cities").find('li:contains('+e.state.city+')').trigger('click', {nopush: 1});
                            } else {
                                $('.city-filter .clear_btn').trigger('click', {nopush: 1});
                            }
                        }
                    });
                }

                function initForm()
                {
                    if (map.allObjects.length)
                    {
                        if($('#search_bar input[name=type]:checked').val() == 'postomat')
                        {
                            $('#search_bar input[name=type]:checked').trigger('click');
                        }
                        $('.d_offices .active').trigger('click');
                    }
                    else
                    {
                        setTimeout(function(){initForm();}, 1000);
                    }
                }

                initForm();
            }
            else if (!$("#view_map").length)
            {
               /* var offlineMap=new GoogleMaps('map');
                offlineMap.triggerNearestSearch(true);

                $('#search_bar input[name=type]:checked').trigger('click');
                $('.d_offices .active').trigger('click');*/
            }
    }
});

function initWeightPerPlaceValidate() {

    var $inputFields = $('.weight-validate');
    var $totalWeight = $('.weight-validate.total-weight');
    var $numberPlaces = $('.weight-validate.number-places');

    if ($inputFields.length != 2) {
        return false;
    }

    $inputFields.on('keyup', function () {
        var totalWeight = $totalWeight.val() || 0;
        var numberPlaces = $numberPlaces.val() || 0;
        var error = false;

        if (totalWeight > 0) {
            if (numberPlaces == 0) {
                error = true;
            }
            if (totalWeight / numberPlaces > 1000) {
                error = true;
            }
        }

        if (error) {
            $inputFields.addClass('error');
            $('.weight-error-message').show();
        } else {
            $inputFields.removeClass('error');
            $('.weight-error-message').hide();
        }
    });
}

/**
 * TODO: refactor
 */
function disableType() {

    var $department = $('#department');

    if (!$department.length) { return false; }

    var val = $('.postomat-radio-buttons input[type=radio]:checked').val();
    if (val && val != 'warehouse') {
        $department.css('visibility', 'hidden');
    }

    $('body').on('change', '.postomat-radio-buttons input[type=radio]', function() {
        if ($(this).filter(':checked').val() == 'warehouse') {
            $department.css('visibility', 'visible');
        } else {
            $department.css('visibility', 'hidden');
        }
    });
}

function isEnableStorage()
{
    try {
        return 'localStorage' in window && window['localStorage'] !== null;
    } catch (e) {
        return false;
    }
};

$(function(){
    // history api on map
    $(document).on('change', '#i_City', function(e, data){
        if(!$("#map").length)
        {
            return;
        }


        if(
            (typeof data == 'undefined' || typeof data.nopush == 'undefined')
            && history.pushState
        )
        {
            // Для дремучего хрома
            appParameters.historyReady = true;
            var city = $(this).val();
            var new_url = city ? appParameters.url+'/city/'+city : appParameters.url;
            var new_title = city+appParameters.tr_title;
            $('title').text(new_title);

            history.pushState({city: city}, new_title, new_url);
            NovaPoshta.trackAnalitycs(new_url);
          //  initMap();
        }
    });

    if(location.pathname.indexOf('/office/list') != -1 && location.pathname.indexOf('/office/listinternational') == -1)
    {
        // history api on list
        if(history.pushState)
        {
            // initial page replace
            history.replaceState({city: $("ul.d_cities").find('li.active').text()}, $('title'), location.href);

            // Event listener to capture when user pressing the back and forward buttons within the browser.
            window.addEventListener("popstate", function(e) {
                // оказывается кто-то еще использует дремучий хром :)
                // @todo старая версия jquery неправильно определяет версию браузера
                // @todo проверить на сафари и старой версии хрома без этого блока
                if(
                    ($.browser.webkit && parseFloat($.browser.version) < 537.36)
                    || $.browser.safari
                ) {
                    if(!appParameters.historyReady) {
                        return;
                    }
                }

                // fix #hash
                if(e.state) {
                    var new_title = e.state.city+appParameters.tr_title;
                    $('title').text(new_title);
                    if(e.state.city) {
                        $("ul.d_cities").find('li:contains('+e.state.city+')').trigger('click', {nopush: 1});
                    } else {
                        $('.city-filter .clear_btn').trigger('click', {nopush: 1});
                    }
                }
            });

            $(document).on('change', '#i_City', function(){
                if(
                    (typeof data == 'undefined' || typeof data.nopush == 'undefined')
                    && history.pushState
                )
                {
                    // Для дремучего хрома
                    appParameters.historyReady = true;
                    var city = $(this).val();
                    var new_url = city ? appParameters.url+'/city/'+city : appParameters.url;
                    var new_title = appParameters.tr_title.replace('#CITY#', city);
                    $('title').text(new_title);
                    history.pushState({city: city}, new_title, new_url);
                    NovaPoshta.trackAnalitycs(new_url);
                }
            });
        }
    }

    if (location.pathname.indexOf('/office/list') != -1 || location.pathname.indexOf('/office/listinternational') != -1) {
        geoLocation.initSearch();

        if ($("#latlng").val() == '') {
            if (!$("ul.d_cities").find('li.active').length) {
                geoLocation.geoLocation();
            }
        } else {
            $('#header.map ul.results').html('<li class="autoload ymaps-event">' + $('#header.map .search_map #address').val() + '</li>').find('li').trigger('click');
        }
    }

    if (location.pathname.indexOf('/office/listinternational') != -1) {
        applyCity('8d5a980d-391c-11dd-90d9-001a92567626', 'Київ');
    }

    // history api on timetable
    if($('#timetable-warehouses').length)
    {
        Timetable.initHistoryApi();

        if($("#NovaPoshtaFiltersForm_city_ul li.active").length)
        {
            $("#NovaPoshtaFiltersForm_city_ul li.active").trigger('click', {nopush: 1});
        }
    }

    if($('.m_news_item .text').length)
    {
        $('html, body').animate({
            scrollTop: $('.m_news_item .text').offset().top - 100
        }, 350);
    }

    $('.form_wrap form').append('<input type="hidden" name="FeedbackForm[norobot]" value="555">');

    $('input[name="FeedbackForm[ClientType]"]').change(function(){
        var enableOrganization = $(this).attr('id') == 'JURIDICAL_PERSON';
        $('#block-organization').toggle(enableOrganization);
        $('#block-organization').find('input').attr('disabled', !enableOrganization);
    });

    $('input[name="FeedbackForm[ClientType]"]:checked').trigger('change');

    $('input[name="TendersFeedbackForm[ClientType]"]').change(function(){
        var enableOrganization = $(this).attr('id') == 'JURIDICAL_PERSON';
        $('#block-organization').toggle(enableOrganization);
        $('#block-organization').find('input').attr('disabled', !enableOrganization);
    });

    $('input[name="TendersFeedbackForm[ClientType]"]:checked').trigger('change');

    $(document).on('change', '#DeliveryForm_senderCity_id, #DeliveryForm_recipientCity_id, #DeliveryForm_deliveryTechnology_id', function(){
        var $elements = $('.l_generalDelivery, .l_generalDelivery + div'),
            $input = $('#DeliveryForm_GeneralDelivery');

        if($('#DeliveryForm_senderCity_id').val() && $('#DeliveryForm_senderCity_id').val() == $('#DeliveryForm_recipientCity_id').val() && $('#DeliveryForm_deliveryTechnology_id').val() == 'WarehouseWarehouse'){
            $elements.removeClass('hide');
            $input.attr('disabled', false);
        }else{
            $elements.addClass('hide');
            $input.attr('disabled', true);
        }
    });

    $(document).on('change', '#DeliveryForm_deliveryTechnology_id', function(){
        var $element_default = $('#packing-default'),
            $element_doors = $('#packing-doors'),
            $input = $('#DeliveryForm_packing_service, .places .packing');

        if($(this).val() == 'DoorsDoors' || $(this).val() == 'DoorsWarehouse'){
            $element_default.addClass('hide');
            $element_doors.removeClass('hide');
            $input.attr('disabled', true);
        }else{
            $element_default.removeClass('hide');
            $element_doors.addClass('hide');
            $input.attr('disabled', false);
        }
    });
    $('#AgentForm_cityText').on('change', function () {
        $("#AgentForm_city").val($('.d_cities .active').data('value'));
    });

    $('.agent #settlementSelect').on('change', function () {
        $("#AgentForm_city").val($('.d_cities .active').data('settlement'));
        $(".cityid").val($('.d_cities .active').data('value'));
    });

    $('#payment-button-tracking').click(function(){
        $link = $(this);
        $link.attr('disabled', 'disabled');
        var payType = $link.data('paytype');

        $.ajax({
            url: '/cardpay/getRecipientPaymentInfo',
            data: {Document: $('#Document').text(), Language: currentLang, RefEW: $('input[name=RefEW]').val()},
            dataType: 'json',
            cache: false
        }).success(function(data){
            if(data.success == 'true') {
                $('body').append(data.data.item.Form);
                $('#portmone-tracking-form').find('input[name=bill_amount]').val($link.data('sum'));
                $('#portmone-tracking-form').submit();
            } else {
                if(typeof data.errors.item == 'string'){
                    switch(data.errors.item) {
                        case 'CardPay payed':
                            alert(window.appParameters.tr_CARDPAY_PAYED);
                            break;
                        case 'Invalid session. Try again later.':
                            alert(data.errors.item);
                            break;
                        default:
                            alert(window.appParameters.tr_CARDPAY_CARD_DENIED);
                            break;
                    }
                } else {
                    alert(window.appParameters.tr_CARDPAY_CARD_DENIED);
                }
            }
        }).error(function(e){
            alert(window.appParameters.tr_CARDPAY_ERROR);
        }).complete(function(){
            $link.attr('disabled', false);
        });

        $('#portmone-tracking-form').submit();
    });

    $('#payment-button-tracking-tas').click(function(){
        $link = $(this);
        $link.attr('disabled', 'disabled');
        var payType = $link.data('paytype');

        $.ajax({
            url: '/cardpay/getRecipientPaymentInfoTas',
            data: {Document: $('#Document').text(), Phone: $('#phoneValue').val(), RefEW: $('input[name=RefEW]').val()},
            dataType: 'json',
            cache: false
        }).success(function(data){
            if(data.success == 'true') {
                var paymentData = data.data.item;

                if (paymentData.UseNovaPay == 'true') {
                    $('#tas-form').remove();
                } else {
                    $('#novapay-form').remove();
                }

                //Pay by TAS
                $('#choosePayCardModal').removeClass('hide');
                DocNumber = paymentData.DocNumber;
                Pays = paymentData.Pays;
                DocumentRef = paymentData.DocumentRef;
                Commissionpay = 0;

                AllSumma = paymentData.AllSumma;

                if (paymentData.Services != 0) {
                    Services = paymentData.Services + ' грн';
                    $('#Services').html(Services);
                    $('#divServices').css('display', 'block');
                    $('#checkServices').val(paymentData.Services);

                    var divServicesList = '';
                    if(paymentData.ServicesList != null && paymentData.ServicesPaid == 0) {
                        var divServicesArray = '';
                        for (var i = 0; i < paymentData.ServicesList.item.length; i++) {
                            if(paymentData.ServicesList.item[i].Service != 'd8525f47-bd44-11e7-ba66-005056b2fc3d') {
                                divServicesArray += paymentData.ServicesList.item[i].ServiceName;
                                if(i != paymentData.ServicesList.item.length - 1) { //-1 because don't show "Payment for delivery"
                                    divServicesArray += ', ';
                                }
                            }
                        }
                        if(divServicesArray != '') {
                            divServicesList = '(у т.ч. ';
                            divServicesList += divServicesArray;
                            divServicesList += ')';
                        }

                        $('#ServicesList').html(divServicesList);
                    }
                } else if(paymentData.InternationalDelivery != 0) {
                    Services = paymentData.InternationalDelivery + ' грн';
                    $('#Services').html(Services);
                    $('#divServices').css('display', 'block');
                    $('#checkServices').val(paymentData.InternationalDelivery);
                }

                if (paymentData.MoneyTransfer != 0) {
                    MoneyTransfer = parseFloat(paymentData.MoneyTransfer) + ' грн';
                    $('#MoneyTransfer').html(MoneyTransfer);
                    $('#divMoneyTransfer').css('display', 'block');

                    Commission = '(у т.ч. комісія ' + paymentData.Commission + ' грн)';
                    $('#Commission').html(Commission);
                    Commissionpay = data.data.item.Commission;
                    $('#checkMoneyTransfer').val(paymentData.MoneyTransfer);
                }

                if (paymentData.AfterPayment != 0) {
                    AfterPayment = paymentData.AfterPayment + ' грн';
                    $('#AfterPayment').html(AfterPayment);
                    $('#divAfterPayment').css('display', 'block');

                    $('#checkAfterPayment').val(paymentData.AfterPayment);
                }

                if(AllSumma == 0) {
                    $('.box_pay').css('display', 'none');
                }
                var visibleSumm = AllSumma;

                AllSumma = AllSumma + ' грн';
                payMoney = AllSumma;

                if ($('#divServices').is(':visible') && !$('#checkServices').prop("checked")) {
                    visibleSumm = visibleSumm - paymentData.Services;
                }

                if ($('#divMoneyTransfer').is(':visible') && !$('#checkMoneyTransfer').prop("checked")) {
                    visibleSumm = visibleSumm - paymentData.MoneyTransfer;
                    //visibleSumm = visibleSumm - paymentData.Commission;
                }

                if ($('#divAfterPayment').is(':visible') && !$('#checkAfterPayment').prop("checked")) {
                    visibleSumm = visibleSumm - paymentData.AfterPayment;
                }
                payMoney = visibleSumm;
                $('#AllSumma').html(visibleSumm + ' грн');
            } else {
                if(typeof data.errors.item == 'string'){
                    switch(data.errors.item) {
                        case 'CardPay payed':
                            alert(window.appParameters.tr_CARDPAY_PAYED);
                            break;
                        case 'Invalid session. Try again later.':
                            alert(data.errors.item);
                            break;
                        default:
                            alert(window.appParameters.tr_CARDPAY_CARD_DENIED);
                            break;
                    }
                } else {
                    alert(window.appParameters.tr_CARDPAY_CARD_DENIED);
                }
            }
        }).error(function(e){
            alert(window.appParameters.tr_CARDPAY_ERROR);
        }).complete(function(){
            $link.attr('disabled', false);
        });

        $('#portmone-tracking-form').submit();
    });

    /*Заказ курьера*/
    if($('form.order').length) {
        $('#PaymentMethod [data-value="1"]').addClass('disabled');
        $('#TimeIntervalCurrent span').text('');

        $(document).on('step.next', 'form.order', function(){
            $('#CarrierForm_cityRef').trigger('change');

            $.ajax({
                type: 'POST',
                url: '/onlineorder/createBuilding',
                data: {
                    streetRef: $('#CarrierForm_streetRef').val(),
                    houseNumber: $('#CarrierForm_houseNumber').val()
                },
                dataType: 'json',
                success: function (data) {
                    if(data.Ref) {
                        $('#CarrierForm_senderBuildingRef').val(data.Ref);
                    }
                },
                error: function(e) {
                }
            });
        });

        $(document).on('change', '#CarrierForm_senderUser, #CarrierForm_senderTel', function(){
            var contactPerson = $('#CarrierForm_senderUser').val();
            var phone = $('#CarrierForm_senderTel').val();
            if(!contactPerson.length || !phone.length) {
                return;
            }

            $('#CarrierForm_senderCounterpartyRef').val('');
            $('#PaymentMethod [data-value="1"]').addClass('disabled');
            $('.senderCompany').addClass('hide');

            $.ajax({
                type: 'GET',
                url: '/onlineorder/getCatalogCounterparty',
                data: {contactPerson: contactPerson, phone: phone},
                dataType: 'json',
                success: function (data) {
                    if(data.counterparties) {
                        var html = '';
                        var options = '';
                        $.each(data.counterparties, function(k,v){
                            if(v.Options && v.Options.CanNonCashPayment) {
                                options = 'data-cannoncash="'+v.Options.CanNonCashPayment+'"';
                            } else {
                                options = '';
                            }

                            html += '<li data-value="'+v.RefCounterparty+'" '+options+' class="c1" ><span>'+v.Description+'</span></li>';
                        });

                        $('#CarrierForm_senderCompany + .scroll-element .list').html(html);

                        if(data.counterparties.length == 1) {
                            $('#CarrierForm_senderCompany + .scroll-element .list li').trigger('click');
                        } else {
                            $('.senderCompany').removeClass('hide');
                            $('#CarrierForm_senderCompany + .scroll-element .list').show();
                        }
                    }
                }
            });
        });

        $(document).on('change', '#CarrierForm_senderCounterpartyRef', function(){
            if($('#CarrierForm_senderCompany + .scroll-element .list [data-value="'+$(this).val()+'"]').data('cannoncash').toString() == 'true') {
                $('#PaymentMethod [data-value="1"]').removeClass('disabled');
            }
        });

        $(document).on('change', '#CarrierForm_payer', function(){
            if($(this).val().toString() == '2') {
                $('#PaymentMethod [data-value="1"]').addClass('disabled');
                $('#PaymentMethod [data-value="2"]').trigger('click');
            } else if ($('#CarrierForm_senderCompany + .scroll-element .list [data-value="'+$('#CarrierForm_senderCounterpartyRef').val()+'"]').data('cannoncash').toString() == 'true') {
                $('#PaymentMethod [data-value="1"]').removeClass('disabled');
            }
        });

        $(document).on('change', '#CarrierForm_dateTime, #CarrierForm_cityRef', function(){
            if($(this).attr('id') == 'CarrierForm_cityRef') {
                $('#CarrierForm_dateTime').datepicker("setDate", new Date());
                if(!$(this).closest('.completed').length) {
                    return;
                }
            }
            if($(this).closest('.wrap').find('.error').length) {
                return;
            }

            $('#TimeIntervalCurrent span').text('');
            $('#CarrierForm_timeInterval').removeAttr('data-validate');
            $.ajax({
                type: 'GET',
                url: '/onlineorder/getTimeIntervals',
                data: {city: $('#CarrierForm_cityRef').val(), date: $('#CarrierForm_dateTime').val()},
                dataType: 'json',
                success: function (data) {
                    $('#TimeIntervalCurrent span').text('');
                    $('#CarrierForm_timeInterval').val('');

                    if (typeof data.response.warnings.DateChangedTo !== 'undefined'){
                        var d = data.response.warnings.DateChangedTo.split('.');
                        var dateToChange = new Date(d[2], d[1]-1, d[0]);
                        $('#CarrierForm_dateTime').datepicker("setDate", dateToChange);
                    }

                    var TimeInterval = '';
                    if (data.response.data !== null && typeof data.response.data.item !== "undefined") {
                        var obj = data.response.data.item;
                        if (!Array.isArray(obj)) {
                            var resArray = [];
                            for (var prop in obj) {
                                resArray[prop] = obj[prop];
                            }
                            obj = [];
                            obj[0] = resArray;
                        }
                        var date = new Date();
                        var minutes = date.getMinutes();
                        if(minutes < 10) {
                            minutes = '0'+minutes;
                        }
                        var hour = date.getHours();
                        if(hour < 10) {
                            hour = '0'+hour;
                        }
                        var time = hour+':'+minutes;
                        for (var i = 0; i < obj.length; i++) {
                            var object = obj[i];
                            if(data.additional.CarrierOnNextDate == 1 || object.BoundaryTime > time || data.additional.CarrierToday == 0) {
                                var val = object.Start + '-' + object.End;
                                TimeInterval += '<li data-value="' + val + '"><span>' + val + '</span></li>';
                            }
                        }
                        // if(data.additional.CarrierOnNextDate == 1){
                        //     var today = new Date();
                        //     today.setDate(today.getDate() + 1);
                        //     $('#CarrierForm_dateTime').datepicker("setDate", today);
                        // }
                        $('#CarrierForm_timeInterval').attr('data-validate', "select");
                    } else {
                        TimeInterval += '<li data-value="' + 0 + '" class="disabled"><span>' + 'Доставки в часові інтервали в дане місто не здійснюється' + '</span></li>';
                    }
                    $('ul#TimeInterval').html(TimeInterval);
                    validate_ini();
                }
            });
        });
    }
    /*!Заказ курьера*/

    /* Калькулятор международный */
    var CalculatorInternational = {
        DefaultCountry: 'UA',
        PickupCountry: {
            disabledText: window.appParameters.tr_country_pickup_disabled,
            clearOtherTypeCountry: function(){
                $('#CalculatorInternationalForm_deliveryCountry').val('');
                $('#CalculatorInternationalForm_deliveryCountryCode').val('');
            },
            setOtherTypeCountryDefault: function(){
                $('.deliveryCountry li[data-value='+CalculatorInternational.DefaultCountry+']').trigger('click');
            }
        },
        DeliveryCountry: {
            disabledText: window.appParameters.tr_country_delivery_disabled,
            clearOtherTypeCountry: function(){
                $('#CalculatorInternationalForm_pickupCountry').val('');
                $('#CalculatorInternationalForm_pickupCountryCode').val('');
            },
            setOtherTypeCountryDefault: function(){
                $('.pickupCountry li[data-value='+CalculatorInternational.DefaultCountry+']').trigger('click');
            }
        },
        init: function() {
            var t = this;
            $('#CalculatorInternationalForm_pickupCountryCode, #CalculatorInternationalForm_deliveryCountryCode').change(function(e){
                if ($(e.target).attr('id') == 'CalculatorInternationalForm_pickupCountryCode') {
                    var country = t.PickupCountry;
                } else {
                    var country = t.DeliveryCountry;
                }
                var pickupCountryCode = $('#CalculatorInternationalForm_pickupCountryCode').val();
                var deliveryCountryCode = $('#CalculatorInternationalForm_deliveryCountryCode').val();

                // Настройки доступности хранятся тут
                if($('.deliveryCountry .'+$(this).val()).data('disabled')) {
                    alert(country.disabledText);
                }

                if (pickupCountryCode == t.DefaultCountry && pickupCountryCode == deliveryCountryCode) {
                    country.clearOtherTypeCountry();
                } else {
                    if([pickupCountryCode, deliveryCountryCode].indexOf(t.DefaultCountry) == -1) {
                        country.setOtherTypeCountryDefault();
                    }
                }
            });

            if($('#CalculatorInternationalForm_pickupCountryCode').val() == '') {
               // $('.pickupCountry li[data-value='+t.DefaultCountry+']').trigger('click');
            }

            this.Places.init();
        },
        Places: {
            _$table: $('.intcalc-places'),
            _cellNames: {
                ActualWeight: 'ActualWeight',
                Length: 'Length',
                Width: 'Width',
                Height: 'Height',
                VolumeWeight: 'VolumeWeight',
            },
            init: function(){
                var Places = this;
                Places._$rowClone = Places._$table.find('tbody tr:first').clone();
                Places._$rowClone.find('input').each(function(){
                    $(this).val('');
                });

                $(document).on('click', '.addRow', function(e){
                    e.preventDefault();

                    Places._$table.append(Places._$rowClone.clone());

                    Places._generateInputNames(Places._$table.find('tbody tr:last'), Places._$table.find('.ActualWeight').length);
                });

                $(document).on('click', '.removeRow', function(e){
                    e.preventDefault();

                    if(Places._$table.find('.ActualWeight').length == 1) {
                        return;
                    }

                    $(this).closest('tr').detach();

                    var i = 0;
                    Places._$table.find('tbody tr').each(function(){
                        Places._generateInputNames($(this), ++i);
                    })
                });

                $(document).on('click', '.clearRow', function(e){
                    e.preventDefault();

                    $(this).closest('tr').find('input').val('');
                });

                $(document).on('click', '.cloneRow', function(e){
                    e.preventDefault();

                    Places._$table.append($(this).closest('tr').clone());
                    Places._generateInputNames(Places._$table.find('tbody tr:last'), Places._$table.find('.ActualWeight').length);
                });

                // Расчет объемного веса
                $(document).on('change', '.dimensions-int input', function(){
                    const currentUrl = window.location.pathname;
                    var divisore = 4000;
                    if (currentUrl == '/calculatorinternational/index/counterpartytype/organization') {
                        divisore = 5000;
                    }
                    var $dimensions = $(this).closest('.dimensions-int');
                    var volumeWeight = $dimensions.find('.Length').val() * $dimensions.find('.Width').val() * $dimensions.find('.Height').val() / divisore;
                    if(volumeWeight) {
                        volumeWeight = volumeWeight.toFixed(2);
                    } else {
                        volumeWeight = '';
                    }
                    $dimensions.closest('tr').find('.VolumeWeight').val(volumeWeight);
                })
            },

            _generateInputNames: function($el, id) {
                var Places = this;
                $.each(Places._cellNames, function(k, v){
                    $el.find('.'+k).attr('name', 'CalculatorInternationalForm[parcels][' + id + ']['+v+']');
                });
            },
        }
    };

    CalculatorInternational.init();
    /* !Калькулятор международный */

    /* Онлайн чат*/
    var Chat = {
        container: '#chat-24-widget-container',
        init: function(){
            $('.online-chat').click(function(){
                if ($(Chat.container).length) {
                    $(Chat.container).show().removeClass('chat-24-closed');
                    $('#chat-24-icon-7').trigger('click');
                } else {
                    $('.woot-widget-bubble').eq(0).trigger('click');
                }
            });

            // Клик по главной кнопке чата
            $(document).on('click', '#chat-24-roll', function(){
                $('#chat-24-icon-7').trigger('click');
            });

            // Клик по главной кнопке закрыть
            $(document).on('click', '#chat-24-close-icons', function(){
                $(Chat.container).hide();
            });

            // Клик по кнопке закрыть чата
            $(document).on('click', '.chat-24-popup-close-container', function(){
                $(Chat.container).hide();
            });

            // Если есть сообщения, показываем чат
            var checkInterval = setInterval(function(){
                var unred = $('.chat-24-badge-unread').text();
                if(unred != '00') {
                    $(Chat.container).show();
                    //clearInterval(checkInterval);
                }
            }, 1000);

            // Замена рисунка
            var checkImg = setInterval(function(){
                if ($('.woot-widget-bubble img').length) {
                    $('.woot-widget-bubble img').attr('src', 'https://static.novaposhta.ua/sitecard/logo/logochat.png');
                    clearInterval(checkImg);
                }
            }, 10);
        }
    }
    Chat.init();
    /* !Онлайн чат*/

    $(document).on('click', '.mp-banners a', function(e){
        var href = $(this).attr('href');
        var res = href.match(/^\#help([\d]*)/);
        if (res) {
            e.preventDefault();

            if (res[1]) {
                var id = res[1];
            } else {
                var id = 12;
            }

            popOpen('help');
            $('[data-help-id="'+id+'"]').trigger("click");
        }
    });

    var myLocalStorage = {
        isEnabled: function() {
            try {
                return 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
                return false;
            }
        },
        get: function(key) {
            var value = undefined;
            if (typeof window.localStorage[key] != 'undefined') {
                value = JSON.parse(window.localStorage[key]);
            }

            return value;
        },
        set: function(key, value) {
            var v = JSON.stringify(value);
            try {
                window.localStorage[key] = v;
            } catch(e) {
                if (e.name == 'QuotaExceededError') {
                    window.localStorage.clear();
                    try {
                        window.localStorage[key] = v;
                    } catch(e) {

                    }
                }
            }
        }
    }

    var popInfo = {
        key: 'popInfoShowed',
        init: function() {
            if (myLocalStorage.isEnabled() && 1) {
                var dateLast = myLocalStorage.get(popInfo.key);
            } else {
                var dateLast = getCookie(popInfo.key);
            }

            var now = new Date();
            var date = now.getDate();
            if (0 || dateLast != date) {
                var $img = $("img.popup_info_img");
                if ($img.length == 0) {
                    return;
                }
                // ленивая загрузка рисунка только если нужно показать попап
                $img.attr('src', $img.data('src')).one("load", function () {
                    popInfo.onLoaded(date);
                }).each(function () {
                    if (this.complete) {
                        $(this).load(); // For jQuery < 3.0
                        // $(this).trigger('load'); // For jQuery >= 3.0
                    }
                });
            }
        },
        onLoaded: function(date) {
            popOpen('info');
            var domain = location.host;
            var geo = domain.match(/geo\.(.*)/);
            if (geo) {
                domain = '.' + geo[1];
            } else {
                domain = domain;
            }
            if (myLocalStorage.isEnabled() && 1) {
                myLocalStorage.set(popInfo.key, date)
            } else {
                setCookie(popInfo.key, date, {domain: domain});
            }
        }
    };
    popInfo.init()
});

var geoLocation = {
    error: null,
    cacheKey: 'geolocation',
    warehouses: null,
    geoLocation: function() {
        var geoOptions = {
            timeout: 10 * 1000,
            maximumAge: 5 * 60 * 1000
        };
        var geoSuccess = function(position) {
            $.ajax({
                type: 'POST',
                url: '/shop/office/getnearestwarenhouse',
                data: {
                    x: parseFloat(position.coords.longitude),
                    y: parseFloat(position.coords.latitude),
                    type: 'city'
                },
                dataType: 'json',
                success: function (json) {
                    if (json && json.warenhouses) {
                        geoLocation.setCity(json);
                    } else {
                        geoLocation.error = {message: 'Not found nearest warehouse'};
                        geoLocation.setCity();
                    }
                },
                error: function(e) {
                    geoLocation.error = {message: 'Error when found nearest warehouse', httpErrorCode: e.status};
                    geoLocation.setCity();
                }
            });

        };
        var geoError = function(error) {
            // error.code can be:
            //   0: unknown error
            //   1: permission denied
            //   2: position unavailable (error response from location provider)
            //   3: timed out

            geoLocation.error = {message: 'Error getting location', geolocationErrorCode: error.code, geolocationErrorMessage: error.message};
            geoLocation.setCity();
        };

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(geoSuccess, geoError, geoOptions);
        } else {
            geoLocation.error = {message: 'Browser not support geolocation'};
            geoLocation.setCity();
        }
    },
    setCity: function(json) {
        if(json) {
            geoLocation.setCache(json);
            var city = json.warenhouses[0].CityRef;
        } else {
            geoLocation.setCache();
            var city = '8d5a980d-391c-11dd-90d9-001a92567626'; // Киев

            $.ajax({
                type: 'POST',
                url: '/office/loggeolocationerror',
                data: geoLocation.error,
                dataType: 'json'
            });
        }
        $("ul.o_cities").find('li.' + city).trigger('click');
    },
    setCache: function(json) {
        var data = json ? json.warenhouses : null;

        geoLocation.warehouses = data;
        if(isEnableStorage()) {
            try {
                window.localStorage[geoLocation.cacheKey] = JSON.stringify(data);
            } catch(e) {
                if(e.name == 'QuotaExceededError') {
                    window.localStorage.clear();
                    try {
                        window.localStorage[geoLocation.cacheKey] = JSON.stringify(data);
                    } catch(e) {

                    }
                }
            }
        }
    },
    getCache: function() {
        if(isEnableStorage()) {
            if(
                1
                && typeof window.localStorage[geoLocation.cacheKey] !== 'undefined'
                && window.localStorage[geoLocation.cacheKey] !== 'null'
            ) {
                var warehouses = JSON.parse(window.localStorage[geoLocation.cacheKey]);
                if (warehouses) {
                    return warehouses;
                }
            }
        }

        return false;
    },
    initSearch: function() {
        // функционал немного дублируется с таковым же на карте, но я не уверен, что его стоит сливать
        var t = this;
        var searchInput = '#header.map .search_map #address';
        $(searchInput).off('ymaps-search-places').on('ymaps-search-places', function () {
            if ($(this).hasClass('ymaps-event')) {
                t.searchPlaces(searchInput, $(this).val());
            }
        });

        t.searchPlaces = function (el, q) {
            var t = this;
            t.searchResults = null;
            if (q == '') return;
            q = 'Україна, ' + q;

            var geocoder = new google.maps.Geocoder(); // геокодер

            geocoder.geocode({'address': q}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    t.searchPlacesProceedData(results, el);
                }
            });

            $(el).removeClass('ymaps-event');
        };

        t.searchPlacesProceedData = function (results, el) {
            var t = this;
            var htmlLi = '';
            var dataObject = '';
            var coords = [];
            t.searchResults = results;
            for (var i = 0; i < results.length; i++) {
                dataObject = results[i];

                if (typeof dataObject.formatted_address != "undefined") {
                    htmlLi += '<li>' + dataObject.formatted_address + '</li>'
                }
            }
            $(el).next('ul.results').show().html(htmlLi);
        }

        var searchItem = "#header.map ul.results";
        $(searchItem).off('ymaps-nearest-search', 'li').on('ymaps-nearest-search', 'li', function () {
            if ($(this).hasClass('ymaps-event')) {
                var coords;
                if ($(this).hasClass('autoload')) {
                    coords = $("#latlng").val().split(':');
                    coords = {lng: parseFloat(coords[0]), lat: parseFloat(coords[1])};
                    var formattedAddress = $('#address').val();
                } else {
                    var currentAddress = t.searchResults[$(this).index()];
                    coords = currentAddress.geometry.location;
                    coords = {lng: coords.lng(), lat: coords.lat()};
                    var formattedAddress = currentAddress.formatted_address;
                    $("#latlng").val(currentAddress.geometry.location.lng() + ':' + currentAddress.geometry.location.lat());
                }

                var filter = WarehouseFilter.getFilter();

                $(searchItem).hide();
                $.ajax({
                    type: 'POST',
                    url: '/shop/office/getnearestwarenhouse',
                    data: {
                        x: coords.lng,
                        y: coords.lat,
                        formattedAddress: formattedAddress,
                        filter: filter,
                        type: 'list'
                    },
                    dataType: 'json',
                    success: function (json) {
                        if (json) {
                            $(".offices_wrap .offices").show();
                            $(".offices_wrap .offices tbody").html(json.html);
                        } else {
                            $(".offices_wrap .offices tbody").html('<tr><td>' + appParameters.tr_notfound + '</td></tr>');
                        }
                    }
                });
            }
        });

    }
}

$translate = {
    'mustFill':{
        'ru': 'Необходимо заполнить как минимум одно поле',
        'uk': 'Необхідно заповнити як мінімум одне поле'
    }
};

$(function() {
    // Init section
    //var $districtSelect = $("#oAreaFilter");
    var $citySelect = $("#oCityFilter");
    var $warehouseSelect = $("#oWarehouseFilter");
    var $warehouseTypeSelect = $("#oWHTypeFilter");
    var $isWorkingOnSundayCheckbox = $("#oSundayFilter");
    var $isSelfServingCheckbox = $("#oSelfServiceFilter");
    var $isWorkingNowCheckbox = $("#oNowFilter");
    var $findWarehouseBtn = $('#oSearchFilter');
    var $showMapBtn = $('#mapSubmit');
    var $geoSubmitBtn = $('#geoSubmit');
    var $addressSubmitBtn = $('#addressSubmit');
    var $clearBtn = $('#oClearAll');
    var $additionalSearchBtn = $("#oAdditionalSearch");
    var $additionalSearchBlock = $("#oAdditionalSearchBlock");

    $additionalSearchBtn.click(function(){
        if ($additionalSearchBlock.css('display') == 'none') {
            $('.first_wh_types').attr('readonly', true);
            $('.first_wh_types').attr('disabled', 'disabled');
            $('.first_wh_types').val('');
            $("#o_wh_types").find("li:first");
            $additionalSearchBtn.css('width', '180px');
            $additionalSearchBtn.html($("#o_text_additional_search_close").val());
            $additionalSearchBtn.css('background-image', 'url(/o_wh_arrow_up_max.png)');
            $additionalSearchBlock.css('display', 'block');
        } else {
            $('.first_wh_types').attr('readonly', false);
            $additionalSearchBtn.css('width', '140px');
            $additionalSearchBtn.html($("#o_text_additional_search_open").val());
            $additionalSearchBtn.css('background-image', 'url(/o_wh_arrow_down_max.png)');
            $additionalSearchBlock.css('display', 'none');
            $('.first_wh_types').attr('disabled', false);
        }
    });


    // $('#o_areas li').click(function(){
    //     var areaRef = $(this).attr('data-area-ref');
    //     $ulElem = $('#o_cities');
    //
    //     $.ajax({
    //         type: 'GET',
    //         url: '/shop/office/getcitiesbyarea/areaRef/'+areaRef,
    //         dataType: 'json',
    //         async: false,
    //         success: function (json) {
    //             if (json) {
    //                 var content = '';
    //                 $citySelect.val('');
    //                 $(".offices_wrap .offices").hide();
    //
    //                 $.each(json, function(ref, data) {
    //                     var description = (currentLang == 'ru') ?  data.nameRu : data.nameUkr;
    //                     content += '<li data-city-ref="'+data.ref+'" data-name-ru="'+data.nameRu+'"  data-name-ua="'+data.nameUkr+'" onclick="javascript:applyCity(\''+data.ref+'\')"><span>'+description+'</span></li>';
    //                 });
    //
    //                 if (Object.keys(json).length != 0) {
    //                     $('#oCityFilter').removeAttr('readonly');
    //                     $('#oWarehouseFilter').attr('readonly', 'readonly');
    //                     $('#oWarehouseFilter').val('');
    //                 } else {
    //                     $('#oCityFilter').attr('readonly', 'readonly');
    //                     $('#oWarehouseFilter').attr('readonly', 'readonly');
    //                     $('#oWarehouseFilter').val('');
    //                 }
    //
    //                 $ulElem.html(content);
    //             }
    //         },
    //         error: function (XHR, textStatus, errorThrown) {
    //             //console.log(textStatus);
    //         }
    //     });
    // })

    function getFilter() {
        // Possible filter
        return {
            //district: $districtSelect.val(),
            city: $citySelect.val(),
            warehouseCategory: $warehouseTypeSelect.val(),
            warehouse: $warehouseSelect.val(),
            sunday: $isWorkingOnSundayCheckbox.is(':checked'),
            now: $isWorkingNowCheckbox.is(':checked'),
            selfService: $isSelfServingCheckbox.is(':checked')
        }
    }

    function clearFilterInputs() {
        //$districtSelect.val("").change();
        $citySelect.val("").change();
        $warehouseSelect.val("").change();
        $warehouseTypeSelect.val("").change();
        $isWorkingOnSundayCheckbox.prop('checked', false);
        $isWorkingNowCheckbox.prop('checked', false);
        $isSelfServingCheckbox.prop('checked', false);
        //$citySelect.attr('readonly', 'readonly');
        $warehouseSelect.attr('readonly', 'readonly');
        $('#o_cities .active').removeClass('active');
        $('#o_wh_types .active').removeClass('active');
        $('#oWHTypeFilterActive').addClass('active');
        $('#o_cities').html('');
        $('#o_warehouses').html('');
    }

    function getNearestWarehouses(filter) {
        var _data = data || {};
        _data.fromList = true;

        if (!$(this).closest('ul').hasClass('nomap'))
        {
            if ($(this).closest('ul').hasClass('d_cities')) {
                var legendClass = $('.postomat-radio-buttons input:checked').val();
                if (legendClass == 'warehouse'){
                    $('#department').css('visibility', 'visible');
                }
                setMapLegend(legendClass);
                $('.search_map .google-autocomplete').val("");
            }
            if ($(this).closest('ul').hasClass('d_offices'))
            {
                $(this).addClass('ymaps-event');
                $(this).trigger('ymaps-filter-warehouse');
                if ($(".offices_wrap table tbody").length)
                {
                    $('.offices_wrap table tbody tr').removeClass('hide');
                    $('.offices_wrap table tbody tr[data-office!="'+$(this).data('value')+'"]').addClass('hide');
                }
            }
            else {
                $(".offices_num").val('');
                $(".weight").removeClass('disabled').fadeTo('slow','1');
                $(this).addClass('ymaps-event');
                $(this).trigger('ymaps-filter-city');

                // @todo Лучше бы список для фильтра генерировался на стороне js, так как для его генерации достаточно данных ответа.
                getWarehousesList('list');
            }
        }
        else if ($(this).closest('ul').hasClass('load_streets'))
        {
            loadStreets($(this));
        }
        else if ($(this).closest('ul').hasClass('submitOnClick')) {
            $(this).closest('form').submit();
        }
        // if(navigator.geolocation) {
        //     navigator.geolocation.getCurrentPosition(function(position) {
        //         $.ajax({
        //             type: 'POST',
        //             url: '/shop/office/getnearestwarenhouse',
        //             data: {
        //                 x: parseFloat(position.coords.longitude),
        //                 y: parseFloat(position.coords.latitude),
        //                 filter: filter,
        //                 type: 'list'
        //             },
        //             dataType: 'json',
        //             success: function (json) {
        //                 if (json) {
        //                     $(".offices_wrap .offices").show();
        //                     $(".offices_wrap .offices tbody").html(json.html);
        //                 } else {
        //                     $(".offices_wrap .offices tbody").html('<tr><td>' + appParameters.tr_notfound + '</td></tr>');
        //                 }
        //             }
        //         });
        //     }, function(err) {
        //     }, { timeout: 10 * 1000, maximumAge: 5 * 60 * 1000 });
        // } else {
        // }
    }

    $warehouseSelect.keyup(function() {
        if ($warehouseSelect.val() == "") {
            $('#o_warehouses .active').removeClass('active');
        }
    })

    $citySelect.keyup(function() {
        if ($citySelect.val() == "") {
            $('#o_cities .active').removeClass('active');
        }
    })

    $warehouseSelect.change(function(e, data){
        if (data && data.fromList) {
            $findWarehouseBtn.trigger('click');
        }
    })

    $findWarehouseBtn.click(function () {
        var mode = $showMapBtn.data('mode');
        var modeAddress = $addressSubmitBtn.data('mode');

        if (modeAddress == undefined) {
            modeAddress = $geoSubmitBtn.data('mode');
        }

        $("#map-container").hide();
        $(".offices_wrap .offices").hide();

        // if (!$("#o_areas .active").length){
        //     $('#oSelectCityModal').addClass('hide');
        //     $('#oSelectAreaModal').removeClass('hide');
        //     return;
        // }
        // if (!$("#o_cities .active").length){
        //     $('#oSelectAreaModal').addClass('hide');
        //     $('#oSelectCityModal').removeClass('hide');
        //     return;
        // }

        $loader2.show();

        if (mode == WarehouseFilter.modeList && modeAddress == undefined) {
            getWarehousesList(mode);
        } else if(1 && modeAddress != undefined) {
            changeStype(modeAddress);
        } else {
            getWarehouseMap(0, 0);
        }
        //getNearestWarehouses(getFilter());
    });

    $showMapBtn.click(function () {
        $this = $(this);
        var mode = $this.data('mode') == 'list' ?
            WarehouseFilter.modeMap : WarehouseFilter.modeList;
        var text = $this.find('span').html();
        var textNew = $this.data('alt-mode-text');

        $this.data('mode', mode).data('alt-mode-text', text);
        $this.find('span').html(textNew);

        $findWarehouseBtn.trigger('click');
    });

    $geoSubmitBtn.click(function () {
        $this = $(this);
        var mode = $this.data('mode') == 'list' ? 'map' : 'list';
        var text = $this.find('span').html();
        var textNew = $this.data('alt-mode-text');

        $this.data('mode', mode).data('alt-mode-text', text);
        $this.find('span').html(textNew);

        if ($('#searchType').val() == 'geo') {
            getNearest(mode);
        } else {
            changeStype(mode);
        }
    });

    $addressSubmitBtn.click(function () {
        $this = $(this);
        var mode = $this.data('mode') == 'list' ? 'map' : 'list';
        var text = $this.find('span').html();
        var textNew = $this.data('alt-mode-text');

        $this.data('mode', mode).data('alt-mode-text', text);
        $this.find('span').html(textNew);

        changeStype(mode);
    });

    $clearBtn.click(function () {
        clearFilterInputs();
        //getNearestWarehouses(getFilter());
    });

    // $districtSelect.click(function () {
    //     var $active = $('#o_areas .active');
    //     if ($active.length) {
    //         $(this).closest('.b_autocomplete').data('previous', $active);
    //     }
    //     $districtSelect.val('');
    //     $active.removeClass('active');
    // });

    // $('#oAreaArrow').click(function () {
    //     $districtSelect.val('');
    //     $('#o_areas .active').removeClass('active');
    //     $districtSelect.focus();
    // });

    $citySelect.click(function () {
        var $active = $('#o_cities .active');
        if ($active.length) {
            $(this).closest('.b_autocomplete').data('previous', $active);
        } else {
            fillMainCities();
        }

        $citySelect.val('');
        $active.removeClass('active');
    });

    $('#oCityArrow').click(function () {
        var $active = $('#o_cities .active');
        $citySelect.val('');
        $('#o_cities .active').removeClass('active');
        $citySelect.focus();

        if ($active.length == 0) {
            fillMainCities();
        }
    });

    $warehouseSelect.click(function () {
        var $active = $('#o_warehouses .active');
        if ($active.length) {
            $(this).closest('.b_autocomplete').data('previous', $active);
        }
        $warehouseSelect.val('');
        $active.removeClass('active');
    });

    $('#oWarehouseArrow').click(function () {
        $warehouseSelect.val('');
        $('#o_warehouses .active').removeClass('active');
        $warehouseSelect.focus();
    });

    // $('#oPopupButtonArea, #oPopupButtonCity').click(function(e){
    //     $(this).closest('.popup-input-wrapper').addClass('hide');
    //
    //     if (!$("#o_areas .active").length){
    //         $('#oAreaFilter').focus();
    //     } else {
    //         $('#oCityFilter').focus();
    //     }
    // });

    $('#oPopupButtonCity').click(function(e){
        $(this).closest('.popup-input-wrapper').addClass('hide');

        $('#oCityFilter').focus();
    });

    // $('#oPopupButtonGeoFail').click(function(e){
    //     $(this).closest('.popup-input-wrapper-geo').addClass('hide');
    // });

    var sub = getSubLoc();
    dlink = getLink(sub);
    $('.mapLink').attr('href', dlink);

    // $('#oCityFilter').keyup(function(){
    //     if ($('#oCityFilter').val().length > 2) {
    //         setTimeout(function(){
    //             searchSettlements($('#oCityFilter').val());
    //        }, 200);
    //     }
    // });
});

function searchSettlements(CityName, $ulElem = null) {
    if (null === $ulElem){
        $ulElem = $('#o_cities');
    }

    $.ajax({
        type: 'GET',
        url: '/shop/office/searchsettlements/searchString/'+CityName+ '?language=' + currentLang,
        dataType: 'json',
        async: false,
        success: function (json) {
            if (json) {
                var content = '';

                $.each(json, function(ref, json) {
                    var description = (currentLang == 'ru') ?  json.Present : json.Present;
                    content += '<li data-warehouses="'+json.Warehouses+'" data-value="'+json.DeliveryCity+'" data-city-ref="'+json.DeliveryCity+'" id="li'+json.DeliveryCity+'" onclick="javascript:applyCity(\''+json.DeliveryCity+'\', `'+description+'`)"><span>'+description+'</span></li>';
                });

                $ulElem.html(content);
                $ulElem.closest('.scroll-element').show();
                $('#searchSettlementsDiv .scroll-element').show();

                scrollHeight = $ulElem.closest('.scroll-element').find('ul').height();
                scrollHeight2 = $ulElem.closest('.jspPane').height();
                $ulElem.closest('.scroll-element').css('height', scrollHeight+'px');
                // $('#searchSettlementsDiv .scroll-element').css('height', scrollHeight+'px');
                $('#searchSettlementsDiv .jspContainer').css('height', scrollHeight2 +'px');
            }
        },
        error: function (XHR, textStatus, errorThrown) {
            //console.log(textStatus);
        }
    });
}

function searchSettlementsStreetList(StreetName) {
    $ulElem = $('#streetsList');
    let ref = $('#CarrierForm_cityRef').attr('city-ref');
    $.ajax({
        type: 'GET',
        url: '/onlineorder/streets/?ref=' + ref + '&term='+StreetName,
        dataType: 'json',
        async: false,
        success: function (json) {
            if (json) {
                var content = '';

                $.each(json, function(ref, json) {
                    var description = json.label;
                    content += '<li data-city-ref="'+json.value+'" data-value="'+json.value+'" id="li'+json.value+'"><span>'+description+'</span></li>';
                });

                $ulElem.html(content);
                $('#streetsList').parent().show();
                scrollHeight = json.length * 30;
                $('#streetsList').parent().css('height', scrollHeight+'px');
            }
        },
        error: function (XHR, textStatus, errorThrown) {
            //console.log(textStatus);
        }
    });
}

function searchSettlementsList(CityName) {
    $ulElem = $('#settlementSelectList');
    var onclick = !$ulElem.data('noonclick');

    $.ajax({
        type: 'GET',
        url: '/onlineorder/cities/?term='+CityName,
        dataType: 'json',
        async: false,
        success: function (json) {
            if (json) {
                var content = '';

                $.each(json, function(ref, json) {
                    var description = json.label;
                    var onclickAttr = onclick ? ' onclick="javascript:setCity(\''+json.cityRef+'\')" ' : '';
                    content += '<li data-city-ref="'+json.value+'" data-settlement="'+json.cityRef+'" data-value="'+json.value+'" id="li'+json.value+'"'+onclickAttr+'><span>'+description+'</span></li>';
                });

                $ulElem.html(content);
                $('#settlementSelectList').parent().show();
                scrollHeight = json.length * 30;
                $('#settlementSelectList').parent().css('height', scrollHeight+'px');
            }
        },
        error: function (XHR, textStatus, errorThrown) {
            //console.log(textStatus);
        }
    });
}

function setCity(ref){
    $('#CarrierForm_cityRef').attr('city-ref', ref);
}

function applyCity(ref, description) {

    if ($('form.time_estimate').length){
        return ;
    }

    $('#oCityFilter').val(description);
    $ulElem = $('#o_warehouses');
    $('#li'+ref).addClass('active');
    $ulElem.find('li.active').removeClass('active');

    fillWarehousesByCity(ref, description);

}

function fillWarehousesByCity(ref, description, preload = true, page = 1, filters = null){
    $ulElem = $('#o_warehouses');
    var preloadCount = $warehouseList.warehousesLimit;
    var fullListWarehousesLoaded = false;
    var totalCount = 0;
    var content = '';
    var cityChanged = false;

    if ($ulElem.find('li.active').length){
        $('.offices_wrap').find('table').find('tr.trLoader').remove();
        return ;
    }


    setTimeout(function(){
        $.ajax({
            type: 'POST',
            url: '/shop/office/getwarehousebycity/cityRef/'+ref + '?language=' + currentLang,
            data: {
                preload: preload,
                preloadCount: preloadCount,
                totalCount: totalCount,
                page: page,
                filters: filters
            },
            dataType: 'json',
            async: true,
            // async: false,
            success: function (json) {
                if (cityChanged){
                    $('.offices_wrap').find('table').find('tr.trLoader').remove();
                    return ;
                }

                if (typeof json.whs !== "undefined" && json.whs.warenhouse) {
                    $warehouseList.setStorage(json.whs.warenhouse);
                    if (json.cityRef !== ref){
                        $('.offices_wrap').find('table').find('tr.trLoader').remove();
                        return ;
                    }
                    preload = false;
                    if (typeof json.totalCount !== 'undefined' && json.totalCount <= (preloadCount * page)){
                        if (null === filters){
                            totalCount = json.totalCount;
                        } else {
                            $warehouseFilter.fullFilteredListLoaded = true;
                        }
                        fullListWarehousesLoaded = true;
                    } else {
                        fullListWarehousesLoaded = false;
                    }
                    if (page == 1){
                        var allWarehouses = (currentLang == 'ru') ? 'Все отделения' : 'Всі відділення';
                        content = '<li data-warehouse-ref="" data-warehouse-number="" data-name-ru="" data-name-ua=""><span>'+allWarehouses+'</span></li>';
                    }

                    $.each(json.whs.warenhouse, function(ref, data) {
                        var description = (currentLang == 'ru') ? data.warehouseTypeDescriptionRu : data.warehouseTypeDescription;
                        var city = (currentLang == 'ru') ? data.cityRu : data.city;
                        content += '<li data-warehouse-ref="'+data.ref+'" data-warehouse-number="'+data.number+'" data-name-ru="'+data.nameRu+'" data-name-ua="'+data.nameUkr+'"><span>'+city+' №'+data.number+' ('+description+')</span></li>';
                    });

                    if (Object.keys(json).length != 0) {
                        $('#oWarehouseFilter').removeAttr('readonly');
                        // $('#oWarehouseFilter').val('');
                    } else {
                        $('#oWarehouseFilter').attr('readonly', 'readonly');
                    }

                    if ($ulElem.length == 0){
                        var div = $('#li'+ref).closest('.cityBlock');

                        if (div.length && div.data('city-type') === 'sender' && $('#blockSenderWarehouse').find('ul').length){
                            $ulElem = $('#blockSenderWarehouse').find('ul');
                        } else if (div.length && div.data('city-type') === 'recipient' && $('#blockRecipientWarehouse').find('ul').length){
                            $ulElem = $('#blockRecipientWarehouse').find('ul');
                        }

                    }

                    content += '<li class="liLoader" data-warehouse-ref="" data-warehouse-number="" data-name-ru="" data-name-ua="">' +
                        '<span>' +
                        '<div class="loader2-wrapper" style="height: 10px">' +
                        '<div class="loader2" style="height: 8px; width: 8px; border: 6px solid #ccc; border-top: 6px solid transparent; margin-top: -17px"></div>' +
                        '</div>' +
                        '</span>' +
                        '</li>';

                    if (null === filters){
                        $ulElem.find('li.liLoader').remove();
                        if (page == 1){
                            $ulElem.html(content);
                        } else {
                            content = $ulElem.html() + content;
                            $ulElem.html(content);
                        }
                    }

                    if (1){
                    // if (1 && !fullListWarehousesLoaded){
                        // fillWarehousesByCity(ref, description, false, ++page);
                        var scroll = $ulElem.closest('.scroll-element:visible');
                        if (scroll.length){
                            $('#oWarehouseArrow').trigger('click');
                        }
                        $("#oWarehouseFilter").bind('click', function (){
                            $("#oWarehouseFilter").trigger('click');
                        });
                        $("#oWarehouseFilter").unbind('click');
                    }
                    if (typeof json.tableBody !== "undefined"){
                        $warehouseList.setTableData(json.tableBody, ref, page, fullListWarehousesLoaded);
                    }
                    $('.offices_wrap').find('table').find('tr.trLoader').remove();
                }
            },
            error: function (XHR, textStatus, errorThrown) {
                $('.offices_wrap').find('table').find('tr.trLoader').remove();
                //console.log(textStatus);
            }
        });
    }, 100);
}

function getWarehousesList(FilterType)
{
    var CategoryOfWarehouse = '';
    var TypeOfWarehouse = '';
    var Sunday = ($('#oSundayFilter').prop('checked')) ? 1 : 0;
    var Now = ($('#oNowFilter').prop('checked')) ? 1 : 0;
    var SelfService = ($('#oSelfServiceFilter').prop('checked')) ? 1 : 0;
    var warehouseRef = $("#o_warehouses .active").attr('data-warehouse-ref');
    var cityRef = $("#o_cities .active").attr('data-city-ref');
    warehouseRef = (typeof warehouseRef != "undefined") ? warehouseRef : '';
    cityRef = (typeof cityRef != "undefined") ? cityRef : '';

    $WHTypes = $("#o_wh_types .active");

    if (typeof $WHTypes.attr('data-wh-type') != "undefined") {
        if ($WHTypes.attr('data-wh-filter') == "TypeOfWarehouse") {
            TypeOfWarehouse = $WHTypes.attr('data-wh-type');
        } else {
            CategoryOfWarehouse = $WHTypes.attr('data-wh-type');
        }
    }

    if ($warehouseList.filterWarehousesList() && $warehouseFilter.fullFilteredListLoaded){
        // $loader2.hide();
        $('.loader2-wrapper').not('.filterLoader').hide();
        $('.loader2').not('.filterLoader').remove();
        return ;
    }

    var warenhouselistTimeout = setTimeout(function(){
        $.ajax({
            type:'POST',
            url:"/office/warehouselisto?language="+currentLang,
            data: {
                CityRef: cityRef,
                WarehouseRef: warehouseRef,
                CategoryOfWarehouse: CategoryOfWarehouse,
                TypeOfWarehouse: TypeOfWarehouse,
                Sunday: Sunday,
                Now: Now,
                SelfService: SelfService,
                FilterType: FilterType
            },
            dataType:'json',
            success:function (data)
            {
                $warehouseFilter.fullFilteredListLoaded = true;
                if (FilterType == WarehouseFilter.modeList) {
                    if ($(".offices_wrap .offices tbody").length)
                    {
                        $(".offices_wrap .offices").show();
                        $(".offices_wrap .offices tbody").html(data['html']);
                    }
                    $('.weight .dropdown li[data-value="0"]').trigger('click');
                    $('.weight .dropdown li[data-value="-1"]').trigger('click');
                } else {
                    return data;
                }
            },
            complete:function(){
                $loader2.hide();
            }
        });
    }, 1000);
}

function getWarehouseMap(x, y) {
    if (!WarehouseFilter.map) {
        var x = (x == 0) ? 50.429764 : x;
        var y = (y == 0) ? 30.644195 : y;
        var mapOptions = {
            center: [x,y],
            zoom: 16
        };

        var map = new GoogleMaps('map', mapOptions);
        map.initO(false);

        WarehouseFilter.map = map;
    }

    WarehouseFilter.map.loadWarenhouses(true);
}

// Загрузка есть похожая в трекинге
var $loader2 = {
    show: function () {
        $('.loader2-wrapper').show();
        $('.loader2-wrapper').append('<div class="loader2"></div>');
        //$('.loader-wrapper').append('<div id="overlay2"></div>');
        $('#overlay2').on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
        })
    },

    hide: function () {
        $('.loader2-wrapper').hide();
        $('.loader2').remove();
        //$('#overlay2').remove();
    }
};

function getNearest(stype) {
    $("#map-container").hide();
    $(".offices_wrap .offices").hide()
    ;

    $loader2.show();

    var options = {
        enableHighAccuracy: true,
        timeout: 60000,
        maximumAge: 0
    };

    navigator.geolocation.getCurrentPosition(geoSuccess, geoError, options);

    function geoSuccess(position) {
        //console.log(position);
        var sub = getSubLoc();
        setCookie('geoSuccess', sub);

        dlink = getLink(sub);
        $('.mapLink').attr('href', dlink);

        var crd = position.coords;
        var x = crd.longitude;
        var y = crd.latitude;

        var filter = {};
        //Приоритет фильтров
        if ($("#oAdditionalSearchBlock").css('display') == 'none') {
            $WHTypes = $("#o_wh_types .active");
        } else {
            $WHTypes = $("#oAdditionalSearchBlock #o_wh_types .active");
        }

        if ($WHTypes.attr('data-wh-filter') == "TypeOfWarehouse") {
            filter.warehouseType =  $WHTypes.attr('data-wh-type');
            if ($WHTypes.attr('data-wh-type') == 'f9316480-5f2d-425d-bc2c-ac7cd29decf0') {
                filter.warehouseCategory =  'postomat';
            } else {
                filter.warehouseCategory =  'warehouse';
            }
        } else {
            filter.warehouseCategory = $WHTypes.attr('data-wh-type').toLowerCase();
        }
        filter.sunday = ($('#oSundayFilter').prop('checked')) ? 1 : 0;
        filter.now = ($('#oNowFilter').prop('checked')) ? 1 : 0;
        filter.selfService = ($('#oSelfServiceFilter').prop('checked')) ? 1 : 0;

        setCookie('longitude', x);
        setCookie('latitude', y);
        $('#addressLng').val(x);
        $('#addressLat').val(y);

        if (stype == 'map') {
            $.ajax({
                type: 'POST',
                url: '/shop/office/GetNearestwarenhouseO',
                data: {
                    x: x,
                    y: y,
                    filter: filter,
                    type: 'map'
                },
                dataType: 'json',
                success: function (data) {
                    if (data[0]) {
                        var cityRef = data[0].city_ref;

                        if (!WarehouseFilter.map) {
                            var x = (x == 0) ? 50.429764 : x;
                            var y = (y == 0) ? 30.644195 : y;
                            var mapOptions = {
                                center: [x,y],
                                zoom: 100, // 16
                                geolocationZoom: 100, //13
                            };

                            var map = new GoogleMaps('map', mapOptions);
                            map.initGeoO(false);

                            WarehouseFilter.map = map;
                        }

                        WarehouseFilter.map.loadWarenhousesGEO(cityRef, data);
                    }
                },
                complete:function(){
                    $loader2.hide();
                    $("#map-container").show();
                },
                error: function(e) {

                }
            });
        } else {
            $.ajax({
                type: 'POST',
                url: '/shop/office/GetNearestwarenhouseO',
                data: {
                    x: x,
                    y: y,
                    filter: filter,
                    type: 'list'
                },
                dataType: 'json',
                success: function (data) {
                    if (data && data.html) {
                        $(".offices_wrap .offices tbody").html(data['html']);
                        $('.weight .dropdown li[data-value="0"]').trigger('click');
                        $('.weight .dropdown li[data-value="-1"]').trigger('click');
                    }
                },
                complete:function(){
                    $loader2.hide();
                    $(".offices_wrap .offices").show();
                },
                error: function(e) {

                }
            });
        }

        $('.geolocation-note').addClass('hide');
    }

    function geoError(err) {
        $loader2.hide();
        $('#geoSubmit').hide();
        $('#oGeoFailButton').removeClass('hide');

        deleteCookie('geoSuccess');

        dlink = getLink(0);
        $('.mapLink, #oGeoFailButton').attr('href', dlink);

        $('.geolocation-note').removeClass('hide');
    }
}

function getLink(gSubNum) {
    if (gSubNum == 0) {
        var mid = getRandomInt();
    } else {
        var mid = gSubNum;
    }

    var str = 'https://';
    str += 'r';
    str += mid;
    str += '.';
    str += 'geo';
    str += '.';
    str += 'novaposhta.ua';
    str += '/office';
    str += '/nearest';

    return str;
}

function getRandomInt() {
    var max = 99999;
    return Math.floor(Math.random() * Math.floor(max));
}

function getSubLoc() {
    var re = /(http\:\/\/|https\:\/\/r)(\d*).*/;
    var str = window.location.href;
    var sub = str.replace(re, '$2');

    var mid = getCookie("geoSuccess");

    if ((typeof mid != "undefined") && mid != 0) {
        return mid;
    } else {
        if (str == sub) {
            return false;
        } else {
            return sub;
        }
    }
}

function setCookie(name, value, options = {}) {
    var now = new Date();
    var time = now.getTime();
    var expireTime = time+60*60*24*365;
    now.setTime(expireTime);

    var defaults = {
        path: '/',
        domain: '.novaposhta.ua',
        expires: now.toGMTString()
    };
    options = $.extend(defaults, options);

    // if (options.expires instanceof Date) {
    //     options.expires = options.expires.toUTCString();
    // }

    var updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

    for (var optionKey in options) {
        updatedCookie += "; " + optionKey;
        var optionValue = options[optionKey];
        if (optionValue !== true) {
            updatedCookie += "=" + optionValue;
        }
    }

    document.cookie = updatedCookie;
}

function getCookie(name) {
    var value = "; " + document.cookie;
    var parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
}

function deleteCookie(name) {
    setCookie(name, "", {
        'max-age': -1
    });
}

function getAddress(stype) {
    var options = {
        types: ['address']
    };

    var autocomplete = new google.maps.places.Autocomplete(document.getElementById('oAddressFilter'), options);

    autocomplete.setComponentRestrictions({'country': ['ua']});

    google.maps.event.addListener(autocomplete, 'place_changed', function () {
        var place = autocomplete.getPlace();

        if (typeof place != "undefined" && typeof place.geometry != "undefined") {
            var x = place.geometry.location.lng();
            var y = place.geometry.location.lat();

            $('#addressLng').val(x);
            $('#addressLat').val(y);

            addressSuccess(stype, x, y);
        }
    });
}

function addressSuccess(stype, x, y) {
    $("#map-container").hide();
    $(".offices_wrap .offices").hide();
    $loader2.show();

    var filter = {};
    //Приоритет фильтров
    if ($("#oAdditionalSearchBlock").css('display') == 'none') {
        $WHTypes = $("#o_wh_types .active");
    } else {
        $WHTypes = $("#oAdditionalSearchBlock #o_wh_types .active");
    }

    if ($WHTypes.attr('data-wh-filter') == "TypeOfWarehouse") {
        filter.warehouseType =  $WHTypes.attr('data-wh-type');
        if ($WHTypes.attr('data-wh-type') == 'f9316480-5f2d-425d-bc2c-ac7cd29decf0') {
            filter.warehouseCategory =  'postomat';
        } else {
            filter.warehouseCategory =  'warehouse';
        }
    } else {
        filter.warehouseCategory = $WHTypes.attr('data-wh-type').toLowerCase();
    }
    filter.sunday = ($('#oSundayFilter').prop('checked')) ? 1 : 0;
    filter.now = ($('#oNowFilter').prop('checked')) ? 1 : 0;
    filter.selfService = ($('#oSelfServiceFilter').prop('checked')) ? 1 : 0;

    if (document.getElementById('codeFilter') != undefined
        && document.getElementById('codeFilter').value != 'undefined'
        && document.getElementById('codeFilter').value != ''
    ) {
        filter.warehouseIndex = document.getElementById('codeFilter').value;
        x = 1;
        y = 1;
    }

    if (stype == 'map') {
        $.ajax({
            type: 'POST',
            url: '/shop/office/GetNearestwarenhouseO',
            data: {
                x: x,
                y: y,
                filter: filter,
                type: 'map'
            },
            dataType: 'json',
            success: function (data) {
                if (data[0]) {
                    var cityRef = data[0].city_ref;

                    if (!WarehouseFilter.map) {
                        var x = (x == 0) ? 50.429764 : x;
                        var y = (y == 0) ? 30.644195 : y;
                        var mapOptions = {
                            center: [x,y],
                            zoom: 100, // 16
                            geolocationZoom: 100, //13
                        };

                        var map = new GoogleMaps('map', mapOptions);
                        map.initGeoO(false);

                        WarehouseFilter.map = map;
                    }

                    WarehouseFilter.map.loadWarenhousesGEO(cityRef, data);
                }
            },
            complete:function(){
                $loader2.hide();
                //$('.geolocation-note').addClass('hide'); // new
                //$('#searchType').val('address'); // new
                $('#addressSubmit').removeClass('hide'); // old
                //$('#oGeoFailButton').hide(); // new
                //$('#geoSubmit').show(); // new
                $("#map-container").show();
            },
            error: function(e) {

            }
        });
    } else {

        $.ajax({
            type: 'POST',
            url: '/shop/office/GetNearestwarenhouseO',
            data: {
                x: x,
                y: y,
                filter: filter,
                type: 'list'
            },
            dataType: 'json',
            success: function (data) {
                if (data && data.html) {
                    $(".offices_wrap .offices tbody").html(data['html']);
                    $('.weight .dropdown li[data-value="0"]').trigger('click');
                    $('.weight .dropdown li[data-value="-1"]').trigger('click');
                }
            },
            complete:function(){
                $loader2.hide();
                //$('.geolocation-note').addClass('hide'); // new
                //$('#searchType').val('address'); // new
                //$('#oGeoFailButton').hide(); // new
                //$('#geoSubmit').show(); // new

                $addressSubmit = $('#addressSubmit');

                if ($addressSubmit.data('mode') == 'map') {
                    var mode = $addressSubmit.data('mode') == 'list' ? 'map' : 'list';
                    var text = $addressSubmit.find('span').html();
                    var textNew = $addressSubmit.data('alt-mode-text');

                    $addressSubmit.data('mode', mode).data('alt-mode-text', text);
                    $addressSubmit.find('span').html(textNew);
                }

                $addressSubmit.removeClass('hide'); // old
                $(".offices_wrap .offices").show();
                if (document.getElementById('codeFilter') != undefined) {
                    document.getElementById('codeFilter').value = '';
                }
            },
            error: function(e) {

            }
        });
    }
}

function changeStype(stype) {
    var x = $('#addressLng').val();
    var y = $('#addressLat').val();

    addressSuccess(stype, x, y);
}

function fillMainCities() {
    $ulElem = $('#o_cities');

    if (null !== $dataStorage.mainCities){
        $ulElem.html($dataStorage.mainCities);
        scrollHeight = $ulElem.closest('.scroll-element').find('ul').height();
        $ulElem.closest('.scroll-element').css('height', scrollHeight+'px');
        scrollHeight2 = $ulElem.closest('.jspPane').height();
        $('#searchSettlementsDiv .jspContainer').css('height', scrollHeight2 +'px');
        return ;
    }

    $.ajax({
        type: 'POST',
        url: '/shop/office/getMainCities',
        data: {
        },
        dataType: 'json',
        success: function (json) {
            if (json) {
                var content = '';

                $.each(json, function(ref, json) {
                    if (currentLang === 'ru'){
                        var description = 'г. ' + json.nameRu + ', ' + json.areaDescriptionRu + ' обл.'
                    } else {
                        var description = 'м. ' + json.nameUkr + ', ' + json.areaDescription + ' обл.';
                    }

                    content += '<li data-city-ref="'+json.ref+'" id="li'+json.ref+'" onclick="javascript:applyCity(\''+json.ref+'\', `'+description+'`)"><span>'+description+'</span></li>';
                });
                $dataStorage.mainCities = content;
                $ulElem.html(content);
                $('#searchSettlementsDiv .scroll-element').show();
                scrollHeight = $ulElem.closest('.scroll-element').find('ul').height();
                $ulElem.closest('.scroll-element').css('height', scrollHeight+'px');
            }
        },
        complete:function(){
        },
        error: function(e) {
        }
    });
}

$dataStorage = {
    mainCities: null
}

// var defaultBounds1 = new google.maps.LatLngBounds(
//     new google.maps.LatLng(parseFloat(coords[0]), parseFloat(coords[1])),
//     new google.maps.LatLng(parseFloat(coords[0]), parseFloat(coords[1])));

// google.maps.event.addListener(autocomplite, 'inputs', function () {
//     var place = autocomplite.getPlace();
//     console.log(place);
// });




// for (var i = 0; i < place.address_components.length; i++) {
//     var addressType = place.address_components[i].types[0];
//     if (componentForm[addressType]) {
//         var val = place.address_components[i][componentForm[addressType]];
//         console.log(val);
//     }
// }

//
//
// geocoder.geocode({'address': q}, function (results, status) {
//     if (status == google.maps.GeocoderStatus.OK) {
//         t.searchPlacesProceedData(results, el);
//     }
// });


</script>

</body>
</html>
