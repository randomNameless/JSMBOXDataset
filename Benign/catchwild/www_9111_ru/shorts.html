<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shorts.html</title>
</head>
<body>

<script>
let shortVideo=null;const shortsArray=[],shortsDiffSlide=15;let countItems=0,selectedItem=0,shortVideoMuted=!1,screenY=window.innerHeight,containerShorts=null;function openShortsWithId(t){short_id=t,openShorts()}function openShorts(){0===$("#shorts_container").length&&($("body").css("overflow-y","hidden"),null!==currentVideo&&!0!==currentVideo.paused&&currentVideo.pause(),$("body").append('<div id="shorts_container__wrap" data-fullscreen="false" draggable="false"><div class="shorts_container" data-fullscreen="false" draggable="false" id="shorts_container"></div></div>'),containerShorts=document.querySelector("#shorts_container"),containerShorts.addEventListener("touchstart",handleTouchStart,{passive:!0,once:!1}),containerShorts.addEventListener("touchmove",handleTouchMove,{passive:!0,once:!1}),containerShorts.addEventListener("touchend",handleTouchEnd,{passive:!0,once:!1}),openFullscreen(),loadShorts(0,5))}function closeShorts(){1===$("#shorts_container").length&&($("body").css("overflow-y","auto"),selectedItem=0,shortsArray.length=0,null!==shortVideo&&(shortVideo.pause(),shortVideo=null),exitFullscreen(),containerShorts=null,$("#shorts_container__wrap").remove())}function openFullscreen(){let t=document.querySelector("#shorts_container__wrap");"function"==typeof t.requestFullScreen&&(t.requestFullScreen(),document.cancelFullScreen&&document.cancelFullScreen()),"function"==typeof t.webkitRequestFullScreen&&(t.webkitRequestFullScreen(),document.webkitCancelFullScreen&&document.webkitCancelFullScreen()),"function"==typeof t.mozRequestFullScreen&&(t.mozRequestFullScreen(),document.mozCancelFullScreen&&document.mozCancelFullScreen()),$(containerShorts).attr("data-fullscreen",!0)}function exitFullscreen(){if(!0===$(containerShorts).data("fullscreen")){let t=document.querySelector("#shorts_container__wrap");document.fullscreenElement?document.exitFullscreen():t.webkitFullscreenElement&&document.webkitExitFullscreen(),$(containerShorts).attr("data-fullscreen",!1)}}$('button[data-open-shorts="true"]').on("click",(function(){openShorts()})),$("button[data-open-shorts-with-id]").on("click",(function(){openShortsWithId(Number.parseInt($(this).data("openShortsWithId")))}));var xDown=null,yDown=null,touchStart=0,touchEnd=0;function getTouches(t){return t.touches||t.originalEvent.touches}function handleTouchStart(t){const e=getTouches(t)[0];xDown=e.clientX,yDown=e.clientY,touchStart=yDown,countItems=$("#shorts_container .shorts__item").length}function handleTouchMove(t){var e=t.touches[0].clientX,s=t.touches[0].clientY,o=xDown-e,r=yDown-s;touchStart>s?countItems>selectedItem+1&&$(containerShorts).get(0).style.setProperty("--pull-y",Math.abs(touchStart-s)+"px"):selectedItem>0&&$(containerShorts).get(0).style.setProperty("--pull-y",-Math.abs(touchStart-s)+"px"),Math.abs(o),Math.abs(r),xDown=null,yDown=null}function handleTouchEnd(t){const e=t.changedTouches[0];touchEnd=e.clientY;let s=Math.abs(Math.abs(touchEnd)-touchStart)/screenY*100;if(touchStart>touchEnd){if(s>=shortsDiffSlide&&countItems>selectedItem+1){selectedItem++,$(containerShorts).get(0).style.setProperty("--selected-item",selectedItem);let t=new ShortPlayer;t.load(selectedItem),void 0!==shortsArray[selectedItem+1]&&t.load(selectedItem+1),shortsArray.length-selectedItem<5&&loadShorts(shortsArray.length,5)}}else if(s>=shortsDiffSlide&&selectedItem-1>=0){selectedItem--,(new ShortPlayer).load(selectedItem),$(containerShorts).get(0).style.setProperty("--selected-item",selectedItem)}$(containerShorts).get(0).style.setProperty("--pull-y","0px")}class ShortModel{videoId=0;url="";like=0;dislike=0;comments=0;userId=0;userName="";userAvatar="";userIsFollower=0;titleId=0;titleName="";constructor(t){Object.assign(this,t)}}class ShortPlayer extends ShortModel{constructor(t){super(t)}fillObject(t){return Object.assign(this,t),this}initPlayer(t){null!==shortVideo&&(videoViewingDuration("send",shortVideo.videoId),shortVideo.pause(),shortVideo.load(),shortVideo=null);let e=$('.shorts__item[data-selected-item="'+t+'"]');shortVideo=e.find("video")[0];let s=shortsArray.at(t);shortVideo.videoId=s.videoId,shortVideo.itemNum=t,shortVideo.titleId=s.titleId,shortVideo.addEventListener("click",(()=>{shortVideo.paused?shortVideo.play():(shortVideo.pause(),videoViewingDuration("send",shortVideo.videoId))}),{passive:!0,once:!1}),!0===shortVideoMuted?(shortVideo.volume=0,shortVideo.muted=!0,e.find(".shorts__panel__muted svg").html('<use href="#muted_off"></use>')):(shortVideo.volume=1,shortVideo.muted=!1,e.find(".shorts__panel__muted svg").html('<use href="#muted_on"></use>')),shortVideo.play(),saveHidden(shortVideo.titleId),videoViewsAnalytics(e,shortVideo.videoId,1),videoViewingDuration("start",shortVideo.videoId),this.setListener()}addShorts(){$.each(shortsArray,((t,e)=>{0===$('.shorts__item[data-selected-item="'+t+'"]').length&&$("#shorts_container").append(`<div class="shorts__item" data-video-id="${e.video_id}" data-title-id="${e.title_id}" data-selected-item="${t}" data-url="${e.url}" style="background-image: url(${e.url}.jpg);"></div>`)})),0===selectedItem&&(this.load(0),this.load(1)),countItems=shortsArray.length}load(t){void 0!==t&&($('.shorts__item[data-selected-item="'+t+'"]').html(this.getTemplate(shortsArray.at(t))),t===selectedItem&&this.fillObject(shortsArray.at(t)).initPlayer(selectedItem))}getTemplate(t){return`\n\t\t\t<div class="shorts__header">\n\t\t\t\t<div class="shorts__header__back"><svg><use href="#left"></use></svg></div>\n\t\t\t\t<div class="shorts__header__share">Поделиться<svg><use href="#share"></use></svg></div>\n\t\t\t</div>\n\t\t\t<video class="shorts__video__video" playsinline disablepictureinpicture loop preload="auto" src="${t.url}.mp4" type="video/mp4"></video>\n\t\t\t<div class="shorts__panel">\n\t\t\t\t<div class="shorts__panel__like">\n\t\t\t\t\t<svg><use href="#like"></use></svg>\n\t\t\t\t\t<div>${t.like}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="shorts__panel__dislike">\n\t\t\t\t\t<div>${t.dislike}</div>\n\t\t\t\t\t<svg><use href="#like"></use></svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="shorts__panel__comments">\n\t\t\t\t\t<svg><use href="#message"></use></svg>\n\t\t\t\t\t<div>${t.comments}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="shorts__panel__share"><svg><use href="#share"></use></svg></div>\n\t\t\t\t<div class="shorts__panel__separator"></div>\n\t\t\t\t<div class="shorts__panel__muted"><svg><use href="#muted_on"></use></svg></div>\n\t\t\t</div>\n\t\t\t<div class="shorts__footer">\n\t\t\t\t<div class="shorts__footer__user">\n\t\t\t\t\t<img src="${t.userAvatar}">\n\t\t\t\t\t<a class="shorts__footer__name" target="_blank" href="/user-${t.userId}/">${t.userName}</a>\n\t\t\t\t\t<button class="shorts__footer__subscribe" data-user-id="${t.userId}" data-is-follower="${t.userIsFollower}">Подписаться</button>\n\t\t\t\t</div>\n\t\t\t\t<a class="shorts__footer__title" target="_blank" href="/questions/777777777${t.titleId}/">${t.titleName}</a>\n\t\t\t</div>\n\t\t`}setListener(){$(".shorts__panel__like").on("click",(function(){null!==shortVideo&&(titleRatingVote(shortVideo.titleId,5),$(this).find("div").text(Number.parseInt($(this).find("div").text())+1),$(this).off("click"))})),$(".shorts__panel__dislike").on("click",(function(){null!==shortVideo&&(titleRatingVote(shortVideo.titleId,1),$(this).find("div").text(Number.parseInt($(this).find("div").text())-1),$(this).off("click"))})),$(".shorts__panel__muted").on("click",(function(){shortVideoMuted?(shortVideo.volume=1,shortVideo.muted=!1,$(this).find("svg").html('<use href="#muted_on"></use>')):(shortVideo.volume=0,shortVideo.muted=!0,$(this).find("svg").html('<use href="#muted_off"></use>')),shortVideoMuted=shortVideo.muted})),$(".shorts__header__back").on("click",(function(){closeShorts()})),$(".shorts__panel__share, .shorts__header__share").on("click",(function(){let t=$(this).closest(".shorts__item").find(".shorts__footer__title");t&&(statClicks("shorts_share"),navigatorShare(t.attr("href"),t.text()))})),$(".shorts__footer__subscribe").on("click",(function(t){let e=Number.parseInt($(this).data("userId")),s=Number.parseInt($(this).data("isFollower"));e>0&&(0===s?(follower("add",e,!1),$(this).attr("data-is-follower",1),$(this).data("isFollower",1),$(this).html("Отписаться")):(follower("del",e,!1),$(this).attr("data-is-follower",0),$(this).data("isFollower",0),$(this).html("Подписаться")))}))}}let shortsLoaded=!1,short_id=0;function loadShorts(t=0,e=0){if(!1===shortsLoaded){shortsLoaded=!0;let s=[];if(shortsArray.length>0)for(i=0;i<shortsArray.length;i++)s.push(shortsArray[i].videoId);$.ajax({dataType:"json",type:"GET",url:"/ajax_server/shorts.php",cache:!1,data:{short_id:short_id,offset:t,limit:e},success:function(t){if(0!==short_id&&(short_id=0),!0===t.success){$.each(t.shorts,(function(t,e){!1===s.includes(e.videoId)&&shortsArray.push(new ShortModel(e))})),(new ShortPlayer).addShorts()}shortsLoaded=!1}})}}function getShortsAdvert(){window.yaContextCb.push((()=>{Ya.adfoxCode.create({ownerId:282719,containerId:"adfox_171135416107283401",params:{pp:"g",ps:"ddlt",p2:"ixkh"}})}))}$(document).ready((function(){$(".gallery_shorts__wrap").length>0&&$(".gallery_shorts__wrap").fadeIn(100)}));
</script>

</body>
</html>
