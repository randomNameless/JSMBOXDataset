<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>getMarkVal.html</title>
</head>
<body>

<script>
/***

Function to Create Cookie

***/
function createCookie(name,value,days) {
  if (days) {
    var date = new Date();
    date.setTime(date.getTime()+(days*24*60*60*1000));
    var expires = "; expires="+date.toGMTString();
  } else var expires = "";
  document.cookie = name+"="+value+expires+"; domain=.manageengine.cn; path=/";
}


/***

Function to get the Cookie value

***/

function getSrcCookie(cname) {
  var name =  cname+"=";try{var decodedCookie = decodeURIComponent(document.cookie);}catch(exp){var decodedCookie =document.cookie;}
   var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}
/***

If the referrer is empty, Then the session is considered direct

***/
function directTraffic(){
if(document.referrer == ''){
return 'direct';
}}

/***

Function to get the Product Name based on the Page URL

***/
  function getProduct(){

  var pageURL = document.URL;
  result = pageURL.split('/');
  var str =pageURL.replace('index.html','');
if(str.indexOf('sdpondemand.manageengine.cn')>-1){
 product = "SDP"
}
else if(str.indexOf('manageengine.cn/products/passwordmanagerpro/')>-1){
 product = "PMP"
}
else if(str.indexOf('manageengine.cn/products/applications_manager/')>-1){
  product="APM"
}
else if(str.indexOf('manageengine.cn/network-performance-management.html')>-1){
  product="OPM"
}
else if(str.indexOf('manageengine.cn/application-performance-management.html')>-1){
  product="APM"
}
else if(str.indexOf('manageengine.cn/windows-active-directory-tools.html')>-1){
  product="ADGroup"
}
else if(str.indexOf('manageengine.cn/desktop-management-solution.html')>-1){
  product="DCGroup"
}
else if(str.indexOf('manageengine.cn/it-compliance-suite.html')>-1){
  product="ITCompliance"
}
else if(str.indexOf('manageengine.cn/msp-solutions.html')>-1){
  product="MSPGroup"
}
else if(str.indexOf('manageengine.cn/ondemand-solutions.html')>-1){
  product="ODGroup"
}
else if(str.indexOf('manageengine.cn/free-software-download.html')>-1){
  product="Free Tool Pages"
}
else if(str.indexOf('manageengine.cn/mobile-device-management/')>-1){
  product="MDM"
}else if(str.indexOf('manageengine.cn/network-monitoring/')>-1){
  product="OPM"
}else if(str.indexOf('mdm.manageengine.cn')>-1){
  product="MDM"
}else if(str.indexOf('manageengine.cn/products/service-desk/')>-1){
  product="SDP"
}else if(str.indexOf('manageengine.cn/products/desktop-central/')>-1){
  product="DC"
}else if(str.indexOf('manageengine.cn/patch-management/')>-1){
  product="Patch"
}else if(str.indexOf('manageengine.cn/products/firewall/')>-1){
  product="FWA"
}else if(str.indexOf('manageengine.cn/products/ad-manager/')>-1){
  product="ADMP"
}else if(str.indexOf('manageengine.cn/products/netflow/')>-1){
  product="NFA"
}else if(str.indexOf('manageengine.cn/ad-recovery-manager/')>-1){
  product="ADRM"
}else if(str.indexOf('manageengine.cn/products/self-service-password/')>-1){
  product="ADSSP"
}else if(str.indexOf('manageengine.cn/secure-browser/')>-1){
  product="BSP"
}else if(str.indexOf('manageengine.cn/remote-desktop-management/')>-1){
  product="RAP"
}else if(str.indexOf('manageengine.cn/products/asset-explorer/')>-1){
  product="AE"
}else if(str.indexOf('manageengine.cn/network-monitoring/')>-1){
  product="OPM"
}else if(str.indexOf('manageengine.com/sprints.html')>-1){
      product="ME-Sprints"
    }
else if(str.indexOf('manageengine.com/projects.html')>-1){
      product="ME-Projects"
    }
else if(str.indexOf('manageengine.com/creator.html')>-1){
      product="ME-Creator"
    }
else if(str.indexOf('manageengine.com/assist.html')>-1){
      product="ME-Assist"
    }
else if(str.indexOf('manageengine.com/vulnerability-management/')>-1){
      product="VMP"
    }
else if(str.indexOf('manageengine.com/sharepoint-management-reporting/')>-1){
      product="SPMP"
    }
else if(str.indexOf('manageengine.com/products/service-desk-msp/')>-1){
      product="SDP-MSP"
    }
else if(str.indexOf('manageengine.com/it-operations-management/')>-1){
      product="OPM-Plus"
    }
else if(str.indexOf('manageengine.com/office365-management-reporting/')>-1){
      product="Office365"
    }
else if(str.indexOf('manageengine.com/products/os-deployer/')>-1){
      product="OSD"
    }
else if(str.indexOf('manageengine.com/mobile-device-management-msp/')>-1){
      product="MDM-MSP"
    }
else if(str.indexOf('manageengine.com/log-management')>-1){
      product="Log360"
    }
else if(str.indexOf('manageengine.com/device-control')>-1){
      product="DeviceControl"
    }

else if(str.indexOf('manageengine.com/browser-security')>-1){
      product="BSP"
    }
else if(str.indexOf('manageengine.com/alarmsone')>-1){
      product="AlarmsOne"
    }
else if(str.indexOf('manageengine.com/products/active-directory-audit/')>-1){
      product="AD-Audit"
    }
else if(str.indexOf('manageengine.com/privileged-access-management/')>-1){
      product="PAM360"
    }
else if(str.indexOf('manageengine.cn/products/mibbrowser-free-tool/')>-1){
  product="MIBBrowser"
}else if(str.indexOf('manageengine.cn/analytics-plus/')>-1){
  product="AnalyticsPlus"
}else if(str.indexOf('manageengine.cn/network-configuration-manager/')>-1){
  product="NCM"
}else if(str.indexOf('manageengine.cn/products/eventlog/')>-1){
  product="ELA"
}else if(str.indexOf('manageengine.cn/key-manager/')>-1){
  product="key-manager"
}
else if(str.indexOf('manageengine.cn/sccm-third-party-patch-management/')>-1){
  product="PatchConnect"
}else if(str.indexOf('manageengine.cn/products/support-center/')>-1){
  product="SCP"
}else if(str.indexOf('manageengine.cn/desktop-management-msp/')>-1){
  product="DC-MSP"
}else if(str.indexOf('manageengine.cn/products/oputils/')>-1){
  product="oputils"
}else if(str.indexOf('manageengine.cn/active-directory-360/')>-1){
  product="AD360"
}else if(str.indexOf('manageengine.cn/data-security/')>-1){
  product="DSP"
}else if(str.indexOf('patch.manageengine.cn/')>-1){
  product="Patch"
}
else if(str.indexOf('store.manageengine.cn/')>-1){
  product="MEStore"
}
else if(str.indexOf('blogs.manageengine.cn/')>-1){
  product="Blogs"
}
else if(str.indexOf('manageengine.cn/passwordmanagerpro/')>-1){
  product="PMP"
}
else if(str.indexOf('manageengine.cn/products/')>-1){
  product=str.split('www.manageengine.cn/products/')[1].split('/')[0]
}
else{
    /***
    If none of the Above condition is valid, Then the URL is parsed and the directory after over domain is considered product Here
    ***/
  tmpStr=str.split('.manageengine.cn/')[1]
  if(tmpStr.indexOf('/')>-1){
    product = tmpStr.split('/')[0]
  }
  else if(tmpStr.indexOf('.')>-1){
    product = tmpStr.split('.')[0]
  }
  else{
    product='ME'
  }
}
  return product

}

/***

To extract the Domain from a URL after striping the domain name extensions, such as .com, .net etc

***/


function extractDomain(url) {
    var domain;
    if (url.indexOf("://") > -1){
      if(url.indexOf("manageengine.com/")>-1){
        domain = "ME.com"
      }
      else{
      if (url.indexOf("://www") > -1) { domain = url.split('.')[1]; }
      else { domain = url.split('/')[2]; }
      }
    }
    else { domain = url.split('/')[0]; }
    domain = domain.split(':')[0];
    return domain;
  }
/***

To check Whether the traffic is from Baidu

***/
function getBaidu(){
var ref = document.referrer;
var pageURL = document.URL;
if(pageURL.indexOf('utm_source=Baidu&utm_medium=cpc')>-1){
return "BaiduAds"
}
else if(ref.indexOf('.baidu.com/baidu.php')>-1){
    return "BaiduAds"
}
else if(ref.indexOf('.baidu.com')>-1){
    return "Baidu"
}

}


function isNotEmpty(varName){
var response = true;
if(varName=="" || varName==undefined){
    response = false;
}
return response;
}
/***

To set the  ME-CN-MarkFullSrc


***/
function setME_CN_MarkFullSrc(){
  dt_stat ="";
  var ref = document.referrer, cookie = "", firstdat = [], bcookie, finalVal, lastdat = [], prdt = getProduct();
   ref = extractDomain(ref);
  sourceCookie=getSrcCookie("ME-CN-MarkSrc")
  if(isNotEmpty(sourceCookie)){
  console.log("sourceCookie!=undefined")
    cookie = sourceCookie;
    if(cookie.length > 1000){
    console.log("cookie.length > 1000")
      cookie = cookie.split('|');
      first = cookie[0];
      var c = cookie.length
      cookie = first + "|" + cookie[c-1];
    }
    var checkQu = cookie.indexOf('"')
    if(cookie.indexOf('"') > -1) {
      var getnewStr = cookie.replace('"','');
      getnewStr = getnewStr.replace('"','');
      bcookie = getnewStr;
      cookie = getnewStr + "|" ;
    }else{ console.log("Else 1");
    bcookie = sourceCookie; cookie = sourceCookie + "|" ; }
    var last = cookie.split('|');
    var l = last.length;
    last = last[l-2];
    lastdat = last.split(':');
  }else{
  console.log("Else 2")
    if(isNotEmpty(ref!=undefined)){
    console.log("ref!=undefined")
    lastdat[0]= ref; }
    else{
    console.log("Else 3");lastdat[0]= directTraffic(); }
    lastdat[1] = prdt;
    bcookie = lastdat[0]+":"+lastdat[1];
  }
  if(isNotEmpty(directTraffic())){
  console.log("directTraffic()")
  if(  lastdat[0].indexOf('direct') === 0 && lastdat[1].indexOf(prdt) === -1){  //direct traffic & diff product
  console.log("direct traffic & diff product")
    dt_stat = directTraffic()+":"+prdt;
    finalVal = cookie+dt_stat;
  }else if(lastdat[0].indexOf('direct') === 0 && lastdat[1].indexOf(prdt) > -1){  //direct traffic & same product
  console.log("direct traffic & same product")
    finalVal = bcookie;
  }else if(lastdat[0].indexOf('direct') !== 0 ){  //If the current visit is direct but the previous one is not
    console.log("If the current visit is direct but the previous one is not")
    if(cookie == ""){ //If the cookie is blank
    console.log("If the cookie is blank ")
      dt_stat = ((cookie == "") ? directTraffic(): lastdat[0])+":"+prdt;
    } else {  //no blank cookie
    console.log("no blank cookie")
      dt_stat = "direct:"+getProduct();
    } finalVal = cookie+dt_stat;
  }
  }
    else if(isNotEmpty(getBaidu())){ //  Check if the traffic is Baidu
    dt_stat = getBaidu()+":"+prdt;
    finalVal = cookie+dt_stat;
  }else {                // If the traffic is not direct(no referrer - URL Loading) and not baidu then the domain of the referrer is set as referrer.
    dt_stat = ref+":"+prdt;
    finalVal = cookie+dt_stat;
  }
  firstdat = dt_stat.split(':');
  if ((getSrcCookie("ME-CN-MarkFullSrc") && (lastdat[0] != firstdat[0] || lastdat[1] != firstdat[1]) && ref!='manageengine' && ref!='crm.zoho.com.cn') || !isNotEmpty(getSrcCookie("ME-CN-MarkSrc"))) {
    createCookie("ME-CN-MarkFullSrc",'"'+finalVal+'"',90);
  }
}

function getUserFls(){
var myprod = getProduct(), interactions = getSrcCookie("ME-CN-MarkFullSrc"), proccessedIntr = [];
  if(interactions.indexOf('"') > -1) {
    var getnewStr = interactions.replace('"','');
    getnewStr = getnewStr.replace('"','');
    interactions = getnewStr;
  } interactions = interactions.split('|')
  for(var ind=0;ind<interactions.length;ind++){
    if(interactions[ind].indexOf("_") == -1){
        proccessedIntr.push(interactions[ind]);
    }
  }
  var source =  proccessedIntr;
  var l = source.length, fSource = "", leSource = "", laSource = "";
  if (source[0] != undefined || source[0] != "" ) {
    fSource = source[0];
    for(var i=0; i<l; i++) {
      currSource = source[i];
      if (currSource.indexOf(myprod) > -1) {
          leSource = source[i];
          break;
      }
    }
    laSource = source[l-1];
  } else laSource = interactions;
  flSource = fSource+"|"+leSource+"|"+laSource;
createCookie("ME-CN-MarkSrc",'"'+flSource+'"');
return flSource;

}
function setMarketingReferralURL(){
var ref= document.referrer.substring(0,100);  // Get the referrer and only the first 300 characters is considered due to limitation in CRM field
var pageURL = document.URL.substring(0,500);  // Get the Current URL and only the first 300 characters is considered due to limitation in CRM field
if(!getSrcCookie("ME-CN-MarkRefURL")){
    refval = ref+"&&@&&"+pageURL
    createCookie("ME-CN-MarkRefURL",'"'+refval+'"');
    return refval;

}

}
  setME_CN_MarkFullSrc();
  getSrcCookie("ME-CN-MarkSrc");
  getUserFls();
setMarketingReferralURL();
</script>

</body>
</html>
