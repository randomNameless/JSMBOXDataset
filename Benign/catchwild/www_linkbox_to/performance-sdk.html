<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>performance-sdk.html</title>
</head>
<body>

<script>
function randomString(len){len=len||10;var $chars="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz123456789",maxPos=$chars.length,pwd="";for(let i=0;i<len;i++)pwd+=$chars.charAt(Math.floor(Math.random()*maxPos));return pwd+(new Date).getTime()}function Performance(option,fn){try{var filterUrl=["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/"];let opt={domain:"http://localhost/api",outtime:300,filterUrl:[],isPage:!0,isAjax:!0,isResource:!0,isError:!0,add:{}};opt=Object.assign(opt,option),opt.filterUrl=opt.filterUrl.concat(filterUrl);let conf={resourceList:[],performance:{},errorList:[],fetchNum:0,loadNum:0,ajaxLength:0,fetLength:0,ajaxMsg:{},goingType:"",haveAjax:!1,haveFetch:!1,preUrl:document.referrer&&document.referrer!==location.href?document.referrer:"",page:""};var errordefo={t:"",n:"js",msg:"",data:{}};let beginTime=(new Date).getTime(),loadTime=0,ajaxTime=0,fetchTime=0;function reportData(type){setTimeout(()=>{!opt.isPage||window.performance&&(markuser=performance.timing,conf.performance={dnst:markuser.domainLookupEnd-markuser.domainLookupStart||0,tcpt:markuser.connectEnd-markuser.connectStart||0,wit:markuser.responseStart-markuser.navigationStart||0,domt:markuser.domContentLoadedEventEnd-markuser.navigationStart||0,lodt:markuser.loadEventEnd-markuser.navigationStart||0,radt:markuser.fetchStart-markuser.navigationStart||0,rdit:markuser.redirectEnd-markuser.redirectStart||0,uodt:markuser.unloadEventEnd-markuser.unloadEventStart||0,reqt:markuser.responseEnd-markuser.requestStart||0,andt:markuser.domComplete-markuser.domInteractive||0}),(opt.isResource||opt.isAjax)&&function(){if(window.performance&&window.performance.getEntries){let resource=performance.getEntriesByType("resource"),resourceList=[];if(!resource&&!resource.length)return resourceList;resource.forEach(ajaxMsg=>{if((opt.isAjax||"xmlhttprequest"!=ajaxMsg.initiatorType&&"fetchrequest"!=ajaxMsg.initiatorType)&&(opt.isResource||"xmlhttprequest"==ajaxMsg.initiatorType||"fetchrequest"===ajaxMsg.initiatorType)){let json={name:ajaxMsg.name,method:"GET",type:ajaxMsg.initiatorType,duration:ajaxMsg.duration.toFixed(2)||0,decodedBodySize:ajaxMsg.decodedBodySize||0,nextHopProtocol:ajaxMsg.nextHopProtocol};ajaxMsg=ajaxMsg.name?ajaxMsg.name.split("?")[0]:"",ajaxMsg=conf.ajaxMsg[ajaxMsg]||"";ajaxMsg&&(json.method=ajaxMsg.method||"GET",json.type=ajaxMsg.type||json.type,json.decodedBodySize=json.decodedBodySize||ajaxMsg.decodedBodySize),resourceList.push(json)}}),conf.resourceList=resourceList}}(),ERRORLIST&&ERRORLIST.length&&(conf.errorList=conf.errorList.concat(ERRORLIST));var w=document.documentElement.clientWidth||document.body.clientWidth,h=document.documentElement.clientHeight||document.body.clientHeight,markuser=function(){var markUser=sessionStorage.getItem("ps_markUser")||"";let result={markUser:markUser,isFristIn:!1};return markUser||(markUser=randomString(),sessionStorage.setItem("ps_markUser",markUser),result.markUser=markUser,result.isFristIn=!0),result}();let result={time:(new Date).getTime(),addData:ADDDATA,markUser:markuser.markUser,markUv:function(){const date=new Date;let markUv=localStorage.getItem("ps_markUv")||"";var datatime=localStorage.getItem("ps_markUvTime")||"",today=date.getFullYear()+"/"+(date.getMonth()+1)+"/"+date.getDate()+" 23:59:59";return(!markUv&&!datatime||date.getTime()>+datatime)&&(markUv=randomString(),localStorage.setItem("ps_markUv",markUv),localStorage.setItem("ps_markUvTime",new Date(today).getTime())),markUv}(),type:type,url:location.href};!function(){let reslist=conf.resourceList;var filterUrl=opt.filterUrl;let newlist=[];if(reslist&&reslist.length&&filterUrl&&filterUrl.length)for(let i=0;i<reslist.length;i++){let begin=!1;for(let j=0;j<filterUrl.length;j++)if(-1<reslist[i].name.indexOf(filterUrl[j])){begin=!0;break}begin||newlist.push(reslist[i])}conf.resourceList=newlist}(),1===type?result=Object.assign(result,{preUrl:conf.preUrl,errorList:conf.errorList,performance:conf.performance,resourceList:conf.resourceList,isFristIn:markuser.isFristIn,screenwidth:w,screenheight:h}):2===type?result=Object.assign(result,{resourceList:conf.resourceList,errorList:conf.errorList}):3===type&&(result=Object.assign(result,{errorList:conf.errorList,resourceList:conf.resourceList})),result=Object.assign(result,opt.add),fn&&fn(result),!fn&&window.fetch&&fetch(opt.domain,{method:"POST",headers:{"Content-Type":"application/json"},type:"report-data",body:JSON.stringify(result)}),Promise.resolve().then(()=>{clear()})},opt.outtime)}function getLargeTime(){conf.page!==location.href?(conf.haveAjax&&conf.haveFetch&&loadTime&&ajaxTime&&fetchTime||conf.haveAjax&&!conf.haveFetch&&loadTime&&ajaxTime||!conf.haveAjax&&conf.haveFetch&&loadTime&&fetchTime||!conf.haveAjax&&!conf.haveFetch&&loadTime||loadTime)&&reportData(1):(conf.haveAjax&&conf.haveFetch&&ajaxTime&&fetchTime||conf.haveAjax&&!conf.haveFetch&&ajaxTime||!conf.haveAjax&&conf.haveFetch&&fetchTime)&&reportData(2)}function ajaxResponse(xhr){let defaults=Object.assign({},errordefo);defaults.t=(new Date).getTime(),defaults.n="ajax",defaults.msg=xhr.statusText||"ajax request error",defaults.method=xhr.method,defaults.data={resourceUrl:xhr.responseURL,text:xhr.statusText,status:xhr.status},conf.errorList.push(defaults)}function getFetchTime(){conf.fetchNum+=1,conf.fetLength===conf.fetchNum&&(conf.fetchNum=conf.fetLength=0,fetchTime=(new Date).getTime()-beginTime,getLargeTime())}function getAjaxTime(){conf.loadNum+=1,conf.loadNum===conf.ajaxLength&&(conf.ajaxLength=conf.loadNum=0,ajaxTime=(new Date).getTime()-beginTime,getLargeTime())}function clearPerformance(){window.performance&&window.performance.clearResourceTimings&&(conf.haveAjax&&conf.haveFetch&&0==conf.ajaxLength&&0==conf.fetLength||!conf.haveAjax&&conf.haveFetch&&0==conf.fetLength||conf.haveAjax&&!conf.haveFetch&&0==conf.ajaxLength)&&clear(1)}function clear(type){window.performance&&window.performance.clearResourceTimings&&performance.clearResourceTimings(),conf.performance={},conf.errorList=[],conf.preUrl="",conf.resourceList=[],conf.page=0===type?location.href:"",conf.haveAjax=!1,conf.haveFetch=!1,conf.ajaxMsg={},ERRORLIST=[],ADDDATA={},ajaxTime=0,fetchTime=0}opt.isError&&function(){window.addEventListener("error",function(e){let defaults=Object.assign({},errordefo);defaults.n="resource",defaults.t=(new Date).getTime(),defaults.msg=e.target.localName+" is load error",defaults.method="GET",defaults.data={target:e.target.localName,type:e.type,resourceUrl:e.target.href||e.target.currentSrc},e.target!=window&&conf.errorList.push(defaults)},!0),window.onerror=function(msg,_url,line,col,error){let defaults=Object.assign({},errordefo);setTimeout(function(){col=col||window.event&&window.event.errorCharacter||0,defaults.msg=error&&error.stack?error.stack.toString():msg,defaults.method="GET",defaults.data={resourceUrl:_url,line:line,col:col},defaults.t=(new Date).getTime(),conf.errorList.push(defaults),conf.page!==location.href||conf.haveAjax||reportData(3)},0)},window.addEventListener("unhandledrejection",function(message){var error=message&&message.reason,message=error.message||"";const stack=error.stack||"";let resourceUrl,col,line,errs=stack.match(/\(.+?\)/);if(errs&&errs.length&&(errs=errs[0]),errs){errs=errs.replace(/\w.+[js|html]/g,$1=>(resourceUrl=$1,"")),errs=errs.split(":"),errs&&1<errs.length&&(line=parseInt(errs[1]||0)),col=parseInt(errs[2]||0);let defaults=Object.assign({},errordefo);defaults.msg=message,defaults.method="GET",defaults.t=(new Date).getTime(),defaults.data={resourceUrl:resourceUrl,line:col,col:line},conf.errorList.push(defaults),conf.page!==location.href||conf.haveAjax||reportData(3)}});const oldError=console.error;console.error=function(e){let defaults=Object.assign({},errordefo);return setTimeout(function(){defaults.msg=e,defaults.method="GET",defaults.t=(new Date).getTime(),defaults.data={resourceUrl:location.href},conf.errorList.push(defaults),conf.page!==location.href||conf.haveAjax||reportData(3)},0),oldError.apply(console,arguments)}}(),addEventListener("load",function(){loadTime=(new Date).getTime()-beginTime,getLargeTime()},!1),(opt.isAjax||opt.isError)&&function(){if(window.fetch){let _fetch=fetch;window.fetch=function(){var url;const result=function(arg){let result={method:"GET",type:"fetchrequest"},args=Array.prototype.slice.apply(arg);if(!args||!args.length)return result;try{1===args.length?"string"==typeof args[0]?result.url=args[0]:"object"==typeof args[0]&&(result.url=args[0].url,result.method=args[0].method):(result.url=args[0],result.method=args[1].method||"GET",result.type=args[1].type||"fetchrequest")}catch(err){}return result}(arguments);return"report-data"!==result.type&&(clearPerformance(),url=result.url?result.url.split("?")[0]:"",conf.ajaxMsg[url]=result,conf.fetLength=conf.fetLength+1,conf.haveFetch=!0),_fetch.apply(this,arguments).then(res=>{if("report-data"===result.type)return res;try{var url=res.url?res.url.split("?")[0]:"";res.clone().text().then(data=>{conf.ajaxMsg[url]&&(conf.ajaxMsg[url].decodedBodySize=data.length)})}catch(e){}return getFetchTime(),res}).catch(err=>{if("report-data"!==result.type){getFetchTime();let defaults=Object.assign({},errordefo);return defaults.t=(new Date).getTime(),defaults.n="fetch",defaults.msg="fetch request error",defaults.method=result.method,defaults.data={resourceUrl:result.url,text:err.stack||err,status:0},conf.errorList.push(defaults),err}})}}}(),(opt.isAjax||opt.isError)&&(proxy={onreadystatechange:function(xhr){4===xhr.readyState&&setTimeout(()=>{if("load"!==conf.goingType){conf.goingType="readychange";var responseURL=xhr.xhr.responseURL?xhr.xhr.responseURL.split("?")[0]:"";if(conf.ajaxMsg[responseURL]){try{xhr.xhr.response instanceof Blob?conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.response.size:conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.responseText.length}catch(err){}getAjaxTime()}(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr))}},600)},onerror:function(xhr){xhr.args&&(xhr.method=xhr.args.method,xhr.responseURL=xhr.args.url,xhr.statusText="ajax request error",conf.ajaxMsg[xhr.responseURL]&&getAjaxTime()),ajaxResponse(xhr)},onload:function(xhr){if(4===xhr.readyState&&"readychange"!==conf.goingType){conf.goingType="load";var responseURL=xhr.xhr.responseURL?xhr.xhr.responseURL.split("?")[0]:"";if(conf.ajaxMsg[responseURL]){try{xhr.xhr.response instanceof Blob?conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.response.size:conf.ajaxMsg[responseURL].decodedBodySize=xhr.xhr.responseText.length}catch(err){}getAjaxTime()}(xhr.status<200||300<xhr.status)&&(xhr.method=xhr.args.method,ajaxResponse(xhr))}},open:function(arg,xhr){if(opt.filterUrl&&opt.filterUrl.length){let begin=!1;if(opt.filterUrl.forEach(item=>{-1!=arg[1].indexOf(item)&&(begin=!0)}),begin)return}var result={url:arg[1].split("?")[0],method:arg[0]||"GET",type:"xmlhttprequest"};this.args=result,clearPerformance(),conf.ajaxMsg[result.url]=result,conf.ajaxLength=conf.ajaxLength+1,conf.haveAjax=!0}},window._ahrealxhr=window._ahrealxhr||XMLHttpRequest,XMLHttpRequest=function(){for(var attr in this.xhr=new window._ahrealxhr,this.xhr){var type="";try{type=typeof this.xhr[attr]}catch(e){}"function"===type?this[attr]=function(fun){return function(){var args=[].slice.call(arguments);if(!proxy[fun]||!proxy[fun].call(this,args,this.xhr))return this.xhr[fun].apply(this.xhr,args)}}(attr):Object.defineProperty(this,attr,{get:function(attr){return function(){var v=this.hasOwnProperty(attr+"_")?this[attr+"_"]:this.xhr[attr],attrGetterHook=(proxy[attr]||{}).getter;return attrGetterHook&&attrGetterHook(v,this)||v}}(attr),set:function(attr){return function(v){var xhr=this.xhr,that=this,attrSetterHook=proxy[attr];if("function"==typeof attrSetterHook)xhr[attr]=function(){proxy[attr](that)||v.apply(xhr,arguments)};else{attrSetterHook=(attrSetterHook||{}).setter;v=attrSetterHook&&attrSetterHook(v,that)||v;try{xhr[attr]=v}catch(e){this[attr+"_"]=v}}}}(attr)})}},window._ahrealxhr)}catch(err){}var proxy}"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?module.exports=Performance:window.Performance=Performance,window.ERRORLIST=[],window.ADDDATA={},Performance.addError=function(err){err={method:"GET",msg:err.msg,n:"js",data:{col:err.col,line:err.line,resourceUrl:err.resourceUrl}},ERRORLIST.push(err)},Performance.addData=function(fn){fn&&fn(ADDDATA)};
</script>

</body>
</html>
