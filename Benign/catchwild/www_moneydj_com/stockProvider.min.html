<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stockProvider.min.html</title>
</head>
<body>

<script>
(function(h,p){var m=function(){this._MinReg={};this.T=[]};m.prototype={_MinReg:null,T:null,startIdx:0,TradeTime:"09001330",DP:2,Date:"",Exch:"",U:0,D:0,PC:0,CI:0,SF:0,P:0,PT:"",getMin:function(a){return this._MinReg[a]},setMin:function(a,c){var b;this._MinReg[a]?(b=this._MinReg[a],c.I=b.I):(this.T.push(a),c.I=this.T.length-1);this._MinReg[a]=c;return c.I}};window.stockProvider={_path_basic:"/ModeDataSvc/getdata.aspx?dataver=1&opcode=0&a={ID}&b={CODE}&c={EXID}&xyz=1234",_path_bcd:"/funddj/djxml/proxyHandlerXQ.djxml?src={X}$${ID}",
_file_worker:"timerWorker.js",_cache:{},_cacheActCall:{},_timer:{},_notify:{},_worker:null,_delaySleep:18E5,_delayPull:3E4,_isInit:0,_isNextDate:0,_isIE:function(){return h.browser.msie},_exchMap:{1:"TW",TW:"1",2:"TE",TE:"2",3:"TF",TF:"3",4:"SG",SG:"4",5:"FX",FX:"5",6:"FS",FS:"6",7:"HK",HK:"7",8:"SH",SH:"8",9:"SZ",SZ:"9",10:"KS",KS:"10",11:"JP",JP:"11",12:"US",US:"12",13:"WS",WS:"13",16:"CB",CB:"16",17:"DJ",DJ:"17",18:"SW",SW:"18"},_exch_mapping:function(a){a=a.toUpperCase();var c={sID:a,exchID:"1",
exchCode:"TW"},b=a.split(".");a=a.split(",");2==b.length?(c.sID=b[0],c.exchCode=b[1],c.exchID=this._exchMap[b[1]]):2==a.length&&(c.sID=a[0],c.exchID=a[1],c.exchCode=this._exchMap[a[1]]);return c},_fmt_stockID:function(a){a=this._exch_mapping(a);return a.sID+","+a.exchID},_init:function(){var a=this;if(!a._isInit&&!a._worker&&window.Worker){a._isInit=1;var c=h('script[src$="'+a._file_worker+'"]'),b="";1==c.length&&(b=c.attr("src"));b&&(a._worker=new Worker(b),a._worker.addEventListener("message",function(c){c=
c.data;var b=c.key;1===c.cmd&&h.isFunction(a._notify[b])&&a._notify[b].apply(a)}))}},_clearInterval:function(a){this._worker?this._worker.postMessage({cmd:0,key:a}):this._timer[a]&&(clearInterval(this._timer[a]),delete this._timer[a])},_resetInterval:function(a,c,b){this._clearInterval(a);this._worker?(this._notify[a]=c,this._worker.postMessage({cmd:1,key:a,delay:b})):this._timer[a]=setInterval(c,b)},_emptyInterval:function(){var a=this;a._worker?a._worker.postMessage({cmd:-1}):h.each(a._timer,function(c){a._clearInterval(c)})},
_xml_attr2obj:function(a,c){c||(c={});if(!a||null==a)return c;a.attributes&&h.each(a.attributes,function(a,f){c[f.name]=f.value});return c},_getXml:function(a,c){if(1.4<=parseFloat(h.fn.jquery)&&!this._isIE())h.get(a,null,c,"xml");else{var b=new XMLHttpRequest;b.open("GET",a,!0);b.send();b.onload=b.onreadystatechange!==p?b.onreadystatechange=function(){if(4==this.readyState||"complete"==this.readyState)c(b.responseXML),b.onload=b.onreadystatechange=null,b.abort(),b=null}:function(a){c(a.target.responseXML);
b.abort();b=null}}},_setTradeTime:function(a,c,b,f){var d=this,e=d._exch_mapping(a),l=d._fmt_stockID(a),k=d._path_basic.replace("{ID}",e.sID+"."+e.exchCode).replace("{CODE}",e.exchCode).replace("{EXID}",e.exchID);d._getXml(k,function(g){g=h(g);var j=d._xml_attr2obj(g.find("Exch")[0],{}),j=d._xml_attr2obj(g.find("Exch Item")[0],j);j.TradeTime||"1"===e.exchID?(j.TradeTime&&(c.TradeTime=j.TradeTime),j.DP&&(c.DP=+j.DP),b(c)):(f(c),d._resetInterval(l,function(){d._setTradeTime(a,c,b,f)},d._delayPull,"_setTradeTime"))})},
_setPC:function(a,c,b,f){var d=this;d._exch_mapping(a);var e=d._fmt_stockID(a),l=d._path_bcd.replace("{NUM}",0).replace("{ID}",e).replace("{X}",1).replace("{B}",0),k=Math.pow(10,c.DP);d._getXml(l,function(g){g=h(g);g=d._xml_attr2obj(g.find("Data")[0],{});g.PC?(c.Date=g.Date,c.U=Math.round(+g.U)/k,c.D=Math.round(+g.D)/k,c.PC=Math.round(+g.PC)/k,c.P=Math.round(+g.P)/k,c.PT=g.T,b(c)):(f(c),d._resetInterval(e,function(){d._setPC(a,c,b,f)},d._delayPull,"_setPC"))})},_setBCD:function(a,c,b){var f=this;
f._exch_mapping(a);a=f._fmt_stockID(a);a=f._path_bcd.replace("{NUM}",c.CI).replace("{ID}",a).replace("{X}",8).replace("{B}",1);var d=Math.pow(10,c.DP),e;f._getXml(a,function(a){var k=h(a);a=f._xml_attr2obj(k.find("Data")[0],{});var k=k.find("Data Row").text().split(";"),g,j,n=-1;h.each(k,function(a,b){b=b.split(",");g={T:b[0],O:NaN,C:NaN,H:NaN,L:NaN,V:NaN};5<b.length&&(g.C=j=parseInt(b[1])/d,g.O="-"==b[2]?j:j+parseInt(b[2])/d,g.H="-"==b[3]?j:j+parseInt(b[3])/d,g.L="-"==b[4]?j:j+parseInt(b[4])/d,g.V=
parseInt(b[5]));g.T&&(n++,e=c.setMin(g.T,g));0===n&&(c.startIdx=e)});c.CI=parseInt(a.CurrentIdx);c.SF=parseInt(a.SF);b(c)})},_sleeping:function(a,c){var b=this,f=b._fmt_stockID(a),d=b._cache[f],e=d.Date;c||(c=b._delaySleep);b._resetInterval(f,function(){b._setBCD(a,d,function(){d.Date!==e&&(b._isNextDate=1);b._isNextDate&&"0"==d.SF&&(b._isNextDate=0,b._cache[f]&&delete b._cache[f],b.setID(a,b._cacheActCall[f]))},"_sleeping")},c,"_sleeping")},_pulling:function(a,c,b){var f=this,d=f._fmt_stockID(a),
e=f._cache[d];b||(b=f._delayPull);!e||"1"==e.SF?f._sleeping(a):f._resetInterval(d,function(){"1"==e.SF?f._sleeping(a):f._setBCD(a,e,function(){var a={T:[],O:[],H:[],L:[],C:[],V:[]};h.each(e.T.slice(e.startIdx),function(b,c){var d=e.getMin(c);a.T.push(d.T);a.O.push(d.O);a.H.push(d.H);a.L.push(d.L);a.C.push(d.C);a.V.push(d.V)});c(a)},"_pulling")},b,"_pulling")},setID:function(a,c){var b=this,f=function(){},d=b._fmt_stockID(a),e=b._cache[d]=new m,l=function(){var a={TradeTime:e.TradeTime,DP:e.DP,U:e.U,
D:e.D,PC:e.PC,Exch:e.Exch,SF:e.SF,Date:e.Date,P:e.P,PT:e.PT,T:[],O:[],H:[],L:[],C:[],V:[]};h.each(e.T,function(b,c){var d=e.getMin(c);a.T.push(d.T);a.O.push(d.O);a.H.push(d.H);a.L.push(d.L);a.C.push(d.C);a.V.push(d.V)});c.success(a)};c=h.extend({success:f,fail:f,pulling:null},c);0<c.delay&&(b._delayPull=c.delay);b._init();b._emptyInterval();b._cacheActCall[d]=c;b._setTradeTime(a,e,function(){b._setPC(a,e,function(){b._setBCD(a,e,function(){l();h.isFunction(c.pulling)&&b._pulling(a,c.pulling,b._delayPull)},
"setID")},function(){l()})},function(){c.fail()})},stop:function(a){a=this._fmt_stockID(a);this._clearInterval(a)},disposed:function(){this._emptyInterval();this._timer={};this._cache={};this._notify={};this._cacheActCall={}}}})(jQuery);
</script>

</body>
</html>
