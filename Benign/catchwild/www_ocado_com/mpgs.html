<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mpgs.html</title>
</head>
<body>

<script>
(function(document,jQ,webshop){webshop=webshop||{};webshop.mastercardCheckout=webshop.mastercardCheckout||{};var paymentEndpoints={braintree:'/webshop/api/v1/payments/braintree',braintreeContext:'/webshop/api/v1/payments/add-payment-context/braintree',};var masterCardRedirectSources={accountSettings:'ACCOUNT_SETTINGS',checkout:'CHECKOUT',failedPaymets:'FAILED_PAYMENTS',deliveryPass:'DELIVERY_PASS',};var mastercardStatuses={initialized:'INITIALIZED',configured:'CONFIGURED',redirecting:'REDIRECTING',complete:'COMPLETE',error:'ERROR',cancelled:'CANCELLED',};var mastercardRedirectUrls={paymentDetails:'/settings/payment-details',btFundingInstrument:'/webshop/addBraintreeFundingInstrument.go',checkout:'/webshop/setupHPPCheckout.go',failedPaymentsFirstStep:'/webshop/getFailedPaymentOrders.go',deliveryPass:'/webshop/deliveryPassDetails.do',checkoutBasketStep:'/webshop/displaySmartBasketCheckout.do',checkoutValidateVoucherStep:'/webshop/checkoutValidateOrder.do'};webshop.mastercardCheckout={statuses:mastercardStatuses,redirectUrls:mastercardRedirectUrls,redirectSources:masterCardRedirectSources,status:null,redirectedFrom:null,isInCheckout:false,isMPGSCancel:false,isPaymentWalletEmpty:false,merchant:null,isAfterMastercardPage:false,hasPaymentErrors(){var error=/paymentErrors=([^&]+)/.exec(window.location.search);if(error){return error[1];}
return false;},isInitialized(){return webshop.mastercardCheckout.status&&webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.initialized;},isConfigured(){return webshop.mastercardCheckout.status&&webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.configured;},isComplete(){return webshop.mastercardCheckout.status&&webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.complete;},isError(){return!webshop.mastercardCheckout.status||webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.error;},setStatus(status){webshop.mastercardCheckout.status=status;},setRedirectSource(source){if(source){webshop.mastercardCheckout.redirectedFrom=source;return;}
if(webshop.mastercardCheckout.isInCheckout){webshop.mastercardCheckout.redirectedFrom=webshop.mastercardCheckout.redirectSources.checkout;return;}
if(window.location.href.includes('/webshop/setupHPPRepaymentsOrders.go')){webshop.mastercardCheckout.redirectedFrom=webshop.mastercardCheckout.redirectSources.failedPaymets;return;}
if(window.location.href.includes('/webshop/addPaymentSettings.go')){webshop.mastercardCheckout.redirectedFrom=webshop.mastercardCheckout.redirectSources.accountSettings;return;}
webshop.mastercardCheckout.redirectedFrom=webshop.mastercardCheckout.redirectSources.deliveryPass;},configure(){if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"configuration started",level:"info",});}
var paymentErrors=webshop.mastercardCheckout.hasPaymentErrors();if(paymentErrors){webshop.mastercardCheckout.setRedirectSource();webshop.mastercardCheckout.onError(paymentErrors);return false;}
if(!webshop.mastercardCheckout.isInitialized()){const error={error:{explanation:'Mastercard service is not initialized',isCheckoutObjPresent:!!window.Checkout,status:webshop.mastercardCheckout.status,}}
webshop.mastercardCheckout.onError(error);return false;}
if(window.Checkout&&webshop.mastercardCheckout.isInitialized()){Checkout.configure({session:webshop.mastercardCheckout.session,order:{description:'Adding card'},interaction:{merchant:{logo:webshop.mastercardCheckout.merchant.logo,name:'Wm Morrison Supermarkets Limited',},locale:'en_GB',operation:'NONE',displayControl:{billingAddress:'HIDE',customerEmail:'HIDE',shipping:'HIDE'},}});if(webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.initialized&&!webshop.mastercardCheckout.isAfterMastercardPage){webshop.mastercardCheckout.setRedirectSource();webshop.mastercardCheckout.setStatus(webshop.mastercardCheckout.statuses.configured);if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"configuration succeeded",level:"info",});}}}else{const error={error:{explanation:'Mastercard service is not initialized',isCheckoutObjPresent:!!window.Checkout,status:webshop.mastercardCheckout.status,}}
webshop.mastercardCheckout.onError(error);return false;}
return true;},getRedirectUrl(){if(webshop.mastercardCheckout.redirectedFrom===webshop.mastercardCheckout.redirectSources.checkout){if(webshop.mastercardCheckout.isMPGSCancel&&webshop.mastercardCheckout.isPaymentWalletEmpty){if(localStorage.getItem('isRedirectedFromVoucherStep')){return webshop.mastercardCheckout.redirectUrls.checkoutValidateVoucherStep;}else{return webshop.mastercardCheckout.redirectUrls.checkoutBasketStep;}}
return webshop.mastercardCheckout.redirectUrls.checkout;}
if(webshop.mastercardCheckout.redirectedFrom===webshop.mastercardCheckout.redirectSources.failedPaymets){return webshop.mastercardCheckout.redirectUrls.failedPaymentsFirstStep;}
if(webshop.mastercardCheckout.redirectedFrom===webshop.mastercardCheckout.redirectSources.accountSettings){return webshop.mastercardCheckout.redirectUrls.paymentDetails;}
return webshop.mastercardCheckout.redirectUrls.deliveryPass;},onCancel(){var redirectedFrom=localStorage.getItem('redirectedFrom');if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"onCancel",data:{redirectedFrom,},level:"info",});}
webshop.mastercardCheckout.setRedirectSource(redirectedFrom);webshop.mastercardCheckout.isMPGSCancel=true;webshop.mastercardCheckout.setStatus(webshop.mastercardCheckout.statuses.cancelled);this.showStatusMessage();this.redirect(this.getRedirectUrl());},onComplete(){var clientTokenValue=localStorage.getItem('clientTokenValue');var redirectedFrom=localStorage.getItem('redirectedFrom');if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"onComplete",data:{clientTokenValue,redirectedFrom,},level:"info",});}
webshop.mastercardCheckout.setStatus(webshop.mastercardCheckout.statuses.complete);webshop.mastercardCheckout.isAfterMastercardPage=true;webshop.mastercardCheckout.setRedirectSource(redirectedFrom);if(this.isComplete()){var self=this;if(redirectedFrom===webshop.mastercardCheckout.redirectSources.checkout||redirectedFrom===webshop.mastercardCheckout.redirectSources.failedPaymets){webshop.mastercardCheckout.redirect(webshop.mastercardCheckout.redirectUrls.btFundingInstrument+'?payloadNonce='+clientTokenValue);}else{jQ.ajax({type:'POST',url:paymentEndpoints.braintree,data:JSON.stringify({payloadNonce:clientTokenValue}),contentType:'application/json',success(){self.showStatusMessage();self.redirect(webshop.mastercardCheckout.getRedirectUrl());},error(request,status,error){const errorObj={error:{explanation:'Braintree call failed',reason:error,data:{payloadNonce:clientTokenValue},}}
self.onError(errorObj);},});}}else{this.redirect(this.getRedirectUrl());}},onError(error){webshop.mastercardCheckout.setStatus(webshop.mastercardCheckout.statuses.error);if(window.Sentry){var explanation=error.error&&error.error.explanation||error||'Error occurred';var err=new Error('[MasterCard]: '+explanation);Sentry.captureException(err,{extra:error.error});}
this.showStatusMessage();},onPageLoad(){if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"page loaded",level:"info",});}
if(webshop.mastercardCheckout.configure()===true){if(window.Checkout&&webshop.mastercardCheckout.isConfigured()){webshop.mastercardCheckout.showStatusMessage();webshop.mastercardCheckout.showPaymentPage();}else if(!window.Checkout||webshop.mastercardCheckout.isError()){const error={error:{explanation:'Mastercard service is not configured properly',isCheckoutObjPresent:!!window.Checkout,status:webshop.mastercardCheckout.status,}}
webshop.mastercardCheckout.onError(error);}}},init(session,merchant,isInCheckout,isPaymentWalletEmpty){if(window.Sentry){Sentry.addBreadcrumb({category:"MPGS",message:"initialize",data:{session,merchant,isInCheckout,isPaymentWalletEmpty,},level:"info",});}
webshop.mastercardCheckout.session=session;webshop.mastercardCheckout.merchant=merchant;webshop.mastercardCheckout.isInCheckout=isInCheckout;webshop.mastercardCheckout.isPaymentWalletEmpty=isPaymentWalletEmpty;webshop.mastercardCheckout.setStatus(webshop.mastercardCheckout.statuses.initialized);},showPaymentPage(){if(window.Checkout){Checkout.showPaymentPage();}},showStatusMessage(){var template='default';if(webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.complete){template='success';}
if(webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.cancelled){template='cancel'}
if(webshop.mastercardCheckout.status===webshop.mastercardCheckout.statuses.error){template='error';}
jQ(document).ready(function(){var html=jQ('#stored-payment-methods-mpgs-message-'+template).html();jQ('.stored-payment-methods-mpgs-message').html(html);if(template==='error'){jQ('.stored-payment-methods-mpgs_btn').click(function(){webshop.mastercardCheckout.redirect(webshop.mastercardCheckout.getRedirectUrl());});}});},redirect(redirectUrl){jQ(document).ready(function(){jQ('.stored-payment-methods-loader').show();setTimeout(function(){window.location=redirectUrl;},1000);});}};})(document,jQ,webshop);(function(document,jQ,webshop){webshop=webshop||{};webshop.mastercardThreeDS={correlationId:null,authenticatePayerRetries:0,authenticatePayerMaximumRetries:3,authenticatePayerRetryInterval:3500,mpgsParams:null,originalOrderId:null,isDeliveryPassOrder(){var deliveryPassPrefix='ODP';var orderHasDeliveryPassPrefix=webshop.mastercardThreeDS.originalOrderId&&webshop.mastercardThreeDS.originalOrderId.startsWith(deliveryPassPrefix);var isLongSessionId=webshop.mastercardThreeDS.mpgsParams.sessionId&&webshop.mastercardThreeDS.mpgsParams.sessionId.length>8;return orderHasDeliveryPassPrefix&&isLongSessionId;},configure(mpgsParams,originalOrderId,correlationId){if(window.ThreeDS){webshop.mastercardThreeDS.mpgsParams=mpgsParams;webshop.mastercardThreeDS.originalOrderId=originalOrderId;webshop.mastercardThreeDS.correlationId=correlationId;ThreeDS.configure({merchantId:webshop.mastercardThreeDS.mpgsParams.merchantId,sessionId:webshop.mastercardThreeDS.mpgsParams.sessionId,configuration:{userLanguage:"en-GB",wsVersion:webshop.mastercardThreeDS.mpgsParams.wsVersion,},callback(){if(ThreeDS.isConfigured()){webshop.mastercardThreeDS.initiateAuthentication();}else{webshop.mastercardThreeDS.redirectOnError();}}});}else{webshop.mastercardThreeDS.redirectOnError();}},getOrderId(){var deliveryPassSuffix='-';if(webshop.mastercardThreeDS.isDeliveryPassOrder()){var sessionId=webshop.mastercardThreeDS.mpgsParams.sessionId;var sessionIdLastEightCharacters=sessionId.substring(sessionId.length-8);return webshop.mastercardThreeDS.originalOrderId+deliveryPassSuffix+sessionIdLastEightCharacters;}else{return webshop.mastercardThreeDS.originalOrderId;}},initiateAuthentication(){var initiateAuthenticationOptionalParams={correlationId:webshop.mastercardThreeDS.correlationId,};ThreeDS.initiateAuthentication(webshop.mastercardThreeDS.getOrderId(),webshop.mastercardThreeDS.mpgsParams.transactionId,this.initiateAuthenticationCallback,initiateAuthenticationOptionalParams);},initiateAuthenticationCallback(data){if(data&&data.error){webshop.mastercardThreeDS.sendErrorToSentry(data.error);webshop.mastercardThreeDS.redirectOnError();}else{var isTheSameCorrelationId=data.correlationId==webshop.mastercardThreeDS.correlationId;if(isTheSameCorrelationId){switch(data.gatewayRecommendation){case"PROCEED":webshop.mastercardThreeDS.authenticatePayer();break;case"DO_NOT_PROCEED":webshop.mastercardThreeDS.redirectOnError();break;}}else{webshop.mastercardThreeDS.redirectOnError();}}},authenticatePayer(){var authenticatePayerOptionalParams={fullScreenRedirect:true,"authentication.challengePreference":webshop.mastercardThreeDS.mpgsParams.merchantPreference,device:{browserDetails:{screenHeight:screen.height,screenWidth:screen.width,},ipAddress:webshop.mastercardThreeDS.mpgsParams.customerIP,},customer:{email:webshop.info.CE,mobilePhone:webshop.mastercardThreeDS.mpgsParams.customerPhoneNumber,firstName:webshop.info.CFN,lastName:webshop.info.CLN,},};ThreeDS.authenticatePayer(webshop.mastercardThreeDS.getOrderId(),webshop.mastercardThreeDS.mpgsParams.transactionId,this.authenticatePayerCallback,authenticatePayerOptionalParams);},authenticatePayerCallback(data){if(data.error){if(webshop.mastercardThreeDS.authenticatePayerRetries<webshop.mastercardThreeDS.authenticatePayerMaximumRetries){webshop.mastercardThreeDS.authenticatePayerRetries+=1;setTimeout(function(){webshop.mastercardThreeDS.authenticatePayer();},webshop.mastercardThreeDS.authenticatePayerRetryInterval);}else{webshop.mastercardThreeDS.sendErrorToSentry(data.error);webshop.mastercardThreeDS.redirectOnError();}}},sendErrorToSentry(error){if(window.Sentry){var extra={cause:error.cause,field:error.field,validationType:error.validationType};Sentry.captureException(new Error('MasterCard Payment Gateway 3DS'),{extra:extra});}},redirectOnError(){setTimeout(function(){window.location='/webshop/VBVFailure.go';},1000);},};})(document,jQ,webshop);
</script>

</body>
</html>
