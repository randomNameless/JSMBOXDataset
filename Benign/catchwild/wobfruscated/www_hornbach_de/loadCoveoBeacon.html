<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>loadCoveoBeacon.html</title>
</head>
<body>
<script>if (!window.loadAsync_CoveoBeacon) {
  /* Load the Coveo Beacon into the customer page */
  let BEACON_PREFIX_CoveoBeacon = 'CoveoBeacon: ';
  let SEARCH_HUB_CoveoBeacon = 'Search';
  let DEBUG_CoveoBeacon = false;
  var coveoua_CoveoBeacon = undefined;
  let InExtension_CoveoBeacon = false;
  let COVEO_COOKIE_ID = 'CBeaconClientId';
  //SHOULD NEVER BE SET IN loadCoveoBeacon.js
  let RESET_PUSH = false;


  function log_CoveoBeacon(message) {
    console.log(BEACON_PREFIX_CoveoBeacon, message);
  }

  function debugm_CoveoBeacon(message) {
    if (DEBUG_CoveoBeacon) console.log(BEACON_PREFIX_CoveoBeacon, message);
  }

  function md5(str) {

    var RotateLeft = function (lValue, iShiftBits) {
      return (lValue << iShiftBits) | (lValue >>> (32 - iShiftBits));
    };

    var AddUnsigned = function (lX, lY) {
      var lX4, lY4, lX8, lY8, lResult;
      lX8 = (lX & 0x80000000);
      lY8 = (lY & 0x80000000);
      lX4 = (lX & 0x40000000);
      lY4 = (lY & 0x40000000);
      lResult = (lX & 0x3FFFFFFF) + (lY & 0x3FFFFFFF);
      if (lX4 & lY4) {
        return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
      }
      if (lX4 | lY4) {
        if (lResult & 0x40000000) {
          return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
        } else {
          return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
        }
      } else {
        return (lResult ^ lX8 ^ lY8);
      }
    };

    var F = function (x, y, z) { return (x & y) | ((~x) & z); };
    var G = function (x, y, z) { return (x & z) | (y & (~z)); };
    var H = function (x, y, z) { return (x ^ y ^ z); };
    var I = function (x, y, z) { return (y ^ (x | (~z))); };

    var FF = function (a, b, c, d, x, s, ac) {
      a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
      return AddUnsigned(RotateLeft(a, s), b);
    };

    var GG = function (a, b, c, d, x, s, ac) {
      a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
      return AddUnsigned(RotateLeft(a, s), b);
    };

    var HH = function (a, b, c, d, x, s, ac) {
      a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
      return AddUnsigned(RotateLeft(a, s), b);
    };

    var II = function (a, b, c, d, x, s, ac) {
      a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
      return AddUnsigned(RotateLeft(a, s), b);
    };

    var ConvertToWordArray = function (str) {
      var lWordCount;
      var lMessageLength = str.length;
      var lNumberOfWords_temp1 = lMessageLength + 8;
      var lNumberOfWords_temp2 = (lNumberOfWords_temp1 - (lNumberOfWords_temp1 % 64)) / 64;
      var lNumberOfWords = (lNumberOfWords_temp2 + 1) * 16;
      var lWordArray = Array(lNumberOfWords - 1);
      var lBytePosition = 0;
      var lByteCount = 0;
      while (lByteCount < lMessageLength) {
        lWordCount = (lByteCount - (lByteCount % 4)) / 4;
        lBytePosition = (lByteCount % 4) * 8;
        lWordArray[lWordCount] = (lWordArray[lWordCount] | (str.charCodeAt(lByteCount) << lBytePosition));
        lByteCount++;
      }
      lWordCount = (lByteCount - (lByteCount % 4)) / 4;
      lBytePosition = (lByteCount % 4) * 8;
      lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80 << lBytePosition);
      lWordArray[lNumberOfWords - 2] = lMessageLength << 3;
      lWordArray[lNumberOfWords - 1] = lMessageLength >>> 29;
      return lWordArray;
    };

    var WordToHex = function (lValue) {
      var WordToHexValue = "", WordToHexValue_temp = "", lByte, lCount;
      for (lCount = 0; lCount <= 3; lCount++) {
        lByte = (lValue >>> (lCount * 8)) & 255;
        WordToHexValue_temp = "0" + lByte.toString(16);
        WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length - 2, 2);
      }
      return WordToHexValue;
    };

    var x = Array();
    var k, AA, BB, CC, DD, a, b, c, d;
    var S11 = 7, S12 = 12, S13 = 17, S14 = 22;
    var S21 = 5, S22 = 9, S23 = 14, S24 = 20;
    var S31 = 4, S32 = 11, S33 = 16, S34 = 23;
    var S41 = 6, S42 = 10, S43 = 15, S44 = 21;

    //str = this.utf8_encode(str);
    x = ConvertToWordArray(str);
    a = 0x67452301; b = 0xEFCDAB89; c = 0x98BADCFE; d = 0x10325476;

    for (k = 0; k < x.length; k += 16) {
      AA = a; BB = b; CC = c; DD = d;
      a = FF(a, b, c, d, x[k + 0], S11, 0xD76AA478);
      d = FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
      c = FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
      b = FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
      a = FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
      d = FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
      c = FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
      b = FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
      a = FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
      d = FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
      c = FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
      b = FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
      a = FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
      d = FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
      c = FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
      b = FF(b, c, d, a, x[k + 15], S14, 0x49B40821);
      a = GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
      d = GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
      c = GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
      b = GG(b, c, d, a, x[k + 0], S24, 0xE9B6C7AA);
      a = GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
      d = GG(d, a, b, c, x[k + 10], S22, 0x2441453);
      c = GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
      b = GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
      a = GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
      d = GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
      c = GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
      b = GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
      a = GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
      d = GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
      c = GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
      b = GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);
      a = HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
      d = HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
      c = HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
      b = HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
      a = HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
      d = HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
      c = HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
      b = HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
      a = HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
      d = HH(d, a, b, c, x[k + 0], S32, 0xEAA127FA);
      c = HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
      b = HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
      a = HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
      d = HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
      c = HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
      b = HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);
      a = II(a, b, c, d, x[k + 0], S41, 0xF4292244);
      d = II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
      c = II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
      b = II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
      a = II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
      d = II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
      c = II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
      b = II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
      a = II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
      d = II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
      c = II(c, d, a, b, x[k + 6], S43, 0xA3014314);
      b = II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
      a = II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
      d = II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
      c = II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
      b = II(b, c, d, a, x[k + 9], S44, 0xEB86D391);
      a = AddUnsigned(a, AA);
      b = AddUnsigned(b, BB);
      c = AddUnsigned(c, CC);
      d = AddUnsigned(d, DD);
    }

    var temp = WordToHex(a) + WordToHex(b) + WordToHex(c) + WordToHex(d);

    return temp.toLowerCase();
  }

  function createHash(uri) {
    return md5(uri);
  }

  function mapLanguage_CoveoBeacon(language_code) {
    //return the language based upon the language code
    //language = en --> return english
    let language = 'Unknown';
    language_code = language_code.toLowerCase();
    const languageCodes = {
      en: 'English',
      us: 'English',
      es: 'Spanish',
      fr: 'French',
      de: 'German',
      it: 'Italian',
      pt: 'Portuguese',
      ja: 'Japanese',
      zh: 'Chinese',
      ar: 'Arabic',
      da: 'Danish',
      nl: 'Dutch',
      zh: 'Chinese'
    };
    Object.entries(languageCodes).map((code) => {
      if (language_code.startsWith(code[0])) {
        language = code[1];
      }
    });
    return language;
  }

  //Initialize UA
  function initUA_CoveoBeacon(data) {
    log_CoveoBeacon("In initUA");
    //coveoua_CoveoBeacon('reset');
    coveoua_CoveoBeacon('set', 'currencyCode', data['currency']? data['currency'] : 'USD');
    coveoua_CoveoBeacon('init', data['analytics_apikey'], data['endpoint']);
    coveoua_CoveoBeacon("set", "custom", { context_website: data['customer'] });
  }

  function base64_CoveoBeacon(str) {
    /*jslint bitwise: true */
    let CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
    let out = [],
      i = 0,
      len = str.length,
      c1,
      c2,
      c3;
    while (i < len) {
      c1 = str.charCodeAt(i++) & 0xff;
      if (i === len) {
        out.push(CHARS.charAt(c1 >> 2), CHARS.charAt((c1 & 0x3) << 4), '==');
        break;
      }
      c2 = str.charCodeAt(i++);
      if (i === len) {
        out.push(CHARS.charAt(c1 >> 2), CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xf0) >> 4)), CHARS.charAt((c2 & 0xf) << 2), '=');
        break;
      }
      c3 = str.charCodeAt(i++);
      out.push(CHARS.charAt(c1 >> 2), CHARS.charAt(((c1 & 0x3) << 4) | ((c2 & 0xf0) >> 4)), CHARS.charAt(((c2 & 0xf) << 2) | ((c3 & 0xc0) >> 6)), CHARS.charAt(c3 & 0x3f));
    }
    return out.join('');
  }

  function htmlDecode(input) {
    if (input != "") {
      var doc = new DOMParser().parseFromString(input, "text/html");
      return doc.documentElement.textContent;
    }
    else return '';
  }

  function _addBodyHtmlToRecord_CoveoBeacon(source, record, container) {
    let body = '<html><body>';
    //first add the description
    let foundOne = false;
    const regex = /(<\/span>|<\/div>|<\/td>|<\/p>|<\/li>|<\/h\d>|<br>|<br *\/>|<\/br>)/gm;
    const subst = ` $1`;
    body += record['description'] + ' <br>';
    source['body_selectors'].map((select) => {
      try {
        body += ' ' + container.querySelector(select).outerHTML.replaceAll(regex, subst);
        foundOne = true;
      }
      catch (e) { /* no-op */ }
    });
    body += "</body></html>";
    if (!foundOne) {
      record['bodyFound'] = false;
    } else {
      record['bodyFound'] = true;
    }
    record["compressedBinaryData"] = base64_CoveoBeacon(body);

    return record;
  }

  function addBody_CoveoBeacon(data, record) {
    return _addBodyHtmlToRecord_CoveoBeacon(data['detailed_information'], record, document);
  }

  function addBodySearch_CoveoBeacon(data, record, content) {
    return _addBodyHtmlToRecord_CoveoBeacon(data['search_information'], record, content);
  }


  function pushDocumentToCloud_CoveoBeacon(data, contents) {
    log_CoveoBeacon('Pushing the document - Sent to Cloud');
    const request = new XMLHttpRequest();
    //We will sent it first to lambda they will figure it out
    const LAMBDA_URL = 'https://62ximdnbwh.execute-api.us-east-1.amazonaws.com/dev/';
    request.open("POST", LAMBDA_URL, true);
    request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    request.onreadystatechange = function () {
      if (request.readyState === 4 && request.status === 200) {
        const jsonData = JSON.parse(request.response);
        debugm_CoveoBeacon(jsonData);
      }
    };
    const dataToSend = JSON.stringify(contents);
    request.send(dataToSend);
  }

  function updateContents_CoveoBeacon(data, contents, detail) {
    //Set up base fields
    if (!InExtension_CoveoBeacon) {
      RESET_PUSH = false;
    }
    if (RESET_PUSH == true) {
      contents['reset'] = true;
      log_CoveoBeacon('Pushing WILL RESET ALL ENTRIES!!!! - RESET_PUSH = true');
    }

    contents['p_url'] = contents['url'];
    contents['p_c'] = data['customer'];
    contents['p_ap'] = data['push_apikey'];
    contents['p_s'] = data['push_endpoint'];
    contents['p_d'] = detail;
    contents["objecttype"] = "Product";
    contents["fileextension"] = ".html";
    if (data['language'] == 'Unknown') {
      contents['language'] = 'English';
    } else {
      contents['language'] = data['language'];
    }
    contents['language_code'] = data['language']
    if (data['language_code'] == '') {
      contents["permanentid"] = contents['id'];
    } else {
      contents["permanentid"] = data['language_code'] + '-' + contents['id'];
    }
    contents["cat_sku"] = contents["sku"];
    //contents["documentId"] = contents['url'];
    contents["title"] = contents['name'];
    return contents;
  }

  function pushDocument_CoveoBeacon(data, contents, detail) {
    log_CoveoBeacon('Pushing the document');
    contents = updateContents_CoveoBeacon(data, contents, detail);

    let contentsArray = [contents];
    pushDocumentToCloud_CoveoBeacon(data, contentsArray);
  }


  function addPushDocument_CoveoBeacon(data, contents, detail) {
    log_CoveoBeacon('add Pushing the document');
    return updateContents_CoveoBeacon(data, contents, detail);
  }


  function getKey_CoveoBeacon(keys, jsondata, content, attribute) {
    let data = '';
    let attributeInSelector = '';
    if (keys.length == 0) return '';

    keys.map((key) => {
      if (data == '' && key != '') {
        try {
          if (key.indexOf('HTML:') != -1) {
            //We need to select an HTML element
            key = key.replace('HTML:', '');
            //Check if an attribute is set inside the selector
            if (key.indexOf('@') != -1) {
              let selectorParts = key.split("@");
              key = selectorParts[0];
              attributeInSelector = selectorParts[1];
            }
            let selected = content.querySelector(key);
            if (selected != null) {
              //data = document.querySelector(key).innerText;
              if (selected != null && attribute == null)
                data = selected.innerText;
              if (selected != null && attribute != null) {
                if (selected[attribute] == undefined) {
                  data = selected.innerText;
                } else {
                  data = selected[attribute];
                }
              }
              if (selected != null && attributeInSelector != '') {
                //Get the attribute
                let attrValue = selected.getAttribute(attributeInSelector);
                if (attrValue != null) {
                  data = attrValue;
                }
              }
            }
            //remove \n
            data = data.replace(/\n/, ';');
          } else {
            if (key.indexOf('.') > 0) {

              let keys = key.split('.');
              for (var i = 0; i < keys.length; i++) {
                if (typeof jsondata[keys[i]] == 'undefined')
                  data = '';
                jsondata = jsondata[keys[i]];
              }
              data = jsondata;
            }
            if (jsondata[key] != undefined) {
              data = jsondata[key];
            }
          }
          if (data == undefined) data = '';
        }
        catch (e) { /* no-op */ }
      }
    });
    return data;
  }

  function getSearchKey_CoveoBeacon(selectors, content, attribute) {
    let data = '';
    let attributeInSelector = '';
    //selector is an array
    //first one with content wins
    if (selectors.length == 0) return '';

    selectors.map((selector) => {
      if (data == '' && selector != '') {
        //Check if an attribute is set inside the selector
        if (selector.indexOf('@') != -1) {
          let selectorParts = selector.split("@");
          selector = selectorParts[0];
          attributeInSelector = selectorParts[1];
        }
        let selected = content.querySelector(selector);
        if (selected != null && attribute == null)
          data = selected.innerText;
        if (selected != null && attribute != null) {
          if (selected[attribute] == undefined) {
            data = selected.innerText;
          } else {
            data = selected[attribute];
          }
        }
        if (selected != null && attributeInSelector != '') {
          //Get the attribute
          let attrValue = selected.getAttribute(attributeInSelector);
          if (attrValue != null) {
            data = attrValue;
          }
        }
        if (data == undefined) data = '';
      }
    });



    data = data.replaceAll('\n', ' ');
    return data;
  }

  function ifStringIsNumber_CoveoBeacon(_string) {
    return !(Number.isNaN(parseFloat(_string)));
  }

  function htmlEncodeContents(contents) {
    contents['name'] = htmlDecode(contents['name']);
    contents['brand'] = htmlDecode(contents['brand']);
    contents['category'] = htmlDecode(contents['category']);
    contents['description'] = htmlDecode(contents['description']);

    return contents;
  }
  function getAllProductsFromSearch_CoveoBeacon(data, scrollY, force) {
    //Gather all documents from the current search page and push them to the pusher.
    //first check if we have results...
    if (data['push_search'] == true) {
      setTimeout(function () {
        let moveOn = false;
        data['search_information']['selectors'].map((select) => {
          if (document.querySelectorAll(select).length > 0) moveOn = true;
        });
        if (!moveOn) {
          debugm_CoveoBeacon("getAllProductsFromSearch, NO RESULTS");
          return;
        }
        debugm_CoveoBeacon("getAllProductsFromSearch");
        if (!checkAlreadySent_CoveoBeacon('SearchPage', window.location.href + scrollY, force)) {
          debugm_CoveoBeacon("Fetching results from page...");
          let allDocuments = [];

          //Use the normal selector
          data['search_information']['selectors'].map((select) => {
            if (document.querySelectorAll(select).length > 0) {
              let list = document.querySelectorAll(select);
              Array.from(list).forEach((result) => {
                let contents = {};
                const mappings = data['search_information']['mappings'];
                //If json_selector is set, we will use that
                if (data['search_information']['json_selector'] != '') {
                  let innerjson = result.querySelector(data['search_information']['json_selector']);
                  let jsonld = {};
                  if (innerjson != null) {
                    try {
                      jsonld = JSON.parse(innerjson.innerText.replaceAll('\n', ' '));
                    }
                    catch (e) { /* no-op */ }
                  }
                  debugm_CoveoBeacon("json_selector data");
                  debugm_CoveoBeacon(jsonld);
                  contents = {
                    //get the details for the result from the json
                    'id': getKey_CoveoBeacon(mappings['id'], jsonld, result, 'href'),
                    'name': getKey_CoveoBeacon(mappings['name'], jsonld, result),
                    'sku': getKey_CoveoBeacon(mappings['sku'], jsonld, result),
                    'brand': getKey_CoveoBeacon(mappings['brand'], jsonld, result),
                    'category': getKey_CoveoBeacon(mappings['category'], jsonld, result),
                    'price': getKey_CoveoBeacon(mappings['price'], jsonld, result),
                    'image': getKey_CoveoBeacon(mappings['image'], jsonld, result, 'src'),
                    'description': getKey_CoveoBeacon(mappings['description'], jsonld, result),
                    'url': getKey_CoveoBeacon(mappings['url'], jsonld, result, 'href')
                  };

                } else {
                  contents = {
                    //get the details for the result
                    'id': getSearchKey_CoveoBeacon(mappings['id'], result, 'href'),
                    'name': getSearchKey_CoveoBeacon(mappings['name'], result),
                    'sku': getSearchKey_CoveoBeacon(mappings['sku'], result),
                    'brand': getSearchKey_CoveoBeacon(mappings['brand'], result),
                    'category': getSearchKey_CoveoBeacon(mappings['category'], result),
                    'price': getSearchKey_CoveoBeacon(mappings['price'], result),
                    'image': getSearchKey_CoveoBeacon(mappings['image'], result, 'src'),
                    'description': getSearchKey_CoveoBeacon(mappings['description'], result),
                    'url': getSearchKey_CoveoBeacon(mappings['url'], result, 'href'),
                  };
                }
                if (!ifStringIsNumber_CoveoBeacon(contents['price'])) {
                  if (contents['price'] != undefined) {
                    contents['price'] = contents['price'].split(' ')[0].replace('£', '').replace('$', '').replace('€', '');
                    // contents['price'] = contents['price'].replaceAll(' ','').replaceAll('\n','').replaceAll('\t','');
                    // contents['price'] = contents['price'].replace('£', '').replace('$', '').replace('€', '');
                  }
                }
                if (contents['url'].indexOf('http') == -1) {
                  contents['url'] = 'https://' + window.location.host + '/' + contents['url'];
                }
                if (contents['id'].indexOf('/') != -1) {
                  contents['id'] = getRegexId_CoveoBeacon(data, contents['id']);
                }
                contents = fixSearchResult_CoveoBeacon(contents, result, data);
                //Fix HTML encoding issues
                contents = htmlEncodeContents(contents);
                let go = true;
                if (data['push_image_must_be_there'] && contents['image'] == '') {
                  go = false;
                }
                debugm_CoveoBeacon("contents data");
                debugm_CoveoBeacon(contents);
                if (contents['id'] != '' && contents['id'] != null && go) {
                  contents = addBodySearch_CoveoBeacon(data, contents, result);
                  if (contents['bodyFound']) {
                    contents = addPushDocument_CoveoBeacon(data, contents, '0');
                    contents['cat_detailed'] = "False";
                    let wehaveit = allDocuments.filter(doc => doc.id === contents.id).length > 0;
                    if (!wehaveit) {
                      allDocuments.push(contents);
                    }
                  } else {
                    debugm_CoveoBeacon("Body contents not found, not pushing");
                  }

                }
              });
            }
          });


          if (allDocuments.length > 0) {
            log_CoveoBeacon("Pushing all results");
            pushDocumentToCloud_CoveoBeacon(data, allDocuments);
          }
        }
      }, 200);
    }
  }


  function getPriceAndBrand_CoveoBeacon(target, data) {
    //We do not know if we are on a search page or on a detailed page
    //a detailed page could also have recommendations with add to cart
    //We start with getting the search data
    //if that is not there we go for the detailed page
    var contents = {};
    var result = null;
    debugm_CoveoBeacon("getPriceAndBrand on Search page");
    data['search_information']['selectors'].map((select) => {
      if (result == null) {
        result = target.closest(select);
      }
    });
    if (result == null) {
      debugm_CoveoBeacon("getPriceAndBrand no Search Item found");
    }
    if (result != null) {
      const mappings = data['search_information']['mappings'];
      //If json_selector is set, we will use that
      if (data['search_information']['json_selector'] != '') {
        let innerjson = result.querySelector(data['search_information']['json_selector']);
        let jsonld = {};
        if (innerjson != null) {
          try {
            jsonld = JSON.parse(innerjson.innerText.replaceAll('\n', ' '));
          }
          catch (e) { /* no-op */ }
        }
        debugm_CoveoBeacon("json_selector data");
        debugm_CoveoBeacon(jsonld);
        contents = {
          //get the details for the result from the json
          'id': getKey_CoveoBeacon(mappings['id'], jsonld, result, 'href'),
          'name': getKey_CoveoBeacon(mappings['name'], jsonld, result),
          'sku': getKey_CoveoBeacon(mappings['sku'], jsonld, result),
          'brand': getKey_CoveoBeacon(mappings['brand'], jsonld, result),
          'category': getKey_CoveoBeacon(mappings['category'], jsonld, result),
          'price': getKey_CoveoBeacon(mappings['price'], jsonld, result),
          'image': getKey_CoveoBeacon(mappings['image'], jsonld, result, 'src'),
          'description': getKey_CoveoBeacon(mappings['description'], jsonld, result),
          'url': getKey_CoveoBeacon(mappings['url'], jsonld, result, 'href')
        };

      } else {
        contents = {
          //get the details for the result
          'id': getSearchKey_CoveoBeacon(mappings['id'], result, 'href'),
          'name': getSearchKey_CoveoBeacon(mappings['name'], result),
          'sku': getSearchKey_CoveoBeacon(mappings['sku'], result),
          'brand': getSearchKey_CoveoBeacon(mappings['brand'], result),
          'category': getSearchKey_CoveoBeacon(mappings['category'], result),
          'price': getSearchKey_CoveoBeacon(mappings['price'], result),
          'image': getSearchKey_CoveoBeacon(mappings['image'], result, 'src'),
          'description': getSearchKey_CoveoBeacon(mappings['description'], result),
          'url': getSearchKey_CoveoBeacon(mappings['url'], result, 'href'),
        };
      }
      if (!ifStringIsNumber_CoveoBeacon(contents['price'])) {
        if (contents['price'] != undefined)
          contents['price'] = contents['price'].split(' ')[0].replace('£', '').replace('$', '').replace('€', '');
      }
      if (contents['url'].indexOf('http') == -1) {
        contents['url'] = 'https://' + window.location.host + '/' + contents['url'];
      }
      if (contents['id'].indexOf('/') != -1) {
        contents['id'] = getRegexId_CoveoBeacon(data, contents['id']);
      }
      contents = fixSearchResult_CoveoBeacon(contents, result, data);
    }
    if (result == null) {

      debugm_CoveoBeacon("getPriceAndBrand on Detailed page");
      //Detailed page
      var jsonld = {};
      if (data['detailed_information']['json_selector'] !== "") {
        let list = document.querySelectorAll(data['detailed_information']['json_selector']);
        Array.from(list).forEach((jsond) => {
          try {
            let jsonlddata = JSON.parse(jsond.innerText.replaceAll('\n', ' '));
            if (Array.isArray(jsonlddata)) {
              Array.from(jsonlddata).forEach((jsond) => {
                jsonld = Object.assign(jsonld, jsond);
              });
            }
            else {
              jsonld = Object.assign(jsonld, jsonlddata);
            }
          }
          catch (e) {
            debugm_CoveoBeacon("Bad json_selector");
            debugm_CoveoBeacon(e);
            debugm_CoveoBeacon(jsond.innerText);
          }
        });
      }
      debugm_CoveoBeacon("jsonld data");
      debugm_CoveoBeacon(jsonld);

      const mappings = data['detailed_information']['mappings'];
      contents = {
        'id': getKey_CoveoBeacon(mappings['id'], jsonld, document, 'href'),
        'name': getKey_CoveoBeacon(mappings['name'], jsonld, document),
        'sku': getKey_CoveoBeacon(mappings['sku'], jsonld, document),
        'brand': getKey_CoveoBeacon(mappings['brand'], jsonld, document),
        'category': getKey_CoveoBeacon(mappings['category'], jsonld, document),
        'price': getKey_CoveoBeacon(mappings['price'], jsonld, document),
        'image': getKey_CoveoBeacon(mappings['image'], jsonld, document, 'src'),
        'description': getKey_CoveoBeacon(mappings['description'], jsonld, document),
        'url': getKey_CoveoBeacon(mappings['url'], jsonld, document, 'href'),
        'quantity': 1
      };
      //Fix price
      if (!ifStringIsNumber_CoveoBeacon(contents['price'])) {
        try {
          if (contents['price'] != undefined)
            contents['price'] = contents['price'].replace('$', '').replace('£', '').replace('€', '');
        }
        catch (e) { /* no-op */ }
      }
      //If id is empty, get the window location href instead
      if (contents['id'] == '') {
        contents['id'] = window.location.href;
      }
      if (contents['url'] == '') {
        contents['url'] = window.location.href;
      }
      if (contents['id'].indexOf('/') != -1) {
        contents['id'] = getRegexId_CoveoBeacon(data, contents['id']);
      }
      contents = fixDetailedResult_CoveoBeacon(contents, data);
    }
    return contents;
  }

  function getProductAndPush_CoveoBeacon(data, detail) {
    var jsonld = {};
    if (data['detailed_information']['json_selector'] !== "") {
      let list = document.querySelectorAll(data['detailed_information']['json_selector']);
      Array.from(list).forEach((jsond) => {
        try {
          let jsonlddata = JSON.parse(jsond.innerText.replaceAll('\n', ' '));
          if (Array.isArray(jsonlddata)) {
            Array.from(jsonlddata).forEach((jsond) => {
              jsonld = Object.assign(jsonld, jsond);
            });
          }
          else {
            jsonld = Object.assign(jsonld, jsonlddata);
          }
        }
        catch (e) {
          debugm_CoveoBeacon("Bad json_selector");
          debugm_CoveoBeacon(e);
          debugm_CoveoBeacon(jsond.innerText);
        }
      });
    }
    debugm_CoveoBeacon("jsonld data");
    debugm_CoveoBeacon(jsonld);

    const mappings = data['detailed_information']['mappings'];
    let pushrecord = {
      'id': getKey_CoveoBeacon(mappings['id'], jsonld, document, 'href'),
      'name': getKey_CoveoBeacon(mappings['name'], jsonld, document),
      'sku': getKey_CoveoBeacon(mappings['sku'], jsonld, document),
      'brand': getKey_CoveoBeacon(mappings['brand'], jsonld, document),
      'category': getKey_CoveoBeacon(mappings['category'], jsonld, document),
      'price': getKey_CoveoBeacon(mappings['price'], jsonld, document),
      'image': getKey_CoveoBeacon(mappings['image'], jsonld, document, 'src'),
      'description': getKey_CoveoBeacon(mappings['description'], jsonld, document),
      'url': getKey_CoveoBeacon(mappings['url'], jsonld, document, 'href'),
      'quantity': 1
    };
    //Fix price
    if (!ifStringIsNumber_CoveoBeacon(pushrecord['price'])) {
      try {
        if (pushrecord['price'] != undefined)
          pushrecord['price'] = pushrecord['price'].replace('$', '').replace('£', '').replace('€', '');
      }
      catch (e) { /* no-op */ }
    }
    //If id is empty, get the window location href instead
    if (pushrecord['id'] == '') {
      pushrecord['id'] = window.location.href;
    }
    if (pushrecord['url'] == '') {
      pushrecord['url'] = window.location.href;
    }
    if (pushrecord['id'].indexOf('/') != -1) {
      pushrecord['id'] = getRegexId_CoveoBeacon(data, pushrecord['id']);
    }
    pushrecord = fixDetailedResult_CoveoBeacon(pushrecord, data);
    //Fix HTML encoding issues
    pushrecord = htmlEncodeContents(pushrecord);
    //Add variant to record
    if (data['language_code'] == '') {
      pushrecord['variant'] = pushrecord['id'];
    } else {
      pushrecord['variant'] = data['language_code'] + '-' + pushrecord['id'];

    }

    let record = JSON.parse(JSON.stringify(pushrecord));
    debugm_CoveoBeacon("pushrecord data");
    debugm_CoveoBeacon(record);
    let go = true;
    if (data['push_image_must_be_there'] && pushrecord['image'] == '') {
      go = false;
    }

    if (pushrecord['id'] != '' && pushrecord['id'] != null && go) {
      if (data['push_pdp'] == true) {
        //Add body to pushrecord
        pushrecord = addBody_CoveoBeacon(data, pushrecord);
        if (pushrecord['bodyFound']) {
          if (!checkAlreadyPushed_CoveoBeacon(pushrecord['url'] + detail)) {
            pushrecord['cat_detailed'] = "True";
            pushDocument_CoveoBeacon(data, pushrecord, detail);
          }
        } else {
          debugm_CoveoBeacon("Body contents not found, not pushing");
        }
      }
      delete record['image'];
      delete record['description'];
      delete record['url'];
    }
    return record;
  }

  function getNewSearchId_CoveoBeacon() {
    const getRandomValues = (rnds) => {
      for (let i = 0, r = 0; i < rnds.length; i++) {
        if ((i & 0x03) === 0) {
          r = Math.random() * 0x100000000;
        }
        rnds[i] = (r >>> ((i & 0x03) << 3)) & 0xff;
      }
      return rnds;
    };

    const uuidv4 = (a) => {
      // eslint-disable-next-line no-extra-boolean-cast
      if (!!a) {
        return (Number(a) ^ (getRandomValues(new Uint8Array(1))[0] % 16 >> (Number(a) / 4))).toString(16);
      }
      return (`${1e7}` + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, uuidv4);
    };
    return uuidv4();
  }

  function getQueryId_CoveoBeacon(data, query) {
    //Do we have the current query already in localstorage?
    //if so use that id
    let value = '';
    let sentNew = false;
    let ids = sessionStorage.getItem('CoveoBeaconQuery');
    if (query == '') {
      if (ids == null) {
        return { "queryId": '', "sentNew": sentNew };
      } else {
        let allids = JSON.parse(ids);
        return { "queryId": allids['id'], "sentNew": sentNew };
      }
    } else {
      if (ids == null) {
        ids = {};
        sentNew = true;
        value = getNewSearchId_CoveoBeacon();
        ids['query'] = query;
        ids['id'] = value;
        sessionStorage.setItem('CoveoBeaconQuery', JSON.stringify(ids));
      } else {
        let allids = JSON.parse(ids);
        if (allids[query] == undefined) {
          allids = {};
          sentNew = true;
          value = getNewSearchId_CoveoBeacon();
          allids['query'] = query;
          allids['id'] = value;
          sessionStorage.setItem('CoveoBeaconQuery', JSON.stringify(allids));
        } else {
          value = allids[query];
        }
      }
      return { "queryId": value, "sentNew": sentNew };
    }
  }


  function sentPageEvents_CoveoBeacon(data, scrollY, forceEvents, forcePush) {
    //First check what kind of page is it?
    //Is it a PLP?
    //force=true then do not check if already sent 
    // this happens when Observer fires, that means lazy loading or navigation was done
    // without a full page refresh
    debugm_CoveoBeacon('Sent Page Events');
    let pageType = '';
    let query = '';
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    if (isStringIn_CoveoBeacon(data['plp_url_regex'], window.location.href)) {
      //it is a PLP page
      query = window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1).split('.')[0];
      pageType = 'PLP';
    } else {
      //Is it a searchpage?
      data['search_term_parameters'].map((term) => {
        //If term is a regex?
        if ((typeof term) == 'object') {
          //Term is a regex so check the window.location.href
          if (isStringIn_CoveoBeacon(term, window.location.href)) {
            query = getRegex_CoveoBeacon(data['search_term_regex'], window.location.href);
            pageType = 'SEARCH';
          }
        } else {
          if (params[term] != undefined) {
            query = params[term];
            pageType = 'SEARCH';
          }
        }
      });
      if (query == '') {
        //If query still empty try the hash
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const hparams = Object.fromEntries(hashParams.entries());
        data['search_term_parameters'].map((term) => {
          if (hparams[term] != undefined) {
            query = hparams[term];
            pageType = 'SEARCH';
          }
        });
      }
    }
    let isPDPPage = false;
    isPDPPage = isStringIn_CoveoBeacon(data['product_url_regex'], window.location.href);
    if (data['product_page_selector'] != "") {
      if (document.querySelector(data['product_page_selector']) != null) {
        isPDPPage = true;
      }
    }
    if (isPDPPage) {
      //it is a product page
      pageType = 'DETAIL';
      debugm_CoveoBeacon('Sent Page Events, DETAIL page');
      getAllProductsFromSearch_CoveoBeacon(data, scrollY, forcePush);
      //Get product data + push to source
      let record = getProductAndPush_CoveoBeacon(data, '1');
      let referrer = document.referrer;
      if (referrer == '') referrer = document.location.href;
      if (record['id'] != '') {
        if (!checkAlreadySent_CoveoBeacon('Page', window.location.href, forceEvents)) {
          getClientId_CoveoBeacon(data).then((clientId) => {
            log_CoveoBeacon("Sending Product Page analytics");
            //fix empty name, used for 'Title'
            if (record['name'] == '') {
              record['name'] = window.location.href;
            }
            //add the product to coveoua
            if (data['language_code'] == '') {
              record['id'] = record['id'];
            }
            else {
              record['id'] = data['language_code'] + '-' + record['id'];
            }
            coveoua_CoveoBeacon('ec:addProduct', record);
            log_CoveoBeacon("Sending Detail");
            coveoua_CoveoBeacon('ec:setAction', 'detail', {
              "clientId": clientId,
              location: encodeURI(document.location.href),
              referrer
            });
            coveoua_CoveoBeacon('send', 'event');
            //Sent view data
            sentView_CoveoBeacon(data, clientId, window.location.href);
            //Sent view event normal event so set customData
            // coveoua_CoveoBeacon('send', 'view', {
            //   contentType: 'Product',
            //   language: data['language_code'],
            //   originLevel1: 'PDP',
            //   originLevel2: record['id'],
            //   originLevel3: referrer,
            //   title: record['name'],
            //   "customData": {
            //     "contentIDKey": "permanentid",
            //     "contentIDValue": record['id'],
            //     "context_website": data['customer'],
            //   },
            //   location: encodeURI(document.location.href),
            //   referrer
            // });
            // coveoua_CoveoBeacon('send', 'pageview', {
            //   searchHub: 'PDP',
            //   language: data['language_code'],
            //   location: encodeURI(document.location.href),
            //   referrer: encodeURI(referrer),
            //   //"context_website": data['customer']
            // });
          });
        } else {
          log_CoveoBeacon("Already sent Product Page analytics");
        }
      }

      return;
    }
    if (pageType == 'SEARCH') {
      //We also need to create a GUID, based on the Query + random value
      //Store that in sessiondata
      debugm_CoveoBeacon('Sent Page Events, SEARCH page');
      getAllProductsFromSearch_CoveoBeacon(data, scrollY, forcePush);
      if (!checkAlreadySent_CoveoBeacon('Page', window.location.href, forceEvents)) {
        getClientId_CoveoBeacon(data).then((clientId) => {
          log_CoveoBeacon("Sending Pageview Search Page");
          let referrer = document.referrer;
          if (referrer == '') referrer = document.location.href;
          coveoua_CoveoBeacon('send', 'pageview', {
            searchHub: SEARCH_HUB_CoveoBeacon,
            language: data['language_code'],
            location: encodeURI(document.location.href),
            referrer: encodeURI(referrer),
            //"context_website": data['customer']
          });
          //Will be done by coveoua
          const { queryId, sentNew } = getQueryId_CoveoBeacon(data, query);
          if (sentNew) {
            log_CoveoBeacon("Sending Send Query");
            //Sent normal event so set customData
            coveoua_CoveoBeacon('send', 'search',
              {
                "anonymous": true,
                "clientId": clientId,
                "language": data['language_code'],
                "originLevel1": SEARCH_HUB_CoveoBeacon,
                "originLevel2": "All",
                "actionCause": "searchboxSubmit",
                "queryText": query,
                "responseTime": 145,
                "searchQueryUid": queryId,
                "userAgent": navigator.userAgent,
                "customData": {
                  "context_website": data['customer']
                }

              });
          }
        });
      }
    }
    if (pageType == 'PLP') {
      //We also need to create a GUID, based on the Query + random value
      //Store that in sessiondata
      debugm_CoveoBeacon('Sent Page Events, PLP page');
      getAllProductsFromSearch_CoveoBeacon(data, scrollY, forcePush);
      if (!checkAlreadySent_CoveoBeacon('Page', window.location.href, forceEvents)) {
        getClientId_CoveoBeacon(data).then((clientId) => {
          log_CoveoBeacon("Sending Pageview PLP");
          let referrer = document.referrer;
          if (referrer == '') referrer = document.location.href;
          coveoua_CoveoBeacon('send', 'pageview', {
            searchHub: 'Listing',
            language: data['language_code'],
            "clientId": clientId,
            tab: query,
            location: encodeURI(document.location.href),
            referrer: encodeURI(referrer),
            //"context_website": data['customer']


          });
        });
      }
    }
    if (pageType == '') {
      debugm_CoveoBeacon('Sent Page Events, NORMAL page');
      if (!checkAlreadySent_CoveoBeacon('Page', window.location.href, forceEvents)) {
        getClientId_CoveoBeacon(data).then((clientId) => {
          log_CoveoBeacon("Sending Normal Pageview");
          let referrer = document.referrer;
          if (referrer == '') referrer = document.location.href;
          coveoua_CoveoBeacon('send', 'pageview', {
            searchHub: 'Search',
            language: data['language_code'],
            "clientId": clientId,
            location: encodeURI(document.location.href),
            referrer: encodeURI(referrer),
            //"context_website": data['customer']


          });

          sentView_CoveoBeacon(data, clientId, window.location.href);
        });
      }
    }
  }

  function loadAsync_CoveoBeacon(src, defer, callback) {

    var script = document.createElement('script');
    script.src = src;
    script.type = 'text/javascript';
    script.async = true;
    script.defer = defer;
    if (callback != null) {
      script.onload = function () {
        setTimeout(function () {
          callback();
        }, 100);

      };
      // Error handling for script loading
      script.onerror = function () {
        console.error('Error loading script:', src);
        if (typeof callback === 'function') {
          callback(new Error('Script loading error'));
        }
      };
    }
    setTimeout(function () {
      document.body.appendChild(script);
    }, 100);

  }


  function loadAsyncXML_CoveoBeacon(src, callback) {
    var oXmlHttp = new XMLHttpRequest();
    oXmlHttp.onreadystatechange = function () {
      if (oXmlHttp.readyState == XMLHttpRequest.DONE) {
        if (oXmlHttp.status == 200) {


          coveoua_clientId = oXmlHttp.getResponseHeader('set-clientbeacon');


          if (oXmlHttp.responseText != null) {
            var oHead = document.head;
            var oScript = document.createElement("script");
            oScript.language = "javascript";
            oScript.type = "text/javascript";
            oScript.text = oXmlHttp.responseText;
            oHead.appendChild(oScript);
            if (callback != null) {
              //oScript.onload = function () {
              setTimeout(function () {
                callback();
              }, 100);

              //};
            }
          }
        } else {
          console.log("Error", oXmlHttp.statusText)
        }
      }
    }
    //oXmlHttp.withCredentials = true;
    oXmlHttp.withCredentials = true;
    oXmlHttp.open('get', src, true);
    oXmlHttp.setRequestHeader('Content-Type', 'text/plain');
    oXmlHttp.send();
  }

  function checkInPath_CoveoBeacon(name, paths) {
    let result = false;
    (paths || []).map((path) => {
      if (path.className != undefined) {
        if (typeof path.className.indexOf === "function") {
          if (path.className.indexOf(name) != -1) {
            result = true;
          }
        }
      }
    });
    return result;
  }


  function getQueryFromURL_CoveoBeacon(data) {
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    let query = '';
    //Is it a PLP?
    if (isStringIn_CoveoBeacon(data['plp_url_regex'], window.location.href)) {
      //it is a PLP page
      query = window.location.pathname;
    } else {
      //Is it a searchpage?
      data['search_term_parameters'].map((term) => {
        if ((typeof term) == 'object') {
          //Term is a regex so check the window.location.href
          if (isStringIn_CoveoBeacon(term, window.location.href)) {
            query = getRegex_CoveoBeacon(data['search_term_regex'], window.location.href);
          }
        } else {
          if (params[term] != undefined) {
            query = params[term];
          }
        }
      });
      if (query == '') {
        //If query still empty try the hash
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const hparams = Object.fromEntries(hashParams.entries());
        data['search_term_parameters'].map((term) => {
          if (hparams[term] != undefined) {
            query = hparams[term];
          }
        });
      }
    }
    return query;
  }

  function getRegexId_CoveoBeacon(data, href) {
    let reg = data['product_id_regex_url'];
    let id = href;
    //only if id contains a real https link, else it probably contains the direct id
    if (id.indexOf('/') != -1) {
      let matches = href.match(reg);
      if (matches) {
        try {
          id = matches[1];//No splitting anymore .split('?')[0];
          id = id.replace('?', '');
          id = id.replace('=', '');
        } catch (e) {
          debugm_CoveoBeacon("getRegexId failed!!! " + href);
        }
        return id;
      }
    }
    return id;
  }


  function getRegex_CoveoBeacon(regex, href) {
    let reg = regex;
    let id = href;
    let matches = href.match(reg);
    if (matches) {
      id = matches[1];
      return decodeURI(id);
    }
    return id;
  }

  function isStringIn_CoveoBeacon(regex, href) {
    return (href.match(regex) ? true : false);
  }


  function sentView_CoveoBeacon(data, clientId, href) {
    //Sent  normal event so set customData
    let id = '';
    if (data['language_code'] == '') {
      id = getRegexId_CoveoBeacon(data, href);
    } else {
      id = data['language_code'] + '-' + getRegexId_CoveoBeacon(data, href);
    }
    coveoua_CoveoBeacon('send', 'view',
      {
        "language": data['language_code'],
        "location": encodeURI(href),
        "clientId": clientId,
        "contentIDKey": "permanentid",
        "contentIDValue": id,
        "originLevel1": SEARCH_HUB_CoveoBeacon,
        "originLevel2": "All",
        "customData": {
          "context_website": data['customer']
        }

      });
  }

  function sentCart_CoveoBeacon(data, href, target) {
    if (href == '') {
      href = window.location.href;
    }
    if (!checkAlreadySent_CoveoBeacon('Add', href, false)) {
      log_CoveoBeacon("Sending Cart");
      let details = getPriceAndBrand_CoveoBeacon(target, data);
      let docId = href;
      if (docId.indexOf('/') != -1) {
        docId = getRegexId_CoveoBeacon(data, href);
      }
      if (data['language_code'] == '') {
        docId = docId;
      }
      else {
        docId = data['language_code'] + '-' + docId;
      }
      let record = {
        'id': docId,
        'variant': docId,
        'position': 1,
        'quantity': 1
      };
      //Add detailed data
      let allData = {
        ...details,
        ...record
      };

      let { queryId } = getQueryId_CoveoBeacon(data, '');
      if (queryId == '') {
        queryId = getNewSearchId_CoveoBeacon();
      }
      getClientId_CoveoBeacon(data).then((clientId) => {
        addCartSession_CoveoBeacon(allData);
        //add the product to coveoua
        coveoua_CoveoBeacon('ec:addProduct', allData);
        coveoua_CoveoBeacon('ec:setAction', 'add', {
          list: `coveo:search:${queryId}`,
          language: data['language_code'],
          clientId: clientId
        });
        coveoua_CoveoBeacon('send', 'event');
      });
    }
  }


  function sentPurchase_CoveoBeacon(data, href) {
    if (href == '') {
      href = window.location.href;
    }
    log_CoveoBeacon("Sending Purchase: ", href);
    let ids = sessionStorage.getItem('CoveoBeaconCart');
    let go = true;
    if (ids == null) {
      //Do nothing
      debugm_CoveoBeacon('Nothing in Cart session, checking Cookie');
      go = false;
    }
    if (go == false) {
      //Check custom work
      var records = getCartData_CoveoBeacon();
      records.map((rec) => {
        coveoua_CoveoBeacon('ec:addProduct', rec);
      });
    }
    else {
      var records = JSON.parse(ids);
      records.map((rec) => {
        coveoua_CoveoBeacon('ec:addProduct', rec);
      });
    }
    let { queryId } = getQueryId_CoveoBeacon(data, '');
    if (queryId == '') {
      queryId = getNewSearchId_CoveoBeacon();
    }
    getClientId_CoveoBeacon(data).then((clientId) => {
      //add the product to coveoua
      coveoua_CoveoBeacon('ec:setAction', 'purchase', {
        'id': queryId,
        'language': data['language_code'],
        'revenue': '1',
        'tax': '1',
        'shipping': '1',
        'clientId': clientId
      });
      coveoua_CoveoBeacon('send', 'event');
    });
    //}
  }

  function addCartSession_CoveoBeacon(record) {
    let ids = sessionStorage.getItem('CoveoBeaconCart');
    if (!ids) {
      ids = [record];
      sessionStorage.setItem('CoveoBeaconCart', JSON.stringify(ids));
    } else {
      let allids = JSON.parse(ids);
      //Check if id is already here
      let exists = false;
      allids.map((rec) => {
        if (rec['id'] == record['id']) {
          exists = true;
        }
      });
      if (!exists) allids.push(record);
      sessionStorage.setItem('CoveoBeaconCart', JSON.stringify(allids));
    }

  }

  function checkAlreadySent_CoveoBeacon(action, href, force) {
    let sent = false;
    let ids = sessionStorage.getItem('CoveoBeacon' + action);
    if (ids == null) {
      sent = false;
      sessionStorage.setItem('CoveoBeacon' + action, href);
    } else {
      if (href == ids) {
        sent = true;
      } else {
        sent = false;
        sessionStorage.setItem('CoveoBeacon' + action, href);
      }
    }
    if (force == true) sent = false;
    return sent;
  }


  function checkAlreadyPushed_CoveoBeacon(href) {
    let sent = false;
    let ids = sessionStorage.getItem('CoveoBeaconPush');
    if (ids == null) {
      ids = {};
      sent = false;
      ids[href] = '1';
      sessionStorage.setItem('CoveoBeaconPush', JSON.stringify(ids));
    } else {
      let allids = JSON.parse(ids);
      if (allids[href] == undefined) {
        sent = false;
        allids[href] = '1';
        sessionStorage.setItem('CoveoBeaconPush', JSON.stringify(allids));
      } else {
        sent = true;
      }
    }
    return sent;
  }

  function sentClick_CoveoBeacon(data, query, href, position, target) {
    //Check if query is empty, if so, use page id
    if (query == '') {
      query = window.location.href;
    }
    if (!checkAlreadySent_CoveoBeacon('Sent', query + href)) {
      log_CoveoBeacon("Sending Click");
      let details = getPriceAndBrand_CoveoBeacon(target, data);
      let { queryId } = getQueryId_CoveoBeacon(data, '');
      let docId = href;
      if (docId.indexOf('/') != -1) {
        docId = getRegexId_CoveoBeacon(data, href);
      }
      if (data['language_code'] == '') {
        docId = docId;
      }
      else {
        docId = data['language_code'] + '-' + docId;
      }

      let record = {
        'id': docId,
        'variant': docId,
        'position': position,
        'quantity': 1
      };
      //Add detailed data
      let allData = {
        ...details,
        ...record
      };
      //Fix documentUriHash if to long
      let docHash = docId;
      if (docId.length > 32) {
        docHash = createHash(docId);
      }
      let title = href;
      //If name is there use that as title
      if (allData['name'] != '') {
        title = allData['name'];
      }
      //add the product to coveouak
      //not needed anymore 24-11-2023
      //coveoua_CoveoBeacon('ec:addProduct', allData);
      if (queryId == '') {
        queryId = getNewSearchId_CoveoBeacon();
      }
      let referrer = document.referrer;
      if (referrer == '') referrer = document.location.href;
      getClientId_CoveoBeacon(data).then((clientId) => {
        if (clientId == '') {
          log_CoveoBeacon("NO VISITORID?");
        }
        //collect for 'click'
        //This is not needed anymore 24-11-2023
        // coveoua_CoveoBeacon('ec:setAction', 'click', {
        //   "clientId": clientId,
        //   language: data['language_code'],
        //   list: `coveo:search:${queryId}`,
        //   location: encodeURI(document.location.href),
        //   referrer: encodeURI(referrer)
        // });
        // coveoua_CoveoBeacon('send', 'event');

        //normal for 'click'
        //Sent event normal event so set customData
        coveoua_CoveoBeacon('send', 'click',
          {
            "anonymous": true,
            'language': data['language_code'],
            "clientId": clientId,
            "originLevel1": SEARCH_HUB_CoveoBeacon,
            "originLevel2": "All",
            "documentPosition": position,
            "documentTitle": title,
            "documentUri": href,
            "documentUriHash": docHash,
            "documentUrl": href,
            "actionCause": "documentOpen",
            "searchQueryUid": queryId,
            "sourceName": "Products",
            "userAgent": navigator.userAgent,
            "customData": {
              "contentIDKey": "permanentid",
              "contentIDValue": docId,
              "context_website": data['customer']
            }
          });
      });
    }


    //coveoua('send', 'pageview');
  }

  function getHref_CoveoBeacon(classname, event) {
    let href = '';
    // check if we can find it with closest and the classname
    let selector = '.' + classname;
    if (classname.indexOf('[') != -1 || classname.indexOf('>') != -1) {
      //We have a CSS selector
      selector = classname;
    }
    let closest = event.target.closest(selector);
    if (closest) {
      href = getHrefSearchResult_CoveoBeacon(event);
    }

    let classList = event?.target?.classList;
    if (!href && classList && classList.contains(classname)) {
      //Sent Purchase
      //First check if we have something back from the getHrefSearchResult function
      href = getHrefSearchResult_CoveoBeacon(event);
    }
    if (!href) {
      if (checkInPath_CoveoBeacon(classname, event.composedPath())) {
        //First check if we have something back from the getHrefSearchResult function
        href = getHrefSearchResult_CoveoBeacon(event);
      }
    }

    return { "catched": href ? true : false, "href": href };
  }


  const funcNamePurchase_CoveoBeacon = (event, data) => {
    debugm_CoveoBeacon('Click Purchase Wrapper');
    debugm_CoveoBeacon(event);
    let catched = false;
    let href = '';
    data.purchase_classes.map((name) => {
      if (!catched) {
        let check = getHref_CoveoBeacon(name, event);
        if (check.catched) {
          catched = check.catched;
          href = check.href;
        }
      }
    });
    if (catched) {
      log_CoveoBeacon('Purchase event');
      sentPurchase_CoveoBeacon(data, href);
    }
  };
  const funcNameCart_CoveoBeacon = (event, data) => {
    debugm_CoveoBeacon('Click Add To Cart Wrapper');
    debugm_CoveoBeacon(event);
    let catched = false;
    let href = '';
    data.add_to_cart_classes.map((name) => {
      if (!catched) {
        let check = getHref_CoveoBeacon(name, event);
        if (check.catched) {
          catched = check.catched;
          href = check.href;
        }
      }
    });
    if (catched) {
      log_CoveoBeacon('Add To Cart event');
      sentCart_CoveoBeacon(data, href, event.target);
    }
  };
  const funcNameSearch_CoveoBeacon = (event, data) => {
    debugm_CoveoBeacon('Click Search Wrapper');
    debugm_CoveoBeacon(event);
    let catched = false;
    let href = '';

    //Add to cart
    data.add_to_cart_classes.map((name) => {
      if (!catched) {
        let check = getHref_CoveoBeacon(name, event);
        if (check.catched) {
          catched = check.catched;
          href = check.href;
        }
      }
    });
    if (catched) {
      log_CoveoBeacon('Add To Cart event');
      sentCart_CoveoBeacon(data, href, event.target);
    }
    //Search
    if (catched == false) {
      data.search_onclick_classes.map((name) => {
        if (!catched) {
          let check = getHref_CoveoBeacon(name, event);
          if (check.catched) {
            catched = check.catched;
            href = check.href;
          }
        }

      });
      if (catched) {
        const query = getQueryFromURL_CoveoBeacon(data);
        log_CoveoBeacon('Search Click event');
        let position = getPositionForClick_CoveoBeacon(event);
        sentClick_CoveoBeacon(data, query, href, position, event.target);
      }
    }
  };

  function changeHref_CoveoBeacon(href, clientId) {
    if (href !== undefined) {
      if (href.indexOf(COVEO_COOKIE_ID) == -1) {
        if (href.indexOf('?') == -1) {
          href = href + '?' + COVEO_COOKIE_ID + '=' + clientId;

        } else {
          href = href + '&' + COVEO_COOKIE_ID + '=' + clientId;
        }
      } else {
        let re = new RegExp(`(${COVEO_COOKIE_ID}=)([a-z0-9\-]*)`, 'ig');
        href = href.replace(re, '$1' + clientId);
      }
    }
    return href;
  }


  function setupEvents_CoveoBeacon(data, clientId) {
    //addHrefWithClientId_CoveoBeacon(data);
    document.documentElement.addEventListener('click', (event) => {
      //Check for href
      var closestA = event.target.closest('a');
      if (closestA) {
        let href = closestA.getAttribute("href");
        let found = false;
        data['add_clientid_to_urls'].map((url) => {
          if (href.indexOf(url) >= 0) {
            found = true;
          }
        });
        if (found) {
          debugm_CoveoBeacon('Changing url, adding clientid');
          href = changeHref_CoveoBeacon(href, clientId);
          closestA.setAttribute('href', href);
        }
      }
      function getSelectors(key) {
        let selectors = data[key];
        if (typeof selectors == 'string') selectors = [selectors];
        return selectors || [];
      }

      function callHandlerIfSelectorMatch(selectorsKey, handler) {
        let selectors = getSelectors(selectorsKey);
        selectors.forEach(selector => {
          if (event.target.closest(selector)) { // if the target element has the selector in its path
            handler(event, data);
          }
        });
      }

      //Purchase
      callHandlerIfSelectorMatch('purchase_onclick_selector', funcNamePurchase_CoveoBeacon);
      //Add to cart
      callHandlerIfSelectorMatch('add_to_cart_onclick_selector', funcNameCart_CoveoBeacon);
      //Search onclick or add to cart
      callHandlerIfSelectorMatch('search_onclick_selectors', funcNameSearch_CoveoBeacon);
    }, true);
  }

  function setupUrlListener_CoveoBeacon(data) {
    let previousUrl = '';
    let timer = null;

    const observer = new MutationObserver(function (mutations) {
      clearTimeout(timer);
      timer = setTimeout(function () {
        if (previousUrl == '') {
          previousUrl = location.href;
        }
        if (location.href !== previousUrl) {
          previousUrl = location.href;

          debugm_CoveoBeacon("Observer update done... adding new events...");
          log_CoveoBeacon("Observer, change navigation to: " + window.location.href);
          sentPageEvents_CoveoBeacon(data, window.scrollY, true, true);
        } else {
          //Probably because of lazy loading or scrolling
          if (data['push_search'] == true) {
            debugm_CoveoBeacon("Observer update done... adding new events...");
            log_CoveoBeacon("Observer, contents changed, scroll position: " + window.scrollY);
            sentPageEvents_CoveoBeacon(data, window.scrollY, false, true);
          }
        }
      }, 400);
    });

    const config = {
      childList: true,
      subtree: true,
    };
    if (data['observer_container_selector'] != '') {
      let location = null;
      if (data['observer_container_selector'] != 'document') {
        if (document.querySelector(data['observer_container_selector']) != null) {
          location = document.querySelector(data['observer_container_selector']);
        }
      }
      if (data['observer_container_selector'] == 'document') {
        location = document;
      }
      if (location != null) {
        debugm_CoveoBeacon("Observer started...");
        observer.observe(location, config);
      }
    }
  }

  function setClientId_CoveoBeacon(clientId, callback) {
    //Transform clientId to a proper UUID
    //44ABB170C33111EDB30077BAF1F42189|||  -->32
    //44ABB170-C331-11ED-B300-77BAF1F42189
    //UUID: 8 - 4 - 4 - 4 - 12 (32)
    let cookieId = COVEO_COOKIE_ID;
    try {
      if (clientId.indexOf('-') == -1) {
        var str = clientId.replaceAll('|', '').toLowerCase();
        clientId = str.slice(0, 8) + "-" + str.slice(8, 12) + "-" + str.slice(12, 16) +
          "-" + str.slice(16, 20) + "-" + str.slice(20, str.length + 1)
      }
      clientId = fixClientIdCookie_CoveoBeacon(clientId);
      coveoanalytics.getCurrentClient().setClientId(clientId);
      callback(clientId);
    } catch {
      //In the case of an invalid UUID
      debugm_CoveoBeacon("Error setting clientId, fallback to visitorid");
      coveoanalytics.getCurrentClient().determineVisitorId().then(clientId => {
        //Set it in a cookie
        setCookie_CoveoBeacon(cookieId, clientId, 1);
        callback(clientId);
      });

    }
  }

  function getClientId_CoveoBeacon(data) {
    //First check if we have a cookie
    let cookieId = COVEO_COOKIE_ID;
    let SiteCookieId = data['cookie_for_clientid'];
    return new Promise((resolve) => {
      let cid = '';
      //first check if coveoua_clientId is defined, if so use that
      // if (typeof coveoua_clientId !== 'undefined') {
      //   setClientId(coveoua_clientId);
      //   setCookie_CoveoBeacon(AWSCookieId, coveoua_clientId, 1);
      //   resolve(coveoua_clientId);
      // } else {
      //First step is to check the URL, does it contain the COVEO_COOKIE_ID
      //If so use that
      const urlParams = new URL(window.location.toLocaleString()).searchParams;
      let id = urlParams.get(COVEO_COOKIE_ID);
      if (id != null) {
        debugm_CoveoBeacon("Using URL clientId");
        setClientId_CoveoBeacon(id, function (clid) {
          resolve(clid);
        });

      } else {
        //First check the AWS cookie, if it is there, use that

        let cookie = getCookie_CoveoBeacon(SiteCookieId);
        if (cookie != undefined) {
          debugm_CoveoBeacon("Using Site Cookie for clientId");
          setClientId_CoveoBeacon(cookie, function (clid) {
            resolve(clid);
          });

        }
        else {
          cookie = getCookie_CoveoBeacon(cookieId);
          if (cookie != undefined) {
            //If so use that
            debugm_CoveoBeacon("Using existing Cookie for clientId");
            resolve(cookie);
          } else {
            //Else use the analytics to get one
            if (coveoanalytics.getCurrentClient().currentVisitorId != '') {
              debugm_CoveoBeacon("Use existing visitorId for clientId");
              setCookie_CoveoBeacon(cookieId, coveoanalytics.getCurrentClient().currentVisitorId, 1);
              resolve(coveoanalytics.getCurrentClient().currentVisitorId);
            } else {
              coveoanalytics.getCurrentClient().determineVisitorId().then(clientId => {
                //Set it in a cookie
                setCookie_CoveoBeacon(cookieId, clientId, 1);
                resolve(clientId);
              });
            }
          }
        }
      }
      //}
      //return cid;
    });
  }

  const getDomainWithoutSubdomain_CoveoBeacon = url => {
    const urlParts = new URL(url).hostname.split('.')

    return urlParts
      .slice(0)
      .slice(-(urlParts.length === 4 ? 3 : 2))
      .join('.')
  }


  function getCookie_CoveoBeacon(cookieName) {
    let cookie = {};
    let value = undefined;
    if (cookieName == '') {
      return value;
    }
    document.cookie.split(';').forEach(function (el) {
      let [key, value] = el.split('=');
      cookie[key.trim()] = value;
    });
    //try to find the cookie with the prefix of the name
    Object.keys(cookie).map((name) => {
      if (name.indexOf(cookieName) != -1) {
        value = cookie[name];
      }
    });
    return value;
  }

  function setCookie_CoveoBeacon(cName, cValue, expDays) {
    let date = new Date();
    date.setTime(date.getTime() + (expDays * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    // let newcookievalue = cName + "=" + cValue + "; " + expires + "; path=/; domain=" + getDomainWithoutSubdomain_CoveoBeacon(window.location.href);
    let newcookievalue = cName + "=" + cValue + "; path=/; domain=" + getDomainWithoutSubdomain_CoveoBeacon(window.location.href);
    document.cookie = newcookievalue;
    debugm_CoveoBeacon(newcookievalue);

  }

  //Load all scripts and settings
  function initScripts_CoveoBeacon() {

    if (typeof coveoua !== 'undefined') {
      coveoua_CoveoBeacon = coveoua;
    }
    let data = getCoveoDetails_CoveoBeacon();
    data["customer"] = data["customer"].replace(' ', '_');
    DEBUG_CoveoBeacon = data['debug'];
    if (data['active'] == false) {
      log_CoveoBeacon("WARNING: Not Active!!!");
      return;
    }
    //Now init the Usage Analytics
    initUA_CoveoBeacon(data);
    getClientId_CoveoBeacon(data).then((clientId) => {
      setupEvents_CoveoBeacon(data, clientId);
      sentPageEvents_CoveoBeacon(data, window.scrollY, false, false);
      setupUrlListener_CoveoBeacon(data);
    });
  }

  function waitForUA_CoveoBeacon(callback) {
    if (typeof coveoua !== 'undefined') {
      coveoua_CoveoBeacon = coveoua;
      callback();
    } else {
      setTimeout(function () {
        waitForUA_CoveoBeacon(callback);
      }, 100);
    }
  }

  //Load all scripts and settings
  function loadScripts_CoveoBeacon(withDOM = false) {
    //console.log(prefix + "Loading " + src + customerName + ".js");
    const coveoBeaconEl = document.getElementById('loadCoveoBeacon');
    let customerName = coveoBeaconEl.getAttribute('data-customer');
    let src = coveoBeaconEl.getAttribute('src').replace('loadCoveoBeacon.js', '');
    loadAsync_CoveoBeacon(src + customerName + ".js", true, function () {
      waitForUA_CoveoBeacon(function () {
        if (withDOM) {
          window.addEventListener('DOMContentLoaded', initScripts_CoveoBeacon);
        } else {
          initScripts_CoveoBeacon();
        }
      });
    });
  }

  console.log(BEACON_PREFIX_CoveoBeacon + "Loading Coveo Beacon");
  loadAsync_CoveoBeacon("https://poc-beacon.coveodemo.com/coveouaupdated.js", false, loadScripts_CoveoBeacon);


}</script>
</body>
</html>
