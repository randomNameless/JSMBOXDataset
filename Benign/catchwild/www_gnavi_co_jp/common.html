<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>common.html</title>
</head>
<body>

<script>
var IS_RETINA = false;
var IS_TOUCH = false;
var NOT_COUNT_QTYPE_LIST = ["images", "description", "movie"];
var ENQUETE_STATUS = ["回収中","終了","予約中","作成中"];
var ENQUETE_STATUS_EN = ["Collecting","Closed","Schedule a survey","Creating"];

var mousemove_event = 0

var message = null;
var ok = null;
var cancel = null;
var extra = null;

$(function() {
    if (window.devicePixelRatio == 2) {
        IS_RETINA = true;
    }
    if("ontouchend" in window) {
        IS_TOUCH = true;
    }
    
    $("html").mousemove(function(e){
        mousemove_event = e;
    });

    $(window).scroll( function(){
        $('.sidebar').height($("body").height() + 120);
    });
    // ヘッダメニュー
    $(document).on('click', '.uiHeaderMenu', function() {
        var el = $(this);

        if (el.find('ul').is(':hidden')) {
            el.addClass('open');
            el.find('ul').slideDown('fast');

            $(document).on('click', function() {
                $(document).off('click', arguments.callee);
                el.find('ul').slideUp('fast', function() {
                    el.removeClass('open');
                });
            });
        }
    });
    
    $(document).on('click', '#new_enq_lnk', function () {
        extra = "new_enq_lnk";
        if (!adhoc_check && adhoc_exists) {
            HOME_SELECT_CREATE[0] = 'z-enquete-check';
            $.ajax({
                "url": "/enquete/check_adhoc",
                "timeout": 10000,
                "type": "GET",
                "dataType": "JSON",
            }).done(function (data, status, xhr) {
                if (data) {
                    utils.messageBox(HOME_SELECT_CREATE, function () {

                        var v_check = $('input[name=enquetetype]:checked').val();
                        if ($('#adhoc-qst').hasClass('checked')) {
                            window.open('/enquete/switch#f=all&p=1&s=r', "_blank");
                        } else if ($('#normal-qst').hasClass('checked')) {
                            window.location = '/enquete/create';
                        }

                    });
                    $('.alert-dialog-content p').css('background-image', 'none');
                } else {
                    window.location = '/enquete/create';
                }
            }).fail(function (xhr, status, error) {
            });
        }
    });
        
    
    // ポップアップボタン
    $(document).on('click', '.uiPopupButton > a:not(.pen)', function() {
        var el = $(this).parent().find('.uiPopupMenu');
        if (el.is(':hidden')) {
            el.slideDown('fast', function() {
                $(document).on('click', function(e) {
                    if (!$(e.target).hasClass('hasChildren') && $(e.target).parents("#pageEdit").length == 0) {
                        if(touch_mode && el.hasClass("logic_menu")) {
                            if($(e.target).parents(".helpDialogSp").length != 0 || $(e.target).hasClass("sidebar-grayout-layer")) {
                                return;
                            }
                        }
                        $(document).off('click', arguments.callee);
                        el.slideUp('fast', function() {
                            if (el.parents(".spPreviewOnce").length > 0) {
                                el.parents("#pageEdit").remove();
                            }
                        });
                    }
                });
            });
        }
    });
});

function convertNum(num, figures) {
	var str = String(num);
	while (str.length < figures) {
		str = "0"+str;
	}
	return str;
}

function CKEditorToHtml(code, multi) {
    if (code === null) return '';
    code = code.replace(/<!--[\s\S]*?-->/g, '')

    var tags = code.match(/<[^<|>]*>/gi);
    if (!tags) {
        if (multi) {
            return [code];
        } else {
            return code;
        }
    }

    if (tags.length == 2 && tags[0] == '<p>' && tags[1] == '</p>') {
        code = code.replace(/<[^<|>]*>/gi, '');
        if (multi) {
            return [code];
        } else {
            return code;
        }
    }

    tags = tags.sort(function(a, b) {
        if (a.length < b.length) return 1;
        else if (a.length > b.length) return -1;
        else return 0;
    });

    _.each(tags, function(tag) {
        if (!tag.match(/<\/?(p|span|u|em|strong|a|font)(>|[\s][^>]*>)/i)) {
            var t = tag;
            t = t.split('>').join("&gt;");
            t = t.split('<').join("&lt;");
            code = code.split(tag).join(t);
        } else {
            var t = tag.slice(1, -1)
            t = t.split('>').join("&gt;");
            t = t.split('<').join("&lt;");
            code = code.split(tag).join('<'+t+'>');
        }
    });

    if (multi) {
        var lines = code.split('<p');
        var ret = []
        for (var i = 0; i < lines.length; i++) {
            if (lines[i] != '') {
                var line = '<p' + lines[i];
                line = CKEditorToHtml(line, false);
                ret.push(line);
                // ret.push('<p' + lines[i]);
            }
        }
        return ret;
    }

    return code;
}

function CKEditorToText(code) {
    code = "" + code;
    return code.replace(/<[^<|>]*>/gi, '');
}

function CKEditorToTextBr(code) {
    code = "" + code;
    return code.replace(/<\/p>/gi, '\n').replace(/<br[^>]*>/gi, '\n').replace(/<[^<|>]*>/gi, '').replace(/\n+$/g,'').replace(/\n/gi, '<br>&nbsp;&nbsp;&nbsp;');
}

function CKEditorJoinMulti(data) {
    var rows = []
    _.each(data, function(row) {
        html = CKEditorToHtml(row);
        if (html == CKEditorToText(row)) {
            html = '<p><span style="font-size:16px;">' + html + '</span></p>';
        }
        rows.push(html);
    });
    return rows.join('\n');
}

// 見出し込みで表示
function CKEditorJoinMultiLabel(data, options, target) {
    var rows = []
    _.each(data, function(row) {
        html = CKEditorToHtml(row);
        if (html == CKEditorToText(row)) {
            html = '<p>' + html + '</p>';
        }
        if (options[target]) {
            if (CKEditorToText(row) in options[target]) {
                if ("head" in options[target][CKEditorToText(row)]) {
                    var head_info = options[target][CKEditorToText(row)]["head"]
                    if (head_info && head_info["checked"]) {
                        var head_text = head_info["text"].replace("<p>", "").replace("</p>", "");
                        head = '<p>' + "{見出し}" + head_text + '</p>';
                        rows.push(head);
                    }
                    rows.push(html);
                } else {
                    rows.push(html);
                }
            }
        } else {
            rows.push(html);
        }
    });
    return rows.join('\n');
}

function onChangeValue(this_el, cbf){
  var _tm = 600;
  var count = 0;
  var f = function (){
    var t = setTimeout(
      function (){
        clearTimeout(t);
        if(this_el.is_focused == false || count == 100){
          cbf();
        }else{
          f();
        }
      },
      _tm
    );
    count ++;
  }
  f();
}
function setCkEditor(elem, title) {
        /* title はスマホ用 */
        
        if (elem.html() != undefined) {
            var id = elem.attr("id");
            if (CKEDITOR.instances[id]) {
                CKEDITOR.instances[id].destroy();
            }
            CKEDITOR.inline(elem[0], {language: language_code});

            if (touch_mode && !elem.hasClass("disabled")) {
                elem.focus(function(){
                    elem.blur();
                    var current = elem.offset().top;
                    open_CKEditorDialog(elem.html(), "", function(input){
                        elem.html(input);
                        window.scroll(0, current - 200);
                        CKEDITOR.instances["dialog-ckeditor"].destroy();
                    });
                });
            }
        }
    }

function CKEditorInline(elem, onblur, answertag, id, common, t, keyconst, modal_title) {
    /* 引数 modal_title はsp用 */
    if(!touch_mode) {
        $(elem).click(function() {
            if ($(elem).data('ck') == '1') {
                return;
            }
            if (answertag) {
                set_answertag_options(id, common)
            }
            if(t){
                t.is_focused = true
            }

            var option = {
                on: {
                    instanceReady: function(event) {
                        var nodeInfo = getNodeByCursor(mousemove_event.clientX - 4, mousemove_event.clientY);
                        if (nodeInfo) {
                            var range = document.createRange();
                            range.setStart(nodeInfo.node, nodeInfo.offsetInsideNode);
                            range.setEnd(nodeInfo.node, nodeInfo.offsetInsideNode);
                            sel = window.getSelection();
                            sel.removeAllRanges();
                            sel.addRange(range);
                        }
                    },
                    blur: function(event) {
                        if (onblur != undefined) {
                            onblur(event.editor);
                        }
                        event.editor.destroy();
                        $(elem).data('ck', '0');
                    },
                },
                language: language_code,
                font: selected_font_family,
            }
            if (keyconst) {
                option['blockedKeystrokes'] = [13, CKEDITOR.SHIFT + 13, CKEDITOR.CTRL + 13];
                option['keystrokes'] = [13, 'blur', CKEDITOR.SHIFT + 13, 'blur'];
            }

            // font タグが消えてしまわないように
            $(this).html(utils.normalizeFont($(this).html()));

            CKEDITOR.inline($(this)[0], option);

            function DragStartFunc(e){
                // InternetExplorer 用
                if (!e)	e = window.event;

                if(e.preventDefault){
                    // デフォルトのドラッグを無効化する
                    e.preventDefault();
                }else{
                    // デフォルトのドラッグを無効化する（アタッチイベント利用時や、InternetExplorer 8 以前の場合）
                    return false;
                }
            }
            if(elem.attachEvent){
                // ドラッグ開始時に実行されるイベント
		        elem.attachEvent("ondragstart",DragStartFunc);
                // イベントハンドラを使用する
        	}else{
                // ドラッグ開始時に実行されるイベント
        		elem.ondragstart = DragStartFunc;
	        }
            $(elem).data('ck', '1');
            $(elem).blur();
        });
    } else {
        $(elem).prop('contenteditable', false);
        $(elem).click(function(){
            $(this).trigger("blur");
            if (answertag) {
                set_answertag_options(id, common)
            }
            if(t){
                t.is_focused = true
            }

            var option = 
            {
                language: language_code,
            };
            if (keyconst) {
                option['blockedKeystrokes'] = [13, CKEDITOR.SHIFT + 13, CKEDITOR.CTRL + 13];
                option['keystrokes'] = [13, 'blur', CKEDITOR.SHIFT + 13, 'blur'];
            }

            // font タグが消えてしまわないように
            $(this).html(utils.normalizeFont($(this).html()));

            var current = $(elem).offset().top;
            open_CKEditorDialog($(this).html(), modal_title, function (input) {
                if(input) {
                    $(elem).html(input);
                    onblur(CKEDITOR.instances["dialog-ckeditor"]);
                }
                window.scroll(0, current - 200);
			    if (CKEDITOR.instances["dialog-ckeditor"]) {
        			CKEDITOR.instances["dialog-ckeditor"].destroy();
    			}
            }, option);
        });
    }
    // $(elem).blur(function() {
    //     if (onblur != undefined) {
    //         onblur(CKEDITOR.currentInstance);
    //     }
    //     CKEDITOR.currentInstance.destroy();
    // });
};

function open_CKEditorDialog (defaultValue, title, callback, ckOptions, elem) {
    var is_iOS = touch_mode && navigator.userAgent.match(/iP(hone|ad|od)/i);

    if ($('.cke_top')[0]) {
        $('.cke_top').hide();
        $('#CKEditorDialog .cke_top').show();
    }
    $('#CKEditorDialog h2').text(title);

    if (CKEDITOR.instances["dialog-ckeditor"]) {
        CKEDITOR.instances["dialog-ckeditor"].destroy();
    }
    if (!ckOptions) {
        ckOptions = {};
    }
    if (!ckOptions['language']) {
        ckOptions['language'] = language_code;
    }
    if (is_iOS) {
        ckOptions.toolbarLocation = 'bottom';
    }
    zoomDisable();

    CKEDITOR.replace('dialog-ckeditor', ckOptions);
    CKEDITOR.instances["dialog-ckeditor"].setData(defaultValue);

    utils.editorDialog($('#CKEditorDialog'), '.overlay');
    // 元のフォームからフォーカスをダイアログに移す
    setTimeout(utils.focusAgain, 50);

    // 「適用する」ボタンクリック時の動作
    // (意図せず過去に編集した場所まで書き換えてしまわぬよう先にハンドラーを外す)
    $('#saveCKEditor').off('click');
    $('#saveCKEditor').on('click', function () {
    	// コンボボックスが開いた状態の場合は、閉じる処理をする
        $('#CKEditorDialog').find(".cke_combo_on").find(".cke_combo_open").trigger('click');
        // android でスタイル指定が幾つか欠けるので getData を経由しない。
        // var input = CKEDITOR.instances["dialog-ckeditor"].getData();
        var input = $('#CKEditorDialog iframe').contents().find('body').html();
        var txt = $('#CKEditorDialog iframe').contents().find('body').text();
        if (txt == "") input = "";

        if (callback) {
            input = utils.normalizeFont(input);
            callback(input);
        }
        utils.closeDialog($('#CKEditorDialog'));
        $('#CKEditorDialog').trigger('blur');
        $('#saveCKEditor').off('click', arguments.callee);
    });

    // 「キャンセル」ボタン及びモーダル領域以外をクリックした時の動作
    $('#cancelCKEditor').removeClass("cancel");
    $('#cancelCKEditor').addClass('cancelCKN');
    $('#cancelCKEditor').off('click');
    $('#cancelCKEditor,.sidebar-grayout-layer').on('click', function () {
    	// コンボボックスが開いた状態の場合は、閉じる処理をする
        $('#CKEditorDialog').find(".cke_combo_on").find(".cke_combo_open").trigger('click');
        if (callback) {
            callback();
        }
        utils.closeDialog($('#CKEditorDialog'));
        $('#CKEditorDialog').trigger('blur');
        $('#cancelCKEditor').off('click', arguments.callee);
    });

    // iOS でのヘッダ移動対策
    if (is_iOS) {
        _.each(['.header', '.itemPaletteParent', '.sidebar-grayout-layer'], function(selector) {
            $(selector).addClass('fixfixed');
        });
    }

    var interval = setInterval(function() {
        if ($('#CKEditorDialog .cke_inner')[0]) {
            // ツールバー固定
            var contentsHeight = $('#CKEditorDialog .cke_inner').height();
            if (is_iOS) {
                // ボトムに固定
                contentsHeight -= $('#CKEditorDialog .cke_inner .cke_bottom').outerHeight();
            } else {
                // トップに固定
                contentsHeight -= $('#CKEditorDialog .cke_inner .cke_top').outerHeight();
            }
            $('#CKEditorDialog .cke_inner .cke_contents').height(contentsHeight);

            // 元の input text に残骸が残るのでこっそり消す
            $('div.cke_top').hide();

            if (is_iOS) {
                // キーボードの ON/OFF で動きまわるのを阻止
                $('#CKEditorDialog').addClass('fixfixed');
                window.scrollTo(0, 0);
                $('#cancelCKEditor,#saveCKEditor,.sidebar-grayout-layer').on('click', function () {
                    setTimeout(function () {
                        // キーボードを隠す
                        $(':focus').blur();
                    }, 200);

                    $('#cancelCKEditor,#saveCKEditor,.sidebar-grayout-layer').off('click', arguments.callee);
                });

                // カーソル位置を移動した後に入力できなくなる iOS のバグ対策
                $(window).on('scroll', utils.focusAgain);
            }

            clearInterval(interval);
        }
    }, 10);

    // CKEditorDialogの中身が描画されるまで監視する
    var e = elem;
    var checkIframeInterval = setInterval(function() {

        // 指定要素がなければ特に何もしないので監視終了
        if (e == undefined) {
            clearInterval(checkIframeInterval);
            return;
        }

        if ($('#CKEditorDialog iframe').contents().find('body')[0]) {
            // どこのエディタかに応じてダイアログにスタイルを付与
            if ($(e).hasClass('first-page-title')) {
                $('#CKEditorDialog iframe').contents().find('body').addClass('first-page-title');
            }

            if ($(e).hasClass('last-page-message')) {
                $('#CKEditorDialog iframe').contents().find('body').addClass('last-page-message');
            }

            clearInterval(checkIframeInterval);
        }
    }, 10);

};

function zoomDisable () {
    var $viewport = $('head meta[name=viewport]');
    var content = $viewport.attr('content');
    if (content.indexOf('user-scalable') !== -1) {
        var split_content = content.split(/, */);
        var transformed = [];
        _.each(split_content, function(fragment) {
            if (fragment.indexOf('user-scalable') === -1) {
                transformed.push(fragment);
            } else {
                transformed.push('user-scalable=0');
            }
        });
        var newMeta = $('<meta name="viewport">').attr({
            content: transformed.join(",")
        })
    } else {
        content += ",user-scalable=0";
        var newMeta = $('<meta name="viewport">').attr({
            content: content
        })
    }
    $('head meta[name=viewport]').replaceWith(newMeta);
};

function zoomEnable(){
    var $viewport = $('head meta[name=viewport]');
    var content = $viewport.attr('content');
    if (content.indexOf('user-scalable') !== -1) {
        var split_content = content.split(/, */);
        var transformed = [];
        _.each(split_content, function(fragment) {
            if (fragment.indexOf('user-scalable') === -1) {
                transformed.push(fragment);
            } else {
                transformed.push('user-scalable=1');
            }
        });
        var newMeta = $('<meta name="viewport">').attr({
            content: transformed.join(",")
        })
    } else {
        content += ",user-scalable=1";
        var newMeta = $('<meta name="viewport">').attr({
            content: content
        })
    }
    $('head meta[name=viewport]').replaceWith(newMeta);
};

function editor_getData (editor) {
    var is_android = navigator.userAgent.match(/android/i);
    var is_chrome = navigator.userAgent.match(/chrome/i);
    var is_firefox = navigator.userAgent.match(/firefox/i);
    var is_standard_browser = is_android && !is_chrome && !is_firefox;
    if (is_standard_browser && editor.element && editor.element.$) {
        var $data = $('<div>').html(editor.element.$.innerHTML);
        var btags = $data.find('b');
        if (btags[0]) {
            _.each(btags, function (btag) {
                var replacer = $('<strong>').html($(btag).html());
                $(btag).replaceWith(replacer);
            });
        }
        var itags = $data.find('i');
        if (itags[0]) {
            _.each(itags, function (itag) {
                var replacer = $('<em>').html($(itag).html());
                $(itag).replaceWith(replacer);
            });
        }
        return $data.html();
    } else {
        // fall back
        return editor.getData();
    }
};

// function CKEditorInline(elem, onblur, answertag, id, common, t) {
//     if (answertag) {
//         set_answertag_options(id, common)
//     }

//     CKEDITOR.inline(elem, {on: {
//         focus: function(event) {
//             if (answertag) {
//                 set_answertag_options(id, common)
//             }
//             if(t){
//                 t.is_focused = true
//             }
//         },
//         blur: function(event) {
//             if (onblur != undefined) {
//                 onblur(event);
//             }
//             event.editor.destroy();
//             CKEditorInline(elem, onblur, answertag, id, common, t);
//         }
//     }});
// }

// function CKEditorInlineKeyConst(elem, onblur, answertag, id, common, t) {
//     if (answertag) {
//         set_answertag_options(id, common)
//     }

//     CKEDITOR.inline(elem, {
//         blockedKeystrokes: [13, CKEDITOR.SHIFT + 13],
//         keystrokes: [ 13, 'blur', CKEDITOR.SHIFT + 13, 'blur'],
//         on: {
//         focus: function(event) {
//             if (answertag) {
//                 set_answertag_options(id, common)
//             }
//             if(t){
//                 t.is_focused = true
//             }
//         },
//         blur: function(event) {
//             onblur(event);
//             event.editor.destroy();
//             CKEditorInlineKeyConst(elem, onblur, answertag, id, common, t);
//         }
//     }});
// }

function getNodeByCursor(x, y) {

    // Implementation note: range.setStart offset is
    // counted in number of child elements if any or
    // in characters if there is no child. Since we
    // want to compute in number of chars, we need to
    // get the node which has no child.
    if (document.selection) { // Internet Explorer
        return false;
    }

    // FIXME - elementFromPoint() is failing for inline editor's below the first one (?)
    var elem = document.elementFromPoint(x, y);
    // var elem = $.elementFromPoint(x, y);
    if (! elem) {
            //console.log('elementFromPoint() failed! @ (' + x + ',' + y + ')');
            return(false);
    }
    var startNode = (elem.childNodes.length > 0) ? elem.childNodes[0] : elem;
    var startCharIndexCharacter = -1;

    // Narrow in on the Y coordinate we want first;
    // we'll use binary space partitioning
    var bspStep = parseInt(startNode.length / 2);
    var bspPosition = 0;

    // Use the first position to get the line height
    var startRange = document.createRange();
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(startRange);
    startRange.setStart(startNode, bspPosition);
    startRange.setEnd(startNode, bspPosition + Math.min(1, startNode.childNodes.length));

    var rangeRect = startRange.getBoundingClientRect();
    var lineHeight = rangeRect.bottom - rangeRect.top;
    var lineSeek = 0;
    var lineFirst = rangeRect.top;
    //console.log('Line height is [' + lineHeight + ']');
    if (y <= lineFirst) {
            //console.log('Impossible, y=[' + y + '] < lineFirst=[' + lineFirst + ']');
    }
    else {
            var d = y - lineFirst;
            lineSeek = parseInt(d / lineHeight);
            //console.log('Looks like we should be around line [' + lineSeek + ']');
    }

    do {
        // Advance to the next character
        startCharIndexCharacter++;

        // Make a range for just this one character
        startRange.setStart(startNode, startCharIndexCharacter);
        startRange.setEnd(startNode, startCharIndexCharacter + Math.min(1, startNode.childNodes.length));

        // Get the bounding rectangle for the range
        rangeRect = startRange.getBoundingClientRect();

        // Based on line height, what line is this character at?
        var d = rangeRect.top - lineFirst;
        var lineAt = parseInt(d / lineHeight);

    } while (((lineAt < lineSeek) || (rangeRect.left < x)) && (startCharIndexCharacter < startNode.length - 1));
    return {node:startNode, offsetInsideNode:startCharIndexCharacter};
}


function set_answertag_options(id, common, qindex) {
    // id (質問ID) か qindex (質問番号) どちらか片方のみ
    answertag_options = []
    var index = 1;
    var flag = true;
    common.enquete_model.each(function(page){
        page.get("questions").each(function(question){
            if (id == question.get('id')) flag = false;
            if (qindex == index) flag = false;

            if (flag) {
                // if (question.get('qtype') != "description" && question.get('qtype') != "images") {
                if (!_.contains(NOT_COUNT_QTYPE_LIST, question.get("qtype")) && question.get('qtype') != "photoupload") {
                    var Q_num = "Q" + index;
                    var title = question.get('title');

                    var this_options = question.get('options')
                    if (question.get("qtype").indexOf("matrix") != -1) {
                        var items = question.get('options')["rows"]
                        for (var j =0; j< items.length; j++) {
                            var q_item_num = Q_num + "-" + (j+1);
                            var question_data = ["{" + q_item_num + "}",
                                                 q_item_num + ":" + CKEditorToText(title),
                                                 q_item_num ]
                            answertag_options.push(question_data)
                        }
                    } else if (question.get("qtype").indexOf("textbox") != -1) {
                        var choices = question.get('options')["choices"]
                        for (var j =0; j< choices.length; j++) {
                            var q_item_num = Q_num + "-" + (j+1);
                            var question_data = ["{" + q_item_num + "}",
                                                 q_item_num + ":" + CKEditorToText(title),
                                                 q_item_num ]
                            answertag_options.push(question_data)
                        }

                    } else if (question.get("qtype") == "ranking") {
                        var choices = question.get('options')["choices"]
                        var unit_name = question.get('options')["unit_name"]
                        for (var j =0; j< choices.length; j++) {
                            var q_item_num = Q_num + "-" + (j+1);
                            var question_data = ["{" + q_item_num + "}",
                                                 q_item_num + unit_name,
                                                 q_item_num ]
                            answertag_options.push(question_data)
                        }
                    } else {
                        var question_data = ["{" + Q_num + "}",
                                             Q_num + ":" + CKEditorToText(title),
                                             Q_num ]
                        answertag_options.push(question_data)
                    }
                    index ++;
                } else if(question.get('qtype') == "photoupload") {
                    index ++;
                }
            }
        });
    });
}


// 辞書と現在のデータを比較し、無い情報を全て埋める関数
function check_all_default_value(res_data, default_data) {
    for (var key in default_data) {
        try {
            if (key in res_data) {
                res_data[key] = check_all_default_value(res_data[key], default_data[key])
            } else {
                res_data[key] = JSON.parse(JSON.stringify(default_data[key]))
            }
        } catch(e) {}
    }
    return res_data;
}

var utils = {
    saveBackboneModel: function(model, attrs, onsuccess, onbadrequest, onerror, force) {
        var changed = {}

        if (force) {
            changed = attrs;

        } else {
            $.each(attrs, function(key, value) {
                if (model.get(key) != value) {
                    changed[key] = value;
                }
            });
            if (changed.length == 0) {
                onsuccess(model);
                return;
            }
        }

        model.save(changed, {
            'patch': true,
            'wait': true,
            'success': function(model) {
                utils._onsuccess(model, onsuccess);
                model.trigger('change');
            },
            'error': function(model, xhr, options) {
                // console.log('error');
                utils._onerror(model, xhr, options, function() {
                    utils.saveBackboneModel(model, attrs, onsuccess, onbadrequest, onerror);
                }, onbadrequest, onerror);
            }
        });
    },

    createBackboneModel: function(collection, attrs, index, onsuccess, onbadrequest, onerror) {
        collection.create(attrs, {
            'at':index,
            'wait': true,
            'success': function(model) {
                utils._onsuccess(model, onsuccess);
            },
            'error': function(model, xhr, options) {
                utils._onerror(model, xhr, options, function() {
                    utils.createBackboneModel(collection, attrs, index, onsuccess, onbadrequest, onerror);
                }, onbadrequest, onerror);
            }
        });
    },

    destroyBackboneModel: function(model, onsuccess, onbadrequest, onerror) {
        model.destroy({
            'wait': true,
            'success': function(model) {
                utils._onsuccess(model, onsuccess);
            },
            'error': function(model, xhr, options) {
                utils._onerror(model, xhr, options, function() {
                    utils.destroyBackboneModel(model, onsuccess, onbadrequest, onerror);
                }, onbadrequest, onerror);
            }
        });
    },

    _onsuccess: function(model, onsuccess) {
        utils.hideSaveError();
        if (onsuccess) {
            onsuccess(model);
        }
    },

    _onerror: function(model, xhr, options, retry, onbadrequest, onerror) {
        if (xhr.status == 400) {
            utils.hideSaveError();
            if (onbadrequest) {
                onbadrequest(model, xhr, options);
            }
        } else if (xhr.status == 0) {
            if (onerror) {
                onerror();
            }
            utils.showSaveErrorRetry(retry);
        } else {
            if (onerror) {
                onerror();
            }
            utils.showSaveErrorReload();
        }
    },

    onAjaxSuccess: function(data, onsuccess) {
        utils.hideSaveError();
        if (onsuccess) {
            onsuccess(data);
        }
    },
    onAjaxError: function(xhr, retry, onbadrequest, onerror) {
        if (xhr.status == 400) {
            utils.hideSaveError();
            if (onbadrequest) {
                onbadrequest(xhr);
            }
        } else if (xhr.status == 0) {
            if (onerror) {
                onerror();
            }
            utils.showSaveErrorRetry(retry);
        } else {
            if (onerror) {
                onerror();
            }
            utils.showSaveErrorReload();
        }
    },
    onAjaxErrorForResult: function(xhr) {
        if (xhr.status == 400) {
            utils.hideSaveError();
        } else if (xhr.status == 0) {
            utils.showErrorTimeoutForResult();
        } else {
            utils.showSaveErrorReload();
        }
    },
    grayout_index: 0,

    setGrayout: function(callback, opacity, zindex, selector, is_not_close_grayout) {
        utils.grayout_index++;
        var callback = callback;

        $('.uiSidebarPopup').slideUp('fast');

        if (opacity == undefined) {
            opacity = 0.5;
        }
        if (zindex == undefined) {
            zindex = 100;
        }
        if (selector == undefined) {
            selector = 'body';
        }
        var style = 'position: fixed; top: 0;left: 0; height: 100%; width: 100%; background: black; opacity: 0.50; z-index: 100;'
        $(selector).append('<div id="sidebar-grayout-layer-' + utils.grayout_index + '" style="' + style + '" class="sidebar-grayout-layer"></div>');

        el = $('#sidebar-grayout-layer-' + utils.grayout_index)

        el.hide();
        el.css('opacity', opacity);
        el.css('z-index', zindex);
        if (!is_not_close_grayout) {
            el.click(function () {
                ret = true;
                if (callback) {
                    ret = callback();
                }
                if (ret != false) {
                    utils.unsetGrayout();
                }
            });
        }
        el.fadeIn();
    },

    unsetGrayout: function() {
        el = $('#sidebar-grayout-layer-' + utils.grayout_index)
        el.fadeOut(function() {
            el.remove();
            utils.grayout_index--;
        });
    },

    showSaveErrorRetry: function(retry) {
        /*var el = $('#save-error-retry');
        if(el.css('display') == 'block') {
            return;
        }
        if($('#save-error-reload').css('display') == 'block') {
            $('#save-error-reload').hide();
        } else {
            utils.setGrayout(function() {
                return false;
            }, 0.5, 9999);
        }

        el.show();
        el.find('a').click(retry);*/
        render_confirm(MESSAGE_ERROR[0], MESSAGE_ERROR[1], MESSAGE_ERROR[2], retry);
    },
    showErrorTimeoutForResult: function() {
        render_error(MESSAGE_TIMEOUT_RESULT_ACCESS_ERROR, MESSAGE_ERROR[2]);
    },
    showSaveErrorReload: function() {
        /*var el = $('#save-error-reload');
        if(el.css('display') == 'block') {
            return;
        }
        if($('#save-error-retry').css('display') == 'block') {
            $('#save-error-retry').hide();
        } else {
            utils.setGrayout(function() {
                return false;
            }, 0.5, 9999);
        }

        el.show();*/
        render_error(SAVE_MESSAGE_ERROR[0], SAVE_MESSAGE_ERROR[1], function(){
            location.reload(true);
        });
    },
    showCreateError: function() {
        render_error(SAVE_MESSAGE_ERROR[2], MESSAGE_ERROR[2]);
    },    
    hideSaveError: function() {
        var el1 = $('#save-error-retry');
        var el2 = $('#save-error-reload');
        if(el1.css('display') == 'block' || el2.css('display') == 'block') {
            utils.unsetGrayout();
        }
        $('.save-error').hide();
    }, 

    openDialog: function(elem, selector, zindex, grayoutIsActive) {
        var elem = elem;
        var z_index = zindex ? zindex : 100;
        var grayout_is_active = ( grayoutIsActive!= undefined) ? grayoutIsActive : true;
        utils.setGrayout(function() {
            if (grayout_is_active) {
                utils.closeDialog(elem);
            }
            return false;
        }, 0.5, z_index, selector);

        elem.show();
        if(elem.find('#infoPupCls')){
            elem.find('#infoPupCls').click(function() {
                    utils.closeDialog(elem);
                });
        }
        var init = elem.data('init')
        if (!init) {
             elem.find('a.cancel').click(function() {
                            utils.closeDialog(elem);
                    });
            elem.data('init', 1)
        }

        // 初回のみデフォルトの幅と高さを計算
        //   2回目以降は data 属性にいれておく
        var dialog_w = elem.data('dialog_w')
        var window_w = $(window).width();
        if (!dialog_w) {
        	if (dialog_w > window_w){
                elem.css('width', window_w * 0.9);
        	}
            dialog_w = elem.outerWidth();
            elem.data('dialog_w', dialog_w)
        }
        var content_h = elem.data('content_h')
        if (!content_h) {
            content_h = elem.find('.modal-dialog-content').height();
            if (!content_h) {
                content_h = elem.height();
            }
            elem.data('content_h', content_h)
        }
        if($('#clsd-msg').length>=1&&!touch_mode){
                var w_h = $(window).height();
                var modal_h = (w_h*90)/100;
                if (modal_h > 650){
                elem.data('content_h',elem.data('content_h')+100);
                $('.optionDialog').css('height','830px');
                $('.optionDialogInner').css('height','730px');
                }else{
                 var sub_h = modal_h-100;
                $('.optionDialog').css('height',modal_h+'px');
                $('.optionDialogInner').css('height',sub_h+'px');
                }
            }
        if($('#infoPupCls').length >=1 && !touch_mode){
            if($('#infoPupCls').css('display') !== 'none'){
                $('body').css('background-color','#F9F9F9')
                $('.sidebar-grayout-layer').css('overflow','hidden')
                $('#infoPopUpOuter').css('width','860px !important');
                $('#infoPopUpOuter').css('height','460px');
            }

        }else if($('#infoPupCls').length >=1 && touch_mode){
             if($('#infoPupCls').css('display') !== 'none'){
                $('body').css('background-color','#F9F9F9')
                $('.sidebar-grayout-layer').css('overflow','hidden')
                $('#infoPopUpOuter').css('width','340px !important');
                $('#infoPopupMainDiv').css('width','330px !important');
                $('#infoPopUpOuter').css('height','460px');
                $('#infoPopUpOuter').css('margin-top','10%');
                $('#infoPopUpOuter').css('margin-bottom','-122.5%');
                $('#infoPupCls').css('margin-left','55%')
                $('#infoPupCls').css('margin-top','-20px')
                $('#infoPopUpOuter').css("margin-top", ( (window.screen.height - 460 )/ 2) + "px");
            }

        }
        if (document.getElementById("modal_image") != null) {
            var modalimage = document.getElementById("modal_image");
            var image = new Image();
            image.src = modalimage.getAttribute('src');
            // 画像サイズ自動調整 モーダルの最大幅に調整
            image.onload = function() {
                $('#modal_image').css('width',$('#infoPdiv').width());
            }
        }
        function resizeDialog(elem, dialog_w, content_h) {
            var window_w = $(window).width();
            // var dialog_w = elem.outerWidth();

            if (dialog_w > window_w * 0.9) {
                elem.width(window_w * 0.9);
                elem.css('left', '5%');
                if (elem.find('.notice-answer-title')) {
                    elem.parent().find('.notice-answer-title').css('width',window_w * 0.9);
                }
            } else {
                elem.width(dialog_w);
                elem.css('left', (window_w - dialog_w) / 2);
                if (elem.find('.migrationEnqDialog')) {
                    //モーダル高さはここで調整
                    elem.find('.migrationEnqDialog').height(420);
                    elem.parent().find('.migrationEnqDialog').css('width',elem.outerWidth() + 50);
                }
                if (elem.find('.migrationEnqConfirmDialog')) {
                    //モーダル高さはここで調整
                    elem.find('.migrationEnqDialog').height(420);
                    elem.find('.migrationEnqDialog').css('width',elem.outerWidth() + 30);
                }
            }

            var window_h = $(window).height();
            var header_h = elem.find('h2').outerHeight();
            if (header_h == null) {
                header_h = 0;
            }
            var footer_h = elem.find('.modal-dialog-footer').outerHeight();
            if (footer_h == null) {
                footer_h = 0;
            }
            // var content_h = elem.find('.modal-dialog-content').height();

            if (content_h + header_h + footer_h > window_h * 0.85) {
                var h = window_h * 0.85 - header_h - footer_h;
                if (h < 100) {
                    h = 100;
                }
                elem.find('.modal-dialog-content').height(h);
                elem.find('.sample-info-div').height(h - 100);
                elem.css('top', '9%');
            } else {
            	// margin-topを0にしないとIE8,9のホイールが効かない
            	elem.css('margin-top',0);
            	// ヘッタなしのモーダル用
                if (header_h == 0){
                	var global_header_h = $('div.header').height();
                    // ウインドウの高さよりも大きい場合には、強制的に高さを変える（ボタンを押せなくならない対応）
              		var ios_margin_bottom = 0;
                	if (window_h < (elem.height() + global_header_h)){
                        // iOSは、最下部のボタンが押せないのでスペースを作る
                		if (touch_mode && navigator.userAgent.match(/iP(hone|ad|od)/i)){
	                		var ios_margin_bottom = 20;
                		}
                		elem.height(window_h - global_header_h - ios_margin_bottom);
                	} else if (content_h < elem.find('.modal-dialog-content').height()){
                		// ランドスケープで高さが大きくなったら高さを自動にする
                		elem.css("height" , "" );
                	}
                    elem.css('top', (window_h - elem.height() + global_header_h - ios_margin_bottom) / 2);
                	var ua = navigator.userAgent;
                	var is_mobile = false;
                	if(ua.indexOf('iPhone') > 0 || ua.indexOf('iPod') > 0 || ua.indexOf('Android') > 0 && ua.indexOf('Mobile') > 0) {
                        is_mobile = true;
                    }
                	// データ移行モーダル スマホのみ
                    if (touch_mode && is_mobile) {
                        if (elem.parent().find('.migrationEnqDialog').length > 0 && elem.parent().find('.migrationEnqConfirmDialog').length === 0) {
                            if (window_h < 844) {
                                elem.parent().find('.migrationEnqDialog').css('top', (window_h - elem.height() + global_header_h));
                            } else if (window_h > 895) {
                                elem.parent().find('.migrationEnqDialog').css('top', (window_h - elem.height() + global_header_h) / 2);
                            } else {
                                elem.parent().find('.migrationEnqDialog').css('top', (window_h - elem.height() + global_header_h) / 2);
                            }
                        }
                        if (elem.parent().find('.migrationEnqConfirmDialog').length > 0) {
                            if (window_h < 844) {
                                elem.parent().find('.migrationEnqConfirmDialog').css('top', (window_h - elem.height() + global_header_h));
                            } else if (window_h > 895) {
                                elem.parent().find('.migrationEnqConfirmDialog').css('top', (window_h - elem.height() + global_header_h) / 2);
                            } else {
                                elem.parent().find('.migrationEnqConfirmDialog').css('top', (window_h - elem.height() + global_header_h) / 2);
                            }
                        }
                        if (elem.parent().find('.migrationEnqDialog').length > 0 && elem.parent().find('.migrationEnqConfirmDialog').length === 0) {
                            elem.parent().find('.migrationEnqDialog').css('height', '470px');
                        }
                        if (elem.parent().find('.helpDialogSp').length > 0) {
                            elem.parent().find('.helpDialogSp').css('top', (window_h - elem.height() - global_header_h - ios_margin_bottom) / 2);
                        }
                    }
                }else{
                    elem.find('.modal-dialog-content').height(content_h);
                    var global_header_h = 0;
                    if (touch_mode){
                    	global_header_h = $('div.header').height();
                    }
                    elem.css('top', (window_h - (content_h + header_h + footer_h - global_header_h)) / 2);
                }
            }
            if($('#clsd-msg').length>=1&&!touch_mode){
                var w_h = $(window).height();
                var modal_h = (w_h*90)/100;
                if (modal_h > 820){
                    elem.data('content_h',elem.data('content_h')+100);
                    $('.optionDialog').css('height','830px');
                    $('.optionDialogInner').css('height','730px');
                }else{
                    var sub_h = modal_h-100;
                    $('.optionDialog').css('height',modal_h+'px');
                    $('.optionDialogInner').css('height',sub_h+'px');
                }
            }
             if($('#infoPupCls').length >=1 && !touch_mode){
                $('body').css('background-color','#F9F9F9')
                $('.sidebar-grayout-layer').unbind("click");
                $('#infoPopUpOuter').css('width','860px !important');
                $('#infoPopUpOuter').css('height','460px');
                $('#infoPopUpOuter').css("position","absolute");
                $('#infoPopUpOuter').css("top", ( (window.height - 460 )/ 2) + "px");
                $('#infoPopUpOuter').css("right", ( (window.width - 860 ) / 2)+ "px");

            }else if($('#infoPupCls').length >=1 && touch_mode){

                $('#infoPopUpOuter').css("margin-top", ( (window.screen.height - 460 )/ 2) + "px");
                $('.sidebar-grayout-layer').unbind("click");
                $('.sidebar-grayout-layer').css("z-index","1000");
            }
        }

        function positionDialog(elem, dialog_w, content_h) {
            var window_w = $(window).width();

            if (dialog_w > window_w * 0.9) {
                //elem.width(window_w * 0.9);
                elem.css('left', '5%');
            } else {
                elem.width(dialog_w);
                elem.css('left', (window_w - dialog_w) / 2);
            }

            return elem.css("left");
        }

        function WidthCheck(elem, dialog_w, content_h){
            var left = positionDialog(elem, dialog_w, content_h);
            var window_w = $(window).width();
            left = parseInt(left.replace(/px/g,''),10);

            if(left + 860 > window_w){
                widthHandler(left);
                $(window).bind('scroll', left , widthHandler);
            }else{
                $(window).unbind('scroll',widthHandler);
            }
        }

        var widthHandler = function(left){
                var x = $(window).scrollLeft();
                if(typeof(left) == 'number'){
                    var move = left - x;
                }else{
                    var move = left.data - x;
                }
                elem.css("left",move);
        }

        function HeihgtCheck(elem, content_h){

            var window_h = $(window).height();
            var header_h = elem.find('h2').outerHeight();
            if (header_h == null) {
                header_h = 50;
            }
            var footer_h = elem.find('.modal-dialog-footer').outerHeight();

            if ($('#rs-dialog').is(':visible')){
                var offset_name = "#rs-dialog";
            }else{
                var offset_name = "#pr-dialog";
            }

            var offset = $(offset_name).offset();

            if (70 + content_h + header_h + footer_h > window_h) {
                heightHandler(offset);
                $(window).bind('scroll', offset , heightHandler);
            } else {
                $(window).unbind('scroll',heightHandler);
                elem.css('top', (window_h - (content_h + header_h + footer_h)) / 2);
            }
        }

        var heightHandler = function(offset){

            var y = $(window).scrollTop();
            if(typeof(offset.top) == 'number'){
                var move = offset.top - y;
            }else{
                var move = offset.data.top - y;
            }
            elem.css("top",move);
        }


        if( !( elem.is("#pr-dialog") || elem.is("#rs-dialog") ) || touch_mode ){
            resizeDialog(elem, dialog_w, content_h);
            $(window).resize(function() {
                resizeDialog(elem, dialog_w, content_h)
            });
        }else{
            if(!elem.is("#pr-dialog")){
                elem.css('top', '12%');
                WidthCheck(elem, dialog_w, content_h);
                HeihgtCheck(elem, content_h);

                $(window).resize(function() {
                    $(window).unbind('scroll', heightHandler);
                    $(window).unbind('scroll', widthHandler);
                    WidthCheck(elem,dialog_w, content_h);
                    HeihgtCheck(elem, content_h)
                });
            }
        }
    }, 
    closeDialog: function(elem) {
        elem.hide();
        utils.unsetGrayout();

        if (touch_mode) {
            $('.fixfixed').removeClass('fixfixed');

            zoomEnable();
        }
    },

    messageBox: function(param, callback, cancel_callback, add_class, add_dialog_class, is_not_close_grayout) {
        if ($(".alert-dialog").html() == undefined) {
            cancel = null;
            if (param.length >= 3) {
                cancel = param[2]
            }
            var options = {
                'message': param[0], 
                'ok': param[1], 
                'cancel': cancel
            }
            message = param[0];
            ok = param[1];
            if(param[3]=='enqdelete' || param[3]== 'ansdelete'){
                options = {
                    'message': param[0], 
                    'ok': param[1], 
                    'cancel': cancel,
                    'extra':param[3],
                    // 'tooltipdata':param[4]
                }
                extra = param[3];
            }
            
            
            
            var el = $('<div>');
            el.addClass('alert-dialog');
            if (add_class != null) el.addClass(add_class);
            if (add_dialog_class != null) el.addClass(add_dialog_class);
            el.html(_.template($('#message-box-template').html(), options));
            if (el.html().indexOf('&lt;') >= 0){
                el.html( el.html().replace('&lt;b&gt;', '<b>'));
                el.html( el.html().replace('&lt;/b&gt;', '</b>'));
                el.html( el.html().replace('&lt;span&gt;', '<span>'));
                el.html( el.html().replace('&lt;/span&gt;', '</span>'));
                
                if(param[0].indexOf('赤字の件数が申し込み可能数です。') != -1){
                    
                for(var i=0 ;i<=12;i++){
                    el.html( el.html().replace('&lt;span&gt;', '<span>'));
                    el.html( el.html().replace('&lt;/span&gt;', '</span>'));
                    }
                    el.html( el.html().replace('&lt;br&gt;', '<br>'));
                }
                el.html( el.html().replace('&lt;br&gt;', '<br>'));
                el.html( el.html().replace('&lt;br/&gt;', '<br/>'));
                el.html( el.html().replace('&lt;a&gt;', '<a>'));
                el.html( el.html().replace('&lt;/a&gt;', '</a>'));
                }
            $('body').append(el);
            el.fadeIn();

            if(param[0] == 'BROWSER_CHECK' && param[3] != 'ansdelete' && param[3] != 'enqdelete'){
              $('.alert-dialog').css('width','560px');
              $('.alert-dialog-content-wrapper').css('margin-top','30px');
              $('.message-box-ok').remove();
            }

            if(param[0].indexOf('アンケートを終了するとアンケートに回答できなくなります。終了にしますか？')!=-1 || param[0].indexOf('Closing this questionnaire will disable your')!=-1 || param[0].indexOf('を回収中に変更しますか')!=-1 || param[0].indexOf('during collecting?')!=-1){
              $('.msgbx-1').css('display','none');
              $('.msgbx-2').css('display','table-cell');
              $('#pb-clsd1').css('color','red');
              $('#pb-clsd1').css('font-size','14px');
              $('#pb-clsd2').css('color','red');
              $('#pb-clsd2').css('font-size','14px');

              }
            
            if(param[0].indexOf('赤字の件数が申し込み可能数です。')!=-1){
               $('.alert-dialog-content p').css('background-image','none');
               $('.alert-dialog-content p').css('padding-left','50px');
               $('.alert-dialog-content p span ').css('color','red');
               $('.alert-dialog-content p span ').css('font-size','14px');
               $('.alert-dialog-content p span span').css('color','red');
               $('.alert-dialog-content p span span').css('font-size','14px;');
                $('.tooltip1').attr('style','font-size:14px !important; font-color:#333333;');
                $('.i-agree').attr('style','font-size:14px !important;font-color:#333333;');
               
            }
             if(param[0]=='z-enquete-check'){
                  $('.alert-dialog-content-wrapper').css('margin-top','20px ');
                  $('.alert-dialog-content p').css('padding-top','10px');
                  $('#normal-qst').removeClass('checked');
                  $('#adhoc-qst').removeClass('checked');
                  if(touch_mode){
                      $('.uiRadio .span-l1').css('margin-top','0px');
                      $('p .main-l1').css('margin-left','-40px');
                      $('p .main-l2').css('margin-left','-40px');
                      $('.alert-dialog-content p span').css('line-height','100%');
                  }
            }
            
             $('.tooltip1').attr('style','font-size:14px !important;');
             $('.i-agree').attr('style','font-size:14px !important;');
             
            if(param[0].indexOf('y-changeEmail')!=-1){
                $('.alert-dialog-content p').css('background-image','none');
                $('.alert-dialog-content p').css('padding-left','50px');
                $('.alert-dialog-content p span').css('font-size','14px');
                $('#em-d1').attr('style','font-size:16px !important;');
                $('#em-d1').css('text-align','center');
                if(touch_mode){
                    $('.alert-dialog-content-wrapper').css('margin-top','25px')
                    $('#em-d2').attr('style','font-size:14px !important;');
                }else{
                    $('.alert-dialog-content-wrapper').css('margin-top','35px')
                    $('#em-d2').attr('style','font-size:14px !important;');
                    $('#em-d3').attr('style','font-size:14px !important;line-height:0%;');
                }
                $('.alert-dialog-footer').css('margin','0px 0px 50px');
            }
            if(param[3] === 'ansdelete'){
                var enquete_delete_dialog_size = 480;
                $(".alert-dialog").addClass("delete-dialog");
                $('.alert-dialog-content').prepend('<div class="alert-dialog-title delete-dialog" style="height:50px; width:'+ enquete_delete_dialog_size +'px;"></div>');
                $('a.cancel').attr('style', 'background-image:linear-gradient(to top, #cc1f1f, #d52625) !important;background-color:#cc1f1f !important;color:#fff !important ;box-shadow : 0 -1px 1px rgba(0, 0, 0, 0.3) inset, 0 1px 1px rgba(255, 255, 255, 0.3) inset !important;text-shadow:0 -1px 0 rgba(0,0,0,0.5) !important;');
                $('span.check-cm').css('display','none');
                $('span.check-cm').css('font-size','14px');
                $('span.delete-check-s').css('font-size','14px');
                $('span.delete-check-s').css('display','block');
                $('a.message-box-ok').css('background-image','linear-gradient(to bottom, #ebebeb, #bdbdbd)');
                $('a.message-box-ok').css('background-color','#bdbdbd !important');
                $('a.message-box-ok').css('color','#444444!important');
                $('a.message-box-ok').css('box-shadow','0px 1px 3px rgba(000,000,000,0), inset 0px 1px 1px rgba(255,255,255,0.2)');
                $('a.message-box-ok').css('text-shadow','0px 0px 0px rgba(000,000,000,0), 1px 1px 0px rgba(240,240,240,1)');
                $('.alert-dialog-content').append('<div class="alert-dialog-content-wrapper2 delete-dialog" style="width:'+ enquete_delete_dialog_size +'px;"></div>');
                // $('.alert-dialog-content').append('<div class="alert-dialog-content-wrapper3" style="width:'+ enquete_delete_dialog_size +'px;"></div>');
                $('.alert-dialog-content-wrapper2').append('<br><p id="delete-agree" style="text-align:center !important; background-image:none;"></p>')
                $('span.delete-check-s').css('margin-left','0px');
                $('.delete-check-s').prependTo('#delete-agree');
                $('#check-confirm').addClass('delete-check-confirm');
                $('#check-confirm').insertAfter('.alert-dialog-content');
                $('p .tooltip1').attr('style','font-size:14px !important; margin-left:-80px !important;');
                $('.alert-dialog-content .msgbx-1').attr('style','text-align:center !important; background-image:none; padding-left:30px; padding-right:30px;');
                $('.i-agree').attr('style','font-size:14px !important; margin-left:-80px !important;');
                $('.alert-dialog-content').css('height','210px')
                $('.alert-dialog').css('height','420px')
                $('div.alert-dialog-content-wrapper').attr('style','width:480px !important; background-color:#ffffe0 !important;');
                $('.alert-dialog-content-wrapper').css('margin-top','0px');
                $('.alert-dialog-content-wrapper').css('margin-left','0px');
                $('.alert-dialog-content-wrapper').css('margin-right','0px');
                $('#del-span-check').css("margin-left", "-80px");
                $('#check-confirm').css("font-size","14px !important;");
                $('.alert-dialog-content .msgbx-1').css('background-image','none !important;');
                $('.alert-dialog-content .msgbx-1').css('display','block');
                $('.alert-dialog-content .msgbx-1').css('margin-top','15px');
                $('.alert-dialog-content .msgbx-1').css('margin-right','0px');
                $('.alert-dialog-content .msgbx-1').css('margin-left','0px');
                $('.alert-dialog-content .msgbx-1').css('height','60px');
                $('#delete-agree').prepend('<p class="msgbx-5">' + param[7] + '</p>');
                if (touch_mode) {
                    // スマホ用設定はここに入れる
                } else {
                    $('.alert-dialog-content .msgbx-1').attr('title',param[4])
                    $('.alert-dialog-content .msgbx-1').css('width','420px');
                }
                if (language_code === 'en') {
                    $('.alert-dialog-title').prepend('<p>Delete answer</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-3">Status : '+ ENQUETE_STATUS_EN[param[5]] +'</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-4">Responses : '+ param[6] +'</p>');
                    $('.alert-dialog-content-wrapper2').append('<span id="nml1" class="ans-delete-caution" style="margin-top: 20px;">※Deletion may take several minutes</span>')
                    $('.alert-dialog-content-wrapper2').append('<span id="nml2" class="ans-delete-caution" style="margin-top: 10px;">Do not press the "Delete" button more than once</span>')
                    $('#delete-agree').css('padding-left','90px');
                    $('#delete-agree').css('height','50px');
                    $('.alert-dialog-content-wrapper2 .msgbx-5').css('padding-left','15px');
                    $('.msgbx-5').css('height','auto');
                    $('#check-confirm').css("margin-left", "-60px");
                    $('.alert-dialog-content .msgbx-2').css('height','20px');
                    $('.alert-dialog-content .msgbx-3').css('height','20px');
                    $('.alert-dialog-content .msgbx-4').css('height','20px');
                } else {
                    $('.alert-dialog-title').prepend('<p>回答クリア</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-3">ステータス : '+ ENQUETE_STATUS[param[5]] +'</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-4">回答数 : '+ param[6] +'</p>');
                    $('.alert-dialog-content-wrapper2').append('<span id="nml1" class="ans-delete-caution" style="margin-top: 20px;">※削除には数分かかります。</span>')
                    $('#nml1').append('<a id="nml1-a-tag" href="https://help.questant.jp/hc/ja/articles/6166636021657" target="_blank" style="text-decoration:underline;">詳しくはこちら</a>');
                    $('.alert-dialog-content-wrapper2').append('<span id="nml2" class="ans-delete-caution" style="margin-top: 10px;">「削除する」ボタンは複数回押さないでください</span>')
                    $('#check-confirm').css("margin-left", "-80px");
                    $('#del-span-check').css('padding-right','0px');
                }
                $('#del-check').change(function() {
                    if(this.checked) {
                    $('a.message-box-ok').css('background-image','linear-gradient(to top, #cc1f1f, #d52625)');
                    $('a.message-box-ok').css('background-color','#cc1f1f');
                    $('a.message-box-ok').css('color','#fff');
                    $('a.message-box-ok').css('box-shadow','0 -1px 1px rgba(0, 0, 0, 0.3) inset, 0 1px 1px rgba(255, 255, 255, 0.3) inset');
                    $('a.message-box-ok').css('text-shadow','0 -1px 0 rgba(0,0,0,0.5)');
                    }
                    if (this.checked === false){
                    $('a.message-box-ok').css('background-image','linear-gradient(to bottom, #ebebeb, #bdbdbd)');
                    $('a.message-box-ok').css('background-color','#bdbdbd !important');
                    $('a.message-box-ok').css('color','#444444!important');
                    $('a.message-box-ok').css('box-shadow','0px 1px 3px rgba(000,000,000,0), inset 0px 1px 1px rgba(255,255,255,0.2)');
                    $('a.message-box-ok').css('text-shadow','0px 0px 0px rgba(000,000,000,0), 1px 1px 0px rgba(240,240,240,1)');
                    }
                });
            } else if(param[3] === 'enqdelete') {
                // アンケート削除用に作成する
                var enquete_delete_dialog_size = 480;
                $(".alert-dialog").addClass("delete-dialog");
                $('.alert-dialog-content').prepend('<div class="alert-dialog-title delete-dialog" style="height:50px; width:'+ enquete_delete_dialog_size +'px;"></div>');
                $('a.cancel').attr('style', 'background-image:linear-gradient(to top, #cc1f1f, #d52625) !important;background-color:#cc1f1f !important;color:#fff !important ;box-shadow : 0 -1px 1px rgba(0, 0, 0, 0.3) inset, 0 1px 1px rgba(255, 255, 255, 0.3) inset !important;text-shadow:0 -1px 0 rgba(0,0,0,0.5) !important;');
                $('span.check-cm').css('display','none');
                $('span.check-cm').css('font-size','14px');
                $('span.delete-check-s').css('font-size','14px');
                $('span.delete-check-s').css('display','block');
                $('a.message-box-ok').css('background-image','linear-gradient(to bottom, #ebebeb, #bdbdbd)');
                $('a.message-box-ok').css('background-color','#bdbdbd !important');
                $('a.message-box-ok').css('color','#444444!important');
                $('a.message-box-ok').css('box-shadow','0px 1px 3px rgba(000,000,000,0), inset 0px 1px 1px rgba(255,255,255,0.2)');
                $('a.message-box-ok').css('text-shadow','0px 0px 0px rgba(000,000,000,0), 1px 1px 0px rgba(240,240,240,1)');
                $('.alert-dialog-content').append('<div class="alert-dialog-content-wrapper2 delete-dialog" style="width:'+ enquete_delete_dialog_size +'px;"></div>');
                $('.alert-dialog-content-wrapper2').append('<br><p id="delete-agree" style="text-align:center !important; background-image:none;"></p>')
                $('span.delete-check-s').css('margin-left','0px');
                $('.delete-check-s').prependTo('#delete-agree');
                $('#check-confirm').addClass('delete-check-confirm');
                $('#check-confirm').insertAfter('.alert-dialog-content');
                $('p .tooltip1').attr('style','font-size:14px !important; margin-left:-80px !important;');
                $('.alert-dialog-content .msgbx-1').attr('style','text-align:center !important; background-image:none; padding-left:30px; padding-right:30px;');
                $('.i-agree').attr('style','font-size:14px !important; margin-left:-80px !important;');
                $('.alert-dialog-content').css('height','210px')
                $('.alert-dialog').css('height','350px')
                $('div.alert-dialog-content-wrapper').attr('style','width:480px !important; background-color:#ffffe0 !important;');
                $('.alert-dialog-content-wrapper').css('margin-top','0px');
                $('.alert-dialog-content-wrapper').css('margin-left','0px');
                $('.alert-dialog-content-wrapper').css('margin-right','0px');
                $('#nml').css('display','none');
                $('#nml1').css('display','none');
                $('#nml2').css('display','none');
                $('#del-span-check').css("margin-left", "-80px");
                $('#check-confirm').css("font-size","14px !important;");
                $('.alert-dialog-content .msgbx-1').css('background-image','none !important;');
                $('.alert-dialog-content .msgbx-1').css('display','block');
                $('.alert-dialog-content .msgbx-1').css('margin-top','15px');
                $('.alert-dialog-content .msgbx-1').css('margin-right','0px');
                $('.alert-dialog-content .msgbx-1').css('margin-left','0px');
                $('.alert-dialog-content .msgbx-1').css('height','60px');
                $('#delete-agree').prepend('<p class="msgbx-5">' + param[7] + '</p>');
                if (touch_mode) {
                    // スマホ用設定はここに入れる

                } else {
                    $('.alert-dialog-content .msgbx-1').attr('title',param[4])
                    $('.alert-dialog-content .msgbx-1').css('width','420px');
                }
                if (language_code === 'en') {
                    $('.alert-dialog-title').prepend('<p>Delete survey</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-3">Status : '+ ENQUETE_STATUS_EN[param[5]] +'</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-4">Responses : '+ param[6] +'</p>');
                    $('#delete-agree').css('padding-left','90px');
                    $('#delete-agree').css('height','50px');
                    $('.alert-dialog-content-wrapper2 .msgbx-5').css('padding-left','15px');
                    $('.msgbx-5').css('height','auto');
                    $('#check-confirm').css("margin-left", "-60px");
                    $('.alert-dialog-content .msgbx-2').css('height','20px');
                    $('.alert-dialog-content .msgbx-3').css('height','20px');
                    $('.alert-dialog-content .msgbx-4').css('height','20px');
                } else {
                    $('.alert-dialog-title').prepend('<p>アンケートを削除</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-3">ステータス : '+ ENQUETE_STATUS[param[5]] +'</p>');
                    $('.alert-dialog-content-wrapper').append('<p class="msgbox msgbx-4">回答数 : '+ param[6] +'</p>');
                    $('#check-confirm').css("margin-left", "-80px");
                    $('#del-span-check').css('padding-right','0px');
                }
                $('#del-check').change(function() {
                    if(this.checked) {
                    $('a.message-box-ok').css('background-image','linear-gradient(to top, #cc1f1f, #d52625)');
                    $('a.message-box-ok').css('background-color','#cc1f1f');
                    $('a.message-box-ok').css('color','#fff');
                    $('a.message-box-ok').css('box-shadow','0 -1px 1px rgba(0, 0, 0, 0.3) inset, 0 1px 1px rgba(255, 255, 255, 0.3) inset');
                    $('a.message-box-ok').css('text-shadow','0 -1px 0 rgba(0,0,0,0.5)');
                    }
                    if (this.checked === false){
                    $('a.message-box-ok').css('background-image','linear-gradient(to bottom, #ebebeb, #bdbdbd)');
                    $('a.message-box-ok').css('background-color','#bdbdbd !important');
                    $('a.message-box-ok').css('color','#444444!important');
                    $('a.message-box-ok').css('box-shadow','0px 1px 3px rgba(000,000,000,0), inset 0px 1px 1px rgba(255,255,255,0.2)');
                    $('a.message-box-ok').css('text-shadow','0px 0px 0px rgba(000,000,000,0), 1px 1px 0px rgba(240,240,240,1)');
                    }
                });
            }
            if(param[0]=='z-enquete-check'){
                if($('input[name=enquetetype]:checked').val() !== undefined){
                    $("#engrd-error").css('display','none'); 
                }
            }
            if (cancel) {
                el.find('a.cancel').click(function(e) {
                    closeDialog();
                    extra = null;
                    e.stopPropagation();
                    if (cancel_callback) {
                        cancel_callback();
                    }
                });
            }
            el.find('a.message-box-ok').click(function() {
                if(param[3] === 'enqdelete' || param[3] === 'ansdelete'){
                    if(document.getElementById('del-check').checked){
                        closeDialog(true);
                        extra = null;
                    }
                    else{
                        $('span.check-cm').css('color','red');
                        $('span.check-cm').css('display','block');
                    }
                }else if(param[0]=='z-enquete-check'){
                    var v_check = $('input[name=enquetetype]:checked').val();
                    if(!$('#normal-qst').hasClass('checked') && !$('#adhoc-qst').hasClass('checked')){
                        $("#engrd-error").css('display','inline');
                    }else{
                        $("#engrd-error").css('display','none');        
                        closeDialog(true);
                        
                    }
                }else{
                    
                    closeDialog(true);
                }
            });
    
            utils.setGrayout(function() {
            if(!(param[0].indexOf('アンケートを終了するとアンケートに回答できなくなります。終了にしますか？')!=-1 || param[0].indexOf('Closing this questionnaire will disable your')!=-1 || param[0].indexOf('を回収中に変更しますか')!=-1 || param[0].indexOf('during collecting?')!=-1)){
              closeDialog();
            } 
                return false;
            },undefined, undefined, undefined, is_not_close_grayout);
    
            // ウィンドウリサイズ
            var dialog_w = el.outerWidth();
            var dialog_h = el.outerHeight();
    
            // console.log(el.find('img').height());
    
            function resizeDialog(elem, dialog_w, dialog_h) {

                var classVal = elem.attr('class');
                var classVals = classVal.split(' ');
                var delete_elem = "";
                for (var i = 0; i < classVals.length; i++) {
                    if(classVals[i] === "delete-dialog") {
                        // アンケート削除ダイアログ用リサイズ設定
                        delete_elem = elem;
                    }
                }
                var window_w = $(window).width();
                var min_w = parseInt(elem.css('min-width'));
                if (dialog_w > window_w * 0.9) {
                    var w = window_w * 0.9;                
                    if (w < min_w) w = min_w;
                    elem.width(w);
                    elem.css('left', '5%');
                    if (delete_elem) {
                        $('.alert-dialog-title').width(w);
                        $('.alert-dialog-content-wrapper').width(w);
                        $('.alert-dialog-content-wrapper2').width(w);
                        $('.msgbx-5').width(w * 0.625);
                        $('#check-confirm').css("transform","translate(180px, 0px)");
                        if (window_w < 400) {
                            $('#check-confirm').css("margin-left","-145px");
                        }
                        else {
                            $('#check-confirm').css("margin-left","-135px");
                        }
                        if (language_code === 'en') {
                            $('#delete-agree').css("padding-left","20px");
                            $('.msgbx-5').css("padding-left", "30px");
                            $('.msgbx-5').width(w * 0.8);
                            if (window_w < 400) {
                                $('#check-confirm').css("margin-left","-120px");
                            }
                            else {
                                $('#check-confirm').css("margin-left","-110px");
                            }
                        }
                    }
                } else {
                    elem.width(dialog_w);
                    elem.css('left', (window_w - dialog_w) / 2);
                    if (delete_elem) {
                        $('.alert-dialog-title').width(dialog_w);
                        $('.alert-dialog-content-wrapper').width(dialog_w);
                        $('.msgbx-5').width(dialog_w * 0.625);
                        $('#delete-agree').css("padding-left","110px");
                        $('#delete-agree').css("padding-right","30px");
                        if (language_code === 'ja') {
                            $('.msgbx-5').css("padding-left", "0px");
                        }
                        $('.msgbx-5').css("padding-right", "0px");
                        $('#check-confirm').css("transform","translate(180px, 0px)");
                        $('#del-span-check').css("padding-right","80px");
                    }
                }
    
                var window_h = $(window).height();
                if (dialog_h > window_h * 0.9) {
                    var h = window_h * 0.9;
                    var min_h = parseInt(elem.css('min-height'));
                    if (h < min_h) h = min_h;
                    elem.height(h);
                    elem.css('top', '5%');
                } else {
                    elem.height(dialog_h);
                    elem.css('top', (window_h - dialog_h) / 2);
                }
                elem.find('.alert-dialog-content').height(elem.height()-80);

                if (elem.width() === min_w) {
                    // 狭い画面でボタンを縦に配置するための調整
                    dialog_h += 50;
                    elem.height(dialog_h);
                    elem.find('.alert-dialog-content').height(elem.height()-120);
                }
            }

            $(window).resize(function() {
                resizeDialog(el, dialog_w, dialog_h)
            });
            resizeDialog(el, dialog_w, dialog_h);
    
            function closeDialog(ok) {
                if (ok && callback) {
                    callback();
                }
                utils.unsetGrayout();
                el.remove();
            }
        }
    },

	imageDeleteMessageBox: function(param, callback, cancel_callback, add_class, add_dialog_class) {
        if ($(".alert-dialog").html() == undefined) {
            var cancel = param[2];
            var options = {
                'message': param[0],
                'ok': param[2],
                'cancel': param[1]
            };
            var el = $('<div>');
            el.addClass('alert-dialog');
            if (add_class != null) el.addClass(add_class);
            if (add_dialog_class != null) el.addClass(add_dialog_class);
            el.html(_.template($('#message-box-template').html(), options));
            $('body').append(el);
            el.fadeIn();
            el.find('a.message-box-ok').remove();
            el.find('a.cancel').click(function(e) {
                closeDialog();
                e.stopPropagation();
                if (cancel_callback) {
                    cancel_callback();
                }
            });
            utils.setGrayout(function() {
                closeDialog();
                return false;
            });

            // ウィンドウリサイズ
            var dialog_w = el.outerWidth();
            var dialog_h = el.outerHeight();

            function resizeDialog(elem, dialog_w, dialog_h) {
                var window_w = $(window).width();
                var min_w = parseInt(elem.css('min-width'));
                if (dialog_w > window_w * 0.9) {
                    var w = window_w * 0.9;
                    if (w < min_w) w = min_w;
                    elem.width(w);
                    elem.css('left', '5%');
                } else {
                    elem.width(dialog_w);
                    elem.css('left', (window_w - dialog_w) / 2);
                }

                var window_h = $(window).height();
                if (dialog_h > window_h * 0.9) {
                    var h = window_h * 0.9;
                    var min_h = parseInt(elem.css('min-height'));
                    if (h < min_h) h = min_h;
                    elem.height(h);
                    elem.css('top', '5%');
                } else {
                    elem.height(dialog_h);
                    elem.css('top', (window_h - dialog_h) / 2);
                }
                elem.find('.alert-dialog-content').height(elem.height()-80);

                if (elem.width() === min_w) {
                    // 狭い画面でボタンを縦に配置するための調整
                    dialog_h += 50;
                    elem.height(dialog_h);
                    elem.find('.alert-dialog-content').height(elem.height()-120);
                }
            }

            $(window).resize(function() {
                resizeDialog(el, dialog_w, dialog_h)
            });
            resizeDialog(el, dialog_w, dialog_h);

            function closeDialog(ok) {
                if (ok && callback) {
                    callback();
                }
                utils.unsetGrayout();
                el.remove();
            }
        }
    },
    editorDialog: function (elem, selector) {
        // openDialog との違い:
        //   表示位置が常にヘッダ直下
        //   高さが画面の半分まで
        var is_iOS = touch_mode && navigator.userAgent.match(/iP(hone|ad|od)/i);
        var elem = elem;
        var z_index = 100;
        utils.setGrayout(function() {
            utils.closeDialog(elem);
            $(window).off('scroll', utils.focusAgain);
			if ($('#cancelCKEditor').is(':visible') && is_iOS){
            	$('#dummytextarea').show();
            	$('#dummytextarea').focus();
            	$('#dummytextarea').blur();
            	$('#dummytextarea').hide();
        	}
            return false;
        }, 0.5, z_index, selector);

        elem.show();

        var init = elem.data('init')
        if (!init) {
            elem.find('a.cancel').click(function() {
                utils.closeDialog(elem);
                $(window).off('scroll', utils.focusAgain);
            });
            elem.data('init', 1)
        }

        // 初回のみデフォルトの幅と高さを計算
        //   2回目以降は data 属性にいれておく
        var dialog_w = elem.data('dialog_w')
        if (!dialog_w) {
            dialog_w = elem.outerWidth();
            elem.data('dialog_w', dialog_w)
        }
        var content_h = elem.data('content_h')
        if (!content_h) {
            content_h = elem.find('.modal-dialog-content').height();
            elem.data('content_h', content_h)
        }

        function resizeDialog(elem, dialog_w, content_h) {
            var window_w = $(window).width();
            // var dialog_w = elem.outerWidth();

            if (dialog_w > window_w * 0.9) {
                elem.width(window_w * 0.9);
                elem.css('left', '5%');
            } else {
                elem.width(dialog_w);
                elem.css('left', (window_w - dialog_w) / 2);
            }

            var window_h = $(window).height();
            var header_h = elem.find('h2').outerHeight();
            if (header_h == null) {
                header_h = 50;
            }
            var footer_h = elem.find('.modal-dialog-footer').outerHeight();
            // var content_h = elem.find('.modal-dialog-content').height();

            // iOSのキーボードは出現してもウィンドウサイズが変わらないので区別する。
            if(is_iOS) {
                var sizing_rate = 0.5;
            } else {
                var sizing_rate = 0.8;
            }
            if (content_h + header_h + footer_h > window_h * sizing_rate) {
                var h = window_h * sizing_rate - header_h - footer_h;
                if (h < 150) {
                    h = 150;
                }
                elem.find('.modal-dialog-content').height(h);
            } else {
                elem.find('.modal-dialog-content').height(content_h);
            }
            // スークロールバー表示部の高さをモーダルのサイズ変更に合わせて調節する。
            if(elem.find('.cke_contents').length > 0) {
                var cke_contents = elem.find('.cke_contents');
                if(is_iOS) {
                    var toolbar_h = $(".cke_bottom").height();
                } else {
                    var toolbar_h = $(".cke_top").height();
                }
                cke_contents.height(elem.find('.modal-dialog-content').height() - toolbar_h - 20);
            }
            // 常にヘッダ直下に配置
            elem.css('top', '55px');
        }

        $(window).resize(function() {
            resizeDialog(elem, dialog_w, content_h)
        });
        resizeDialog(elem, dialog_w, content_h);
    },

    focusAgain: function () {
        var iframe = $('#CKEditorDialog iframe.cke_wysiwyg_frame')[0];
        if ($('.cke_dialog_body').is(':visible') ||
            $('.cke_panel').is(':visible') ||
            $('.cke_combopanel').is(':visible')) {
            return;
        }

        var panel = $('iframe.cke_panel_frame')[0];
        if (!panel && iframe) {
            iframe.contentWindow.focus();
        }
    },

    normalizeFont: function (input) {
        var sizeToPx = {
            1: 11, 2: 13, 3: 16, 4: 19, 5: 24, 6: 32, 7: 48
        };
        var $output = $("<div>").html(input);
        if ($output.find("font")[0]) {
            _.each($output.find("font"), function (fonttag, index) {
                var $alt = $("<span>");
                if ($(fonttag).attr("size")) {
                    var size = $(fonttag).attr("size");
                    $alt.css({fontSize: sizeToPx[size]});
                }
                if ($(fonttag).attr('color')) {
                    $alt.css({color: $(fonttag).attr("color")});
                }
                $alt.html(fonttag.innerHTML);
                $(fonttag).replaceWith($alt[0].outerHTML);
            });
        }
        return $output.html();
    },

    setIntervalTimes: function(func, interval, time) {
        /* func を interval 間隔で time 回実行する。
         * 第4引数以降に func に渡す引数を指定可 */
        var args = Array.prototype.slice.call(arguments, 3);
        return setTimeout(function() {
            var interval_args = [func, interval, time--].concat(args);
            if (time > 0) utils.setIntervalTimes.apply(null, interval_args);
            return func.apply(null, args);
        }, interval);
    }
}

function optimal_width(elem, base_elem, qtype){
    var width = elem.css("width");
    var max_width = base_elem.css("width");

    if (qtype == null) qtype = '';
    if (qtype == 'scale') {
        // 例外
        var $uiScale = elem.parents('.uiScale:first');
        var choice_num = $uiScale.find('.disp_logic').length;
        if (choice_num) max_width = String(parseInt($uiScale.width() / choice_num) - 10);
    } else if (qtype == 'images' || qtype == 'choiceimage-radio' || qtype == 'choiceimage-checkbox') {
        max_width = String(base_elem.width() - 20);
    }

    if (max_width == undefined) {
        return width;
    }
    if(parseInt(width.replace("px","")) > parseInt(max_width.replace("px",""))) {
        width = max_width;
    }
    return width;
}

function adjust_textbox_edit(root){
    root.find(':input').each(function(){
        var $block = $(this).parents('.textboxSet');
        if (!$block[0]) {
            // console.log("テキストボックスと関係ないので抜ける");
            return;
        }
        $(this).css('max-width', '');
        $block.css('max-width', '');
        $block.find('.textbox_unit').css('max-width', '');
        var unitWidth = $block.find('.textbox_unit').outerWidth();
        var guideTxt = $block.find('.guideTxt').outerWidth();

        var inputWidth = $(this).outerWidth() + unitWidth + guideTxt + 35;
        var blockWidth = $block.width();
        if (root.find('.uiTextbox').length > 0) {
            // テキストボックスタイプ
            blockWidth = $block.parent().width();
        }

        if (blockWidth > inputWidth) {
            $block.css('max-width', inputWidth + 'px');
        } else if (unitWidth) {
            var unitWidth = $block.find('.textbox_unit').width();
            if (!unitWidth) unitWidth = 0;
            if (blockWidth*0.2 < unitWidth ) {
              $(this).css('max-width', '80%');
              $block.find('.textbox_unit').css('max-width', '20%');
            } else {
              unitWidth += 4;
              $(this).css('max-width', $(this).outerWidth() - unitWidth + 'px');
            }
        }
        // $target.parents('.textboxSet').width($target.outerWidth());
    });
    var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
    var isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
    if(isChrome || isFirefox){
        $('#enqueteEdit .uiTextbox textarea,#enqueteEdit .textbox-in textarea,#enqueteResult .uiTextbox textarea,#enqueteResult .textbox-in textarea').each(function(){
            var el=$(this).closest("textarea");
            var start_width=$(el).width();
            var skip_widht_change=$(el).attr('skip_widht_change');
            if( el && start_width >0 && skip_widht_change ==undefined ){
                $(el).attr("skip_widht_change", start_width);
                $(el).width(start_width-10);
            }
        });
    }
    return;
}

function adjust_imgarea_edit(root){
    //　画像が表示領域を飛び出さないようにする処理            
    root.find('.addImgEditWrap:has(.addImgEdit)').each(function(){
        if ($(this).parents("#answerSPPreview").length > 0) return;

        var qtype = "radio";
        if ($(this).parents(".questionContent").find(".uiMatrix").html() != undefined) {
            qtype = "matrix";
        } else if ($(this).parents(".questionContent").find(".uiMatrixVertical").html() != undefined) {
            qtype = "matrix-vertical";
        } else if ($(this).parents(".questionContent").find(".uiRanking").html() != undefined) {
            qtype = "ranking";
        } else if ($(this).parents(".questionContent").find(".uiScale").html() != undefined) {
            qtype = "scale";
        } else if ($(this).parents(".uiTextboxSum").html() != undefined) {
            qtype = "textbox-sum";
        }
        
        if (qtype.indexOf('scale') != -1) {
            var choice_num = $(this).parents('.uiScale').find('.disp_logic').length;
            if (!choice_num) return;

            var q_width = $(this).parents('.uiScale:first').width();
            var frame_size = parseInt(q_width / choice_num) - 10;

        } else { 
            var frame = $(this).parents('td:first');
            if (frame.length != 1) frame = $(this).parents('th:first');
            if (frame.length != 1) frame = root;

            if (qtype == 'matrix') {
                var frame_size = $(this).parents('table').find('thead th:first').width();
            } else if (qtype.indexOf('matrix') != -1 ||
                       qtype.indexOf('ranking') != -1 ||
                       qtype == 'textbox-sum') {
                var frame_size = frame.width();
            } else {
                var frame_size = frame.width() - 60;
            }
        }
        $(this).css('max-width', '');
        var image_size = $(this).width();
        if (!frame_size || frame_size <= 0) return;
        if (!image_size || image_size <= 0) return;

        $(this).css('max-width', frame_size + 'px');
    });    
}

function adjust_sp_choice_height($root) {
    // ラジオボタン、チェックボックスの選択肢高さ調整 (SP)
    function adjust($tr) {
      $tr.find('label').height('');
      var maxHeight = 0;
      $tr.find('label').each(function(){
          var height = $(this).height();
          if (height > maxHeight) maxHeight = height;
      });
      $tr.find('label').each(function(){
          $(this).height(maxHeight);
      });
    }
    $root.find('tr').each(function(){
        var $img = $(this).find('img');
        $tr = $(this);
        if ($img.length > 0) {
            $img.ready(function(){
                adjust($tr);
            });
            return;
        }
        adjust($(this));
    });
}

function adjust_movie_size($root, origin_w, origin_h) {
    var max_width = $root.width();
    var $movie = $root.find('.youtube');
    var movie_width = +$movie.attr('width');
    var movie_height = +$movie.attr('height');
    if (!isFinite(movie_width)) return;
    if (!isFinite(movie_height)) return;

    if (!isFinite(origin_w)) origin_w = movie_width;
    if (!isFinite(origin_h)) origin_h = movie_height;

    var new_width = max_width;
    if (origin_w <= max_width) new_width = origin_w;
    if (movie_width == new_width) return;

    var new_height = parseInt(new_width * (origin_h / origin_w), 10);
    $movie.attr('width', new_width);
    $movie.attr('height', new_height);
}

function adjust_textbox_sum($question) {
    var $table = $question.find('table.uiTextboxSum');
    if ($table.length == 0) return;

    var tableWidth = $table.width();
    var captionWidth = $table.find('textarea:first').position().left;
    var guideWidth = $table.find('.guide:first').width();
    var maxBoxWidth = 0;
    $table.find('textarea').each(function() {
        var w = $(this).outerWidth();
        if (w > maxBoxWidth) maxBoxWidth = w;
    });
    var paddingRightWidth = tableWidth - (captionWidth + maxBoxWidth);

    var maxGuidePos = 0
    $table.find('.guide').each(function() {
        var p = $(this).position().left;
        if (p > maxGuidePos) maxGuidePos = p;
    });
    var hrWidth = maxGuidePos + guideWidth;

    var $sum = $table.find('td.sum');
    var $hr = $table.find('hr');
    $sum.css('padding-right', paddingRightWidth + "px");
    $hr.width(hrWidth);
}

function getChoiceimageColSize(root, touch_mode) {
    if (touch_mode) return 2;

    var maxColSize = 3;
    var colSize = 1;
    root.find('ul').each(function(){
        var size = $(this).find('label:visible').length;
        if (size > maxColSize) size = maxColSize;
        if (size > colSize) colSize = size;
    });

    return colSize;
}
function adjustChoiceimageWidth(attrs, root) {
    if (!attrs['qtype']) {
        return;
    }
    var qtype = attrs['qtype'];
    if (qtype.indexOf('choiceimage') == -1) {
        return;
    }

    var touch_mode = touch_mode || attrs.sp_preview_mode == true;
    var colSize = getChoiceimageColSize(root, touch_mode);
    var widthRate = 100 / colSize;
    root.find('li.normal-choice').width(widthRate + '%');
}

function afterImageLoaded($root, callback, args) {
    /*
    $root 要素内に存在する img タグの
    各画像が読み込まれてから callback を実行する
    引数が必要な場合は args に入れる。
    */
    var imgUrlList = [];
    var loadedImgList = [];

    $root.find('img').each(function() {
        var imgUrl = $(this).attr('src');
        if (imgUrl == null ||
              _.contains(imgUrlList, imgUrl)) return;

        imgUrlList.push(imgUrl);
    });

    function onLoadImg($img) {
        var imgUrl = $img.attr('src');
        if (imgUrl == null ||
              _.contains(loadedImgList, imgUrl)) return;

        loadedImgList.push(imgUrl);

        if (loadedImgList.length < imgUrlList.length) return;
        setTimeout(function() {
            callback(args);
        }, 1);
    }

    $root.find('img').load(function() {
        onLoadImg($(this));
    }).each(function() {
        if (!this.complete) return;

        onLoadImg($(this));
    });
}
// 画像選択肢カード高さ、横幅調節
function adjust_choiceimage(attrs, root, edit) {
    if (!attrs['qtype']) {
        return;
    }
    var qtype = attrs['qtype'];
    if (qtype.indexOf('choiceimage') == -1) {
        return;
    }

    adjustChoiceimageWidth(attrs, root);

    // 画像がロードされてから実行されるようにする
    if (edit == null) edit = false;
    var params = [attrs, root, edit];
    adjust_choiceimage_height(params);
    afterImageLoaded(root, adjust_choiceimage_height, params);
}

function adjust_choiceimage_height(args) {
    var attrs = args[0];
    var root = args[1];
    var edit = args[2];

    var padding = parseInt(root.find('.table_qtype_choiceimage label:first').css('padding-bottom'), 10);

    var touch_mode = touch_mode || attrs.sp_preview_mode == true;
    var colSize = getChoiceimageColSize(root, touch_mode);
    function isRowFirst(index) {
        if ( index % colSize == 0 ) return true;
        return false;
    }
    function getRowIndex(index) {
        return parseInt(index / colSize, 10);
    }

    root.find('.table_qtype_choiceimage ul').each(function() {
        var choice_size = $(this).find('label:visible').length;
        var row_size = parseInt(choice_size / colSize, 10) + 1;

        // 画像領域
        var photo_height_list = [];
        _.each($(this).find('div.imagechoice-photo-block:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            if (isRowFirst(index)) {
                photo_height_list[row_index] = 0;
            }

            var $img = $(elm).find('img');
            var height = $img.height();
            $img.height('');
            if ($img.length) height = $img.height();
            if (height > photo_height_list[row_index]) {
                photo_height_list[row_index] = height;
            }
        });

        // 選択肢領域
        var headline_height_list = [];
        _.each($(this).find('div.caption-height:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            if (isRowFirst(index)) {
                headline_height_list[row_index] = 0;
            }

            $(elm).height('');
            if ($(elm).height() > headline_height_list[row_index]) {
                headline_height_list[row_index] = $(elm).height();
            }
        });

        // テキストボックス領域
        var textarea_height_list = [];
        _.each($(this).find('.textbox-pos:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            if (isRowFirst(index)) {
                textarea_height_list[row_index] = 0;
            }

            $(elm).height('');

            var textarea_h = 0;
            textarea_h = $(elm).height();

            if (!edit) {
                // テキストボックスサイズが2行以上に設定されている場合
                if ($(elm).find('textarea').length) textarea_h = $(elm).find('textarea').height();

                // 単位表示領域
                var $unit = $(elm).find('.textbox_unit:visible');
                if ($unit.length > 0 && $unit.height() > textarea_h) textarea_h = $unit.height();
                if ($(elm).find('.guideTxt:visible').length > 0) textarea_h += 16;
            }

            if (textarea_h > textarea_height_list[row_index]) {
                textarea_height_list[row_index] = textarea_h;
            }
        });

        // 反映:画像
        _.each($(this).find('div.imagechoice-photo-block:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            var photo = photo_height_list[row_index];
            $(elm).height(photo);
        });
        // 反映:選択肢
        _.each($(this).find('div.caption-height:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            var headline = headline_height_list[row_index];
            $(elm).height(headline);
        });
        _.each($(this).find('div.display-bottom-area:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            var headline = headline_height_list[row_index];
            var textarea = textarea_height_list[row_index];
            //$(elm).height(headline + textarea);
            if($(elm).has( "textarea" ).length >0){
                $(elm).css({'margin-bottom':'8px'  });
            }
            $(elm).css({"min-height":headline + textarea  });



        });
        // 反映:カード高さ
        _.each($(this).find('label.choice-block:visible'), function(elm, index) {
            var row_index = getRowIndex(index);
            var photo = photo_height_list[row_index];
            var headline = headline_height_list[row_index];
            var textarea = textarea_height_list[row_index];

            var height_size = padding + photo + headline + textarea + 30;
            if(height_size < 75){
                height_size = 75;
            }
            //$(elm).height(height_size);
            $(elm).css({"height": height_size});



        });
    });
}


var boxtype_name = {
    "boxtype1": BOXTYPE1_TEXT,
    "boxtype2": BOXTYPE2_TEXT,
    "boxtype3": BOXTYPE3_TEXT,
    "boxtype4": BOXTYPE4_TEXT,
    "boxtype5": BOXTYPE5_TEXT,
    "boxtype6": BOXTYPE6_TEXT
}

var def_box_data = {
    "checked": false,
    "width":30,
    "height":1,
    "type":"boxtype1",
    "range":[null, null],
    "unit":""
}
var def_box_data_for_textbox = {
    "checked": false,
    "width":50,
    "height":3,
    "type":"boxtype1",
    "range":[null, null],
    "unit":""
}

/* --ロジック(デフォルト設定)------*/
var def_logic_data = {
    "textbox":{
        "checked": false,
        "width":30,
        "height":1,
        "type":"boxtype1",
        "range":[null, null],
        "unit": null
    },
    "images":null ,
    "thumbs":null ,
    "image_width":"90px",
    "exc":false,
    "line_break":false,
    "disp_cond":[],
    "head":{
        "checked": false,
        "text": null,
        "line_break": false
    },
    "randomize":{
        "checked": false,
        "l_group": null,
        "m_group": null
    }
}
var header_show = true;
var ad_show = true;

if(typeof is_mhs_user != 'undefined') {
    if (is_mhs_user) {
        header_show = false;
        ad_show = false;
    }
}

var enquete_option_def = {
    "logo": "",
    "language":"japanese",
    "set_qnum":true,
    "set_cnum":false,
    "back_text":BACK_TEXT,
    "next_text":NEXT_TEXT,
    "send_text":SEND_TEXT,
    "abort_text":ABORT_ANSWER_TEXT,
    "start_text":START_ANSWER_TEXT,
    "show_back_btn":false,
    "show_abort_btn":false,
    "mark":"＊",
    "show_progress_bar":'number',
    "header_show":header_show,
    "ad_show":ad_show,
    "show_share_btn":false,
    "closed_message":CLOSED_TEXT,
    "reserve_message":RESERVE_TEXT,
}

var maching_q_num = {}

function setDatePicker(el, min, max){
    minDate = null;
    maxDate = null;

    if (min) {
        minDate = new Date(min);
    }
    if (max) {
        maxDate = new Date(max);
    }

    if(!(el.hasClass("hasDatepicker"))){
        el.datepicker({
            dateFormat: 'yy/mm/dd',
            minDate: minDate,
            maxDate: maxDate,
            changeYear: true,
            yearRange: "1930:2100",
            showButtonPanel: true,
            onChangeMonthYear: function ( year ,month ){
                var t = this;
                setTimeout(function() {
                    var buttonPanel = $( t )
                        .datepicker( "widget" )
                        .find( ".ui-datepicker-buttonpane" );

                    date = new Date();
                    selectdate = year + "/" + month;
                    nowdate = date.getFullYear() + "/" + (date.getMonth()+1);
                    if(selectdate == nowdate || selectdate == ""){
                        buttonPanel.find('.ui-datepicker-current').hide();
                    }
                    if(touch_mode){
                        $('.ui-datepicker-year').css("width",'55%');
                    }
                    var btn = buttonPanel.find('.ui-datepicker-close');
                    btn.unbind("click")
                       .bind("click", function () {
                           $.datepicker._clearDate( t );
                        });
                    btn.appendTo( buttonPanel );
                }, 1 );
            },
            beforeShow: function( input ) {
                setTimeout(function() {
                    var buttonPanel = $( input )
                        .datepicker( "widget" )
                        .find( ".ui-datepicker-buttonpane" );

                    date = new Date();
                    selectdate = $(el).val().slice(0,7);
                    nowdate = date.getFullYear() + "/" + ("0" + (date.getMonth()+1)).slice(-2);
                    if(selectdate == nowdate || selectdate == ""){
                        buttonPanel.find('.ui-datepicker-current').hide();
                    }

                    //var btn = $('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
                    var btn = buttonPanel.find('.ui-datepicker-close');
                    btn.unbind("click")
                       .bind("click", function () {
                           $.datepicker._clearDate( input );
                        });
                    btn.appendTo( buttonPanel );
                }, 1 );
            }
        });

        el.click(function(){
            el.datepicker().css("display", "block");
             if(touch_mode){
                $('.ui-datepicker-year').css("width",'55%');
            }
        });
    }
}


function update_texts(text) {
    var key;
    for (key in maching_q_num) {
        if (text.indexOf(key) != -1) {
            text = replaceAll(text, key, "P_"+key)
        }
    }
    for (key in maching_q_num) {
        if (text.indexOf("P_"+key) != -1) {
            text = replaceAll(text, "P_"+key, maching_q_num[key])
        }
    }
    return text;
}

// 他質問の回答表示：質問順序入れ替えたときに競合があれば、テキストを更新
function q_num_competes(text, index) {
    for (var i=index; i<100;i++) {
        if (text.indexOf("{Q"+i+"}") != -1){
            text = replaceAll(text, "{Q"+i+"}", "")
        } else if(text.indexOf("{Q"+i+"-") != -1) {
            var name = "{Q"+i+"-" ;
            text = text.replace(eval("/"+name+"[0-9]}/g"), "");
        }
    }
    return text
}

// 質問編集時に伴い不要になったロジック設定の削除
function remove_unwanted_logic(saveObj){
    var choices = saveObj["choices"];
    var qtype = saveObj["qtype"];
    var key;

    if(choices != undefined){
        for(key in saveObj["options"]["choice_options"]){
            var flag = true
            for (var i=0; i<choices.length ;i++){
                if(CKEditorToText(choices[i]["title"]) == key){
                    flag = false;
                    break;
                }
            }
            if(flag){
                delete saveObj["options"]["choice_options"][key]
                if (saveObj["options"]["cell_options"]) {
                    if(key in saveObj["options"]["cell_options"]){
                        delete saveObj["options"]["cell_options"][key]
                    }
                }
            }
        }

        if(qtype.indexOf("matrix") != -1){
            var items = saveObj["items_left"];
            for(key in saveObj["options"]["item_options"]){
                var flag = true
                for (var i=0; i<items.length ;i++){
                    if(CKEditorToText(items[i]["title"]) == key){
                        flag = false;
                        break;
                    }
                }
                if(flag){
                    delete saveObj["options"]["item_options"][key]
                    if (saveObj["options"]["cell_options"]) {
                        for(cell_key in saveObj["options"]["cell_options"]){
                            if(key in saveObj["options"]["cell_options"][cell_key]){
                                delete saveObj["options"]["cell_options"][cell_key][key]
                            }
                        }
                    }
                }
            }
        }
    }
}

function replaceAll(expression, org, dest){
    return expression.split(org).join(dest);
}

function setDefaultLogics(qtype, options, attrs){
    var key;

    if (!_.contains(NOT_COUNT_QTYPE_LIST, qtype)) {
        if (!options.choice_options) {
            options["choice_options"] = {}
        }

        for (var i = 0; i< attrs["choices"].length; i++) {
            if (attrs["choices"][i]["title"] === undefined) continue

            var bbText_choices = CKEditorToText(attrs["choices"][i]["title"])
            var data = {}
            if (bbText_choices in options["choice_options"]) {
                for (key in def_logic_data) {
                    // var defData = JSON.stringify(def_logic_data[key])
                    if (key in options["choice_options"][bbText_choices]) {
                        // defData = JSON.stringify(options["choice_options"][bbText_choices][key])
                        data[key] = options["choice_options"][bbText_choices][key];
                    } else {

                    }
                    // data[key] = JSON.parse(defData)
                }
                if (attrs["choices"][i]["choice_type"] == "other") {
                    if (!data["textbox"]) {
                        data["textbox"] = {}
                    }
                    data["textbox"]["checked"] = true;
                }
                if (attrs["choices"][i]["choice_type"] == "nochoice") {
                    data["exc"] = true;
                }
            }
            options["choice_options"][bbText_choices] = data;
        }

        // マトリックス系用に項目オプションのデフォルト設定
        if (qtype.indexOf("matrix") != -1) {
            if (!options.item_options) {
                options["item_options"] = {}
            }
            if (!options.cell_options) {
                options["cell_options"] = {}
            }

            for (var j = 0; j< attrs["choices"].length; j++) {
                var bbText_choices = CKEditorToText(attrs["choices"][j]["title"])

                if (!(bbText_choices in options["cell_options"])) {
                    options["cell_options"][bbText_choices] = {};
                }

                for (var i = 0; i< attrs["items_left"].length; i++) {
                    var bbText_items = CKEditorToText(attrs["items_left"][i]["title"])

                    // item optionsの設定
                    // var data = {"textbox":{}, "images":{}, "image_width":{}, "disp_cond":{}, "head":{}, "randomize":{}}
                    var data = {}
                    if (bbText_items in options["item_options"]) {
                        for (key in def_logic_data) {
                            data[key] = options["item_options"][bbText_items][key]
                        }
                    }
                    options["item_options"][bbText_items] = data;

                    // item optionsの設定
                    // var data = {"textbox":{}, "images":{}}
                    var data = {}
                    if (bbText_items in options["cell_options"][bbText_choices]) {
                        for (key in def_logic_data) {
                            data[key] = options["cell_options"][bbText_choices][bbText_items][key]
                        }
                    }
                    options["cell_options"][bbText_choices][bbText_items] = data;
                }
            }
        }
    }
    return options;
}

//　リッチテキストで選択肢テキストを変更した際、ひもづいていたロジックオプションを引き継ぐ
function change_choice_text(choice, data, options) {
    var bbText_choice = choice;

    if (data != bbText_choice) {
        if ( bbText_choice in options["choice_options"] ) {
            options["choice_options"][data] = options["choice_options"][bbText_choice];
            delete options["choice_options"][bbText_choice];
        }
        if ("cell_options" in options) {
            if ( bbText_choice in options["cell_options"] ) {
                options["cell_options"][data] = options["cell_options"][bbText_choice];
                delete options["cell_options"][bbText_choice];
            }
        }
    }

    return options
}

//　リッチテキストで項目テキストを変更した際、ひもづいていたロジックオプションを引き継ぐ
function change_item_text(item, data, options, attrs) {
    var bbText_item = item;

    if (data != bbText_item) {
        if ("item_options" in options) {
            if ( bbText_item in options["item_options"] ) {
                options["item_options"][data] = options["item_options"][bbText_item];
                delete options["item_options"][bbText_item];
            }
        }

        if ("cell_options" in options) {
            for (var i = 0; i < attrs['choices'].length; i++ ) {
                var bbText_choice = CKEditorToText(attrs['choices'][i]["title"]);
                if ( bbText_choice in options["cell_options"] ) {
                    if ( bbText_item in options["cell_options"][bbText_choice] ) {
                        options["cell_options"][bbText_choice][data] = options["cell_options"][bbText_choice][bbText_item];
                        delete options["cell_options"][bbText_choice][bbText_item];
                    }
                }
            }
        }
    }
    return options
}

//- 汎用関数（集合演算系）
function include(item, target) {
    for (var i = 0, len = target.length; i < len; i++) {
        if (item == target[i]) {
            return true;
        }
    }
    return false;
}

//- 汎用関数（集合演算系：差集合取得）
function difference(arrayA, arrayB) {
    var result = [];
    for (var i = 0, len = arrayA.length; i < len; i++) {
        if (!this.include(arrayA[i], arrayB)) {
            result.push(arrayA[i]);
        }
    }
    return result;
}

function merged_choices(qtype, options){
    var attrs_local = {};

    var choices = []
    if (qtype.indexOf("matrix") == -1){
        choices = options['choices'];

    } else {
        choices = options['cols'];

        attrs_local['items_left'] = new Array();
        var items = options['rows'];
        for (var i = 1; i <= items.length; i++){
            attrs_local['items_left'].push({"index": i, "title": items[i-1]})
        }

        if (qtype == "matrix-radio-bi") {
            var items_right = options['rows_right'];
            attrs_local['items_right'] = new Array();
            for (var i = 1; i <= items_right.length; i++){
                attrs_local['items_right'].push({"index": i, "title": items_right[i-1]})
            }
        }
    }

    if(choices == undefined) choices = []

    // 選択肢リストを格納
    attrs_local['choices'] = new Array();
    var qpt_index = 1
    for (var i = 0; i < choices.length; i++){
        attrs_local['choices'].push({"index": qpt_index, "title": choices[i], "choice_type": "normal"})
        qpt_index += 1
    }

    var needs = ["radio","checkbox","ranking", "choiceimage-radio", "choiceimage-checkbox"]
    if('other' in options && (_.indexOf(needs, qtype) != -1 || qtype.indexOf("matrix") != -1 )) {
        if(options['other']) {
            attrs_local['choices'].push({"index": qpt_index, "title": options['othertext'], "choice_type": "other"})
            qpt_index += 1
        }
    }

    if('nochoice' in options  && (_.indexOf(needs, qtype) != -1 || qtype.indexOf("matrix") != -1 )){
        if(options['nochoice']){
            attrs_local['choices'].push({"index": qpt_index, "title": options['nochoicetext'], "choice_type": "nochoice"})
        }
    }

    return attrs_local;
}

// 複数列ある質問のテーブルの転置
function change_tableform(attrs, el) {
    var qtype = attrs["qtype"]

    if (qtype === "radio" || qtype === "checkbox" || qtype.indexOf("textbox") !== -1) {
        var maxlength = 0;
        var table_trans = el.find("#table_trans");
        var table_trans_tr = table_trans.find("tr");
        table_trans_tr.each(function() {
            var t_length = $(this).find("td").length;
            if (t_length > maxlength){
                maxlength = t_length;
            }
        });

        table_trans_tr.each(function(index) {
            var tdlength = $(this).find("td").length;
            if (maxlength === tdlength) {
                $(this).find("td").attr('col_index', index);
                return;
            }
            var elem = $(this).find("td:first");
            for (var i = 1; i < maxlength; i++) {
                elem.attr('col_index', index);
                if (elem.next("td").html() == undefined) {
                    elem.after('<td class="td-spacer"></td>');
                }
                elem = elem.next("td");
            }
            elem.attr('col_index', index);
        });

        table_trans_tr.addClass("temptr");
        table_trans.find("thead,tbody").children().unwrap();
        table_trans.find("tr:first td,tr:first th").each(function() {
            var tds = $(this).index()+1;
            table_trans.find("tr:last").after("<tr />");
            table_trans.find("tr.temptr").each(function() {
                var elem_ = table_trans.find("tr:last");
                table_trans.find("tr:eq("+$(this).index()+") > :nth-child("+tds+")").clone(true).appendTo(elem_);
                // ieでテキストエリアにプレースホルダの値が入るバグがあるので、描画時に一度値を空にする
                table_trans.find("textarea").val('');
            });
        });
        table_trans.find("tr.temptr").detach();
        var tbody = $("<tbody>");
        table_trans.find("tr:last").after(tbody);
        tbody.append(table_trans.find("tr"));
    }
}

//
function setQuestionRandom(common) {
    var group = random_group(common);
    for (var key in group) {
        for (var i = 0; i < group[key].length; i++){
            $(".questionContent").each(function(index){
                if (parseInt($(this).attr("qid")) == parseInt(group[key][i]["id"])) {
                    $(this).find(".q_ids_insert > p > span").html("")

                    for (var j=0; j<group[key].length; j++){
                        var q_index = group[key][j]["q_index"];
                        if (q_index == 'image') {
                            $(this).find(".q_ids_insert > p > span").append("<b>"+QTYPE_IMAGE_TEXT + group[key][j]["i_index"] + "</b>");
                        } else if (q_index == 'description') {
                            $(this).find(".q_ids_insert > p > span").append("<b>"+QTYPE_DESCRIPTION_TEXT + group[key][j]["d_index"] + "</b>");
                        } else if (q_index == 'movie') {
                            $(this).find(".q_ids_insert > p > span").append("<b>"+QTYPE_MOVIE_TEXT + group[key][j]["m_index"] + "</b>");
                        } else {
                            $(this).find(".q_ids_insert > p > span").append("<b>Q"+q_index+"</b>");
                        }
                    }
                }
            });
        }
    }
    return group;
}

// ロジック表示中の質問IDを質問番号に変換
function exchangeQuestionID(common) {

    var index = 1;
    common.enquete_view.model.get('pages').each(function(page) {
        page.get('questions').each(function(question) {
            var id = question.get('id');
            var qtype = question.get('qtype');
            // if(qtype != "images" && qtype != "description"){
            if (!_.contains(NOT_COUNT_QTYPE_LIST, qtype)) {
                $(".QID_changer#Q_changeId_"+id).html("Q" + index);

                var choices = question.get('choices');
                if(choices != undefined){
                    for(var i=0; i<choices.length; i++){
                        $(".CID_changer#C_changeId_"+id+"_"+i).html("" + CKEditorToText(choices[i]['title']));
                    }

                    if(qtype == "ranking") {
                        for(var j=0; j<choices.length; j++) {
                            $(".IID_changer#I_changeId_"+id+"_"+choices[j]['index']).html(ORDER_TEXT+ choices[j]['index']);
                        }
                    }
                }

                if(qtype.indexOf("matrix") != -1) {
                    var items = question.get('items_left');
                    if(items != undefined){
                        for(var i=0; i<items.length; i++){
                            $(".IID_changer#I_changeId_"+id+"_"+(items[i]['index']-1)).html(ITEM_TEXT + CKEditorToText(items[i]['title']));
                        }
                    }
                }

                index ++;
            } else {
                if(qtype == "images")
                    $(".QID_changer#Q_changeId_"+id).html(QTYPE_IMAGE_TEXT + question.get("i_index"));
                else if(qtype == "description")
                    $(".QID_changer#Q_changeId_"+id).html(QTYPE_DESCRIPTION_TEXT + question.get("d_index"));
                else
                    $(".QID_changer#Q_changeId_"+id).html(QTYPE_MOVIE_TEXT + question.get("m_index"));
            }
        });
    });
}

// 必須マークの変更
function update_required_mark(common) {
    if(common.enquete_view != undefined && common.enquete_view.model.get("options") != undefined){
        var t_model = common.enquete_view.model.get("options");
        if("mark" in t_model){
            $("span.required").html(t_model["mark"]);
            $("em.required").html(t_model["mark"]);
        }
        if("set_qnum" in t_model){
            if(t_model["set_qnum"]){
                $(".questionTitle").find(".headNumber").show();
            } else {
                $(".questionTitle").find(".headNumber").hide();
            }
        }
    }
}

// 質問ランダムグループ情報取得
function random_group(common){
    var group = {};
    var index = 1;
    common.enquete_view.model.get('pages').each(function(page) {
        page.get('questions').each(function(question) {
            var id = question.get('id');
            var qtype = question.get('qtype');
            var options = question.get('options');

            if ( options["randomize"] && options["randomize"]["checked"]) {
                var name = "mixed_"
                name += options["randomize"]["l_group"] +"_"
                name += options["randomize"]["m_group"]
                var hash = {"id": question.get('id'), "q_index": index};
                if (qtype == "images") {
                    hash["q_index"] = 'image';
                    hash["i_index"] = question.get('i_index');
                }
                if (qtype == "description") {
                    hash["q_index"] = 'description';
                    hash["d_index"] = question.get('d_index');
                }
                if (qtype == "movie") {
                    hash["q_index"] = 'movie';
                    hash["m_index"] = question.get('m_index');
                }
                if ( name in group ) {
                    group[name].push(hash);
                } else {
                    group[name] = [hash];
                }
            }
            if (!_.contains(NOT_COUNT_QTYPE_LIST, qtype)) {
                index ++;
            }
        });
    });
    return group
}

// 選択肢ランダムグループ情報取得
function choices_random_group(attrs){
    if ("choices" in attrs) {
        var choices = attrs["choices"]
        if (!choices) return {}
        var choice_options = attrs["options"]["choice_options"]
        var group = {}

        if (choice_options) {
            for (var i = 0; i< choices.length; i++) {
                var choice = CKEditorToText(choices[i]["title"]);
                if (choice in choice_options) {
                    if ( choice_options[choice]["randomize"] && choice_options[choice]["randomize"]["checked"]) {
                        var name = "mixed_"
                        name += choice_options[choice]["randomize"]["l_group"] +"_"
                        name += choice_options[choice]["randomize"]["m_group"]
                        if ( name in group ) {
                            group[name].push(choices[i]);
                        } else {
                            group[name] = [choices[i]];
                        }
                    }
                }
            }
        }
        attrs["random_groups"] = group;
        return group;
    }
    return {}
}

// 項目ランダムグループ情報取得
function items_random_group(attrs){
    if ("items_left" in attrs) {
        var items = attrs["items_left"]
        if (!items) return {}
        var item_options = attrs["options"]["item_options"]
        var group = {}
        for (var i = 0; i< items.length; i++) {
            var item = CKEditorToText(items[i]["title"]);
            if (item in item_options) {
                if ( item_options[item]["randomize"] && item_options[item]["randomize"]["checked"]) {
                    var name = "mixed_"
                    name += item_options[item]["randomize"]["l_group"] +"_"
                    name += item_options[item]["randomize"]["m_group"]
                    if ( name in group ) {
                        group[name].push(items[i]);
                    } else {
                        group[name] = [items[i]];
                    }
                }
            }
        }
        attrs["items_random_groups"] = group;
        return group
    }
    return {}
}

function setLogicJS(parent, attrs) {
    var g_sp_preview_mode = location.href.indexOf("/preview") != -1 && enquete_data['mode'] == 'preview' && language_code == 'ja' && touch_mode == false;
    // ランキングJS
    // ToDo: 選択肢の非表示があった場合挙動がおかしい不具合修正
    function uiRankingHandler(e) {
        var emptyFlag = true;
        var mode = e.data;
        var pid = undefined;
        if (g_sp_preview_mode) {
            var pid = (mode == 'pc') ? "#answerSPPreview" : "#answerPage";
        }

        if (mode == 'pc') {
            var choices = attrs["choices"]
            var value = $(this).data('value');

            $(this).parent().siblings('p').html($(this).html());
            $(this).parent().siblings('input').val(value);
            if (g_sp_preview_mode) {
                var id = $(this).parents("td").next().attr("id");
                var sp = $("#answerSPPreview").find("#"+id).prev().find("select");
                sp.siblings('div.selectTxt').text(sp.find('option[value="'+value+'"]').text());
                sp.siblings('input').val(value);
                sp.val(value);
            }

            if (value != "") emptyFlag = false;
        } else {
            var value = $(this).val();
            var name = $(this).find('option[value='+value+']').text();
            $(this).siblings('div.selectTxt').text(name);
            $(this).siblings('input').val(value);
            if (g_sp_preview_mode) {
                var id = $(this).parents("td").next().attr("id");
                var pc = $("#answerPage").find("#"+id).prev().find("ul");
                pc.siblings('p').html(pc.find("li[data-value='"+value+"']").html());
                pc.val(value);
            }

            if (value != "0" ) emptyFlag = false;
        }

        if (!emptyFlag) {
            var unit = attrs["options"]["unit"];
            var unit_name = attrs["options"]["unit_name"];
            if (!unit || unit_name == undefined) {
                unit_name = ""
            }

            var upper = parseInt(attrs["options"]["rank_upper"]);
            if (!attrs["options"]["set_rank"]) {
                upper = parseInt("  ");
            };

            if (mode == 'pc') {
                var insert_index = $(this).attr("val");
            } else {
                var insert_index = $(this).find('option[value='+value+']').attr("data-index");
            }
            var elem = $(this).parents(".rank_body");
            var current_index = parent.find('.rank_body').index($(this).parents(".rank_body")) + 1;
            if (g_sp_preview_mode) {
                var elem_sp = $(pid).find("#"+id).parent();
            }

            if(current_index > insert_index){
                // 自身を動かすとIE8でイベントアンバインドされてしまい、回答取得処理が走らないため、自身以外を動かしている
                // parent.find(".rank").find('.rank_body:eq('+(insert_index-1)+')').before(elem);
                for (var i=current_index;i>insert_index;i--) {
                    elem.after(parent.find(".rank").find('.rank_body:eq('+(i-2)+')'));
                    if (g_sp_preview_mode) {
                        elem_sp.after(elem_sp.parents(".rank").find('.rank_body:eq('+(i-2)+')'));
                    }
                }
            } else if(current_index < insert_index){
                // parent.find(".rank").find('.rank_body:eq('+(insert_index-1)+')').after(elem);
                for (var i=current_index;i<insert_index;i++) {
                    elem.before(parent.find(".rank").find('.rank_body:eq('+(i)+')'));
                    if (g_sp_preview_mode) {
                        elem_sp.before(elem_sp.parents(".rank").find('.rank_body:eq('+(i)+')'));
                    }
                }
            }
            
            if (current_index != insert_index) {
                elem.find('ul').slideUp('fast', function() {
                    elem.removeClass('open');
                });
            }

            // ずれた順位を戻す処理 
            // 範囲は current ~ insert
            function getRankValue($elem) {
                if (mode == 'pc') {
                    return $elem.find('.rkselect').parent().siblings('input').val();
                } else {
                    return $elem.find('.selectObj').siblings('input').val();
                }
            }
            var start = insert_index-1;
            var end = current_index-1;
            // 下に移動した場合は下位から走査し、選択済みの1つ下が空ならその位置を下げる
            if (current_index < insert_index) {
                for (var i=start-1;i>=end;i--) {
                    var $target = parent.find(".rank_body:eq("+i+")");
                    var target_val = getRankValue($target);
                    var next_val = getRankValue($target.next());
                    if (target_val != "" && next_val == "") {
                        $target.next().after($target);
                        if (g_sp_preview_mode) {
                            var $target_sp = $(pid).find("#"+id).parent().parent().find(".rank_body:eq("+i+")");
                            $target_sp.next().after($target_sp);
                        }
                    }
                }
            }
            // 上に移動した場合は上位から走査し、選択済みの1つ上が空ならその位置を上げる
            if (current_index > insert_index) {
                for (var i=start+1;i<=end;i++) {
                    var $target = parent.find(".rank_body:eq("+i+")");
                    var target_val = getRankValue($target);
                    var prev_val = getRankValue($target.prev());
                    if (target_val != "" && prev_val == "") {
                        $target.prev().before($target);
                        if (g_sp_preview_mode) {
                            var $target_sp = $(pid).find("#"+id).parent().parent().find(".rank_body:eq("+i+")");
                            $target_sp.prev().before($target_sp);
                        }
                    }
                }
            }

            parent.trigger('click');  // IE8対応: プルダウンを閉じるイベントをアンバインドするため

            parent.find('.head_view').each(function() {
                parent.find(".rank").find('.rank_body:eq('+$(this).attr("index")+')').before($(this));
            });

            var rkval = 1;
            parent.find('.rank_body').each(function() {
                if (mode == 'pc') {
                    $(this).find(".uiRankingSelectText").text("　");
                    if (g_sp_preview_mode) {
                        id = $(this).find(".rank_choice_index").attr("id")
                        $(pid).find("#"+id).prev().find(".selectTxt").text("　");
                    }
                } else {
                    $(this).find(".selectTxt").text("　");
                    if (g_sp_preview_mode) {
                        id = $(this).find(".rank_choice_index").attr("id")
                        $(pid).find("#"+id).prev().find(".uiRankingSelectText").text("　");
                    }
                }

                var choice_index = $(this).find('.choice_index').attr("value");

                var elem_val = $(this).find('.uiSelect').find('input[type="hidden"]').val();
                if(elem_val != ""){
                    $(this).find('.uiSelect').find('input[type="hidden"]').val(choice_index);
                    if (g_sp_preview_mode) {
                        $(pid).find("#"+id).prev().find('.uiSelect').find('input[type="hidden"]').val(choice_index);
                    }
                }

                if (rkval <= upper || isNaN(upper)) {
                    if(elem_val != ""){
                        if (mode == 'pc') {
                            $(this).find(".uiRankingSelectText").text(rkval+" "+unit_name);
                            if (g_sp_preview_mode) {
                                $(pid).find("#"+id).prev().find('select.selectObj').val(rkval);
                                $(pid).find("#"+id).prev().find(".selectTxt").text(rkval+" "+unit_name);
                            }
                        } else {
                            $(this).find('select.selectObj').val(rkval);
                            $(this).find(".selectTxt").text(rkval+" "+unit_name);
                            if (g_sp_preview_mode) {
                                $(pid).find("#"+id).prev().find(".uiRankingSelectText").text(rkval+" "+unit_name);
                            }
                        }
                        $(this).find(".logic_textbox").removeAttr("disabled");
                        if (g_sp_preview_mode) {
                            $(pid).find("#"+id).prev().find(".logic_textbox").removeAttr("disabled");
                        }
                    }
                } else {
                    $(this).find('.uiSelect').find('input[type="hidden"]').val("");
                    $(this).find(".logic_textbox").attr("disabled", "disabled");
                    if (g_sp_preview_mode) {
                        $(pid).find("#"+id).prev().find('.uiSelect').find('input[type="hidden"]').val("");
                        $(pid).find("#"+id).prev().find(".logic_textbox").attr("disabled", "disabled");
                    }
                }
                rkval += 1;
            });
        } else {
            if (mode == 'pc') {
                $(this).parent().siblings('p').html('　');
                if (g_sp_preview_mode) {
                    $(pid).find("#"+id).prev().parent().siblings('p').html('　');
                }
            } else {
                $(this).parent().siblings('p').html($(this).html());
                if (g_sp_preview_mode) {
                    $(pid).find("#"+id).prev().find('p').html('　');
                }
            }
        }

        parent.find("#"+attrs["id"]+"_nochoice").parent().removeClass('checked');
        if (g_sp_preview_mode) {
            $(pid).find("#"+attrs["id"]+"_nochoice").parent().removeClass('checked');
        }
    }
    parent.find('.rkselect').bind('click', 'pc', uiRankingHandler);
    parent.find('.uiRankingSelect select').bind('change', 'sp', uiRankingHandler);

    parent.find('.uiTextboxSum').find('.uiText > textarea').bind('keydown keyup keypress change', function(e) {
        if(attrs['qtype'] == "textbox-sum") {
            var total = 0;
            parent.find('.uiTextboxSum').find('.uiText:visible').each(function(){
                var count = Number($(this).find('textarea').val());
                if(!isNaN(count)) {
                    total += count;
                }
            }); 
            parent.find('.uiTextboxSum').find('.sum > span').text(total);
        }
    });

    // 他の選択肢と同時に選択できない選択肢
    parent.find('.uiCheck > label').click(function(e) {
        if ($(this).parents(".questionContent").html() == undefined) {
            return;
        }

        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }

        var qtype = attrs['qtype'];
        var options = attrs['options'];
        var choices = attrs['choices'];

        var id = attrs['id'];
        var el = $(this).parent(".uiCheck");

        var choices_data = {}
        for (var i =0; i< choices.length; i++) {
            var exc = false;
            var bbText_choice = CKEditorToText(choices[i]["title"])
            if (bbText_choice in options["choice_options"]){
                exc = options["choice_options"][bbText_choice]["exc"]
            }
            choices_data[choices[i]["index"]] = {"title": choices[i]["title"], "exc": exc}
        }

        // マトリックスチェックボックス
        if(qtype.indexOf("matrix-checkbox") != -1) {
            var el_name = el.find("input").attr('name');

            var count = 0;
            if (g_sp_preview_mode) {
                var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
            }
            if(el.parents().hasClass("matrix-checkbox-sp")){
                if (g_sp_preview_mode && $(this).parents("#answerPage").length ==0 ){
                    var view_disp = $(pid).find("input[name='"+el_name+"']").parents(".pcView").length > 0 ? ".spView" : ".pcView";
                }else{
                    var view_disp = $(this).parents(".pcView").length > 0 ? ".spView" : ".pcView";
                }
            }
            el.parent().parent().find("[name='"+el_name+"']").each(function() {
                if ($(this).parent().hasClass("checked")) {
                    count += 1;
                }
            });

            var choice_index = el.find("[name='"+el_name+"']").attr('val')

            if (count == 0) {
                el.parent().parent().find("[name='"+el_name+"']").each(function(){
                    $(this).parent().removeClass("disabled");
                    $(this).parent().removeClass("setExc")
                });
                if (g_sp_preview_mode) {
                    $(pid).find("[name='"+el_name+"']").each(function() {
                        $(this).parent().removeClass("disabled");
                        $(this).parent().removeClass("setExc");
                    });
                }
                if(el.parents().hasClass("matrix-checkbox-sp")) {
                    $(view_disp).find("[name='" + el_name + "']").each(function () {
                        $(this).parent().removeClass("disabled");
                        $(this).parent().removeClass("setExc");
                    });
                }
            // その他の選択肢と同時に選択できない選択肢を選択した場合
            } else if (choices_data[choice_index]["exc"]){
                el.parent().parent().find("[name='"+el_name+"']").each(function(){
                    if ($(this).attr('val') != choice_index) {
                        $(this).parent().addClass("disabled");
                        $(this).parent().addClass("setExc");
                    }
                });
                if (g_sp_preview_mode) {
                    $(pid).find("[name='"+el_name+"']").each(function(){
                        if ($(this).attr('val') != choice_index) {
                            $(this).parent().addClass("disabled");
                            $(this).parent().addClass("setExc");
                        }
                    });
                }
                if(el.parents().hasClass("matrix-checkbox-sp")) {
                    $(view_disp).find("[name='" + el_name + "']").each(function () {
                        if ($(this).attr('val') != choice_index) {
                            $(this).parent().addClass("disabled");
                            $(this).parent().addClass("setExc");
                        }
                    });
                }

            } else {

                // チェック数上限に関する設定
                var flag = true;
                if (options['selectable'] && !isNaN(parseInt(options['selectable_upper']))) {
                    if(count >= options['selectable_upper']) {
                        el.parent().parent().find("[name='"+el_name+"']").each(function(){
                            if (!$(this).parent().hasClass("checked")) {
                                $(this).parent().addClass("disabled")
                                $(this).parent().addClass("setExc")
                            }
                        });
                        if (g_sp_preview_mode) {
                            $(pid).find("[name='"+el_name+"']").each(function(){
                                if (!$(this).parent().hasClass("checked")) {
                                    $(this).parent().addClass("disabled");
                                    $(this).parent().addClass("setExc");
                                }
                            });
                        }
                        if(el.parents().hasClass("matrix-checkbox-sp")) {
                            $(view_disp).find("[name='" + el_name + "']").each(function () {
                                if (!$(this).parent().hasClass("checked")) {
                                    $(this).parent().addClass("disabled");
                                    $(this).parent().addClass("setExc");
                                }
                            });
                        }

                        flag = false;
                    }
                }

                if (flag) {
                    el.parent().parent().find("[name='"+el_name+"']").each(function(){
                        if (!choices_data[$(this).attr('val')]["exc"]) {
                            $(this).parent().removeClass("disabled")
                            $(this).parent().removeClass("setExc")
                        } else {
                            $(this).parent().addClass("disabled")
                            $(this).parent().addClass("setExc")
                        }
                    });
                    if (g_sp_preview_mode) {
                        $(pid).find("[name='"+el_name+"']").each(function(){
                            if (!choices_data[$(this).attr('val')]["exc"]) {
                                $(this).parent().removeClass("disabled")
                                $(this).parent().removeClass("setExc")
                            } else {
                                $(this).parent().addClass("disabled")
                                $(this).parent().addClass("setExc")
                            }
                        });
                    }
                    if(el.parents().hasClass("matrix-checkbox-sp")) {
                        $(view_disp).find("[name='" + el_name + "']").each(function () {
                            if (!choices_data[$(this).attr('val')]["exc"]) {
                                $(this).parent().removeClass("disabled")
                                $(this).parent().removeClass("setExc")
                            } else {
                                $(this).parent().addClass("disabled")
                                $(this).parent().addClass("setExc")
                            }
                        });
                    }
                }

            }

        // 通常チェックボックス
        } else if (qtype != "ranking") {
            var count = 0;
            var el_name = el.find("input").attr('name');
            var el_list = el.parents("#table_trans").find("input[name='"+el_name+"']");
            var el_list_sp = undefined;
            if (g_sp_preview_mode) {
                var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
                el_list_sp = $(pid).find("input[name='"+el_name+"']");
            }

            el_list.each(function() {
                if ($(this).parent().hasClass("checked")) {
                    count += 1;
                }
            });

            var choice_index = el.find("input[type='checkbox']").attr('val')

            if (count == 0) {
                el_list.each(function() {
                    $(this).parent().removeClass("disabled")
                    $(this).parent().removeClass("setExc")
                });
                if (el_list_sp != undefined) {
                    el_list_sp.each(function() {
                        $(this).parent().removeClass("disabled")
                        $(this).parent().removeClass("setExc")
                    });
                }

            // その他の選択肢と同時に選択できない選択肢を選択した場合
            } else if (choices_data[choice_index]["exc"]){
                el_list.each(function() {
                    if ($(this).attr('val') != choice_index) {
                        $(this).parent().addClass("disabled")
                        $(this).parent().addClass("setExc")
                    }
                });
                if (el_list_sp != undefined) {
                    el_list_sp.each(function() {
                        if ($(this).attr('val') != choice_index) {
                            $(this).parent().addClass("disabled")
                            $(this).parent().addClass("setExc")
                        }
                    });
                }

            } else {

                // チェック数上限に関する設定
                var flag = true;
                if (options['selectable'] && !isNaN(parseInt(options['selectable_upper']))) {
                    if(count >= options['selectable_upper']) {
                        el_list.each(function() {
                            if (!$(this).parent().hasClass("checked")) {
                                $(this).parent().addClass("disabled")
                                $(this).parent().addClass("setExc")
                            }
                        });
                        if (el_list_sp != undefined) {
                            el_list_sp.each(function() {
                                if (!$(this).parent().hasClass("checked")) {
                                    $(this).parent().addClass("disabled")
                                    $(this).parent().addClass("setExc")
                                }
                            });
                        }
                        flag = false;
                   }
                }

                if (flag) {
                    el_list.each(function() {
                        if (!choices_data[$(this).attr('val')]["exc"]) {
                            $(this).parent().removeClass("disabled")
                            $(this).parent().removeClass("setExc")
                        } else {
                            $(this).parent().addClass("disabled")
                            $(this).parent().addClass("setExc")
                        }
                    });
                    if (el_list_sp != undefined) {
                        el_list_sp.each(function() {
                            if (!choices_data[$(this).attr('val')]["exc"]) {
                                $(this).parent().removeClass("disabled")
                                $(this).parent().removeClass("setExc")
                            } else {
                                $(this).parent().addClass("disabled")
                                $(this).parent().addClass("setExc")
                            }
                        });
                    }
                }
            }

        } else {

            //ランキング：「あてはまるものはない」の排他処理
            if (parent.find("#"+id+"_nochoice").parent().hasClass('checked')) {
                var rk = parent.find(".rank").find('tr');
                $("[name='"+id+"']").find('.rank_body').each(function() {
                    $(this).find("[name='"+id+"_hidden']").next("p").html("　");
                });
            }
        }
        return;
    });
}

// マトリックスの見出しと、列名再表示設置
function setMatrixOptions(parent, attrs) {
    var qtype = attrs["qtype"]
    var id = attrs["id"]

    // 「列名を再表示」オプション（横マトリックスタイプ）
    var insertIndex = attrs['options']["repaint_choices"];

    if (!isNaN(parseInt(insertIndex)) && insertIndex > 0) {
        var head = parent.find("[name="+id+"]").find("thead").html();

        parent.find("[name="+id+"]").not(".spView").find("tbody").find(".cell_tr").each(function(index){
            if((index+1) % parseInt(insertIndex) == 0) {
                if($(this).next().html() != undefined){
                    $(this).after( head )
                    parent.find("[name="+id+"]").find(".midashiBg:last").remove();
                    inserted_head = $(this).next();
                    inserted_head.find(".addTextColEdit").remove();
                    // inserted_head.find(".announceTitle").html("");
                    inserted_head.css("background-color: #FFFFFF");
                }
            }
        });
    }
}

// 都道府県を選択したとき、市区町村のプルダウン内部にデータ更新
function setPrefectureHandler() {
    var prev_val = $(".cityInfo").find('[name="city"]').val();
    var changed = true;
    var g_sp_preview_mode = location.href.indexOf("/preview") != -1 && enquete_data['mode'] == 'preview' && language_code == 'ja' && touch_mode == false;

    if (touch_mode) {
        var html = '<option value="0">' + SELECT_DEFAULT_TEXT + '</option>';
    } else {
        var html = '<li data-value="">' + SELECT_DEFAULT_TEXT + '</li>';
        if (g_sp_preview_mode) {
            var sp_html = '<option value="0">' + SELECT_DEFAULT_TEXT + '</option>';
        }
    }
    if(touch_mode) {
        var val = $(".prefectureInfo .selectObj").val();
        if (val == null) {
            val = "";
        }
    } else {
        var val = $(".prefectureInfo [name=basicinfo_pref]").val();
        if (g_sp_preview_mode) {
            var sp_val = $(".prefectureInfo .selectObj").val();
            if (sp_val == null) {
                sp_val = "";
            }
        }
    }

    if (val == -1) {
        val = "";
        if (g_sp_preview_mode) {
            sp_val = "";
        }
        enquete_data["basic_information"]["gender"]['answer'] = "";
        enquete_data["basic_information"]["ages"]['answer'] = "";
        enquete_data["basic_information"]["prefecture"]['answer'] = "";
        enquete_data["basic_information"]["city"]['answer'] = "";
    }

    if(val != "") {
        for (var i=0; i< wprefectures[val].length; i++) {
            var city_code = wprefectures[val][i]["code"];
            var city_name = city_codes[city_code];
            if (touch_mode) {
                html += '<option value="'+ city_code +'">'+city_name+'</option>';
            } else {
                html += '<li data-value="'+ city_code +'">'+city_name+'</li>';
                if (g_sp_preview_mode) {
                    sp_html += '<option value="'+ city_code +'">'+city_name+'</option>';
                }
            }
            if(prev_val == wprefectures[val][i]["code"]){
                changed = false;
            }
        }
    }

    if(changed) {
        $(".cityInfo").find('[name="city"]').val("");
        if (touch_mode) {
            $(".cityInfo").find('.uiSelect .selectTxt').html(SELECT_DEFAULT_TEXT);
        } else {
            $(".cityInfo").find('.uiSelect p').html(SELECT_DEFAULT_TEXT);
            if (g_sp_preview_mode) {
                $("#answerSPPreview").find(".cityInfo").find('.uiSelect .selectTxt').html(SELECT_DEFAULT_TEXT);
            }
        }
    }

    if (touch_mode) {
        $(".cityInfo").find("select").html(html);
    } else {
        $(".cityInfo").find("ul").html(html);
        if (g_sp_preview_mode) {
            $("#answerSPPreview").find(".cityInfo").find("select").html(sp_html);
        }
    }
}
function setPrefectureJs() {
    if(touch_mode) {
        $('.prefectureInfo select').change(setPrefectureHandler);
    } else {
        $(".prefectureInfo").find("input[name=basicinfo_pref]").change(setPrefectureHandler);
    }
}

function set_img_console(callback, elem, callback_resize) {
    elem.find(".addImgEdit a.imgClose , .addImgEdit a.imgResize").css("display","none");
    elem.mouseenter (function(){
        $(this).find("a.imgClose").show();
        $(this).find("a.imgResize").show();
    });
    elem.mouseleave (function(){
        $(this).find("a.imgClose").hide();
        $(this).find("a.imgResize").hide();
    });

    if (touch_mode) {
        elem.resizable();    
        elem.on("resizestop", function () {
            callback_resize(elem)
        });
        elem.find(".ui-icon").css("background-image", "none");
        elem.find(".jqResize").css("cursor", "default");
    } else {
        // jqDnRを利用する方法
        elem.jqResize('.jqResize', function(){callback_resize(elem)});
    }

    elem.find('a.imgClose').unbind("click");
    elem.find('a.imgClose').click(function(e){
        $(e.target).parent('.addImgEdit').remove();
        callback();
    });
}

function set_imgDialog_console(img_elem) {
    if (touch_mode) {
        img_elem.find(".imgCloseBtn").show();
    } else {
        img_elem.find(".imgCloseBtn").hide();

        img_elem.find('.thumbArea').mouseenter (function(){
            $(this).find(".imgCloseBtn").show();
        });
        img_elem.find('.thumbArea').mouseleave (function(){
            $(this).find(".imgCloseBtn").hide();
        });
    }
    img_elem.find('.imgCloseBtn').click(function(e) {
        removeDialogImage(function() {
            $(e.target).parents('.thumbArea').remove();
        }, $(e.target));
    });
}


function set_Rand_dialog() {
    $(".optRandDialog p.headThreadGroup ,.optRandDialog select.group ,.optRandDialog p.headThreadSubgroup, .optRandDialog select.subgroup").css("display", "none");
    $(document).on('click','.optRandDialog .addgroup', function(){
            $('.optRandDialog p.headThreadGroup , .optRandDialog select.group').css('float','right');
            $('.optRandDialog p.headThreadGroup').css('padding-top','15px');
            $(".optRandDialog p.headThreadGroup , .optRandDialog select.group").show();
            $(this).parent().addClass('disabled');
    });
    $(document).on('click', '.optRandDialog .addsubgroup',function(){
            $('.optRandDialog p.headThreadGroup , .optRandDialog select.group').css('float','none');
            $('.optRandDialog p.headThreadGroup').css('padding-top','0');
            $(".optRandDialog p.headThreadSubgroup , .optRandDialog select.subgroup").show();
            $(this).parent().addClass('disabled');
    });

    $(".qptRandDialog p.headThreadGroup , .qptRandDialog select.group , .qptRandDialog p.headThreadSubgroup, .qptRandDialog select.subgroup").css("display", "none");
    $(document).on('click','.qptRandDialog .addgroup', function(){
        $("div").click(function(){
        if ( $(this).hasClass(".addGroupMenu") )
            $('.qptRandDialog p.headThreadGroup , .qptRandDialog select.group').css('float','right');
            $('.qptRandDialog p.headThreadGroup').css('padding-top','15px');
        if ( $(this).hasClass(".addGroupMenu disabled") )
            $('.qptRandDialog p.headThreadGroup , .qptRandDialog select.group').css('float','none');
            $('.qptRandDialog p.headThreadGroup').css('padding-top','5px');
        });
            $(".qptRandDialog p.headThreadGroup , .qptRandDialog select.group").show();
            $(this).parent().addClass('disabled');
    });
    $(document).on('click', '.qptRandDialog .addsubgroup',function(){
            $(".qptRandDialog p.headThreadSubgroup , .qptRandDialog select.subgroup").show();
            $('.qptRandDialog p.headThreadGroup , .qptRandDialog select.group').css('float','none');
            $('.qptRandDialog p.headThreadGroup').css('padding-top','0');
            $(this).parent().addClass('disabled');
    });
}


// 数値を入力させるボックスのバリデーション（全角は使用可)
function str_int_validate(val){
    var lower_val = val.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    });
    if (lower_val.length > 20) {
        return 1000000000000000000
    }
    var parsed = parseInt(lower_val, 10);
    if(isNaN(parsed)){
        return ""
    } else {
        return parsed
    }
}

function text_box_textCheck(box_detail, text, qtype) {
    var ck = box_detail["checked"]
    var boxtype = box_detail["type"]
    var range = box_detail["range"]
    if (!boxtype) boxtype = 'boxtype1';
    if (!range) range = ["", ""];

    // 合計値入力で値の先頭に"+"が付いている場合NGとする。
    if(qtype == "textbox-sum") {
        if(text.match(/^\+/)) {
            return false;
        }
    }
    var checked_type = false;
    if (boxtype == "boxtype1") {
        checked_type = true;
    }
    var validated_boxType = validate_boxtexts(text);
    if ((boxtype == "boxtype3" || boxtype == "boxtype6") && (validated_boxType == "boxtype3" || validated_boxType == "boxtype2") ) {
        checked_type = true;

    } else if(boxtype == validated_boxType) {
        checked_type = true;
    }

    var result = false;
    if (checked_type) {
        result = validate_boxtext_length(range, text, boxtype);
        return result
    }
    return false
}

// テキストの形式チェック（内容の妥当性は見てない）
function validate_boxtexts(text) {
    if (!text) {
        return null
    }

    var valueType = $.type(text);

    if (valueType == "string") {
        if (text.length != 0) {
            if (text.match(/^[+\-]?[0-9]+(\.[0-9]+)?$/)) {
                return "boxtype2" // "数字"
            }
            if (text.match(/[^0-9A-Za-z]+/)) {
                if(text.match(/^([0-9]{4})\/([0-9]{1,2})\/([0-9]{1,2})$/)){
                    return "boxtype5" // "日付"
                }else if (text.match(/^[a-zA-Z0-9\._-]+@[a-zA-Z0-9_-]+\.[a-zA-Z0-9\._-]+$/)) {
                    return "boxtype4" // "email"
                } else {
                    return "boxtype1" // "全角"
                }
            } else {
                return "boxtype3" // "半角英数" and パスワード?
            }
        }
    }
    return null
}

function validate_boxtext_length(range, text, boxtype) {
    function is_empty(number) {
        if (number == null || number === "") return true;
        return false;
    }

    if (text == undefined || text == null) {
        return false
    }
    if (range == null) return true;
    if (is_empty(range[0]) && is_empty(range[1])) return true;

    if(boxtype == "boxtype5") {
        return true
    } else {
        var text_length = String(text).length;
        if(text_length > 10000) return false;
        if(boxtype != "boxtype2") {
            var range_re = [0,text.length + 1];
        } else {
            text_length = parseInt(text);
            var range_re = [null,text_length + 1];
        }

        if (isFinite(+range[0])) { range_re[0] = range[0] }
        if (isFinite(+range[1])) { range_re[1] = range[1] }
        if ((is_empty(range_re[0]) || text_length >= range_re[0])
            && (is_empty(range_re[1]) || text_length <= range_re[1])) {
            return true
        }
    }

    return false
}

function fullNum2Harf(text) {
    return text.replace(/[０１２３４５６７８９]/g, function(a){
        var b = "０１２３４５６７８９".indexOf(a);
        return (b !== -1)? b:a;
    });
}

function enquete_trim(fa_text){
	v_fa_text = $.trim(fa_text);
	return v_fa_text.replace(/\s|　/g,"");
}

function set_boxtext_validate(attrs, parent) {
    /**
        Script for the answer data input check
       [#4667] Input  prohibition of space only. ($(this).val(); => trim($(this).val());)  Change of four patterns.
    **/
    var bbtext, bbtext_choice;
    var g_sp_preview_mode = location.href.indexOf("/preview") != -1 && enquete_data['mode'] == 'preview' && language_code == 'ja' && touch_mode == false;
    if ("choices" in attrs && attrs["choices"]) {
        for (var i = 0; i < attrs["choices"].length; i++) {
            bbtext = CKEditorToText(attrs["choices"][i]["title"])
            if (!attrs["options"]["choice_options"] ||
                attrs["options"]["choice_options"][bbtext] == undefined ||
                !("textbox" in attrs["options"]["choice_options"][bbtext]) ||
                attrs["options"]["choice_options"][bbtext]["textbox"] == undefined ) {
                // テキストボックス未設定
                continue;
            }

            if (attrs["qtype"].indexOf("textbox") != -1) {
                // テキストボックスタイプの場合
                var elem = parent.find("[name='"+attrs["id"]+"'][val='"+attrs["choices"][i]["index"]+"']");
                elem.attr("bbtitle", bbtext);
                elem.bind('keydown keyup keypress change blur', function(e) {
                    var text = enquete_trim($(this).val());
                    var box_detail = attrs["options"]["choice_options"][$(this).attr("bbtitle")]["textbox"];
                    if (g_sp_preview_mode) {
                        var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
                        var elem_sp = $(pid).find('[name="'+$(this).attr("name")+'"][val="'+$(this).attr("val")+'"]');
                    }
                    if($(this).val().length == 0 ){
                        $(this).parents("td").find(".qPageCheck01").removeClass("Check01").removeClass("Check02");
                        if (box_detail.required) $(this).parents("td").find(".qPageCheck01").addClass("Check02");
                        if (g_sp_preview_mode) {
                            elem_sp.val("");
                            elem_sp.parents("td").find(".qPageCheck01").removeClass("Check01").removeClass("Check02");
                            if (box_detail.required) elem_sp.parents("td").find(".qPageCheck01").addClass("Check02");
                        }
                    } else {
                        var new_text1 = $(this).val().replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, "");
                        if (new_text1 != $(this).val()) $(this).val(new_text1);
                        text = enquete_trim(new_text1);
                        if (box_detail.type != 'boxtype1') {
                            var new_text = text.replace(/[\n\r]/g, "");
                            if (new_text != $(this).val()) {
                                $(this).val(new_text);
                                text = new_text;
                            }
                        }
                        if (box_detail.type == 'boxtype2' && attrs["qtype"] != "textbox-sum") {
                            if (text != $(this).val()) $(this).val(text);
                        }
                        if (g_sp_preview_mode) {
                            elem_sp.val($(this).val());
                        }
                        var validated = text_box_textCheck(box_detail, text, attrs["qtype"]);
                        if (validated == false) {
                            $(this).parents("td").find(".qPageCheck01").addClass("Check02")
                            $(this).parents("td").find(".qPageCheck01").removeClass("Check01")
                            if (g_sp_preview_mode) {
                                elem_sp.parents("td").find(".qPageCheck01").addClass("Check02")
                                elem_sp.parents("td").find(".qPageCheck01").removeClass("Check01")
                            }
                        } else {
                            $(this).parents("td").find(".qPageCheck01").addClass("Check01")
                            $(this).parents("td").find(".qPageCheck01").removeClass("Check02")
                            if (g_sp_preview_mode) {
                                elem_sp.parents("td").find(".qPageCheck01").addClass("Check01")
                                elem_sp.parents("td").find(".qPageCheck01").removeClass("Check02")
                            }
                        }
                    }
                });
            } else {
                var elem = parent.find(".uiTextboxAfItem").find("[name='textbox"+ attrs["id"] +"_"+ attrs["choices"][i]["index"] +"']");
                if (attrs["qtype"].indexOf("matrix") != -1) {
                    elem = parent.find(".uiTextboxes").find("[name='textbox_choice"+ attrs["id"] +"_"+ attrs["choices"][i]["index"] +"']");
                }
                elem.attr("bbtitle", bbtext);
                elem.click(function(){return false;});  // IE8でuiRadio関連イベントと競合するので
                elem.bind('keydown keyup keypress change blur', function(e) {
                    var text = enquete_trim($(this).val());
                    if (g_sp_preview_mode) {
                        var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
                        var elem_sp = $(pid).find('[name="'+$(this).attr("name")+'"]');
                    }
                    var required = (attrs["qtype"].indexOf("matrix")　== -1);
                    if($(this).attr("bbtitle") ==  CKEditorToText(attrs['options']['othertext'])&&
                        attrs['options']['otherRequired'] !=undefined){
                        required = attrs['options']['otherRequired'];
                    }else if (attrs["options"]["choice_options"][$(this).attr("bbtitle")]["textbox"] != undefined){
                        if(attrs["options"]["choice_options"][$(this).attr("bbtitle")]["textbox"]["required"] != undefined){
                            required = attrs["options"]["choice_options"][$(this).attr("bbtitle")]["textbox"]["required"];
                        }
                    }
                    if(text.length == 0){
                        if (required) {
                            // チェックマーク×にする
                            var $check = $(this).parents("td,th").find(".qPageCheck01");
                            if ($check.length == 0) $check = $(this).parents('.afterEdit:first').find(".CheckSize03");
                            $check.removeClass("Check01").removeClass("Check02");
                            $check.addClass("Check02");
                            if (g_sp_preview_mode) {
                                elem_sp.val("");
                                $check = elem_sp.parents("td,th").find(".qPageCheck01");
                                if ($check.length == 0) $check = elem_sp.parents('.afterEdit:first').find(".CheckSize03");
                                $check.removeClass("Check01").removeClass("Check02");
                                $check.addClass("Check02");
                            }
                        }else{
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check01")
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                            if (g_sp_preview_mode) {
                                elem_sp.val("");
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check01")
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                            }
                        }
                    } else {
                        var new_text1 = $(this).val().replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, "");
                        if (new_text1 != $(this).val()) $(this).val(new_text1);
                        text = enquete_trim(new_text1);
                        var box_detail = attrs["options"]["choice_options"][$(this).attr("bbtitle")]["textbox"];
                        if (box_detail.type != 'boxtype1') {
						    if (e.which == 13) {
						        return false;
						    }
							var new_text = text.replace(/[\n\r]/g, "");
							if (new_text != $(this).val()) {
						        $(this).val(new_text);
						        text = new_text;
						    }
						}
                        if (box_detail.type == 'boxtype2') {
                            if (text != $(this).val()) $(this).val(text);
                        }
                        var new_text = $(this).val().replace(/[\n\r]/g, "");
                        if (new_text != $(this).val()) $(this).val(new_text);
                        if (g_sp_preview_mode) {
                            elem_sp.val($(this).val());
                        }
                        text = new_text;
                        var validated = text_box_textCheck(box_detail, text)
                        if (validated == false) {
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check02")
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check01")
                            if (g_sp_preview_mode) {
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check02")
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check01")
                            }
                        } else {
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check01")
                            $(this).parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                            if (g_sp_preview_mode) {
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").addClass("Check01")
                                elem_sp.parents(".uiTextboxAfItem, .uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                            }
                        }
                    }
                });
            }
        }
    }
    if (attrs["qtype"].indexOf("matrix") != -1 && "items_left" in attrs) {
        for (var i = 0; i < attrs["items_left"].length; i++) {
            bbtext = CKEditorToText(attrs["items_left"][i]["title"]);
            // マトリックス回答項目にテキストボックスが設定されている場合の処理
            if (attrs["options"]["item_options"][bbtext] != undefined &&
                "textbox" in attrs["options"]["item_options"][bbtext] &&
                attrs["options"]["item_options"][bbtext]["textbox"] != undefined) {

                var elems = $(parent).find("[name='textbox"+ attrs["id"] +"_"+ attrs["items_left"][i]["index"] +"']");
                if (elems.is('*')) {
                    elems.attr("bbtitle", bbtext);
                    elems.bind('keydown keyup keypress change blur', function(e) {
                        // ママトリックス回答項目のテキストボックス入力
                        var text = enquete_trim($(this).val());
                        if (g_sp_preview_mode) {
                            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
                            var elem_sp = $(pid).find('[name="'+$(this).attr("name")+'"]');
                        }
                        var required = false;
                        if (attrs["options"]["item_options"][$(this).attr("bbtitle")]["textbox"] != undefined){
                            if(attrs["options"]["item_options"][$(this).attr("bbtitle")]["textbox"]["required"] != undefined){
                                required = attrs["options"]["item_options"][$(this).attr("bbtitle")]["textbox"]["required"];
                            }
                        }
                        if(text.length == 0){
                            if (required){
                                $(this).parents("th").find(".qPageCheck01").addClass("Check01").addClass("Check02");
                                if (g_sp_preview_mode) {
                                    elem_sp.val("");
                                    elem_sp.parents("th").find(".qPageCheck01").removeClass("Check01").removeClass("Check01");
                                    elem_sp.parents("th").find(".qPageCheck01").addClass("Check01").addClass("Check02");
                                }
                            }else{
                                $(this).parents("th").find(".qPageCheck01").removeClass("Check01").removeClass("Check02");
                                $(this).parents("th").find(".qPageCheck01").addClass("Check01").addClass("Check01");
                                if (g_sp_preview_mode) {
                                    elem_sp.val("");
                                    elem_sp.parents("th").find(".qPageCheck01").removeClass("Check02").removeClass("Check02");
                                    elem_sp.parents("th").find(".qPageCheck01").addClass("Check01").addClass("Check01");
                                }
                            }
                        } else {
                            var new_text1 = $(this).val().replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, "");
                            if (new_text1 != $(this).val()) $(this).val(new_text1);
                            text = enquete_trim(new_text1);
                            var box_detail = attrs["options"]["item_options"][$(this).attr("bbtitle")]["textbox"];
                            if (box_detail.type != 'boxtype1') {
                                if (e.which == 13) {
                                    return false;
                                }
                                var new_text = text.replace(/[\n\r]/g, "");
                                if (new_text != $(this).val()) {
                                    $(this).val(new_text);
                                    text = new_text;
                                }
                            }
                            if (box_detail.type == 'boxtype2') {
                                if (text != $(this).val()) $(this).val(text);
                            }
                            var new_text = $(this).val().replace(/[\n\r]/g, "");
                            if (new_text != $(this).val()) $(this).val(new_text);
                            if (g_sp_preview_mode) {
                                elem_sp.val($(this).val());
                            }
                            text = new_text;
                            var validated = text_box_textCheck(box_detail, text);
                            if (validated == false) {
                                $(this).parents("th").find(".qPageCheck01").addClass("Check02")
                                $(this).parents("th").find(".qPageCheck01").removeClass("Check01")
                                if (g_sp_preview_mode) {
                                    elem_sp.parents("th").find(".qPageCheck01").addClass("Check02")
                                    elem_sp.parents("th").find(".qPageCheck01").removeClass("Check01")
                                }
                            } else {
                                $(this).parents("th").find(".qPageCheck01").addClass("Check01")
                                $(this).parents("th").find(".qPageCheck01").removeClass("Check02")
                                if (g_sp_preview_mode) {
                                    elem_sp.parents("th").find(".qPageCheck01").addClass("Check01")
                                    elem_sp.parents("th").find(".qPageCheck01").removeClass("Check02")
                                }
                            }
                        }
                    });
                }
            }
            for (var j = 0; j < attrs["choices"].length; j++) {
                bbtext_choice = CKEditorToText(attrs["choices"][j]["title"])
                if (attrs["options"]["cell_options"][bbtext_choice][bbtext] == undefined ||
                    !("textbox" in attrs["options"]["cell_options"][bbtext_choice][bbtext]) ||
                    attrs["options"]["cell_options"][bbtext_choice][bbtext]["textbox"] == undefined) {
                    continue;
                }

                // マトリックス回答選択肢にテキストボックスが設定されている場合の処理
                var elem = $(parent).find("[name='textbox"+ attrs["id"] +"_"+ attrs["items_left"][i]["index"] +"_"+ attrs["choices"][j]["index"] +"']");
                if (elem.is('*')){
                    elem.attr({
                        "bbtitle": bbtext,
                        "bbtitle_choice": bbtext_choice,
                    });
                    elem.bind('keydown keyup keypress change blur', function(e) {
                        // マトリックス回答選択肢のテキストボックス入力
                        var text = enquete_trim($(this).val());
                        if (g_sp_preview_mode) {
                            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
                            var elem_sp = $(pid).find('[name="'+$(this).attr("name")+'"]');
                        }
                        var required = true;
                        if (attrs["options"]["cell_options"][$(this).attr("bbtitle_choice")][$(this).attr("bbtitle")]["textbox"] != undefined){
                            if(attrs["options"]["cell_options"][$(this).attr("bbtitle_choice")][$(this).attr("bbtitle")]["textbox"]["required"] != undefined){
                                required = attrs["options"]["cell_options"][$(this).attr("bbtitle_choice")][$(this).attr("bbtitle")]["textbox"]["required"];
                            }
                        }
                        if(text.length == 0){
                            if (required){
                                // テキスト入力無し
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check01");
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").addClass("Check02");
                                if (g_sp_preview_mode) {
                                    elem_sp.val("");
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check01");
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").addClass("Check02");
                                }
                            }else{
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check02");
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").addClass("Check01");
                                if (g_sp_preview_mode) {
                                    elem_sp.val("");
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check02");
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").addClass("Check01");
                                }
                            }
                        } else {
                            var new_text1 = $(this).val().replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g, "");
                            if (new_text1 != $(this).val()) $(this).val(new_text1);
                            text = enquete_trim(new_text1);
                            var box_detail = attrs["options"]["cell_options"][$(this).attr("bbtitle_choice")][$(this).attr("bbtitle")]["textbox"];
                            if (box_detail.type != 'boxtype1') {
                                if (e.which == 13) {
                                    return false;
                                }
                                var new_text = text.replace(/[\n\r]/g, "");
                                if (new_text != text) {
                                    $(this).val(new_text);
                                    text = new_text;
                                }
                            }

                            var new_text = $(this).val().replace(/[\n\r]/g, "");
                            if (new_text != $(this).val()) $(this).val(new_text);
                            if (g_sp_preview_mode) {
                                elem_sp.val($(this).val());
                            }
                            text = new_text;   
                            var validated = text_box_textCheck(box_detail, text);
                            if (validated == false) {
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").addClass("Check02")
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check01")
                                if (g_sp_preview_mode) {
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").addClass("Check02")
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check01")
                                }
                            } else {
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").addClass("Check01")
                                $(this).parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                                if (g_sp_preview_mode) {
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").addClass("Check01")
                                    elem_sp.parent(".uiTextboxes").find(".qPageCheck01").removeClass("Check02")
                                }
                            }
                        }
                    });
                }
            }
        }
    }
}

function setUis(parent) {
    var g_sp_preview_mode = location.href.indexOf("/preview") != -1 && enquete_data['mode'] == 'preview' && language_code == 'ja' && touch_mode == false;
    // ラジオボタン
    parent.find('.uiRadio label').click(function(e) {
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }

        // 編集フォーム内のスケール（顔）の関数の場合
        if ($(this).hasClass("face_in_edit_form")) {
            $(this).parents(".partOpt16").find('.face2').each(function(){
                $(this).find(".uiRadio").removeClass("checked");
            });
        }
        
        var name = $(this).prev().attr('name');
        if (g_sp_preview_mode) {
            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
            var elem_sp = $(pid).find('input[name="'+name+'"][val="'+$(this).prev().attr("val")+'"]').parent()
        }
        //マトリクスSP表示の場合のみPC表示スマホ表示両方に選択状態が反映されるようにする
        if ($(this).parents().hasClass("matrix-radio-sp")){
            if (g_sp_preview_mode && $(this).parents("#answerPage").length ==0 ){
                var view_disp = elem_sp.parents(".pcView").length > 0 ? ".spView" : ".pcView";
            }else{
                var view_disp = $(this).parents(".pcView").length > 0 ? ".spView" : ".pcView";
            }
            var elem_another_view = $(view_disp).find('input[name="'+name+'"][val="'+$(this).prev().attr("val")+'"]').parent()
        }

        if(! $(e.target).hasClass("logic_textbox") ){
            if ($(this).parents().hasClass("quiz-correct-answer")){
                $(this).parents().find('.uiRadio:has(input[name="'+name+'"])').removeClass('checked');
            } else {
                parent.find('.uiRadio:has(input[name="'+name+'"])').removeClass('checked');
            }
            $(this).parent().addClass('checked');
            $(this).parent().find(".logic_textbox").trigger("change");
            if ($(this).parents().hasClass("matrix-radio-sp")){
                elem_another_view.find('.uiRadio:has(input[name="'+name+'"])').removeClass('checked');
                elem_another_view.addClass('checked');
            }
            if (g_sp_preview_mode) {
                $(pid).find('.uiRadio:has(input[name="'+name+'"])').removeClass('checked');
                elem_sp.addClass('checked');
                elem_sp.find(".logic_textbox").trigger("change");
            }
        }

        $(this).parent().find(".logic_textbox").attr("disabled","disabled");
        if (g_sp_preview_mode) {
            elem_sp.find(".logic_textbox").attr("disabled","disabled");
        }
        if($(this).parent().hasClass('checked')){
            $(this).parent().find(".logic_textbox").removeAttr("disabled");
            // 強制的にチェックをする
            $(this).parent().find(".logic_textbox").trigger("change");
            $(this).parent().find(".logic_textbox").focus()
            if (g_sp_preview_mode) {
                elem_sp.find(".logic_textbox").removeAttr("disabled");
                // 強制的にチェックをする
                elem_sp.find(".logic_textbox").trigger("change");
            }
        } else {
            $(this).parent().find(".logic_textbox").attr("disabled","disabled");
            if (g_sp_preview_mode) {
                elem_sp.find(".logic_textbox").attr("disabled","disabled");
            }
        }
    });

    // チェックボックス
    parent.find('.uiCheck label').click(function(e) {
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }

        // 編集フォーム内のスケール（スター）の場合は動作無し。
        if ($(this).hasClass("star_in_edit_form")) {
            return;
        }

        var name = $(this).prev().attr('name');
        var value = $(this).prev().attr("val");
        if (g_sp_preview_mode) {
            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
        }

        //マトリクスSP表示の場合のみPC表示スマホ表示両方に選択状態が反映されるようにする
        if ($(this).parents().hasClass("matrix-checkbox-sp")){
            if (g_sp_preview_mode && $(this).parents("#answerPage").length ==0 ){
                var view_disp = $(pid).find("input[name='"+name+"'][val='"+value+"']").parents(".pcView").length > 0 ? ".spView" : ".pcView";
            }else{
                var view_disp = $(this).parents(".pcView").length > 0 ? ".spView" : ".pcView";
            }
        }

        if(! $(e.target).hasClass("logic_textbox") ){
            $(this).parent().toggleClass('checked');
            $(this).parent().find(".logic_textbox").trigger("change");
            if ($(this).parents().hasClass("matrix-checkbox-sp")&& pid != '#answerPage'){
                $(view_disp).find('[name="' + name + '"][val="' + value + '"]').parent().toggleClass('checked');
            }
            if (g_sp_preview_mode) {
                $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().toggleClass('checked');
                $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().find(".logic_textbox").trigger("change");
            }
        }

        if($(this).find(".logic_textbox").html()!= undefined){
            if($(this).parent().hasClass('checked')){
                $(this).find(".logic_textbox").removeAttr("disabled");
	            // 強制的にチェックをする
	            $(this).find(".logic_textbox").trigger("change");
                if (g_sp_preview_mode) {
                    $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().find(".logic_textbox").removeAttr("disabled");
                    $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().find(".logic_textbox").trigger("change");
                }
            } else {
                $(this).find(".logic_textbox").attr("disabled","disabled");
                if (g_sp_preview_mode) {
                    $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().find(".logic_textbox").removeAttr("disabled");
                    $(pid).find("input[name='"+name+"'][val='"+value+"']").parent().find(".logic_textbox").attr("disabled","disabled");
                }
            }
        }
    });

    // セレクトボックス
    parent.on('click', '.uiSelect', function(e) {
        if ($(this).hasClass('disabled')) {
            return;
        }
        var el = $(this);
        if (el.find('ul').is(':hidden')) {
            el.addClass('open');
            el.find('ul').slideDown('fast');
            parent.on('click', '.uiSelect li', function() {
                parent.off('click', '.uiSelect li', arguments.callee);
                if(!el.hasClass("uiRankingSelect")){
                    $(this).parent().siblings('p').html($(this).html());
                    $(this).parent().siblings('input').val($(this).data('value'));
                    if (g_sp_preview_mode) {
                        var name = $(this).parent().parent().find("input").attr("name");
                        var value = $(this).data('value');
                        var sp = $("#answerSPPreview").find("input[name="+name+"]");
                        var select = sp.parent().find("select");
                        sp.siblings('div.selectTxt').text(select.find('option[value="'+value+'"]').text());
                        sp.val(value);
                        select.val(value);
                    }
                    if ($(this).parent().parent().find("input").attr("name") == "basicinfo_pref") {
                        $(this).parent().parent().find('input').change();
                    }
                }
            });
            parent.on('click', function() {
                parent.off('click', arguments.callee);
                el.find('ul').slideUp('fast', function() {
                    el.removeClass('open');
                });
            });
        }
    });
    parent.on('change', '.uiSelect select', function(e) {
        if ($(this).parent().hasClass("uiRankingSelect")) return;

        var value = $(this).val();
        var txt = $(this).find('option[value="'+value+'"]').text();
        $(this).siblings('div.selectTxt').text(txt);
        $(this).siblings('input').val(value);
        if (g_sp_preview_mode) {
            var pc = $("#answerPage").find("input[name="+$(this).parent().parent().find("input").attr("name")+"]");
            pc.siblings('p').html(pc.parent().find("li[data-value='"+value+"']").html());
            pc.val(value);
        }
        if ($(this).parent().find("input").attr("name") == "basicinfo_pref") {
            $(this).parent().find('input').change();
        }
    });

    // スケール
    parent.on('click', '.uiScale :not(.star) label', function(e) {
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }
        var name = $(this).parent().find('input').attr('name');
        parent.find('.uiScale div:has(input[name="'+name+'"])').removeClass('checked');
        $(this).parent().addClass('checked');
        if (g_sp_preview_mode) {
            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
            var sp = $(pid+" input[id='"+$(this).parent().find("input").attr("id")+"']");
            sp.parents(".uiScale").find('div:has(input[name="'+name+'"])').removeClass('checked');
            sp.parent().addClass('checked');
        }
    });
    // スケールスター
    parent.on('click', '.uiScale .star label', function(e) {
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }
        var name = $(this).prev().attr('name');
        $('.uiScale div:has(input[name="'+name+'"])').removeClass('checked');
        $(this).parent().addClass('checked');
        $(this).parent().prevAll().addClass('checked');
        if (g_sp_preview_mode) {
            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
            var sp = $(pid+" input[id='"+$(this).parent().find("input").attr("id")+"']");
            sp.parent().addClass('checked');
            sp.parent().prevAll().addClass('checked');
        }
    });
    parent.on('mouseenter', '.uiScale .star label', function(e) {
        if ($(this).parents("#answerSPPreview").length > 0) return;
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }
        var name = $(this).prev().attr('name');
        parent.find('.uiScale div:has(input[name="'+name+'"])').removeClass('hover');
        $(this).parent().addClass('hover');
        $(this).parent().prevAll().addClass('hover');
    });
    parent.on('mouseleave', '.uiScale .star label', function(e) {
        if ($(this).parents("#answerSPPreview").length > 0) return;
        if ($(e.target).hasClass('noUI')) {
            return;
        }
        if ($(this).parent().hasClass('disabled')) {
            e.preventDefault();
            return;
        }
        var name = $(this).prev().attr('name');
        parent.find('.uiScale div:has(input[name="'+name+'"])').removeClass('hover');
    });

    // テキストボックス
    parent.on('keydown keyup keypress change', '.uiTextbox textarea,.uiTextbox input[type="password"]', function() {
        if (g_sp_preview_mode) {
            // SPプレビューモードの場合、もう一方のテキストボックスにも同じ値を入れる
            var pid = $(this).parents("#answerPage").length > 0 ? "#answerSPPreview" : "#answerPage";
            var another_txtbox = $(pid).find("[name='"+$(this).attr("name")+"'][bbtitle='"+$(this).attr("bbtitle")+"']");
            var val = $(this).val();
            if (another_txtbox.val() != val) {
                another_txtbox.val(val).trigger("change");
            }
            another_txtbox.parents('.textboxSet:first').find('.textbox_input_count').text($(this).val().length);
        }
        $(this).parents('.textboxSet:first').find('.textbox_input_count').text($(this).val().length);
    });

    //  セルのカラーリング[マトリックス /縦]
    if(parent.find(".cellColorV").html() != undefined){
        parent.find("th:nth-child(2n)",".cellColorV")
          .css("background-color","#F7F7F7")
        parent.find("td:nth-child(2n)",".cellColorV")
          .css("background-color","#F7F7F7")
    }
    
    // デートピッカーアイコン
    parent.find('a.calendar-mark').click(function(e) {
        $(this).next().focus();
    });

    parent.find('.datepicker').click(function(e) {
        $(this).next().focus();
    });
}

var show_ohter_q_answer_def = {
    "0" : NO_ANSWER_TEXT,
    "-1": HIDDEN_ANSWER_TEXT
}

// 他質問の回答表示と回答確認画面で利用（特定質問の回答をフォーマットして取得）
function get_ans(qtype, qid, item_index, ans, choices) {
    if (qtype == "radio" || qtype.indexOf("scale") != -1 || qtype == "pulldown" || qtype == "choiceimage-radio") {
        var ans_text = get_answer_text(choices, ans[qid]["answers"]);
        if(ans[qid]["free_answers"] != null) ans_text += "(" + ans[qid]["free_answers"] + ")";
        return ans_text;

    } else if (qtype == "checkbox" || qtype == "choiceimage-checkbox") {
        var ans_array = []
        if (ans[qid]["answers"][0] == -1) {
            ans_array.push(show_ohter_q_answer_def["-1"])
            return ans_array
        }
        for (var i=0; i< ans[qid]["answers"].length; i++) {
            if (ans[qid]["answers"][i] == 1) {
                var ans_text = get_answer_text(choices, i+1);
                if(ans[qid]["free_answers"][i] != null) ans_text += "(" + ans[qid]["free_answers"][i] + ")";
                ans_array.push(ans_text);
            }
        }
        if (ans_array.length == 0) {
            ans_array.push(show_ohter_q_answer_def["0"])
        }
        return ans_array

    } else if (qtype == "ranking") {
        var ans_array = []
        if (ans[qid]["answers"][0] == -1) {
            ans_array.push(show_ohter_q_answer_def["-1"])
            return ans_array
        }
        if (ans[qid]["answers"][0] == 0 || isNaN(ans[qid]["answers"][0])) {
            ans_array.push(show_ohter_q_answer_def["0"])
            return ans_array
        }
        // for (var i=0; i< ans[qid]["answers"].length; i++) {
        //     var ans_text = get_answer_text(choices, ans[qid]["answers"][i]);
        //     if(ans[qid]["free_answers"][ans[qid]["answers"][i]-1] != null) ans_text += "(" + ans[qid]["free_answers"][ans[qid]["answers"][i]-1] + ")";            
        //     ans_array.push(ans_text);
        // }
        item_index -= 1;
        var ans_text = get_answer_text(choices, ans[qid]["answers"][item_index]);
        if(ans[qid]["free_answers"][ans[qid]["answers"][item_index]-1] != null) ans_text += "(" + ans[qid]["free_answers"][ans[qid]["answers"][item_index]-1] + ")";
        ans_array.push(ans_text);

        if (ans_array.length == 0) {
            ans_array.push(show_ohter_q_answer_def["0"])
        }
        return ans_array

    } else if (qtype.indexOf("matrix-radio") != -1) {
        var ans_col_num = ans[qid]["answers"]["row" + item_index];
        var ans_text = get_answer_text(choices, ans_col_num);
        if(ans[qid]["free_answers"]["choice"][ans_col_num - 1] != null) ans_text += "(" + ans[qid]["free_answers"]["choice"][ans_col_num - 1] + ")";
        if(ans[qid]["free_answers"]["row" + item_index] != null) ans_text += "(" + ans[qid]["free_answers"]["row" + item_index] + ")";
        return ans_text

    } else if (qtype.indexOf("matrix-checkbox") != -1) {
        var ans_array = []
        if (ans[qid]["answers"]["row" + item_index][0] == -1) {
            ans_array.push(show_ohter_q_answer_def["-1"])
            return ans_array
        }
        for (var i=0; i< ans[qid]["answers"]["row" + item_index].length; i++) {
            if (ans[qid]["answers"]["row" + item_index][i] == 1) {
                var ans_text = get_answer_text(choices, i+1);
                if(ans[qid]["free_answers"]["choice"][i] != null) ans_text += "(" + ans[qid]["free_answers"]["choice"][i] + ")";
                if(ans[qid]["free_answers"]["row" + item_index][i] != null) ans_text += "(" + ans[qid]["free_answers"]["row" + item_index][i] + ")";
                ans_array.push(ans_text);
            }
        }
        if (ans_array.length == 0) {
            ans_array.push(show_ohter_q_answer_def["0"])
        }
        return ans_array
    } else if (qtype.indexOf("textbox") != -1) {
        return ans[qid]["answers"][parseInt(item_index-1)]
    }

    return []
}

// 回答番号から選択肢文章を取得
function get_answer_text(choices, ans_index) {
    for(var i= 0; i< choices.length; i++){
        if (choices[i]["index"] == ans_index) {
            return choices[i]["title"]
        }
    }
    for (var key in show_ohter_q_answer_def) {
        if (parseInt(key) == parseInt(ans_index)) {
            return show_ohter_q_answer_def[key]
        }
    }
    return ans_index
}

function append_cover_elem_class(srcElm, className) {
    if (className != "image-in") {
        var dstElm = srcElm.parents('label:first');
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('th:first');
        }
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('td:first');
        }
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('.disp_logic:first');
        }
    }
    else {
        var dstElm = srcElm.parents('label');
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('th');
        }
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('td');
        }
        if (dstElm.length == 0) {
            dstElm = srcElm.parents('.disp_logic');
        }
    }
    dstElm.addClass(className);
}
// 選択肢に画像追加 (change_tableformの後に呼ぶ必要がある)
function append_image_consoles(attrs, parent, t, sidebar) {
    if (!attrs["options"]["choice_options"]) {
        return;
    }
    var qtype = attrs['qtype'];

    _.each(attrs['choices'], function(choice) {
        var choiceOp = attrs["options"]["choice_options"][CKEditorToText(choice["title"])];

        // 選択肢に画像追加
        if ((choiceOp["images"] != null && (qtype == "radio" || qtype == "checkbox" || qtype == "ranking" || qtype == "scale" || qtype.indexOf("textbox") != -1 || qtype.indexOf("matrix") != -1) || qtype.indexOf("choiceimage") != -1)) {
            if (choiceOp['image_width'] === undefined) {
                choiceOp['image_width'] = def_logic_data['image_width']
            }

            var image_area = parent.find(".addImgEditWrap#addImg" + choice["index"]);
            append_cover_elem_class(image_area, 'image-in');
            if (qtype == 'choiceimage-radio' || qtype == 'choiceimage-checkbox') {
                var url =choiceOp["images"];
                var dispIndex = choice["index"];
                if (url) {
                    var context = {
                        url: choiceOp["images"],
                        enlarged_on_tap: attrs.options.enlarged_on_tap,
                        thumbUrl: choiceOp["thumbs"],
                        index: attrs.index, choice: choice,
                        delete_flg: attrs["options"]["show_headline"]};
                    var tmpl = _.template($('#q-logic-view-choiceimg').html());
                    image_area.html(tmpl(context));
                } else {
                    var q = parent.find('#addHead' + dispIndex);
                    var l = $(q).find('label.choice-block');
                    var hiddenInfo = $('<a class="choiceimage qnum-' + attrs.index+ '" href="no-image-' + dispIndex + '"><img alt="' + encodeURIComponent(choice.title) + '" style="display:none;"></a>');
                    l.append(hiddenInfo);
                }
            } else {
                image_area.html(_.template($('#q-logic-view-img').html(), {"url": choiceOp["images"], "sp_preview_mode":attrs["sp_preview_mode"]}));
            }
            image_area.css("width", choiceOp["image_width"]); 
            image_area.css("min-width", "20px");
            if(image_area.hasClass("col")) {
                image_area.before("<br>");
            }

            if(attrs["mode"] == "edit"){
                set_img_console(function(){
                    delete attrs["options"]["choice_options"][CKEditorToText(choice["title"])]["images"]
                    delete attrs["options"]["choice_options"][CKEditorToText(choice["title"])]["image_width"]
                    sidebar.forcedSave(t.model, {'options': attrs["options"]});
                }, image_area,
                function(){
                    var image_area = parent.find(".addImgEditWrap#addImg" + choice["index"]);
                    var elem_base = image_area.parents(".disp_logic");
                    var elem = image_area.find(".addImgEdit");
                    if (elem_base.length == 0 || qtype == 'ranking') {
                        elem_base = image_area.parents('td:first');
                    }
                    if (elem_base.length == 0) {
                        elem_base = image_area.parents('th:first');
                    }

                    var width = optimal_width(elem, elem_base, qtype);
                    elem.css("width", width);

                    attrs["options"]["choice_options"][CKEditorToText(choice["title"])]["image_width"] = width;
                    sidebar.forcedSave(t.model, {'options': attrs["options"]});
                });
            }
        }

        if (qtype == "radio" || qtype == "checkbox" || qtype == "ranking" || qtype.indexOf("matrix") != -1 || qtype.indexOf('choiceimage') != -1) {
            // var choiceOp = attrs["options"]["choice_options"][CKEditorToText(choice["title"])];

            // 日付タイプであれば、datepickerを設置
            if(choiceOp["textbox"] && "checked" in choiceOp["textbox"]){
                if(choiceOp["textbox"]["checked"] && choiceOp["textbox"]["type"] == "boxtype5"){
                    var min = choiceOp["textbox"]["range"][0];
                    var max = choiceOp["textbox"]["range"][1];
                    var $box;
                    if(qtype.indexOf("matrix") != -1){
                        $box = parent.find("[name='textbox_choice" + attrs["id"] + "_" + choice["index"] + "']");
                    } else {
                        $box = parent.find("[name='textbox" + attrs["id"] + "_" + choice["index"] + "']")
                    }
                    setDatePicker($box, min, max);
                    append_cover_elem_class($box, 'datepicker-in');
                }

                if(choiceOp["textbox"]["checked"]){
                    var textbox_area = parent.find("#addText"+choice["index"]+" ."+choiceOp["textbox"]["type"]);
                    append_cover_elem_class(textbox_area, 'textbox-in');
                    textbox_area.css("display","inline-block");
                }

                if(choiceOp["textbox"]["checked"] && choiceOp["textbox"]["type"] != "boxtype5" && choiceOp["textbox"]["type"] != "boxtype6"){
                    var width = choiceOp["textbox"]["width"];
                    var height = choiceOp["textbox"]["height"];
                    var target_name = "textbox";
                    if(qtype.indexOf("matrix") != -1){
                        target_name = "textbox_choice";
                    }
                    parent.find("[name='" + target_name + attrs["id"] + "_" + choice["index"] + "']").attr("rows", height);
                    parent.find("[name='" + target_name + attrs["id"] + "_" + choice["index"] + "']").attr("cols", width);
                }
            }
        }
    });

    if (window.choiceImage) {
        var choiceSelector = ".choiceimage.qnum-" + attrs.index;
        choiceImage(choiceSelector);
    }

    // マトリックスの項目、セル内の日付テキストボックスにデートピッカー付与
    setTimeout(function(){
        if (qtype.indexOf("matrix") != -1) {
            // 項目
            _.each(attrs["options"]["rows"], function(row, row_index){
                var option_key = CKEditorToText(row);
                if (!option_key in attrs["options"]["item_options"]) return;

                var option = attrs["options"]["item_options"][option_key];
                if (!option["textbox"] || !option["textbox"]["checked"]) return;

                var textbox_info = option["textbox"];
                if (textbox_info["type"] == "boxtype5") {
                    var min = textbox_info["range"][0];
                    var max = textbox_info["range"][1];
                    var $elem = $('[name=textbox' + attrs["id"] + '_' + (row_index+1) + ']');
                    setDatePicker($elem, min, max);
                    append_cover_elem_class($elem, 'datepicker-in');
                }
            });

            // セル
            var cell_options = attrs["options"]["cell_options"];
            if (!cell_options) return;

            var cols = _.map(attrs["options"]["cols"], function(x){return x;});
            if (attrs["options"]["other"])
                cols.push(attrs["options"]["othertext"]);
            if (attrs["options"]["nochoice"])
                cols.push(attrs["options"]["nochoicetext"]);

            _.each(cols, function(col, col_index){
                var col_key = CKEditorToText(col);
                if (!cell_options[col_key]) return;

                _.each(attrs["options"]["rows"], function(row, row_index){
                    var row_key = CKEditorToText(row);

                    var option = cell_options[col_key][row_key]
                    if (!option || !option["textbox"] || !option["textbox"]["checked"]) return;

                    var textbox_info = option["textbox"];
                    if (textbox_info["type"] == "boxtype5") {
                        var min = textbox_info["range"][0];
                        var max = textbox_info["range"][1];
                        var $elem = $('[name=textbox' + attrs["id"] + '_' + (row_index+1) + '_' + (col_index+1) + ']');
                        setDatePicker($elem, min, max);
                        append_cover_elem_class($elem, 'datepicker-in');
                    }
                });
            });
        }
    },1);

    // テキストボックスタイプであり、日付型の場合、datepickerを設置
    if(qtype.indexOf("textbox") != -1){
        _.each(attrs['choices'], function(choice) {
            var choiceOp = attrs["options"]["choice_options"][CKEditorToText(choice["title"])];
            if(parent.find("input[type='text']").html()!= undefined){
                if (choiceOp["textbox"]) {
                    if(choiceOp["textbox"]["type"] == "boxtype5"){
                        var min = choiceOp["textbox"]["range"][0];
                        var max = choiceOp["textbox"]["range"][1];
                        var $box = parent.find("input[type='text'][val='"+choice["index"]+"']");
                        setDatePicker($box, min, max);
                        append_cover_elem_class($box, 'datepicker-in');
                    }
                }
            }
        });
    }
}

// change_tableformの前に呼ぶ必要がある
function set_question_initial_logics(attrs, parent, t, sidebar) {
    var qtype = attrs['qtype'];

    // 画像タイプ：サイズ指定と編集モードではリサイズ関数の設置
    if(qtype == "images" || qtype == "choiceimage-radio" || qtype == "choiceimage-checkbox"){
        for (var i=0; i<attrs['options']["images"].length;i++){
            var img_name = attrs['options']["images"][i];
            var img_width = 100;
            if("image_width" in attrs['options']){
                if(img_name in attrs['options']["image_width"]){
                    if(!(isNaN(parseInt(attrs['options']["image_width"][img_name])))){
                        img_width = parseInt(attrs['options']["image_width"][img_name])
                    }
                }
            }
            var target_elem = parent.find("#addImgType"+i);
            target_elem.css("width", img_width);
            target_elem.css("min-width", "78px");
            target_elem.attr("el_name", img_name);

            if("mode" in attrs){
                if(attrs["mode"] == "edit"){
                    set_img_console(
                        function(){},
                        target_elem,
                        function(elem){
                            var imgName = elem.attr("el_name");
                            if(!("image_width" in attrs['options'])){
                                attrs['options']["image_width"] = {};
                            }
                            if(!(imgName in attrs['options']["image_width"])){
                                attrs['options']["image_width"][imgName] = 100;
                            }

                            var elem_base = elem.parents(".questionContent");
                            var width = optimal_width(elem, elem_base, 'images');
                            elem.css("width", width);
                            attrs['options']["image_width"][imgName] = width;
                            sidebar.forcedSave(t.model, {'options': attrs["options"]});
                        }
                    );
                }
            }
        }
    }

    var matrix_head = [];
    var index_prev = 1;
    if (attrs["options"]["choice_options"]) {

        _.each(attrs['choices'], function(choice) {
            var choiceOp = attrs["options"]["choice_options"][CKEditorToText(choice["title"])];

            if (choiceOp["exc"] && qtype.indexOf("checkbox") != -1) {
                parent.find(".dispExc").show();
            }

            // 選択肢にテキストボックス追加
            if (choiceOp["textbox"] && choiceOp["textbox"]["checked"] && (qtype == 'matrix-radio-sp' || qtype == 'matrix-checkbox-sp' || qtype == "radio" || qtype == "checkbox" || qtype == "ranking" || qtype.indexOf("scale") != -1 || qtype.indexOf('choiceimage') != -1)) {
                var unit = ""
                if("unit" in choiceOp["textbox"]){
                    unit = choiceOp["textbox"]["unit"]
                }

                var insert_data = _.extend({bb:CKEditorToHtml, bbText: CKEditorToText}, {"id": attrs["id"], "choice": choice, "mode": attrs["mode"], "unit": unit});
                var textbox_area = parent.find(".afterEdit#addText" + choice["index"]);
                append_cover_elem_class(textbox_area, 'textbox-in');
                textbox_area.data('insert_data', insert_data);
                textbox_area.data('textbox', choiceOp["textbox"]);
                textbox_area.html(_.template($('#q-logic-view-text').html(), insert_data));
                if(choiceOp["textbox"]["type"] == "boxtype6"){
                    textbox_area.find("textarea").remove();
                    textbox_area.find("input[type='text']").remove();
                    textbox_area.find(".calendar-mark").remove();
                } else if(choiceOp["textbox"]["type"] == "boxtype5"){
                    textbox_area.find("textarea").remove();
                    textbox_area.find("input[type='password']").remove();
                    append_cover_elem_class(textbox_area, 'datepicker-in');
                } else {
                    textbox_area.find("input[type='text']").remove();
                    textbox_area.find(".calendar-mark").remove();
                    textbox_area.find("input[type='password']").remove();
                }
            }

            // マトリクス横の場合の、列見出しデータ作成
            
            if(qtype.indexOf("matrix") != -1 && qtype.indexOf("-vert") == -1) {
                if (choiceOp["head"] && choiceOp["head"]["checked"]) {
                    matrix_head.push({
                        "index_prev": index_prev,
                        "col_span": 1,
                        "id": attrs["id"],
                        "head_text": choiceOp["head"]["text"],
                        "choice_title": choice["title"],
                        "choice_index": choice["index"]
                    });
                } else if (matrix_head.length != 0) {
                    matrix_head[matrix_head.length -1]["col_span"] ++;
                } else {
                    index_prev ++;
                }
            }
        });
    }

    if('items_left' in attrs && qtype.indexOf("matrix") != -1){

        // マトリクス縦の場合の列見出しデータ作成
        index_prev = 1;
        _.each(attrs['items_left'], function(item) {
            var itemOp = attrs["options"]["item_options"][CKEditorToText(item["title"])];

            if (qtype.indexOf("-vert") != -1) {

                if (itemOp["head"] && itemOp["head"]["checked"]) {
                    matrix_head.push({
                        "index_prev": index_prev,
                        "col_span": 1,
                        "id": attrs["id"],
                        "head_text": itemOp["head"]["text"],
                        "choice_title": item["title"],
                        "choice_index": item["index"]
                    });
                } else if (matrix_head.length != 0) {
                    matrix_head[matrix_head.length -1]["col_span"] ++;
                } else {
                    index_prev ++;
                }
            }

            // マトリクス項目への画像追加
            if (itemOp["images"] != null){
                if (itemOp['image_width'] === undefined) {
                    itemOp['image_width'] = def_logic_data['image_width']
                }

                var image_area = parent.find(".addImgEditWrap#addImgItem" + item["index"]);
                append_cover_elem_class(image_area, 'image-in');
                image_area.html(_.template($('#q-logic-view-img').html(), {"url": itemOp["images"], "sp_preview_mode": attrs["sp_preview_mode"]}));
                image_area.css("width", itemOp["image_width"]);
                if(image_area.hasClass("col")) {
                    image_area.before("<br>");
                    image_area.find(".addImgEdit").addClass("addImgRowEdit");
                }

                if(attrs["mode"] == "edit"){
                    set_img_console(function(){
                        delete attrs["options"]["item_options"][CKEditorToText(item["title"])]["images"]
                        delete attrs["options"]["item_options"][CKEditorToText(item["title"])]["image_width"]
                        sidebar.forcedSave(t.model, {'options': attrs["options"]});
                    }, image_area,
                    function(){
                        var $elm = parent.find(".addImgEditWrap#addImgItem" + item["index"]).find(".addImgEdit");
                        // var $flame = $elm.parents('th:first');
                        var $frame = $elm.parents('table:first').find('thead th:first');
                        var width = optimal_width($elm, $frame);

                        attrs["options"]["item_options"][CKEditorToText(item["title"])]["image_width"] = width;
                        sidebar.forcedSave(t.model, {'options': attrs["options"]});
                    });
                }
            };
        });
    }

    //　マトリックス見出しの表示追加
    var insert_data = _.extend({bb:CKEditorToHtml, bbText: CKEditorToText}, {"matrix_head": matrix_head, "mode": attrs["mode"]});
    if(qtype.indexOf("matrix") != -1 && qtype.indexOf("-vert") == -1 && matrix_head.length != 0) {
        parent.find(".uiMatrix > thead > tr:first").before(_.template($('#q-logic-view-head-matrix').html(), insert_data));
    }
    if(qtype.indexOf("-vert") != -1 && matrix_head.length != 0) {
        parent.find(".uiMatrixVertical > thead > tr:first").before(_.template($('#q-logic-view-head-matrix').html(), insert_data));
    }

    //　スケール（顔）：顔の順序指定
    if(qtype == "scale-face") {
        if(['face_order'] in attrs["options"]){
            if(attrs["options"]['face_order'] == true){
                var hash = {'a':'e', 'b':'d', 'c':'c', 'd':'b', 'e':'a'};
                parent.find(".uiScaleInner").find(".face").each(function(){
                    for (var key in hash) {
                        if($(this).hasClass(key)){
                            $(this).removeClass(key);
                            $(this).addClass(hash[key]);
                            break;
                        }
                    }
                });
            }
        }
    }

    parent.find('.uiRankingSelect').each(function(){
        // 「ランキング（順位回答）」->選択できる順位の数を指定する
        if( !attrs["options"]["set_rank"] ) return;
        var rank_upper = parseInt(attrs["options"].rank_upper);
        if(isNaN(rank_upper)) return;

        if (touch_mode || $(this).parents("#answerSPPreview").length > 0) {
            $(this).find('select option').each(function(index){
                if(index > rank_upper) $(this).remove();
            });
        } else {
            $(this).find('ul li').each(function(index){
                if(index > rank_upper) $(this).remove();
            });
        }
    });
}

function set_checked(elem, tf, def) {
    if (tf != undefined) {
        elem.prop("checked", tf);
    } else {
        elem.prop("checked", def);
    }
}

function set_radio(elem,def){
    if(elem != undefined){
        elem.prop("checked", true);
    }else{
        def.prop("checked",true);
    }
}

function set_textbox(elem, text) {
    if (text != undefined) {
        elem.val(_.unescape(text));
    }
}

function set_textbox_val(elem, text) {
    
    
    if (text != undefined) {

        elem.html(CKEditorToHtml(text,true))

    }else{
        //　タグがエスケープされないように調整
        elem.html(CLOSED_TEXT+"</p><p>"+CLOSED_TEXT2);
        elem.html(elem.html().replace("<p></p><p>","</p><p>"));
        elem.html(elem.html().replace("<p></p>",""));
    }
        if (touch_mode){
            elem.find("h2").css('display','none');
        }
}
function set_default_closed_message(){
    
    var old_data=CKEDITOR.instances['clsd-msg'].getData();
    var data_new ="<span style='font-size:24px;color:#BD0C18'>"+old_data+"</span>";
    CKEDITOR.instances['clsd-msg'].setData(data_new);
}

function set_textbox_reserve_message_val(elem, text) {
    if (text != undefined) {
        elem.html(CKEditorToHtml(text,true));
    }else{
        //　タグがエスケープされないように調整
        elem.html(RESERVE_TEXT);
        elem.html(elem.html().replace("<p></p><p>","</p><p>"));
        elem.html(elem.html().replace("<p></p>",""));
    }
    if (touch_mode) {
        elem.find("h2").css('display', 'none');
    }
}

function set_default_reserve_message(){
    var old_data=CKEDITOR.instances['reserve-msg'].getData();
    var data_new ="<span style='font-size:24px;color:#BD0C18'>"+old_data+"</span>";
    CKEDITOR.instances['reserve-msg'].setData(data_new);
}

// アンケートオプションの設定
function setEnquete_design_panel(enqOp, t_model, theme_edit, mtListView, sidebar){
    data = _.extend({bb:CKEditorToHtml, bbText:CKEditorToText}, enqOp);

    $(".optionDialog").html(_.template($('#enquete_options').html(), data));
    $(".optionDialog").find('.optionsPopup,.optionsPopup2').perfectScrollbar({wheelSpeed:PERFECT_SCROLLBAR_WHEEL_SPEED});
//        ckOptions = {};
//        CKEDITOR.replace("clsd-msg",ckOptions);
        
//        var text_elem =  $(".optionDialog").find('.closedMsg');
//                text_elem.focus(function(e){
//                    answertag_options = [];
//                    text_elem.blur();
//                    e['editor'] = CKEDITOR.instances['clsd-msg'];
//                    open_CKEditorDialog(text_elem.html(), EDIT_MESSAGE_TEXT, function(input){
//                        text_elem.html(input);
//                        pageTextBlurHandler(e);
//                    });
//                });
        
        
//        CKEDITOR.instances["clsd-msg"]
    //ロジックウィンドウを表示
    if ($(".optionDialog").is(":hidden")) {
        utils.openDialog($('.optionDialog'), "#enqueteEdit");
        //$(".optionDialog").fadeIn();
        //$('.overlay .background').fadeIn();
    }

    elem = $(".optionDialog").find('.cont');

    // ロゴアップロード用JS
    elem.find("#btnBrowse_03").click(function(){
        if ($('.imgDialog').is(":hidden")) {
            showImageDialog(function(image_url) {
                if (image_url != undefined) {
                    // $(".optionDialog").find(".upload-logo-img-box").val(image_url.match(".+/(.+?)$")[1]);
                    $(".optionDialog").find(".upload-logo-img-box").val(getNameFromS3URL(image_url));
                    $(".optionDialog").find(".upload-logo-img-box").attr("data_url",image_url);
                    enqOp["logo"] = image_url;

                    display_logo_delete();
                }
            }, false, true);
        }
    });

    var LANGUAGE_DEFAULT = 'japanese';
    if ($('body').hasClass('en')) {
        LANGUAGE_DEFAULT = 'english';
    }

    var isFontUnselected = enqOp["font"] == undefined || enqOp["font"] == '';
    var FONT_DEFAULT = isFontUnselected ? '' : 'NotoSansJP';

    set_theme_to_form(enqOp)

    // データをフォームに反映
    function set_theme_to_form(theme_data){
        if (theme_data["logo"] != undefined && theme_data["logo"] != "") {
            // $(".optionDialog").find(".upload-logo-img-box").val(theme_data["logo"].match(".+/(.+?)$")[1]);
            $(".optionDialog").find(".upload-logo-img-box").val(getNameFromS3URL(theme_data["logo"]));
            $(".optionDialog").find(".upload-logo-img-box").attr("data_url",theme_data["logo"]);
        } else {
            $(".optionDialog").find(".upload-logo-img-box").val("");
            $(".optionDialog").find(".upload-logo-img-box").attr("data_url","");
        }

        if (theme_data["language"] == undefined) {
            elem.find('select[name=language]').val(LANGUAGE_DEFAULT);
        } else {
            elem.find('select[name=language]').val(theme_data["language"]);

            if (theme_data["language"] !== "japanese" && is_panel_research) {
                //パネルリサーチ用アンケートで日本語以外の場合は設定変更不可状態を解除する
                elem.find('select[name=language]').prop('disabled', false)
            }
        }

        if (theme_data["font"] == undefined) {
            elem.find('select[name=font]').val(FONT_DEFAULT);
        } else {
            elem.find('select[name=font]').val(theme_data["font"]);
        }

        set_checked(elem.find('input[name=qnum]'), theme_data["set_qnum"], enquete_option_def["set_qnum"]);
        set_checked(elem.find('input[name=cnum]'), theme_data["set_cnum"], enquete_option_def["set_cnum"]);

        set_textbox(elem.find('.backText'), theme_data["back_text"]);
        set_textbox(elem.find('.nextText'), theme_data["next_text"]);
        set_textbox(elem.find('.sendText'), theme_data["send_text"]);
        set_textbox(elem.find('.startText'), theme_data["start_text"]);
        set_textbox(elem.find('.abortText'), theme_data["abort_text"]);
        set_textbox_val(elem.find('#clsd-msg'), theme_data["closed_message"]);
        elem.find('#clsd-msg').html(elem.find('#clsd-msg').html().replace("&lt;br&gt;","<br>"))
        setCkEditor(elem.find('#clsd-msg'),theme_data["closed_message"])
        
        if (theme_data["closed_message"] == undefined){
            set_default_closed_message()
        }

        if (plan != 'free') {
            set_textbox_reserve_message_val(elem.find('#reserve-msg'), theme_data["reserve_message"]);
            elem.find('#reserve-msg').html(elem.find('#reserve-msg').html().replace("&lt;br&gt;", "<br>"));
            setCkEditor(elem.find('#reserve-msg'), theme_data["reserve_message"]);
            if (theme_data["reserve_message"] == undefined) {
                set_default_reserve_message();
            }
        }
        
        set_checked(elem.find('input[name=show_back_btn]'), theme_data["show_back_btn"], enquete_option_def["shw_back_btn"]);
        set_checked(elem.find('input[name=show_abort_btn]'), theme_data["show_abort_btn"], enquete_option_def["show_abort_btn"]);

        if (theme_data["mark"] != undefined) {
            elem.find('select[name=mark]').val(theme_data["mark"]);
        }
        set_radio(elem.find('input[id='+theme_data["show_progress_bar"]+']'),elem.find('input[id=number]'));
        set_checked(elem.find('input[name=header_show]'), theme_data["header_show"], enquete_option_def["header_show"]);
        set_checked(elem.find('input[name=ad_show]'), theme_data["ad_show"], enquete_option_def["ad_show"]);

        display_logo_delete();
    }

    // カラーテーマJS
    $("#langdemo").spectrum({
      flat: false,
      showInput: true,
      showPalette: true,
      palette: [
            ["rgb(0, 0, 0)", "rgb(67, 67, 67)", "rgb(102, 102, 102)", /*"rgb(153, 153, 153)","rgb(183, 183, 183)",*/
            "rgb(204, 204, 204)", "rgb(217, 217, 217)", /*"rgb(239, 239, 239)", "rgb(243, 243, 243)",*/ "rgb(255, 255, 255)"],
            ["rgb(152, 0, 0)", "rgb(255, 0, 0)", "rgb(255, 153, 0)", "rgb(255, 255, 0)", "rgb(0, 255, 0)",
            "rgb(0, 255, 255)", "rgb(74, 134, 232)", "rgb(0, 0, 255)", "rgb(153, 0, 255)", "rgb(255, 0, 255)"],
            ["rgb(230, 184, 175)", "rgb(244, 204, 204)", "rgb(252, 229, 205)", "rgb(255, 242, 204)", "rgb(217, 234, 211)",
            "rgb(208, 224, 227)", "rgb(201, 218, 248)", "rgb(207, 226, 243)", "rgb(217, 210, 233)", "rgb(234, 209, 220)",
            "rgb(221, 126, 107)", "rgb(234, 153, 153)", "rgb(249, 203, 156)", "rgb(255, 229, 153)", "rgb(182, 215, 168)",
            "rgb(162, 196, 201)", "rgb(164, 194, 244)", "rgb(159, 197, 232)", "rgb(180, 167, 214)", "rgb(213, 166, 189)",
            "rgb(204, 65, 37)", "rgb(224, 102, 102)", "rgb(246, 178, 107)", "rgb(255, 217, 102)", "rgb(147, 196, 125)",
            "rgb(118, 165, 175)", "rgb(109, 158, 235)", "rgb(111, 168, 220)", "rgb(142, 124, 195)", "rgb(194, 123, 160)",
            "rgb(166, 28, 0)", "rgb(204, 0, 0)", "rgb(230, 145, 56)", "rgb(241, 194, 50)", "rgb(106, 168, 79)",
            "rgb(69, 129, 142)", "rgb(60, 120, 216)", "rgb(61, 133, 198)", "rgb(103, 78, 167)", "rgb(166, 77, 121)",
            /*"rgb(133, 32, 12)", "rgb(153, 0, 0)", "rgb(180, 95, 6)", "rgb(191, 144, 0)", "rgb(56, 118, 29)",
            "rgb(19, 79, 92)", "rgb(17, 85, 204)", "rgb(11, 83, 148)", "rgb(53, 28, 117)", "rgb(116, 27, 71)",*/
            "rgb(91, 15, 0)", "rgb(102, 0, 0)", "rgb(120, 63, 4)", "rgb(127, 96, 0)", "rgb(39, 78, 19)",
            "rgb(12, 52, 61)", "rgb(28, 69, 135)", "rgb(7, 55, 99)", "rgb(32, 18, 77)", "rgb(76, 17, 48)"]
        ]
    });

    // 現在の設定を取得
    function get_current_theme(){
        var el = $(".optionDialog");
        var enquete_options = {
            "logo": el.find(".upload-logo-img-box").attr("data_url"),
            "language" : el.find('select[name=language]').val(),
            "font" : el.find('select[name=font]').val(),
            "set_qnum" : el.find('input[name=qnum]').prop("checked"),
            "set_cnum" : el.find('input[name=cnum]').prop("checked"),
            "back_text" : el.find('.backText').val(),
            "next_text" : el.find('.nextText').val(),
            "send_text" : el.find('.sendText').val(),
            "abort_text" : el.find('.abortText').val(),
            "start_text" : el.find('.startText').val(),
            "show_back_btn" : el.find('input[name=show_back_btn]').prop("checked"),
            "show_abort_btn" : el.find('input[name=show_abort_btn]').prop("checked"),
            "mark" : el.find("select[name=mark]").val(),
            "show_progress_bar" : el.find('input[name=show_progress_bar]:checked').val(),
            "header_show" : el.find('input[name=header_show]').prop("checked"),
            "ad_show" : el.find('input[name=ad_show]').prop("checked"),
            "closed_message":CKEDITOR.instances['clsd-msg'].getData(),
        };
        
        if(enquete_options["closed_message"].indexOf('<br />') >-1){
            enquete_options["closed_message"]=enquete_options["closed_message"].replace("<br />","<br>");
        }

        if (plan != 'free') {
            enquete_options["reserve_message"] = CKEDITOR.instances['reserve-msg'].getData();
            if (enquete_options["reserve_message"].indexOf('<br />') > -1) {
                enquete_options["reserve_message"] = enquete_options["reserve_message"].replace("<br />", "<br>");
            }
        }
        
        if(enquete_options["logo"] == undefined){
            enquete_options["logo"] = "";
        }
        return enquete_options;
    }

    $(".optionDialog").find(".remove_logo").click(function(){
        var el = $(this).parents(".optionDialog");
        el.find(".upload-logo-img-box").val("");
        el.find(".upload-logo-img-box").attr("data_url","");
        display_logo_delete();
    });

    // 「デフォルトに戻す」クリック時
    $(".optionDialog").find(".opDefault").click(function(){
        var el = $(this).parents(".optionDialog");
        el.find(".upload-logo-img-box").val("");
        el.find(".upload-logo-img-box").attr("data_url","");
        el.find('select[name=language]').val(LANGUAGE_DEFAULT);
        el.find('select[name=font]').val(FONT_DEFAULT);
        set_checked(el.find('input[name=qnum]'), enquete_option_def["set_qnum"], true);
        set_checked(el.find('input[name=cnum]'), enquete_option_def["set_cnum"], false);
        set_textbox(el.find('.backText'), enquete_option_def["back_text"]);
        set_textbox(el.find('.nextText'), enquete_option_def["next_text"]);
        set_textbox(el.find('.sendText'), enquete_option_def["send_text"]);
        set_textbox(el.find('.startText'), enquete_option_def["start_text"]);
        set_textbox(el.find('.abortText'), enquete_option_def["abort_text"]);
        set_textbox_val(el.find("#clsd-msg"), enquete_option_def["closed_message"]);
        //　タグがエスケープされないように調整
        el.find('#clsd-msg').html('<p>'+el.find('#clsd-msg').html()+'</p><p>'+CLOSED_TEXT2);
        setCkEditor(el.find('#clsd-msg'),enquete_option_def["closed_message"])
        set_default_closed_message()

        if (plan != 'free') {
            set_textbox_reserve_message_val(el.find("#reserve-msg"), enquete_option_def["reserve_message"]);
            setCkEditor(el.find('#reserve-msg'), enquete_option_def["reserve_message"]);
            set_default_reserve_message();
        }

        set_checked(el.find('input[name=show_back_btn]'), enquete_option_def["shw_back_btn"], false);
        set_checked(el.find('input[name=show_abort_btn]'), enquete_option_def["show_abort_btn"], false);
        el.find('select[name=mark]').val(enquete_option_def["mark"]);
        set_radio(elem.find('input[id='+enquete_option_def["show_progress_bar"]+']'),elem.find('input[id=number]'));
        set_checked(el.find('input[name=header_show]'), enquete_option_def["header_show"], false);
        set_checked(el.find('input[name=ad_show]'), enquete_option_def["ad_show"], false);
        display_logo_delete();
    });

    // お気に入りに設定を保存
    var mytheme_list = {}
    set_mytheme_list();

    function set_mytheme_list(){
        $.ajax({
            "url": "/enquete/mytheme/api/get_mytheme",
            "type": "POST",
            "dataType": "JSON",
            "success": function(data){
                if(data.length != 0){
                    $(".optionDialog").find(".mytheme_list ul").html("");
                    for(var i=0; i< data.length; i++){
                        var html = '<li><a class="delete_theme" href="javascript:void(0);" value="'+ data[i]["id"] +'"></a><a href="javascript:void(0);" class="set_theme" value="'+ data[i]["id"] +'">'+ data[i]["name"] +'</a></li>'
                        $(".optionDialog").find(".mytheme_list ul").append(html)
                        mytheme_list[data[i]["id"]] = data[i]["theme"]
                    }

                    $(".optionDialog").find(".set_theme").click(function(){
                        var theme_id = $(this).attr("value");
                        var theme_data = JSON.parse(mytheme_list[theme_id]);
                        set_theme_to_form(theme_data);
                        $(".optionDialog").find(".mytheme_popup_menu").unbind('outerClick');
                        $(".optionDialog").find(".mytheme_popup_menu").hide("slide", {direction: "up"}, "fast");
                    });

                    $(".optionDialog").find(".delete_theme").click(function(){
                        var theme_id = $(this).attr("value");
                        //$(".optionDialog").find(".mytheme_popup_menu").hide();
                        utils.messageBox(MESSAGE_DELETE_MYTHEME, function() {
                            delete_mytheme_list(theme_id);
                        });
                    });
                }
            }
        });
    }

    function delete_mytheme_list(theme_id){
        $.ajax({
            "url": "/mypage/enquete_design/api/update_enquete_design/",
            "type": "DELETE",
            "dataType": "JSON",            
            "data": JSON.stringify({'mytheme_id' : theme_id}),
            "success": function(){
                $(".delete_theme[value='"+theme_id+"']").parent("li").slideUp('fast', function() {
                    $(".delete_theme[value='"+theme_id+"']").parent("li").remove();

                    var p = $(".optionDialog").find(".mytheme_popup_menu");
                    p.show("slide", {direction: "up"}, "fast", function(){
                        p.bind('outerClick', function(event){
                            p.unbind('outerClick');
                            p.hide("slide", {direction: "up"}, "fast");
                        });
                    });
                });
            },
            "error": function() {
                utils.showSaveErrorRetry();
            }
        });
    }
    
    // 「保存」クリック時
    $(".optionDialog").find(".opSave").click(function(e){
        var el = $(".optionDialog");
        var close_ok = true;

        var error_target = ["backText","nextText","sendText","abortText","startText"]
        for(var i=0; i< error_target.length;i++){
            if(el.find('.'+error_target[i]).val() == ""){
                el.find('.'+error_target[i]).css("border-color","rgb(209,34,34)");
                close_ok = false;
            }else if(el.find('.'+error_target[i]).val().length > 100){
                el.find('.'+error_target[i]).css("border-color","rgb(209,34,34)");
                el.find('.'+error_target[i]).parent().parent().children(".textover").css("display","inline-block");
                close_ok = false;
            }else if(chk_utf8_out_of_code(el.find('.'+error_target[i]).val())){
                el.find('.'+error_target[i]).css("border-color","rgb(209,34,34)");
                el.find('.'+error_target[i]).parent().parent().children(".utf8_out_of_code").css("display","inline-block");
                close_ok = false;
            }else {
                el.find('.'+error_target[i]).parent().parent().children(".error").css("display","none");
                el.find('.'+error_target[i]).css("border-color","#ccc");
            }
        }

        elem.find('#clsd-msg').css("border-color", "rgb(204,204,204)");
        elem.find('#clsd-msg').parent().find('.textover').css("display", "none");
        if(elem.find('#clsd-msg').html().length > 5000) {
            elem.find('#clsd-msg').css("border-color", "rgb(209,34,34)");
            elem.find('#clsd-msg').parent().find('.textover').css("display", "block");
            close_ok = false;
        }

        if (plan != 'free') {
            elem.find('#reserve-msg').css("border-color", "rgb(204,204,204)");
            elem.find('#reserve-msg').parent().find('.textover').css("display", "none");
            if (elem.find('#reserve-msg').html().length > 5000) {
                elem.find('#reserve-msg').css("border-color", "rgb(209,34,34)");
                elem.find('#reserve-msg').parent().find('.textover').css("display", "block");
                close_ok = false;
            }
        }
        
        if(theme_edit && $(e.target).hasClass("cancel") == false){
            attrs = {
                name: t_model.get("name"),
                theme: get_current_theme()
            };

            if(close_ok){
                if(mtListView != undefined){
                    utils.saveBackboneModel(t_model, attrs, function(model, response, options) {
                        mtListView.collection.add(model);
                        mtListView.render();
                    }, function(model, error, options) {
                        // badrequest:
                        /*$('.mailtemplate-error').hide();
                        var errors = error.responseText.split(',');
                        _.each(errors, function(e) {
                            $('#mailtemplate-error-' + e).show();
                        });*/
                    });
                } else {
                    forcedSave(t_model, {"theme": attrs["theme"]})
                }
            }
        }

        if(close_ok){
            var font_family = $('[name=font] option:selected').text().replace(/ /g, '');
            if(font_family == FONT_UNSELECTED) {
                $('.font-editable').css('font-family', '');
                selected_font_family = '';
            } else {
                $('.font-editable').css('font-family', font_family);
                selected_font_family = font_family;
            }

            if(theme_edit == false) {
                var cur_options = get_current_theme();
                if("mark" in cur_options){
                    $(".questionTitle").find("span.required").html(cur_options["mark"]);
                    $("em.required").html(cur_options["mark"]);
                    $(".questionTitle").next('.textbox-table').find("span.required").html(cur_options["mark"]);
                    $(".questionTitle").next('.uiTextbox').find(".uiTextboxSum").find("span.required").html(cur_options["mark"]);
                }
                if("set_qnum" in cur_options){
                    if(cur_options["set_qnum"]){
                        $(".questionTitle").find(".headNumber").show();
                    } else {
                        $(".questionTitle").find(".headNumber").hide();
                    }
                }
                var options= t_model.get("options")
                for(var key in cur_options){
                    options[key] = cur_options[key];
                }
                forcedSave(t_model, {"options": options})
                if(options['start_text'] && options['agreement']){
                    if(options['agreement']['required'] && options['start_text'].trim()){
                        $('.agreement-okl a').html(options['start_text'])
                    }
                }
                if (options['set_cnum']) {
                    $('.choice_index').show();
                } else {
                    $('.choice_index:not(.rank_choice_index)').hide();
                }

            }
            $(".optionDialog").fadeOut();
            utils.unsetGrayout();            
            // $('.overlay .background').fadeOut();
            if (typeof sidebar !== "undefined") {
                sidebar.checkPanelError();
            }
        }
    });

    // お気に入り設定ダイアログ開く
    $(".optionDialog").find(".star").click(function(){
        var p = $(".optionDialog").find(".add_mytheme_view");
        p.show("slide", {direction: "up"}, "fast", function(){
            p.bind('outerClick', function(event){
                p.unbind('outerClick');
                p.find(".add-myTheme-no").unbind('click');
                p.find(".add-myTheme-yes").unbind('click');
                p.hide("slide", {direction: "up"}, "fast");
            });
            p.find(".add-myTheme-no").click(function(){
                p.unbind('outerClick');
                p.find(".add-myTheme-no").unbind('click');
                p.find(".add-myTheme-yes").unbind('click');
                p.hide("slide", {direction: "up"}, "fast");
            });
            p.find(".add-myTheme-yes").click(function(){
                var qName = $(".optionDialog").find('.textarea-add-theme').val();
                if(qName != ""){
                    var MyThemeModel = Backbone.Model.extend({
                        url: '/enquete/mytheme/api/save_mytheme',
                        initialize: function (attrs, options) {}
                    });

                    var post_data = get_current_theme();
                    post_data["name"] = qName;

                    var mythemeModel = new MyThemeModel();
                    utils.saveBackboneModel(mythemeModel, post_data, function(){
                        set_mytheme_list();
                        $(".optionDialog").find(".add_mytheme_view").hide("slide", {direction: "up"}, "fast");
                        $(".optionDialog").find('.textarea-add-theme').val("");
                    });
                    p.unbind('outerClick');
                    p.find(".add-myTheme-no").unbind('click');
                    p.find(".add-myTheme-yes").unbind('click');
                }
            });
        });
    });

    $(".optionDialog").find(".pen").click(function(){
        var p = $(".optionDialog").find(".mytheme_popup_menu");
        p.show("slide", {direction: "up"}, "fast", function(){
            p.bind('outerClick', function(event){
                p.unbind('outerClick');
                p.hide("slide", {direction: "up"}, "fast");
            });
        });
    });
    
    if(mtListView != undefined){
        $('.ui210IconBtn.star').parents(".ui210IconBtnWrap").hide();
    }
    if(plan == "free"){
        if(theme_edit && mtListView != undefined){
            $(".optionDialog").find(".opSave").addClass("cancel")
        }
    }

    function display_logo_delete(){
        if($(".optionDialog").find(".upload-logo-img-box").attr("data_url") == "" || $(".optionDialog").find(".upload-logo-img-box").attr("data_url") == undefined){
            $(".optionDialog").find('.remove_logo').hide();
        } else {
            $(".optionDialog").find('.remove_logo').show();
        }
    }
}


image_dialog_callback: null
image_enpoint: ''

function initImageDialog() {
    image_enpoint = $('#image-dialog').data('endpoint');
}

function updateImageDialog(img_elem) {
    $.ajax({
        url: '/enquete/api/get_images',
        type: 'GET',
        timeout: 10000,
        dataType: "json"
    }).done(function(data, status, xhr) {
        img_elem.html('');
        _.each(data['images'], function(img) {
            url = image_enpoint + img;
            p = img.indexOf('_')
            disp_name = img.substr(p + 1);
            var elem = _.template($('#img_data').html(), {"url": url, "name": disp_name});
            img_elem.append(elem);
        });
        set_imgDialog_console(img_elem);

    }).fail(function(xhr, status, error) {
        utils.onAjaxError(xhr, function() {
            updateImageDialog(img_elem);
        }, null, null);
    });
}

function upload_image_callback(res, elem) {
    if (res.lastIndexOf('name:', 0) == 0) {
        str = res.substr('name:'.length);
        p = str.indexOf('_');
        disp_name = str.substr(p + 1)
        url = image_enpoint + str;
        var t = _.template($('#img_data').html(), {"url": url, "name": disp_name});
        var el = elem.prepend(t);
        set_imgDialog_console(el);

    } else {
        if (res.indexOf('ext') != -1) {
            $('#image-dialog-error-ext').show();
        } else if (res.indexOf('size') != -1) {
            $('#image-dialog-error-size').show();
        } else if (res.indexOf('name') != -1) {
            $('#image-dialog-error-name').show();
        } else {
            $('#image-dialog-error-unknown').show();
        }
    }
    $('.image-dialog-loading').hide();
}

function showImageDialog(callback, default_overlay, usable) {
    if(usable == undefined){
        usable = false;
        if(plan != 'free'){
            usable = true;
        }
    }

    $('.imgDialog').html(_.template($('#imgDialog').html(), {"usable": usable}));
    $('.imgDialog').find('.optionsPopup,.optionsPopup2').perfectScrollbar({wheelSpeed:PERFECT_SCROLLBAR_WHEEL_SPEED});

    utils.openDialog($('.imgDialog'), "#enqueteEdit", 120);
    /*$(".editOverlay .bg").fadeIn();
    $('.editOverlay .bg').css("z-index", "1100");
    $('.imgDialog').css("z-index", "1200");
    $('.imgDialog').fadeIn();*/
    updateImageDialog($('#image-dialog-upload-images'));

    if (default_overlay) {
        $('.imgDialog').find(".suggestUpgrade").hide();
    }
     $('.imgDialog').find('input[type=file]').click(function(){
        if ($('.image-dialog-loading').css('display') != 'none') {
            return false;
        }
    });
    $('.imgDialog').find('input[type=file]').change(function(){
    // $('#input_image_file_field').change(function(){
        $('.image-dialog-loading').show();
        $('.image-dialog-errors').hide();

        $('.imgDialog').upload('/enquete/api/upload_image', function(res) {
            upload_image_callback(res, $('#image-dialog-upload-images'));
        }, 'text');
    });

    $('.imgDialog').unbind('click');
    if(usable){
        $('.imgDialog').on('click', '.img_url', function() {
            src = $(this).attr('src')
            $('.imgDialog').fadeOut();
            utils.unsetGrayout();
            if (image_dialog_callback) {
                image_dialog_callback(src);
            }
        });
    }

    image_dialog_callback = callback;
    /* $(".editOverlay .bg").click(function(){
        $('.imgDialog').fadeOut();
        $(this).fadeOut();
    }); */

    $('.imgDialog').find('.cancel').click(function(){
        $('.imgDialog').fadeOut();
        utils.unsetGrayout();
    });
    setTimeout("$('.imgDialog').find('.optionsPopup,.optionsPopup2').perfectScrollbar('update');",1000);
}

function removeDialogImage(callback, elem) {
    var url = elem.parents('.thumbArea').find('img').attr('src')
    var imgName = {
        'name': url.substr(url.lastIndexOf('/') + 1)
    }
    $.ajax({
        "url": "/enquete/api/check_image",
        "type": 'POST',
        "data": imgName
    }).done(function(data, status, xhr) {
        if(data == "in_use") {
			utils.imageDeleteMessageBox(MESSAGE_DELETE_IMAGE_USED, function(){
            });
            /*utils.messageBox(MESSAGE_DELETE_IMAGE_CONFIRM, function(){
                $.ajax({
                    "url": "/enquete/api/delete_image",
                    "type": 'POST',
                    "data": imgName
                }).done(function(data, status, xhr) {
                    callback();
                }).fail(function(xhr, status, error) {
                });
            });*/
        } else {
            $.ajax({
                "url": "/enquete/api/delete_image",
                "type": 'POST',
                "data": imgName
            }).done(function(data, status, xhr) {
                callback();
            }).fail(function(xhr, status, error) {
            });
        }
    }).fail(function(xhr, status, error) {
    });
}

function getNameFromS3URL(image_url) {
    var name = image_url.substr(image_url.lastIndexOf('/')+1)
    name = name.substr(name.indexOf('_')+1);
    return name;
}


// JSON の中身を変えた場合に使用する
function forcedSave(model, attrs, silent) {
    utils.saveBackboneModel(model, attrs, function() {
        // model.trigger('change');
    }, null, null, true);
}

function save_model(model, attrs) {
    utils.saveBackboneModel(model, attrs, function() {
        // model.trigger('change');
    }, null, null);
}

// レイアウトの動的変更に伴いクエスチョンマークの位置修正が必要な場合に用いる関数
// 引数にはマクロに渡しているroot_selectorを指定。
function relocateQuestionMark(root_selector) {
    var position = $(root_selector + " .help-position")
    var top = $(position).position().top;
    var left = $(position).position().left;
    $(root_selector + " .help").css("top", top - 4 + "px");
    $(root_selector + " .help").css("left", left - 10 + "px");
}

function extractFirstLineText(text) {
    $tmp_elm = $('<div>').append(text);
    _.each($tmp_elm.children(), function(elm, index) {
        if (index != 0) $(elm).remove();
    });
    return $tmp_elm.html();
}

// サイドバーの下部が露出しないようにフッターサイズを調整する関数
function resizeFooter($footer) {
    var display_bottom = $('html').height();
    var footer_bottom = $footer.outerHeight() + $footer.offset().top;

    // フッター底部が画面底部より上にある場合、リサイズする。
    if(display_bottom > footer_bottom) {
        var padding_bottom = parseInt($footer.css('padding-bottom'), 10);
        var shortfall = display_bottom - footer_bottom;
        $footer.css('padding-bottom', padding_bottom + shortfall);
    }
}

// uuid 生成関数 (v4 すなわちランダム)
function uuid4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(
        /[xy]/g,
        function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 3 | 8);
            return v.toString(16);
        }
    );
};

var timeoutId = 0; //タイムアウトの破棄用
var scrollFrom = null; //呼び出し元記憶用

function scroll_preview(callFrom) {
    //呼び出し元をセットする
    if(scrollFrom === null) scrollFrom = callFrom;

    //呼び出し元が違うなら何もしない
    if(scrollFrom !== callFrom) return;

    //タイムアウトが設定されているなら破棄する
    if(timeoutId !== 0) clearTimeout(timeoutId);

    //タイムアウトを設定、timeoutと呼び出し元を初期化
    timeoutId = setTimeout(function(){
            timeoutId = 0;
            scrollFrom = null;
        }, 500);
    if (callFrom == 'answerPage') {
        var target1 = $("#answerPage");
        var target2 = $("#spPreviewBody");
    } else {
        var target1 = $("#spPreviewBody");
        var target2 = $("#answerPage");
    }

    // var sum = 0;
    // var question_idx = 0;
    // target1.find(".questionContent").each(function(index) {
    //     if ($(this).offset().top > 0) {
    //         return false;
    //     } else {
    //         sum = $(this).offset().top - target1.find("div:first-child").offset().top;
    //         question_idx += 1;
    //     }
    // });

    scrollRatio = target1.scrollTop() / (target1.get(0).scrollHeight - target1.height());
    target2.scrollTop((target2.get(0).scrollHeight - target2.height()) * scrollRatio);
}

function adjustImageSize(target, attrs) {
    /* 挿入画像の重なりを防ぐ */
    var qtype = attrs['qtype'];
    target.find('.addImgEditWrap:has(.addImgEdit)').each(function(){
        if (qtype.indexOf('scale') != -1) {
            var choice_num = attrs['choices'].length;
            if (!choice_num) return;

            var q_width = $(this).parents('.uiScale:first').width();
            var frame_size = parseInt(q_width / choice_num) - 10;
        } else {
            var frame = $(this).parents('td:first');
            if (frame.length != 1) frame = $(this).parents('th:first');
            if (frame.length != 1) frame = target;

            if (touch_mode || $(this).parents("#answerSPPreview").length > 0) {
                if (qtype == 'matrix-radio-vert' ||
                      qtype == 'matrix-checkbox-vert') {
                    var frame_size = frame.width();
                } else if ( ( qtype == 'matrix-radio-sp'
                            || qtype == 'matrix-radio'
                            || qtype == 'matrix-radio-bi'
                            || qtype == 'matrix-checkbox-sp'
                            || qtype == 'matrix-checkbox'
                            || qtype == 'matrix-checkbox-bi'
                          ) && $(this).parents("tr").hasClass("choices_repaint") ) {
                    var frame_size = frame.width();
                } else if (qtype.indexOf('matrix') != -1 ||
                      qtype.indexOf('ranking') != -1) {
                    var frame_size = frame.width() - 10;
                } else if (qtype.indexOf('radio') != -1 ||
                           qtype.indexOf('checkbox') != -1) {
                    var frame_size = frame.width() - 30;
                } else if (qtype == 'textbox-sum') {
                    var frame_size = frame.width() - 5;
                } else {
                    var frame_size = frame.width() - 60;
                }
            } else {
                if (qtype.indexOf('matrix') != -1 ||
                    qtype.indexOf('ranking') != -1) {
                    var frame_size = frame.width() - 20;
                } else {
                    var frame_size = frame.width() - 60;
                }
            }
        }
        $(this).css('max-width', '');
        var image_size = $(this).width();
        if (!frame_size || frame_size <= 0) return;
        if (!image_size || image_size <= 0) return;

        $(this).css('max-width', frame_size + 'px');
    });
}

function check_is_free_answer_blank($free_answer){
    if($free_answer == null || $free_answer.length == 0){
        return true;
    }else{
        return false;
    }
};

</script>

</body>
</html>
