<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gpush-gtoken.html</title>
</head>
<body>

<script>
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"; import { getMessaging, onMessage, getToken } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging.js"; var dMA = new Date(); var dMAm = dMA.getMonth() + 1; var lSvIgt = "gPushWebCheck" + dMAm + dMA.getFullYear(); const cookieUserGPGFT = document.cookie.split(";").reduce( (ac, cv, i) => Object.assign(ac, {[cv.split('=')[0]]: cv.split('=')[1]}), {}); const userAgentGPGFT = navigator.userAgent; (async function(window) { const ipUserGPGFT = await getUserIP(); if (window.Notification.permission === "denied") { console.log("Notificao nao permitida;"); } else { const firebaseConfig = { apiKey: "AIzaSyCAgkOqrANwE1UuKG_GiS1RY-JENJgBuHQ", authDomain: "testexpo-142d5.firebaseapp.com", projectId: "testexpo-142d5", storageBucket: "testexpo-142d5.appspot.com", messagingSenderId: "231918621312", appId: "1:231918621312:web:72fe9d2c2485aae9fc8c65", measurementId: "G-VK57RLWT1C" }; const app = initializeApp(firebaseConfig); const registerServiceWorker = async () => { try { const swOptions = { type: "classic", scope: "/", }; const sw = await window.navigator.serviceWorker.register(`/gpush-sw.js`, swOptions); return sw.update().then((registration) => { return registration; }).catch((error) => console.error("Nao e possivel atualizar o service worker", error)); } catch (error) { console.error("Nao e possivel registrar o prestador de serviÃ§o", error); } }; const requestPermission = async (messaging) => { try { const permission = await window.Notification.requestPermission(); if (permission === "granted") { const serviceWorkerRegistration = await registerServiceWorker(); return getToken(messaging, { serviceWorkerRegistration, vapidKey: "BPPA_c0MQysaUsKcuBofVexptiI7m3pFXhN2pGDV-gBD5EDgN--hdpdNNAijN_a4wSVxm-19u32C3pb5CBVt-YM", }).then((tokenWebPush) => { if ((tokenWebPush && tokenWebPush != window.localStorage.getItem("gpushTC")) || localStorage.getItem(lSvIgt) == null) { const siteConfig = window.location.origin; window.localStorage.setItem("gpushTC", tokenWebPush); sendTokenApiGpush(tokenWebPush, 'gpushgrumft', siteConfig, 'https://app.mediagrumft.com', ipUserGPGFT); } }).catch((err) => { console.error("Nao foi possivel obter o token FCM", err); }); } else { console.error("Nao foi possivel conceder permissao", permission); } } catch (error) { console.error("Nao foi possivel solicitar permissao", error); } }; const messaging = getMessaging(app); await requestPermission(messaging); const showNotification = (payload) => { const { data: { title, body, actionUrl, image, icon }, } = payload; const notificationOptions = { body, icon, image, data: { actionUrl, }, }; if(title !== 'undefined' && title) { const notification = new window.Notification(title, notificationOptions); notification.onclick = (event) => { event.preventDefault(); if(actionUrl !== 'undefined' && actionUrl) { window.open(actionUrl, "_blank").focus(); } }; } }; onMessage(messaging, (payload) => { showNotification(payload); }); } })(window); async function sendTokenApiGpush(tokenWebPush, topic, site, hostgpsuh, ipUser) { if(!cookieUserGPGFT){ cookieUserGPGFT = ''; } if(!ipUser){ ipUser = ''; } var data = { devicetoken: tokenWebPush, cookies: cookieUserGPGFT, ipUser: ipUser, userAgent: userAgentGPGFT, ativo: 1, site: site, topic: topic }; await fetch(hostgpsuh + '/api/v1/pushweb', { method: 'POST', headers: { Authorization: 'Bearer ' + site, 'Accept-encoding': 'multipart/form-data', 'Content-Type': 'application/json', }, body: JSON.stringify(data), }).then((response) => { if (!response.ok) { throw new Error("HTTP status " + response.status); } return response.json(); }).then((obj) => { if (obj['status'] === 'inserted') { localStorage.setItem(lSvIgt, true); } return; }); } async function getUserIP() { try { const response = await fetch('https://api.ipify.org?format=json'); const data = await response.json(); return data.ip; } catch (error) { return ''; } }
</script>

</body>
</html>
