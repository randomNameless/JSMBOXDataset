<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ReviewItem.1a62fc6f.html</title>
</head>
<body>
<script>import{R as w}from"./index.8365acb2.js";import{g as k}from"./index.f5993dad.js";import{c as C}from"./client.56225896.js";import{f as F}from"./fgm_account_userData_list.d42d333e.js";import{f as T}from"./fgm_content_comicData_list.733373f3.js";import{f as U}from"./fgm_marking_reviewData_list.7521c959.js";import{m as O}from"./marking_emotions.f1bb90d8.js";import{m as K}from"./marking_statuss.9d622f52.js";import{S as B}from"./ScoreStars.e56e12c1.js";import{U as L,V as Q}from"./UserGender.a1a2b5a6.js";import{M as E}from"./MarkdownDisplay.25bf213f.js";import{T as z}from"./TimeAgo.2237c5b8.js";import{C as A}from"./ComicCard_Stats.659fb23c.js";import{C as V}from"./ComicCard_Cover.c2be3f6b.js";import{C as P}from"./ComicCard_Title.d462ffd1.js";import{C as G}from"./ComicCard_Genres.6f7d84de.js";import{u as R}from"./ReactProviders.242c2151.js";import{j as e}from"./jsx-runtime.7d759e48.js";import{U as H}from"./UserAvatar.6eccc366.js";import{p as M,f as W,c as Y}from"./reavars.660bacce.js";import{u as S}from"./useMutation.bcca56b6.js";import{F as J}from"./FontIcon_Entypo.d5a1bd20.js";import{F as X}from"./FontIcon_AntDesign.4fef2788.js";import{F as Z}from"./FontIcon_Octicons.81468a48.js";import{R as ee}from"./RichEditor.5300c3c3.js";import{u as te}from"./useQuery.a4ed7007.js";async function se(n={},{with_userNode:t=!1,with_comicNode:s=!1}={}){let r=t?k`
  userNode {
    id
    data {
      ${F}
    }
  }
  `:"",l=s?k`
  comicNode {
    id
    data {
      ${T}
    }
  }
  `:"";const i=k`
  query get_marking_reviewNode($id: ID!) {
    get_marking_reviewNode(id: $id) {
      id
      data {
        ${U}
        ${r}
        ${l}
      }
      sser_vote_val
    }
  }
  `;return(await C().rawRequest(i,n)).data.get_marking_reviewNode}async function ne(n={},t=null){const s=k`
  mutation mut_marking_review_vote($id: ID!, $val: Int) {
    mut_marking_review_vote(id: $id, val: $val) {
      err
      int
    }
  }
  `;return(await C().rawRequest(s,n)).data.mut_marking_review_vote}function ae(n){const{sess:t,comicId:s,item:r,isEmbed:l}=n;if(s)return null;const i=r.data.comicNode;return i?.data?e.jsx("div",{className:"p-2 bg-base-200 rounded shadow shadow-base-200",children:e.jsxs("div",{className:"flex",children:[e.jsx(V,{sess:t,node:i,style:"small"}),e.jsxs("div",{className:"pl-3 grow flex flex-col space-y-1 overflow-hidden group",children:[e.jsx(P,{sess:t,node:i,style:"small"}),e.jsx(A,{sess:t,node:i}),e.jsx(G,{sess:t,node:i})]})]})}):null}async function re(n={},t=null){const s=k`
  mutation mut_marking_delete_review($reviewId: ID) {
    mut_marking_delete_review(reviewId: $reviewId) {
      err tof int
    }
  }
  `;return(await C().rawRequest(s,n)).data.mut_marking_delete_review}function ie(n){const{sess:t,reviewNode:s,deleMode:r,set_deleMode:l,rqKeys:i=[],onDone:x,onError:f}=n;return s.data,r?e.jsx(oe,{...n}):null}function oe(n){const{sess:t,reviewNode:s,deleMode:r,set_deleMode:l,rqKeys:i=[]}=n,{_sser:x,_wint:f}=t,d=s?.data,p=d?.id,o=d?.userId,m=d?.comicId,b=R(),[j,u]=w.useState(!1),_=S(re,{onSuccess:c=>{const v=[...i];if(p&&v.push(["marking_review_node",p]),m&&(!o||x.uid===o)&&v.push(["marking_review_node",`my_by_comicid_${m}`]),v?.length)for(const I of v)b.invalidateQueries(I);if(c.err){M({style:"error",content:"System error, try again please"}),u(!1);return}M({style:"success",content:"Review deleted!"}),u(!1),l(!1)},onError:c=>{u(!1),M({style:"error",content:"System error, try again please"})}});function h(){_.mutate({reviewId:d.id}),u(!0)}return e.jsx("div",{className:"flex justify-center items-center !m-0 absolute top-0 right-0 bottom-0 left-0 w-full h-full bg-black/90",children:e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{className:"btn btn-sm btn-error",onClick:h,children:[!!j&&e.jsx("span",{className:"loading loading-spinner loading-xs"}),"Delete"]}),e.jsx("button",{className:"btn btn-sm btn-ghost",onClick:()=>l(!r),children:"Cancel"})]})})}function ce(n){const{sess:t,item:s,deleMode:r,set_deleMode:l,editMode:i,set_editMode:x}=n,{_sser:f,_wint:d}=t,p=s.data,o=f.uid===p.userId;function m(){W({reviewNode:s})}return e.jsxs("div",{className:"dropdown dropdown-hover dropdown-left dropdown-end",children:[e.jsx("label",{tabIndex:"0",className:"btn btn-xs btn-square opacity-30 group-hover:opacity-100 hover:btn-accent",children:e.jsx(J,{name:"dots-two-horizontal",size:"1rem"})}),e.jsx("div",{tabIndex:"0",className:"dropdown-content flex flex-nowrap p-1 rounded-lg shadow bg-base-300 text-base-content",children:e.jsxs("div",{className:"flex flex-nowrap space-x-2",children:[(f.is_mod||o)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-xs btn-ghost normal-case",onClick:()=>x(!i),children:["edit",!o&&"[M]"]}),e.jsxs("button",{className:"btn btn-xs btn-ghost normal-case",onClick:()=>l(!r),children:["delete",!o&&"[M]"]})]}),e.jsx("a",{className:"btn btn-xs btn-ghost normal-case",href:p.urlPath,target:d.Common,children:"permalink"}),e.jsx("a",{className:"btn btn-xs btn-ghost normal-case",disabled:!f.is_verified||f.is_warned,onClick:m,children:"report"})]})})]})}async function le(n={},t=null){const s=k`
  mutation mut_marking_upsert_review($comicId: ID!, $content: String, $reviewId: ID) {
    mut_marking_upsert_review(comicId: $comicId, content: $content, reviewId: $reviewId) {
      err str
    }
  }
  `;return(await C().rawRequest(s,n)).data.mut_marking_upsert_review}function de(n){const{sess:t,comicId:s,innerText:r,reviewNode:l,onDone:i=()=>{},onCancel:x=()=>{},rqKeys:f=[]}=n,{_sser:d,_sets:p}=t,o=l?.data,m=o?.id,b=o?.userId,[j,u]=w.useState([]),[_,h]=w.useState(""),[c,v]=w.useState(!1),I=R();w.useEffect(()=>{h(r)},[r]);const D=S(le,{onSuccess:a=>{const N=[...f];if(m&&N.push(["marking_review_node",m]),s&&(!b||d.uid===b)&&N.push(["marking_review_node",`my_by_comicid_${s}`]),N?.length)for(const g of N)I.invalidateQueries(g);if(a.err){switch(a.err){case"login_required":{u([{state:"error",text:"You haven't logged in yet?"}]);break}case"bad_input":{u([{state:"error",text:"Bad request"}]);break}case"invalid_comic_id":{u([{state:"error",text:"Invalid comic id"}]);break}}v(!1);return}v(!1),i()},onError:a=>{v(!1),u([{state:"error",text:"System error, try again please"}])}});function q(a){h(a),u([])}function $(){D.mutate({comicId:s,content:_,reviewId:m}),u([]),v(!0)}function y(){x()}return e.jsxs("div",{className:"relative",children:[e.jsx(ee,{editorId:"my_review",innerText:r,messages:j,onChange:q,cancelTitle:e.jsx("span",{className:"normal-case opacity-60",children:"cancel"}),cancelClick:y,submitTitle:e.jsx("span",{children:"Save"}),submitClick:$,isLoading:c}),!!_&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h6",{className:"font-extrabold text-accent",children:"Preview"}),e.jsx("div",{className:"mt-1 py-3 w-full border-y-2 border-solid border-accent bg-accent/5",children:e.jsx(E,{maxHeight:"max-h-28",children:_})})]}),!d.uid&&e.jsx("div",{className:"absolute top-0 right-0 bottom-0 left-0 bg-neutral opacity-60 flex justify-center items-center",children:e.jsx("button",{className:"btn btn-outline btn-primary",onClick:()=>Y(!0),children:e.jsx(X,{name:"login",size:"1.5rem"})})}),d.is_verified===!1&&e.jsx("div",{className:"absolute top-0 right-0 bottom-0 left-0 bg-neutral opacity-60 flex justify-center items-center",children:e.jsx("a",{className:"btn btn-outline btn-warning",href:"/account/emails",children:e.jsx(Z,{name:"unverified",size:"1.5rem"})})})]})}function Ue(n){const{sess:t,gqlOpt:s={},rqOpt:r={},item:l,quickEditBtn:i=!1}=n,{_sser:x,_wint:f}=t,[d,p]=w.useState(!1),[o,m]=w.useState(!1),[b,j]=w.useState(!1),u=R(),_=l.id,h=["marking_review_node",_],{data:c,refetch:v}=te(h,()=>se({id:_},s),{initialData:l,staleTime:1/0,refetchOnWindowFocus:!1,refetchOnReconnect:"always"}),I=S(ne,{onSuccess:g=>{u.invalidateQueries(h),j(!1)}});function D(g){j(!0),I.mutate({id:_,val:g})}function q(){m(!o)}function $(){m(!o)}if(!c?.data)return null;const y=c.data.userNode.data,a=c.data,N=String(c?.data?.content?.code||"");return e.jsxs("div",{id:_,name:"review-item",className:"space-y-2 relative",children:[e.jsx(ae,{...n}),e.jsx("div",{className:"flex justify-between items-baseline",children:e.jsxs("div",{className:"flex",children:[e.jsx(H,{sess:t,userData:y,className:"rounded-full w-11 h-11"}),e.jsxs("div",{className:"ml-2 flex flex-col",children:[e.jsxs("div",{children:[e.jsx("a",{className:"link link-hover link-primary",href:y.urlPath,target:f.Common,children:y.name}),e.jsx(L,{val:y.gender})]}),e.jsxs("div",{className:"mt-1 flex items-baseline text-sm",children:[e.jsx(B,{score:a.score||0,textFace:"text-yellow-500"}),!!a.followed&&e.jsx("span",{className:"ml-2 opacity-60",children:"Following"}),!!a.status&&e.jsx("span",{className:"ml-2 opacity-60",children:K[a.status].text}),!!a.emotion&&e.jsx("span",{className:"ml-2 opacity-60",children:O[a.emotion].text})]})]})]})}),!!a.ctags?.length&&e.jsx("div",{className:"mt-2",children:a.ctags.map(g=>e.jsxs("a",{href:`/tag/${encodeURIComponent(g)}`,className:"mr-2 link link-primary link-hover",children:["#",g]},g))}),e.jsx("div",{className:"my-2",children:o?e.jsx(de,{sess:t,comicId:a.comicId,reviewNode:c,innerText:N,onCancel:q,onDone:$}):e.jsx(E,{maxHeight:"max-h-28",children:c?.data?.content?.code})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Q,{classNameOuter:"",classNameBtnUp:"hover:text-primary",classNameBtnDn:"hover:text-primary",classNameIcoUp:"text-primary",classNameIcoDn:"text-primary",id:`review_${_}`,count_vote_up:a.count_vote_up,count_vote_dn:a.count_vote_dn,count_vote_ab:a.count_vote_ab,sser_vote_val:c.sser_vote_val,is_loading:b,on_vote:D}),e.jsxs("div",{className:"flex justify-between items-center opacity-80 space-x-3",children:[e.jsx(z,{time:a.dateCreate,className:"text-sm"}),e.jsx(ce,{sess:t,item:c,deleMode:d,set_deleMode:p,editMode:o,set_editMode:m})]})]}),i&&!o&&e.jsx("button",{className:"btn btn-xs btn-block",onClick:()=>m(!o),children:"Edit My Review"}),e.jsx(ie,{sess:t,reviewNode:c,deleMode:d,set_deleMode:p})]})}export{Ue as R,de as a,se as g};</script>
</body>
</html>
