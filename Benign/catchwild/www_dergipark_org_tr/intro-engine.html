<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>intro-engine.html</title>
</head>
<body>

<script>
$(function () {
// body id tanımlanmayan sayfalarda interaktif rehber çalışmayacaktır.
    let bodyId = $('body').attr('id');
    if (bodyId !== null) {
        let allElementSelectorIds = [];

        /*
         body id sine göre ilgili gösterilecek mesajlar object elementi olarak tanımlanması gerekmektedir.
          Key element id'si, value ise gösterilecek metindir.
        */
        allElementSelectorIds["my-journals"] = {
            'my-journals-central-msg-1': 'interactive.guide.my.journals.central.first.desc',
            'my-journals-journal-roles': 'interactive.guide.my.journals.role.switch.desc',
            'my-journals-journal-panel': 'interactive.guide.my.journals.journal.panel.desc',
            'my-journals-journal-transactions': 'interactive.guide.my.journals.journal.transactions.desc',
        };

        allElementSelectorIds["user-panel"] = {
            'user-panel-central-msg-1': 'interactive.guide.user.panel.first.desc',
            'user-panel-journals': 'interactive.guide.user.panel.journals',
            'user-panel-process': 'interactive.guide.user.panel.process',
            'user-panel-profile': 'interactive.guide.user.panel.profile.operations',
            'user-panel-followers': 'interactive.guide.user.panel.follows',
            'user-panel-accounts': 'interactive.guide.user.panel.accounts',
            'user-panel-library': 'interactive.guide.user.panel.library',
        };

        allElementSelectorIds["my-articles"] = {
            'my-articles-central-msg-1': 'interactive.guide.my.articles.central.first.desc',
            'my-articles-btn-filter': 'interactive.guide.my.articles.btn.filter.desc',
            'my-articles-btn-action': 'interactive.guide.my.articles.btn.action.desc',
        };

        allElementSelectorIds["my-other-articles"] = {
            'my-other-articles-central-msg-1': 'interactive.guide.my.other.articles.central.first.desc',
            'my-other-articles-grid-filters': 'interactive.guide.my.other.articles.grid.filter.desc',
            'my-other-articles-central-msg-2': 'interactive.guide.my.other.articles.central.second.desc',
        };

        allElementSelectorIds["my-projects"] = {
            'my-projects-central-msg-1': 'interactive.guide.my.projects.central.first.desc',
            'my-projects-create-project': 'interactive.guide.my.projects.create.project.desc',
            'my-projects-btn-filter': 'interactive.guide.my.projects.btn.filter.desc',
            'my-projects-btn-action': 'interactive.guide.my.projects.btn.action.desc',
            'my-projects-project-guide': 'interactive.guide.my.projects.guide.view.desc',
        };

        allElementSelectorIds["my-projects-links-page"] = {
            'my-projects-links-page-central-msg-1': 'interactive.guide.my.projects.links.page.central.first.desc',
            'my-projects-links-page-extension-button': 'interactive.guide.my.projects.link.page.extension.desc',
            'my-projects-links-page-add-link': 'interactive.guide.my.projects.link.page.add.desc',
            'my-projects-links-page-grid-portlet-body': 'interactive.guide.my.projects.link.page.grid.desc',
            'my-projects-links-page-dp-articles': 'interactive.guide.my.projects.link.page.dp.articles.desc',
        };

        allElementSelectorIds["my-projects-dp-articles-page"] = {
            'my-projects-dp-articles-page-central-msg-1': 'interactive.guide.my.projects.dp.articles.page.central.first.desc',
            'my-projects-dp-articles-page-grid-portlet-body': 'interactive.guide.my.projects.dp.articles.page.grid.desc',
            'my-projects-dp-articles-text': 'interactive.guide.my.projects.dp.articles.page.guide.view.desc',
        };

        allElementSelectorIds["user-follower"] = {
            'user-follower-central-msg-1': 'interactive.guide.user.followers.central.first.desc',
            'user-follower-central-msg-2': 'interactive.guide.user.followers.second.desc',
            'user-follower-grid-portlet-body': 'interactive.guide.user.followers.grid.desc',
        };

        allElementSelectorIds["journal-follower"] = {
            'journal-follower-central-msg-1': 'interactive.guide.journal.followers.central.first.desc',
            'journal-follower-central-msg-2': 'interactive.guide.journal.followers.second.desc',
            'journal-follower-grid-portlet-body': 'interactive.guide.journal.followers.grid.desc',
        };

        allElementSelectorIds["connected-accounts"] = {
            'connected-accounts-central-msg-1': 'interactive.guide.connected.accounts.central.first.desc',
            'connected-accounts-orcid-button': 'interactive.guide.connected.accounts.btn.orcid.desc',
            'connected-accounts-edevlet-button': 'interactive.guide.connected.accounts.btn.edevlet.desc',
        };

        allElementSelectorIds["my-favorite-articles"] = {
            'my-favorite-articles-central-msg-1': 'interactive.guide.my.favorite.articles.central.first.desc',
            'my-favorite-articles-grid-portlet-body': 'interactive.guide.my.favorite.articles.grid.desc',
        };

        allElementSelectorIds["edit-my-profile"] = {
            'edit-my-profile-central-msg-1': 'interactive.guide.edit.my.profile.central.first.desc',
            'ojs_userbundle_updateuser_username': 'interactive.guide.edit.my.profile.username.desc',
            'edit-my-profile-user-badge': 'interactive.guide.edit.my.profile.badge.desc',
        };

        allElementSelectorIds["user-panel-process"] = {
            'user-panel-process-status': 'interactive.guide.user.panel.process.status.desc',
            'user-panel-process-filter': 'interactive.guide.user.panel.process.filter.desc',
            'user-panel-process-role-button': 'interactive.guide.user.panel.process.role.button.desc',
            'user-panel-process-download-button': 'interactive.guide.user.panel.process.download.button.desc',
        };

        allElementSelectorIds["user-merge-request"] = {
            'user-merge-request-central-msg-1': 'interactive.guide.user.merge.request.central.first.desc',
            'user_merge_passiveUser': 'interactive.guide.user.merge.request.email.input.desc',
            'user-merge-request-central-msg-2': 'interactive.guide.user.merge.request.central.second.desc'
        };

        allElementSelectorIds["issue_management"] = {
            'issue-management-central-msg-1': 'interactive.guide.issue.management.central.first.desc'
        };

        allElementSelectorIds["article_new"] = {
            'article-new-central-msg-1': 'interactive.guide.article.new.central.first.desc'
        };

        allElementSelectorIds["article_edit"] = {
            'article-edit-central-msg-1': 'interactive.guide.article.edit.central.first.desc'
        };

        allElementSelectorIds["issue_index"] = {
            'issue-index-central-msg-1': 'interactive.guide.issue.index.central.first.desc'
        };

        allElementSelectorIds["special_issue_new"] = {
            'special-issue-new-central-msg-1': 'interactive.guide.special.issue.new.central.first.desc'
        };

        if (allElementSelectorIds[bodyId] !== undefined) {

            /**
             * function return olarak db de kayıtlı mesajların ids dönmektedir. return olarak getInteractiveGuideData dönülmüştür.
             * @returns {null}
             */
            let handleSavedElements = function (elementData) {
                let elements = null;
                $.ajax({
                    url: Routing.generate('ojs_user_interactive_guide_sync'),
                    type: 'POST',
                    async: false,
                    global: false,
                    data: {data: elementData},
                    success: function (data) {
                        elements = data;
                    },
                });

                return elements;
            };

            function getAllElementIds() {
                let elements = Object.values(allElementSelectorIds);
                let ids = [];
                for (let i = 0; i < elements.length; i++) {
                    let dat = Object.keys(elements[i]);
                    for (let a = 0; a < dat.length; a++) {
                        ids.push(dat[a]);
                    }
                }

                return ids;
            }

            function removeElements(keys) {
                let status = null;
                $.ajax({
                    url: Routing.generate('ojs_user_interactive_guide_remove_element'),
                    type: 'POST',
                    async: false,
                    global: false,
                    data: {data: keys},
                    success: function () {
                        status = true;
                    },
                });

                return status;
            }

            let interactiveLclStorage = localStorage.getItem('dp_interactive_guide');
            // önceki okunmuş mesajlar db'ye yazılıyor...
            if (interactiveLclStorage) {
                let elements = JSON.parse(interactiveLclStorage);
                let elementValues = Object.values(elements);
                let ids = [];
                for (let i = 0; i < elementValues.length; i++) {
                    for (let a = 0; a < elementValues[i].length; a++) {
                        ids.push(elementValues[i][a]);
                    }
                }

                handleSavedElements(ids);
            }

            const readElements = handleSavedElements();
            let elementSelectorIds;
            let introJsTitle = null;

            elementSelectorIds = allElementSelectorIds[bodyId];
            let elementSelectorIdKeys = Object.keys(elementSelectorIds);
            // introjs config alanı
            if (elementSelectorIdKeys.length > 0) {

                if (bodyId === "user-panel") {
                    introJsTitle = Translator.trans('interactive.guide.user.panel.welcome');
                }

                const guideConfig = {
                    nextLabel: Translator.trans('interactive.guide.next.button'),
                    doneLabel: Translator.trans('interactive.guide.done.button'),
                    prevLabel: Translator.trans('interactive.guide.prev.button'),
                    exitOnOverlayClick: false,
                    scrollToElement: true,
                    exitOnEsc: false
                };

                // Turu Başlat Yönetimi
                $(".interactive-guide-container").removeClass('d-none');
                // Turu Başlat Yönetimi Sonu

                // Gösterimlerin yönetildiği alandır. Hiç gösterilmeyen veya sonradan eklenen - çıkarılan elementler buradan yönetilmektedir.
                let setOptionData = {steps: []};
                let counter = 1;
                let unReadElementIds = [];
                for (let elementId in elementSelectorIds) {
                    if (readElements.indexOf(elementId) === -1) {
                        unReadElementIds.push(elementId);
                        let introMsg = {
                            element: document.querySelector('#' + elementId),
                            intro: Translator.trans(elementSelectorIds[elementId]),
                        };
                        if (introJsTitle !== null && counter === 1) {
                            let introTitle = {
                                title: introJsTitle,
                            };
                            Object.assign(introMsg, introTitle);
                        }
                        setOptionData.steps.push(introMsg);
                    }
                    counter++;
                }

                // mobil görünümlerde grid panelin action bölümünü sağa kaydıran alan
                introJs().setOptions(Object.assign(setOptionData, guideConfig)).start();

                if ($('.introjs-nextbutton').length > 0) {
                    $('.introjs-nextbutton').on('click', function () {
                        if ($(".table-responsive").get(0) !== undefined) {
                            $('.table-responsive').scrollLeft($(".table-responsive").get(0).scrollWidth);
                            introJs().refresh();
                        }
                        if ($('.introjs-tooltip')[0] !== undefined) {
                            // sayfa yüklendikten sonra ilk balona gidiyor...
                            $('html,body').animate({
                                scrollTop: $('.introjs-tooltip')[0].scrollHeight - $('.introjs-tooltip')[0].clientHeight
                            }, 1000);
                        }
                    });
                }

                // sayfa yüklendikten sonra ilk balona gidiyor...

                if ($('.introjs-tooltip').length) {
                    $('html,body').animate({
                        scrollTop: $('.introjs-tooltip')[0].scrollHeight - $('.introjs-tooltip')[0].clientHeight
                    }, 1000);
                }

                // interaktif rehber tamamlanırken yapılan işlem alanı
                introJs.fn.oncomplete(function () {
                    handleSavedElements(unReadElementIds);
                });

                $(document).on('click', function () {
                    if ($('.introjs-donebutton').length > 0) {
                        $('.introjs-donebutton').on('click', function () {
                            $('.table-responsive').scrollLeft(0);
                        });
                    }

                });

                // X butonuna basıldığında tüm mesajlar okundu olarak işaretleniyor...
                $('.introjs-skipbutton').on('click', function () {
                    handleSavedElements(getAllElementIds());
                });

                // İlgili sayfada turu başlat'a tıklanınca id'leri temizler ve baştan gösterim sağlanır.
                $('#interactive-guide-tour-start').on('click', function () {
                    let status = removeElements(elementSelectorIdKeys);
                    if (status) {
                        // sayfa yüklendikten sonra ilk balona gidiyor...
                        $('html,body').animate({
                            scrollTop: 0
                        }, 1000);

                        location.reload();
                    }
                });
            }
        }
    }
});
</script>

</body>
</html>
