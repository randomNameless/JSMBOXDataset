<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ntCalendar.html</title>
</head>
<body>

<script>
/**
 * @TODO: Document.
 */
var ntCalendar = function ($container) {
  this.currentMonth = false;

  this.dom = {
    $container: $container,
  };

  this.init();
};

ntCalendar.getDateHash = function (month, day) {
  var months = [
    'jan',
    'feb',
    'mar',
    'apr',
    'may',
    'jun',
    'jul',
    'aug',
    'sep',
    'oct',
    'nov',
    'dec',
  ];

  return '#' + months[month] + '-' + day;
};

ntCalendar.parseMonthFromUrl = function (url) {
  var link;

  var months = {
    'january': 0,
    'february': 1,
    'march': 2,
    'april': 3,
    'may': 4,
    'june': 5,
    'july': 6,
    'august': 7,
    'september': 8,
    'october': 9,
    'november': 10,
    'december': 11,
  };

  if (url && url.pathname) {
    link = url.pathname.replace(/\//g, '').replace('-holidays', '');
    link = link.split('-');

    if (months[link[0]]) {
      return months[link[0]];
    }
  }

  return false;
};

ntCalendar.rewriteLinks = function (obj) {
  var months = {
    'january': 'jan',
    'february': 'feb',
    'march': 'mar',
    'april': 'apr',
    'may': 'may',
    'june': 'jun',
    'july': 'jul',
    'august': 'aug',
    'september': 'sep',
    'october': 'oct',
    'november': 'nov',
    'december': 'dec',
  };

  $(obj).find('.wp-calendar-table').find('a').each(function () {
    var link = new URL(this.href);

    if (link.pathname) {
      link = link.pathname.replace(/\//g, '')
          .replace('-holidays', '')
          .replace('-birthdays', '');
      link = link.split('-');

      if (months[link[0]]) {
        link[0] = months[link[0]];
      }

      link = link.join('-');
    }

    this.href = '#' + link;
  });
};

ntCalendar.prototype.bindEvents = function bindEvents () {
  if (this.currentMonth) {
    this.dom.$prevMonthBtn.on('click', this.updateCalendar.bind(
        this, this.getPrevMonth(this.currentMonth)));
    this.dom.$nextMonthBtn.on('click', this.updateCalendar.bind(
        this, this.getNextMonth(this.currentMonth)));
  }
};

ntCalendar.prototype.getMonthFromName = function getMonthFromName (monthName) {
  var months = {
    'january': 1,
    'february': 2,
    'march': 3,
    'april': 4,
    'may': 5,
    'june': 6,
    'july': 7,
    'august': 8,
    'september': 9,
    'october': 10,
    'november': 11,
    'december': 12,
  };

  if (monthName in months) {
    return months[monthName];
  } else {
    return false;
  }
};

ntCalendar.prototype.getNextMonth = function getNextMonth (monthNum) {
  var num = monthNum + 1;

  if (num > 12) {
    num = 1;
  }

  return num;
};

ntCalendar.prototype.getPrevMonth = function getPrevMonth (monthNum) {
  var num = monthNum - 1;

  if (num < 1) {
    num = 12;
  }

  return num;
};

ntCalendar.prototype.init = function init () {
  this.setDom();

  let monthName = this.dom.$title.html()
    .toLowerCase()
    .replace('holidays', '')
    .replace('birthdays', '')
    .trim();
  this.setCurrentMonth(this.getMonthFromName(monthName));
  this.bindEvents();
};

ntCalendar.prototype.setDom = function setDom () {
  this.dom.$title = this.dom.$container.find('.calendar-title');
  this.dom.$nextMonthBtn = this.dom.$container.find('.wp-calendar-nav-next');
  this.dom.$prevMonthBtn = this.dom.$container.find('.wp-calendar-nav-prev');
};

ntCalendar.prototype.setCurrentMonth = function setCurrentMonth (monthNum) {
  this.currentMonth = monthNum;
};

ntCalendar.prototype.updateCalendar = function updateCalendar (monthNum) {
  var that = this;

  this.dom.$container.append('<div class="calendar-loading"></div>');

  $.ajax({
    type: 'post',
    dataType: 'json',
    url : ntWpData.ajaxUrl,
    data: {
      action: 'nt_get_calendar',
      month: monthNum,
    },
    success: function (response) {
      if (response.type === 'success') {
        that.dom.$container.html(response.data);
        that.init();
      }
    },
  });

  return false;
};

</script>

</body>
</html>
