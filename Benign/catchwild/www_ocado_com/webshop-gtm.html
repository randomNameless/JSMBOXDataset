<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>webshop-gtm.html</title>
</head>
<body>

<script>
webshop=window.webshop||{};webshop.common=webshop.common||{};webshop.common.ServerLogger=webshop.common.ServerLogger||{log:function(logMessage,logLevel){jQ.ajax({url:'/webshop/ajaxCreateLogMessage.go',type:'POST',data:{jsLogMessage:logMessage,jsLogLevel:logLevel||'INFO'}});},trace:function(logMessage){this.log(logMessage,'TRACE');},debug:function(logMessage){this.log(logMessage,'DEBUG');},info:function(logMessage){this.log(logMessage,'INFO');},warn:function(logMessage){this.log(logMessage,'WARN');},error:function(logMessage){this.log(logMessage,'ERROR');},};webshop=window.webshop||{};webshop.common=webshop.common||{};webshop.common.JsonSizeEstimator=webshop.common.JsonSizeEstimator||{estimateSize:function(dataObj){function getUtf8BytesNum(str){var bytesNum=0;for(var i=0;i<str.length;i++){var charCode=str.charCodeAt(i);if(charCode<=0x007F){bytesNum+=1;}else if(charCode<=0x07FF){bytesNum+=2;}else{bytesNum+=3;}}
return bytesNum;}
return getUtf8BytesNum(JSON.stringify(dataObj));},};ocBackbone=window.ocBackbone||{};ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.GTMEventSender=(function(Backbone,webshop){'use strict';return Backbone.Marionette.Object.extend({acceptedEvents:{'gtm:uaEvent':'sendUniversalAnalyticsEvent','gtm:checkout':'sendCheckoutEvent','gtm:firstCheckout':'sendFirstCheckoutEvent','gtm:registration':'sendRegistrationEvent','gtm:registrationType':'sendRegistrationTypeEvent','gtm:login':'sendLoginEvent','gtm:loginType':'sendLoginTypeEvent','gtm:secondCheckoutWithinFourWeeksEvent':'sendSecondCheckoutWithinFourWeeksEvent','gtm:orderPurchased':'sendOrderPurchasedEvent','gtm:orderCancelled':'sendOrderCancelledEvent','gtm:virtualPageView':'sendVirtualPageViewEvent','gtm:FacebookLiked':'sendFacebookLikeEvent','gtm:FacebookUnliked':'sendFacebookUnlikeEvent','gtm:PinnedIt':'sendPinnedItEvent','gtm:checkoutWalk':'sendCheckoutWalkEvent','gtm:basketChangedEvent':'sendBasketChangedEvent','gtm:basketAddEvent':'sendAddToBasketEvent','gtm:trolleyEvent':'sendTrolleyEvent','gtm:productDetails':'sendProductDetailsEvent','gtm:productImpressions':'sendProductImpressions','gtm:productClick':'sendProductClickEvent','gtm:promotionImpressions':'sendPromotionImpressions','gtm:promotionClick':'sendPromotionClickEvent','gtm:oosRatio':'sendOosRatioEvent','gtm:orderStatus':'sendOrderStatus','gtm:editOrder':'sendEditOrder','gtm:deliveryUpdate':'sendDeliveryUpdate','gtm:recipeFinder':'sendRecipeFinderEvent','gtm:smartPassSignup':'sendSmartPassSignupEvent','gtm:navigationEvent':'sendNavigationInteractionEvent','gtm:pageView':'sendPageViewEvent',},sendUniversalAnalyticsEvent:function(eventData){var uaEvent={event:'UAEvent',uaEventCategory:eventData.category,uaEventAction:eventData.action,uaEventLabel:eventData.label,uaEventValue:eventData.value};sendGTMEvent.call(this,uaEvent);},sendCheckoutEvent:function(eventData){var event={event:'Checkout',uaEventCategory:eventData.category,uaEventAction:eventData.action,uaEventLabel:eventData.label};sendGTMEvent.call(this,event);},sendFirstCheckoutEvent:function(eventData){var event={event:'FirstCheckout',uaEventCategory:eventData.category,uaEventAction:eventData.action,uaEventLabel:eventData.label};sendGTMEvent.call(this,event);},sendSecondCheckoutWithinFourWeeksEvent:function(eventData){var event={event:'SecondCheckoutWithinFourWeeks',uaEventCategory:eventData.category,uaEventAction:eventData.action,uaEventLabel:eventData.label};sendGTMEvent.call(this,event);},sendRegistrationEvent:function(source,client,type){var event={event:'Registration',userId:webshop.info.CI,method:type,hashedEmail:webshop.info.CET,uaEventCategory:'Registration',uaEventAction:source,uaEventLabel:client};sendGTMEvent.call(this,event);},sendRegistrationTypeEvent:function(source,type){var event={event:'RegistrationType',uaEventCategory:'RegistrationType',uaEventAction:source,uaEventLabel:type};sendGTMEvent.call(this,event);},sendLoginEvent:function(source,client,type){var event={event:'Login',userId:webshop.info.CI,method:type,hashedEmail:webshop.info.CET,uaEventCategory:'Login',uaEventAction:source,uaEventLabel:client};sendGTMEvent.call(this,event);},sendLoginTypeEvent:function(source,type){var event={event:'LoginType',uaEventCategory:'LoginType',uaEventAction:source,uaEventLabel:type};sendGTMEvent.call(this,event);},sendOrderPurchasedEvent:function(purchasedOrderDTO){if(purchasedOrderDTO.products.length>getProductListSizeLimit()){var purchasedEvents=createChunkedPurchasedOrderEvents(purchasedOrderDTO,_.identity,getProductListSizeLimit(),'orderPurchased');_.each(purchasedEvents,function(event){sendGTMEvent.call(this,event);});}else{var purchasedEvent=createPurchasedOrderEvent(purchasedOrderDTO,_.identity,'orderPurchased');sendGTMEvent.call(this,purchasedEvent);}},sendOrderCancelledEvent:function(cancelledOrderDTO,address,slot){function revert(x){return-x;}
if(cancelledOrderDTO.products.length>getProductListSizeLimit()){var purchasedCancelledEvents=createChunkedPurchasedOrderEvents(cancelledOrderDTO,revert,getProductListSizeLimit(),'orderCancelled');_.each(purchasedCancelledEvents,function(event){sendGTMEvent.call(this,event);});}else{var purchasedCancelledEvent=createPurchasedOrderEvent(cancelledOrderDTO,revert,'orderCancelled',address,slot);sendGTMEvent.call(this,purchasedCancelledEvent);}},sendOrderStatus:function(eventData){var orderStatusEvent={'event':'OrderStatus','uaEventCategory':'PageComponent','uaEventAction':'OrderStatusDisplayed','uaEventLabel':eventData};sendGTMEvent.call(this,orderStatusEvent);},sendEditOrder:function(eventData){var editOrderEvent={event:"order_update",...eventData};sendGTMEvent.call(this,editOrderEvent);},sendDeliveryUpdate:function(eventData){var deliveryUpdateEvent={event:"order_update",updateType:"Update delivery slot",...eventData};sendGTMEvent.call(this,deliveryUpdateEvent);},sendRecipeFinderEvent:function(eventData){var recipeFinderEvent={event:"recipeFinder",...eventData};sendGTMEvent.call(this,recipeFinderEvent);},sendSmartPassSignupEvent:function(eventData){var smartPassSignupEvent={event:"smart_pass_signup",userId:webshop.info.CI,smartPassSignupDate:new Date().toISOString().substr(0,10),...eventData};sendGTMEvent.call(this,smartPassSignupEvent);},sendNavigationInteractionEvent:function(eventData){var navigationInteractionEvent={event:"navigation_interaction",...eventData};sendGTMEvent.call(this,navigationInteractionEvent);},sendPageViewEvent:function(eventData){var pageViewEvent={event:"pageview",...eventData};sendGTMEvent.call(this,pageViewEvent);},sendCheckoutWalkEvent:function(eventData){var checkoutEvent={'event':'checkoutEventFired','slotVanTypeDimension':eventData.vanType,'slotBookedTimeDimension':eventData.bookedTime,'timeAheadToDeliveryDimension':eventData.timeAheadToDeliveryInDays?eventData.timeAheadToDeliveryInDays.toString():undefined,'voucherCountDimension':eventData.vouchersCount,'isDiscountClubMember':eventData.isDiscountClubMember,'ecommerce':{currencyCode:'GBP','checkout':{'actionField':{'affiliation':''+Date.now(),'step':eventData.step,'option':eventData.option,'list':'Checkout walk'}}}};checkoutEvent.uaEventCategory='E-Commerce';checkoutEvent.uaEventAction='checkoutStep';checkoutEvent.uaEventLabel=eventData.step;if(eventData.products){this.sendGTMEventWithProducts(checkoutEvent,eventData.products);}else{sendGTMEvent.call(this,checkoutEvent);}},sendGTMEventWithProducts:function(checkoutEvent,products){var productListSizeLimit=getProductListSizeLimit();var length=products.length;var baseAffiliation=checkoutEvent.ecommerce.checkout.actionField.affiliation;if(length>productListSizeLimit){for(var i=0;i<length;i+=productListSizeLimit){checkoutEvent.ecommerce.checkout.products=mapProductsDTO(products.slice(i,i+productListSizeLimit));checkoutEvent.ecommerce.checkout.actionField.affiliation=baseAffiliation+'_'+(i/productListSizeLimit);checkoutEvent.uaEventValue=(i==0)?1:0;sendGTMEvent.call(this,checkoutEvent);}}else{checkoutEvent.ecommerce.checkout.products=mapProductsDTO(products);sendGTMEvent.call(this,checkoutEvent);}},sendBasketChangedEvent:function(basketValue,emptyBasket){var eventData={'event':'BasketChangedRule','BV':basketValue,'EB':emptyBasket};sendGTMEvent.call(this,eventData);},sendAddToBasketEvent:function(sku){var eventData={'event':'ProductAddToBasketRule','PID':sku};sendGTMEvent.call(this,eventData);},sendTrolleyEvent:function(action,products,sectionTitle,pageType,listName,size,basketValue,basket){var eventName=action=='add'?'addToTrolley':'removeFromTrolley';var ARRAY_MAX_LENGTH=size?size:30;_.each(_.chunk(products,ARRAY_MAX_LENGTH),function(products){var eventData={'event':eventName,'basketId':basket&&basket.get&&basket.get('basketId'),'basketValue':basketValue,'pageTypeDimension':pageType,'productSectionDimension':sectionTitle,'ecommerce':{'currencyCode':'GBP'}};const productListName=this._getGTMProductListName(pageType,sectionTitle);eventData.ecommerce[action]={'products':_.map(products,function(product,index){return webshop.common.jsVariables.get('gaMinProductUpdateTrolley')?{id:product.id,price:product.price,quantity:product.quantity}:{...product,list:productListName,}},this),'actionField':{'list':productListName}};eventData.uaEventCategory='E-Commerce';eventData.uaEventAction=eventName;eventData.uaEventLabel=pageType+'|'+sectionTitle;eventData.uaEventValue=products.length;sendGTMEvent.call(this,eventData);},this);},sendProductDetailsEvent:function(productDetailsDTO,pageType,productListName){var productDetailsEvent={event:'eecGeneric',pageTypeDimension:pageType,ecommerce:{detail:{actionField:{list:productListName},products:[webshop.common.jsVariables.get('gaMinProductDetails')?{id:productDetailsDTO.sku,price:productDetailsDTO.price}:{id:productDetailsDTO.sku,name:productDetailsDTO.name,brand:productDetailsDTO.brand,price:productDetailsDTO.price,category:productDetailsDTO.category}]}}};productDetailsEvent.uaEventCategory='E-Commerce';productDetailsEvent.uaEventAction='productDetails';productDetailsEvent.uaEventLabel=pageType+'|'+productListName;productDetailsEvent.uaEventValue=productDetailsEvent.ecommerce.detail.products.length;sendGTMEvent.call(this,productDetailsEvent);},_getFilterValues:function(){return jQ('.js-filters .filter-header').map(function(){var title=jQ('h3:first-child',this).text().trim();var values=jQ(this).next('ul').children('.filter-select.active').map(function(){return jQ(this).text().trim();}).get();return values.length?`${title}: ${values}`:undefined;}).get().join(' | ')||undefined;},_getNumberOfResults:function(){return jQ('.total-product-number').data('rawValue');},sendProductClickEvent:function(productClick,eventCallback){var product=productClick.product;const productListName=this._getGTMProductListName(productClick.pageType,productClick.sectionTitle,product.promotionNames);var eventData={event:'productClick',filterValues:this._getFilterValues(),numberOfResults:this._getNumberOfResults(),pageTypeDimension:productClick.pageType,productSectionDimension:productClick.sectionTitle,ecommerce:{click:{actionField:{list:productListName},products:[webshop.common.jsVariables.get('gaMinProductClick')?{id:product.sku,price:product.price,position:productClick.position}:{id:product.sku,name:product.name,brand:product.brand,category:product.category,price:product.price,position:productClick.position,dimension60:product.dimension60,promotionNames:product.promotionNames,dimension70:product.dimension70,canAddToBasket:product.canAddToBasket,isFavorite:product.isFavorite,isFeatured:product.isFeatured,isOnPromotion:product.isOnPromotion,promotionIds:product.promotionIds,list:productListName,}]}}};if(eventCallback){eventData.eventCallback=eventCallback;}
eventData.uaEventCategory='E-Commerce';eventData.uaEventAction='productClick';eventData.uaEventLabel=productClick.pageType+'|'+productClick.sectionTitle;eventData.uaEventValue=eventData.ecommerce.click.products.length;sendGTMEvent.call(this,eventData);},sendVirtualPageViewEvent:function(virtualPageURL){sendGTMEvent.call(this,{'event':'virtualPageView','virtualPageURL':virtualPageURL});},sendPinnedItEvent:function(targetUrl){sendGTMEvent.call(this,prepareSocialGTMEvent('Pinterest','Pin',targetUrl));},sendFacebookLikeEvent:function(targetUrl){sendGTMEvent.call(this,prepareSocialGTMEvent('Facebook','Like',targetUrl));},sendFacebookUnlikeEvent:function(targetUrl){sendGTMEvent.call(this,prepareSocialGTMEvent('Facebook','Unlike',targetUrl));},_getGTMProductListName:function(pageType,sectionTitle,promotionName=''){let productListName=pageType;if(['Homepage','Instant Shop','Shopping List','Checkout walk'].includes(pageType)){productListName=`${pageType}: ${sectionTitle}`;}
if(['Meal deals','Bundle items'].includes(pageType)){const offerName=promotionName||webshop.common.jsVariables.get('promotionName')||'';productListName=`Offers: ${offerName}`;}
return productListName},sendProductImpressions:function(productImpressions,size){const ARRAY_MAX_LENGTH=size?size:30;const sortBy=jQ('.js-product-sort option:selected').text().trim()||undefined;const self=this;_.each(_.chunk(productImpressions.products,ARRAY_MAX_LENGTH),function(products,chunkIndex){var impressions={event:'eecProductInteractionEvent',filterValues:this._getFilterValues(),numberOfResults:this._getNumberOfResults(),sortBy,pageTypeDimension:productImpressions.pageType,productSectionDimension:productImpressions.sectionTitle,ecommerce:{impressions:_.map(products,function(fop,index){return webshop.common.jsVariables.get('gaMinProductImpressions')?{id:fop.sku,price:fop.price,list:self._getGTMProductListName(productImpressions.pageType,productImpressions.sectionTitle,fop.promotionNames),position:fop.positionInList||calculateAbsoluteElementIndex(ARRAY_MAX_LENGTH,chunkIndex,index)}:{name:fop.name,brand:fop.brand,id:fop.sku,price:fop.price,category:fop.category,list:self._getGTMProductListName(productImpressions.pageType,productImpressions.sectionTitle,fop.promotionNames),position:fop.positionInList||calculateAbsoluteElementIndex(ARRAY_MAX_LENGTH,chunkIndex,index),dimension60:fop.dimension60,promotionNames:fop.promotionNames,dimension70:fop.dimension70,canAddToBasket:fop.canAddToBasket,isFavorite:fop.isFavorite,isFeatured:fop.isFeatured,isOnPromotion:fop.isOnPromotion,promotionIds:fop.promotionIds,}},this)}};impressions.uaEventCategory='E-Commerce';impressions.uaEventAction='productImpressions';impressions.uaEventLabel=productImpressions.pageType+'|'+productImpressions.sectionTitle;impressions.uaEventValue=impressions.ecommerce.impressions.length;sendGTMEvent.call(this,impressions);},this);},sendPromotionImpressions:function(promotionImpressions,size){var ARRAY_MAX_LENGTH=size?size:30;_.each(_.chunk(promotionImpressions.promotions,ARRAY_MAX_LENGTH),function(promotions){var impressions={event:promotions[0].id2?'eecPromotionInteractionEvent':'eecProductPromotionInteractionEvent',pageTypeDimension:promotionImpressions.pageType,ecommerce:{promoView:{promotions:_.map(promotions,function(promo){return{id:promo.id?promo.id:null,id2:promo.id2?promo.id2:undefined,name:promo.name?promo.name:null,creative:promo.creative?promo.creative:null,position:(promo.position||promo.position==0)?promo.position:null};},this)}}};if(promotionImpressions.productSectionDimension){impressions.productSectionDimension=promotionImpressions.productSectionDimension;}
impressions.uaEventCategory='E-Commerce';impressions.uaEventAction='promotionImpressions';impressions.uaEventLabel=promotionImpressions.pageType+'|'+promotionImpressions.sectionTitle;impressions.uaEventValue=impressions.ecommerce.promoView.promotions.length;sendGTMEvent.call(this,impressions);},this);},sendPromotionClickEvent:function(promotionClick){var promo=promotionClick.promo;var eventData={event:promo.id2?'promotionClick':'productPromotionClick',pageTypeDimension:promotionClick.pageType,ecommerce:{promoClick:{promotions:[{id:promo.id,id2:promo.id2,name:promo.name,creative:promo.creative,position:promo.position}]}}};eventData.uaEventCategory='E-Commerce';eventData.uaEventAction='promotionClick';eventData.uaEventLabel=promotionClick.pageType+(promotionClick.sectionTitle?'|'+promotionClick.sectionTitle:'');eventData.uaEventValue=eventData.ecommerce.promoClick.promotions.length;sendGTMEvent.call(this,eventData);},sendOosRatioEvent:function(pageType,range,category){var uaEvent={event:'oosProductsEvent',uaEventCategory:"Out of stock",uaEventAction:pageType,uaEventLabel:range,productCategoryDimension:category};sendGTMEvent.call(this,uaEvent);}});function calculateAbsoluteElementIndex(elementsPerChunk,chunkIndex,elementIndex){return chunkIndex*elementsPerChunk+elementIndex;}
function mapProductsDTO(products,transformQuantityFunction){transformQuantityFunction=transformQuantityFunction||_.identity;if(getGAMinCheckout()){return _.map(products,function(product){return{id:product.sku,price:product.price,quantity:transformQuantityFunction(product.quantity)}});}else if(shouldTrimGACheckoutInfo()){return _.map(products,function(product){return{id:product.sku,name:product.name,price:product.price,category:trimCategory(product.category,3),quantity:transformQuantityFunction(product.quantity)}});}else{return _.map(products,function(product){const productRating=_.get(product,'reviewStats.averageRate',0);const packInfo=product.packInfo||{};const labels=product.labels||[];const productDescription=(_.get(product,'backOfPack.bopFields.description')||[]).map(item=>item.content).join(' ');const productNutrition=(_.get(product,'backOfPack.bopFields.nutrition')||[]).map(item=>item.content).join(' ');const productIngredients=(_.get(product,'backOfPack.bopFields.ingredients')||[]).map(item=>item.content).join(' ');const productUsage=(_.get(product,'backOfPack.bopFields.storageAndUsage')||[]).map(item=>item.content).join(' ');const dietaryFlags=[...(packInfo.vegetarian?['Vegetarian']:[]),...(packInfo.organic?['Organic']:[]),].join(', ');let promotionNames=_.get(product,'offer.description','');promotionNames=(promotionNames&&promotionNames.trim)?(promotionNames.trim()||undefined):undefined;return{id:product.sku,name:product.name,brand:product.brand,price:product.price,category:product.category,quantity:transformQuantityFunction(product.quantity),variant:undefined,dimension60:productRating>0?productRating.toFixed(1):undefined,promotionNames,dimension62:1,dimension63:undefined,dimension64:productDescription||undefined,dimension65:productNutrition||undefined,dimension66:dietaryFlags||undefined,dimension67:productIngredients||undefined,dimension68:productUsage||undefined,dimension69:product.fullPrice,dimension70:_.get(product,'coupon.id'),dimension72:undefined,canAddToBasket:!labels.includes('OOS'),isFavorite:labels.includes('FAVOURITE'),isFeatured:product.featured,isOnPromotion:Boolean(_.get(product,'offer.id',false)),promotionIds:_.get(product,'offer.id'),list:"Checkout walk",}});}}
function shouldTrimGACheckoutInfo(){return webshop.common.jsTopBodyVariables.gaTrimCheckout||webshop.common.jsVariables.get('gaTrimCheckout');}
function trimCategory(category,level){if(_.isString(category)){return category.split("/").slice(0,level).join("/");}
return category;}
function createPurchasedOrderEvent(purchasedOrderDTO,transformMoneyFunction,eventAction,address,slot){var productsDTO=mapProductsDTO(purchasedOrderDTO.products,transformMoneyFunction);var eventData={event:'eecPlaceOrder',eecOrderType:purchasedOrderDTO.editing?'edited-order':'new-order',street:address.street||address.street2,city:address.city,area:undefined,country:address.country,postcode:address.postcode.displayPostcode,firstOrder:purchasedOrderDTO.firstShop,slotBookingTime:slot.slotBookingTime,slotBookingDate:slot.slotBookingDate,slotBookingDay:slot.slotBookingDay,vanType:undefined,numberOfDaysUntilDelivery:undefined,couponDiscountAmount:undefined,basketId:purchasedOrderDTO.basketId,editOrderDeadline:undefined,ecommerce:{currencyCode:"GBP",purchase:{actionField:{id:purchasedOrderDTO.orderId,affiliation:''+Date.now(),revenue:transformMoneyFunction(purchasedOrderDTO.totalCost),shipping:transformMoneyFunction(purchasedOrderDTO.shipping),},products:productsDTO}}};if(purchasedOrderDTO.voucherIds){eventData.ecommerce.purchase.actionField.coupon=purchasedOrderDTO.voucherIds.join(',');}
_.extend(eventData,{uaEventCategory:'E-Commerce',uaEventAction:eventAction,uaEventLabel:eventData.eecOrderType,uaEventValue:getEventValueForPurchasedEvent(eventAction)});return eventData;}
function createChunkedPurchasedOrderEvents(purchasedOrderDTO,transformMoneyFunction,chunkSize,eventAction){var productsDTO=mapProductsDTO(purchasedOrderDTO.products,transformMoneyFunction),chunkedProducts=_.chunk(productsDTO,chunkSize),chunkedEventData=[],timestamp=Date.now();_.each(chunkedProducts,function(chunk,idx){var eventData={event:'eecPlaceOrder',eecOrderType:(purchasedOrderDTO.editing?'edited-order':'new-order')+(idx==0?'':'-continued'),street:"Broad Street",city:"Shefford",area:undefined,country:"United Kingdom",postcode:"SG17 5RJ",firstOrder:true,slotBookingTime:"06:00",slotBookingDate:"2022-05-25",slotBookingDay:"Wednesday",vanType:"INFO_UNAVAILABLE",numberOfDaysUntilDelivery:5,couponDiscountAmount:undefined,basketId:"17091507",editOrderDeadline:"2022-05-23",ecommerce:{currencyCode:"GBP",purchase:{actionField:{id:purchasedOrderDTO.orderId,affiliation:timestamp+'_'+idx,revenue:(idx==0)?transformMoneyFunction(purchasedOrderDTO.totalCost):0,shipping:(idx==0)?transformMoneyFunction(purchasedOrderDTO.shipping):0,},products:chunk}}};if(purchasedOrderDTO.voucherIds){eventData.ecommerce.purchase.actionField.coupon=(idx==0)?purchasedOrderDTO.voucherIds.join(','):null;}
_.extend(eventData,{uaEventCategory:'E-Commerce',uaEventAction:eventAction,uaEventLabel:eventData.eecOrderType,uaEventValue:(idx==0)?getEventValueForPurchasedEvent(eventAction):0});chunkedEventData.push(eventData);});return chunkedEventData;}
function prepareSocialGTMEvent(socialNetwork,socialAction,socialTarget){return{'event':'socialInteracted','socialNetwork':socialNetwork,'socialAction':socialAction,'socialTarget':socialTarget};}
function sendGTMEvent(gtmEvent){var approximateSize=webshop.common.JsonSizeEstimator.estimateSize(gtmEvent);if(approximateSize>(8192*0.9)){webshop.common.ServerLogger.warn("[sendGTMEvent] Event "+gtmEvent.event+" is approximately "
+approximateSize+" bytes and may be too large to send to GA");}
if(typeof dataLayer!='undefined'&&!webshop.common.jsTopBodyVariables.shouldExcludeRequestFromUATracking){dataLayer.push({isApp:webshop.info.PALOMO,...gtmEvent});}}
function getProductListSizeLimit(){return webshop.common.jsTopBodyVariables.gaProductListSize||webshop.common.jsVariables.get('gaProductListSize');}
function getGAMinCheckout(){return webshop.common.jsTopBodyVariables.gaMinCheckout||webshop.common.jsVariables.get('gaMinCheckout');}
function getEventValueForPurchasedEvent(eventAction){switch(eventAction){case'orderPurchased':return 1;case'orderCancelled':return-1;default:return 0;}}})(Backbone,webshop);webshop.gtm=(function(){var gtm={eventSenderInitialized:false,init:function(){this.initializeEventSender();},initializeEventSender:function(){if(!this.eventSenderInitialized){this.gtmEventSender=new ocBackbone.gtm.GTMEventSender();this.eventSenderInitialized=true;}},registerEventSource:function(eventSource){this.initializeEventSender();Backbone.Marionette.bindEntityEvents(this.gtmEventSender,eventSource,this.gtmEventSender.acceptedEvents);}};if(_.isUndefined(webshop.gtm)){return gtm;}else{return _.extend(webshop.gtm,gtm);}})();(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.GTMVirtualPageviewEventSender=Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},send:function(virtualPageURL){this.trigger('gtm:virtualPageView',virtualPageURL);}});})(Backbone);(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.PageviewEventSender=new(Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},send:function(data){var eventData={event:'pageview',pageType:webshop.common.jsVariables.get('analyticsPageType'),pageViewId:webshop.common.jsVariables.get('pageViewId'),loggedInStatus:webshop.info.LI,userId:webshop.info.CI||undefined,userRegistrationDate:webshop.info.CRD||undefined,userFirstPurchaseDate:webshop.info.CFPD||undefined,userLastPurchaseDate:webshop.info.CLPD||undefined,smartPass:webshop.info.LI?webshop.info.OSP:undefined,smartPassType:webshop.info.OSP?webshop.info.OSPT:undefined,smartPassDuration:webshop.info.OSP?webshop.info.OSPD:undefined,placedOrderCount:webshop.info.POC||undefined,basketValue:webshop.info.BV||undefined,numberOfPurchaseLastTwelveWeeks:webshop.info.PLY||undefined,sessionId:webshop.info.SI,averageBasketValue:webshop.info.AB,searchTerm:webshop.info.ST,searchType:undefined,hashedEmail:webshop.info.CET||undefined,customerEmail:webshop.info.CE||undefined,customerFirstName:webshop.info.CFN||undefined,customerLastName:webshop.info.CLN||undefined,transactionId:webshop.basketSummaryData.orderNo||undefined,...data,isOSP:false,vouchers:webshop.common.jsVariables.get('voucherData'),};this.trigger('gtm:pageView',eventData);}}))();})(Backbone);(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.EditOrderEventSender=new(Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},send:function(data){var eventData={updateType:"Edit order clicked",...data};this.trigger('gtm:editOrder',eventData);}}))();})(Backbone);(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.NavigationInteractionEventSender=new(Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},send:function(data){this.trigger('gtm:navigationEvent',data);}}))();})(Backbone);(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.ORSignUpTracker=Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);this.ORResponisveEnabled=Backbone.Webshop.mixins.isBetaFeatureEnabled('OR_RESPONSIVE_SIGN_UP');},trackLandingOnSignUpPage:function(isWithIncentive){this._triggerORSignUpPageEvent(isWithIncentive?'Has the incentive':'Does not have the incentive');},trackLandingOnOldSignUpPage:function(isMobileRequested){this._triggerORSignUpPageEvent(isMobileRequested?'Mobile phone requested':'Mobile phone not requested');},trackOldORMbilePhoneError:function(){this._triggerORSignUpPageEvent('Error on reserve click');},trackOldORSignUpClick:function(){this._triggerORSignUpPageEvent('Reserve button clicked');},trackTryItNowButtonClick:function(isBottomButton){this._triggerORSignUpPageEvent(isBottomButton?'Bottom CTA clicked':'Top CTA clicked');},trackScrolledToBottomEvent:function(){this._triggerORSignUpPageEvent('Scrolled to bottom');},trackTCClick:function(){this._triggerORSignUpPageEvent('T&C clicked');},trackFAQClick:function(){this._triggerORSignUpPageEvent('FAQ clicked');},trackLandingOnBookSlotPage:function(hasMultipleDeliveryAddresses){this._triggerORBookSlotPageEvent(hasMultipleDeliveryAddresses?'Has multiple delivery addresses':'Has single delivery address');},trackDeliveryAddressChange:function(){this._triggerORBookSlotPageEvent('Delivery address changed');},trackManageAddressesClick:function(){this._triggerORBookSlotPageEvent('Manage addresses clicked');},trackDeliveryAddressConfirm:function(isPrimary){this._triggerORBookSlotPageEvent(isPrimary?'Primary delivery address selected':'Other delivery address selected');},trackDaySelection:function(selectedDay){var availableDays=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];if(availableDays.indexOf(selectedDay)<0){throw'Day is incorrect. Must be one of: Mon, Tue, Wed, Thu, Fri, Sat, Sun';}
this._triggerORBookSlotPageEvent('Day selected: '+selectedDay);},trackFrequencySelect:function(selectedFrequency){var availableFrequencies=['WEEKLY','TWO_WEEKLY'];if(availableFrequencies.indexOf(selectedFrequency)<0){throw'Frequency is incorrect. Must be one of: Weekly, Every 2 weeks';}
this._triggerORBookSlotPageEvent('Frequency selected: '+selectedFrequency);},trackTimeSlotsDisplay:function(){this._triggerORBookSlotPageEvent('Time slots displayed');},trackTimeSlotSelect:function(timeSlot){if(!timeSlot){throw'Time Slot is a required parameter';}
this._triggerORBookSlotPageEvent('Time slot selected: '+timeSlot);},trackItemsInOrderConfirm:function(){this._triggerORBookSlotPageEvent('Items in order confirmed');},trackSMSRemindersDisplay:function(){this._triggerORBookSlotPageEvent('SMS Reminders box displayed');},trackPhoneNumberConfirmClick:function(){this._triggerORBookSlotPageEvent('Phone number confirm clicked');},trackPhoneNumberError:function(){this._triggerORBookSlotPageEvent('Phone number confirmation error');},trackPhoneNumberSuccess:function(){this._triggerORBookSlotPageEvent('Phone number confirmation success');},trackBookSlotConfirmClick:function(){this._triggerORBookSlotPageEvent('Confirm and continue clicked');},trackLandingOnPaymentsPage:function(){this._triggerORPaymentsPageEvent('Landed on payments page');},trackPaymentMethodSubmit:function(method){var availableMethods=['Pay Pal','New Card','Stored Card'];if(availableMethods.indexOf(method)<0){throw'Payment method is incorrect. Must be one of: Pay Pal, New Card, Stored Card';}
this._triggerORPaymentsPageEvent('Payment method submitted: '+method);},trackLandingOnSettingsPage:function(){this._triggerORSettingsPageEvent('Landed on settings page');},trackSettingsPageUnavailableSlotInfo:function(){this._triggerORSettingsPageEvent('Informed about unavailable slot');},trackSettingsPageUnavailableItemsInfo:function(){this._triggerORSettingsPageEvent('Informed about unavailable items');},_triggerORSignUpPageEvent:function(action){this._triggerORPageEvent('Sign Up Page',action);},_triggerORBookSlotPageEvent:function(action){this._triggerORPageEvent('Book Slot Page',action);},_triggerORPaymentsPageEvent:function(action){this._triggerORPageEvent('Payments Page',action);},_triggerORSettingsPageEvent:function(action){this._triggerORPageEvent('Settings Page',action);},_triggerORPageEvent:function(label,action){var eventData={category:this.ORResponisveEnabled?'OR':'OR Old',label:label,action:action};this.trigger('gtm:uaEvent',eventData);}});})(Backbone);(function(Backbone){'use strict';ocBackbone.gtm=ocBackbone.gtm||{};ocBackbone.gtm.OrderStatusEventTracker=Backbone.Marionette.Object.extend({initialize:function(){webshop.gtm.registerEventSource(this);},trackOrderStatusEvent:function(orderStatusDescription){if(orderStatusDescription){this.trigger('gtm:orderStatus',orderStatusDescription);}}});})(Backbone);
</script>

</body>
</html>
